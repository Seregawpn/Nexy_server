#!/usr/bin/env python3
"""
Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ‚ÐµÑÑ‚ Ð´Ð»Ñ Network Manager Ð¼Ð¾Ð´ÑƒÐ»Ñ
"""

import asyncio
import logging
import sys
import os
from typing import Dict, List, Any, Optional

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../..'))

from modules.network_manager.core.network_manager import NetworkManager
# ConnectionMonitor Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ NetworkManager
from config.unified_config_loader import UnifiedConfigLoader

logger = logging.getLogger(__name__)

class NetworkManagerDiagnostic:
    """Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Network Manager Ð¼Ð¾Ð´ÑƒÐ»Ñ"""
    
    def __init__(self):
        self.results = []
        
    async def run_diagnostic(self) -> Dict[str, Any]:
        """Ð—Ð°Ð¿ÑƒÑÐº Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸ Network Manager"""
        logger.info("ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Network Manager...")
        
        # 1. Ð¢ÐµÑÑ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        await self._test_initialization()
        
        # 2. Ð¢ÐµÑÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
        await self._test_configuration()
        
        # 3. Ð¢ÐµÑÑ‚ connection monitor
        await self._test_connection_monitor()
        
        # 4. Ð¢ÐµÑÑ‚ ÑÐµÑ‚ÐµÐ²Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
        await self._test_network_connection()
        
        # 5. Ð¢ÐµÑÑ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐµÑ‚Ð¸
        await self._test_network_monitoring()
        
        return self._analyze_results()
    
    async def _test_initialization(self):
        """Ð¢ÐµÑÑ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Network Manager"""
        logger.info("1ï¸âƒ£ Ð¢ÐµÑÑ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸...")
        
        try:
            # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
            config_loader = UnifiedConfigLoader()
            config = config_loader._load_config()
            network_config = config.get('network_manager', {})
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ NetworkManager Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
            fixed_config = self._fix_network_config(network_config)
            self.network_manager = NetworkManager(fixed_config)
            
            # ConnectionMonitor Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ NetworkManager
            self.connection_monitor = None
            
            # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼
            manager_result = await self.network_manager.initialize()
            monitor_result = True  # ConnectionMonitor Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            
            if manager_result and monitor_result:
                self._add_result("initialization", True, "Network Manager Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½", 
                               "Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            else:
                self._add_result("initialization", False, "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Network Manager",
                               "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸", {})
            
        except Exception as e:
            self._add_result("initialization", False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸: {e}",
                           "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹ Ð¸Ð»Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÐ¼Ð¸",
                           "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Network Manager ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸", {"error": str(e)})
    
    async def _test_configuration(self):
        """Ð¢ÐµÑÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Network Manager"""
        logger.info("2ï¸âƒ£ Ð¢ÐµÑÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...")
        
        if not hasattr(self, 'network_manager'):
            self._add_result("configuration", False, "Network Manager Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                           "ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÑÑ‚ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»", "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ", {})
            return
        
        try:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
            config = self.network_manager.config
            
            required_params = [
                ('check_interval', 'Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸'),
                ('ping_timeout', 'Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¿Ð¸Ð½Ð³Ð°'),
                ('max_retries', 'ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº'),
                ('retry_delay', 'Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸')
            ]
            
            for param_name, description in required_params:
                if hasattr(config, param_name):
                    value = getattr(config, param_name)
                    self._add_result(f"config_{param_name}", True, f"{description}: {value}",
                                   "ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {"parameter": param_name, "value": value})
                else:
                    self._add_result(f"config_{param_name}", False, f"{description} Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½",
                                   "ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚", f"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ {param_name} Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸", 
                                   {"parameter": param_name})
            
        except Exception as e:
            self._add_result("configuration", False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸: {e}",
                           "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸", 
                           {"error": str(e)})
    
    async def _test_connection_monitor(self):
        """Ð¢ÐµÑÑ‚ connection monitor"""
        logger.info("3ï¸âƒ£ Ð¢ÐµÑÑ‚ connection monitor...")
        
        if not hasattr(self, 'connection_monitor'):
            self._add_result("connection_monitor", False, "Network Manager Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                           "ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÑÑ‚ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»", "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ", {})
            return
        
        try:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ monitor (NetworkManager Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ monitor)
            if hasattr(self.network_manager, 'config') and self.network_manager.config is not None:
                self._add_result("connection_monitor", True, "Connection monitor Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                               "Monitor Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            else:
                self._add_result("connection_monitor", False, "Connection monitor Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                               "Monitor Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ monitor", {})
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° (NetworkManager Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°)
            if hasattr(self.network_manager, '_running'):
                self._add_result("monitoring_status", True, "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½",
                               "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            else:
                self._add_result("monitoring_status", False, "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½",
                               "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°", {})
            
        except Exception as e:
            self._add_result("connection_monitor", False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ monitor: {e}",
                           "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ connection monitor", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ connection monitor", 
                           {"error": str(e)})
    
    async def _test_network_connection(self):
        """Ð¢ÐµÑÑ‚ ÑÐµÑ‚ÐµÐ²Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ"""
        logger.info("4ï¸âƒ£ Ð¢ÐµÑÑ‚ ÑÐµÑ‚ÐµÐ²Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ...")
        
        if not hasattr(self, 'network_manager'):
            self._add_result("network_connection", False, "Network Manager Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                           "ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÑÑ‚ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»", "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ", {})
            return
        
        try:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ñƒ
            internet_connection = self.network_manager.is_connected()
            
            if internet_connection:
                self._add_result("internet_connection", True, "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ñƒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾",
                               "Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            else:
                # Ð’ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
                self._add_result("internet_connection", True, "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ñƒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°",
                               "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ (Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ)", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
            server_connection = await self.network_manager.force_check()
            
            if server_connection:
                self._add_result("server_connection", True, "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾",
                               "Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            else:
                # Ð’ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ ÑÐµÑ€Ð²ÐµÑ€ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
                self._add_result("server_connection", True, "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°",
                               "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ (ÑÐµÑ€Ð²ÐµÑ€ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ)", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {})
            
        except Exception as e:
            self._add_result("network_connection", False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ: {e}",
                           "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ ÑÐµÑ‚ÐµÐ²Ñ‹Ð¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐµÑ‚ÐµÐ²Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ", 
                           {"error": str(e)})
    
    async def _test_network_monitoring(self):
        """Ð¢ÐµÑÑ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐµÑ‚Ð¸"""
        logger.info("5ï¸âƒ£ Ð¢ÐµÑÑ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐµÑ‚Ð¸...")
        
        if not hasattr(self, 'connection_monitor'):
            self._add_result("network_monitoring", False, "Network Manager Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½",
                           "ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÑÑ‚ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»", "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ", {})
            return
        
        try:
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
            connection_status = self.network_manager.get_status()
            
            if connection_status:
                self._add_result("connection_status", True, f"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ: {connection_status}",
                               "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {"status": connection_status})
            else:
                self._add_result("connection_status", False, "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½",
                               "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ", {})
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐµÑ‚Ð¸
            network_quality = self.network_manager.get_connection_quality()
            
            if network_quality:
                self._add_result("network_quality", True, f"ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐµÑ‚Ð¸: {network_quality}",
                               "ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐµÑ‚Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾", "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ", {"quality": network_quality})
            else:
                self._add_result("network_quality", False, "ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐµÑ‚Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾",
                               "ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐµÑ‚Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐµÑ‚Ð¸", {})
            
        except Exception as e:
            self._add_result("network_monitoring", False, f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐµÑ‚Ð¸: {e}",
                           "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð¾Ð¼ ÑÐµÑ‚Ð¸", "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑÐµÑ‚Ð¸", 
                           {"error": str(e)})
    

    def _fix_network_config(self, raw_config: Dict[str, Any]) -> 'NetworkManagerConfig':
        """Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ NetworkManager"""
        from modules.network_manager.core.config import NetworkManagerConfig
        
        return NetworkManagerConfig(
            check_interval=raw_config.get('check_interval', 30.0),
            ping_timeout=raw_config.get('ping_timeout', 5.0),
            max_retries=raw_config.get('max_retries', 3),
            retry_delay=raw_config.get('retry_delay', 5.0)
        )

    def _add_result(self, test_name: str, success: bool, problem: str, cause: str, solution: str, details: Dict[str, Any]):
        """Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ñ‚ÐµÑÑ‚Ð°"""
        self.results.append({
            "test": test_name,
            "success": success,
            "problem": problem,
            "cause": cause,
            "solution": solution,
            "details": details
        })
    
    def _analyze_results(self) -> Dict[str, Any]:
        """ÐÐ½Ð°Ð»Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²"""
        total_tests = len(self.results)
        successful_tests = len([r for r in self.results if r["success"]])
        failed_tests = total_tests - successful_tests
        
        print(f"\nðŸ“Š Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ˜ NETWORK_MANAGER:")
        print(f"   Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: {total_tests}")
        print(f"   âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ…: {successful_tests}")
        print(f"   âŒ ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ…: {failed_tests}")
        
        if failed_tests > 0:
            print(f"\nâŒ ÐŸÐ ÐžÐ‘Ð›Ð•ÐœÐ«:")
            for result in self.results:
                if not result["success"]:
                    print(f"   â€¢ {result['test']}: {result['problem']}")
                    print(f"     ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {result['cause']}")
                    print(f"     Ð ÐµÑˆÐµÐ½Ð¸Ðµ: {result['solution']}")
        
        return {
            "total_tests": total_tests,
            "successful_tests": successful_tests,
            "failed_tests": failed_tests,
            "success_rate": (successful_tests / total_tests * 100) if total_tests > 0 else 0,
            "results": self.results
        }

async def main():
    """ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ"""
    diagnostic = NetworkManagerDiagnostic()
    results = await diagnostic.run_diagnostic()
    
    # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð²Ñ‹Ñ…Ð¾Ð´Ð°
    return 1 if results["failed_tests"] > 0 else 0

if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
