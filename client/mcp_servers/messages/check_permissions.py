#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Messages

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ß—Ç–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
"""

from pathlib import Path
import sys

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—é
sys.path.insert(0, str(Path(__file__).parent))

from . import messages_db


def check_permissions():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞"""
    print("=" * 70)
    print("–ü–†–û–í–ï–†–ö–ê –†–ê–ó–†–ï–®–ï–ù–ò–ô –î–û–°–¢–£–ü–ê –ö –ë–ê–ó–ï –î–ê–ù–ù–´–• MESSAGES")
    print("=" * 70)
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    print("üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
    db_path = messages_db.get_db_path()
    print(f"   –ü—É—Ç—å: {db_path}")
    
    if db_path.exists():
        print("   ‚úÖ –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    else:
        print("   ‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
        print("   ‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞")
        return False
    
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
    print("üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞")
    accessible, error_msg = messages_db.check_db_access()
    
    if accessible:
        print("   ‚úÖ –§–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è")
    else:
        print("   ‚ùå –§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        print(f"   –û—à–∏–±–∫–∞: {error_msg}")
        print()
        print("   ‚ö†Ô∏è  –ù–ï–û–ë–•–û–î–ò–ú–û –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ FULL DISK ACCESS")
        print()
        print("   –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:")
        print("   1. –û—Ç–∫—Ä–æ–π—Ç–µ –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
        print("   2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å")
        print("   3. –ù–∞–π–¥–∏—Ç–µ '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Å–∫—É'")
        print("   4. –î–æ–±–∞–≤—å—Ç–µ Terminal/Cursor –≤ —Å–ø–∏—Å–æ–∫")
        print("   5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
        print()
        return False
    
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    print("üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
    conn = messages_db.connect_db()
    
    if conn:
        print("   ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ß—Ç–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        print()
        print("üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ß—Ç–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        tables = messages_db.get_tables(conn)
        
        if tables:
            print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: {len(tables)}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
            key_tables = ["handle", "chat", "message", "chat_handle_join", "chat_message_join"]
            found_key_tables = [t for t in key_tables if t in tables]
            
            print(f"   ‚úÖ –ö–ª—é—á–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–π–¥–µ–Ω—ã: {len(found_key_tables)}/{len(key_tables)}")
            
            if len(found_key_tables) == len(key_tables):
                print("   ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã")
            else:
                missing = [t for t in key_tables if t not in tables]
                print(f"   ‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–∞–±–ª–∏—Ü—ã: {missing}")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü
            print()
            print("   –ü—Ä–∏–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü:")
            for table in tables[:5]:
                print(f"     - {table}")
            if len(tables) > 5:
                print(f"     ... –∏ –µ—â–µ {len(tables) - 5} —Ç–∞–±–ª–∏—Ü")
        else:
            print("   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü")
        
        conn.close()
        
        print()
        print("=" * 70)
        print("‚úÖ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("=" * 70)
        print()
        print("üéâ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
        print("   –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ MCP —Å–µ—Ä–≤–µ—Ä–∞:")
        print("   - –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤")
        print("   - –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π")
        print("   - –ò –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ")
        print()
        return True
    else:
        print("   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è")
        print()
        print("   ‚ö†Ô∏è  –ù–ï–û–ë–•–û–î–ò–ú–û –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ FULL DISK ACCESS")
        return False

if __name__ == "__main__":
    success = check_permissions()
    sys.exit(0 if success else 1)




