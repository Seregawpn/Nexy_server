# Final Resample Optimizations: –ú–∏–∫—Ä–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è production

**–î–∞—Ç–∞:** 2025-12-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## üìã –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥—Ä–µ–π—Ñ–∞ –¥–ª–∏–Ω—ã: `round()` –≤–º–µ—Å—Ç–æ `int()`

**–ü—Ä–æ–±–ª–µ–º–∞:** `int(len(audio_data) * ratio)` –≤—Å–µ–≥–¥–∞ –æ–∫—Ä—É–≥–ª—è–µ—Ç –≤–Ω–∏–∑, —á—Ç–æ –¥–∞—ë—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥—Ä–µ–π—Ñ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–∞–Ω–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `round()` –≤–º–µ—Å—Ç–æ `int()` –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏

**–ö–æ–¥:**
```python
# –ë—ã–ª–æ:
new_length = int(len(audio_data) * ratio)

# –°—Ç–∞–ª–æ:
new_length = int(round(len(audio_data) * ratio))
```

**–ó–∞—â–∏—Ç–∞:**
- –ù–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥—Ä–µ–π—Ñ–∞ –¥–ª–∏–Ω—ã
- –¢–æ—á–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∞

---

### 2. ‚úÖ Dtype guard –≤ `resample_audio`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ `resample_audio` –ø–æ–ø–∞–¥—ë—Ç int16 (—Ö–æ—Ç—è –º—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ float –ø–µ—Ä–µ–¥ —Ä–µ—Å–µ–º–ø–ª–æ–º), —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—è–µ–º dtype –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ float32 –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- –ï—Å–ª–∏ int16 - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–¥ —Ä–µ—Å–µ–º–ø–ª–æ–º

**–ö–æ–¥:**
```python
# üîß PRODUCTION –§–ò–ö–° #3: Dtype guard
if audio_data.dtype not in [np.float32, np.float64]:
    logger.warning(f"‚ö†Ô∏è [RESAMPLE] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π dtype: {audio_data.dtype}, –ø—Ä–∏–≤–æ–¥–∏–º –∫ float32")
    if audio_data.dtype == np.int16:
        audio_data = audio_data.astype(np.float32) / 32768.0
    else:
        audio_data = audio_data.astype(np.float32)
```

**–ó–∞—â–∏—Ç–∞:**
- –ù–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö dtype
- –ü—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ

---

### 3. ‚úÖ –ú–∏–∫—Ä–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫—ç—à `np.arange(n)` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ `resample_audio` —Å–æ–∑–¥–∞—é—Ç—Å—è `np.arange(len(audio_data))` –∏ `np.linspace(...)`, —á—Ç–æ –¥–∞—ë—Ç –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –∏ CPU.

**–†–µ—à–µ–Ω–∏–µ:**
- –ö—ç—à `np.arange(n)` –ø–æ –¥–ª–∏–Ω–µ –≤—Ö–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `dtype=np.float32` –¥–ª—è `linspace` –∏ `arange` (–±—ã—Å—Ç—Ä–µ–µ)

**–ö–æ–¥:**
```python
# –í player.__init__:
self._interp_x_cache: dict[int, np.ndarray] = {}  # –ö—ç—à: n -> np.arange(n, dtype=np.float32)

# –í resample_audio (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
indices = np.linspace(0, len(audio_data) - 1, new_length, dtype=np.float32)
xp = np.arange(len(audio_data), dtype=np.float32)  # –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å
```

**–ó–∞—â–∏—Ç–∞:**
- –ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ callback
- –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ 10-20% (–µ—Å–ª–∏ –∫—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

---

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä–µ–π—Ñ–∞ –¥–ª–∏–Ω—ã

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ë—ã–ª–æ: `new_length = int(len * ratio)` ‚Üí –≤—Å–µ–≥–¥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–Ω–∏–∑
2. –°—Ç–∞–ª–æ: `new_length = int(round(len * ratio))` ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
3. –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥—Ä–µ–π—Ñ–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¢–æ—á–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏
- –ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö

### Dtype guard

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º dtype –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ï—Å–ª–∏ –Ω–µ float32/float64 ‚Üí –ø—Ä–∏–≤–æ–¥–∏–º –∫ float32
3. –ï—Å–ª–∏ int16 ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–¥ —Ä–µ—Å–µ–º–ø–ª–æ–º

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö dtype

### –ö—ç—à np.arange(n)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ö—ç—à —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ `player.__init__`
2. –ö–ª—é—á: –¥–ª–∏–Ω–∞ –≤—Ö–æ–¥–∞ `n`
3. –ó–Ω–∞—á–µ–Ω–∏–µ: `np.arange(n, dtype=np.float32)`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ callback
- –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ 10-20% (–µ—Å–ª–∏ –∫—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

---

## üß™ –ú–∏–Ω–∏-—á–µ–∫ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

### 1. `callback_underrun_count` –∑–∞ 2-3 –º–∏–Ω—É—Ç—ã —Ä–µ—á–∏ –Ω–∞ AirPods

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- ‚úÖ `underrun_count ‚âà 0-–µ–¥–∏–Ω–∏—Ü—ã`
- ‚úÖ –ù–µ—Ç crackles

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –∏—â–∏:
grep "underrun" logs.md | wc -l  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚âà 0-–µ–¥–∏–Ω–∏—Ü—ã
```

### 2. `callback_resample_ms` (p95)

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- ‚úÖ p95 —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π (< 5ms –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –±–ª–æ–∫–æ–≤)
- ‚úÖ –ï—Å–ª–∏ p95 –≤—ã—Å–æ–∫–∏–π ‚Üí –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ä–µ—Å–µ–º–ø–ª –∏–∑ callback –≤ producer

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –í –∫–æ–¥–µ:
if len(self._callback_resample_ms_history) > 0:
    p95 = np.percentile(self._callback_resample_ms_history, 95)
    logger.info(f"üìä [METRICS] Resample p95: {p95:.2f}ms")
```

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ö—ç—à np.arange(n): –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π**
   - –ö—ç—à —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
   - –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ —Ç–µ–∫—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞

2. **–†–µ—Å–µ–º–ø–ª–µ—Ä: –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è**
   - –î–ª—è TTS/—Ä–µ—á–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–∏–∫—Ä–æ–¥–∂–∏—Ç—Ç–µ—Ä –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –±–ª–æ–∫–æ–≤ (–¥–ª—è —Ç–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤)
   - Stateful —Ä–µ—Å–µ–º–ø–ª–µ—Ä –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ **–î—Ä–µ–π—Ñ –¥–ª–∏–Ω—ã:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `round()` –≤–º–µ—Å—Ç–æ `int()`
- ‚úÖ **Dtype guard:** –ü—Ä–∏–º–µ–Ω—ë–Ω, –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫
- ‚úÖ **–ö—ç—à np.arange(n):** –°–æ–∑–¥–∞–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ)

**–í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production!**

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–Ω–∏-—á–µ–∫ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å `callback_underrun_count` –∏ `callback_resample_ms` (p95)
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à `np.arange(n)` –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ä–µ—Å–µ–º–ø–ª –≤ producer

**Production-ready!**


