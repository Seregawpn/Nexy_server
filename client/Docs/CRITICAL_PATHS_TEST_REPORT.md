# –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-11-12  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –õ–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è tray controller
- ‚úÖ `applicationShouldTerminate` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
- ‚úÖ `_setup_quit_handler()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 2: NSApplication activation
- ‚úÖ NSApplication –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å activation policy (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –∏–ª–∏ False - –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã)
- ‚úÖ Activation policy —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 3: –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–ª–∞–≥–æ–≤ first run
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ data_dir –∏ cache_dir
- ‚úÖ AtomicRestartFlag —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–ª–∞–≥
- ‚úÖ –§–ª–∞–≥ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ read_and_remove
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 4: –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∏—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ó–∞—Ö–≤–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (—Ç–æ—Ç –∂–µ PID) –Ω–µ –¥–∞—ë—Ç –ª–æ–∂–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 5: –õ–æ–≥–∏–∫–∞ permission restart
- ‚úÖ MacOSRestartHandler —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–µ—Ç–æ–¥ `trigger_restart` –¥–æ—Å—Ç—É–ø–µ–Ω
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è EventBus
- ‚úÖ EventBus —Å–æ–∑–¥–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

### –¢–µ—Å—Ç 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è StateManager
- ‚úÖ StateManager —Å–æ–∑–¥–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–°—Ç–∞—Ç—É—Å:** –ü–†–û–ô–î–ï–ù

## –ò—Ç–æ–≥–∏

- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 7
- **–ü—Ä–æ–π–¥–µ–Ω–æ:** 7
- **–ü—Ä–æ–≤–∞–ª–µ–Ω–æ:** 0

**üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—á–∞—Å—Ç–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**

## –ß—Ç–æ –±—ã–ª–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

### 1. Tray Controller
- –õ–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `applicationShouldTerminate` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- `_setup_quit_handler()` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 2. NSApplication
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è menu bar
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ activation policy
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 3. First Run Flags
- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å —Ñ–ª–∞–≥–æ–≤
- –ß—Ç–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤

### 4. Instance Manager
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- –ó–∞—Ö–≤–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ PID (–∏–∑–±–µ–∂–∞–Ω–∏–µ –ª–æ–∂–Ω—ã—Ö –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π)

### 5. Permission Restart
- –°–æ–∑–¥–∞–Ω–∏–µ RestartHandler
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### 6. EventBus
- –°–æ–∑–¥–∞–Ω–∏–µ EventBus
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π

### 7. StateManager
- –°–æ–∑–¥–∞–Ω–∏–µ StateManager
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —É–ø–∞–∫–æ–≤–∫–µ

‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
- Tray controller –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- NSApplication –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è menu bar
- First run flags —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ
- Instance manager –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- Permission restart handler –¥–æ—Å—Ç—É–ø–µ–Ω
- EventBus —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- StateManager —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã - –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —É–ø–∞–∫–æ–≤–∫–µ
2. –ü—Ä–∏ —É–ø–∞–∫–æ–≤–∫–µ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–µ–Ω—ã
3. –ü–æ—Å–ª–µ —É–ø–∞–∫–æ–≤–∫–∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ .app bundle

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `Docs/PRE_PACKAGING_VERIFICATION.md` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É–ø–∞–∫–æ–≤–∫–æ–π
- `Docs/TRAY_TERMINATION_FIX.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `scripts/test_critical_paths.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `scripts/test_tray_termination.py` - —Ç–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è




