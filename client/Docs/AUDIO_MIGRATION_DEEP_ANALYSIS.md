# –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π

**–°—Ç–∞—Ç—É—Å**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑  
**–¶–µ–ª—å**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –≤–ª–∏—è–Ω–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ race conditions  
**–î–∞—Ç–∞**: 2025-12-23

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ](#1-–∞–Ω–∞–ª–∏–∑-–º–æ–¥—É–ª–µ–π-–∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö-–∞—É–¥–∏–æ)
2. [–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ](#2-–∞–Ω–∞–ª–∏–∑-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π-–∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö-–∞—É–¥–∏–æ)
3. [–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π](#3-–∞–Ω–∞–ª–∏–∑-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
4. [–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π](#4-–∞–Ω–∞–ª–∏–∑-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
5. [–ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤](#5-–∞–Ω–∞–ª–∏–∑-–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö-–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
6. [–ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è](#6-–∞–Ω–∞–ª–∏–∑-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
7. [–ê–Ω–∞–ª–∏–∑ race conditions](#7-–∞–Ω–∞–ª–∏–∑-race-conditions)
8. [–ö–∞—Ä—Ç–∞ –≤–ª–∏—è–Ω–∏—è](#8-–∫–∞—Ä—Ç–∞-–≤–ª–∏—è–Ω–∏—è)
9. [–ü–ª–∞–Ω –º–∏—Ç–∏–≥–∞—Ü–∏–∏](#9-–ø–ª–∞–Ω-–º–∏—Ç–∏–≥–∞—Ü–∏–∏)

---

## 1. –ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ

### 1.1. `modules/voice_recognition/`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`core/speech_recognizer.py`** (1840 —Å—Ç—Ä–æ–∫)
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `SpeechRecognizer`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**:
  - `sounddevice.InputStream` –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ
  - `speech_recognition.Microphone` –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
  - `speech_recognition.Recognizer` –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- **Threading**:
  - `listen_thread: threading.Thread` ‚Äî –ø–æ—Ç–æ–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏
  - `audio_lock: threading.Lock` ‚Äî –∑–∞—â–∏—Ç–∞ `audio_data`
  - `_stream_state_lock: threading.RLock` ‚Äî –∑–∞—â–∏—Ç–∞ state machine
  - `_start_lock: asyncio.Lock` ‚Äî –∑–∞—â–∏—Ç–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏**:
  - `input_device_id` ‚Äî —Ç–µ–∫—É—â–∏–π device index
  - `input_device_name` ‚Äî –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (PRIMARY –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
  - `_device_name_to_id_cache` ‚Äî –∫—ç—à –º–∞–ø–ø–∏–Ω–≥–∞ name ‚Üí id
  - `_refresh_device_cache()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤**:
  - `device_monitor: AudioDeviceMonitor` ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  - `_on_device_changed()` ‚Äî callback –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **Recovery**:
  - `recovery_manager: AudioRecoveryManager` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  - `_execute_recovery()` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `start_listening()` ‚Äî –∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ (async)
  - `stop_listening()` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ (async)
  - `_run_listening()` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞–ø–∏—Å–∏ (thread)
  - `_audio_callback()` ‚Äî callback –¥–ª—è `sounddevice.InputStream`
  - `_switch_device()` ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (async)

**`core/audio_device_monitor.py`** (140 —Å—Ç—Ä–æ–∫)
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `AudioDeviceMonitor`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**:
  - `sounddevice.default.device[0]` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ input —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - Polling –∫–∞–∂–¥—ã–µ `check_interval` —Å–µ–∫—É–Ω–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.5)
- **Threading**:
  - `_monitor_thread: threading.Thread` ‚Äî –ø–æ—Ç–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - `_lock: threading.Lock` ‚Äî –∑–∞—â–∏—Ç–∞ `current_input_device`
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `start_monitoring()` ‚Äî –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - `stop_monitoring()` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - `_monitor_loop()` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - `_get_current_input_device()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**`core/audio_recovery_manager.py`**
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `AudioRecoveryManager`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: –ü–æ—Ä–æ–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (A: 10, B: 50, C: 100, D: 150 –ø—É—Å—Ç—ã—Ö —á–∞–Ω–∫–æ–≤)
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `on_chunk_received()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–æ–≤
  - `execute_recovery()` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `sounddevice`

- **–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π**: 58 —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ 5 —Ñ–∞–π–ª–∞—Ö
- **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**:
  - `sd.InputStream()` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ input –ø–æ—Ç–æ–∫–∞
  - `sd.query_devices()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  - `sd.default.device` ‚Äî —Å–∏—Å—Ç–µ–º–Ω–æ–µ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  - `sd._terminate()` / `sd._initialize()` ‚Äî **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)

---

### 1.2. `modules/speech_playback/`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`core/player.py`** (922 —Å—Ç—Ä–æ–∫–∏)
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `SequentialSpeechPlayer`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**:
  - `sounddevice.OutputStream` –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
  - `numpy` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
- **Threading**:
  - `_playback_thread: threading.Thread` ‚Äî –ø–æ—Ç–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
  - `_stream_lock: threading.RLock` ‚Äî –∑–∞—â–∏—Ç–∞ `_audio_stream`
  - `_stop_event: threading.Event` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
  - `_pause_event: threading.Event` ‚Äî –ø–∞—É–∑–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏**:
  - `output_device_name: Optional[str]` ‚Äî –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (PRIMARY –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
  - `_query_default_output_device()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `_check_and_update_output_device()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `resync_output_device()` ‚Äî –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `play_chunk()` ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–∞–Ω–∫–∞
  - `_start_audio_stream()` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ output –ø–æ—Ç–æ–∫–∞
  - `_ensure_stream_started()` ‚Äî lazy start –ø–æ—Ç–æ–∫–∞
  - `_stop_audio_stream()` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
  - `_audio_callback()` ‚Äî callback –¥–ª—è `sounddevice.OutputStream`
  - `_sync_output_format()` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º

**`macos/core_audio.py`**
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `CoreAudioManager`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: macOS CoreAudio API (—á–µ—Ä–µ–∑ PyObjC)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CoreAudio –¥–ª—è macOS

**`macos/performance.py`**
- **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `PerformanceMonitor`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `sounddevice`

- **–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π**: 16 —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ 3 —Ñ–∞–π–ª–∞—Ö
- **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**:
  - `sd.OutputStream()` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ output –ø–æ—Ç–æ–∫–∞
  - `sd.query_devices()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  - `sd.default.device[1]` ‚Äî —Å–∏—Å—Ç–µ–º–Ω–æ–µ default output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

---

### 1.3. `modules/permissions/first_run/activator.py`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`activate_microphone()`** (async —Ñ—É–Ω–∫—Ü–∏—è)
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: `sounddevice.InputStream` –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –¥–µ—Ä–∂–∏—Ç –µ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–∏–∞–ª–æ–≥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sd.InputStream()` —Å `samplerate=16000`, `channels=1`, `dtype='int16'`
  - –î–µ—Ä–∂–∏—Ç –ø–æ—Ç–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã–º –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ `hold_duration` —Å–µ–∫—É–Ω–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7.0)
  - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç**: –ú–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å `SpeechRecognizer` –µ—Å–ª–∏ –æ–±–∞ –ø—ã—Ç–∞—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

## 2. –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ

### 2.1. `integration/integrations/voice_recognition_integration.py`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`VoiceRecognitionIntegration`**
- **–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è**:
  - `voice.recording_start` ‚Äî –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
  - `voice.recording_stop` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
  - `permissions.first_run_started` ‚Äî –Ω–∞—á–∞–ª–æ first-run
- **–ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è**:
  - `voice.mic_opened` ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫—Ä—ã—Ç
  - `voice.mic_closed` ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–∫—Ä—ã—Ç
  - `voice.recognition_started` ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ
  - `voice.recognition_completed` ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
  - `voice.recognition_failed` ‚Äî –æ—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- **–£–ø—Ä–∞–≤–ª—è–µ—Ç**:
  - `SpeechRecognizer` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
  - **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞** (—á–µ—Ä–µ–∑ `SpeechRecognizer`)
- **Threading**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio.run_coroutine_threadsafe()` –¥–ª—è thread-safe –ø—É–±–ª–∏–∫–∞—Ü–∏–π
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ "CoreAudio thread already running"
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `_on_recording_start()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏
  - `_on_recording_stop()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏
  - `_start_recognition()` ‚Äî –∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `sounddevice`

- **–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π**: 3 —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
- **–ß–µ—Ä–µ–∑**: `SpeechRecognizer` (–Ω–µ –Ω–∞–ø—Ä—è–º—É—é)

---

### 2.2. `integration/integrations/speech_playback_integration.py`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`SpeechPlaybackIntegration`**
- **–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è**:
  - `grpc.response.audio` ‚Äî –∞—É–¥–∏–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- **–ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è**:
  - `playback.started` ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ
  - `playback.completed` ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
  - `playback.failed` ‚Äî –æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- **–£–ø—Ä–∞–≤–ª—è–µ—Ç**:
  - `SequentialSpeechPlayer` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
  - **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü output** (—á–µ—Ä–µ–∑ `SequentialSpeechPlayer`)
- **Threading**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio.run_coroutine_threadsafe()` –¥–ª—è thread-safe –ø—É–±–ª–∏–∫–∞—Ü–∏–π
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã**:
  - `_on_audio_response()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
  - `play_chunk()` ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–∞–Ω–∫–∞

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `sounddevice`

- **–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π**: 3 —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
- **–ß–µ—Ä–µ–∑**: `SequentialSpeechPlayer` (–Ω–µ –Ω–∞–ø—Ä—è–º—É—é)

---

### 2.3. `integration/integrations/first_run_permissions_integration.py`

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`FirstRunPermissionsIntegration`**
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: `activate_microphone()` –∏–∑ `modules/permissions/first_run/activator.py`
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç**: –ú–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å `VoiceRecognitionIntegration` –µ—Å–ª–∏ –æ–±–∞ –ø—ã—Ç–∞—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

## 3. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### 3.1. `config/unified_config.yaml`

#### –°–µ–∫—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∞—É–¥–∏–æ

**`audio_system`** (—Å—Ç—Ä–æ–∫–∏ 46-124)
- **Feature flags**:
  - `avfoundation_enabled: false` ‚Äî –≥–ª–∞–≤–Ω—ã–π feature flag
  - `avfoundation_input_monitor_enabled: false` ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ input
  - `avfoundation_output_enabled: false` ‚Äî output —á–µ—Ä–µ–∑ AVFoundation
  - `avfoundation_route_manager_enabled: false` ‚Äî RouteManager
- **Kill-switches**:
  - `ks_avfoundation_input_monitor: false`
  - `ks_avfoundation_output: false`
  - `ks_avfoundation_route_manager: false`
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**:
  - `input_monitor.check_interval_sec: 1.5` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª polling
  - `input_monitor.use_notifications: true` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NSNotificationCenter
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã RouteManager**:
  - `route_manager.debounce` ‚Äî debounce –ø–æ —Ç–∏–ø–∞–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (bluetooth, usb, built_in)
  - `route_manager.reconcile_timeout_ms: 5000`
  - `route_manager.max_reconcile_retries: 3`
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã output**:
  - `output.max_queue_ms: 5000`
  - `output.max_queue_bytes: 5242880`
  - `output.sample_rate_conversion: true`

**`default_audio`** (—Å—Ç—Ä–æ–∫–∏ 30-34)
- `target_sample_rate: 16000` ‚Äî –¥–ª—è STT
- `target_channels: 1` ‚Äî mono
- `target_dtype: "int16"` ‚Äî —Ñ–æ—Ä–º–∞—Ç –¥–ª—è ASR

**`server_audio_format`** (—Å—Ç—Ä–æ–∫–∏ 37-44)
- `sample_rate: 24000` ‚Äî –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- `channels: 1` ‚Äî mono
- `dtype: "int16"` ‚Äî 16-bit PCM

**`speech_playback`** (—Å—Ç—Ä–æ–∫–∏ 375-387)
- `sample_rate: 24000` ‚Äî —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ gRPC
- `channels: 1`
- `dtype: int16`
- `buffer_size: 512`
- `auto_output_device_switch: true` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**`voice_recognition`** (—Å—Ç—Ä–æ–∫–∏ 295-302)
- `enabled: true`
- `timeout_sec: 10.0`

**`input_processing`** (—Å—Ç—Ä–æ–∫–∏ 196-208)
- `mic_reset_timeout_sec: 60.0` ‚Äî —Ç–∞–π–º–∞—É—Ç —Å–±—Ä–æ—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π

- **–í—Å–µ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π**: 25 –≤ `unified_config.yaml`
- **–û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏**: `audio_system`, `default_audio`, `server_audio_format`, `speech_playback`, `voice_recognition`

---

## 4. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 4.1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

```
SpeechRecognizer
  ‚îú‚îÄ‚Üí AudioDeviceMonitor (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
  ‚îú‚îÄ‚Üí AudioRecoveryManager (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
  ‚îú‚îÄ‚Üí sounddevice.InputStream (–∑–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ)
  ‚îî‚îÄ‚Üí speech_recognition (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ)

SequentialSpeechPlayer
  ‚îú‚îÄ‚Üí sounddevice.OutputStream (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
  ‚îú‚îÄ‚Üí CoreAudioManager (macOS CoreAudio)
  ‚îî‚îÄ‚Üí PerformanceMonitor (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

VoiceRecognitionIntegration
  ‚îî‚îÄ‚Üí SpeechRecognizer

SpeechPlaybackIntegration
  ‚îî‚îÄ‚Üí SequentialSpeechPlayer

FirstRunPermissionsIntegration
  ‚îî‚îÄ‚Üí activate_microphone() (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç sounddevice.InputStream)
```

### 4.2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫

- **`sounddevice`** (PortAudio):
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `SpeechRecognizer`, `SequentialSpeechPlayer`, `activate_microphone()`
  - **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∞–º–∏
- **`speech_recognition`**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `SpeechRecognizer`
  - **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
- **`numpy`**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `SpeechRecognizer`, `SequentialSpeechPlayer`
  - **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö
- **`PyObjC`** (AVFoundation):
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: `CoreAudioManager` (—á–∞—Å—Ç–∏—á–Ω–æ)
  - **–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AVFoundation –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

---

## 5. –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### 5.1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–µ–Ω

#### –ö–ª–∞—Å—Å—ã

- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã (`DeviceDiscovery`, `DeviceMapping`, `RouteManager`) –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏

#### –§—É–Ω–∫—Ü–∏–∏

- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç**: `input_device_id`, `input_device_name`, `output_device_name` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
  - `SpeechRecognizer.input_device_id` / `input_device_name`
  - `SequentialSpeechPlayer.output_device_name`
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å feature flag –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

### 5.2. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–ø–æ—Ä—Ç–æ–≤

- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –ù–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã (`AVFoundation`, `AVAudioEngine`) –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏

### 5.3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ–±—ã—Ç–∏–π EventBus

#### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è

- `voice.recording_start` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `VoiceRecognitionIntegration`
- `voice.recording_stop` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `VoiceRecognitionIntegration`
- `voice.mic_opened` ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `VoiceRecognitionIntegration`
- `voice.mic_closed` ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `VoiceRecognitionIntegration`
- `playback.started` ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `SpeechPlaybackIntegration`
- `playback.completed` ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `SpeechPlaybackIntegration`

#### –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ EventBus)

- `audio.input.active` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
- `audio.output.ready` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
- `audio.device.changed` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
- `audio.route.snapshot` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç

- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏

### 5.4. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏

- `audio_system.*` ‚Äî —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è feature flags
- `default_audio.*` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è STT
- `server_audio_format.*` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è gRPC
- `speech_playback.*` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- `voice_recognition.*` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

#### –ù–æ–≤—ã–µ –∫–ª—é—á–∏

- `audio_route_manager.*` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
- `audio_route_manager.device_discovery.*` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
- `audio_route_manager.device_mapping.*` ‚Äî **–ù–û–í–û–ï**, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç

- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –ù–æ–≤—ã–µ –∫–ª—é—á–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏

### 5.5. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- **Input (–º–∏–∫—Ä–æ—Ñ–æ–Ω)**:
  - `SpeechRecognizer` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü —á–µ—Ä–µ–∑ `sounddevice.InputStream`
  - `activate_microphone()` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
  - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç**: –ï—Å–ª–∏ `activate_microphone()` –∏ `SpeechRecognizer` –ø—ã—Ç–∞—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **Output (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)**:
  - `SequentialSpeechPlayer` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü —á–µ—Ä–µ–∑ `sounddevice.OutputStream`
  - **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**: –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–ª–∞–¥–µ–ª–µ—Ü

#### –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- **Input (–º–∏–∫—Ä–æ—Ñ–æ–Ω)**:
  - `AudioRouteManager` ‚Äî **–ù–û–í–´–ô** –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü —á–µ—Ä–µ–∑ `AVFInputAdapter`
  - `SpeechRecognizer` ‚Äî **–ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–´–ô**, –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `AudioRouteManager`
  - `activate_microphone()` ‚Äî **–ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–´–ô**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `AudioRouteManager`
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
- **Output (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)**:
  - `AudioRouteManager` ‚Äî **–ù–û–í–´–ô** –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü —á–µ—Ä–µ–∑ `AVFOutputAdapter`
  - `SequentialSpeechPlayer` ‚Äî **–ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–´–ô**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `AudioRouteManager`
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞

---

## 6. –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### 6.1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: `SpeechRecognizer` –∏ `SequentialSpeechPlayer` –æ–±–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
  - `SpeechRecognizer._refresh_device_cache()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  - `SpeechRecognizer._get_device_name_by_id()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `SequentialSpeechPlayer._query_default_output_device()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `SequentialSpeechPlayer._check_and_update_output_device()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –≤ `AudioRouteManager`

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: `AudioDeviceMonitor` –∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π `AVFoundationDeviceMonitor`
  - `AudioDeviceMonitor` ‚Äî polling —á–µ—Ä–µ–∑ `sounddevice.default.device[0]`
  - `AVFoundationDeviceMonitor` ‚Äî —á–µ—Ä–µ–∑ `NSNotificationCenter` + polling
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞, —Å—Ç–∞—Ä—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  - `SpeechRecognizer._refresh_device_cache()` ‚Äî —á–µ—Ä–µ–∑ `sd.query_devices()`
  - `SequentialSpeechPlayer._query_default_output_device()` ‚Äî —á–µ—Ä–µ–∑ `sd.query_devices()`
  - `activate_microphone()` ‚Äî —á–µ—Ä–µ–∑ `sd.query_devices(kind='input')`
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ `DeviceDiscovery`

### 6.2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π EventBus

- ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è, –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã

### 6.3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

#### Input (–º–∏–∫—Ä–æ—Ñ–æ–Ω)

- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: `SpeechRecognizer` –∏ `activate_microphone()` –æ–±–∞ –º–æ–≥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Feature flag –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏, —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

#### Output (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)

- ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –¢–æ–ª—å–∫–æ `SequentialSpeechPlayer` —É–ø—Ä–∞–≤–ª—è–µ—Ç output

### 6.4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
  - `SpeechRecognizer.input_device_id` / `input_device_name`
  - `SequentialSpeechPlayer.output_device_name`
  - `AudioDeviceMonitor.current_input_device`
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ `RouteManager`

---

## 7. –ê–Ω–∞–ª–∏–∑ race conditions

### 7.1. Shared state –∑–∞—â–∏—â–µ–Ω–æ locks

#### `SpeechRecognizer`

- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `audio_data` –∑–∞—â–∏—â–µ–Ω–æ `audio_lock: threading.Lock`
- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `_stream_state` –∑–∞—â–∏—â–µ–Ω–æ `_stream_state_lock: threading.RLock`
- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã `_start_lock: asyncio.Lock`
- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: `listen_thread` –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—É—é state machine

#### `SequentialSpeechPlayer`

- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `_audio_stream` –∑–∞—â–∏—â–µ–Ω–æ `_stream_lock: threading.RLock`
- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `chunk_buffer` –∑–∞—â–∏—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ locks
- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `state_manager` –∑–∞—â–∏—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ locks

#### `AudioDeviceMonitor`

- ‚úÖ **–ó–∞—â–∏—â–µ–Ω–æ**: `current_input_device` –∑–∞—â–∏—â–µ–Ω–æ `_lock: threading.Lock`

### 7.2. Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏

#### `SpeechRecognizer`

- ‚úÖ **Thread-safe**: `_audio_callback()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `audio_lock`
- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: `_run_listening()` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—É—é state machine –∏ reconcile loop

#### `SequentialSpeechPlayer`

- ‚úÖ **Thread-safe**: `_audio_callback()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_stream_lock`
- ‚úÖ **Thread-safe**: `play_chunk()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_stream_lock`

### 7.3. Single-flight –º–µ—Ö–∞–Ω–∏–∑–º

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- ‚ö†Ô∏è **–ù–µ—Ç single-flight**: `SpeechRecognizer.start_listening()` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç reconcile loop —Å single-flight –º–µ—Ö–∞–Ω–∏–∑–º–æ–º

#### –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- ‚úÖ **Single-flight**: `AudioRouteManager.reconcile_routes()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç single-flight –º–µ—Ö–∞–Ω–∏–∑–º
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ `is_reconciling` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º reconcile

### 7.4. –ù–µ—Ç –≥–æ–Ω–æ–∫ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≥–æ–Ω–∫–∏**:
  - `SpeechRecognizer.listen_thread` –∏ `AudioDeviceMonitor._monitor_thread` –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `SequentialSpeechPlayer._playback_thread` –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å
  - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π monitoring thread –∏ reconcile loop

#### –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- ‚úÖ **–ù–µ—Ç –≥–æ–Ω–æ–∫**: –ï–¥–∏–Ω—ã–π monitoring thread –≤ `AudioRouteManagerIntegration`
- ‚úÖ **–ù–µ—Ç –≥–æ–Ω–æ–∫**: Reconcile loop —Å single-flight –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
- ‚úÖ **–ù–µ—Ç –≥–æ–Ω–æ–∫**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã locks

---

## 8. –ö–∞—Ä—Ç–∞ –≤–ª–∏—è–Ω–∏—è

### 8.1. –ú–æ–¥—É–ª–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

#### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

1. **`modules/voice_recognition/core/speech_recognizer.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
   - **Feature flag**: `audio_route_manager.enabled`
   - **Fallback**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

2. **`modules/speech_playback/core/player.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è output
   - **Feature flag**: `audio_route_manager.enabled`
   - **Fallback**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

3. **`modules/voice_recognition/core/audio_device_monitor.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ
   - **Feature flag**: `audio_route_manager.monitoring.enabled`
   - **Fallback**: –°—Ç–∞—Ä—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

#### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

4. **`modules/permissions/first_run/activator.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è `activate_microphone()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager`
   - **Feature flag**: `audio_route_manager.enabled`
   - **Fallback**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

#### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

5. **`modules/voice_recognition/core/audio_recovery_manager.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - **Feature flag**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `SpeechRecognizer`)

### 8.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

#### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

1. **`integration/integrations/voice_recognition_integration.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager`
   - **Feature flag**: `audio_route_manager.enabled`
   - **Fallback**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

2. **`integration/integrations/speech_playback_integration.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager`
   - **Feature flag**: `audio_route_manager.enabled`
   - **Fallback**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

#### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

3. **`integration/integrations/first_run_permissions_integration.py`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AudioRouteManager` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - **Feature flag**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `activate_microphone()`)

### 8.3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. **`config/unified_config.yaml`**
   - **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ `audio_route_manager.*`
   - **Feature flags**: –í—Å–µ feature flags —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `audio_system.*`

### 8.4. –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **`modules/audio_route_manager/`** (–ù–û–í–´–ô)
   - `core/device_discovery.py` ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ AVFoundation
   - `core/device_mapping.py` ‚Äî –º–∞–ø–ø–∏–Ω–≥ AVFoundation ‚Üí PortAudio
   - `core/route_manager.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
   - `core/reconcile_engine.py` ‚Äî reconcile loop
   - `core/input_state_machine.py` ‚Äî FSM –¥–ª—è input
   - `core/output_state_machine.py` ‚Äî FSM –¥–ª—è output
   - `core/adapters/avf_input_adapter.py` ‚Äî –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è input
   - `core/adapters/avf_output_adapter.py` ‚Äî –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è output

2. **`integration/integrations/audio_route_manager_integration.py`** (–ù–û–í–´–ô)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EventBus
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ input/output —á–µ—Ä–µ–∑ RouteManager

---

## 9. –ü–ª–∞–Ω –º–∏—Ç–∏–≥–∞—Ü–∏–∏

### 9.1. –ú–∏—Ç–∏–≥–∞—Ü–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

1. **Feature flags**: –í—Å–µ –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `audio_route_manager.enabled: true`
2. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback –ø—Ä–∏ `audio_route_manager.enabled: false`
3. **Kill-switch**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ `audio_route_manager.kill_switch: true`

### 9.2. –ú–∏—Ç–∏–≥–∞—Ü–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –≤ `AudioRouteManager`
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ feature flags
3. **–£–¥–∞–ª–µ–Ω–∏–µ**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞

### 9.3. –ú–∏—Ç–∏–≥–∞—Ü–∏—è race conditions

1. **–ï–¥–∏–Ω–∞—è state machine**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—É—é state machine –¥–ª—è input/output
2. **Single-flight –º–µ—Ö–∞–Ω–∏–∑–º**: Reconcile loop –∏—Å–ø–æ–ª—å–∑—É–µ—Ç single-flight –º–µ—Ö–∞–Ω–∏–∑–º
3. **Locks**: –í—Å–µ shared state –∑–∞—â–∏—â–µ–Ω–æ locks
4. **Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ thread-safe

### 9.4. –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **Unit —Ç–µ—Å—Ç—ã**: –¢–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. **Integration —Ç–µ—Å—Ç—ã**: –¢–µ—Å—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
3. **Regression —Ç–µ—Å—Ç—ã**: –¢–µ—Å—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
4. **End-to-end —Ç–µ—Å—Ç—ã**: –ü–æ–ª–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç

### –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω

- [x] –ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ
- [x] –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∞—É–¥–∏–æ
- [x] –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- [x] –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- [x] –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ê–Ω–∞–ª–∏–∑ race conditions
- [x] –ö–∞—Ä—Ç–∞ –≤–ª–∏—è–Ω–∏—è
- [x] –ü–ª–∞–Ω –º–∏—Ç–∏–≥–∞—Ü–∏–∏

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- ‚ö†Ô∏è **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- ‚ö†Ô∏è **Race conditions**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≥–æ–Ω–∫–∏ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏

### –ú–∏—Ç–∏–≥–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

- ‚úÖ **Feature flags**: –í—Å–µ –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã feature flags
- ‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º**: –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback
- ‚úÖ **Kill-switch**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è**: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- ‚úÖ **Thread-safety**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ thread-safe

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –≥–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

