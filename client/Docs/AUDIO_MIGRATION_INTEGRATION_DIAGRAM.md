# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°ÑƒĞ´Ğ¸Ğ¾-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚

## ğŸ”„ Ğ¡Ñ…ĞµĞ¼Ğ°: Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° â†’ ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° (Ğ”Ğ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ¢Ğ•ĞšĞ£Ğ©ĞĞ¯ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InputProcessing         â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ KeyboardMonitor       â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - voice.recording_    â”‚
â”‚     start/stop          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ voice.recording_start {session_id}
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VoiceRecognition        â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ SpeechRecognizer      â”‚
â”‚ â€¢ sr.Microphone         â”‚  â† ĞŸÑ€ÑĞ¼Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ¾Ğ¼
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - voice.mic_opened   â”‚
â”‚   - voice.recognition_* â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ voice.recognition_completed
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GrpcClient              â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² gRPC       â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - grpc.response.audio â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ grpc.response.audio
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SpeechPlayback          â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ SequentialSpeech      â”‚
â”‚   Player                â”‚
â”‚ â€¢ sounddevice.          â”‚  â† ĞŸÑ€ÑĞ¼Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ output
â”‚   OutputStream          â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - playback.started/   â”‚
â”‚     completed           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° (ĞŸĞĞ¡Ğ›Ğ• Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞĞĞ’ĞĞ¯ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InputProcessing         â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ KeyboardMonitor       â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - voice.recording_    â”‚
â”‚     start/stop          â”‚
â”‚                         â”‚
â”‚ âœ… Ğ‘Ğ•Ğ— Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ voice.recording_start {session_id}
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AudioRouteManagerIntegration (ĞĞĞ’ĞĞ¯)                            â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ RouteManager Core                                            â”‚â”‚
â”‚ â”‚ â€¢ DeviceDiscovery (AVFoundation)                             â”‚â”‚
â”‚ â”‚ â€¢ DeviceMapping (PortAudio)                                  â”‚â”‚
â”‚ â”‚ â€¢ Reconcile Engine                                           â”‚â”‚
â”‚ â”‚ â€¢ Input/Output State Machines                                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Adapters                                                     â”‚â”‚
â”‚ â”‚ â€¢ AVFInputAdapter (sounddevice.InputStream)                  â”‚â”‚
â”‚ â”‚   â””â”€â†’ Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ°                        â”‚â”‚
â”‚ â”‚ â€¢ AVFOutputAdapter (AVAudioEngine)                           â”‚â”‚
â”‚ â”‚   â””â”€â†’ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ default        â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Device Monitoring (Thread)                                   â”‚â”‚
â”‚ â”‚ â€¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ğ¶Ğ´ÑƒÑ ÑĞµĞºÑƒĞ½Ğ´Ñƒ                                    â”‚â”‚
â”‚ â”‚ â€¢ AVFoundation + PortAudio                                   â”‚â”‚
â”‚ â”‚ â€¢ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ                                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸:                                                       â”‚
â”‚ â€¢ voice.recording_start â†’ Ğ·Ğ°Ğ¿ÑƒÑĞº input Ñ‡ĞµÑ€ĞµĞ· reconcile         â”‚
â”‚ â€¢ voice.recording_stop â†’ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° input                        â”‚
â”‚ â€¢ app.mode_changed â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ        â”‚
â”‚ â€¢ permissions.first_run_* â†’ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸               â”‚
â”‚                                                                 â”‚
â”‚ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸:                                                     â”‚
â”‚ â€¢ audio.input.active â†’ input Ğ³Ğ¾Ñ‚Ğ¾Ğ², Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ       â”‚
â”‚ â€¢ audio.output.ready â†’ output Ğ³Ğ¾Ñ‚Ğ¾Ğ², Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ      â”‚
â”‚ â€¢ audio.device.changed â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ ÑĞ¼ĞµĞ½Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°        â”‚
â”‚ â€¢ audio.route.snapshot â†’ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° (Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â†’ audio.input.active {session_id, device_uid}
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VoiceRecognition        â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ SpeechRecognizer      â”‚
â”‚ â€¢ ĞĞ• ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚          â”‚  â† Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· AudioRouteManager
â”‚   Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ   â”‚
â”‚ â€¢ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ÑƒĞ´Ğ¸Ğ¾-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ â”‚
â”‚   Ğ¸Ğ· AudioRouteManager  â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - voice.mic_opened    â”‚  â† Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
â”‚   - voice.recognition_* â”‚
â”‚                         â”‚
â”‚ âœ… ĞĞ”ĞĞŸĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞĞ¯       â”‚
â”‚    (feature flag)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ voice.recognition_completed
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GrpcClient              â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² gRPC       â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - grpc.response.audio â”‚
â”‚                         â”‚
â”‚ âœ… Ğ‘Ğ•Ğ— Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ grpc.response.audio
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SpeechPlayback          â”‚
â”‚ Integration             â”‚
â”‚                         â”‚
â”‚ â€¢ ĞĞ• ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ output   â”‚  â† Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· AudioRouteManager
â”‚   Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ               â”‚
â”‚ â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ AVAudio    â”‚
â”‚   Engine Ñ‡ĞµÑ€ĞµĞ·          â”‚
â”‚   AudioRouteManager      â”‚
â”‚ â€¢ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚:            â”‚
â”‚   - playback.started/   â”‚  â† Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
â”‚     completed           â”‚
â”‚                         â”‚
â”‚ âœ… ĞĞ”ĞĞŸĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞĞ¯       â”‚
â”‚    (feature flag)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°: ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Input Flow (Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ)

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Control+N
   â”‚
   â–¼
2. InputProcessingIntegration
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: voice.recording_start {session_id: "123"}
   â”‚
   â–¼
3. AudioRouteManagerIntegration
   â”œâ”€â†’ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ: voice.recording_start
   â”œâ”€â†’ Reconcile loop:
   â”‚   â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚: permissions.mic, first_run, app_mode
   â”‚   â”œâ”€â†’ ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ: START (Ñ‡ĞµÑ€ĞµĞ· gateway)
   â”‚   â””â”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚: sounddevice.InputStream
   â”‚       â”œâ”€â†’ device_index: Ğ¸Ğ· DeviceMapping
   â”‚       â”œâ”€â†’ samplerate: fallback [48000, 16000, 44100, 48000]
   â”‚       â””â”€â†’ callback: _audio_callback â†’ audio_buffer
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: audio.input.active {session_id: "123", device_uid: "..."}
   â”‚
   â–¼
4. VoiceRecognitionIntegration
   â”œâ”€â†’ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ: audio.input.active
   â”œâ”€â†’ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ÑƒĞ´Ğ¸Ğ¾-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· AudioRouteManager (callback)
   â”œâ”€â†’ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ² Google SR
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: voice.mic_opened, voice.recognition_started
   â”‚
   â–¼
5. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Control+N
   â”‚
   â–¼
6. InputProcessingIntegration
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: voice.recording_stop {session_id: "123"}
   â”‚
   â–¼
7. AudioRouteManagerIntegration
   â”œâ”€â†’ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ: voice.recording_stop
   â”œâ”€â†’ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚: sounddevice.InputStream
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: audio.input.inactive {session_id: "123"}
   â”‚
   â–¼
8. VoiceRecognitionIntegration
   â”œâ”€â†’ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: voice.recognition_completed, voice.mic_closed
```

### Output Flow (Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ)

```
1. GrpcClientIntegration
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: grpc.response.audio {session_id: "123", audio_bytes: ...}
   â”‚
   â–¼
2. SpeechPlaybackIntegration
   â”œâ”€â†’ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ: grpc.response.audio
   â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚: audio.output.ready (Ğ¾Ñ‚ AudioRouteManager)
   â”œâ”€â†’ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚: AVAudioEngine Ñ‡ĞµÑ€ĞµĞ· AudioRouteManager
   â”‚   â”œâ”€â†’ AVFOutputAdapter.play_audio_chunk()
   â”‚   â”œâ”€â†’ numpy â†’ AVAudioPCMBuffer
   â”‚   â””â”€â†’ AVAudioPlayerNode.scheduleBuffer_()
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: playback.started, playback.completed
```

### Device Switching Flow (ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²)

```
1. AudioRouteManagerIntegration (Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ thread)
   â”œâ”€â†’ ĞšĞ°Ğ¶Ğ´ÑƒÑ ÑĞµĞºÑƒĞ½Ğ´Ñƒ:
   â”‚   â”œâ”€â†’ AVFoundation: get_input_devices(), get_output_devices()
   â”‚   â”œâ”€â†’ PortAudio: sd.default.device[0], sd.default.device[1]
   â”‚   â””â”€â†’ DeviceMapping: find_portaudio_match()
   â”‚
   â”œâ”€â†’ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚: Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° (UID Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ)
   â”‚
   â”œâ”€â†’ Reconcile loop:
   â”‚   â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚: Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (input/output active?)
   â”‚   â”œâ”€â†’ ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ: SWITCH (Ñ‡ĞµÑ€ĞµĞ· gateway)
   â”‚   â””â”€â†’ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ:
   â”‚       â”œâ”€â†’ Input: Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ stream, ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
   â”‚       â””â”€â†’ Output: Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ engine, Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ engine
   â”‚
   â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚: audio.device.changed {type: "input|output", old_uid, new_uid}
   â”‚
   â–¼
2. VoiceRecognitionIntegration / SpeechPlaybackIntegration
   â”œâ”€â†’ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ: audio.device.changed
   â””â”€â†’ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğº Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ñƒ (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
```

---

## ğŸ—ï¸ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

### ĞœĞ¾Ğ´ÑƒĞ»ÑŒ: `modules/audio_route_manager/`

```
modules/audio_route_manager/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ contracts.py
â”‚   â”‚   â”œâ”€â”€ DeviceInfo
â”‚   â”‚   â”œâ”€â”€ DeviceTransport
â”‚   â”‚   â”œâ”€â”€ MappingResult
â”‚   â”‚   â”œâ”€â”€ RouteSnapshot
â”‚   â”‚   â””â”€â”€ Confidence
â”‚   â”‚
â”‚   â”œâ”€â”€ device_discovery.py
â”‚   â”‚   â””â”€â”€ DeviceDiscovery
â”‚   â”‚       â”œâ”€â”€ get_input_devices() â†’ List[DeviceInfo]
â”‚   â”‚       â””â”€â”€ get_output_devices() â†’ List[DeviceInfo]
â”‚   â”‚
â”‚   â”œâ”€â”€ device_mapping.py
â”‚   â”‚   â””â”€â”€ DeviceMapping
â”‚   â”‚       â””â”€â”€ find_portaudio_match() â†’ MappingResult
â”‚   â”‚
â”‚   â”œâ”€â”€ route_manager.py
â”‚   â”‚   â””â”€â”€ RouteManager
â”‚   â”‚       â”œâ”€â”€ reconcile() â†’ Decision
â”‚   â”‚       â”œâ”€â”€ start_input() â†’ bool
â”‚   â”‚       â”œâ”€â”€ stop_input() â†’ bool
â”‚   â”‚       â”œâ”€â”€ start_output() â†’ bool
â”‚   â”‚       â””â”€â”€ switch_device() â†’ bool
â”‚   â”‚
â”‚   â”œâ”€â”€ reconcile_engine.py
â”‚   â”‚   â””â”€â”€ ReconcileEngine
â”‚   â”‚       â”œâ”€â”€ reconcile() â†’ Decision
â”‚   â”‚       â”œâ”€â”€ single_flight_lock
â”‚   â”‚       â””â”€â”€ debounce_manager
â”‚   â”‚
â”‚   â”œâ”€â”€ input_state_machine.py
â”‚   â”‚   â””â”€â”€ InputStateMachine
â”‚   â”‚       â”œâ”€â”€ transition_to()
â”‚   â”‚       â””â”€â”€ check_heartbeat()
â”‚   â”‚
â”‚   â”œâ”€â”€ output_state_machine.py
â”‚   â”‚   â””â”€â”€ OutputStateMachine
â”‚   â”‚       â”œâ”€â”€ transition_to()
â”‚   â”‚       â””â”€â”€ check_recreate_timeout()
â”‚   â”‚
â”‚   â””â”€â”€ adapters/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”‚
â”‚       â”œâ”€â”€ avf_input_adapter.py
â”‚       â”‚   â””â”€â”€ AVFInputAdapter
â”‚       â”‚       â”œâ”€â”€ start_stream() â†’ bool
â”‚       â”‚       â”œâ”€â”€ stop_stream() â†’ bool
â”‚       â”‚       â””â”€â”€ get_audio_callback() â†’ Callable
â”‚       â”‚
â”‚       â””â”€â”€ avf_output_adapter.py
â”‚           â””â”€â”€ AVFOutputAdapter
â”‚               â”œâ”€â”€ initialize_engine() â†’ bool
â”‚               â”œâ”€â”€ play_audio_chunk() â†’ bool
â”‚               â””â”€â”€ switch_device() â†’ bool
â”‚
â”œâ”€â”€ types.py
â””â”€â”€ README.md
```

### Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ: `integration/integrations/audio_route_manager_integration.py`

```
AudioRouteManagerIntegration
â”œâ”€â”€ __init__(event_bus, state_manager, error_handler, config)
â”‚   â”œâ”€â”€ self.route_manager: RouteManager
â”‚   â”œâ”€â”€ self.device_discovery: DeviceDiscovery
â”‚   â”œâ”€â”€ self.device_mapping: DeviceMapping
â”‚   â””â”€â”€ self.monitor_thread: Thread
â”‚
â”œâ”€â”€ async initialize()
â”‚   â”œâ”€â”€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ RouteManager
â”‚   â”œâ”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° EventBus
â”‚   â””â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²
â”‚
â”œâ”€â”€ async start()
â”‚   â””â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² (thread)
â”‚
â”œâ”€â”€ async stop()
â”‚   â””â”€â”€ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ¸ cleanup
â”‚
â”œâ”€â”€ async _on_recording_start(event)
â”‚   â””â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº input Ñ‡ĞµÑ€ĞµĞ· reconcile
â”‚
â”œâ”€â”€ async _on_recording_stop(event)
â”‚   â””â”€â”€ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° input
â”‚
â”œâ”€â”€ async _on_mode_changed(event)
â”‚   â””â”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
â”‚
â”œâ”€â”€ _monitor_devices() (thread)
â”‚   â””â”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² ĞºĞ°Ğ¶Ğ´ÑƒÑ ÑĞµĞºÑƒĞ½Ğ´Ñƒ
â”‚
â””â”€â”€ _publish_device_changed(type, old_uid, new_uid)
    â””â”€â”€ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ audio.device.changed
```

---

## ğŸ”Œ Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸

### SimpleModuleCoordinator

```python
# ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹)
def _create_integrations(self):
    # ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ...
    
    # 1. InstanceManager
    self.integrations['instance'] = InstanceManagerIntegration(...)
    
    # 2. HardwareId
    self.integrations['hardware_id'] = HardwareIdIntegration(...)
    
    # 3. FirstRunPermissions
    self.integrations['first_run'] = FirstRunPermissionsIntegration(...)
    
    # 4. PermissionRestart
    self.integrations['permission_restart'] = PermissionRestartIntegration(...)
    
    # 5. AudioRouteManager â† ĞĞĞ’ĞĞ• (Ğ¿ĞµÑ€ĞµĞ´ VoiceRecognition)
    audio_route_config = self.config.get('audio_route_manager', {})
    self.integrations['audio_route_manager'] = AudioRouteManagerIntegration(
        event_bus=self.event_bus,
        state_manager=self.state_manager,
        error_handler=self.error_handler,
        config=audio_route_config
    )
    
    # 6. Tray
    self.integrations['tray'] = TrayControllerIntegration(...)
    
    # 7. ModeManagement
    self.integrations['mode'] = ModeManagementIntegration(...)
    
    # 8. InputProcessing
    self.integrations['input'] = InputProcessingIntegration(...)
    
    # 9. VoiceRecognition â† Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ AudioRouteManager
    self.integrations['voice'] = VoiceRecognitionIntegration(...)
    
    # ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ...
    
    # 12. SpeechPlayback â† Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ AudioRouteManager
    self.integrations['speech'] = SpeechPlaybackIntegration(...)
```

---

## ğŸ›ï¸ Feature Flag Ğ¸ Kill-Switch

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

```yaml
# unified_config.yaml
audio_route_manager:
  enabled: false  # Feature flag (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½)
  kill_switch: false  # Kill-switch Ğ´Ğ»Ñ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°
  
  device_monitoring_interval_sec: 1.0
  reconcile_debounce_ms: 500
  
  input:
    fallback_samplerates: [48000, 16000, 44100, 48000]
    blocksize: 1024
    auto_device_switch: true
    
  output:
    auto_device_switch: true
    recreate_on_switch: true
```

### Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ĞºĞ¾Ğ´Ğµ

```python
# VoiceRecognitionIntegration
self._use_audio_route_manager = (
    unified_config.get('audio_route_manager', {}).get('enabled', False) and
    not unified_config.get('audio_route_manager', {}).get('kill_switch', False)
)

if self._use_audio_route_manager:
    # ĞĞ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°: AudioRouteManager
    await self.event_bus.publish("audio.input.request_start", {...})
else:
    # Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (fallback)
    await self._recognizer.start_listening()
```

---

## ğŸ“Š Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ EventBus (ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚)

### ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (AudioRouteManager)

```python
# Input ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
"audio.input.request_start"      # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° input
"audio.input.active"              # Input Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
"audio.input.inactive"            # Input Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½
"audio.input.device_changed"     # Input ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ

# Output ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
"audio.output.ready"               # Output Ğ³Ğ¾Ñ‚Ğ¾Ğ², Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ
"audio.output.device_changed"     # Output ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ

# ĞĞ±Ñ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
"audio.device.changed"            # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ ÑĞ¼ĞµĞ½Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° (input Ğ¸Ğ»Ğ¸ output)
"audio.route.snapshot"            # Ğ¡Ğ½Ğ¸Ğ¼Ğ¾Ğº ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸)
```

### Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)

```python
# Ğ’ÑĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ:
"voice.recording_start"           # â† InputProcessingIntegration
"voice.recording_stop"            # â† InputProcessingIntegration
"voice.mic_opened"                # â† VoiceRecognitionIntegration
"voice.mic_closed"                # â† VoiceRecognitionIntegration
"voice.recognition_started"        # â† VoiceRecognitionIntegration
"voice.recognition_completed"     # â† VoiceRecognitionIntegration
"playback.started"                # â† SpeechPlaybackIntegration
"playback.completed"              # â† SpeechPlaybackIntegration
```

---

## ğŸ”„ ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ

### Ğ¤Ğ°Ğ·Ğ° 1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (Ğ½ĞµĞ´ĞµĞ»Ñ 1-2)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flag: OFF (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)       â”‚
â”‚                                         â”‚
â”‚ â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ audio_route_manager   â”‚
â”‚ â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸                   â”‚
â”‚ â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² SimpleModuleCoordinator â”‚
â”‚ â€¢ Ğ¢ĞµÑÑ‚Ñ‹ (unit + integration)            â”‚
â”‚                                         â”‚
â”‚ âœ… Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ĞºĞ°Ğº Ñ€Ğ°Ğ½ÑŒÑˆĞµ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¤Ğ°Ğ·Ğ° 2: Shadow mode (Ğ½ĞµĞ´ĞµĞ»Ñ 3-4)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flag: 1% Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹          â”‚
â”‚                                         â”‚
â”‚ â€¢ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°:                  â”‚
â”‚   - Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (99% Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)    â”‚
â”‚   - ĞĞ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (1% Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)     â”‚
â”‚                                         â”‚
â”‚ â€¢ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³:                           â”‚
â”‚   - ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (success rate, latency)      â”‚
â”‚   - ĞÑˆĞ¸Ğ±ĞºĞ¸ (error rate, fallback)       â”‚
â”‚                                         â”‚
â”‚ âœ… ĞÑ‚ĞºĞ°Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°Ñ…                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¤Ğ°Ğ·Ğ° 3: Gradual rollout (Ğ½ĞµĞ´ĞµĞ»Ñ 5-8)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flag: 25% â†’ 50% â†’ 75%          â”‚
â”‚                                         â”‚
â”‚ â€¢ ĞŸĞ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°       â”‚
â”‚ â€¢ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ            â”‚
â”‚ â€¢ ĞÑ‚ĞºĞ°Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°Ñ…                   â”‚
â”‚                                         â”‚
â”‚ âœ… Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¤Ğ°Ğ·Ğ° 4: Full rollout (Ğ½ĞµĞ´ĞµĞ»Ñ 9)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flag: 100%                     â”‚
â”‚                                         â”‚
â”‚ â€¢ Ğ’ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ    â”‚
â”‚   Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ                                â”‚
â”‚ â€¢ Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°     â”‚
â”‚   (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)                         â”‚
â”‚                                         â”‚
â”‚ âœ… ĞĞ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° - production            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğº Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

### Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ

- [ ] ĞœĞ¾Ğ´ÑƒĞ»ÑŒ `audio_route_manager` ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
- [ ] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ `AudioRouteManagerIntegration` ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
- [ ] Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ (unit + integration)
- [ ] ĞĞµÑ‚ Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¹ Ğ² ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ğµ
- [ ] Feature flag Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾

### Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ

- [ ] Push-to-talk Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ (Ğ½Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)
- [ ] ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ (Ğ½Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)
- [ ] Ğ’ÑĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ (fallback mode)

### ĞŸÑ€Ğ¾Ñ†ĞµÑÑĞ½Ñ‹Ğµ

- [ ] ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ EventBus ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
- [ ] STATE_CATALOG.md Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
- [ ] interaction_matrix.yaml Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
- [ ] ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹
- [ ] Kill-switch Ğ¿Ñ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

---

## ğŸ¯ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Impact Map** Ğ´Ğ»Ñ Ğ­Ñ‚Ğ°Ğ¿Ğ° 1
2. **ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ STATE_CATALOG.md** Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¾ÑÑĞ¼Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
3. **ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ interaction_matrix.yaml** Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸
4. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ EventBus** Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
5. **ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ­Ñ‚Ğ°Ğ¿Ğ° 1** (Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ audio_route_manager)

