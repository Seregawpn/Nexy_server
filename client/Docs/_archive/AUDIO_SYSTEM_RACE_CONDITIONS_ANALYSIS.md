# –ê–Ω–∞–ª–∏–∑ –≥–æ–Ω–æ–∫ —É—Å–ª–æ–≤–∏–π, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ –∞—É–¥–∏–æ

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-12-24  
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-12-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´** (–∞—Ç–æ–º–∞—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω)

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ì–û–ù–ö–ê –£–°–õ–û–í–ò–ô: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤ `add_audio_data`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `modules/speech_playback/core/player.py:283-301`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 283-286: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ë–ï–ó –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
if self._audio_stream is not None:
    logger.warning(f"‚ö†Ô∏è [SAMPLE_RATE] –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º sample_rate...")
    self._stop_audio_stream()  # ‚ùå –ù–ï –ø–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π!

# –°—Ç—Ä–æ–∫–∞ 296-301: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ—Ç–æ–∫ —É–∂–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è
if self._audio_stream is None:
    logger.debug("üîç [OUTPUT] –ü–æ—Ç–æ–∫ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π...")
    self._start_audio_stream(device_id=device_id)  # ‚ùå –ú–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å!
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –≥–æ–Ω–∫–∏:**
1. –ß–∞–Ω–∫ A –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `sample_rate=24000`, –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω —Å `48000`
2. –ß–∞–Ω–∫ B –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å `sample_rate=24000`
3. –û–±–∞ –≤–∏–¥—è—Ç `_audio_stream is not None` –∏ –≤—ã–∑—ã–≤–∞—é—Ç `_stop_audio_stream()`
4. –û–±–∞ –≤–∏–¥—è—Ç `_audio_stream is None` –∏ –≤—ã–∑—ã–≤–∞—é—Ç `_start_audio_stream()`
5. –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∏–ª–∏ –ø–æ—Ç–µ—Ä—è –æ–¥–Ω–æ–≥–æ –∏–∑ —á–∞–Ω–∫–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –û–±–µ—Ä–Ω—É—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –≤ `_stream_lock`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É-–∏-—É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–ª—è `_audio_stream`

---

### 2. –ö–û–ù–§–õ–ò–ö–¢: `_sync_output_format` vs `_actual_sample_rate`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** 
- `modules/speech_playback/core/player.py:609-616` (_sync_output_format)
- `modules/speech_playback/core/player.py:454` (_start_audio_stream)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# _sync_output_format –∏–∑–º–µ–Ω—è–µ—Ç config.sample_rate (—Å—Ç—Ä–æ–∫–∞ 616)
if sample_rate is not None and sample_rate > 0 and sample_rate != self.config.sample_rate:
    self.config.sample_rate = sample_rate  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å _actual_sample_rate!

# –ù–æ _start_audio_stream –∏—Å–ø–æ–ª—å–∑—É–µ—Ç _actual_sample_rate (—Å—Ç—Ä–æ–∫–∞ 454)
playback_sample_rate = self._actual_sample_rate if self._actual_sample_rate is not None else self.config.sample_rate
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞:**
1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç `default_samplerate=48000`
2. `_sync_output_format` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `config.sample_rate=48000`
3. –ê—É–¥–∏–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `sample_rate=24000` –≤ metadata
4. `_actual_sample_rate=24000`, –Ω–æ `config.sample_rate=48000`
5. –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å `24000` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ), –Ω–æ `config.sample_rate` –æ—Å—Ç–∞–µ—Ç—Å—è `48000` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

**–†–µ—à–µ–Ω–∏–µ:**
- –ù–ï –∏–∑–º–µ–Ω—è—Ç—å `config.sample_rate` –≤ `_sync_output_format`, –µ—Å–ª–∏ –µ—Å—Ç—å `_actual_sample_rate`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è device sample_rate

---

### 3. –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/—Å—Ç–∞—Ä—Ç–∞ –ø–ª–µ–µ—Ä–∞

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `integration/integrations/speech_playback_integration.py:176-179, 302-308` (_on_audio_chunk)
- `integration/integrations/speech_playback_integration.py:545-549, 570-577` (_on_raw_audio)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

```python
# _on_audio_chunk (—Å—Ç—Ä–æ–∫–∏ 176-179, 302-308)
if self._player and not self._player.state_manager.is_playing and not self._player.state_manager.is_paused:
    if not self._player.initialize():
        await self._handle_error(...)
        return
# ... –ø–æ–∑–∂–µ ...
if state != PlaybackState.PLAYING:
    if not self._player.initialize():
        await self._handle_error(...)
        return
    if not self._player.start_playback():
        await self._handle_error(...)
        return

# _on_raw_audio (—Å—Ç—Ä–æ–∫–∏ 545-549, 570-577) - –¢–ê –ñ–ï –õ–û–ì–ò–ö–ê!
if (not self._player.state_manager.is_playing and not self._player.state_manager.is_paused):
    if not self._player.initialize():
        await self._handle_error(...)
        return
# ... –ø–æ–∑–∂–µ ...
elif state != PlaybackState.PLAYING:
    if not self._player.start_playback():
        await self._handle_error(...)
        return
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `_ensure_player_ready()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/—Å—Ç–∞—Ä—Ç–∞

---

### 4. –ì–û–ù–ö–ê: `resync_output_device` vs `add_audio_data`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `integration/integrations/speech_playback_integration.py:282` (_on_audio_chunk)
- `integration/integrations/speech_playback_integration.py:344` (_on_voice_mic_closed)
- `modules/speech_playback/core/player.py:193` (add_audio_data)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# _on_audio_chunk –≤—ã–∑—ã–≤–∞–µ—Ç resync_output_device (—Å—Ç—Ä–æ–∫–∞ 282)
changed = self._player.resync_output_device()  # –ú–æ–∂–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫

# –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ add_audio_data —Ç–æ–∂–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 193-214)
device_changed = self._check_and_update_output_device()
if device_changed:
    self._stop_audio_stream()
    self._start_audio_stream(device_id=device_id)
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –≥–æ–Ω–∫–∏:**
1. `resync_output_device` –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–∞–Ω–∫, `add_audio_data` —Ç–æ–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ
3. –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –ø–æ—Ç–µ—Ä—è –ø–æ—Ç–æ–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ—Ç–æ–∫–æ–º
- –°–¥–µ–ª–∞—Ç—å `resync_output_device` –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º

---

### 5. –ì–û–ù–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ `_audio_stream` –≤ `_start_audio_stream`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `modules/speech_playback/core/player.py:435-438`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
with self._stream_lock:  # ‚úÖ –ï—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    if self._audio_stream is not None:  # –ü—Ä–æ–≤–µ—Ä–∫–∞
        logger.warning("‚ö†Ô∏è –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω")
        return True
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ ...
```

**–ê–Ω–∞–ª–∏–∑:**
–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –µ—Å—Ç—å, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `_stop_audio_stream` —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ `add_audio_data` (—Å—Ç—Ä–æ–∫–∞ 285).

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –≤—ã–∑–æ–≤—ã `_stop_audio_stream` –∏ `_start_audio_stream` –∑–∞—â–∏—â–µ–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `add_audio_data` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞

---

## üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 6. –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï: Fallback –Ω–∞ 24000Hz

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `integration/integrations/speech_playback_integration.py:162` (_on_audio_chunk)
- `integration/integrations/speech_playback_integration.py:488` (_on_raw_audio)

**–ü—Ä–æ–±–ª–µ–º–∞:**
Fallback –Ω–∞ 24000Hz –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
```python
# _on_audio_chunk
src_sample_rate: Optional[int] = data.get("sample_rate") or 24000

# _on_raw_audio
sample_rate = data.get("sample_rate", 48000)  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô FALLBACK!
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - fallback –≤ `_on_raw_audio` –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ 24000Hz (—Å—Ç—Ä–æ–∫–∞ 497)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `DEFAULT_SAMPLE_RATE = 24000` –≤ –µ–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. **–û–±–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤ `add_audio_data` –≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É**
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç `_sync_output_format` vs `_actual_sample_rate`**
3. **–í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä—É—é—â—É—é—Å—è –ª–æ–≥–∏–∫—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥**

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
4. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å `resync_output_device` —Å `add_audio_data`**
5. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å fallback –≤ `_on_raw_audio`**

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏–µ):
6. **–î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≥–æ–Ω–æ–∫ —É—Å–ª–æ–≤–∏–π**
7. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–π –ø–æ—Ç–æ–∫–∞**

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥–æ–Ω–æ–∫:** 3 ‚úÖ **–í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–´**
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:** 1 ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù**
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π:** 2 ‚úÖ **–í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–´**
- **–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º:** 6 ‚úÖ **–í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–´**

## ‚úÖ –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-12-24  
**–ú–µ—Ç–æ–¥:** –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (–µ–¥–∏–Ω—ã–π lock + locked-–≤–µ—Ä—Å–∏–∏ –º–µ—Ç–æ–¥–æ–≤)

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ **–ì–æ–Ω–∫–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –≤ `add_audio_data`**
   - –í—Å—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–Ω–µ—Å–µ–Ω–∞ –ø–æ–¥ –µ–¥–∏–Ω—ã–π `_stream_lock`
   - –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_recreating_stream` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç re-entrancy
   - –°–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `_recreate_stream_if_needed_locked()`

2. ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç `_sync_output_format` vs `_actual_sample_rate`**
   - –†–∞–∑–¥–µ–ª–µ–Ω—ã `device_sample_rate` –∏ `content_sample_rate`
   - `config.sample_rate` –±–æ–ª—å—à–µ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∏–∑ `_sync_output_format`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `_device_sample_rate` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è device rate

3. ‚úÖ **–ì–æ–Ω–∫–∞ `resync_output_device` vs `add_audio_data`**
   - `resync_output_device` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º `_recreate_stream_if_needed_locked()`
   - –ú–µ—Ç–æ–¥ —Å—Ç–∞–ª –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è)

4. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**
   - –°–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `_ensure_player_ready()` –≤ `speech_playback_integration.py`
   - –í—Å—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ –≤—ã–∑–æ–≤ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞

5. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ fallback –Ω–∞ 24000Hz**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω fallback –≤ `_on_raw_audio` (–±—ã–ª–æ 48000, —Å—Ç–∞–ª–æ 24000)

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

- **Locked-–≤–µ—Ä—Å–∏–∏ –º–µ—Ç–æ–¥–æ–≤:** `_stop_audio_stream_locked()`, `_start_audio_stream_locked()`, `_sync_output_format_locked()`
- **–ú–µ—Ç—Ä–∏–∫–∏:** `_stream_recreate_count`, `_stream_recreate_reasons` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **–ó–∞—â–∏—Ç–∞ –æ—Ç re-entrancy:** —Ñ–ª–∞–≥ `_recreating_stream`
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ device:** `_current_device_id`, `_stream_sample_rate` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `threading.Lock` –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏—è—Ö
- [ ] –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π —Å `_audio_stream`
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å `config.sample_rate` –∏ `_actual_sample_rate`

