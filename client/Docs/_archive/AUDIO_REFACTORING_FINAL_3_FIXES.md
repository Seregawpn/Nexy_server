# –§–∏–Ω–∞–ª—å–Ω—ã–µ 3 —Ç–æ–Ω–∫–∏—Ö —Ñ–∏–∫—Å–∞ - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–∏—Å–∫–æ–≤

**–î–∞—Ç–∞:** 2025-12-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ 3 —Ñ–∏–∫—Å–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∏–∫—Å—ã

### 1. ‚úÖ Generation counter –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö callback'–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** Callback –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ä—ã–π stream, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞–∫—Ä—ã—Ç, —á—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å race/crash.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `_stream_gen` (int) - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º recreate
- –î–æ–±–∞–≤–ª–µ–Ω `_current_stream_gen` - generation —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ stream
- Callback –ø—Ä–æ–≤–µ—Ä—è–µ—Ç generation –∏ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è - –Ω–µ –ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç –Ω—É–ª—è–º–∏)

**–ö–æ–¥:**
```python
# –í __init__:
self._stream_gen: int = 0
self._current_stream_gen: int = 0

# –ü—Ä–∏ recreate (–ø–æ–¥ lock):
self._stream_gen += 1
new_stream_gen = self._stream_gen
# ... –æ—Ç—Å–æ–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π stream ...

# –í callback:
current_gen = self._current_stream_gen
callback_stream_gen = getattr(self, '_callback_stream_gen', None)

if callback_stream_gen is None:
    callback_stream_gen = current_gen
    self._callback_stream_gen = callback_stream_gen
elif callback_stream_gen != current_gen:
    # Stream –±—ã–ª –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω - —ç—Ç–æ—Ç callback —É—Å—Ç–∞—Ä–µ–ª
    outdata[:] = 0
    return  # –ù–µ –ø–∏—à–µ–º –≤ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π stream
```

**–ó–∞—â–∏—Ç–∞:**
- Callback –Ω–µ –ø–∏—à–µ—Ç –≤ –∑–∞–∫—Ä—ã—Ç—ã–π/—É—Å—Ç–∞—Ä–µ–≤—à–∏–π stream
- –ù–µ—Ç race conditions –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ PortAudio –¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ä—ã–π stream

---

### 2. ‚úÖ Cooldown –Ω–∞ device query (–∑–∞—â–∏—Ç–∞ –æ—Ç "–≤–µ—á–Ω–æ–≥–æ need_device")

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `_query_default_output_device()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –∏–ª–∏ device_id –Ω–µ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è, –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π —á–∞–Ω–∫.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω cooldown 500ms –º–µ–∂–¥—É device queries
- –ï—Å–ª–∏ device –Ω–µ –Ω–∞–π–¥–µ–Ω - –ª–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞—Ç—å —á–∞–Ω–∫–∏ –¥–∞–∂–µ –µ—Å–ª–∏ device –Ω–µ –Ω–∞–π–¥–µ–Ω

**–ö–æ–¥:**
```python
# –í __init__:
self._last_device_query_ts: float = 0.0
self._device_query_cooldown_sec: float = 0.5  # 500ms

# –í add_audio_data:
current_time = time.time()
if current_time - self._last_device_query_ts >= self._device_query_cooldown_sec:
    device_changed, device_id, device_sr = self._detect_output_device_change()
    self._last_device_query_ts = current_time
else:
    # Cooldown –∞–∫—Ç–∏–≤–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
    logger.debug("üîç [OUTPUT] Device query –≤ cooldown, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à")

# –ï—Å–ª–∏ device –Ω–µ –Ω–∞–π–¥–µ–Ω:
if device_id is None:
    if (current_time - getattr(self, '_device_not_found_last_log', 0)) >= 5.0:
        logger.warning("‚ö†Ô∏è [DEVICE] Device –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é. –ß–∞–Ω–∫–∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è.")
        self._device_not_found_last_log = current_time
```

**–ó–∞—â–∏—Ç–∞:**
- –ù–µ—Ç —Å–ø–∞–º–∞ device queries (–º–∞–∫—Å–∏–º—É–º 2 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫)
- –ù–µ—Ç —Å–ø–∞–º–∞ –ª–æ–≥–æ–≤ (–º–∞–∫—Å–∏–º—É–º 1 –ª–æ–≥/5 —Å–µ–∫)
- –ß–∞–Ω–∫–∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è - –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è –¥–∞–∂–µ –±–µ–∑ device

---

### 3. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç playback –±–µ–∑ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ stream —Å–æ–∑–¥–∞–Ω —Å `device_sr` (48kHz), –∞ –¥–∞–Ω–Ω—ã–µ `content_sr` (24kHz), –∑–≤—É–∫ –±—É–¥–µ—Ç –≤ 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –∏ –≤—ã—à–µ –ø–æ —Ç–æ–Ω—É.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_needs_resample` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ stream
- –ï—Å–ª–∏ `stream_sr != content_sr` –∏ —Ä–µ—Å–µ–º–ø–ª–µ—Ä –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω - –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º (—Ç–æ–ª—å–∫–æ –±—É—Ñ–µ—Ä–∏–∑—É–µ–º)
- –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑

**–ö–æ–¥:**
```python
# –í __init__:
self._needs_resample: bool = False
self._resample_warning_logged: bool = False

# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ stream:
if actual_stream_sr != content_sr_actual:
    self._needs_resample = True
    if not self._resample_warning_logged:
        logger.warning(
            f"‚ö†Ô∏è [RESAMPLE] Stream —Å–æ–∑–¥–∞–Ω —Å sr={actual_stream_sr}Hz, –Ω–æ content_sr={content_sr_actual}Hz. "
            f"–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥! Playback –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º."
        )
        self._resample_warning_logged = True

# –í callback:
if self._needs_resample:
    # –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω - –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º, —Ç–æ–ª—å–∫–æ –±—É—Ñ–µ—Ä–∏–∑—É–µ–º
    outdata[:] = 0
    if not hasattr(self, '_resample_playback_skipped_logged'):
        logger.warning(
            f"‚ö†Ô∏è [RESAMPLE] –ü—Ä–æ–ø—É—Å–∫ playback: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥, –Ω–æ —Ä–µ—Å–µ–º–ø–ª–µ—Ä –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω. "
            f"–î–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è, –Ω–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è."
        )
        self._resample_playback_skipped_logged = True
    return
```

**–ó–∞—â–∏—Ç–∞:**
- –ù–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ playback (–±—ã—Å—Ç—Ä—ã–π/–≤—ã—Å–æ–∫–∏–π –∑–≤—É–∫)
- –î–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è (–Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è)
- –Ø–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞

---

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Generation counter

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º recreate: `_stream_gen += 1`
2. –ü—Ä–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏: `_current_stream_gen = new_stream_gen`
3. –í callback: –ø—Ä–æ–≤–µ—Ä—è–µ–º `callback_stream_gen == current_gen`
4. –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç - callback —É—Å—Ç–∞—Ä–µ–ª, –Ω–µ –ø–∏—à–µ–º –¥–∞–Ω–Ω—ã–µ

**–ó–∞—â–∏—Ç–∞ –æ—Ç:**
- Callback –ø–∏—à–µ—Ç –≤ –∑–∞–∫—Ä—ã—Ç—ã–π stream
- Race conditions –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏
- Crash –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É stream

### Cooldown –Ω–∞ device query

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `current_time - _last_device_query_ts >= cooldown`
2. –ï—Å–ª–∏ cooldown –∞–∫—Ç–∏–≤–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
3. –ï—Å–ª–∏ device –Ω–µ –Ω–∞–π–¥–µ–Ω - –ª–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥

**–ó–∞—â–∏—Ç–∞ –æ—Ç:**
- –°–ø–∞–º device queries (CPU –Ω–∞–≥—Ä—É–∑–∫–∞)
- –°–ø–∞–º –ª–æ–≥–æ–≤ (—à—É–º –≤ –ª–æ–≥–∞—Ö)
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª `need_device=True`

### –ó–∞—â–∏—Ç–∞ –æ—Ç playback –±–µ–∑ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ stream –ø—Ä–æ–≤–µ—Ä—è–µ–º `stream_sr != content_sr`
2. –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç - —Å—Ç–∞–≤–∏–º `_needs_resample = True`
3. –í callback –µ—Å–ª–∏ `_needs_resample` - –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º (—Ç–æ–ª—å–∫–æ –±—É—Ñ–µ—Ä–∏–∑—É–µ–º)

**–ó–∞—â–∏—Ç–∞ –æ—Ç:**
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π playback (–±—ã—Å—Ç—Ä—ã–π/–≤—ã—Å–æ–∫–∏–π –∑–≤—É–∫)
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö (–¥–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è)
- –°–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—è–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)

---

## üß™ –ú–∏–Ω–∏-—á–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. AirPods: –ø–æ–¥–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å 5-10 —Ä–∞–∑

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- ‚úÖ –ù–µ—Ç crash
- ‚úÖ `_stream_recreate_count` —Ä–∞—Å—Ç—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ (‚â§ 10)
- ‚úÖ –ù–µ—Ç "need_device spam" –≤ –ª–æ–≥–∞—Ö
- ‚úÖ Generation counter —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö callback'–æ–≤)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –∏—â–∏:
grep "RECREATE" logs.md | wc -l  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â§ 10
grep "need_device" logs.md | wc -l  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â§ 5
grep "–£—Å—Ç–∞—Ä–µ–≤—à–∏–π callback" logs.md  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
```

### 2. Fallback scenario: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –Ω–∞ content_sr

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- ‚úÖ Stream –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–∞ device_sr (48kHz)
- ‚úÖ `_needs_resample = True`
- ‚úÖ Playback –Ω–µ –∏–¥—ë—Ç (–∏–ª–∏ –µ—Å—Ç—å —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥)
- ‚úÖ –ß–∞–Ω–∫–∏ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è
- ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ "resampler required"

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –∏—â–∏:
grep "RESAMPLE" logs.md  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
grep "needs_resample=True" logs.md  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ stream
grep "–ü—Ä–æ–ø—É—Å–∫ playback" logs.md  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ callback
```

### 3. Concurrency storm: 10 –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞—é—Ç add_audio_data

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- ‚úÖ –ù–µ—Ç "–∑–∞–ª–∏–ø–ª–æ" –ø–æ `_recreating_stream`
- ‚úÖ `_recreating_stream` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ False
- ‚úÖ Generation counter —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç race conditions

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –∏—â–∏:
grep "–∑–∞–ª–∏–ø–ª–æ" logs.md  # –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
grep "_recreating_stream=True" logs.md | tail -1  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å False –≤ –∫–æ–Ω—Ü–µ
grep "stream_gen" logs.md | tail -20  # Generation –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### Generation counter

- `_stream_gen` - –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ (–¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º recreate)
- `_current_stream_gen` - generation –∞–∫—Ç–∏–≤–Ω–æ–≥–æ stream (–¥–ª—è callback)
- –í –ª–æ–≥–∞—Ö: `gen=X‚ÜíY` –ø—Ä–∏ –∫–∞–∂–¥–æ–º recreate

### Cooldown

- `_last_device_query_ts` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ query
- –í –ª–æ–≥–∞—Ö: "Device query –≤ cooldown" –µ—Å–ª–∏ cooldown –∞–∫—Ç–∏–≤–µ–Ω
- –ß–∞—Å—Ç–æ—Ç–∞ queries: –º–∞–∫—Å–∏–º—É–º 2 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫

### Resample protection

- `_needs_resample` - —Ñ–ª–∞–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞
- –í –ª–æ–≥–∞—Ö: "RESAMPLE" –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –í –ª–æ–≥–∞—Ö: "–ü—Ä–æ–ø—É—Å–∫ playback" –µ—Å–ª–∏ —Ä–µ—Å–µ–º–ø–ª–µ—Ä –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω**
   - Playback –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –µ—Å–ª–∏ `stream_sr != content_sr`
   - –î–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è (–Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è)
   - –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

2. **Generation counter —á–∏—Ç–∞–µ—Ç—Å—è –±–µ–∑ lock –≤ callback**
   - –ß—Ç–µ–Ω–∏–µ int –∞—Ç–æ–º–∞—Ä–Ω–æ –Ω–∞ Python (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
   - –ù–æ –≤ –∏–¥–µ–∞–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–µ—Ä–µ–∑ snapshot

3. **Cooldown —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (500ms)**
   - –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —á–µ—Ä–µ–∑ config
   - –ù–æ 500ms –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ **Generation counter:** –ü—Ä–∏–º–µ–Ω–µ–Ω, –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö callback'–æ–≤
- ‚úÖ **Cooldown –Ω–∞ device query:** –ü—Ä–∏–º–µ–Ω–µ–Ω, –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–ø–∞–º–∞
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç playback –±–µ–∑ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∞, –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–≤—É–∫–∞

**–í—Å–µ 3 —Ç–æ–Ω–∫–∏—Ö —Ä–∏—Å–∫–∞ –∑–∞–∫—Ä—ã—Ç—ã!**

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–Ω–∏-—á–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ production
3. **–†–µ—Å–µ–º–ø–ª–∏–Ω–≥:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —è–≤–Ω—ã–π —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–ì–æ—Ç–æ–≤–æ –∫ production!**


