# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è: First-Run Permissions

## –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: cursor
- –¢–∏–ø: task-brief
- –î–∞—Ç–∞: 2026-01-13
- –°—Ç–∞—Ç—É—Å: completed

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** `check_first_run_state.py` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π `ApplicationStateManager`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç runtime-—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.

**Root Cause:** State –≤ `ApplicationStateManager` ‚Äî in-memory. –ù–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ —Ñ–ª–∞–≥ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è, –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã.

## –†–µ—à–µ–Ω–∏–µ

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ offline –∏ runtime –ø—Ä–æ–≤–µ—Ä–æ–∫ ‚úÖ

**Offline —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ –∏ –ª–æ–≥–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç StateManager (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä, –Ω–µ –≤–∞–ª–∏–¥–µ–Ω)

**Runtime —Ä–µ–∂–∏–º (—Å —Ñ–ª–∞–≥–æ–º `--runtime`):**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç StateManager —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–∞–±–æ—Ç–∞—é—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª—ë–Ω `check_first_run_state.py` ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω offline —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ –∏ –ª–æ–≥–∏
- –î–æ–±–∞–≤–ª–µ–Ω runtime —Ä–µ–∂–∏–º (—Å `--runtime`): –ø—Ä–æ–≤–µ—Ä—è–µ—Ç StateManager
- –ß—ë—Ç–∫–æ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ StateManager –∏–∑ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –ª–æ–≥–∞—Ö (`permissions.*`)

**–§—É–Ω–∫—Ü–∏–∏:**
- `check_offline_state()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ –∏ –ª–æ–≥–æ–≤
- `check_runtime_state()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ StateManager (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# Offline —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
python3 scripts/check_first_run_state.py

# Runtime —Ä–µ–∂–∏–º
python3 scripts/check_first_run_state.py --runtime
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω QA-–ø–ª–∞–Ω ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ offline/runtime —Ä–µ–∂–∏–º–æ–≤
- –ß—ë—Ç–∫–æ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ StateManager –∏–∑ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 3. –û–±–Ω–æ–≤–ª—ë–Ω QA-–æ—Ç—á—ë—Ç ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è offline/runtime –ø—Ä–æ–≤–µ—Ä–æ–∫
- –£–±—Ä–∞–Ω–∞ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ "first_run_* from new ApplicationStateManager" –∫–∞–∫ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –£–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –≤ offline —Ä–µ–∂–∏–º–µ ‚Äî —Ñ–ª–∞–≥ –∏ –ª–æ–≥–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è

### Offline —Ä–µ–∂–∏–º
- ‚úÖ `permissions_first_run_completed.flag` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- ‚úÖ –°–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥–∞—Ö (`permissions.*`) ‚Äî –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- ‚ùå StateManager ‚Äî –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä, –Ω–µ –≤–∞–ª–∏–¥–µ–Ω)

### Runtime —Ä–µ–∂–∏–º
- ‚úÖ StateManager ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã

### Offline (–±–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
1. **–§–ª–∞–≥:** `permissions_first_run_completed.flag`
2. **–õ–æ–≥–∏:** —Å–æ–±—ã—Ç–∏—è `permissions.*` –≤ –ª–æ–≥–∞—Ö

### Runtime (—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º)
1. **StateManager:** —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **–§–ª–∞–≥:** `permissions_first_run_completed.flag`
3. **–õ–æ–≥–∏:** —Å–æ–±—ã—Ç–∏—è `permissions.*` –≤ –ª–æ–≥–∞—Ö

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### Offline —Ä–µ–∂–∏–º
```
=== First Run State Check (OFFLINE MODE) ===
‚ÑπÔ∏è  StateManager –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ offline —Ä–µ–∂–∏–º–µ (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)
    –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: —Ñ–ª–∞–≥ –∏ –ª–æ–≥–∏

üìã –§–ª–∞–≥ first-run:
   exists: True
   path: /Users/.../permissions_first_run_completed.flag
   size: 0 bytes
   ‚úÖ First-run –∑–∞–≤–µ—Ä—à—ë–Ω (—Ñ–ª–∞–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

üìã –°–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥–∞—Ö:
   log_file: logs/nexy.log
   ‚úÖ permissions.first_run_started: 3 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
   ‚úÖ permissions.first_run_completed: 18 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
   ...
```

### Runtime —Ä–µ–∂–∏–º
```
=== First Run State Check (RUNTIME MODE) ===
‚ö†Ô∏è  Runtime —Ä–µ–∂–∏–º —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    StateManager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

üìã StateManager —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
   first_run_in_progress: False
   first_run_required: None
   first_run_completed: False
   ...

‚ö†Ô∏è  –í–ê–ñ–ù–û: –≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –Ω–æ–≤–æ–≥–æ ApplicationStateManager
    –û–Ω–æ –≤–∞–ª–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–∞–±–æ—Ç–∞—é—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ offline —Ä–µ–∂–∏–º (—Ñ–ª–∞–≥ + –ª–æ–≥–∏)
```

## –í—ã–≤–æ–¥—ã

- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞: —Ä–∞–∑–¥–µ–ª–µ–Ω—ã offline –∏ runtime –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ Offline —Ä–µ–∂–∏–º: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ –∏ –ª–æ–≥–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- ‚úÖ Runtime —Ä–µ–∂–∏–º: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç StateManager —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
- ‚úÖ QA-–¥–æ–∫—É–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º offline/runtime
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –¥–∞–≤–∞—Ç—å –ª–æ–∂–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ Offline —Ä–µ–∂–∏–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
2. ‚úÖ Runtime —Ä–µ–∂–∏–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
3. ‚úÖ QA-–¥–æ–∫—É–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
4. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è runtime —Ä–µ–∂–∏–º–∞)
