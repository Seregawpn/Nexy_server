# Следующие шаги: First-Run Permissions

## Метаданные
- Ассистент: cursor
- Тип: task-brief
- Дата: 2026-01-13
- Статус: ready for next steps

## Текущий статус

### Выполнено ✅
1. ✅ Очистка флагов — выполнена
2. ✅ Сброс TCC разрешений — все 4 разрешения сброшены
3. ✅ Golden logs тест — 3/4 тестов пройдено
4. ✅ Проверка состояния (offline) — флаг создан, события найдены

### Требует выполнения ⏳
1. ⏳ Интеграционный тест — был отменён, требуется повторный запуск
2. ⏳ Визуальная проверка диалогов — обязательна для подтверждения канона

## Следующие шаги

### Шаг 1: Запустить интеграционный тест (опционально)

**Если нужно проверить автоматически:**
```bash
bash scripts/test_first_run_integration.sh
```

**Что проверяет:**
- События `permissions.first_run_started`
- События `permissions.first_run_completed`
- События `permissions.first_run_restart_pending`
- Создание флага `permissions_first_run_completed.flag`

**Примечание:** Этот тест запускает приложение в фоне на 90 секунд, поэтому может быть отменён для визуальной проверки.

### Шаг 2: Визуальная проверка диалогов (ОБЯЗАТЕЛЬНО)

**Подготовка уже выполнена:**
- ✅ Флаги очищены
- ✅ TCC разрешения сброшены

**Запуск приложения:**
```bash
# Если есть собранная .app
open dist/Nexy.app

# Или запуск напрямую
python3 main.py
```

**Что проверить:**

1. **Порядок диалогов:**
   - [ ] Accessibility (первый диалог)
   - [ ] Microphone (второй диалог)
   - [ ] Screen Capture (третий диалог)
   - [ ] Input Monitoring (четвёртый, последний диалог)

2. **Поведение диалогов:**
   - [ ] Диалоги появляются последовательно (не одновременно)
   - [ ] Каждый диалог появляется после предыдущего
   - [ ] После предоставления разрешения → переход к следующему (без ожидания 13s)
   - [ ] После отказа → переход к следующему (без fallback диалога сразу)

3. **Fallback диалог:**
   - [ ] Fallback (in-app dialog) появляется только после таймаута всех разрешений
   - [ ] Кнопка "Open Settings" открывает System Settings
   - [ ] Нет прямого открытия Settings из activator

### Шаг 3: Зафиксировать результаты

**После визуальной проверки:**
1. Зафиксировать результаты в отчёте
2. Подтвердить соответствие канону
3. Отметить выполненные пункты чек-листа

## Чек-лист полной проверки

### Автоматические проверки ✅
- [x] `clear_first_run_flags.py` — флаги очищены
- [x] `reset_tcc_for_first_run.sh` — все 4 разрешения сброшены
- [ ] `test_first_run_integration.sh` — события найдены, флаг создан (требует запуска)
- [x] `test_golden_first_run_logs.py` — последовательность соответствует канону (3/4)
- [x] `check_first_run_state.py` — флаг и события в логах

### Визуальная проверка диалогов ⏳
- [ ] Порядок диалогов: Accessibility → Microphone → Screen Capture → Input Monitoring
- [ ] Диалоги появляются последовательно (не параллельно)
- [ ] Ранний переход при предоставлении разрешения (без ожидания 13s)
- [ ] Fallback диалог появляется только после таймаута всех разрешений
- [ ] Нет прямого открытия Settings из activator

### Проверка логов ✅
- [x] Событие `permissions.first_run_started` публикуется
- [x] События `permissions.status_checked` для каждого разрешения
- [x] События `permissions.changed` при изменении статуса
- [x] Событие `permissions.first_run_restart_pending` (если нужен рестарт)
- [x] Событие `permissions.first_run_completed` публикуется
- [x] Все события содержат `session_id`

## Рекомендации

### Приоритет 1: Визуальная проверка
**Самое важное** — визуально подтвердить порядок диалогов и поведение fallback. Это единственный способ убедиться, что канон соблюдён на практике.

### Приоритет 2: Интеграционный тест
Если визуальная проверка прошла успешно, можно запустить интеграционный тест для автоматической проверки событий.

### Приоритет 3: Документация
После всех проверок зафиксировать результаты в финальном отчёте.

## Готовность к проверке

**Текущее состояние:**
- ✅ Окружение подготовлено (флаги очищены, TCC сброшены)
- ✅ Автоматические проверки частично выполнены
- ⏳ Визуальная проверка готова к выполнению

**Следующее действие:**
Запустить приложение для визуальной проверки диалогов.
