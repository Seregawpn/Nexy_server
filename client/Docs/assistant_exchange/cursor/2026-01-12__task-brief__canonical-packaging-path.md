# Task Brief: Canonical Packaging Path

**Дата:** 2026-01-12  
**Тип:** task-brief  
**Ассистент:** cursor  
**Статус:** ✅ Завершено

---

## Задача

Создать единую техническую инструкцию, чтобы все изменения всегда проходили через канонический packaging-контур без ручных исключений.

### Root Cause

Нет чёткой инструкции «что делать при изменении» → пропуски в обновлении артефактов → несоответствие macOS требованиям.

---

## Решение

Создан единый обязательный процесс для любых изменений с четкими триггерами и шагами.

### Измененные файлы

1. **`Docs/PACKAGING_FINAL_GUIDE.md`** (обновлен раздел 0):
   - Добавлен детальный раздел "ОБЯЗАТЕЛЬНЫЙ ПРОЦЕСС ИЗМЕНЕНИЙ (Canonical Packaging Path)"
   - Определены четкие триггеры изменений (Change Triggers)
   - Описан обязательный процесс из 5 шагов:
     1. Обновление артефактов упаковки
     2. Прохождение PRE_PACKAGING_VERIFICATION.md
     3. Выполнение build_final.sh (ЕДИНСТВЕННЫЙ СПОСОБ)
     4. Проверка артефактов
     5. Валидация релизного бандла
   - Добавлены запреты и ограничения
   - Добавлен чек-лист перед мерджем

2. **`Docs/PRE_PACKAGING_VERIFICATION.md`** (создан):
   - Создан актуальный чек-лист проверки перед упаковкой
   - Включает 10 разделов проверки:
     1. Проверка триггеров изменений
     2. Проверка окружения
     3. Проверка артефактов упаковки
     4. Проверка зависимостей
     5. Проверка конфигурации
     6. Проверка ресурсов
     7. Проверка кода
     8. Проверка тестов
     9. Фиксация результатов
     10. Готовность к упаковке

3. **`Docs/PACKAGING_READINESS_CHECKLIST.md`** (создан):
   - Создан шаблон для фиксации результатов проверки
   - Включает все пункты из PRE_PACKAGING_VERIFICATION.md
   - Предназначен для заполнения перед каждым запуском build_final.sh

---

## Архитектурное соответствие

- ✅ **Source of Truth:** `PACKAGING_FINAL_GUIDE.md` — единый источник истины
- ✅ **Централизация:** Все инструкции ссылаются на PACKAGING_FINAL_GUIDE.md
- ✅ **Запрет дублирования:** Запрещены ручные/альтернативные инструкции вне PACKAGING_FINAL_GUIDE.md
- ✅ **Machine-enforced:** Процесс четко описан и может быть автоматизирован

---

## Триггеры изменений

Определены четкие триггеры для следующих областей:

| Область | Файлы/Директории | Действие |
|---------|------------------|----------|
| **Код приложения** | `main.py`, `integration/`, `modules/` | Полный цикл упаковки |
| **Ресурсы** | `resources/`, `assets/`, `vendor_binaries/` | Полный цикл упаковки |
| **Конфигурация упаковки** | `packaging/`, `scripts/` | Полный цикл упаковки |
| **Зависимости** | `requirements.txt`, `pyproject.toml` | Полный цикл упаковки |

---

## Обязательный процесс (5 шагов)

1. **Обновление артефактов упаковки:**
   - Обновить `packaging/Nexy.spec` (для новых ресурсов/бинарников)
   - Обновить `scripts/stage_universal_binaries.py` (для новых бинарников в vendor_binaries/)
   - Проверить, что файлы попадают в `.app/Contents/Resources/`

2. **Прохождение PRE_PACKAGING_VERIFICATION.md:**
   - Пройти чек-лист из 10 разделов
   - Зафиксировать результаты в `PACKAGING_READINESS_CHECKLIST.md`

3. **Выполнение build_final.sh (ЕДИНСТВЕННЫЙ СПОСОБ):**
   - Запустить `./packaging/build_final.sh`
   - Никаких ручных шагов вне этого скрипта

4. **Проверка артефактов:**
   - Проверить подпись, нотаризацию, архитектуру, целостность
   - Проверить наличие новых файлов в `.app/Contents/Resources/`

5. **Валидация релизного бандла:**
   - Запустить `scripts/validate_release_bundle.py`

---

## Запреты и ограничения

**ЗАПРЕЩЕНО:**
- ❌ Использовать ручные/альтернативные инструкции упаковки вне `PACKAGING_FINAL_GUIDE.md`
- ❌ Пропускать шаги процесса (PRE_PACKAGING_VERIFICATION.md, build_final.sh)
- ❌ Использовать альтернативные скрипты сборки для релиза
- ❌ Модифицировать `.app` после сборки

**РАЗРЕШЕНО:**
- ✅ Использовать `build_final.sh --skip-build` для dev-циклов
- ✅ Использовать `NEXY_SKIP_NOTARIZATION=1` для локальной сборки
- ✅ Использовать `TIMESTAMP_MODE=none` для локальной сборки

---

## Чек-лист перед мерджем

Перед мерджем изменений, затрагивающих упаковку, ОБЯЗАТЕЛЬНО:

- [ ] Все триггеры изменений обработаны
- [ ] Артефакты упаковки обновлены (Nexy.spec, stage_universal_binaries.py)
- [ ] PRE_PACKAGING_VERIFICATION.md пройден и результаты зафиксированы
- [ ] `build_final.sh` выполнен успешно
- [ ] Все артефакты проверены (подпись, нотаризация, архитектура, целостность)
- [ ] `packaging_verification.log` не содержит ошибок
- [ ] Новые файлы присутствуют в `.app/Contents/Resources/`
- [ ] `validate_release_bundle.py` пройден (если применимо)

---

## Критерии успеха

✅ **"Стало проще/стабильнее" (конкретно):**

1. **Любая правка приводит к одному и тому же packaging-контуру:**
   - Четкие триггеры изменений
   - Обязательный процесс из 5 шагов
   - Запрет ручных исключений

2. **Артефакты соответствуют macOS требованиям без ручных исключений:**
   - Автоматическая проверка через build_final.sh
   - Валидация через validate_release_bundle.py
   - Чек-лист перед мерджем

---

## Связанные документы

- `Docs/PACKAGING_FINAL_GUIDE.md` — основной гайд (раздел 0 обновлен)
- `Docs/PRE_PACKAGING_VERIFICATION.md` — чек-лист проверки (создан)
- `Docs/PACKAGING_READINESS_CHECKLIST.md` — фиксация результатов (создан)
- `packaging/build_final.sh` — канонический скрипт упаковки
- `.cursorrules` — правила разработки (раздел 11.2)

---

## Статус

✅ **Завершено:** Единая техническая инструкция создана и интегрирована в существующие документы.

**Следующие шаги:**
- Использовать новый процесс для всех изменений
- Обновить `.cursorrules` раздел 11.2 с ссылкой на новый процесс (если нужно)
- Интегрировать проверку триггеров в CI/CD (опционально)
