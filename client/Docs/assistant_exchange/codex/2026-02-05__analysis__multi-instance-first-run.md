# Multi-instance First Run Loop

## Метаданные
- Ассистент: codex
- Тип: analysis
- Дата: 2026-02-05
- ID (INS-###): INS-005

## Diagnosis
В логах фиксируются несколько CHECKIN и разные PID за короткое время, что указывает на многократный перезапуск и запуск нескольких экземпляров Nexy во время first-run.

## Root Cause
Механизм permission-restart использует `open -n -a`, который принудительно создаёт новый экземпляр даже при наличии активного процесса; это приводит к циклу перезапусков до завершения первого процесса.

## Optimal Fix
Убрать `-n` из `open` для packaged-режима и добавить проверку на уже запущенный Nexy перед запуском в helper-скрипте, чтобы перезапуск был идемпотентным.

## Verification
Проверить по логам наличие только одного CHECKIN при первом запуске и стабильный count процессов `pgrep -f "Nexy.app"` равный 1.

## Запрос/цель
Проверить, есть ли множественные инстансы при первом запуске, и определить причину.

## Контекст
- Файлы: `modules/permission_restart/macos/permissions_restart_handler.py`, `log.md`
- Документы: `Docs/PROJECT_REQUIREMENTS.md`, `Docs/ARCHITECTURE_OVERVIEW.md`
- Ограничения: без реархитектуры, без новых источников истины

## Решения/выводы
- В логах видны разные PID (24650, 24696), что подтверждает множественные инстансы.
- Наиболее вероятная причина — `open -n -a` в permission restart helper.

## Открытые вопросы
- Есть ли в логе `[PERMISSION_RESTART]` или `NexyRestartHelper-*` записи, подтверждающие точку запуска нового процесса?

## Следующие шаги
- Внести фиксы в permission_restart handler.
- Повторить first-run smoke test.
