# Duplicate Launch Lock Ownership

## Метаданные
- Ассистент: codex
- Тип: analysis
- Дата: 2026-02-05
- ID (INS-###): INS-005

## Diagnosis
Повторные запуски и множественные иконки происходят из-за разрушения lock-файла не-владельцами. Это ломает single-instance гарантию InstanceManager.

## Root Cause
Дубликатный процесс вызывает `release_lock()` и удаляет lock чужого процесса → новый запуск считает, что экземпляра нет → параллельные процессы.

## Optimal Fix
Ограничить удаление lock-файла только владельцем (по `lock_fd` или PID в lock-файле). Дубликаты больше не смогут сбивать блокировку.

## Verification
Проверить логи: при `SAFE_EXIT: duplicate_instance` lock-файл остаётся, следующий запуск видит дубликат и завершает работу. Основной процесс продолжает работу без потери lock.

## Запрос/цель
Остановить повторные перезапуски/мульти-иконки за счёт исправления владения lock.

## Контекст
- Файлы: `modules/instance_manager/core/instance_manager.py`
- Документы: `Docs/ARCHITECTURE_OVERVIEW.md`, `Docs/PROJECT_REQUIREMENTS.md`
- Ограничения: без новых источников истины, правки внутри existing InstanceManager

## Решения/выводы
- Добавлена защита: lock удаляется только если текущий процесс владелец.
- Дубликатные процессы больше не очищают lock.

## Открытые вопросы
- Нужна ли дополнительная телеметрия источника запуска (LaunchAgent vs manual) для диагностики повторных CHECKIN.

## Следующие шаги
- Проверить поведение после установки PKG: один instance, один CHECKIN.
