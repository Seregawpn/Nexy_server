# üéß Audio Refactoring - Changelog

## –í–µ—Ä—Å–∏—è 1.0 - 2025-12-25

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏
- **FIX-001:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ - –ø–æ—Ç–æ–∫ –±–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ
  - –ò–∑–º–µ–Ω–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: `current_content_sr != incoming_sr` –≤–º–µ—Å—Ç–æ `_stream_sample_rate != incoming_sr`
  - –§–∞–π–ª: `modules/speech_playback/core/player.py:932-939`
  
- **FIX-002:** –î–æ–±–∞–≤–ª–µ–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  - `CoreAudioManager.initialize()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ `hasattr()`
  - `PerformanceMonitor.start()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ `hasattr()`
  - `ChunkBuffer.set_channels()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ `hasattr()` (3 –º–µ—Å—Ç–∞)
  - –§–∞–π–ª: `modules/speech_playback/core/player.py`

- **FIX-003:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤
  - –°—Ç—Ä–æ–∫–∏: 197, 213, 226, 270, 332, 592, 605, 610, 728, 741
  - –§–∞–π–ª: `modules/speech_playback/core/player.py`

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **PERF-001:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π recreate –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ lock hold time
  - –§–∞–∑–∞ 1 (–ø–æ–¥ lock): —Ä–µ—à–µ–Ω–∏–µ, —Ñ–ª–∞–≥–∏, –æ—Ç—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  - –§–∞–∑–∞ 2 (–≤–Ω–µ lock): stop/close/open (—Ç—è–∂—ë–ª—ã–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏)
  - –§–∞–∑–∞ 3 (–ø–æ–¥ lock): —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ stream
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: Lock hold time —Å–Ω–∏–∂–µ–Ω —Å ~50-100–º—Å –¥–æ < 5-10–º—Å
  - –§–∞–π–ª: `modules/speech_playback/core/player.py:_recreate_stream_if_needed_locked()`

- **PERF-002:** –î–æ–±–∞–≤–ª–µ–Ω cooldown –Ω–∞ device query —Ç–æ–ª—å–∫–æ –Ω–∞ failure-path
  - Cooldown –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ `device_id is None`
  - –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É
  - –§–∞–π–ª: `modules/speech_playback/core/player.py:add_audio_data()`

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **SEC-001:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω per-callback generation —á–µ—Ä–µ–∑ closure
  - –ö–∞–∂–¥—ã–π callback –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–π `stream_gen` —á–µ—Ä–µ–∑ closure
  - Generation —Ç–µ–ø–µ—Ä—å "per-callback", –∞ –Ω–µ "per-object"
  - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–π –ø–æ—Ä—á–∏ –º–µ–∂–¥—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ callback'–∞–º–∏
  - –§–∞–π–ª: `modules/speech_playback/core/player.py:_make_audio_callback()`

#### –ö–∞—á–µ—Å—Ç–≤–æ –∞—É–¥–∏–æ
- **AUDIO-001:** –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥ –≤ callback
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `resample_audio()` –∏–∑ `device_utils.py`
  - –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å `round()` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—Ä–µ–π—Ñ–∞ –¥–ª–∏–Ω—ã
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: Playback —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º sample rate
  - –§–∞–π–ª—ã:
    - `modules/speech_playback/core/player.py:_make_audio_callback()`
    - `modules/speech_playback/utils/device_utils.py:resample_audio()`

- **AUDIO-002:** –£–ª—É—á—à–µ–Ω —Ä–µ—Å–µ–º–ø–ª–µ—Ä `resample_audio()`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `round()` –≤–º–µ—Å—Ç–æ `int()` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥—Ä–µ–π—Ñ–∞ –¥–ª–∏–Ω—ã
  - –î–æ–±–∞–≤–ª–µ–Ω dtype guard –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - –§–∞–π–ª: `modules/speech_playback/utils/device_utils.py`

#### –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- **OBS-001:** –î–æ–±–∞–≤–ª–µ–Ω—ã production tripwires (—Å—á—ë—Ç—á–∏–∫–∏ –∏ —Ç–∞–π–º–µ—Ä—ã)
  - `_callback_underrun_count` - —Å—á—ë—Ç—á–∏–∫ underrun –≤ callback
  - `_callback_gen_mismatch_count` - —Å—á—ë—Ç—á–∏–∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π generation
  - `_callback_shape_mismatch_count` - —Å—á—ë—Ç—á–∏–∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã—Ö
  - `_callback_error_count` - —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –≤ callback
  - `_resample_error_count` - —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞
  - `_stream_open_fail_count` - —Å—á—ë—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π –ø–æ—Ç–æ–∫–∞
  - `_device_query_failure_count` - —Å—á—ë—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `_recreate_total_ms` - –≤—Ä–µ–º—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞
  - `_callback_resample_ms_history` - –∏—Å—Ç–æ—Ä–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞
  - –§–∞–π–ª: `modules/speech_playback/core/player.py:__init__()`

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `Docs/AUDIO_REFACTORING_FINAL_REPORT.md` - –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
- `Docs/AUDIO_REFACTORING_SUMMARY.md` - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `Docs/AUDIO_REFACTORING_CHANGELOG.md` - –≠—Ç–æ—Ç changelog
- `Docs/AUDIO_REFACTORING_VALIDATION.md` - –ß–µ–∫–ª–∏—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `Docs/AUDIO_REFACTORING_CODE_REVIEW.md` - Code review —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
- `Docs/AUDIO_REFACTORING_FINAL_FIXES.md` - –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∏–∫—Å–æ–≤
- `Docs/AUDIO_REFACTORING_FINAL_3_FIXES.md` - –û–ø–∏—Å–∞–Ω–∏–µ 3 —Ç–æ–Ω–∫–∏—Ö —Ä–∏—Å–∫–æ–≤
- `Docs/AUDIO_PRODUCTION_HARDENING.md` - Production hardening –ø—Ä–∞–≤–∏–ª–∞
- `Docs/AUDIO_PRODUCTION_TECHNICAL_SPEC.md` - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- `Docs/AUDIO_RESAMPLE_FINAL_OPTIMIZATIONS.md` - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞
- `Docs/AUDIO_PRODUCTION_TESTING_PLAN.md` - –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `Docs/AUDIO_TESTING_QUICK_START.md` - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `Docs/AUDIO_TESTING_STATUS.md` - –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### üìä –ú–µ—Ç—Ä–∏–∫–∏

#### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- Lock hold time: ~50-100–º—Å
- Recreate count: –Ω–∞ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ
- –†–µ—Å–µ–º–ø–ª–∏–Ω–≥: –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- Generation: per-object
- –ú–µ—Ç—Ä–∏–∫–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

#### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- Lock hold time: < 10–º—Å (—É–ª—É—á—à–µ–Ω–∏–µ 5-10x)
- Recreate count: 1-2 –∑–∞ —Å–µ—Å—Å–∏—é (—É–ª—É—á—à–µ–Ω–∏–µ ~100x)
- –†–µ—Å–µ–º–ø–ª–∏–Ω–≥: —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ callback
- Generation: per-callback
- –ú–µ—Ç—Ä–∏–∫–∏: –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä tripwires

### ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞
- ‚úÖ Thread safety –ø—Ä–æ–≤–µ—Ä–µ–Ω

### üéØ –°—Ç–∞—Ç—É—Å

**‚úÖ PRODUCTION READY**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production.

---

## –õ–µ–≥–µ–Ω–¥–∞

- **FIX-XXX:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞
- **PERF-XXX:** –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **SEC-XXX:** –£–ª—É—á—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **AUDIO-XXX:** –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∞—É–¥–∏–æ
- **OBS-XXX:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏

