# 📋 ПЛАН РЕАЛИЗАЦИИ СИСТЕМЫ ПРЕДВАРИТЕЛЬНЫХ ПРОВЕРОК

## 📊 Статус: В РАБОТЕ

**Дата создания:** 2026-01-08  
**Автор:** Cursor Assistant  
**Основа:** Анализ существующей инфраструктуры + требования проекта

---

## 1. КОНТЕКСТ И ЦЕЛИ

### 1.1 Проблема
Приложение ломается на macOS после изменений кода и упаковки. Необходима система проверок, которая:
- Выявляет проблемы **ДО** упаковки
- Ускоряет диагностику **ПОСЛЕ** падения
- Минимизирует количество итераций сборки

### 1.2 Существующая инфраструктура
| Скрипт | Назначение | Статус |
|--------|------------|--------|
| `pre_build_gate.sh` | Основные проверки перед сборкой | ✅ Есть |
| `run_release_suite.py` | Полный цикл проверок релиза | ✅ Есть |
| `check_dependencies.py` | Проверка зависимостей и бинарников | ✅ Есть |
| `view_nexy_logs.sh` | Просмотр логов | ✅ Есть |
| `analyze_logs.sh` | Анализ ошибок XPC/Sandbox | ✅ Есть |
| `cold_start_diagnostics.sh` | Диагностика после перезагрузки | ✅ Есть |
| `verify_imports.py` | Проверка импортов | ❌ Нет |
| `verify_pyinstaller.py` | Валидация Nexy.spec | ❌ Нет |
| `diagnose.sh` | Единый wrapper для диагностики | ❌ Нет |

---

## 2. ПЛАН РЕАЛИЗАЦИИ

### 📦 ФАЗА 1: Создание новых компонентов

#### 2.1 `verify_imports.py` (Приоритет: ВЫСОКИЙ)

**Назначение:** Проверка синтаксиса Python и критических импортов перед упаковкой

**Функционал:**
```
verify_imports.py
├── check_syntax()
│   ├── py_compile main.py
│   ├── py_compile simple_module_coordinator.py
│   └── py_compile всех интеграций
│
├── check_core_imports()
│   ├── EventBus
│   ├── ApplicationStateManager
│   ├── ErrorHandler
│   └── SimpleModuleCoordinator
│
├── check_integration_imports()
│   └── 21 интеграция
│
└── check_pyobjc_imports()
    ├── AppKit
    ├── Foundation
    ├── Quartz
    └── AVFoundation
```

**Exit codes:**
- `0` — все проверки пройдены
- `1` — есть ошибки синтаксиса или импортов

**Время выполнения:** ~5 секунд

---

#### 2.2 `verify_pyinstaller.py` (Приоритет: ВЫСОКИЙ)

**Назначение:** Валидация Nexy.spec на полноту конфигурации

**Функционал:**
```
verify_pyinstaller.py
├── check_hidden_imports()
│   ├── Все модули из modules/
│   ├── Все интеграции из integration/integrations/
│   ├── PyObjC модули
│   └── gRPC и protobuf
│
├── check_data_files()
│   ├── config/*.yaml
│   ├── assets/icons/
│   ├── resources/ffmpeg/
│   └── resources/audio/
│
├── check_runtime_hooks()
│   └── runtime_hook_pyobjc_fix.py
│
└── check_info_plist()
    ├── CFBundleIdentifier
    ├── NSMicrophoneUsageDescription
    ├── NSCameraUsageDescription
    └── LSUIElement
```

**Exit codes:**
- `0` — все проверки пройдены
- `1` — есть отсутствующие imports/data/hooks

**Время выполнения:** ~3 секунды

---

#### 2.3 `diagnose.sh` (Приоритет: СРЕДНИЙ)

**Назначение:** Единая точка входа для всей диагностики

**Функционал:**
```bash
diagnose.sh [OPTIONS]

OPTIONS:
  --logs      Показать логи (вызывает view_nexy_logs.sh)
  --analyze   Анализировать ошибки (вызывает analyze_logs.sh)
  --cold      Диагностика холодного старта (вызывает cold_start_diagnostics.sh)
  --crash     Анализ crash логов
  --all       Все выше + дополнительный анализ
  --quick     Быстрая диагностика (только ошибки)
```

**Дополнительный анализ (--all):**
- Проверка статуса процесса Nexy
- Проверка TCC разрешений
- Проверка подписи приложения
- Проверка entitlements

---

### 🔧 ФАЗА 2: Интеграция в существующую инфраструктуру

#### 2.4 Обновление `pre_build_gate.sh`

**Добавить в секцию "LAYER 0: КРИТИЧЕСКИЕ ПРОВЕРКИ":**
```bash
# 0.1 Проверка синтаксиса и импортов
if run_check "Проверка синтаксиса и импортов" python3 scripts/verify_imports.py; then
    ((PASSED++))
else
    ((FAILED++))
    # Критическая ошибка — остановить
    exit 1
fi

# 0.2 Проверка зависимостей
if run_check "Проверка зависимостей" python3 scripts/check_dependencies.py; then
    ((PASSED++))
else
    ((FAILED++))
fi
```

**Добавить в секцию "LAYER 3: PYINSTALLER ПРОВЕРКИ":**
```bash
# 3.x Валидация Nexy.spec
if run_check "Валидация Nexy.spec" python3 scripts/verify_pyinstaller.py; then
    ((PASSED++))
else
    ((FAILED++))
fi
```

---

### 📚 ФАЗА 3: Документация

#### 2.5 Создание `Docs/PREFLIGHT_CHECKS.md`

**Содержание:**
- Описание системы проверок
- Порядок выполнения
- Как интерпретировать ошибки
- Как исправлять типичные проблемы
- Примеры использования

---

## 3. ПОРЯДОК РЕАЛИЗАЦИИ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ПОРЯДОК РЕАЛИЗАЦИИ                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  ШАГ 1                  ШАГ 2                  ШАГ 3                  ШАГ 4
  ══════                 ══════                 ══════                 ══════
    │                      │                      │                      │
    ▼                      ▼                      ▼                      ▼
┌─────────┐          ┌─────────┐          ┌─────────┐          ┌─────────┐
│verify_  │          │verify_  │          │diagnose │          │pre_build│
│imports  │   ───▶   │pyinst.  │   ───▶   │.sh      │   ───▶   │_gate.sh │
│.py      │          │.py      │          │         │          │(update) │
└─────────┘          └─────────┘          └─────────┘          └─────────┘
    │                      │                      │                      │
    │ ~1 час              │ ~1 час              │ ~30 мин             │ ~15 мин
    │                      │                      │                      │
    ▼                      ▼                      ▼                      ▼
  [ТЕСТ]               [ТЕСТ]               [ТЕСТ]               [ТЕСТ]
```

---

## 4. КРИТЕРИИ ПРИЁМКИ

### 4.1 verify_imports.py
- [ ] Проверяет синтаксис всех критических .py файлов
- [ ] Проверяет импорт всех 21 интеграций
- [ ] Проверяет импорт PyObjC модулей
- [ ] Exit code 0 при успехе, 1 при ошибках
- [ ] Понятные сообщения об ошибках с путями файлов

### 4.2 verify_pyinstaller.py
- [ ] Парсит Nexy.spec
- [ ] Проверяет hiddenimports на полноту
- [ ] Проверяет datas на наличие файлов
- [ ] Проверяет runtime_hooks
- [ ] Exit code 0 при успехе, 1 при ошибках

### 4.3 diagnose.sh
- [ ] Работает с опциями --logs, --analyze, --cold, --all
- [ ] Вызывает существующие скрипты без дублирования
- [ ] Понятный вывод для пользователя

### 4.4 pre_build_gate.sh (обновлённый)
- [ ] Вызывает verify_imports.py первым
- [ ] Вызывает check_dependencies.py
- [ ] Вызывает verify_pyinstaller.py
- [ ] Сохраняет обратную совместимость

---

## 5. ТЕСТИРОВАНИЕ

### 5.1 Сценарии тестирования

| Сценарий | Ожидаемый результат |
|----------|---------------------|
| Все файлы корректны | Exit 0, все проверки PASSED |
| Синтаксическая ошибка в main.py | Exit 1, указан файл и строка |
| Отсутствует модуль в hiddenimports | Exit 1, список отсутствующих |
| Отсутствует ресурс в datas | Exit 1, путь к файлу |

### 5.2 Ручное тестирование

```bash
# Тест verify_imports.py
python3 scripts/verify_imports.py

# Тест verify_pyinstaller.py  
python3 scripts/verify_pyinstaller.py

# Тест diagnose.sh
./scripts/diagnose.sh --all

# Полный прогон
./scripts/pre_build_gate.sh
```

---

## 6. РИСКИ И МИТИГАЦИЯ

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Ложные срабатывания | Средняя | Высокое | Добавить whitelist исключений |
| Медленная работа | Низкая | Среднее | Кэширование результатов |
| Несовместимость с CI | Низкая | Высокое | Тестировать в GitHub Actions |

---

## 7. ОЦЕНКА ВРЕМЕНИ

| Компонент | Оценка | Сложность |
|-----------|--------|-----------|
| verify_imports.py | 1 час | Средняя |
| verify_pyinstaller.py | 1 час | Средняя |
| diagnose.sh | 30 мин | Низкая |
| pre_build_gate.sh (update) | 15 мин | Низкая |
| PREFLIGHT_CHECKS.md | 30 мин | Низкая |
| Тестирование | 30 мин | — |
| **ИТОГО** | **~4 часа** | — |

---

## 8. СЛЕДУЮЩИЕ ШАГИ

После реализации:
1. Прогнать полный цикл `pre_build_gate.sh`
2. Собрать приложение через `rebuild_from_scratch.sh`
3. Проверить логи на ошибки
4. Задокументировать результаты

---

## CHANGELOG

| Дата | Изменение |
|------|-----------|
| 2026-01-08 | Создан план реализации |
