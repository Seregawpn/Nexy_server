accessibility:
  error_sound: true
  sound_notifications: true
  startup_sound: true
  success_sound: true
  voice_feedback: true
  voiceover_control:
    enabled: true
    mode: stop
    hard_toggle_enabled: false
    duck_modes:
    - listening
    - processing
    release_modes:
    - sleeping
    debounce_seconds: 0.25
    stop_repeats: 2
    stop_repeat_delay: 0.05
    use_apple_script_fallback: true
    engage_on_keyboard_events: false
    debug_logging: false
    log_osascript_commands: false
    log_voiceover_state: false
server:
  production_host: nexy-server.canadacentral.cloudapp.azure.com
  production_grpc_port: 443
  production_http_port: 443
app:
  bundle_id: com.nexy.assistant
  debug: true
  name: Nexy
  team_id: 5NKLL2CLB9
  version: 1.6.1.29
focus:
  force_activate_on_startup: false
  allow_tray_startup_fallback: true
  tray_fallback_timeout_sec: 6.0
default_audio:
  target_sample_rate: 16000
  target_channels: 1
  target_dtype: int16
server_audio_format:
  sample_rate: 48000
  channels: 1
  dtype: int16
  bit_depth: 16
  endianness: little
  format: raw_pcm
audio_system:
  avfoundation_enabled: false
  avfoundation_input_monitor_enabled: false
  avfoundation_output_enabled: false
  avfoundation_route_manager_enabled: false
  ks_avfoundation_input_monitor: false
  ks_avfoundation_output: false
  ks_avfoundation_route_manager: false
  input_monitor:
    check_interval_sec: 1.5
    use_notifications: true
  route_manager:
    debounce:
      bluetooth:
        initial_ms: 200
        increment_ms: 200
        max_ms: 1200
      usb:
        initial_ms: 100
        increment_ms: 100
        max_ms: 600
      built_in:
        initial_ms: 100
        max_ms: 200
    reconcile_timeout_ms: 5000
    max_reconcile_retries: 3
  output:
    max_queue_ms: 5000
    max_queue_bytes: 5242880
    sample_rate_conversion: true
  auto_detect_device: true
  auto_detect_sample_rate: true
  auto_detect_channels: true
  auto_detect_dtype: true
  silent_window_seconds: 0.3
  silent_windows_threshold: 2
  reopen_debounce_ms: 600
  device_quarantine_sec: 20
  health_check_interval_sec: 1.0
  read_chunk_sec: 0.2
  chunk_size: 1024
  max_retry_attempts: 3
  retry_delay: 0.5
  error_cooldown: 2.0
  enable_debug_logging: true
  log_health_checks: true
  log_stream_events: true
  log_device_changes: true
  log_performance_metrics: true
  input_sample_rate: 16000
  output_sample_rate: 48000
  input_channels: 1
  output_channels: 1
  dtype: int16
grpc:
  connection_timeout: 30
  enable_compression: true
  enable_keepalive: true
  keepalive_time: 10
  keepalive_timeout: 3
  keepalive_without_calls: true
  max_connection_idle: 300
  max_connection_age: 3600
  max_connection_age_grace: 5
  max_message_length: 4194304
  max_receive_message_length: 4194304
  max_send_message_length: 4194304
  retry_attempts: 3
  retry_delay: 1.0
  use_tls: false
  servers:
    local:
      host: 127.0.0.1
      port: 50051
      ssl: false
      timeout: 30
      retry_attempts: 3
      retry_delay: 1.0
      description: Локальный сервер для разработки
    production:
      host: nexy-server.canadacentral.cloudapp.azure.com
      port: 443
      ssl: true
      ssl_verify: false
      use_http2: true
      timeout: 300
      retry_attempts: 5
      retry_delay: 2.0
      keepalive: true
      description: Production сервер на Azure (HTTPS через Nginx, gRPC на /)
    fallback:
      host: 127.0.0.1
      port: 50052
      ssl: false
      timeout: 30
      retry_attempts: 3
      retry_delay: 1.0
      description: Резервный сервер
integrations:
  autostart_manager:
    enabled: true
    priority: 12
    monitor_enabled: true
    auto_repair: false
    cleanup_legacy_launch_agent: true
  grpc_client:
    enabled: true
    priority: 9
    server: production
    aggregate_timeout_sec: 1.5
    request_timeout_sec: 0.0
    max_retries: 3
    retry_delay: 1.0
    use_network_gate: true
  hardware_id:
    enabled: true
    priority: 2
  keyboard:
    key_to_monitor: ctrl_n
    short_press_threshold: 0.1
    long_press_threshold: 0.6
    event_cooldown: 0.1
    hold_check_interval: 0.05
    debounce_time: 0.1
    backend: auto
    combo_timeout_sec: 120.0
    key_state_timeout_sec: 60.0
  input_processing:
    enabled: true
    priority: 4
    enable_keyboard_monitoring: true
    auto_start: true
    min_recording_duration_sec: 0.6
    recording_prestart_delay_sec: 0.3
    playback_idle_grace_sec: 0.3
    playback_wait_timeout_sec: 5.0
    mic_reset_timeout_sec: 60.0
  instance_manager:
    enabled: true
    priority: 13
  interrupt_management:
    enabled: true
    priority: 8
  mode_management:
    enabled: true
    priority: 3
  network_manager:
    enabled: true
    priority: 6
  permissions:
    auto_open_preferences: false
    check_interval: 30.0
    enabled: true
    priority: 0
    retry_attempts: 3
    retry_delay: 5.0
    show_instructions: false
    required_permissions:
    # Порядок унифицирован с permissions_v2.order
    - microphone
    - screen_capture
    - contacts
    - input_monitoring
    - accessibility
    - full_disk_access
  permission_restart:
    enabled: true
    critical_permissions:
    - accessibility
    - microphone
    - screen_capture
    - contacts
    - full_disk_access
    - input_monitoring
    restart_delay_sec: 1.0
    max_restart_attempts: 3
    respect_active_sessions: true
    respect_updates: true
    polling_enabled: false
    poll_interval_sec: 3.0
  
  # Permission System V2 - Pipeline Mode
  permissions_v2:
    enabled: true
    advance_on_timeout: false
    default_step_timeout_s: 15.0
    
    # No batching - single pipeline
    batching:
      enabled: false
    
    # Restart policy: single restart after full pipeline completion.
    # require_needs_restart=false keeps restart deterministic for first-run.
    restart:
      delay_sec: 1.0
      require_all_hard_pass: true
      require_needs_restart: false
      settings_safety_window_sec: 30.0
    
    # Order: dialogs first, input_monitoring before settings
    order:
      - microphone
      - screen_capture
      - network
      - contacts
      - messages
      - input_monitoring
      - accessibility
      - full_disk_access

    # No artificial pause between steps
    inter_step_pause_s: 0.0
    
    # Per-step configuration
    steps:
      microphone:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 1.0
        supports_needs_restart: false
        criticality: hard
        
      screen_capture:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 2.0
        supports_needs_restart: false
        criticality: hard
        
      network:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 2.0
        supports_needs_restart: false
        criticality: hard

      contacts:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 2.0
        supports_needs_restart: false
        criticality: hard
        
      messages:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 2.0
        supports_needs_restart: false
        criticality: hard
        
      input_monitoring:
        mode: auto_dialog
        grace_s: 15.0
        poll_s: 2.0
        supports_needs_restart: true
        post_restart_verify_window_s: 20.0
        post_restart_verify_tick_s: 2.0
        criticality: hard
        
      accessibility:
        mode: auto_dialog
        # settings_target: accessibility  <-- disabled to prevent auto-open
        grace_s: 15.0
        poll_s: 2.0
        waiting_long_after_s: 300.0
        waiting_long_poll_s: 15.0
        supports_needs_restart: false
        criticality: hard
        
      full_disk_access:
        mode: open_settings
        settings_target: full_disk_access
        grace_s: 15.0
        poll_s: 10.0
        waiting_long_after_s: 600.0
        waiting_long_poll_s: 30.0
        supports_needs_restart: false
        criticality: hard
  
  update_notification:
    enabled: true
    priority: 15
    speak_start: true
    speak_progress: true
    speak_complete: true
    speak_error: true
    progress_interval_sec: 30.0
    progress_step_percent: 50
    use_signals: true
    voice: en-US
    dry_run: false
  screenshot_capture:
    enabled: true
    priority: 7
  signals:
    enabled: true
    priority: 11
    patterns:
      update_start:
        tone_hz: 880
        duration_ms: 200
        volume: 0.25
        repeat: 2
      update_progress:
        tone_hz: 660
        duration_ms: 120
        volume: 0.2
      update_success:
        tone_hz: 1200
        duration_ms: 300
        volume: 0.3
      update_error:
        tone_hz: 440
        duration_ms: 500
        volume: 0.3
  speech_playback:
    enabled: true
    priority: 10
  tray_controller:
    enabled: true
    priority: 1
  updater:
    enabled: true
    priority: 5
  voice_recognition:
    enabled: true
    priority: 4
    simulate: false
    timeout_sec: null
    simulate_success_rate: 0.7
    simulate_min_delay_sec: 1.0
    simulate_max_delay_sec: 3.0
  welcome_message:
    enabled: true
    priority: 14
logging:
  console_level: DEBUG
  file_level: DEBUG
  file_path: ~/Library/Logs/Nexy/nexy.log
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  max_file_size: 10485760
  max_files: 5
  rotation: true
network:
  connection_check_interval: 30
  auto_fallback: true
  ping_timeout: 5
  ping_hosts:
  - 8.8.8.8
  - 1.1.1.1
permissions:
  first_run:
    enabled: true
    pause_between_requests_sec: 15.0
    activation_hold_duration_sec: 15.0
    mode: smart
    # TCC Rate Limiting Fix: Batch permissions to avoid macOS blocking dialogs
    # When requesting 4+ permissions, macOS blocks the last ones
    # Solution: Request 2 permissions per session, then restart
    batch_size: 3                    # Permissions per batch (3 = fewer restarts)
    enable_batching: true            # ENABLED: batch permissions to avoid macOS blocking
    batch_restart_delay_sec: 2.0     # Delay before restart after batch (unused)
  sequential: false
  request_timeout_sec: 120.0
  auto_open_settings: false
  microphone:
    enabled: true
    required: true
    description: Nexy использует микрофон для распознавания речи и голосового управления.
  screen_capture:
    enabled: true
    required: true
    description: Nexy захватывает содержимое экрана для анализа и помощи пользователю.
  camera:
    enabled: false
    required: false
    description: Nexy может использовать камеру для анализа окружения.
  network:
    enabled: true
    required: true
    description: Nexy использует сеть для связи с сервером и обновлений.
  notifications:
    enabled: true
    required: true
    description: Nexy отправляет уведомления о статусе работы и важных событиях.
  accessibility:
    enabled: true
    required: true
    description: Nexy использует Accessibility для мониторинга клавиатуры и автоматизации.
  contacts:
    enabled: true
    required: true
    description: Nexy использует контакты для резолвинга отправителей и получателей сообщений.
  full_disk_access:
    enabled: true
    required: true
    description: Nexy требует Full Disk Access для доступа к локальным данным сообщений.
  settings_required_permissions:
  # Отключено: подсказки про Settings не используются
  system_preferences:
    microphone: x-apple.systempreferences:com.apple.preference.security?Privacy_Microphone
    screen_capture: x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture
    camera: x-apple.systempreferences:com.apple.preference.security?Privacy_Camera
    accessibility: x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility
    input_monitoring: x-apple.systempreferences:com.apple.preference.security?Privacy_ListenEvent
    contacts: x-apple.systempreferences:com.apple.preference.security?Privacy_Contacts
    full_disk_access: x-apple.systempreferences:com.apple.preference.security?Privacy_AllFiles
    notifications: x-apple.systempreferences:com.apple.preference.notifications
screenshot_capture:
  auto_capture: false
  capture_delay: 0.1
  capture_format: webp
  capture_quality: 85
  enabled: true
  max_captures: 10
  save_path: screenshots
  timeout: 5.0
speech_playback:
  enabled: true
  sample_rate: 48000
  channels: 1
  dtype: int16
  signal_max_age_ms: 2500
  audio_diag_verbose: true
  audio_diag_log_every: 50
  buffer_size: 512
  fade_in_duration: 0.1
  fade_out_duration: 0.1
  max_queue_size: 5
  playback_speed: 1.0
  volume: 0.8
  tts_auto_gain_enabled: true
  tts_target_peak: 0.35
  tts_max_gain: 6.0
  tts_min_peak_for_gain: 0.01
  auto_output_device_switch: true
tray:
  icon_active: assets/icons/active.png
  icon_inactive: assets/icons/off.png
  menu_items:
  - action: quit
    label: Выход
    separator: true
  - action: settings
    label: Настройки
  - action: about
    label: О программе
  - action: status
    label: Статус
  show_notifications: true
  tooltip: Nexy AI Assistant
  status_item:
    circuit_open_threshold: 3
    circuit_open_duration_ms: 8000
    max_attempts_per_series: 10
    initial_backoff_ms: 800
    max_backoff_ms: 10000
    backoff_multiplier: 1.5
    jitter_percent: 0.15
    control_center_ready_timeout_sec: 10.0
    first_attempt_delay_ms: 1000
    final_timeout_ms: 60000
    background_retry_interval_sec: 45
updater:
  default:
    enabled: true
    update_channel: fix
    appcast_url: https://nexy-server.canadacentral.cloudapp.azure.com/updates/appcast.xml
    manifest_url: https://nexy-server.canadacentral.cloudapp.azure.com/updates/appcast.xml
    auto_check: true
    check_interval: 3600
    check_on_startup: true
    auto_install: true
    install_after_download: false
    silent_mode: true
    security:
      public_key: ''
      verify_signatures: true
      require_https: true
      ssl_verify: false
    network:
      timeout: 30
      retries: 3
      user_agent: Nexy-Updater/1.0
    ui:
      show_notifications: true
      auto_download: true
      progress_notifications: true
    channels:
      stable:
        url: https://nexy-server.canadacentral.cloudapp.azure.com/updates/appcast.xml
        description: Стабильные релизы
      beta:
        url: https://nexy-server.canadacentral.cloudapp.azure.com/updates/appcast-beta.xml
        description: Бета версии
      alpha:
        url: https://nexy-server.canadacentral.cloudapp.azure.com/updates/appcast-alpha.xml
        description: Альфа версии
  development:
    enabled: false
    auto_check: false
    check_on_startup: false
    auto_install: false
    network:
      timeout: 10
      retries: 0
    ui:
      show_notifications: false
      auto_download: false
voice_recognition:
  enabled: true
  language: en-US
  max_alternatives: 3
  phrase_timeout: 0.3
  silence_timeout: 0.8
voice:
  start_retry_delay_ms: 300
coordinator:
  event_settle_delay_ms: 500
stt:
  language: en-US
  channels: 1
  chunk_size: 1024
  dtype: int16
  simulate: false
  timeout: 5.0
  use_google: true
  wake_word: nexy
welcome_message:
  enabled: true
  text: Hi! Nexy is here. How can I help you?
  use_server: true
  server_timeout_sec: 20
  delay_sec: 0.3
  volume: 0.8
  voice: en-US-JennyNeural
  sample_rate: 48000
  channels: 1
  bit_depth: 16
  ignore_microphone_permission: true
network_manager:
  enabled: true
  priority: 6
  check_interval: 10
  ping_timeout: 3
  max_retries: 3
  retry_delay: 5.0
  ping_hosts:
  - 1.1.1.1
  - 8.8.8.8
  test_urls:
  - https://www.google.com
  - https://www.apple.com
  - https://www.cloudflare.com
permission_override:
  default:
    assume_granted: false
  development:
    assume_granted: true
features:
  serial_tcc_prompts:
    enabled: false
    rollout_percentage: 1
  ks_serial_tcc:
    enabled: false
  use_events_for_update_status:
    enabled: true
    rollout_percentage: 1
  use_events_for_restart_pending:
    enabled: true
  critical_subscriptions_fix:
    enabled: true
    rollout_percentage: 100
    description: Prevent race condition in permissions event handling by subscribing
      before integration initialization
  ks_first_run_normalization:
    enabled: false
  template_feature:
    enabled: false
  ks_template_feature:
    enabled: false
  actions:
    open_app:
      enabled: true
    close_app:
      enabled: true
  browser:
    enabled: true
  messages:
    enabled: true
  payment:
    enabled: false
  browser_use:
    enabled: true
browser_use:
  enabled: true  # F-2025-015-browser-use enabled
  log_steps: true
  log_terminal: true
  keep_browser_open: true
  gemini_api_key: ""  # SECURE: Moved to ~/Library/Application Support/Nexy/credentials.yaml
  gemini_model: "gemini-3-flash-preview"  # User explicitly requested gemini-3-flash-preview
payment_use:
  enabled: false  # F-2025-018-payment-use DISABLED
  log_steps: true
  log_transactions: true
messages:
  enabled: true  # F-2025-016-messages enabled
  require_full_disk_access: true
  require_contacts_permission: true
whatsapp:
  enabled: false  # F-2025-019-whatsapp DISABLED
  keep_alive: false
  node_path: /usr/local/bin/node
  auto_start: false
actions:
  open_app:
    enabled: true
    timeout_sec: 10.0
    allowed_apps: []
    binary: /usr/bin/open
    speak_errors: true
    use_server_tts: false
  close_app:
    enabled: true
    timeout_sec: 10.0
    speak_errors: true
    use_server_tts: false
mcp:
  open_app:
    server_path: mcp_servers/open_app/server.py
    enabled: true
    timeout_sec: 10.0
  close_app:
    server_path: mcp_servers/close_app/server.py
    enabled: true
    timeout_sec: 10.0
  messages:
    server_path: mcp_servers/messages/server.py
    enabled: true
    timeout_sec: 10.0
