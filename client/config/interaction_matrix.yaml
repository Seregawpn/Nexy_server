# Interaction Matrix
# Defines rules for state transitions based on multiple axes.
# See .cursorrules section 18.2 for format and priority rules.
# Synced with Docs/STATE_CATALOG.md
#
# IMPORTANT: Any changes to axes must be synchronized with:
# 1. Docs/STATE_CATALOG.md (source of truth for axes)
# 2. integration/core/gateways.py (decision logic)
# 3. Gateway tests (≥8–14 pairwise + 2 negative)

axes:
  Permission.mic: [granted, denied, prompt_blocked]
  Permission.screen: [granted, denied, prompt_blocked]
  Permission.accessibility: [granted, denied, prompt_blocked]
  Device.input: [default_ok, busy]
  Network: [online, offline]
  FirstRun: [true, false]
  appMode: [SLEEPING, LISTENING, PROCESSING]
  permissions.restart_pending: [true, false]  # NEW - Phase 2
  process.lifecycle: [running, restarting, terminated]  # NEW - Phase 2
  update_in_progress: [true, false]  # NEW - Phase 2

rules:
  # ============================================================================
  # LISTENING MODE RULES
  # ============================================================================

  # Hard stop: permission denied always aborts listening
  - when: {perm.mic: denied}
    decision: abort
    priority: hard_stop
    description: Microphone permission denied - cannot proceed with listening
    gateway: decide_start_listening

  # Hard stop: first_run in progress blocks activation
  - when: {app.first_run: true}
    decision: abort
    priority: hard_stop
    description: First run in progress - block activation until permissions are granted
    gateway: decide_start_listening

  # Graceful: device busy - retry
  - when: {perm.mic: granted, device.busy: true, app.mode: listening}
    decision: retry
    priority: graceful
    description: Device busy - retry
    gateway: decide_start_listening

  # Graceful: network offline during listening (can still listen, won't process)
  - when: {network.offline: true, app.mode: listening}
    decision: degrade
    priority: graceful
    description: Network offline - can listen but won't process until online
    gateway: decide_start_listening

  # ============================================================================
  # FIRST RUN RESTART RULES (Phase 2)
  # See Docs/ADR-001-first-run-restart-hotfix.md and Docs/change_impact.yaml
  # ============================================================================

  # Hard stop: first_run + restart_pending blocks all integration startup
  - when: {app.first_run: true, app.restart_pending: true}
    decision: abort
    priority: hard_stop
    description: First run restart pending - stop launching remaining integrations until restart completes
    gateway: decide_continue_integration_startup
    source: Docs/change_impact.yaml

  # Hard stop: restarting lifecycle blocks integrations (via first_run_restart_pending selector)
  - when: {app.first_run_restart_pending: true}
    decision: abort
    priority: hard_stop
    description: First run restart pending - do not launch new integrations
    gateway: decide_continue_integration_startup
    source: Docs/change_impact.yaml

  # ============================================================================
  # PROCESSING MODE RULES
  # ============================================================================

  # Hard stop: screen capture denied during processing
  - when: {perm.screen: denied, app.mode: processing}
    decision: abort
    priority: hard_stop
    description: Screen capture permission denied during processing
    gateway: decide_process_audio

  # Graceful: network offline during processing
  - when: {network.offline: true, app.mode: processing}
    decision: degrade
    priority: graceful
    description: Network offline - degrade to offline mode
    gateway: decide_process_audio

  # Hard stop: microphone denied during processing
  - when: {perm.mic: denied, app.mode: processing}
    decision: abort
    priority: hard_stop
    description: Microphone permission denied during processing
    gateway: decide_process_audio

  # ============================================================================
  # PERMISSION RESTART RULES
  # Permission Restart rules consolidated here (previous narrative docs archived)
  # ============================================================================

  # Hard stop: respect_updates blocks restart if update available
  # Rule: If respect_updates=true AND update_available=true → skip permission restart
  # Reason: Avoid double restart (update will restart itself, permissions apply automatically)
  - when: {permission_restart: {respect_updates: true, update_available: true}}
    decision: skip_restart
    priority: hard_stop
    description: Update available - skip permission restart (update will restart itself)
    gateway: permission_restart.maybe_schedule_restart
    source: STATE_CATALOG.md (Связь с Permission Restart)

  # Graceful: respect_active_sessions delays restart until SLEEPING
  # Rule: If respect_active_sessions=true AND appMode != SLEEPING → delay restart (max 10 min)
  # Reason: Don't interrupt user during active session (listening/processing)
  - when: {permission_restart: {respect_active_sessions: true}, appMode: [LISTENING, PROCESSING]}
    decision: delay_restart
    priority: graceful
    description: Active session - delay restart until SLEEPING (max 10 minutes, then force)
    gateway: permission_restart._wait_for_safe_conditions
    timeout_seconds: 600
    source: STATE_CATALOG.md (Связь с Permission Restart)

  # Graceful: respect_updates delays restart if update in progress
  # Rule: If respect_updates=true AND update_in_progress=true → delay restart (max 10 min)
  # Reason: Don't interrupt update installation
  - when: {permission_restart: {respect_updates: true, update_in_progress: true}}
    decision: delay_restart
    priority: graceful
    description: Update in progress - delay restart until installation completes (max 10 minutes)
    gateway: permission_restart._wait_for_safe_conditions
    timeout_seconds: 600
    source: STATE_CATALOG.md (Связь с Permission Restart)

  # ============================================================================
  # UPDATE / RESTART CONFLICT RULES (Phase 2)
  # See Docs/STATE_CATALOG.md section 10 (update_in_progress axis)
  # ============================================================================

  # Hard stop: first_run + restart_pending blocks permission restart
  - when: {app.first_run_restart_pending: true}
    decision: abort
    priority: hard_stop
    description: First run restart pending - block permission restart
    gateway: decide_permission_restart_safety
    source: STATE_CATALOG.md (restart_pending + update_in_progress)

  # Graceful: update_in_progress blocks permission restart
  # Rule: If update_in_progress=true → abort permission restart (graceful)
  # Reason: Avoid interrupting update installation process
  - when: {update.in_progress: true}
    decision: abort
    priority: graceful
    description: Update in progress - block permission restart to avoid interrupting installation
    gateway: decide_permission_restart_safety
    source: STATE_CATALOG.md (update_in_progress axis)

  # Hard stop: update_in_progress + active session blocks update launch
  # Rule: If update_in_progress=true AND appMode=LISTENING|PROCESSING → block update launch
  # Reason: Prevent updates during active user sessions
  # NOTE: This rule is for UpdaterIntegration._can_update, not yet integrated with DecisionEngine
  - when: {update.in_progress: true, app.mode: [listening, processing]}
    decision: abort
    priority: hard_stop
    description: Active session during update - block update launch (only allowed in SLEEPING mode)
    gateway: UpdaterIntegration._can_update
    source: STATE_CATALOG.md (update_in_progress axis)

  # Hard stop: first_run + restart_pending blocks update launch
  # Rule: If firstRun=true AND restart_pending=true → block update launch
  # Reason: First-run restart takes precedence over update
  # NOTE: This is handled by decide_permission_restart_safety via app.first_run_restart_pending
  - when: {app.first_run_restart_pending: true}
    decision: abort
    priority: hard_stop
    description: First-run restart pending - block update launch (restart takes precedence)
    gateway: decide_permission_restart_safety
    source: STATE_CATALOG.md (restart_pending + update_in_progress)

  # Hard stop: max_restart_attempts exceeded
  # Rule: If attempts >= max_restart_attempts → skip restart
  # Reason: Protection against infinite restart loops
  - when: {permission_restart: {attempts: ">=max_restart_attempts"}}
    decision: skip_restart
    priority: hard_stop
    description: Max restart attempts reached - skip to prevent infinite loops
    gateway: permission_restart.maybe_schedule_restart
    source: STATE_CATALOG.md (Связь с Permission Restart)

  # Hard stop: permission_restart enabled=false
  # Rule: If enabled=false → skip restart
  # Reason: Mechanism disabled by configuration (development/debugging)
  - when: {permission_restart: {enabled: false}}
    decision: skip_restart
    priority: hard_stop
    description: Permission restart disabled by configuration
    gateway: permission_restart.maybe_schedule_restart
    source: STATE_CATALOG.md (Связь с Permission Restart)
  # ============================================================================
  # AUDIO ROUTE MANAGER RULES
  # ============================================================================

  # Hard stop: RouteManager блокируется во время first_run
  - when: {app.first_run: true}
    decision: abort
    priority: hard_stop
    description: First run in progress - block RouteManager reconcile
    gateway: decide_route_manager_reconcile

  # Hard stop: RouteManager блокируется во время permission_restart
  - when: {app.restart_pending: true}
    decision: abort
    priority: hard_stop
    description: Permission restart pending - block RouteManager reconcile
    gateway: decide_route_manager_reconcile

  # Hard stop: RouteManager блокируется во время update
  - when: {app.update_in_progress: true}
    decision: abort
    priority: hard_stop
    description: Update in progress - block RouteManager reconcile
    gateway: decide_route_manager_reconcile

  # Graceful: Device busy - retry with backoff
  - when: {device.busy: true, app.mode: listening}
    decision: retry
    priority: graceful
    description: Device busy - retry input switch with backoff
    gateway: decide_route_manager_reconcile

  # Graceful: Network offline - degrade (can still listen)
  - when: {network.offline: true, app.mode: listening}
    decision: degrade
    priority: graceful
    description: Network offline - degrade but allow listening
    gateway: decide_route_manager_reconcile

