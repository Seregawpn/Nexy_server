#!/bin/bash
# üì¶ Nexy AI Assistant - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∏ –Ω–æ—Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/release_build.sh [release|local]
#   release: –ø–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å timestamp –∏ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
#   local: –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ (TIMESTAMP_MODE=none)

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ü—É—Ç–∏
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLIENT_DIR="$(dirname "$SCRIPT_DIR")"
BUILD_SCRIPT="$CLIENT_DIR/packaging/build_final.sh"
VERIFY_SCRIPT="$CLIENT_DIR/scripts/verify_packaging_artifacts.sh"

# –†–µ–∂–∏–º —Å–±–æ—Ä–∫–∏
MODE="${1:-release}"

# –§—É–Ω–∫—Ü–∏–∏
log() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
    exit 1
}

info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞
if [[ "$MODE" != "release" && "$MODE" != "local" ]]; then
    error "–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º: $MODE. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'release' –∏–ª–∏ 'local'"
fi

echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BLUE}üöÄ NEXY AI ASSISTANT - –ê–í–¢–û–ú–ê–¢–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–ë–û–†–ö–ê${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞
if [[ "$MODE" == "release" ]]; then
    info "–†–µ–∂–∏–º: RELEASE (–ø–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å timestamp –∏ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–µ–π)"
    export TIMESTAMP_MODE=auto
    unset NEXY_SKIP_NOTARIZATION
    log "TIMESTAMP_MODE=auto (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω --timestamp)"
    log "NEXY_SKIP_NOTARIZATION –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞)"
elif [[ "$MODE" == "local" ]]; then
    info "–†–µ–∂–∏–º: LOCAL (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏)"
    export TIMESTAMP_MODE=none
    export NEXY_SKIP_NOTARIZATION=1
    log "TIMESTAMP_MODE=none (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ timestamp —Å–µ—Ä–≤–∏—Å–∞)"
    log "NEXY_SKIP_NOTARIZATION=1 (–Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞)"
fi

echo ""
echo -e "${BLUE}üìã –®–ê–ì 1: –°–ë–û–†–ö–ê${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —Å–±–æ—Ä–∫–∏
if [ ! -f "$BUILD_SCRIPT" ]; then
    error "–°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BUILD_SCRIPT"
fi

# –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏
log "–ó–∞–ø—É—Å–∫–∞–µ–º build_final.sh..."
if bash "$BUILD_SCRIPT"; then
    log "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    error "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."
fi

echo ""
echo -e "${BLUE}üìã –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –ê–†–¢–ï–§–ê–ö–¢–û–í${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
if [ ! -f "$VERIFY_SCRIPT" ]; then
    warn "–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $VERIFY_SCRIPT"
    warn "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"
else
    log "–ó–∞–ø—É—Å–∫–∞–µ–º verify_packaging_artifacts.sh..."
    if bash "$VERIFY_SCRIPT"; then
        log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."
    fi
fi

echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}üéâ –°–ë–û–†–ö–ê –ò –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–´ –£–°–ü–ï–®–ù–û!${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
info "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ dist/Nexy.app..."
if [ -d "$CLIENT_DIR/dist/Nexy.app" ]; then
    if codesign --verify --deep --strict "$CLIENT_DIR/dist/Nexy.app" >/dev/null 2>&1; then
        log "–ü–æ–¥–ø–∏—Å—å dist/Nexy.app –≤–∞–ª–∏–¥–Ω–∞"
    else
        error "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–æ–¥–ø–∏—Å—å dist/Nexy.app –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!"
    fi
    
    if [[ "$MODE" == "release" ]]; then
        if xcrun stapler validate "$CLIENT_DIR/dist/Nexy.app" >/dev/null 2>&1; then
            log "–ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è dist/Nexy.app –≤–∞–ª–∏–¥–Ω–∞"
        else
            error "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è dist/Nexy.app –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!"
        fi
    fi
else
    warn "dist/Nexy.app –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, —É–¥–∞–ª–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è PKG/DMG)"
fi

echo ""
info "üìÅ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
if [ -f "$CLIENT_DIR/dist/Nexy.pkg" ]; then
    PKG_SIZE=$(du -sh "$CLIENT_DIR/dist/Nexy.pkg" | cut -f1)
    log "  PKG: $CLIENT_DIR/dist/Nexy.pkg ($PKG_SIZE)"
fi
if [ -f "$CLIENT_DIR/dist/Nexy.dmg" ]; then
    DMG_SIZE=$(du -sh "$CLIENT_DIR/dist/Nexy.dmg" | cut -f1)
    log "  DMG: $CLIENT_DIR/dist/Nexy.dmg ($DMG_SIZE)"
fi
if [ -d "$CLIENT_DIR/dist/Nexy.app" ]; then
    APP_SIZE=$(du -sh "$CLIENT_DIR/dist/Nexy.app" | cut -f1)
    log "  APP: $CLIENT_DIR/dist/Nexy.app ($APP_SIZE)"
fi

echo ""
warn "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ó–∞—â–∏—Ç–∞ –ø–æ–¥–ø–∏—Å–∏"
echo "  ‚Ä¢ –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ .app –≤ Finder –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏"
echo "  ‚Ä¢ –ù–ï –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ xattr -cr –Ω–∞ .app"
echo "  ‚Ä¢ –ù–ï –∫–æ–ø–∏—Ä—É–π—Ç–µ .app —á–µ—Ä–µ–∑ Finder –∏–ª–∏ cp -R"
echo "  ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ ditto --noextattr --noqtn –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"

echo ""
log "‚úÖ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!"
