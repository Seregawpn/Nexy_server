#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Nexy.app –±–µ–∑ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏

APP_PATH="dist/Nexy.app"

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Nexy.app (–±–µ–∑ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏)"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
if [ ! -d "$APP_PATH" ]; then
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: $APP_PATH"
    exit 1
fi

echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ: $APP_PATH"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏..."
if codesign --verify --deep --strict "$APP_PATH" 2>/dev/null; then
    echo "‚úÖ –ü–æ–¥–ø–∏—Å—å –≤–∞–ª–∏–¥–Ω–∞"
else
    echo "‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–ø–∏—Å—å—é (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–ø—Ä–æ–Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä..."
ARCHS=$(lipo -info "$APP_PATH/Contents/MacOS/Nexy" 2>/dev/null | grep -o "x86_64\|arm64" | tr '\n' ' ')
echo "‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: $ARCHS"
echo ""

# –°–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞
echo "üìã –°–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo ""
echo "1Ô∏è‚É£  –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ (–æ–±—Ö–æ–¥ Gatekeeper):"
echo "   $APP_PATH/Contents/MacOS/Nexy"
echo ""
echo "2Ô∏è‚É£  –ß–µ—Ä–µ–∑ open (–º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ):"
echo "   open $APP_PATH"
echo ""
echo "3Ô∏è‚É£  –° —É–¥–∞–ª–µ–Ω–∏–µ–º quarantine –∞—Ç—Ä–∏–±—É—Ç–∞:"
echo "   xattr -d com.apple.quarantine $APP_PATH 2>/dev/null || true"
echo "   open $APP_PATH"
echo ""

# –û–ø—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
read -p "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–µ–π—á–∞—Å? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "–ó–∞–ø—É—Å–∫–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    # –£–¥–∞–ª—è–µ–º quarantine –¥–ª—è –æ–±—Ö–æ–¥–∞ Gatekeeper
    xattr -d com.apple.quarantine "$APP_PATH" 2>/dev/null || true
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
    "$APP_PATH/Contents/MacOS/Nexy" &
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ"
    echo "üìù –õ–æ–≥–∏: ~/Library/Application Support/Nexy/logs/"
else
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã—à–µ"
fi
