# –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è MVP-12

**–î–∞—Ç–∞**: 2025-12-23  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ `startAndReturnError_` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞**: –í PyObjC `NSError**` –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–∞–∫ output-–∞—Ä–≥—É–º–µ–Ω—Ç.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω helper –º–µ—Ç–æ–¥ `_engine_start()` –≤ `OutputPlaybackPrototype`
- –í—Å–µ –≤—ã–∑–æ–≤—ã `engine.startAndReturnError_(error)` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `_engine_start()`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤: `mvp6_output_playback/test_output_playback.py`, `mvp12_full_input_output/test_full_input_output.py`

**–§–∞–π–ª—ã**:
- `mvp6_output_playback/test_output_playback.py`: –¥–æ–±–∞–≤–ª–µ–Ω `_engine_start()`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ `main()`
- `mvp12_full_input_output/test_full_input_output.py`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 4 –≤—ã–∑–æ–≤–∞ `startAndReturnError_`

---

### 2. ‚úÖ `OutputPlaybackPrototype` —Å–¥–µ–ª–∞–Ω –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º

**–ü—Ä–æ–±–ª–µ–º–∞**: –ì–æ–Ω–∫–∏ –≤–æ–∫—Ä—É–≥ engine + player node.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω `self._engine_lock = threading.Lock()` –≤ `__init__`
- –ú–µ—Ç–æ–¥—ã `initialize_engine()` –∏ `play_audio_chunk()` –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `with self._engine_lock:`
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å engine –∑–∞—â–∏—â–µ–Ω—ã lock

**–§–∞–π–ª—ã**:
- `mvp6_output_playback/test_output_playback.py`: –¥–æ–±–∞–≤–ª–µ–Ω lock, –º–µ—Ç–æ–¥—ã –æ–±–µ—Ä–Ω—É—Ç—ã

---

### 3. ‚úÖ `current_recognizer` —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ worker thread

**–ü—Ä–æ–±–ª–µ–º–∞**: `self.current_recognizer` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ worker thread, –Ω–µ thread-safe.

**–†–µ—à–µ–Ω–∏–µ**:
- –í `_recognize_and_play_worker()` —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π `recognizer = sr.Recognizer()`
- –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if self.current_recognizer is None`
- –£–¥–∞–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `self.current_recognizer.recognize_google()`

**–§–∞–π–ª—ã**:
- `mvp12_full_input_output/test_full_input_output.py`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `_recognize_and_play_worker()`

---

### 4. ‚úÖ `on_release` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `is_recording` –ø–µ—Ä–µ–¥ stop

**–ü—Ä–æ–±–ª–µ–º–∞**: `on_release` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `is_recording` –ø–µ—Ä–µ–¥ `_stop_recording()`, –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –º—É—Å–æ—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if self.key_pressed and self.is_recording:` –ø–µ—Ä–µ–¥ `_stop_recording()`

**–§–∞–π–ª—ã**:
- `mvp12_full_input_output/test_full_input_output.py`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `on_release` –≤ `start_keyboard_monitoring()`

---

### 5. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `uid+name+sample_rate+channels`

**–ü—Ä–æ–±–ª–µ–º–∞**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ `uid`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å `portaudio_{index}` –∏ –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ device storm.

**–†–µ—à–µ–Ω–∏–µ**:
- –°–æ–∑–¥–∞–Ω–∏–µ "signature" –∏–∑ `(uid, name, sample_rate, channels)` –¥–ª—è input –∏ output
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –ø–æ–ª–Ω–æ–π signature –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ `uid`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏ device storm

**–§–∞–π–ª—ã**:
- `mvp12_full_input_output/test_full_input_output.py`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `_monitor_devices()`

---

### 6. ‚úÖ Decision-–ª–æ–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏—Ö decision-–ª–æ–≥–æ–≤ –¥–ª—è gateway —Ä–µ—à–µ–Ω–∏–π.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã decision-–ª–æ–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: `decision=start ctx={...} source=audio_route_manager duration_ms=0`
- –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ input –∏ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–§–∞–π–ª—ã**:
- `mvp12_full_input_output/test_full_input_output.py`: –¥–æ–±–∞–≤–ª–µ–Ω—ã decision-–ª–æ–≥–∏ –≤ `_monitor_devices()`

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—á–∏ (1-5) –ø—Ä–∏–º–µ–Ω–µ–Ω—ã** ‚úÖ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**:
- ‚úÖ Decision-–ª–æ–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã (–ø—Ä–æ–±–ª–µ–º–∞ 9)
- ‚ö†Ô∏è AVAudioSession –æ—Å—Ç–∞–≤–ª–µ–Ω (–ø—Ä–æ–±–ª–µ–º–∞ 2) - –º–æ–∂–µ—Ç –±—ã—Ç—å —É–±—Ä–∞–Ω –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –±—É–¥–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω
- ‚ö†Ô∏è –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –±–µ–∑ –∞–Ω—Ç–∏–∞–ª–∏–∞—Å–∏–Ω–≥–∞ (–ø—Ä–æ–±–ª–µ–º–∞ 7) - –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞
- ‚ö†Ô∏è Exit Gate "–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç" (–ø—Ä–æ–±–ª–µ–º–∞ 8) - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å MVP-12** —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Exit Gate** –∫—Ä–∏—Ç–µ—Ä–∏–∏:
   - Push-to-talk –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ input —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - Output playback –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –∑–∞–ø–∏—Å—å ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - Happy path: Ctrl+N (2-3 —Å–µ–∫) ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–æ ‚Üí –ø—Ä–æ–∏–≥—Ä–∞–ª–æ
   - Input switch during recording: –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Üí –≤—ã–¥–µ—Ä–Ω—É—Ç—å/–ø–æ–¥–∫–ª—é—á–∏—Ç—å BT/USB
   - Output switch during playback: Ctrl+M ‚Üí –≤–æ –≤—Ä–µ–º—è —Ç–æ–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å output
   - Device storm: 5-10 –±—ã—Å—Ç—Ä—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π output
   - Network fail: –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

