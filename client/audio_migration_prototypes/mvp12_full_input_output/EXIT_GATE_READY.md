# MVP-12: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Exit Gate

**–î–∞—Ç–∞**: 2025-12-23  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Exit Gate

---

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (10 –ø—É–Ω–∫—Ç–æ–≤)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (A-B)

1. ‚úÖ **`startAndReturnError_`** ‚Äî helper –º–µ—Ç–æ–¥ `_engine_start()` –≤ `OutputPlaybackPrototype`
2. ‚úÖ **`OutputPlaybackPrototype`** ‚Äî –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–¥–æ–±–∞–≤–ª–µ–Ω `_engine_lock`)
3. ‚úÖ **`current_recognizer`** ‚Äî —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ worker thread (thread-safe)
4. ‚úÖ **`on_release`** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ `is_recording` –ø–µ—Ä–µ–¥ `_stop_recording()`
5. ‚úÖ **Signature –ª–æ–≥–∏–∫–∞** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `last_input_signature`/`last_output_signature`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-3)

6. ‚úÖ **Recording duration** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ `recording_started_at`
7. ‚úÖ **Device switching fallback** ‚Äî helper `_open_input_stream_with_fallback()` –¥–ª—è BT/HFP
8. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ signatures** ‚Äî input: `(uid, name, device_index)`, output: `(uid, name)`
9. ‚úÖ **Reset `recording_started_at`** ‚Äî —Å–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ input switch (–±—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω = –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è)
10. ‚úÖ **Decision-–ª–æ–≥–∏** ‚Äî –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç `decision=start ctx={...} source=...`

---

## üìã Exit Gate –∫—Ä–∏—Ç–µ—Ä–∏–∏

### ‚úÖ Push-to-talk –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω
- `_start_recording()` —Å–æ–∑–¥–∞–µ—Ç `sounddevice.InputStream`
- Callback `_audio_callback` –∑–∞–ø–æ–ª–Ω—è–µ—Ç `audio_buffer`
- `is_recording = True` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ input —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ `_monitor_devices()` (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π signature: `(uid, name, device_index)`
- Fallback samplerate –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ: `_open_input_stream_with_fallback()`
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π `duration_ms` –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (reset `recording_started_at`)

### ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- `_recognize_and_play_worker()` —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π `Recognizer()`
- Google SR —á–µ—Ä–µ–∑ `recognize_google()`
- –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –¥–æ 16kHz –¥–ª—è Google SR

### ‚úÖ Output playback –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ
- `AVAudioEngine` —á–µ—Ä–µ–∑ `OutputPlaybackPrototype`
- –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `_engine_lock`
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `_engine_start()`

### ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –†–µ–∂–∏–º: follow-system-default + engine recreate
- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è signature: `(uid, name)` –±–µ–∑ `device_index`
- –ò–∑–±–µ–≥–∞–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø—Ä–∏ hotplug/format change

### ‚úÖ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –∑–∞–ø–∏—Å—å ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- `duration_ms` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (–æ—Ç –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
- Worker thread –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- `work_queue.join()` –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π worker

---

## üéØ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è Exit Gate

### Happy path
1. –ù–∞–∂–∞—Ç—å Control+N (2-3 —Å–µ–∫)
2. –ì–æ–≤–æ—Ä–∏—Ç—å –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω
3. –û—Ç–ø—É—Å—Ç–∏—Ç—å Control+N
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `duration_ms` ‚âà 2000-3000ms

### Input switch during recording
1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å (Control+N)
2. –í—ã–¥–µ—Ä–Ω—É—Ç—å/–ø–æ–¥–∫–ª—é—á–∏—Ç—å BT/USB –Ω–∞—É—à–Ω–∏–∫–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∑–∞–ø–∏—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `duration_ms` —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### Output switch during playback
1. –ù–∞–∂–∞—Ç—å Control+M (—Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫)
2. –í–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å–ª–µ–¥—É—é—â–∏–π –∑–≤—É–∫ –∏–¥–µ—Ç –≤ –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –Ω–µ—Ç "engine recreate storm"

### Device storm
1. 5-10 –±—ã—Å—Ç—Ä—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π output (–∏–ª–∏ BT connect/disconnect)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: engine –Ω–µ –ø–∞–¥–∞–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –Ω–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –Ω–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è signature)

### Network fail (–¥–ª—è SR)
1. –û—Ç–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å
2. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `playback_success=False`, —Å–æ–±—ã—Ç–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- `duration_ms` –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ (–Ω–µ –≤—Ä–µ–º—è –Ω–∞ stop/pack)
- –ù–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π device switching (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è signature)
- –ù–µ—Ç "engine recreate storm" –ø—Ä–∏ format changes
- Fallback samplerate —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è BT/HFP —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- Decision-–ª–æ–≥–∏ –≤ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**  
**–û—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ –Ω–µ—Ç**  
**–ì–æ—Ç–æ–≤–æ –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É Exit Gate** üéØ

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MVP-12 –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ Exit Gate –∫—Ä–∏—Ç–µ—Ä–∏–∏.

