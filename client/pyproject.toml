[tool.ruff]
target-version = "py311"
line-length = 100
exclude = [
  ".git",
  ".venv",
  "build",
  "dist",
  "resources",
]

[tool.ruff.lint]
select = [
  "E",  # pycodestyle errors
  "F",  # pyflakes
  "I",  # isort
  "B",  # flake8-bugbear
  "UP", # pyupgrade
  "PL", # pylint (subset)
  "C90", # complexity (McCabe)
]
ignore = [
  "PLC0415", # lazy imports are intentional for optional/macOS-only deps
]
[tool.ruff.lint.mccabe]
max-complexity = 7

[tool.ruff.lint.per-file-ignores]
# Allow higher complexity in selectors/gateways (they are intentionally decision trees)
"integration/core/selectors.py" = ["C901"]
"integration/core/gateways/**/*.py" = ["C901"]
# Lazy imports are intentional for optional/macOS-only dependencies and scripts/tests.
"scripts/**/*.py" = [
  "PLC0415",
  "PLR2004",
  "PLW1510",
  "UP015",
  "E402",
  "E501",
  "F541",
  "C901",
  "PLR0911",
  "PLR0912",
  "PLR0915",
  "B007",
  "E712",
  "UP035",
  "UP041",
  "UP028",
  "PLR1714",
]
"tests/**/*.py" = [
  "PLC0415",
  "PLR2004",
  "E501",
  "F541",
  "UP015",
  "UP041",
  "C901",
  "PLR0911",
  "PLR0912",
  "PLR0915",
  "PLR0913",
  "E402",
  "F841",
  "E712",
]
"integration/core/simple_module_coordinator.py" = ["PLC0415"]
"integration/core/state_manager.py" = ["PLC0415"]
"integration/integrations/input_processing_integration.py" = ["PLC0415"]
"integration/integrations/action_execution_integration.py" = ["PLC0415"]
"modules/voice_recognition/core/*.py" = ["PLC0415"]
"modules/updater/*.py" = ["PLC0415"]
"modules/whatsapp/*.py" = ["PLC0415"]
"modules/welcome_message/core/*.py" = ["PLC0415"]
"packaging/*.py" = ["PLC0415", "PLR2004", "E501"]
# Long schema/help strings in MCP servers (keep readable text blocks).
"mcp_servers/messages/*.py" = ["E501"]
"mcp_servers/telegram/*.py" = ["E501"]
# Integration layer has extensive structured logs; keep readability.
"integration/**/*.py" = [
  "E501",
  "PLR2004",
  "PLW1510",
  "C901",
  "PLR0911",
  "PLR0912",
  "PLR0915",
  "PLR0913",
  "PLR5501",
  "PLW0603",
  "PLW0602",
  "PLW0602",
  "UP015",
  "UP035",
  "UP037",
  "F541",
  "F841",
  "E402",
  "B028",
  "UP007",
  "UP041",
  "B007",
  "E701",
  "B009",
  "PLR1711",
  "PLW0602",
  "F811",
  "B027",
]
# Modules also contain long log/help strings and OS-specific scripts.
"modules/**/*.py" = [
  "E501",
  "PLR2004",
  "PLW1510",
  "B904",
  "C901",
  "PLR0911",
  "PLR0912",
  "PLR0915",
  "PLR0913",
  "PLR5501",
  "F541",
  "UP035",
  "UP041",
  "UP022",
  "F821",
  "E701",
  "B007",
  "B009",
  "PLW0603",
  "PLW0602",
  "UP015",
  "UP009",
  "UP004",
  "PLW2901",
  "PLR0402",
  "PLR1714",
  "F841",
  "UP024",
  "UP037",
  "E722",
  "E402",
  "PLR1730",
  "E713",
]
# Style-only rules for scripts/tests/MCP tooling.
"mcp_servers/**/*.py" = [
  "PLR2004",
  "PLW1510",
  "C901",
  "PLR0911",
  "PLR0912",
  "PLR0915",
  "PLR5501",
  "PLR1730",
  "E713",
  "PLW0602",
  "E701",
  "F541",
]
"config/tests/**/*.py" = ["PLR2004"]
"check_version.py" = ["PLR2004", "UP015"]
"config/server_manager.py" = ["UP015", "C901", "F541"]
"config/unified_config_loader.py" = ["UP007", "UP015", "UP035"]
"config/updater_manager.py" = ["UP015", "C901", "F541"]
"verify_path_resolution.py" = ["E402"]
"test_first_run_centralization.py" = ["E402", "PLR0915", "E712"]
"main.py" = ["E501", "F541", "C901", "B009", "E402", "PLW0602", "PLW0603"]
"run_diagnostics.py" = ["E501", "F541", "C901", "PLR0912", "PLR0915"]

[tool.ruff.lint.isort]
known-first-party = ["integration", "modules", "client"]
force-sort-within-sections = true

[tool.nexy.lint]
# Patterns that should only be accessed through selectors/gateways
# Machine-enforced: ruff will fail if patterns found outside allowed_files
no_direct_state_access_patterns = [
  "\\bperm_mic\\b",
  "\\bperm_screen\\b",
  "\\bperm_accessibility\\b",
  "\\bnetwork_online\\b",
  "\\bfirst_run\\b",
  "\\bdevice_input\\b",
  "\\bapp_mode\\b",
  "\\bstate\\.get",
  "\\bstate\\.set",
  "\\bstate_manager\\.get",
  "\\bstate_manager\\.set",
  "\\bApplicationStateManager\\(\\)\\.get",
  "\\bcfg\\.",
  # Feature flags and kill-switches
  "\\b(perm_|first_run|network|feature_|flag|ks_)\\b",
]
# Files allowed to access state directly (selectors/gateways pattern)
allowed_files = [
  "**/selectors.py",
  "**/gateways.py",
  "**/gateways/**/*.py",
  # Test files are allowed for mocking
  "**/test*.py",
  "**/tests/**/*.py",
]

[tool.basedpyright]
# Configuration for basedpyright type checker
# Add proto directory to extra paths so imports can be resolved
extraPaths = [
  "modules/grpc_client/proto",
]
# Keep type-check useful while reducing legacy noise to warning-level.
typeCheckingMode = "basic"
# Legacy debt bucketed as warnings; hard errors still fail scan.
reportAttributeAccessIssue = "warning"
reportMissingTypeArgument = "warning"
reportOptionalMemberAccess = "warning"
reportConstantRedefinition = "warning"
reportImplicitRelativeImport = "warning"
reportArgumentType = "warning"
reportAssignmentType = "warning"
reportReturnType = "warning"
reportOptionalOperand = "warning"
reportOptionalCall = "warning"
reportOptionalSubscript = "warning"
reportUndefinedVariable = "warning"
reportUnboundVariable = "warning"
reportGeneralTypeIssues = "warning"
# Report missing imports as warnings instead of errors for dynamically added paths
reportMissingImports = "warning"

# Ignore type checking in test files (pytest is a dev dependency)
ignore = [
  "**/test*.py",
  "**/tests/**/*.py",
  "**/test*.py",
  "**/tests/**/*.py",
  "modules/grpc_client/proto",
]

[tool.pytest.ini_options]
markers = [
  "smoke: smoke tests",
]
