#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัััะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั permission restart ะปะพะณะธะบะธ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./manual_test_permission_restart.sh [scenario_number]

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะััะธ
FLAG_FILE="$HOME/.Nexy/permissions_first_run_completed.flag"
LOG_DIR="$HOME/Library/Logs/Nexy"
LOG_FILE="$LOG_DIR/nexy.log"
APP_PATH="/Applications/Nexy.app"

# ะคัะฝะบัะธะธ
print_header() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ  ๐งช Permission Restart - Manual Testing Script           โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo
}

print_section() {
    echo
    echo -e "${YELLOW}โถ $1${NC}"
    echo
}

print_success() {
    echo -e "${GREEN}โ $1${NC}"
}

print_error() {
    echo -e "${RED}โ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

reset_state() {
    print_section "ะกะฑัะพั ัะพััะพัะฝะธั ะฟัะธะปะพะถะตะฝะธั"

    # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต
    if pgrep -x "Nexy" > /dev/null; then
        echo "ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ Nexy..."
        killall Nexy 2>/dev/null || true
        sleep 2
    fi

    # ะฃะดะฐะปัะตะผ ัะปะฐะณ ะฟะตัะฒะพะณะพ ะทะฐะฟััะบะฐ
    if [ -f "$FLAG_FILE" ]; then
        echo "ะฃะดะฐะปัะตะผ ัะปะฐะณ ะฟะตัะฒะพะณะพ ะทะฐะฟััะบะฐ..."
        rm -f "$FLAG_FILE"
        print_success "ะคะปะฐะณ ัะดะฐะปัะฝ"
    else
        echo "ะคะปะฐะณ ะฟะตัะฒะพะณะพ ะทะฐะฟััะบะฐ ะฝะต ะฝะฐะนะดะตะฝ (ะฝะพัะผะฐ ะดะปั ะฟะตัะฒะพะณะพ ัะตััะฐ)"
    fi

    # ะกะพะทะดะฐัะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ ะตัะปะธ ะฝัะถะฝะพ
    mkdir -p "$LOG_DIR"

    # ะััะธะฒะธััะตะผ ััะฐััะต ะปะพะณะธ
    if [ -f "$LOG_FILE" ]; then
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        mv "$LOG_FILE" "$LOG_DIR/nexy_${TIMESTAMP}.log"
        echo "ะกัะฐััะน ะปะพะณ ะฐััะธะฒะธัะพะฒะฐะฝ: nexy_${TIMESTAMP}.log"
    fi

    print_success "ะกะพััะพัะฝะธะต ัะฑัะพัะตะฝะพ"
}

check_prerequisites() {
    print_section "ะัะพะฒะตัะบะฐ ะฟัะตะดััะปะพะฒะธะน"

    # ะัะพะฒะตััะตะผ ััะพ ะฟัะธะปะพะถะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝะพ
    if [ ! -d "$APP_PATH" ]; then
        print_error "ะัะธะปะพะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ: $APP_PATH"
        exit 1
    fi
    print_success "ะัะธะปะพะถะตะฝะธะต ะฝะฐะนะดะตะฝะพ: $APP_PATH"

    # ะัะพะฒะตััะตะผ ััะพ ะฟัะธะปะพะถะตะฝะธะต ะฝะต ะทะฐะฟััะตะฝะพ
    if pgrep -x "Nexy" > /dev/null; then
        print_warning "ะัะธะปะพะถะตะฝะธะต ัะถะต ะทะฐะฟััะตะฝะพ - ะฑัะดะตั ะพััะฐะฝะพะฒะปะตะฝะพ"
    fi
}

watch_logs() {
    print_section "ะัะพัะผะพัั ะปะพะณะพะฒ (Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ)"

    if [ ! -f "$LOG_FILE" ]; then
        echo "ะะถะธะดะฐะตะผ ัะพะทะดะฐะฝะธั ัะฐะนะปะฐ ะปะพะณะพะฒ..."
        # ะะดัะผ ะดะพ 30 ัะตะบัะฝะด ะฟะพะบะฐ ัะฐะนะป ะฟะพัะฒะธััั
        for i in {1..30}; do
            if [ -f "$LOG_FILE" ]; then
                break
            fi
            sleep 1
        done
    fi

    if [ -f "$LOG_FILE" ]; then
        tail -f "$LOG_FILE" | grep --line-buffered -E "(PERMISSION_RESTART|UPDATER|FIRST_RUN|permissions\.|updater\.)"
    else
        print_error "ะคะฐะนะป ะปะพะณะพะฒ ะฝะต ัะพะทะดะฐะฝ: $LOG_FILE"
        echo "ะัะพะฒะตัััะต ััะพ ะฟัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต ัะฐะฑะพัะฐะตั"
    fi
}

start_app() {
    print_section "ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั"

    open -a "$APP_PATH"
    print_success "ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ"

    echo
    echo "โณ ะะถะธะดะฐะตะผ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ (3 ัะตะบัะฝะดั)..."
    sleep 3
}

check_network() {
    if ping -c 1 8.8.8.8 &> /dev/null; then
        print_success "ะะฝัะตัะฝะตั: ะะะะฎะงะะ"
        return 0
    else
        print_warning "ะะฝัะตัะฝะตั: ะะขะะะฎะงะะ"
        return 1
    fi
}

scenario_1() {
    print_header
    echo -e "${BLUE}ะกะฆะะะะะะ 1: ะะฑะฝะพะฒะปะตะฝะธะต ะดะพัััะฟะฝะพ${NC}"
    echo
    echo "ะฆะตะปั: ะัะพะฒะตัะธัั ััะพ permission restart ะะ ะฒัะฟะพะปะฝัะตััั ะตัะปะธ ะพะฑะฝะพะฒะปะตะฝะธะต ะดะพัััะฟะฝะพ"
    echo

    check_prerequisites

    # ะัะพะฒะตััะตะผ ะธะฝัะตัะฝะตั
    if ! check_network; then
        print_error "ะะปั ััะพะณะพ ััะตะฝะฐัะธั ะฝัะถะตะฝ ะธะฝัะตัะฝะตั!"
        echo "ะะบะปััะธัะต ะธะฝัะตัะฝะตั ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ"
        exit 1
    fi

    reset_state
    start_app

    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo
    print_warning "ะกะะะะฃะฎะฉะะ ะจะะะ:"
    echo "1. โ ะัะดะฐะนัะต ัะฐะทัะตัะตะฝะธั ะบะพะณะดะฐ ะฟะพัะฒัััั ะดะธะฐะปะพะณะธ:"
    echo "   โข Microphone"
    echo "   โข Accessibility (ะพัะบัะพะนัะต System Settings)"
    echo "   โข Input Monitoring (ะพัะบัะพะนัะต System Settings)"
    echo "   โข Screen Capture (ะตัะปะธ ะฟะพะฟัะพัะธั)"
    echo
    echo "2. ๐ ะะฐะฑะปัะดะฐะนัะต ะทะฐ ะปะพะณะฐะผะธ ะฝะธะถะต"
    echo
    echo "3. โ ะะะะะะะะซะ ะะะะฃะะฌะขะะข:"
    echo "   โข ะะพะณ: [PERMISSION_RESTART] Update available - skipping"
    echo "   โข ะะพะณ: [UPDATER] Found update to version X.X.X"
    echo "   โข ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟัััะธััั ะะะะ ะะะ (ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั)"
    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo

    watch_logs
}

scenario_2() {
    print_header
    echo -e "${BLUE}ะกะฆะะะะะะ 2: ะะฑะฝะพะฒะปะตะฝะธั ะฝะตั${NC}"
    echo
    echo "ะฆะตะปั: ะัะพะฒะตัะธัั ััะพ permission restart ะฒัะฟะพะปะฝัะตััั ะตัะปะธ ะพะฑะฝะพะฒะปะตะฝะธั ะฝะตั"
    echo

    check_prerequisites

    # ะัะพะฒะตััะตะผ ะธะฝัะตัะฝะตั
    if check_network; then
        print_warning "ะะฝัะตัะฝะตั ะฒะบะปััะตะฝ!"
        echo
        read -p "ะัะบะปััะธัะต ะธะฝัะตัะฝะตั ัะตะนัะฐั ะธ ะฝะฐะถะผะธัะต Enter ะดะปั ะฟัะพะดะพะปะถะตะฝะธั..."

        if check_network; then
            print_error "ะะฝัะตัะฝะตั ะฒัั ะตัั ะฒะบะปััะตะฝ!"
            exit 1
        fi
    fi

    reset_state
    start_app

    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo
    print_warning "ะกะะะะฃะฎะฉะะ ะจะะะ:"
    echo "1. โ ะัะดะฐะนัะต ัะฐะทัะตัะตะฝะธั ะบะพะณะดะฐ ะฟะพัะฒัััั ะดะธะฐะปะพะณะธ"
    echo
    echo "2. ๐ ะะฐะฑะปัะดะฐะนัะต ะทะฐ ะปะพะณะฐะผะธ ะฝะธะถะต"
    echo
    echo "3. โ ะะะะะะะะซะ ะะะะฃะะฌะขะะข:"
    echo "   โข ะะพะณ: [PERMISSION_RESTART] Scheduling application restart"
    echo "   โข ะะพะณ: [PERMISSION_RESTART] Executing restart"
    echo "   โข ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟัััะธััั ัะตัะตะท ~5 ัะตะบัะฝะด"
    echo "   โข ะะพัะปะต ะฟะต๏ฟฝ๏ฟฝะตะทะฐะฟััะบะฐ ะบะปะฐะฒะธะฐัััะฐ ะธ ะผะธะบัะพัะพะฝ ัะฐะฑะพัะฐัั"
    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo

    watch_logs
}

scenario_6() {
    print_header
    echo -e "${BLUE}ะกะฆะะะะะะ 6: Race Condition${NC}"
    echo
    echo "ะฆะตะปั: ะะฑะฝะพะฒะปะตะฝะธะต ะฟะพัะฒะปัะตััั ะะะกะะ ะฟะปะฐะฝะธัะพะฒะฐะฝะธั restart"
    echo

    check_prerequisites

    # ะัะพะฒะตััะตะผ ะธะฝัะตัะฝะตั
    if check_network; then
        print_warning "ะะฝัะตัะฝะตั ะฒะบะปััะตะฝ!"
        echo
        read -p "ะัะบะปััะธัะต ะธะฝัะตัะฝะตั ะกะะะงะะก ะธ ะฝะฐะถะผะธัะต Enter..."

        if check_network; then
            print_error "ะะฝัะตัะฝะตั ะฒัั ะตัั ะฒะบะปััะตะฝ!"
            exit 1
        fi
    fi

    print_success "ะะฝัะตัะฝะตั ะพัะบะปััะตะฝ"

    reset_state
    start_app

    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo
    print_warning "ะกะะะะฃะฎะฉะะ ะจะะะ:"
    echo "1. โ ะัะดะฐะนัะต ัะฐะทัะตัะตะฝะธั"
    echo
    echo "2. โฑ๏ธ  ะกัะฐะทั ะฟะพัะปะต ะฒัะดะฐัะธ ัะฐะทัะตัะตะฝะธะน (ะฒ ัะตัะตะฝะธะต 5 ัะตะบัะฝะด):"
    echo "   ${RED}ะะซะกะขะะ ะะะะฎะงะะขะ ะะะขะะะะะข!${NC}"
    echo
    echo "3. ๐ ะะฐะฑะปัะดะฐะนัะต ะทะฐ ะปะพะณะฐะผะธ ะฝะธะถะต"
    echo
    echo "4. โ ะะะะะะะะซะ ะะะะฃะะฌะขะะข:"
    echo "   โข ะะพะณ: [PERMISSION_RESTART] Scheduling application restart"
    echo "   โข ะะพะณ: [UPDATER] Found update to version X.X.X"
    echo "   โข ะะพะณ: [PERMISSION_RESTART] Waiting for update..."
    echo "   โข ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟัััะธััั ะะะะ ะะะ (ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั)"
    echo
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo

    watch_logs
}

show_menu() {
    print_header
    echo "ะัะฑะตัะธัะต ััะตะฝะฐัะธะน ะดะปั ัะตััะธัะพะฒะฐะฝะธั:"
    echo
    echo "  1) ะกัะตะฝะฐัะธะน 1: ะะฑะฝะพะฒะปะตะฝะธะต ะดะพัััะฟะฝะพ (ะบัะธัะธัะตัะบะธะน)"
    echo "  2) ะกัะตะฝะฐัะธะน 2: ะะฑะฝะพะฒะปะตะฝะธั ะฝะตั (ะฑะฐะทะพะฒัะน)"
    echo "  3) ะกัะตะฝะฐัะธะน 6: Race Condition (ะบัะธัะธัะตัะบะธะน)"
    echo
    echo "  r) ะขะพะปัะบะพ ัะฑัะพั ัะพััะพัะฝะธั"
    echo "  l) ะขะพะปัะบะพ ะฟัะพัะผะพัั ะปะพะณะพะฒ"
    echo "  q) ะััะพะด"
    echo
    read -p "ะะฐั ะฒัะฑะพั: " choice

    case $choice in
        1) scenario_1 ;;
        2) scenario_2 ;;
        3) scenario_6 ;;
        r) reset_state ;;
        l) watch_logs ;;
        q) exit 0 ;;
        *)
            print_error "ะะตะฒะตัะฝัะน ะฒัะฑะพั: $choice"
            show_menu
            ;;
    esac
}

# ะะปะฐะฒะฝะฐั ะปะพะณะธะบะฐ
if [ $# -eq 0 ]; then
    # ะะฝัะตัะฐะบัะธะฒะฝัะน ัะตะถะธะผ
    show_menu
else
    # ะะฐะฟััะบ ะบะพะฝะบัะตัะฝะพะณะพ ััะตะฝะฐัะธั
    case $1 in
        1) scenario_1 ;;
        2) scenario_2 ;;
        6) scenario_6 ;;
        *)
            echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 [1|2|6]"
            echo "  1 - ะกัะตะฝะฐัะธะน 1: ะะฑะฝะพะฒะปะตะฝะธะต ะดะพัััะฟะฝะพ"
            echo "  2 - ะกัะตะฝะฐัะธะน 2: ะะฑะฝะพะฒะปะตะฝะธั ะฝะตั"
            echo "  6 - ะกัะตะฝะฐัะธะน 6: Race Condition"
            exit 1
            ;;
    esac
fi
