# –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏–æ (Input/Output)

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
2025-11-30

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ê–£–î–ò–û –°–ò–°–¢–ï–ú–ê NEXY                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

INPUT (–ú–∏–∫—Ä–æ—Ñ–æ–Ω)                          OUTPUT (–î–∏–Ω–∞–º–∏–∫–∏)
‚îú‚îÄ InputProcessingIntegration             ‚îú‚îÄ SpeechPlaybackIntegration
‚îÇ  ‚îî‚îÄ KeyboardMonitor                    ‚îÇ  ‚îî‚îÄ SequentialSpeechPlayer
‚îÇ     ‚îî‚îÄ LONG_PRESS/RELEASE              ‚îÇ     ‚îî‚îÄ ChunkBuffer
‚îÇ                                          ‚îÇ
‚îú‚îÄ VoiceRecognitionIntegration            ‚îú‚îÄ GrpcClientIntegration
‚îÇ  ‚îî‚îÄ SpeechRecognizer                    ‚îÇ  ‚îî‚îÄ gRPC Stream
‚îÇ     ‚îú‚îÄ AudioDeviceMonitor               ‚îÇ     ‚îî‚îÄ audio_chunk events
‚îÇ     ‚îú‚îÄ DeviceParamsNormalizer           ‚îÇ
‚îÇ     ‚îî‚îÄ sd.InputStream                   ‚îÇ
‚îÇ                                          ‚îÇ
‚îî‚îÄ MicrophoneStateManager                 ‚îî‚îÄ SignalIntegration
   ‚îî‚îÄ microphone.opened/closed                ‚îî‚îÄ AudioToneChannel
```

---

## 1. AUDIO INPUT (–ú–∏–∫—Ä–æ—Ñ–æ–Ω) - –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫

### 1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```
[SpeechRecognizer.__init__]
  ‚îú‚îÄ input_device_name: Optional[str] = None  # PRIMARY –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  ‚îú‚îÄ input_device_id: Any = None              # RUNTIME –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  ‚îú‚îÄ _device_name_to_id_cache: Dict[str, DeviceCacheEntry]  # TTL –∫—ç—à
  ‚îî‚îÄ AudioDeviceMonitor (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

[SpeechRecognizer.start_listening]
  ‚îú‚îÄ _get_system_default_input_index()
  ‚îÇ   ‚îú‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 1: _get_system_default_input_name()
  ‚îÇ   ‚îÇ   ‚îî‚îÄ SwitchAudioSource -c -t input -f json
  ‚îÇ   ‚îÇ       ‚îî‚îÄ _find_device_id_by_name_input(name)  # –ü–æ–∏—Å–∫ ID –ø–æ –∏–º–µ–Ω–∏
  ‚îÇ   ‚îÇ           ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL –∫—ç—à–∞
  ‚îÇ   ‚îÇ           ‚îú‚îÄ Exponential backoff (max_retries=3, base_delay=0.3s)
  ‚îÇ   ‚îÇ           ‚îî‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
  ‚îÇ   ‚îÇ
  ‚îÇ   ‚îî‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 2: sd.default.device[0] (fallback)
  ‚îÇ
  ‚îú‚îÄ DeviceParamsNormalizer.normalize_input_params()
  ‚îÇ   ‚îî‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: sample_rate, channels, dtype
  ‚îÇ
  ‚îî‚îÄ sd.InputStream(device=input_device_id, ...)
      ‚îî‚îÄ _audio_callback() ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–æ–≤
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ INPUT:**
- ‚ö†Ô∏è **TTL –∫—ç—à –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º** –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚ö†Ô∏è **Exponential backoff** –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 0.9s (3 –ø–æ–ø—ã—Ç–∫–∏ √ó 0.3s)
- ‚ö†Ô∏è **SwitchAudioSource –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí fallback –Ω–∞ PortAudio
- ‚ö†Ô∏è **PortAudio –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ BT

### 1.2 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (INPUT)

```
[AudioDeviceMonitor._monitor_loop]  # –ö–∞–∂–¥—ã–µ 0.5s
  ‚îú‚îÄ _get_current_input_device()
  ‚îÇ   ‚îú‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 1: _get_device_via_macos_api()
  ‚îÇ   ‚îÇ   ‚îú‚îÄ SwitchAudioSource -c -t input -f json
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Exponential backoff (max_retries=3, base_delay=0.3s)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ –ü–æ–∏—Å–∫ ID –ø–æ –∏–º–µ–Ω–∏ –≤ PortAudio
  ‚îÇ   ‚îÇ
  ‚îÇ   ‚îî‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 2: sd.default.device[0] (fallback)
  ‚îÇ
  ‚îú‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –ò–ú–ï–ù–ò (–Ω–µ –ø–æ ID!)
  ‚îÇ   ‚îú‚îÄ –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí –†–ï–ê–õ–¨–ù–ê–Ø —Å–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  ‚îÇ   ‚îÇ   ‚îî‚îÄ –ï—Å–ª–∏ –∏–¥–µ—Ç –∑–∞–ø–∏—Å—å ‚Üí _graceful_stop_listening()
  ‚îÇ   ‚îÇ
  ‚îÇ   ‚îî‚îÄ –ï—Å–ª–∏ ID –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω–æ –∏–º—è —Ç–æ –∂–µ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ID
  ‚îÇ
  ‚îî‚îÄ Callback: _on_device_changed(old_device_id, new_device_id)
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ INPUT:**
- ‚ö†Ô∏è **–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ 0.5s** –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚ö†Ô∏è **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏** –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ PortAudio
- ‚ö†Ô∏è **Graceful stop** –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫ –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ

### 1.3 –ü–æ—Ç–æ–∫ –∑–∞–ø–∏—Å–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

```
[InputProcessingIntegration._handle_long_press]
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∏ (5 –∑–∞—â–∏—Ç):
  ‚îÇ   ‚îú‚îÄ _long_press_in_progress? ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  ‚îÇ   ‚îú‚îÄ _input_state == PENDING? ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º
  ‚îÇ   ‚îú‚îÄ keyboard_monitor.key_pressed? ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º
  ‚îÇ   ‚îú‚îÄ state_manager.is_microphone_active()? ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ True
  ‚îÇ   ‚îî‚îÄ _recording_started? ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ True
  ‚îÇ
  ‚îú‚îÄ _wait_for_mic_opened()  # Polling state_manager.is_microphone_active()
  ‚îÇ   ‚îî‚îÄ –¢–∞–π–º–∞—É—Ç: 5.0s
  ‚îÇ
  ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.recording_start
  ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: mode.request(LISTENING)

[VoiceRecognitionIntegration._on_recording_start]
  ‚îú‚îÄ MicrophoneStateManager.request_open(session_id)
  ‚îÇ   ‚îú‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: IDLE ‚Üí OPENING
  ‚îÇ   ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.open_requested
  ‚îÇ   ‚îî‚îÄ –ñ–¥–µ—Ç: microphone.opened (—Ç–∞–π–º–∞—É—Ç 5s)
  ‚îÇ
  ‚îî‚îÄ SpeechRecognizer.start_listening()
      ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç sd.InputStream
      ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.opened
      ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.mic_opened

[SpeechRecognizer._audio_callback]
  ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫–∏
  ‚îú‚îÄ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, VAD)
  ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±—É—Ñ–µ—Ä –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

[InputProcessingIntegration._handle_key_release]
  ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.recording_stop
  ‚îî‚îÄ _wait_for_mic_closed()  # –¢–∞–π–º–∞—É—Ç: 1.0s

[VoiceRecognitionIntegration._on_recording_stop]
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ç–æ–∫–∞: _current_stream.active
  ‚îú‚îÄ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω)
  ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.closed (–°–†–ê–ó–£ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
  ‚îú‚îÄ MicrophoneStateManager.request_close()
  ‚îî‚îÄ SpeechRecognizer.stop_listening()
      ‚îú‚îÄ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫
      ‚îî‚îÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –ø–æ—Ç–æ–∫–∞ INPUT:**
- üî¥ **Deadlock –≤ request_close**: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π microphone.closed –î–û request_close
- ‚ö†Ô∏è **Polling –≤–º–µ—Å—Ç–æ —Å–æ–±—ã—Ç–∏–π** –≤ _wait_for_mic_opened (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º)
- ‚ö†Ô∏è **–¢–∞–π–º–∞—É—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏** –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (5s –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è, 1s –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è)
- ‚ö†Ô∏è **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞** –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ PortAudio

---

## 2. AUDIO OUTPUT (–î–∏–Ω–∞–º–∏–∫–∏) - –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫

### 2.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```
[SequentialSpeechPlayer.__init__]
  ‚îú‚îÄ output_device_name: Optional[str] = None  # PRIMARY –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  ‚îú‚îÄ _current_output_device_id: Optional[int] = None  # RUNTIME –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  ‚îú‚îÄ _device_tracking_lock: threading.RLock()
  ‚îî‚îÄ _output_monitor_thread: Optional[threading.Thread] = None

[SequentialSpeechPlayer.initialize]
  ‚îú‚îÄ _sync_output_format()
  ‚îÇ   ‚îî‚îÄ _query_default_output_device()
  ‚îÇ       ‚îú‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 1: _get_output_device_name_via_macos_api()
  ‚îÇ       ‚îÇ   ‚îî‚îÄ SwitchAudioSource -c -t output -f json
  ‚îÇ       ‚îÇ       ‚îî‚îÄ _find_device_id_by_name(name, device_type='output')
  ‚îÇ       ‚îÇ           ‚îú‚îÄ –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ sd.query_devices()
  ‚îÇ       ‚îÇ           ‚îú‚îÄ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: max_output_channels > 0
  ‚îÇ       ‚îÇ           ‚îú‚îÄ –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏
  ‚îÇ       ‚îÇ           ‚îú‚îÄ –ù–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
  ‚îÇ       ‚îÇ           ‚îî‚îÄ –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
  ‚îÇ       ‚îÇ
  ‚îÇ       ‚îî‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 2: sd.default.device[1] (fallback)
  ‚îÇ
  ‚îú‚îÄ DeviceParamsNormalizer.normalize_output_params()
  ‚îÇ   ‚îî‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: sample_rate, channels, dtype
  ‚îÇ
  ‚îî‚îÄ _start_output_monitoring()  # –ï—Å–ª–∏ auto_output_device_switch=True
      ‚îî‚îÄ _output_monitor_loop()  # –ö–∞–∂–¥—ã–µ 1.0s
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ OUTPUT:**
- ‚ö†Ô∏è **SwitchAudioSource –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∏–º—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ PortAudio** ‚Üí fallback
- ‚ö†Ô∏è **–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ** (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞)
- ‚ö†Ô∏è **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ auto_output_device_switch=True**

### 2.2 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (OUTPUT)

```
[SequentialSpeechPlayer._output_monitor_loop]  # –ö–∞–∂–¥—ã–µ 5.0s –¥–ª—è BT, 1.0s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
  ‚îú‚îÄ ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´: _get_output_device_name_via_macos_api()
  ‚îÇ   ‚îî‚îÄ SwitchAudioSource -c -t output -f json
  ‚îÇ       ‚îî‚îÄ –ù–ï–¢ fallback –Ω–∞ PortAudio –∏–ª–∏ sd.default.device (—É–±—Ä–∞–Ω)
  ‚îÇ       ‚îî‚îÄ –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ ‚Üí return None, –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—ë–º
  ‚îÇ
  ‚îú‚îÄ ‚úÖ –î–õ–Ø BT –£–°–¢–†–û–ô–°–¢–í: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è device=None (–Ω–µ –∏—â–µ—Ç—Å—è ID –≤ PortAudio)
  ‚îÇ   ‚îî‚îÄ –î–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤: _find_device_id_by_name(name, device_type='output')
  ‚îÇ
  ‚îú‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–∑ SwitchAudioSource - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
  ‚îÇ   ‚îú‚îÄ –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí _switch_output_device(new_name, new_id, is_bluetooth)
  ‚îÇ   ‚îî‚îÄ –ï—Å–ª–∏ –∏–º—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ID (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω)
  ‚îÇ
  ‚îî‚îÄ _switch_output_device(new_name, new_id, is_bluetooth)
      ‚îú‚îÄ ‚úÖ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: _stop_audio_stream(is_bluetooth=old_is_bluetooth)
      ‚îÇ   ‚îú‚îÄ stop(), close()
      ‚îÇ   ‚îú‚îÄ —Ü–∏–∫–ª while stream_ref.active: sleep(0.02) (—Ç–∞–π–º–∞—É—Ç 3—Å –¥–ª—è BT, 1—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö)
      ‚îÇ   ‚îú‚îÄ –ª–æ–≥ "active=False"
      ‚îÇ   ‚îú‚îÄ self._audio_stream=None
      ‚îÇ   ‚îî‚îÄ delay 2—Å (BT) / 0.3—Å (–æ–±—ã—á–Ω–æ–µ) –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
      ‚îú‚îÄ ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ï –ó–ê–î–ï–†–ñ–ö–ò: 0.5—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 2.0—Å –¥–ª—è BT (–ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞)
      ‚îú‚îÄ –û—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä: chunk_buffer.clear()
      ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: DeviceParamsNormalizer (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –Ω–µ –¥–ª—è BT)
      ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç output_device_name, _current_output_device_id, _is_current_device_bluetooth
      ‚îî‚îÄ ‚úÖ –í–´–ó–´–í–ê–ï–¢ _start_audio_stream(sync_output=True, device_id=None) –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ OUTPUT:**
- ‚úÖ **SwitchAudioSource - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** (fallback –Ω–∞ PortAudio —É–±—Ä–∞–Ω)
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏**: 5.0s –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤, 1.0s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
- ‚úÖ **–î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è device=None, –Ω–µ –∏—â–µ—Ç—Å—è ID –≤ PortAudio
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**: —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏**: 0.3—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 2.0—Å –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚ö†Ô∏è **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ** (–æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞) - –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
- ‚ö†Ô∏è **Lazy start** –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

### 2.3 –ü–æ—Ç–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

```
[GrpcClientIntegration._on_voice_completed]
  ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: grpc.response.audio
      ‚îî‚îÄ session_id, dtype, sample_rate, channels, bytes

[SpeechPlaybackIntegration._on_audio_chunk]
  ‚îú‚îÄ –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç audio_data –∏–∑ bytes
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–ª–µ–µ—Ä
  ‚îú‚îÄ _check_and_update_output_device()  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  ‚îÇ   ‚îú‚îÄ _get_output_device_name_via_macos_api()
  ‚îÇ   ‚îî‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å output_device_name
  ‚îÇ
  ‚îú‚îÄ start_playback()  # –ï—Å–ª–∏ –Ω–µ –∏–≥—Ä–∞–µ—Ç
  ‚îÇ   ‚îî‚îÄ _ensure_stream_started()
  ‚îÇ       ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç sd.OutputStream (lazy start)
  ‚îÇ       ‚îî‚îÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—Ç–æ–∫
  ‚îÇ
  ‚îî‚îÄ add_audio_data(audio_data, metadata)
      ‚îú‚îÄ –î–æ–±–∞–≤–ª—è–µ—Ç –≤ ChunkBuffer
      ‚îî‚îÄ –ü–æ—Ç–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —á–µ—Ä–µ–∑ _audio_callback()

[SequentialSpeechPlayer._audio_callback]
  ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ ChunkBuffer
  ‚îú‚îÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∫–∞–Ω–∞–ª—ã (–º–æ–Ω–æ ‚Üí —Å—Ç–µ—Ä–µ–æ)
  ‚îî‚îÄ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ outdata
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –ø–æ—Ç–æ–∫–∞ OUTPUT:**
- ‚úÖ **SwitchAudioSource - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**: —É–±—Ä–∞–Ω—ã –≤—Å–µ fallback –Ω–∞ PortAudio –∏ `sd.default.device`, –µ—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ ‚Üí return None
- ‚úÖ **BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è device=None, channels –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞), –Ω–µ –∑–∞–¥–∞—é—Ç—Å—è blocksize/latency (macOS —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
- ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞**: —Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è active=False (—Ç–∞–π–º–∞—É—Ç 3—Å –¥–ª—è BT, 1—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö), –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ close() (2—Å –¥–ª—è BT, 0.3—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö)
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞**: –ø–µ—Ä–µ–¥ sd.OutputStream —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ self._audio_stream is None, –∏–Ω–∞—á–µ _stop_audio_stream() –∏ –æ–∂–∏–¥–∞–Ω–∏–µ
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ -9986/-10851**: –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è _stop_audio_stream() + sleep(1.0), —Å–æ–∑–¥–∞–µ—Ç—Å—è stream —Å device=None, —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π backoff (√ó1.5)
- ‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏–º—è —Å—Ç–∞—Ä–æ–≥–æ/–Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–∏–ø (BT/–æ–±—ã—á–Ω–æ–µ), –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∑–∞–¥–µ—Ä–∂–∫–∏, –æ—à–∏–±–∫–∏, "—Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π stream", "SwitchAudioSource ‚Üí device=None –¥–ª—è BT"
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å InputProcessingIntegration**: —Ç–∞–π–º–∞—É—Ç _ensure_playback_idle() = 5.0—Å, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ TimeoutError (–º–∞–∫—Å–∏–º—É–º 3 —Ä–∞–∑–∞)
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**: _switch_output_device() –≤—ã–∑—ã–≤–∞–µ—Ç _start_audio_stream() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚ö†Ô∏è **Lazy start** –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- ‚ö†Ô∏è **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤** –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞—á–µ—Å—Ç–≤–æ–º

---

## 3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–û–ß–ö–ò –ò –ü–†–û–ë–õ–ï–ú–´

### 3.1 –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É SwitchAudioSource –∏ PortAudio
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- SwitchAudioSource –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Sergiy's AirPods")
- PortAudio –º–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ò–ª–∏ –∏–º—è –≤ PortAudio –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∏–º–µ–Ω–∏ –≤ SwitchAudioSource

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí fallback –Ω–∞ sd.default.device
- –ú–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "MacBook Air Speakers" –≤–º–µ—Å—Ç–æ –Ω–∞—É—à–Ω–∏–∫–æ–≤)

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏ (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –≤ _find_device_id_by_name)
- Fallback –Ω–∞ sd.default.device

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è BT (bt_prestart_delay)
- –î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –ø–æ–∏—Å–∫–µ

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à PortAudio
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- PortAudio –∫—ç—à–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- sd.query_devices() –º–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—Ä–∞–∑—É

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ PortAudio, —Ö–æ—Ç—è –æ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
- Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- TTL –∫—ç—à —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- Exponential backoff –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ PortAudio (sd._terminate() + sd._initialize())
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å macOS API –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: Race conditions –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –°—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –û—à–∏–±–∫–∏ PortAudio (Error 89, Error 35)
- –ü–æ—Ç–µ—Ä—è –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (_device_tracking_lock, _output_monitor_lock)
- Graceful stop –¥–ª—è INPUT
- –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –¥–ª—è OUTPUT

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ "SWITCHING" –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è graceful stop
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ

### 3.2 –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã INPUT

#### –ü—Ä–æ–±–ª–µ–º–∞ 4: Deadlock –≤ request_close
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- request_close –∂–¥–∞–ª microphone.closed
- microphone.closed –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è –ø–æ—Å–ª–µ stop_listening
- stop_listening –≤—ã–∑—ã–≤–∞–ª—Å—è –ø–æ—Å–ª–µ request_close

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è microphone.closed –°–†–ê–ó–£ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- –î–û –≤—ã–∑–æ–≤–∞ request_close

#### –ü—Ä–æ–±–ª–µ–º–∞ 5: Polling –≤–º–µ—Å—Ç–æ —Å–æ–±—ã—Ç–∏–π –≤ _wait_for_mic_opened
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- _wait_for_mic_opened –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polling state_manager.is_microphone_active()
- –ò–Ω—Ç–µ—Ä–≤–∞–ª polling: 0.05s
- –¢–∞–π–º–∞—É—Ç: 5.0s

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 0.05s –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ microphone.opened –≤–º–µ—Å—Ç–æ polling
- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 6: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –í _on_recording_stop –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è _current_stream.active
- –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω, –æ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ PortAudio

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –û—à–∏–±–∫–∏ PortAudio –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å graceful stop –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑–µ—Ä–≤
- –î–æ–±–∞–≤–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

### 3.3 –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã OUTPUT

#### –ü—Ä–æ–±–ª–µ–º–∞ 7: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±—É—Ñ–µ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è
- –¢–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
- –ù–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º add_audio_data (lazy start)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ—Ä—è –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
- –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –±—É—Ñ–µ—Ä –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
- –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤

#### –ü—Ä–æ–±–ª–µ–º–∞ 8: Lazy start –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º add_audio_data
- –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –ø–æ—Ç–æ–∫ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
- –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –ü–æ—Ç–µ—Ä—è –ø–µ—Ä–≤—ã—Ö —á–∞–Ω–∫–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- _check_and_update_output_device() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º add_audio_data
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU
- –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–∞–Ω–∫–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)

---

## 4. –°–•–ï–ú–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

```mermaid
graph TB
    subgraph "INPUT FLOW"
        K[KeyboardMonitor] -->|LONG_PRESS| I[InputProcessingIntegration]
        I -->|voice.recording_start| V[VoiceRecognitionIntegration]
        V -->|request_open| M[MicrophoneStateManager]
        M -->|microphone.open_requested| V
        V -->|start_listening| S[SpeechRecognizer]
        S -->|_get_system_default_input_index| D1[Device Detection]
        D1 -->|SwitchAudioSource| API1[macOS API]
        D1 -->|sd.default.device| PA1[PortAudio]
        S -->|sd.InputStream| STREAM1[Audio Stream]
        STREAM1 -->|_audio_callback| S
        S -->|voice.recognition_completed| I
        I -->|voice.recording_stop| V
        V -->|stop_listening| S
        S -->|microphone.closed| M
    end
    
    subgraph "OUTPUT FLOW"
        G[GrpcClientIntegration] -->|grpc.response.audio| P[SpeechPlaybackIntegration]
        P -->|add_audio_data| PL[SequentialSpeechPlayer]
        PL -->|_check_and_update_output_device| D2[Device Detection]
        D2 -->|SwitchAudioSource| API2[macOS API]
        D2 -->|sd.default.device| PA2[PortAudio]
        PL -->|_ensure_stream_started| STREAM2[Audio Stream]
        STREAM2 -->|_audio_callback| PL
        PL -->|ChunkBuffer| STREAM2
    end
    
    subgraph "DEVICE MONITORING"
        AM[AudioDeviceMonitor] -->|_monitor_loop| D1
        OM[OutputMonitorThread] -->|_output_monitor_loop| D2
        AM -->|device_changed| S
        OM -->|device_changed| PL
    end
    
    style K fill:#e1f5ff
    style I fill:#e1f5ff
    style V fill:#e1f5ff
    style S fill:#e1f5ff
    style G fill:#fff4e1
    style P fill:#fff4e1
    style PL fill:#fff4e1
    style D1 fill:#ffe1f5
    style D2 fill:#ffe1f5
    style API1 fill:#ffe1f5
    style API2 fill:#ffe1f5
    style PA1 fill:#ffe1f5
    style PA2 fill:#ffe1f5
```

---

## 5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω deadlock –≤ request_close** - –ø—É–±–ª–∏–∫–∞—Ü–∏—è microphone.closed –î–û request_close
2. ‚ö†Ô∏è **–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - bt_prestart_delay –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
3. ‚ö†Ô∏è **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ PortAudio** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)
4. ‚ö†Ô∏è **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤ OUTPUT** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
5. ‚ö†Ô∏è **–£–ª—É—á—à–∏—Ç—å graceful stop** - —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
6. ‚ö†Ô∏è **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ SWITCHING** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ)
7. ‚ö†Ô∏è **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤–º–µ—Å—Ç–æ polling** - –¥–ª—è _wait_for_mic_opened
8. ‚ö†Ô∏è **–°–æ—Ö—Ä–∞–Ω—è—Ç—å –±—É—Ñ–µ—Ä –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ OUTPUT** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
9. ‚ö†Ô∏è **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** - –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º

---

## 6. –¢–ï–ö–£–©–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø (–†–ï–ê–õ–ò–ó–û–í–ê–ù–û)

### ‚úÖ TTL –∫—ç—à –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ö—ç—à —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ø–æ TTL
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL

### ‚úÖ Exponential backoff –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- Retry —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –±–∞–∑–æ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π 0.3s

### ‚úÖ –§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: 1.0s
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

### ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Üí –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É ‚Üí —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- –£–ª—É—á—à–∞–µ—Ç –ø–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—é—â–∏–º–∏—Å—è –∏–º–µ–Ω–∞–º–∏

### ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ INPUT
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ request_close
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ deadlock

---

## 7. –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∞—É—à–Ω–∏–∫–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- SwitchAudioSource –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "MacBook Air Speakers"
- PortAudio –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ "MacBook Air Speakers" (ID=2)
- –ù–∞—É—à–Ω–∏–∫–∏ "Sergiy's AirPods" –Ω–µ –≤–∏–¥–Ω—ã –≤ PortAudio

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ù–∞—É—à–Ω–∏–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –∫–∞–∫ default output –≤ macOS
2. PortAudio –Ω–µ –æ–±–Ω–æ–≤–∏–ª —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –ù–∞—É—à–Ω–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∫–∞–∫ input —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ macOS (–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ó–≤—É–∫)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ PortAudio
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–≤–æ–¥ SwitchAudioSource -a -t output

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ PortAudio
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞—É—à–Ω–∏–∫–∏ –≤—ã–±—Ä–∞–Ω—ã –∫–∞–∫ default output –≤ macOS

---

## 8. –ú–ï–¢–†–ò–ö–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ú–µ—Ç—Ä–∏–∫–∏ INPUT
- `device_detection_time_ms` - –≤—Ä–µ–º—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `device_switch_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `stream_start_retries` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞
- `mic_open_latency_ms` - –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

### –ú–µ—Ç—Ä–∏–∫–∏ OUTPUT
- `device_detection_time_ms` - –≤—Ä–µ–º—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `device_switch_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `stream_start_retries` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞
- `playback_start_latency_ms` - –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º DEBUG/INFO
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º ERROR
- –î–æ–±–∞–≤–ª–µ–Ω—ã —ç–º–æ–¥–∑–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (üîç, ‚úÖ, ‚ö†Ô∏è, ‚ùå)

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏–æ –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:
1. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º –º–µ–∂–¥—É macOS API –∏ PortAudio
2. –£—Å—Ç–∞—Ä–µ–≤—à–∏–º –∫—ç—à–µ–º PortAudio –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
3. Race conditions –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (deadlock, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞). –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.



