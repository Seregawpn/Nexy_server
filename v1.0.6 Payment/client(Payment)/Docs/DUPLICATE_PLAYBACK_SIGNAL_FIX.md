# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è playback.signal

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª –æ "–¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏" –∑–≤—É–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ LONG_PRESS. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –ø–æ–∫–∞–∑–∞–ª –¥–≤–µ –ø—Ä–æ–±–ª–µ–º—ã:

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ERROR —Å–∏–≥–Ω–∞–ª–∞

1. **LONG_PRESS** ‚Üí `voice.mic_opened` ‚Üí `SignalIntegration._on_voice_mic_opened` ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç `playback.signal` —Å `pattern=listen_start`
2. **RELEASE** (–ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è) ‚Üí `voice.recognition_failed` ‚Üí `SignalIntegration._on_error_like` ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç `playback.signal` —Å `pattern=error`

–û–±–∞ —Å–∏–≥–Ω–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è —á–µ—Ä–µ–∑ `SpeechPlaybackIntegration._on_playback_signal`, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ "–¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏" - —Å–Ω–∞—á–∞–ª–∞ –∑–≤—É–∫ `listen_start`, –∑–∞—Ç–µ–º —Å—Ä–∞–∑—É –∑–≤—É–∫ `error`.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ LISTEN_START —Å–∏–≥–Ω–∞–ª–∞

–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ `voice.mic_opened` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥ (–≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —Å–ª—É—à–∞–Ω–∏—è), –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ `SignalIntegration._on_voice_mic_opened` –ø—É–±–ª–∏–∫—É–µ—Ç `playback.signal` —Å `pattern=listen_start`, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –¥–≤–æ–π–Ω–æ–π –∑–≤—É–∫ –¥–∞–∂–µ –¥–ª—è –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏.

## –ü—Ä–∏—á–∏–Ω–∞

–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ `mode.request` –∏–ª–∏ `stop_listening`, –∞ –≤ —Ç–æ–º, —á—Ç–æ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ (`voice.recognition_failed`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `playback.signal` —Å `pattern=error`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `listen_start`, —Å–æ–∑–¥–∞–≤–∞—è –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç "–¥–≤–æ–π–Ω–æ–≥–æ –∑–≤—É–∫–∞".

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ suppression –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

### 1. –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ ERROR —Å–∏–≥–Ω–∞–ª–∞ (`_on_error_like`)

- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ LISTEN_START**: –ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ `LISTEN_START` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤—Ä–µ–º—è (`_last_listen_start_time`)
- **–ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ ERROR —Å–∏–≥–Ω–∞–ª–∞**: –ï—Å–ª–∏ `ERROR` –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `LISTEN_START`, –æ–Ω –ø–æ–¥–∞–≤–ª—è–µ—Ç—Å—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ suppression**: –ü—Ä–∏ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏—á–∏–Ω–∞ –∏ –≤—Ä–µ–º—è —Å –º–æ–º–µ–Ω—Ç–∞ `LISTEN_START`

### 2. –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START (`_on_voice_mic_opened`)

- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ session_id**: –ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ `LISTEN_START` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è `session_id` –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è (`_active_listen_session_id`) –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ `_listen_start_in_progress`
- **–ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START**: –ï—Å–ª–∏ `voice.mic_opened` –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–æ–π –∂–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `LISTEN_START` **–≤—Å–µ–≥–¥–∞** –ø–æ–¥–∞–≤–ª—è–µ—Ç—Å—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞**: –§–ª–∞–≥ `_listen_start_in_progress` –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç race conditions, –∫–æ–≥–¥–∞ `voice.mic_opened` –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–°–±—Ä–æ—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**: –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –∏ —Ñ–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `voice.mic_closed` –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `_on_voice_mic_closed` (–∏–ª–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ suppression**: –ü—Ä–∏ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è `session_id` –∏ –ø—Ä–∏—á–∏–Ω–∞ (—Å–µ—Å—Å–∏—è —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ LISTEN_START –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª: `integration/integrations/signal_integration.py`

1. **–î–æ–±–∞–≤–ª–µ–Ω `import time`** –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
2. **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è**:
   ```python
   # –î–ª—è suppression ERROR —Å–∏–≥–Ω–∞–ª–∞
   self._last_listen_start_time: float = 0.0
   self._error_suppression_window_sec: float = 2.0  # 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ LISTEN_START
   
   # –î–ª—è suppression –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ session_id)
   self._active_listen_session_id: Optional[Any] = None
   self._listen_start_in_progress: bool = False  # –§–ª–∞–≥ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START
   ```

3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `voice.mic_closed`**:
   ```python
   await self.event_bus.subscribe("voice.mic_closed", self._on_voice_mic_closed, EventPriority.MEDIUM)
   ```

4. **–û–±–Ω–æ–≤–ª–µ–Ω `_on_voice_mic_opened`**:
   ```python
   # –ö–†–ò–¢–ò–ß–ù–û: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
   if sid is not None and sid == self._active_listen_session_id:
       logger.debug(f"Signals: LISTEN_START suppressed (session={sid} —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞)")
       return
   
   # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ LISTEN_START —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
   if self._listen_start_in_progress and sid == self._active_listen_session_id:
       logger.debug(f"Signals: LISTEN_START suppressed (—É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–ª—è session={sid})")
       return
   
   # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é
   self._listen_start_in_progress = True
   self._active_listen_session_id = sid
   self._last_listen_start_time = current_time
   
   await self._service.emit(...)
   
   # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–Ω–æ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è)
   self._listen_start_in_progress = False
   ```

5. **–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `_on_voice_mic_closed`**:
   ```python
   async def _on_voice_mic_closed(self, event: Dict[str, Any]):
       # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é –∏ —Ñ–ª–∞–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–∞ –∂–µ —Å–µ—Å—Å–∏—è
       if sid is not None and sid == self._active_listen_session_id:
           logger.debug(f"Signals: –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è {sid} –∑–∞–∫—Ä—ã—Ç–∞, —Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–æ–≤—ã–π LISTEN_START")
           self._active_listen_session_id = None
           self._listen_start_in_progress = False
       # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ç–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏
   ```

4. **–û–±–Ω–æ–≤–ª–µ–Ω `_on_error_like`**:
   ```python
   # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–¥–∞–≤–ª—è–µ–º ERROR —Å–∏–≥–Ω–∞–ª, –µ—Å–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª LISTEN_START
   current_time = time.time()
   time_since_listen_start = current_time - self._last_listen_start_time
   
   if time_since_listen_start < self._error_suppression_window_sec:
       logger.debug(
           f"Signals: ERROR suppressed (LISTEN_START –±—ã–ª {time_since_listen_start:.3f}s –Ω–∞–∑–∞–¥, "
           f"–æ–∫–Ω–æ suppression={self._error_suppression_window_sec}s)"
       )
       return
   ```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏:
- ‚úÖ `listen_start` —Å–∏–≥–Ω–∞–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ `voice.mic_opened` –¥–ª—è —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏ –ø–æ–¥–∞–≤–ª—è—é—Ç—Å—è)
- ‚úÖ `error` —Å–∏–≥–Ω–∞–ª **–ø–æ–¥–∞–≤–ª—è–µ—Ç—Å—è**, –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `listen_start`
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∏—Ç "–¥–≤–æ–π–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é" –Ω–∏ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `listen_start`, –Ω–∏ –æ—Ç `error` —Å–∏–≥–Ω–∞–ª–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ suppression –ø–æ–º–æ–≥–∞–µ—Ç –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ

## –û–∫–Ω–∞ suppression

### ERROR —Å–∏–≥–Ω–∞–ª

–û–∫–Ω–æ suppression —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ **2 —Å–µ–∫—É–Ω–¥—ã** (`_error_suppression_window_sec = 2.0`), —á—Ç–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
- LONG_PRESS ‚Üí –∞–∫—Ç–∏–≤–∞—Ü–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ ‚Üí `listen_start` –∑–≤—É–∫
- RELEASE ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Üí `recognition_failed` ‚Üí `error` –∑–≤—É–∫ (–ø–æ–¥–∞–≤–ª–µ–Ω)

–ï—Å–ª–∏ `error` –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–∑–∂–µ 2 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `listen_start`, –æ–Ω –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ gRPC –∑–∞–ø—Ä–æ—Å–∞).

### LISTEN_START —Å–∏–≥–Ω–∞–ª

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ session_id —á–µ—Ä–µ–∑ `_active_listen_session_id` –∏ `_listen_start_in_progress` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω** `listen_start` –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏:
- `voice.mic_opened` (session=123) ‚Üí `listen_start` –∑–≤—É–∫, `_active_listen_session_id = 123`, `_listen_start_in_progress = True` ‚Üí `False`
- `voice.mic_opened` (session=123) ‚Üí `listen_start` **–ø–æ–¥–∞–≤–ª–µ–Ω** (—Å–µ—Å—Å–∏—è —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞)
- `voice.mic_closed` (session=123) ‚Üí `_active_listen_session_id = None`, `_listen_start_in_progress = False` (—Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–æ–≤—ã–π `listen_start`)
- `voice.mic_opened` (session=456) ‚Üí `listen_start` –∑–≤—É–∫ (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è)

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –ø–æ—Å–ª–µ `voice.mic_closed` –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ (–∏–ª–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ), —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `listen_start` –¥–∞–∂–µ –µ—Å–ª–∏ `voice.mic_opened` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥. –§–ª–∞–≥ `_listen_start_in_progress` –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### –¢–µ—Å—Ç 1: –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ ERROR —Å–∏–≥–Ω–∞–ª–∞
1. –ù–∞–∂–º–∏—Ç–µ LONG_PRESS –∏ —Å—Ä–∞–∑—É –æ—Ç–ø—É—Å—Ç–∏—Ç–µ (–±–µ–∑ —Ä–µ—á–∏)
2. –î–æ–ª–∂–µ–Ω –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ `listen_start` –∑–≤—É–∫
3. `error` –∑–≤—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∞–≤–ª–µ–Ω
4. –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `Signals: ERROR suppressed (LISTEN_START –±—ã–ª X.XXXs –Ω–∞–∑–∞–¥, –æ–∫–Ω–æ suppression=2.0s)`

### –¢–µ—Å—Ç 2: –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LISTEN_START
1. –ù–∞–∂–º–∏—Ç–µ LONG_PRESS (–¥–æ–ª–∂–µ–Ω –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è `listen_start`)
2. –ï—Å–ª–∏ `voice.mic_opened` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏, –≤—Ç–æ—Ä–æ–π `listen_start` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∞–≤–ª–µ–Ω **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏**
3. –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `Signals: LISTEN_START suppressed (session=XXX —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –æ–∂–∏–¥–∞–µ–º voice.mic_closed –¥–ª—è —Å–±—Ä–æ—Å–∞)`
4. –ü–æ—Å–ª–µ `voice.mic_closed` –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏, –Ω–æ–≤—ã–π `listen_start` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–î–∞—Ç–∞**: 2024-01-XX  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–î–æ–±–∞–≤–ª–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ `modules/speech_playback/core/player.py`:

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
1. **–§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (`_output_monitor_loop`):
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `_query_system_default_output()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∏ PortAudio ID
   - SwitchAudioSource –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1), fallback –Ω–∞ PortAudio
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–¥ –∑–∞–º–∫–æ–º `_output_monitor_lock`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞** (`_switch_output_device`):
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `_stop_event` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
   - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ `_audio_stream` –ø–æ–¥ `_stream_lock`
   - –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `_playback_thread` (timeout 1.0 —Å–µ–∫)
   - –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ —á–µ—Ä–µ–∑ `chunk_buffer.clear_all()`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ `DeviceParamsNormalizer` (channels, sample_rate)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `chunk_buffer.set_channels()` –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞–Ω–∞–ª–æ–≤
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tracking –ø–æ–ª–µ–π (`output_device_name`, `_current_output_device_id`)
   - –°–±—Ä–æ—Å `_stop_event` –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
   - Lazy start –ø–æ—Ç–æ–∫–∞ (—Å–æ–∑–¥–∞—Å—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `add_audio_data()`)

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π**:
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞ (–µ—Å–ª–∏ `auto_output_device_switch=True`)
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown –ø–ª–µ–µ—Ä–∞
   - –°–æ–≤–º–µ—Å—Ç–∏–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ `add_audio_data()`
   - Event-–±–∞—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å `playback.signal`/`cancelled` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ü—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: `üîÑ [OUTPUT] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: "—Å—Ç–∞—Ä–æ–µ" (ID=old_id) ‚Üí "–Ω–æ–≤–æ–µ" (ID=new_id)`
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏: `‚úÖ [OUTPUT] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: "—Å—Ç–∞—Ä–æ–µ" (ID=old_id) ‚Üí "–Ω–æ–≤–æ–µ" (ID=new_id). –ü–æ—Ç–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö (lazy start)`
- –ü—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: `‚úÖ [OUTPUT] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã: rate=old_rateHz ‚Üí new_rateHz, channels=old_channels ‚Üí new_channels`

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –ü–æ–¥–∫–ª—é—á–∏—Ç—å Bluetooth-–Ω–∞—É—à–Ω–∏–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª –∏–º—è –∏ ID (–ª–æ–≥)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–æ—Å—å –∏ –¥–∞–ª—å—à–µ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –Ω–∞—É—à–Ω–∏–∫–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ event-–±–∞—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å `playback.signal`/`cancelled` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ü—Ä–æ–≥–Ω–∞—Ç—å `test_audio_output/prototype/current_system/test_current_system.py` –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∫–µ–π—Å–∞

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `integration/integrations/signal_integration.py` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è suppression –ª–æ–≥–∏–∫–∏
- `Docs/AUDIO_DEVICE_AUTO_PLAN.md` ‚Äî –ø–ª–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–æ–±–Ω–æ–≤–ª—ë–Ω —Å —Ñ–æ–Ω–æ–≤—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º output)

