# Различия между запуском через терминал и через .app bundle

## Почему проблема не возникала при запуске через терминал?

### 1. **Automatic Termination Support (TAL - Termination After Launch)**

**При запуске через терминал:**
- macOS **НЕ применяет** Automatic Termination Support к процессам, запущенным из терминала
- Терминал "держит" процесс, поэтому система считает, что процесс активен
- `applicationShouldTerminate` вызывается реже или не вызывается вообще

**При запуске через .app bundle:**
- macOS **применяет** Automatic Termination Support к приложениям без видимого окна
- Система может автоматически завершить приложение, если:
  - Нет активного UI (окна или menu bar icon)
  - `applicationShouldTerminate` возвращает `True`
  - Приложение не отвечает на события
- Это механизм энергосбережения macOS

### 2. **NSApplication Activation Policy**

**При запуске через терминал:**
- NSApplication может быть уже инициализирован Python интерпретатором
- Activation policy может быть установлен автоматически
- Приложение "привязано" к терминалу, что предотвращает завершение

**При запуске через .app bundle:**
- NSApplication создаётся "с нуля" в изолированном процессе
- Activation policy **ОБЯЗАТЕЛЬНО** должен быть установлен явно
- Без правильного activation policy приложение может быть завершено системой

### 3. **Обработка `applicationShouldTerminate`**

**При запуске через терминал:**
- `applicationShouldTerminate` может **не вызываться** вообще
- macOS не пытается завершить процесс, так как он "привязан" к терминалу
- Даже если метод возвращает `True`, процесс может продолжать работать

**При запуске через .app bundle:**
- `applicationShouldTerminate` **вызывается** системой при определённых условиях:
  - Когда нет активного UI
  - Когда система считает, что приложение "неактивно"
  - При попытке отобразить menu bar icon
- Если метод возвращает `True`, приложение **завершается немедленно**

### 4. **Отсутствие терминала как "якоря"**

**При запуске через терминал:**
- Терминал является "якорем" для процесса
- Процесс считается активным, пока терминал открыт
- macOS не завершает процессы, привязанные к терминалу

**При запуске через .app bundle:**
- Нет терминала, который "держит" процесс
- macOS может завершить приложение, если:
  - Нет активного UI
  - `applicationShouldTerminate` возвращает `True`
  - Приложение не отвечает на события

## Решение

### Что было исправлено:

1. **Изменён `applicationShouldTerminate` по умолчанию:**
   ```python
   # Было: return True  # ❌ Разрешает завершение
   # Стало: return False  # ✅ Предотвращает завершение
   ```

2. **Добавлен вызов `_setup_quit_handler()` перед `app.run()`:**
   - Это устанавливает кастомный обработчик, который всегда возвращает `False`
   - Предотвращает автоматическое завершение приложения

3. **Отключение Automatic Termination Support:**
   - В `main.py` уже есть код для отключения TAL:
     ```python
     process_info.disableAutomaticTermination_("Waiting for tray icon")
     ```
   - Это работает для .app bundle, но не критично для терминала

## Вывод

**Почему проблема не возникала при запуске через терминал:**
- macOS не применяет Automatic Termination Support к процессам из терминала
- Терминал "держит" процесс, предотвращая завершение
- `applicationShouldTerminate` может не вызываться вообще

**Почему проблема возникала при запуске через .app bundle:**
- macOS применяет Automatic Termination Support
- Нет терминала, который "держит" процесс
- `applicationShouldTerminate` вызывается системой и, возвращая `True`, завершал приложение

## Рекомендации

1. **Всегда устанавливайте `applicationShouldTerminate` возвращающим `False`** для menu bar приложений
2. **Вызывайте `_setup_quit_handler()` перед `app.run()`** для установки кастомного обработчика
3. **Отключайте Automatic Termination Support** при запуске (уже реализовано в `main.py`)
4. **Тестируйте приложение в обоих режимах** (терминал и .app bundle)

## Связанные документы

- `Docs/TRAY_TERMINATION_FIX.md` - описание исправления
- `Docs/APP_BUNDLE_EXIT_ISSUE.md` - другие проблемы с .app bundle




