# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –∞—É–¥–∏–æ

**–î–∞—Ç–∞:** 2025-12-02  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê—É–¥–∏–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, —Ö–æ—Ç—è –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –±—É—Ñ–µ—Ä

## –°–∏–º–ø—Ç–æ–º—ã

1. ‚úÖ –ê—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ (253440 —Å—ç–º–ø–ª–æ–≤, 5.28 —Å–µ–∫—É–Ω–¥)
2. ‚úÖ –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω –∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
3. ‚úÖ –ß–∞–Ω–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±—É—Ñ–µ—Ä (chunk_0_1764697908626, size: 253440)
4. ‚ùå **–ù–û**: Callback `_audio_callback` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è PortAudio
5. ‚ùå –°–æ–±—ã—Ç–∏–µ `playback.completed` –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
6. ‚ùå –ê—É–¥–∏–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê**: –í `modules/speech_playback/core/player.py` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `StreamConfig` –¥–ª—è `AudioStreamManager` callback —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –∫–∞–∫ `None` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ `_audio_callback`.

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞

1. **–°—Ç—Ä–æ–∫–∞ 989** (–º–µ—Ç–æ–¥ `_start_audio_stream`):
   ```python
   callback=None,  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è
   ```

2. **–°—Ç—Ä–æ–∫–∞ 2070** (–º–µ—Ç–æ–¥ `_build_stream_config_for_output_device`):
   ```python
   callback=None,  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è
   ```

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ

PortAudio (`sd.OutputStream`) —Ç—Ä–µ–±—É–µ—Ç callback –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ç–æ–∫. –ë–µ–∑ callback:
- –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ü–æ—Ç–æ–∫ —Å—Ç–∞—Ä—Ç—É–µ—Ç —É—Å–ø–µ—à–Ω–æ
- **–ù–û**: PortAudio –Ω–µ –∑–Ω–∞–µ—Ç, –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
- Callback `_audio_callback` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –ë—É—Ñ–µ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è

## –†–µ—à–µ–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: `_start_audio_stream`

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–µ—Ä–µ–º callback –∏–∑ stream_config
stream_config_obj = StreamConfig(
    ...
    callback=stream_config.get('callback'),  # ‚úÖ Callback –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ _get_stream_config()
    ...
)
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: `_build_stream_config_for_output_device`

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–µ—Ä–µ–º callback –∏–∑ safe_config –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º _audio_callback
return StreamConfig(
    ...
    callback=safe_config.get('callback', self._audio_callback),
    ...
)
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
1. WelcomeMessageIntegration
   ‚îî‚îÄ> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ gRPC
   ‚îî‚îÄ> –ü—É–±–ª–∏–∫—É–µ—Ç playback.raw_audio

2. SpeechPlaybackIntegration._on_raw_audio()
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç player.start_playback()
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç player.add_audio_data()

3. SequentialSpeechPlayer.start_playback()
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç _start_audio_stream()
   ‚îî‚îÄ> –ó–∞–ø—É—Å–∫–∞–µ—Ç _playback_loop() –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ

4. SequentialSpeechPlayer._start_audio_stream()
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç _get_stream_config() ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å callback=_audio_callback
   ‚îî‚îÄ> –°–æ–∑–¥–∞–µ—Ç StreamConfig(callback=stream_config.get('callback')) ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç AudioStreamManager.create_stream(stream_config_obj)

5. AudioStreamManager.create_stream()
   ‚îî‚îÄ> –í—ã–∑—ã–≤–∞–µ—Ç _prepare_stream_params(config)
   ‚îî‚îÄ> –°–æ–∑–¥–∞–µ—Ç sd.OutputStream(callback=config.callback) ‚úÖ –¢–µ–ø–µ—Ä—å callback –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

6. PortAudio (sd.OutputStream)
   ‚îî‚îÄ> –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç callback=_audio_callback ‚úÖ –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚îî‚îÄ> _audio_callback –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ chunk_buffer.get_playback_data()
   ‚îî‚îÄ> –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ outdata

7. SequentialSpeechPlayer._playback_loop()
   ‚îî‚îÄ> –ü–æ–ª—É—á–∞–µ—Ç —á–∞–Ω–∫–∏ –∏–∑ chunk_buffer.get_next_chunk()
   ‚îî‚îÄ> –î–æ–±–∞–≤–ª—è–µ—Ç –≤ –±—É—Ñ–µ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ chunk_buffer.add_to_playback_buffer()
   ‚îî‚îÄ> –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ _wait_for_chunk_completion()
   ‚îî‚îÄ> –ü—É–±–ª–∏–∫—É–µ—Ç playback.completed –∫–æ–≥–¥–∞ –≤—Å–µ —á–∞–Ω–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω—ã
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

1. ‚úÖ –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å callback
2. ‚úÖ PortAudio –≤—ã–∑—ã–≤–∞–µ—Ç `_audio_callback` –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
3. ‚úÖ –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è `üéµ [CALLBACK #N]` (–ø–µ—Ä–≤—ã–µ 10 –≤—ã–∑–æ–≤–æ–≤)
4. ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ø–æ—Ç–æ–∫
5. ‚úÖ –ê—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
6. ‚úÖ –°–æ–±—ã—Ç–∏–µ `playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `modules/speech_playback/core/player.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- `modules/audio_core/stream_manager.py` - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ—Ç–æ–∫–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- `modules/speech_playback/core/stream_config_resolver.py` - resolver –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

## –£—Ä–æ–∫–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–µ—Ä–µ–¥–∞—á—É callback** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PortAudio –ø–æ—Ç–æ–∫–æ–≤
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ callback –≤—ã–∑–æ–≤–æ–≤** –ø–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
3. **–ü–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ**, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ callback
4. **–ë—É—Ñ–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω**, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –±–µ–∑ callback

