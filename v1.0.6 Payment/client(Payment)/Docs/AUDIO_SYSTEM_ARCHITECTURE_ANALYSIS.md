# ะะฝะฐะปะธะท ะฐััะธัะตะบัััั ะฐัะดะธะพ ัะธััะตะผั Nexy

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-12-02  
**ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต:** 2025-12-02  
**ะกัะฐััั:** ะะบััะฐะปัะฝัะน ะฐะฝะฐะปะธะท ัะตะบััะตะณะพ ัะพััะพัะฝะธั

## ะกะพะดะตัะถะฐะฝะธะต

1. [ะะฑัะฐั ะฐััะธัะตะบัััะฐ](#1-ะพะฑัะฐั-ะฐััะธัะตะบัััะฐ)
2. [INPUT ะฟะพะดัะธััะตะผะฐ (ะะฐัะฒะฐั ัะตัะธ)](#2-input-ะฟะพะดัะธััะตะผะฐ-ะทะฐัะฒะฐั-ัะตัะธ)
3. [OUTPUT ะฟะพะดัะธััะตะผะฐ (ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต)](#3-output-ะฟะพะดัะธััะตะผะฐ-ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต)
4. [ะะพะฝะธัะพัะธะฝะณ ััััะพะนััะฒ](#4-ะผะพะฝะธัะพัะธะฝะณ-ััััะพะนััะฒ)
5. [ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะพัะพะบะฐะผะธ (AudioStreamManager)](#5-ัะฟัะฐะฒะปะตะฝะธะต-ะฟะพัะพะบะฐะผะธ-audiostreammanager)
6. [ะัะพะฑะปะตะผั ะธ ัะทะบะธะต ะผะตััะฐ](#6-ะฟัะพะฑะปะตะผั-ะธ-ัะทะบะธะต-ะผะตััะฐ)
7. [ะะธะฐะณัะฐะผะผั ะฟะพัะพะบะพะฒ](#7-ะดะธะฐะณัะฐะผะผั-ะฟะพัะพะบะพะฒ)
8. [ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะปัััะตะฝะธั](#8-ัะตะบะพะผะตะฝะดะฐัะธะธ-ะฟะพ-ัะปัััะตะฝะธั)
9. [ะะฐะบะปััะตะฝะธะต](#9-ะทะฐะบะปััะตะฝะธะต)
10. [ะะปะฐะฝ ัะตัะฐะบัะพัะธะฝะณะฐ ะฐัะดะธะพ-ัะธััะตะผั](#10-ะฟะปะฐะฝ-ัะตัะฐะบัะพัะธะฝะณะฐ-ะฐัะดะธะพ-ัะธััะตะผั)

---

## 1. ะะฑัะฐั ะฐััะธัะตะบัััะฐ

### 1.1 ะัะธะฝัะธะฟั

**ะกะพะฑััะธะนะฝะฐั ะฐััะธัะตะบัััะฐ (EventBus):**
- ะัะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ัะตัะตะท `EventBus` (ัะปะฐะฑะฐั ัะฒัะทะฐะฝะฝะพััั)
- ะะพะผะฟะพะฝะตะฝัั ะฟัะฑะปะธะบััั/ะฟะพะดะฟะธััะฒะฐัััั ะฝะฐ ัะพะฑััะธั
- ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ (async/await)
- ะัะธะพัะธัะตัั ัะพะฑััะธะน (CRITICAL, HIGH, MEDIUM, LOW)

**ะะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ:**
- **ะะพะดัะปะธ** (`modules/`) - ะฝะธะทะบะพััะพะฒะฝะตะฒะฐั ะปะพะณะธะบะฐ (PortAudio, Core Audio)
- **ะะฝัะตะณัะฐัะธะธ** (`integration/integrations/`) - ะฐะดะฐะฟัะตัั ะผะตะถะดั ะผะพะดัะปัะผะธ ะธ EventBus
- **Workflows** (`integration/workflows/`) - ะบะพะพัะดะธะฝะฐัะพัั ัะปะพะถะฝัั ัะตะฟะพัะตะบ
- **Core** (`integration/core/`) - ะธะฝััะฐััััะบัััะฐ (EventBus, StateManager, ErrorHandler)

**ะะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั:**
- `ApplicationStateManager` - ัะพััะพัะฝะธะต ะฟัะธะปะพะถะตะฝะธั
- `session_id` - ะธะท `state_manager.get_current_session_id()`
- `AppMode` - ัะตัะตะท `state_manager.set_mode()`

### 1.2 ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    EventBus (ะฆะตะฝััะฐะปัะฝะฐั ัะธะฝะฐ)              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
        โโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโ
        โ                   โ                   โ
        โผ                   โผ                   โผ
โโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโ
โ   INPUT       โ   โ   OUTPUT     โ   โ   DEVICE      โ
โ   ะะพะดัะธััะตะผะฐ  โ   โ   ะะพะดัะธััะตะผะฐ  โ   โ   ะะพะฝะธัะพัะธะฝะณ  โ
โโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโ
```

---

## 2. INPUT ะฟะพะดัะธััะตะผะฐ (ะะฐัะฒะฐั ัะตัะธ)

### 2.1 ะะพะผะฟะพะฝะตะฝัั

#### 2.1.1 InputProcessingIntegration
**ะคะฐะนะป:** `integration/integrations/input_processing_integration.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะฑัะฐะฑะพัะบะฐ ัะพะฑััะธะน ะบะปะฐะฒะธะฐัััั (PRESS, LONG_PRESS, RELEASE, SHORT_PRESS)
- ะฃะฟัะฐะฒะปะตะฝะธะต ัะพััะพัะฝะธะตะผ (InputState: IDLE โ PENDING โ LISTENING โ PROCESSING)
- ะัะฑะปะธะบะฐัะธั `voice.recording_start` / `voice.recording_stop`

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `_handle_press()` - ะพะฑัะฐะฑะพัะบะฐ ะฝะฐะถะฐัะธั (IDLE โ PENDING)
- `_handle_long_press()` - ะพะฑัะฐะฑะพัะบะฐ ะดะปะธะฝะฝะพะณะพ ะฝะฐะถะฐัะธั (PENDING โ LISTENING)
- `_handle_key_release()` - ะพะฑัะฐะฑะพัะบะฐ ะพัะฟััะบะฐะฝะธั (LISTENING โ PROCESSING)
- `_can_start_recording()` - ะฟัะพะฒะตัะบะฐ ะณะพัะพะฒะฝะพััะธ ะบ ะทะฐะฟะธัะธ

**ะัะพะฑะปะตะผั:**
- โ๏ธ **Race condition**: LONG_PRESS ะผะพะถะตั ะฟัะธะนัะธ ะฟะพัะปะต RELEASE, ะฟัะพะฒะตัะบะฐ `key_pressed` ะฒะพะทะฒัะฐัะฐะตั `False`
- โ๏ธ **ะขะฐะนะผะฐััั**: `_ensure_playback_idle()` (0.5s) ะธ `_wait_for_mic_closed()` (1.0s) ะผะพะณัั ะฑััั ะฝะตะดะพััะฐัะพัะฝัะผะธ
- โ๏ธ **ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั**: `_can_start_recording()` ะฟัะพะฒะตััะตั `keyboard_monitor.key_pressed`, ะฝะพ ัะพััะพัะฝะธะต ะผะพะถะตั ะธะทะผะตะฝะธัััั ะผะตะถะดั LONG_PRESS ะธ ะฟัะพะฒะตัะบะพะน

#### 2.1.2 VoiceRecognitionIntegration
**ะคะฐะนะป:** `integration/integrations/voice_recognition_integration.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะพะพัะดะธะฝะฐัะธั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั ัะตัะธ
- ะฃะฟัะฐะฒะปะตะฝะธะต ะผะธะบัะพัะพะฝะพะผ ัะตัะตะท `MicrophoneStateManager`
- ะะฐะฑะพัะฐ ั `SpeechRecognizer`

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `_on_recording_start()` - ะฝะฐัะฐะปะพ ะทะฐะฟะธัะธ
- `_on_recording_stop()` - ะบะพะฝะตั ะทะฐะฟะธัะธ
- `_on_input_device_changed()` - ะพะฑัะฐะฑะพัะบะฐ ัะผะตะฝั INPUT ััััะพะนััะฒะฐ

**ะกะพะฑััะธั:**
- ะัะฑะปะธะบัะตั: `voice.recognition_started`, `voice.recognition_completed`, `voice.recognition_failed`
- ะะพะดะฟะธััะฒะฐะตััั: `voice.recording_start`, `voice.recording_stop`, `device.default_input_changed`

#### 2.1.3 SpeechRecognizer
**ะคะฐะนะป:** `modules/voice_recognition/core/speech_recognizer.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะธะทะบะพััะพะฒะฝะตะฒะฐั ัะฐะฑะพัะฐ ั PortAudio
- ะกะพะทะดะฐะฝะธะต/ัะฟัะฐะฒะปะตะฝะธะต PortAudio ัััะธะผะฐะผะธ ัะตัะตะท `AudioStreamManager`
- ะะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ ัะฐะฝะบะพะฒ ัะตัะตะท `_audio_callback`

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `start_listening()` - ะทะฐะฟััะบ ะทะฐะฟะธัะธ
- `stop_listening()` - ะพััะฐะฝะพะฒะบะฐ ะทะฐะฟะธัะธ
- `on_device_changed()` - ะฟะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒะฐ

**ะัะพะฑะตะฝะฝะพััะธ:**
- โ ะัะฟะพะปัะทัะตั `AudioStreamManager` ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะฟะพัะพะบะฐะผะธ
- โ ะะพะดะฟะธัะฐะฝ ะฝะฐ `device.default_input_changed` ะพั `DeviceChangePublisher`
- โ ะกะฟะตัะธะฐะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ BT ััััะพะนััะฒ (ัะฒะตะปะธัะตะฝะฝัะต ะทะฐะดะตัะถะบะธ)

#### 2.1.4 MicrophoneStateManager
**ะคะฐะนะป:** `modules/microphone_state/core/microphone_state_manager.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะฃะฟัะฐะฒะปะตะฝะธะต ัะพััะพัะฝะธะตะผ ะผะธะบัะพัะพะฝะฐ (IDLE, OPENING, OPEN, CLOSING)
- ะะพะพัะดะธะฝะฐัะธั ะพัะบัััะธั/ะทะฐะบัััะธั ะผะธะบัะพัะพะฝะฐ
- ะัะฑะปะธะบะฐัะธั ัะพะฑััะธะน `microphone.opened/closed/error`

### 2.2 ะะพัะพะบ INPUT (ะพั ะฝะฐะถะฐัะธั ะดะพ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั)

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั Ctrl+N (PRESS)
   โโ InputProcessingIntegration._handle_press()
      โโ ะกะพะทะดะฐะตั pending_session_id = timestamp
      โโ ะะตัะตัะพะด: IDLE โ PENDING
      โโ ะัะฑะปะธะบัะตั: keyboard.press

2. ะะพะปัะทะพะฒะฐัะตะปั ัะดะตัะถะธะฒะฐะตั Ctrl+N > 0.6s (LONG_PRESS)
   โโ InputProcessingIntegration._handle_long_press()
      โโ ะัะพะฒะตัะบะธ (_can_start_recording):
      โ   โโ _input_state == PENDING?
      โ   โโ _pending_session_id != None?
      โ   โโ keyboard_monitor.key_pressed? โ๏ธ RACE CONDITION
      โ   โโ state_manager.is_microphone_active()?
      โ
      โโ ะะถะธะดะฐะฝะธั:
      โ   โโ _ensure_playback_idle() (ัะฐะนะผะฐัั 0.5s)
      โ   โโ _wait_for_mic_closed() (ัะฐะนะผะฐัั 1.0s)
      โ
      โโ ะัะฑะปะธะบัะตั: voice.recording_start{session_id}
         โโ ะะตัะตัะพะด: PENDING โ LISTENING

3. VoiceRecognitionIntegration ะฟะพะปััะฐะตั voice.recording_start
   โโ VoiceRecognitionIntegration._on_recording_start()
      โโ MicrophoneStateManager.request_open(session_id)
      โ   โโ ะะตัะตัะพะด: IDLE โ OPENING
      โ   โโ ะัะฑะปะธะบัะตั: microphone.open_requested
      โ
      โโ SpeechRecognizer.start_listening()
         โโ AudioStreamManager.create_stream(StreamConfig)
         โ   โโ ะะฐะบััะฒะฐะตั ััะฐััะน ะฟะพัะพะบ (ะตัะปะธ ะตััั)
         โ   โโ ะกะพะทะดะฐะตั ะฝะพะฒัะน PortAudio InputStream
         โ   โโ ะะพะทะฒัะฐัะฐะตั StreamOperationResult
         โ
         โโ ะัะฑะปะธะบัะตั: microphone.opened
         โโ ะัะฑะปะธะบัะตั: voice.mic_opened

4. SpeechRecognizer._audio_callback ะฟะพะปััะฐะตั ะฐัะดะธะพ ัะฐะฝะบะธ
   โโ ะะพะปััะฐะตั ะฐัะดะธะพ ะดะฐะฝะฝัะต ะธะท PortAudio
   โโ ะะฑัะฐะฑะฐััะฒะฐะตั (ะฝะพัะผะฐะปะธะทะฐัะธั, VAD)
   โโ ะกะพััะฐะฝัะตั ะฒ ะฑััะตั ะดะปั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั

5. ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟััะบะฐะตั Ctrl+N (RELEASE)
   โโ InputProcessingIntegration._handle_key_release()
      โโ ะัะฑะปะธะบัะตั: voice.recording_stop{session_id}
      โโ _wait_for_mic_closed() (ัะฐะนะผะฐัั 1.0s)

6. VoiceRecognitionIntegration ะฟะพะปััะฐะตั voice.recording_stop
   โโ VoiceRecognitionIntegration._on_recording_stop()
      โโ SpeechRecognizer.stop_listening()
      โ   โโ AudioStreamManager.close_stream()
      โ   โโ ะัะฑะปะธะบัะตั: microphone.closed
      โ
      โโ ะะฐะฟััะบะฐะตั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต
         โโ ะัะฑะปะธะบัะตั: voice.recognition_completed{session_id, text}
            โโ ะะตัะตัะพะด: LISTENING โ PROCESSING
```

### 2.3 ะัะพะฑะปะตะผั INPUT ะฟะพะดัะธััะตะผั

#### ะัะพะฑะปะตะผะฐ 1: Race condition ะผะตะถะดั LONG_PRESS ะธ RELEASE
**ะะฟะธัะฐะฝะธะต:**
- LONG_PRESS ััะฐะฑะฐััะฒะฐะตั ัะตัะตะท 0.6s ะฟะพัะปะต PRESS
- RELEASE ะผะพะถะตั ะฟัะธะนัะธ ัะฐะฝััะต ะธะปะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ั LONG_PRESS
- ะัะพะฒะตัะบะฐ `keyboard_monitor.key_pressed` ะฒ `_can_start_recording()` ะฒะพะทะฒัะฐัะฐะตั `False`
- ะะตะทัะปััะฐั: ะทะฐะฟะธัั ะฝะต ะฝะฐัะธะฝะฐะตััั, ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั "ะทะฐะฒะธัะฐะฝะธะต"

**ะะพะณะธ:**
```
โ๏ธ LONG_PRESS: ะฝะตะปัะทั ะฝะฐัะฐัั ะทะฐะฟะธัั - key_not_pressed
```

**ะัะธัะธะฝะฐ:**
- ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะพะฑััะธะน
- ะะตั ะฐัะพะผะฐัะฝะพะน ะฟัะพะฒะตัะบะธ ัะพััะพัะฝะธั ะบะปะฐะฒะธัะธ
- ะกะพััะพัะฝะธะต `key_pressed` ะผะพะถะตั ะธะทะผะตะฝะธัััั ะผะตะถะดั LONG_PRESS ะธ ะฟัะพะฒะตัะบะพะน

**ะะตัะตะฝะธะต (ะฟัะตะดะปะฐะณะฐะตะผะพะต):**
- ะัะพะผะฐัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะบะปะฐะฒะธัะธ ะฒ `_can_start_recording()`
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต `asyncio.Lock` ะดะปั ะทะฐัะธัั ะบัะธัะธัะตัะบะพะน ัะตะบัะธะธ
- ะัะพะฒะตัะบะฐ `_pending_recording_cancelled_event` ะฟะตัะตะด ะฟัะฑะปะธะบะฐัะธะตะน `voice.recording_start`

#### ะัะพะฑะปะตะผะฐ 2: ะขะฐะนะผะฐััั ะพะถะธะดะฐะฝะธั
**ะะฟะธัะฐะฝะธะต:**
- `_ensure_playback_idle()` - ัะฐะนะผะฐัั 0.5s (ะผะพะถะตั ะฑััั ะฝะตะดะพััะฐัะพัะฝัะผ)
- `_wait_for_mic_closed()` - ัะฐะนะผะฐัั 1.0s (ะผะพะถะตั ะฑััั ะฝะตะดะพััะฐัะพัะฝัะผ)
- ะัะธ ัะฐะนะผะฐััะต ะฟัะธะฝัะดะธัะตะปัะฝะพ ัะฑัะฐััะฒะฐะตััั ัะพััะพัะฝะธะต, ะฝะพ ััะพ ะผะพะถะตั ะฟัะธะฒะตััะธ ะบ ะฟะพัะตัะต ะดะฐะฝะฝัั

**ะะตัะตะฝะธะต (ะฟัะตะดะปะฐะณะฐะตะผะพะต):**
- ะฃะฒะตะปะธัะธัั ัะฐะนะผะฐััั ะดะปั BT ััััะพะนััะฒ
- ะะพะฑะฐะฒะธัั ะฐะดะฐะฟัะธะฒะฝัะต ัะฐะนะผะฐััั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ ััััะพะนััะฒะฐ
- ะฃะปัััะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ัะฐะนะผะฐััะพะฒ

---

## 3. OUTPUT ะฟะพะดัะธััะตะผะฐ (ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต)

### 3.1 ะะพะผะฟะพะฝะตะฝัั

#### 3.1.1 SpeechPlaybackIntegration
**ะคะฐะนะป:** `integration/integrations/speech_playback_integration.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะพะพัะดะธะฝะฐัะธั ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั ะฐัะดะธะพ ะพัะฒะตัะพะฒ
- ะะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ ัะฐะฝะบะพะฒ ะพั gRPC ัะตัะฒะตัะฐ
- ะฃะฟัะฐะฒะปะตะฝะธะต `SequentialSpeechPlayer`

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `_on_audio_chunk()` - ะพะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ ัะฐะฝะบะฐ
- `_on_output_device_changed()` - ะพะฑัะฐะฑะพัะบะฐ ัะผะตะฝั OUTPUT ััััะพะนััะฒะฐ
- `_on_unified_interrupt()` - ะพะฑัะฐะฑะพัะบะฐ ะฟัะตััะฒะฐะฝะธั

**ะกะพะฑััะธั:**
- ะัะฑะปะธะบัะตั: `playback.started`, `playback.completed`, `playback.failed`
- ะะพะดะฟะธััะฒะฐะตััั: `grpc.response.audio`, `device.default_output_changed`, `playback.cancelled`

#### 3.1.2 SequentialSpeechPlayer
**ะคะฐะนะป:** `modules/speech_playback/core/player.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะธะทะบะพััะพะฒะฝะตะฒะฐั ัะฐะฑะพัะฐ ั PortAudio ะดะปั ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั
- ะกะพะทะดะฐะฝะธะต/ัะฟัะฐะฒะปะตะฝะธะต PortAudio ัััะธะผะฐะผะธ ัะตัะตะท `AudioStreamManager`
- ะะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ ัะฐะฝะบะพะฒ ัะตัะตะท `_audio_callback`
- ะฃะฟัะฐะฒะปะตะฝะธะต ะฑััะตัะพะผ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั (`ChunkBuffer`)

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `_start_audio_stream()` - ะทะฐะฟััะบ ะฟะพัะพะบะฐ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั
- `_stop_audio_stream()` - ะพััะฐะฝะพะฒะบะฐ ะฟะพัะพะบะฐ
- `_switch_output_device()` - ะฟะตัะตะบะปััะตะฝะธะต OUTPUT ััััะพะนััะฒะฐ
- `_audio_callback()` - callback ะดะปั PortAudio

**ะัะพะฑะตะฝะฝะพััะธ:**
- โ ะัะฟะพะปัะทัะตั `AudioStreamManager` ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะฟะพัะพะบะฐะผะธ
- โ ะะพะดะฟะธัะฐะฝ ะฝะฐ `device.default_output_changed` ะพั `DeviceChangePublisher`
- โ ะกะฟะตัะธะฐะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ BT ััััะพะนััะฒ (device=None, ัะฒะตะปะธัะตะฝะฝัะต ะทะฐะดะตัะถะบะธ)
- โ **ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ** ะฟะตัะตะด ะฟะตัะตะบะปััะตะฝะธะตะผ ััััะพะนััะฒะฐ (2025-12-02)
- โ **ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน** (`_switch_sequence_counter`) ะดะปั ะฐัะดะธัะฐ
- โ **Guard ะทะฐัะธัะฐ** (`_switch_in_progress`) ะพั concurrent ะฟะตัะตะบะปััะตะฝะธะน
- โ **ะัั ััะฟะตัะฝัั ะบะพะฝัะธะณััะฐัะธะน** (`_last_successful_config`) ะดะปั ะฑััััะพะณะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั
- โ๏ธ **Lazy start** - ะฟะพัะพะบ ัะพะทะดะฐะตััั ะฟัะธ ะฟะตัะฒะพะผ ัะฐะฝะบะต (ะผะพะถะตั ะทะฐะดะตัะถะฐัั ะฝะฐัะฐะปะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั)

### 3.2 ะะพัะพะบ OUTPUT (ะพั gRPC ะพัะฒะตัะฐ ะดะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั)

```
1. GrpcClientIntegration ะฟะพะปััะฐะตั ะฐัะดะธะพ ัะฐะฝะบ ะพั ัะตัะฒะตัะฐ
   โโ GrpcClientIntegration._on_audio_chunk()
      โโ ะัะฑะปะธะบัะตั: grpc.response.audio{bytes, session_id}

2. SpeechPlaybackIntegration ะฟะพะปััะฐะตั grpc.response.audio
   โโ SpeechPlaybackIntegration._on_audio_chunk()
      โโ ะะตะบะพะดะธััะตั ะฐัะดะธะพ (WAV header skip, ะบะพะฝะฒะตััะฐัะธั)
      โโ SequentialSpeechPlayer.add_audio_data(audio_data, session_id)

3. SequentialSpeechPlayer.add_audio_data()
   โโ ะัะพะฒะตััะตั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะฟะปะตะตัะฐ
   โโ ะะพะฑะฐะฒะปัะตั ัะฐะฝะบ ะฒ ChunkBuffer
   โโ ะัะปะธ ะฟะพัะพะบ ะฝะต ัะพะทะดะฐะฝ โ _start_audio_stream()
      โโ AudioStreamManager.create_stream(StreamConfig)
      โ   โโ ะะฐะบััะฒะฐะตั ััะฐััะน ะฟะพัะพะบ (ะตัะปะธ ะตััั)
      โ   โโ ะกะพะทะดะฐะตั ะฝะพะฒัะน PortAudio OutputStream
      โ   โโ ะะพะทะฒัะฐัะฐะตั StreamOperationResult
      โ
      โโ ะะฐะฟััะบะฐะตั playback thread

4. SequentialSpeechPlayer._audio_callback (ะฒัะทัะฒะฐะตััั PortAudio)
   โโ ะะพะปััะฐะตั ะดะฐะฝะฝัะต ะธะท ChunkBuffer
   โโ ะะพะฝะฒะตััะธััะตั ัะพัะผะฐั (ะตัะปะธ ะฝัะถะฝะพ)
   โโ ะะฐะฟะธััะฒะฐะตั ะฒ outdata (PortAudio)

5. ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะทะฐะฒะตััะฐะตััั
   โโ SequentialSpeechPlayer._on_playback_completed()
      โโ ะัะฑะปะธะบัะตั: playback.completed{session_id}
      โโ ะััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟะพัะพะบ ัะตัะตะท AudioStreamManager
```

### 3.3 ะัะพะฑะปะตะผั OUTPUT ะฟะพะดัะธััะตะผั

#### ะัะพะฑะปะตะผะฐ 1: ะขะฐะนะผะฐัั switch_device (15+ ัะตะบัะฝะด) โ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- `_switch_output_device()` ะฒัะทัะฒะฐะป `AudioStreamManager.switch_device()`
- ะะฟะตัะฐัะธั ะฒัะฟะพะปะฝัะปะฐัั ะฒ ะพัะดะตะปัะฝะพะผ thread ัะตัะตะท `_run_async_in_thread()`
- ะขะฐะนะผะฐัั: 15s ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ, 30s ะดะปั BT
- ะัะธ ะพัะธะฑะบะต PortAudio (-9986, -10851) ะพะฟะตัะฐัะธั ะผะพะณะปะฐ ะทะฐะฝััั 15+ ัะตะบัะฝะด

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะฃะผะตะฝััะตะฝ ัะฐะนะผะฐัั ะดะปั switch_device: **5s ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ, 10s ะดะปั BT**
- โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ: **2 ะฒะผะตััะพ 5**
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
- โ ะะพะฑะฐะฒะปะตะฝะฐ ะฟัะพะฒะตัะบะฐ `_audio_stream == None` ะฟะพัะปะต ะทะฐะบัััะธั
- โ ะัะตะณะดะฐ ะธัะฟะพะปัะทัะตััั `create_stream()` ะฒะผะตััะพ `switch_device()` (ััะฐััะน ะฟะพัะพะบ ัะถะต ะทะฐะบััั)

**ะขะตะบััะตะต ัะพััะพัะฝะธะต:**
- ะขะฐะนะผะฐััั: 5s (ะพะฑััะฝัะต), 10s (BT)
- ะะพะฟััะบะธ: 2 (ะฒะผะตััะพ 5)
- ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ะฟะตัะตะบะปััะตะฝะธะตะผ

#### ะัะพะฑะปะตะผะฐ 2: ะัะธะฑะบะธ PortAudio ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะฐ โ ะงะะกะขะะงะะ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะงะฐััะธัะฝะพ ะธัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะัะธะฑะบะธ -9986 (Internal PortAudio error) ะธ -10851 (Audio Unit: Invalid Property Value)
- ะงะฐััะพ ะฒะพะทะฝะธะบะฐัั ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ััััะพะนััะฒ ะธะปะธ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะฐ ะฝะฐ BT ััััะพะนััะฒะฐั

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะัะฟะพะปัะทัะตััั ะบัั ะฑะตะทะพะฟะฐัะฝัั ะบะพะฝัะธะณััะฐัะธะน (`_last_successful_config`)
- โ ะะปั BT ััััะพะนััะฒ ะฒัะตะณะดะฐ ะธัะฟะพะปัะทัะตััั `device=None` (macOS ัะฟัะฐะฒะปัะตั ะฟะฐัะฐะผะตััะฐะผะธ)
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ (ััััะฐะฝัะตั "ััััะพะนััะฒะพ ะทะฐะฝััะพ")
- โ Fallback ะฝะฐ `device=None` ะฟัะธ ะพัะธะฑะบะฐั -9986/-10851

**ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- โ๏ธ ะัะธะฑะบะธ -10851 ะฒัะต ะตัะต ะผะพะณัั ะฒะพะทะฝะธะบะฐัั ะฝะฐ BT ััััะพะนััะฒะฐั (ััะตะฑัะตั ะดะฐะปัะฝะตะนัะตะณะพ ะธััะปะตะดะพะฒะฐะฝะธั)
- โ๏ธ Retry ะปะพะณะธะบะฐ ะผะพะถะตั ะทะฐะฝััั ะฒัะตะผั ะดะฐะถะต ั 2 ะฟะพะฟััะบะฐะผะธ

**ะะพะณะธ (ะฟะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั):**
```
โ [OUTPUT][seq=123] close_stream ะทะฐะฒะตัััะฝ ััะฟะตัะฝะพ
โ [OUTPUT] ะะพะดัะฒะตัะถะดะตะฝะธะต: ััะฐััะน ะฟะพัะพะบ ะฟะพะปะฝะพัััั ะทะฐะบััั (_audio_stream=None)
๐ [OUTPUT][seq=123] ะกะพะทะดะฐะตะผ ะฝะพะฒัะน ะฟะพัะพะบ ัะตัะตะท AudioStreamManager.create_stream
```

#### ะัะพะฑะปะตะผะฐ 3: Lazy start ะฟะพัะพะบะฐ
**ะะฟะธัะฐะฝะธะต:**
- ะะพัะพะบ ัะพะทะดะฐะตััั ะฟัะธ ะฟะตัะฒะพะผ ัะฐะฝะบะต (`add_audio_data()`)
- ะกะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะผะพะถะตั ะทะฐะฝััั ะฒัะตะผั (ะพัะพะฑะตะฝะฝะพ ะฟัะธ ะพัะธะฑะบะฐั)
- ะะตะทัะปััะฐั: ะทะฐะดะตัะถะบะฐ ะฝะฐัะฐะปะฐ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั

**ะะตัะตะฝะธะต (ะฟัะตะดะปะฐะณะฐะตะผะพะต):**
- ะัะตะดะฒะฐัะธัะตะปัะฝะพะต ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะปะตะตัะฐ
- ะะปะธ ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะฟัะธ ะฟะตัะฒะพะผ `grpc.response.audio` (ะดะพ ะดะตะบะพะดะธัะพะฒะฐะฝะธั)

---

## 4. ะะพะฝะธัะพัะธะฝะณ ััััะพะนััะฒ

### 4.1 DeviceChangePublisher
**ะคะฐะนะป:** `modules/audio_core/device_change_publisher.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะดะธะฝัะน ะผะพะฝะธัะพัะธะฝะณ INPUT ะธ OUTPUT ััััะพะนััะฒ
- ะะพะดะฟะธัะบะฐ ะฝะฐ Core Audio ะฝะพัะธัะธะบะฐัะธะธ (ะฟัะธะพัะธัะตั 1)
- Fallback ะฝะฐ polling ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ Core Audio
- ะัะฑะปะธะบะฐัะธั ัะพะฑััะธะน ะฒ EventBus

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `start_monitoring()` - ะทะฐะฟััะบ ะผะพะฝะธัะพัะธะฝะณะฐ
- `_on_input_device_changed_core_audio()` - callback ะดะปั INPUT ะฝะพัะธัะธะบะฐัะธะน
- `_on_output_device_changed_core_audio()` - callback ะดะปั OUTPUT ะฝะพัะธัะธะบะฐัะธะน
- `_polling_loop()` - fallback polling ัะธะบะป

**ะัะพะฑะตะฝะฝะพััะธ:**
- โ ะัะฟะพะปัะทัะตั CoreAudioManager ะดะปั ะฟะพะดะฟะธัะบะธ ะฝะฐ ะฝะพัะธัะธะบะฐัะธะธ
- โ ะัะธ ััะฟะตัะฝะพะน ะฟะพะดะฟะธัะบะต ะพัะบะปััะฐะตััั polling fallback
- โ Debounce ะผะตัะฐะฝะธะทะผ (300ms) ะดะปั rapid device switch
- โ ะััะธัะพะฒะฐะฝะธะต ะธะผะตะฝ ััััะพะนััะฒ (TTL 0.5s) ะดะปั ัะผะตะฝััะตะฝะธั ะฒัะทะพะฒะพะฒ SwitchAudioSource

### 4.2 DeviceChangePublisherIntegration
**ะคะฐะนะป:** `integration/integrations/device_change_publisher_integration.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะฝะธัะธะฐะปะธะทะฐัะธั ะธ ะทะฐะฟััะบ DeviceChangePublisher
- ะะพะพัะดะธะฝะฐัะธั ะผะพะฝะธัะพัะธะฝะณะฐ INPUT/OUTPUT ััััะพะนััะฒ

### 4.3 ะะพัะพะบ ะผะพะฝะธัะพัะธะฝะณะฐ ััััะพะนััะฒ

```
1. DeviceChangePublisher.start_monitoring()
   โโ ะะฝะธัะธะฐะปะธะทะฐัะธั ัะตะบััะธั ััััะพะนััะฒ
   โโ ะะพะฟััะบะฐ ะฟะพะดะฟะธัะบะธ ะฝะฐ Core Audio ะฝะพัะธัะธะบะฐัะธะธ
   โ   โโ ะฃัะฟะตั โ ะพัะบะปััะฐะตััั polling
   โ   โโ ะัะธะฑะบะฐ โ ะทะฐะฟััะบะฐะตััั polling fallback
   โ
   โโ ะัะฑะปะธะบัะตั: device.monitoring_started

2. Core Audio ะฝะพัะธัะธะบะฐัะธั (ะตัะปะธ ะดะพัััะฟะฝะฐ)
   โโ CoreAudioManager callback
      โโ DeviceChangePublisher._on_input_device_changed_core_audio()
      โ   โโ _handle_device_change("input", new_device, CORE_AUDIO)
      โ
      โโ DeviceChangePublisher._on_output_device_changed_core_audio()
         โโ _handle_device_change("output", new_device, CORE_AUDIO)

3. Polling fallback (ะตัะปะธ Core Audio ะฝะตะดะพัััะฟะตะฝ)
   โโ DeviceChangePublisher._polling_loop()
      โโ ะัะพะฒะตัะบะฐ INPUT ััััะพะนััะฒะฐ (ะธะฝัะตัะฒะฐะป 1.0s ะธะปะธ 5.0s ะดะปั BT)
      โโ ะัะพะฒะตัะบะฐ OUTPUT ััััะพะนััะฒะฐ (ะธะฝัะตัะฒะฐะป 1.0s ะธะปะธ 5.0s ะดะปั BT)
      โโ ะัะธ ะธะทะผะตะฝะตะฝะธะธ โ _handle_device_change(..., POLLING)

4. _handle_device_change() (ั debounce 300ms)
   โโ ะัะฑะปะธะบัะตั: device.default_input_changed / device.default_output_changed
      โโ VoiceRecognitionIntegration._on_input_device_changed()
      โ   โโ SpeechRecognizer.on_device_changed()
      โ
      โโ SpeechPlaybackIntegration._on_output_device_changed()
         โโ SequentialSpeechPlayer._switch_output_device()
```

### 4.4 ะัะพะฑะปะตะผั ะผะพะฝะธัะพัะธะฝะณะฐ ััััะพะนััะฒ

#### ะัะพะฑะปะตะผะฐ 1: ะะปะพะบะธััััะธะต ะฒัะทะพะฒั SwitchAudioSource โ ะงะะกะขะะงะะ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะงะฐััะธัะฝะพ ะธัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- `_get_device_name_via_macos_api()` ะฒัะทัะฒะฐะตั `subprocess.run()` ั ัะฐะนะผะฐััะพะผ 1s
- ะัะธ ัะฐะนะผะฐััะต ะธะปะธ ะพัะธะฑะบะต ะผะพะถะตั ะฑะปะพะบะธัะพะฒะฐัั ะฟะพัะพะบ
- ะััะธัะพะฒะฐะฝะธะต (TTL 0.5s) ะฟะพะผะพะณะฐะตั, ะฝะพ ะฝะต ัะตัะฐะตั ะฟัะพะฑะปะตะผั ะฟะพะปะฝะพัััั

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource ัะตัะตะท `asyncio.to_thread` ะฒ `_check_and_update_output_device()`
- โ ะััะธัะพะฒะฐะฝะธะต ะธะผะตะฝ ััััะพะนััะฒ (TTL 0.5s) ะดะปั ัะผะตะฝััะตะฝะธั ะฒัะทะพะฒะพะฒ
- โ ะัะพะฒะตัะบะฐ `_device_check_in_progress` ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั concurrent ะฒัะทะพะฒะพะฒ

**ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- โ๏ธ ะขะฐะนะผะฐัั ะฒัะต ะตัะต 1s (ะผะพะถะฝะพ ัะผะตะฝััะธัั ะดะพ 0.5s)
- โ๏ธ ะ ะฝะตะบะพัะพััั ะผะตััะฐั ะฒัะต ะตัะต ะธัะฟะพะปัะทัะตััั ัะธะฝััะพะฝะฝัะน `subprocess.run()`

#### ะัะพะฑะปะตะผะฐ 2: Race conditions ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ััััะพะนััะฒ โ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒะฐ ะผะพะณะปะพ ะฟัะพะธะทะพะนัะธ ะฒะพ ะฒัะตะผั ะฐะบัะธะฒะฝะพะน ะทะฐะฟะธัะธ/ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั
- ะกัะฐััะน ะฟะพัะพะบ ะผะพะณ ะฝะต ััะฟะตัั ะพััะฐะฝะพะฒะธัััั ะดะพ ัะพะทะดะฐะฝะธั ะฝะพะฒะพะณะพ
- ะะตะทัะปััะฐั: ะพัะธะฑะบะธ PortAudio, ะฟะพัะตัั ะดะฐะฝะฝัั

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ **Guard ะทะฐัะธัะฐ** (`_switch_in_progress`) ะฟัะตะดะพัะฒัะฐัะฐะตั concurrent ะฟะตัะตะบะปััะตะฝะธั
- โ **ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ** ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ ัะตัะตะท `_stop_audio_stream()`
- โ **ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะฟะพัะพะบะฐ** (`_audio_stream == None`) ะฟะพัะปะต ะทะฐะบัััะธั
- โ **ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน** (`_switch_sequence_counter`) ะดะปั ะฐัะดะธัะฐ
- โ ะขะฐะนะผะฐัั guard (10s) ะทะฐัะธัะฐะตั ะพั ะทะฐะปะธะฟะฐะฝะธั

---

## 5. ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะพัะพะบะฐะผะธ (AudioStreamManager)

### 5.1 AudioStreamManager
**ะคะฐะนะป:** `modules/audio_core/stream_manager.py`

**ะัะฒะตัััะฒะตะฝะฝะพััั:**
- ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
- Lock ะดะปั ะทะฐัะธัั ะพั concurrent ะพะฟะตัะฐัะธะน
- ะะถะธะดะฐะฝะธะต `active=False` ะฟะตัะตะด ะทะฐะบัััะธะตะผ ะฟะพัะพะบะฐ
- ะะดะฐะฟัะธะฒะฝัะต ะทะฐะดะตัะถะบะธ (2.5ั ะดะปั BT, 0.3ั ะดะปั ะพะฑััะฝัั)
- Retry ะปะพะณะธะบะฐ ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะผ backoff
- ะกะฟะตัะธะฐะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ -9986/-10851

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `create_stream()` - ัะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ ะฟะพัะพะบะฐ
- `close_stream()` - ะทะฐะบัััะธะต ะฟะพัะพะบะฐ
- `switch_device()` - ะฟะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒะฐ (ะทะฐะบัััะธะต ััะฐัะพะณะพ + ัะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ)

**ะะพะฝัะธะณััะฐัะธั:**
- `_close_delay_bt = 2.5` ัะตะบัะฝะด ะดะปั BT ััััะพะนััะฒ
- `_close_delay_normal = 0.3` ัะตะบัะฝะด ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ
- `_max_wait_active_bt = 3.0` ัะตะบัะฝะด ะดะปั BT ััััะพะนััะฒ
- `_max_wait_active_normal = 1.0` ัะตะบัะฝะด ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ
- `_max_retries = 2` ะฟะพะฟััะพะบ (ัะผะตะฝััะตะฝะพ ั 5, 2025-12-02)
- `_base_retry_delay = 0.5` ัะตะบัะฝะด

**ะฃะปัััะตะฝะธั (2025-12-02):**
- โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ ั 5 ะดะพ 2 ะดะปั ะฑััััะพะณะพ fallback
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ ะฒ `_switch_output_device()`
- โ ะฃะปัััะตะฝะพ ะปะพะณะธัะพะฒะฐะฝะธะต ั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพัััะผะธ ะฟะตัะตะบะปััะตะฝะธะน

### 5.2 ะะพัะพะบ ัะพะทะดะฐะฝะธั ะฟะพัะพะบะฐ

```
1. create_stream(StreamConfig)
   โโ ะะฐัะฒะฐั lock (_lock)
   โโ ะะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ (ะตัะปะธ ะตััั)
   โ   โโ _close_stream_safe(old_stream, is_bluetooth)
   โ       โโ ะััะฐะฝะพะฒะบะฐ ะฟะพัะพะบะฐ (stream.stop())
   โ       โโ ะะถะธะดะฐะฝะธะต active=False (ัะฐะนะผะฐัั 3.0s ะดะปั BT, 1.0s ะดะปั ะพะฑััะฝัั)
   โ       โโ ะะฐะบัััะธะต ะฟะพัะพะบะฐ (stream.close())
   โ       โโ ะะฐะดะตัะถะบะฐ ะฟะพัะปะต ะทะฐะบัััะธั (2.5s ะดะปั BT, 0.3s ะดะปั ะพะฑััะฝัั)
   โ
   โโ ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ ะฟะพัะพะบะฐ (retry ะดะพ 2 ะฟะพะฟััะพะบ)
      โโ ะะพะดะณะพัะพะฒะบะฐ ะฟะฐัะฐะผะตััะพะฒ (_prepare_stream_params)
      โโ ะกะพะทะดะฐะฝะธะต PortAudio ะฟะพัะพะบะฐ (sd.InputStream/OutputStream)
      โโ ะัะธ ะพัะธะฑะบะต -9986/-10851:
      โ   โโ ะฃะฒะตะปะธัะตะฝะฝะฐั ะทะฐะดะตัะถะบะฐ ะฟะตัะตะด retry (ร2 ะดะปั BT)
      โ   โโ ะะพะฒัะพัะฝะฐั ะฟะพะฟััะบะฐ
      โ
      โโ ะะพะทะฒัะฐั StreamOperationResult
```

### 5.3 ะัะพะฑะปะตะผั AudioStreamManager

#### ะัะพะฑะปะตะผะฐ 1: ะะพะปะณะพะต ะพะถะธะดะฐะฝะธะต ะทะฐะบัััะธั ะฟะพัะพะบะฐ โ ะงะะกะขะะงะะ ะะะจะะะ
**ะกัะฐััั:** โ ะงะฐััะธัะฝะพ ัะตัะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะะถะธะดะฐะฝะธะต `active=False` ะผะพะถะตั ะทะฐะฝััั ะดะพ 3.0s ะดะปั BT ััััะพะนััะฒ
- ะะฐะดะตัะถะบะฐ ะฟะพัะปะต `close()` - 2.5s ะดะปั BT ััััะพะนััะฒ
- ะะฑัะตะต ะฒัะตะผั ะทะฐะบัััะธั: ะดะพ 5.5s ะดะปั BT ััััะพะนััะฒ

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ะฟะตัะตะบะปััะตะฝะธะตะผ ะฒ `_switch_output_device()`
- โ ะฃะปัััะตะฝะพ ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะตะผะตะฝะธ ะทะฐะบัััะธั ั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพัััะผะธ
- โ ะัะพะฒะตัะบะฐ `_audio_stream == None` ะฟะพัะปะต ะทะฐะบัััะธั

**ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- โ๏ธ ะะฐะดะตัะถะบะธ ะฒัะต ะตัะต ะฑะพะปััะธะต ะดะปั BT ััััะพะนััะฒ (2.5s ะฟะพัะปะต close)
- โ๏ธ ะะถะธะดะฐะฝะธะต `active=False` ะผะพะถะตั ะทะฐะฝััั ะดะพ 3.0s ะดะปั BT

#### ะัะพะฑะปะตะผะฐ 2: Retry ะปะพะณะธะบะฐ ะผะพะถะตั ะทะฐะฝััั ะผะฝะพะณะพ ะฒัะตะผะตะฝะธ โ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- 5 ะฟะพะฟััะพะบ ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะผ backoff
- ะะปั BT ััััะพะนััะฒ ะทะฐะดะตัะถะบะฐ ัะดะฒะฐะธะฒะฐะตััั
- ะะฐะบัะธะผะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ: 0.5s ร 2^4 ร 2 = 16s (ะดะปั BT ะฝะฐ 5-ะน ะฟะพะฟััะบะต)

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ: **2 ะฒะผะตััะพ 5**
- โ ะฃะผะตะฝััะตะฝั ัะฐะนะผะฐััั: **5s ะดะปั ะพะฑััะฝัั, 10s ะดะปั BT** (ะฒะผะตััะพ 15s/30s)
- โ ะัััััะน fallback ะฝะฐ `device=None` ะฟัะธ ะพัะธะฑะบะฐั -9986/-10851
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ ััััะฐะฝัะตั ะผะฝะพะณะธะต ะพัะธะฑะบะธ

---

## 6. ะัะพะฑะปะตะผั ะธ ัะทะบะธะต ะผะตััะฐ

### 6.1 ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั

#### ะัะพะฑะปะตะผะฐ 1: ะะฐะฒะธัะฐะฝะธะต ะฟัะธ ะทะฐะถะฐัะธะธ ะบะปะฐะฒะธัะธ โ๏ธ ะงะะกะขะะงะะ ะะะจะะะ
**ะกัะฐััั:** โ๏ธ ะงะฐััะธัะฝะพ ัะตัะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะถะธะผะฐะตั Ctrl+N, ะฝะพ ะฝะธัะตะณะพ ะฝะต ะฟัะพะธััะพะดะธั
- ะ ะปะพะณะฐั: "โ๏ธ LONG_PRESS: ะฝะตะปัะทั ะฝะฐัะฐัั ะทะฐะฟะธัั - key_not_pressed"
- ะะปะธ: "โ [OUTPUT] ะขะฐะนะผะฐัั switch_device (15.0ั)"

**ะัะธัะธะฝั:**
1. **Race condition**: LONG_PRESS ะฟัะธัะพะดะธั ะฟะพัะปะต RELEASE, ะฟัะพะฒะตัะบะฐ `key_pressed` ะฒะพะทะฒัะฐัะฐะตั `False` โ๏ธ ะะ ะะกะะะะะะะะ
2. **ะขะฐะนะผะฐัั switch_device**: ะฟะตัะตะบะปััะตะฝะธะต OUTPUT ััััะพะนััะฒะฐ ะทะฐะฝะธะผะฐะปะพ 15+ ัะตะบัะฝะด โ ะะกะะะะะะะะ
3. **ะัะธะฑะบะธ PortAudio**: ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะฝะต ัะดะฐะฒะฐะปะพัั ะฟะพัะปะต 5 ะฟะพะฟััะพะบ โ ะะกะะะะะะะะ

**ะะตัะตะฝะธะต:**
- โ ะฃะผะตะฝััะตะฝ ัะฐะนะผะฐัั ะดะปั switch_device (5s ะดะปั ะพะฑััะฝัั, 10s ะดะปั BT)
- โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ (2 ะฒะผะตััะพ 5)
- โ๏ธ ะัะพะผะฐัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะบะปะฐะฒะธัะธ ะฒ `_can_start_recording()` - ะะ ะะะะะะะะะะะ

#### ะัะพะฑะปะตะผะฐ 2: ะัะธะฑะบะธ PortAudio ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะฐ โ ะงะะกะขะะงะะ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะงะฐััะธัะฝะพ ะธัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะัะธะฑะบะธ -9986 (Internal PortAudio error) ะธ -10851 (Audio Unit: Invalid Property Value)
- ะงะฐััะพ ะฒะพะทะฝะธะบะฐัั ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ััััะพะนััะฒ ะธะปะธ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะฐ ะฝะฐ BT ััััะพะนััะฒะฐั

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะัะฟะพะปัะทัะตััั ะบัั ะฑะตะทะพะฟะฐัะฝัั ะบะพะฝัะธะณััะฐัะธะน (`_last_successful_config`)
- โ ะะปั BT ััััะพะนััะฒ ะฒัะตะณะดะฐ ะธัะฟะพะปัะทัะตััั `device=None` (macOS ัะฟัะฐะฒะปัะตั ะฟะฐัะฐะผะตััะฐะผะธ)
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ (ััััะฐะฝัะตั "ััััะพะนััะฒะพ ะทะฐะฝััะพ")
- โ Fallback ะฝะฐ `device=None` ะฟัะธ ะพัะธะฑะบะฐั -9986/-10851

**ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- โ๏ธ ะัะธะฑะบะธ -10851 ะฒัะต ะตัะต ะผะพะณัั ะฒะพะทะฝะธะบะฐัั ะฝะฐ BT ััััะพะนััะฒะฐั (ััะตะฑัะตั ะดะฐะปัะฝะตะนัะตะณะพ ะธััะปะตะดะพะฒะฐะฝะธั)

#### ะัะพะฑะปะตะผะฐ 3: ะะพะปะณะพะต ะฟะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒ โ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะะตัะตะบะปััะตะฝะธะต OUTPUT ััััะพะนััะฒะฐ ะทะฐะฝะธะผะฐะปะพ 15+ ัะตะบัะฝะด
- ะะปะพะบะธัะพะฒะฐะปะพ ะพัะฝะพะฒะฝะพะน ะฟะพัะพะบ ัะตัะตะท `_run_async_in_thread()`

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะฃะผะตะฝััะตะฝ ัะฐะนะผะฐัั ะดะปั switch_device: **5s ะดะปั ะพะฑััะฝัั, 10s ะดะปั BT**
- โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ: **2 ะฒะผะตััะพ 5**
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ััะฐัะพะณะพ ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
- โ ะัะตะณะดะฐ ะธัะฟะพะปัะทัะตััั `create_stream()` ะฒะผะตััะพ `switch_device()` (ััะฐััะน ะฟะพัะพะบ ัะถะต ะทะฐะบััั)

### 6.2 ะัะพะฑะปะตะผั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

#### ะัะพะฑะปะตะผะฐ 1: Lazy start ะฟะพัะพะบะฐ OUTPUT
**ะะฟะธัะฐะฝะธะต:**
- ะะพัะพะบ ัะพะทะดะฐะตััั ะฟัะธ ะฟะตัะฒะพะผ ัะฐะฝะบะต (`add_audio_data()`)
- ะกะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะผะพะถะตั ะทะฐะฝััั ะฒัะตะผั (ะพัะพะฑะตะฝะฝะพ ะฟัะธ ะพัะธะฑะบะฐั)
- ะะตะทัะปััะฐั: ะทะฐะดะตัะถะบะฐ ะฝะฐัะฐะปะฐ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั

**ะะตัะตะฝะธะต:**
- ะัะตะดะฒะฐัะธัะตะปัะฝะพะต ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะปะตะตัะฐ
- ะะปะธ ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะฐ ะฟัะธ ะฟะตัะฒะพะผ `grpc.response.audio` (ะดะพ ะดะตะบะพะดะธัะพะฒะฐะฝะธั)

#### ะัะพะฑะปะตะผะฐ 2: ะะปะพะบะธััััะธะต ะฒัะทะพะฒั SwitchAudioSource โ ะงะะกะขะะงะะ ะะกะะะะะะะะ
**ะะฟะธัะฐะฝะธะต:**
- `_get_device_name_via_macos_api()` ะฒัะทัะฒะฐะตั `subprocess.run()` ั ัะฐะนะผะฐััะพะผ 1s
- ะัะธ ัะฐะนะผะฐััะต ะธะปะธ ะพัะธะฑะบะต ะผะพะถะตั ะฑะปะพะบะธัะพะฒะฐัั ะฟะพัะพะบ

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ ะัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource ัะตัะตะท `asyncio.to_thread` ะฒ `_check_and_update_output_device()`
- โ ะััะธัะพะฒะฐะฝะธะต ะธะผะตะฝ ััััะพะนััะฒ (TTL 0.5s) ะดะปั ัะผะตะฝััะตะฝะธั ะฒัะทะพะฒะพะฒ

**ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- โ๏ธ ะขะฐะนะผะฐัั ะฒัะต ะตัะต 1s (ะผะพะถะฝะพ ัะผะตะฝััะธัั ะดะพ 0.5s)
- โ๏ธ ะ ะฝะตะบะพัะพััั ะผะตััะฐั ะฒัะต ะตัะต ะธัะฟะพะปัะทัะตััั ัะธะฝััะพะฝะฝัะน `subprocess.run()`

### 6.3 ะัะพะฑะปะตะผั ะฝะฐะดะตะถะฝะพััะธ

#### ะัะพะฑะปะตะผะฐ 1: Race conditions ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ััััะพะนััะฒ โ ะะกะะะะะะะะ
**ะกัะฐััั:** โ ะัะฟัะฐะฒะปะตะฝะพ (2025-12-02)

**ะะฟะธัะฐะฝะธะต:**
- ะะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒะฐ ะผะพะณะปะพ ะฟัะพะธะทะพะนัะธ ะฒะพ ะฒัะตะผั ะฐะบัะธะฒะฝะพะน ะทะฐะฟะธัะธ/ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั
- ะกัะฐััะน ะฟะพัะพะบ ะผะพะณ ะฝะต ััะฟะตัั ะพััะฐะฝะพะฒะธัััั ะดะพ ัะพะทะดะฐะฝะธั ะฝะพะฒะพะณะพ

**ะะตัะตะฝะธะต (ัะตะฐะปะธะทะพะฒะฐะฝะพ):**
- โ Guard ะทะฐัะธัะฐ (`_switch_in_progress`) ะฟัะตะดะพัะฒัะฐัะฐะตั concurrent ะฟะตัะตะบะปััะตะฝะธั
- โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
- โ ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
- โ ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน ะดะปั ะฐัะดะธัะฐ

#### ะัะพะฑะปะตะผะฐ 2: ะะตะดะพััะฐัะพัะฝัะต ัะฐะนะผะฐััั ะพะถะธะดะฐะฝะธั
**ะะฟะธัะฐะฝะธะต:**
- `_ensure_playback_idle()` - ัะฐะนะผะฐัั 0.5s (ะผะพะถะตั ะฑััั ะฝะตะดะพััะฐัะพัะฝัะผ)
- `_wait_for_mic_closed()` - ัะฐะนะผะฐัั 1.0s (ะผะพะถะตั ะฑััั ะฝะตะดะพััะฐัะพัะฝัะผ)

**ะะตัะตะฝะธะต (ะฟัะตะดะปะฐะณะฐะตะผะพะต):**
- ะฃะฒะตะปะธัะธัั ัะฐะนะผะฐััั ะดะปั BT ััััะพะนััะฒ
- ะะพะฑะฐะฒะธัั ะฐะดะฐะฟัะธะฒะฝัะต ัะฐะนะผะฐััั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ ััััะพะนััะฒะฐ
- ะฃะปัััะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ัะฐะนะผะฐััะพะฒ

---

## 7. ะะธะฐะณัะฐะผะผั ะฟะพัะพะบะพะฒ

### 7.1 ะะพะปะฝัะน ัะธะบะป INPUT (ะพั ะฝะฐะถะฐัะธั ะดะพ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั)

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั Ctrl+N
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ InputProcessing         โ
โ _handle_press()         โ
โ IDLE โ PENDING          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ keyboard.press
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะพะปัะทะพะฒะฐัะตะปั ัะดะตัะถะธะฒะฐะตั โ
โ Ctrl+N > 0.6s          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ InputProcessing         โ
โ _handle_long_press()    โ
โ ะัะพะฒะตัะบะธ:               โ
โ - _input_state == PENDINGโ
โ - key_pressed? โ๏ธ RACE  โ
โ - mic_active?           โ
โ PENDING โ LISTENING     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ voice.recording_start
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ VoiceRecognition        โ
โ _on_recording_start()   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ microphone.open_requested
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ MicrophoneStateManager  โ
โ request_open()          โ
โ IDLE โ OPENING          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ SpeechRecognizer.start_listening()
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudioStreamManager      โ
โ create_stream()         โ
โ - ะะฐะบััะฒะฐะตั ััะฐััะน ะฟะพัะพะบโ
โ - ะกะพะทะดะฐะตั ะฝะพะฒัะน ะฟะพัะพะบ   โ
โ - Retry ะฟัะธ ะพัะธะฑะบะฐั     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ microphone.opened
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SpeechRecognizer        โ
โ _audio_callback()      โ
โ ะะฐัะฒะฐั ะฐัะดะธะพ            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟััะบะฐะตั Ctrl+N
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ InputProcessing         โ
โ _handle_key_release()   โ
โ voice.recording_stop    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ voice.recording_stop
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ VoiceRecognition        โ
โ _on_recording_stop()    โ
โ - ะััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟะพัะพะบ   โ
โ - ะะฐะฟััะบะฐะตั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะตโ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ voice.recognition_completed
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ LISTENING โ PROCESSING  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 7.2 ะะพะปะฝัะน ัะธะบะป OUTPUT (ะพั gRPC ะดะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั)

```
gRPC ัะตัะฒะตั ะพัะฟัะฐะฒะปัะตั ะฐัะดะธะพ ัะฐะฝะบ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ GrpcClientIntegration  โ
โ _on_audio_chunk()       โ
โ grpc.response.audio     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ grpc.response.audio
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SpeechPlayback          โ
โ _on_audio_chunk()       โ
โ - ะะตะบะพะดะธััะตั ะฐัะดะธะพ      โ
โ - add_audio_data()      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ ะัะปะธ ะฟะพัะพะบ ะฝะต ัะพะทะดะฐะฝ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SequentialSpeechPlayer โ
โ _start_audio_stream()   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ AudioStreamManager.create_stream()
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudioStreamManager      โ
โ create_stream()         โ
โ - ะะฐะบััะฒะฐะตั ััะฐััะน ะฟะพัะพะบโ
โ - ะกะพะทะดะฐะตั ะฝะพะฒัะน ะฟะพัะพะบ   โ
โ - Retry ะฟัะธ ะพัะธะฑะบะฐั     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ PortAudio OutputStream
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SequentialSpeechPlayer โ
โ _audio_callback()      โ
โ - ะะพะปััะฐะตั ะธะท ะฑััะตัะฐ    โ
โ - ะะฐะฟะธััะฒะฐะตั ะฒ outdata  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะทะฐะฒะตััะตะฝะพ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ playback.completed      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 7.3 ะะตัะตะบะปััะตะฝะธะต OUTPUT ััััะพะนััะฒะฐ โ ะะะะะะะะะ

```
DeviceChangePublisher ะพะฑะฝะฐััะถะธะฒะฐะตั ัะผะตะฝั ััััะพะนััะฒะฐ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ DeviceChangePublisher  โ
โ _on_output_device_     โ
โ changed_core_audio()   โ
โ device.default_output_ โ
โ changed                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ device.default_output_changed
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SpeechPlayback          โ
โ _on_output_device_     โ
โ changed()               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ _switch_output_device()
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SequentialSpeechPlayer โ
โ _switch_output_device() โ
โ [seq=123]               โ
โ - Guard ะทะฐัะธัะฐ          โ
โ - ะััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟะพัะพะบ   โ
โ - โ ะะฐะบััะฒะฐะตั ััะฐััะน   โ
โ   ะฟะพัะพะบ ัะตัะตะท           โ
โ   _stop_audio_stream()  โ
โ - ะัะพะฒะตัะบะฐ _audio_streamโ
โ   == None               โ
โ - ะัะธัะฐะตั ะฑััะตั         โ
โ - ะกะพะทะดะฐะตั ะฝะพะฒัะน ะฟะพัะพะบ   โ
โ   ัะตัะตะท create_stream() โ
โ   (ัะฐะนะผะฐัั 5s/10s) โ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ AudioStreamManager.create_stream()
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudioStreamManager      โ
โ create_stream()         โ
โ - ะกัะฐััะน ะฟะพัะพะบ ัะถะต      โ
โ   ะทะฐะบััั โ             โ
โ - ะกะพะทะดะฐะตั ะฝะพะฒัะน ะฟะพัะพะบ   โ
โ   (retry ะดะพ 2 ะฟะพะฟััะพะบ) โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ ะฃัะฟะตั ะธะปะธ ัะฐะนะผะฐัั
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะพัะพะบ ะฟะตัะตะบะปััะตะฝ        โ
โ (ะธะปะธ ะพัะธะฑะบะฐ)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 8. ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะปัััะตะฝะธั

### 8.1 ะัะธัะธัะตัะบะธะต ะธัะฟัะฐะฒะปะตะฝะธั

1. **ะัะฟัะฐะฒะธัั race condition ะฒ LONG_PRESS** โ๏ธ ะ ะะะะฆะะกะกะ
   - ะัะพะผะฐัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะบะปะฐะฒะธัะธ
   - ะัะฟะพะปัะทะพะฒะฐะฝะธะต `asyncio.Lock` ะดะปั ะทะฐัะธัั ะบัะธัะธัะตัะบะพะน ัะตะบัะธะธ
   - ะัะพะฒะตัะบะฐ `_pending_recording_cancelled_event` ะฟะตัะตะด ะฟัะฑะปะธะบะฐัะธะตะน

2. **ะฃะผะตะฝััะธัั ัะฐะนะผะฐัั switch_device** โ ะะซะะะะะะะ (2025-12-02)
   - โ 5s ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ (ะฒะผะตััะพ 15s)
   - โ 10s ะดะปั BT ััััะพะนััะฒ (ะฒะผะตััะพ 30s)
   - โ ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ (2 ะฒะผะตััะพ 5)

3. **ะฃะปัััะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ PortAudio** โ ะะซะะะะะะะ (2025-12-02)
   - โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
   - โ ะัะฟะพะปัะทัะตััั ะบัั ะฑะตะทะพะฟะฐัะฝัั ะบะพะฝัะธะณััะฐัะธะน (`_last_successful_config`)
   - โ ะะปั BT ััััะพะนััะฒ ะฒัะตะณะดะฐ ะธัะฟะพะปัะทัะตััั device=None
   - โ Fallback ะฝะฐ device=None ะฟัะธ ะพัะธะฑะบะฐั -9986/-10851

### 8.2 ะฃะปัััะตะฝะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

1. **ะัะตะดะฒะฐัะธัะตะปัะฝะพะต ัะพะทะดะฐะฝะธะต OUTPUT ะฟะพัะพะบะฐ** โ๏ธ ะะ ะะะะะะะะะะะ
   - ะกะพะทะดะฐะฒะฐัั ะฟะพัะพะบ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะปะตะตัะฐ
   - ะะปะธ ะฟัะธ ะฟะตัะฒะพะผ `grpc.response.audio` (ะดะพ ะดะตะบะพะดะธัะพะฒะฐะฝะธั)

2. **ะัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource** โ ะงะะกะขะะงะะ ะะซะะะะะะะ (2025-12-02)
   - โ ะัะฟะพะปัะทัะตััั `asyncio.to_thread` ะฒ `_check_and_update_output_device()`
   - โ๏ธ ะ ะฝะตะบะพัะพััั ะผะตััะฐั ะฒัะต ะตัะต ะธัะฟะพะปัะทัะตััั ัะธะฝััะพะฝะฝัะน `subprocess.run()`
   - โ๏ธ ะขะฐะนะผะฐัั ะฒัะต ะตัะต 1s (ะผะพะถะฝะพ ัะผะตะฝััะธัั ะดะพ 0.5s)

3. **ะฃะปัััะธัั ะบััะธัะพะฒะฐะฝะธะต ััััะพะนััะฒ** โ ะะซะะะะะะะ (2025-12-02)
   - โ ะััะธัะพะฒะฐะฝะธะต ะธะผะตะฝ ััััะพะนััะฒ (TTL 0.5s) ะฒ DeviceChangePublisher
   - โ ะัั ััะฟะตัะฝัั ะบะพะฝัะธะณััะฐัะธะน (`_last_successful_config`) ะฒ SequentialSpeechPlayer

### 8.3 ะฃะปัััะตะฝะธั ะฝะฐะดะตะถะฝะพััะธ

1. **ะะพะฑะฐะฒะธัั ัะพััะพัะฝะธะต "SWITCHING"** โ ะะซะะะะะะะ (2025-12-02)
   - โ Guard ะทะฐัะธัะฐ (`_switch_in_progress`) ะฟัะตะดะพัะฒัะฐัะฐะตั concurrent ะฟะตัะตะบะปััะตะฝะธั
   - โ ะขะฐะนะผะฐัั guard (10s) ะทะฐัะธัะฐะตั ะพั ะทะฐะปะธะฟะฐะฝะธั
   - โ ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน (`_switch_sequence_counter`) ะดะปั ะฐัะดะธัะฐ

2. **ะะดะฐะฟัะธะฒะฝัะต ัะฐะนะผะฐััั** โ ะะซะะะะะะะ (2025-12-02)
   - โ ะฃะฒะตะปะธัะตะฝั ัะฐะนะผะฐััั ะดะปั BT ััััะพะนััะฒ (10s ะฒะผะตััะพ 5s)
   - โ ะฃะผะตะฝััะตะฝั ัะฐะนะผะฐััั ะดะปั ะพะฑััะฝัั ััััะพะนััะฒ (5s ะฒะผะตััะพ 15s)
   - โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ัะฐะนะผะฐััะพะฒ ั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพัััะผะธ

3. **ะฃะปัััะธัั ะปะพะณะธัะพะฒะฐะฝะธะต** โ ะะซะะะะะะะ (2025-12-02)
   - โ ะะตััะธะบะธ ะฒัะตะผะตะฝะธ ะพะฟะตัะฐัะธะน (`_switch_device_times`)
   - โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพัะธะฑะพะบ PortAudio ั ะบะพะฝัะตะบััะพะผ
   - โ Decision-ะปะพะณะธ ะดะปั ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ ะฒ ะบะฐะฝะพะฝะธัะตัะบะพะผ ัะพัะผะฐัะต
   - โ ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน (`seq=123`) ะดะปั ะฐัะดะธัะฐ

### 8.4 ะฃะฟัะฐะฒะปะตะฝะธะต ััััะพะนััะฒะฐะผะธ (ัะตะบััะธะน ะฟะพะดัะพะด)

**ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ:**
- **SwitchAudioSource** (subprocess) - ะพัะฝะพะฒะฝะพะน ะธััะพัะฝะธะบ ะธััะธะฝั ะดะปั ะธะผะตะฝะธ ััััะพะนััะฒะฐ
- **PortAudio** (sounddevice) - ัะพะทะดะฐะฝะธะต ะฟะพัะพะบะพะฒ ะธ ะฟะพะปััะตะฝะธะต device_id ะฟะพ ะธะผะตะฝะธ
- **Core Audio** (PyObjC) - ะพััะปะตะถะธะฒะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน ัะตัะตะท ะฝะพัะธัะธะบะฐัะธะธ
- **DeviceChangePublisher** - ะตะดะธะฝัะน ะผะพะฝะธัะพั ั Core Audio ะฝะพัะธัะธะบะฐัะธัะผะธ + polling fallback

**ะัะพะฑะปะตะผั ัะตะบััะตะณะพ ะฟะพะดัะพะดะฐ:**
- โ๏ธ ะะฐะฒะธัะธะผะพััั ะพั ะฒะฝะตัะฝะตะน ััะธะปะธัั SwitchAudioSource (ะฝัะถะฝะพ ัััะฐะฝะฐะฒะปะธะฒะฐัั ะพัะดะตะปัะฝะพ)
- โ๏ธ ะะฝะพะถะตััะฒะตะฝะฝัะต ะธััะพัะฝะธะบะธ ะธะฝัะพัะผะฐัะธะธ (SwitchAudioSource ะดะปั ะธะผะตะฝะธ, PortAudio ะดะปั ID)
- โ๏ธ ะกะปะพะถะฝะฐั ะปะพะณะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั (guard'ั, ะบััะธ, fallback'ะธ)

**ะะตะบะพะผะตะฝะดะฐัะธะธ:**
- **ะัะฐัะบะพััะพัะฝะพ:** ะััะฐะฒะธัั ะบะฐะบ ะตััั, ัะปัััะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ ะธ fallback'ะธ
- **ะกัะตะดะฝะตััะพัะฝะพ:** ะะพะฑะฐะฒะธัั fallback ะฝะฐ Core Audio, ะตัะปะธ SwitchAudioSource ะฝะตะดะพัััะฟะตะฝ
- **ะะพะปะณะพััะพัะฝะพ:** ะะธะณัะธัะพะฒะฐัั ะฝะฐ ัะธัััะน Core Audio, ัะฑัะฐะฒ ะทะฐะฒะธัะธะผะพััั ะพั SwitchAudioSource

---

## 9. ะะฐะบะปััะตะฝะธะต

ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ ะฐัะดะธะพ ัะธััะตะผั Nexy ะพัะฝะพะฒะฐะฝะฐ ะฝะฐ ัะพะฑััะธะนะฝะพะน ะผะพะดะตะปะธ (EventBus) ะธ ัะฐะทะดะตะปะตะฝะธะธ ะพัะฒะตัััะฒะตะฝะฝะพััะธ ะผะตะถะดั ะผะพะดัะปัะผะธ ะธ ะธะฝัะตะณัะฐัะธัะผะธ.

### 9.1 ะกัะฐััั ะธัะฟัะฐะฒะปะตะฝะธะน (2025-12-02)

**โ ะัะฟัะฐะฒะปะตะฝะพ:**
- ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ะฟะตัะตะบะปััะตะฝะธะตะผ ััััะพะนััะฒะฐ
- ะฃะผะตะฝััะตะฝั ัะฐะนะผะฐััั switch_device (5s ะดะปั ะพะฑััะฝัั, 10s ะดะปั BT)
- ะฃะผะตะฝััะตะฝะพ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ (2 ะฒะผะตััะพ 5)
- Guard ะทะฐัะธัะฐ ะพั concurrent ะฟะตัะตะบะปััะตะฝะธะน
- ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน ะดะปั ะฐัะดะธัะฐ
- ะัั ััะฟะตัะฝัั ะบะพะฝัะธะณััะฐัะธะน
- ะัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource (ัะฐััะธัะฝะพ)

**โ๏ธ ะ ะฟัะพัะตััะต:**
- Race condition ะผะตะถะดั LONG_PRESS ะธ RELEASE
- ะัะตะดะฒะฐัะธัะตะปัะฝะพะต ัะพะทะดะฐะฝะธะต OUTPUT ะฟะพัะพะบะฐ
- ะะพะปะฝะฐั ะผะธะณัะฐัะธั ะฝะฐ ะฐัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource

**โ๏ธ ะััะฐััะธะตัั ะฟัะพะฑะปะตะผั:**
- ะัะธะฑะบะธ -10851 ะฝะฐ BT ััััะพะนััะฒะฐั (ััะตะฑัะตั ะดะฐะปัะฝะตะนัะตะณะพ ะธััะปะตะดะพะฒะฐะฝะธั)
- ะะฐะดะตัะถะบะธ ะทะฐะบัััะธั ะฟะพัะพะบะฐ ะดะปั BT ััััะพะนััะฒ (2.5s ะฟะพัะปะต close)
- ะะฐะฒะธัะธะผะพััั ะพั ะฒะฝะตัะฝะตะน ััะธะปะธัั SwitchAudioSource

### 9.2 ะขะตะบััะตะต ัะพััะพัะฝะธะต

**ะัะฝะพะฒะฝัะต ัะปัััะตะฝะธั:**
1. **ะะฐะดะตะถะฝะพััั ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ** - ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะฐ ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฝะพะฒะพะณะพ
2. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั** - ัะผะตะฝััะตะฝะฝัะต ัะฐะนะผะฐััั ะธ ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ
3. **ะะฐะฑะปัะดะฐะตะผะพััั** - ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน ะธ decision-ะปะพะณะธ
4. **ะะฐัะธัะฐ ะพั ะพัะธะฑะพะบ** - guard'ั, ะบััะธ, fallback'ะธ

**ะะตะบะพะผะตะฝะดะฐัะธะธ:**
- ะัะพะดะพะปะถะธัั ะผะพะฝะธัะพัะธะฝะณ ะพัะธะฑะพะบ -10851 ะฝะฐ BT ััััะพะนััะฒะฐั
- ะะฐััะผะพััะตัั ะผะธะณัะฐัะธั ะฝะฐ ัะธัััะน Core Audio ะดะปั ััััะฐะฝะตะฝะธั ะทะฐะฒะธัะธะผะพััะธ ะพั SwitchAudioSource
- ะะตะฐะปะธะทะพะฒะฐัั ะฟัะตะดะฒะฐัะธัะตะปัะฝะพะต ัะพะทะดะฐะฝะธะต OUTPUT ะฟะพัะพะบะฐ ะดะปั ัะปัััะตะฝะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

---

## 10. ะะปะฐะฝ ัะตัะฐะบัะพัะธะฝะณะฐ ะฐัะดะธะพ-ัะธััะตะผั

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-12-02  
**ะกัะฐััั:** ะะปะฐะฝ (ะฝะต ัะตะฐะปะธะทะพะฒะฐะฝะพ)

### 10.0 ะะฝะฐะปะธะท: ััะพะธั ะปะธ ะผะตะฝััั ะฐััะธัะตะบัััั?

#### 10.0.1 ะัะฐัะบะธะน ะฒะตัะดะธะบั

**ะะตะบะพะผะตะฝะดะฐัะธั: ะกะขะะะข ะผะตะฝััั, ะฝะฐัะธะฝะฐั ั ะคะฐะทั 1 ะธ ะคะฐะทั 2 (ัะตัะฐะตั ะฟะพััะพัะฝะฝัั ะฟัะพะฑะปะตะผั).**

**ะะฑะพัะฝะพะฒะฐะฝะธะต:**
1. โ๏ธ **ะะพััะพัะฝะฝัะต ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ** (ะฟะพะดัะฒะตัะถะดะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ):
   - ะะฝะพะถะตััะฒะตะฝะฝัะต fallback'ะธ ะฝะฐ SwitchAudioSource ("Fallback ะฝะฐ SwitchAudioSource (device_id ะฝะต ะฟะตัะตะดะฐะฝ)")
   - ะัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (AirPods) โ ััััะพะนััะฒะพ ะฝะต ะฝะฐัะพะดะธััั ะฒ PortAudio ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะธะผะตะฝะธ
   - ะัะธะฑะบะธ -9986 ะธ -10851 ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะพะฒ ะธะท-ะทะฐ ะฝะตัะพะพัะฒะตัััะฒะธั ะผะตะถะดั ะธะผะตะฝะตะผ ะธ ID
   - ะะฝะพะถะตััะฒะตะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource (84 ัะฟะพะผะธะฝะฐะฝะธั ะฒ 5 ัะฐะนะปะฐั)
2. โ๏ธ **ะััะธัะตะบัััะฝัะต ะฟัะพะฑะปะตะผั:**
   - ะะตั ะตะดะธะฝะพะณะพ ะธััะพัะฝะธะบะฐ ะธััะธะฝั (ะธะผั ะธะท SwitchAudioSource, ID ะธะท PortAudio)
   - ะกะปะพะถะฝะฐั ะปะพะณะธะบะฐ ั ะผะฝะพะถะตััะฒะตะฝะฝัะผะธ fallback'ะฐะผะธ ะธ guard'ะฐะผะธ
   - ะัะพะฑะปะตะผั ั ัะธะฝััะพะฝะธะทะฐัะธะตะน ะผะตะถะดั ะธััะพัะฝะธะบะฐะผะธ ะธะฝัะพัะผะฐัะธะธ
3. โ ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั ัะตัะตะฝั (ะฑะปะพะบะธัะพะฒะบะธ, ะดัะฑะปะธัะพะฒะฐะฝะธะต, ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะพะฒ)
4. โ ะะตัะฐะบัะพัะธะฝะณ ะคะฐะทั 1-2 ัะตัะฐะตั ัะตะฐะปัะฝัั ะฟัะพะฑะปะตะผั, ะฐ ะฝะต ะฟัะพััะพ ัะปัััะฐะตั ะฐััะธัะตะบัััั

**ะะพะณะดะฐ ะกะขะะะข ะผะตะฝััั (ะขะะะฃะฉะะฏ ะกะะขะฃะะฆะะฏ):**
- โ **ะะพััะพัะฝะฝัะต ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ** โ ะฟะพะดัะฒะตัะถะดะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
- โ ะัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (AirPods) โ ััััะพะนััะฒะพ ะฝะต ะฝะฐัะพะดะธััั ะฒ PortAudio
- โ ะะฝะพะถะตััะฒะตะฝะฝัะต fallback'ะธ ะธ ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะฒ ะปะพะณะฐั
- โ ะะตั ะตะดะธะฝะพะณะพ ะธััะพัะฝะธะบะฐ ะธััะธะฝั ะดะปั ััััะพะนััะฒะฐ

**ะะพะณะดะฐ ะะ ะกะขะะะข ะผะตะฝััั:**
- ะัะปะธ ัะธััะตะผะฐ ัะฐะฑะพัะฐะตั ััะฐะฑะธะปัะฝะพ ะธ ะฟะพะบััะฒะฐะตั ะฒัะต ััะตะฑะพะฒะฐะฝะธั (ะะ ะะะจ ะกะะฃะงะะ)
- ะัะปะธ ะฝะตั ะฒัะตะผะตะฝะธ ะฝะฐ ะฟะพะปะฝะพัะตะฝะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต (ะฝะพ ะผะพะถะฝะพ ะดะตะปะฐัั ะฟะพััะตะฟะตะฝะฝะพ)

---

#### 10.0.2 ะะตัะฐะปัะฝัะน ะฐะฝะฐะปะธะท ัะตะบััะตะณะพ ัะพััะพัะฝะธั

**โ ะงัะพ ัะฐะฑะพัะฐะตั ัะพัะพัะพ:**
- ะะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒ ัะฐะฑะพัะฐะตั ััะฐะฑะธะปัะฝะพ
- ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะต ะทะฐะบัััะธะต ะฟะพัะพะบะพะฒ ะฟะตัะตะด ะฟะตัะตะบะปััะตะฝะธะตะผ
- Guard ะทะฐัะธัะฐ ะพั concurrent ะพะฟะตัะฐัะธะน
- ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฟะตัะตะบะปััะตะฝะธะน ะดะปั ะฐัะดะธัะฐ
- ะัั ััะฟะตัะฝัั ะบะพะฝัะธะณััะฐัะธะน
- ะัะธะฝััะพะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource (ัะฐััะธัะฝะพ)
- Core Audio ะฝะพัะธัะธะบะฐัะธะธ ะธัะฟะพะปัะทััััั ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะธะทะผะตะฝะตะฝะธะน
- Fallback ะฝะฐ polling ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ Core Audio

**โ๏ธ ะงัะพ ะฝะต ะธะดะตะฐะปัะฝะพ, ะฝะพ ัะฐะฑะพัะฐะตั:**
- ะะฐะฒะธัะธะผะพััั ะพั ะฒะฝะตัะฝะตะน ััะธะปะธัั SwitchAudioSource (84 ัะฟะพะผะธะฝะฐะฝะธั ะฒ 5 ัะฐะนะปะฐั)
- ะะฝะพะถะตััะฒะตะฝะฝัะต ะธััะพัะฝะธะบะธ ะธะฝัะพัะผะฐัะธะธ (SwitchAudioSource ะดะปั ะธะผะตะฝะธ, PortAudio ะดะปั ID)
- ะกะปะพะถะฝะฐั ะปะพะณะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั (guard'ั, ะบััะธ, fallback'ะธ)
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะธะผะตะฝะธ ััััะพะนััะฒะฐ ะดะปั ะฟัะธะฝััะธั ัะตัะตะฝะธะน (ะผะพะถะฝะพ ะทะฐะผะตะฝะธัั ะฝะฐ core_audio_id/uid)

**๐ ะะพะดัะฒะตัะถะดะตะฝะฝัะต ะฟัะพะฑะปะตะผั ะธะท ะปะพะณะพะฒ ะธ ะฟะพะปัะทะพะฒะฐัะตะปั (2025-12-02):**

1. **ะะฝะพะถะตััะฒะตะฝะฝัะต fallback'ะธ ะฝะฐ SwitchAudioSource:**
   ```
   โ [OUTPUT] Fallback ะฝะฐ SwitchAudioSource (device_id ะฝะต ะฟะตัะตะดะฐะฝ)
   ```
   - ะัะพะธััะพะดะธั ะฟะพััะพัะฝะฝะพ ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟััะบะต ะฟะพัะพะบะฐ
   - ะฃะบะฐะทัะฒะฐะตั ะฝะฐ ัะพ, ััะพ `device_id` ะฝะต ะฟะตัะตะดะฐะตััั ะบะพััะตะบัะฝะพ

2. **ะัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (AirPods):**
   ```
   โ๏ธ [OUTPUT] ะฃัััะพะนััะฒะพ "Sergiy's AirPods" ะฝะต ะฝะฐะนะดะตะฝะพ ะฒ PortAudio ะฟะพัะปะต ะฒัะตั ะฟะพะฟััะพะบ
   โ [OUTPUT] ะะต ัะดะฐะปะพัั ัะพะทะดะฐัั ะฟะพัะพะบ ะฟะพัะปะต 2 ะฟะพะฟััะพะบ: Error opening OutputStream: Internal PortAudio error [PaErrorCode -9986]
   ```
   - ะฃัััะพะนััะฒะพ ะฟะพะปััะฐะตััั ัะตัะตะท SwitchAudioSource, ะฝะพ ะฝะต ะฝะฐัะพะดะธััั ะฒ PortAudio
   - ะัะธะฒะพะดะธั ะบ ะพัะธะฑะบะฐะผ -9986 ะธ -10851 ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะพะฒ

3. **ะัะธะฑะบะธ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะพะฒ:**
   ```
   ||PaMacCore (AUHAL)|| Error on line 1332: err='-10851', msg=Audio Unit: Invalid Property Value
   โ [OUTPUT] ะะต ัะดะฐะปะพัั ัะพะทะดะฐัั ะฟะพัะพะบ ะฟะพัะปะต 2 ะฟะพะฟััะพะบ: Error opening OutputStream: Internal PortAudio error [PaErrorCode -9986]
   ```
   - ะัะพะธััะพะดัั ะธะท-ะทะฐ ะฝะตัะพะพัะฒะตัััะฒะธั ะผะตะถะดั ะธะผะตะฝะตะผ ััััะพะนััะฒะฐ (ะธะท SwitchAudioSource) ะธ ID (ะธะท PortAudio)
   - ะัะพะฑะตะฝะฝะพ ัะฐััะพ ะฝะฐ BT ััััะพะนััะฒะฐั

4. **ะะฝะพะถะตััะฒะตะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource:**
   - ะ ะปะพะณะฐั ะฒะธะดะฝะพ ะผะฝะพะถะตััะฒะพ ะฒัะทะพะฒะพะฒ `SwitchAudioSource` ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟััะบะต
   - ะะฐะถะดัะน ะฒัะทะพะฒ ะทะฐะฝะธะผะฐะตั ะฒัะตะผั (subprocess ั timeout=5s)
   - ะฃะฒะตะปะธัะธะฒะฐะตั ะทะฐะดะตัะถะบะธ ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ััััะพะนััะฒ

**โ ะงัะพ ะฝะต ัะฐะฑะพัะฐะตั (ะะะะขะะงะะกะะะ ะะะะะะะะซ):**
- โ๏ธ **ะะพััะพัะฝะฝัะต ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ:**
  - ะะฝะพะถะตััะฒะตะฝะฝัะต fallback'ะธ ะฝะฐ SwitchAudioSource ("Fallback ะฝะฐ SwitchAudioSource (device_id ะฝะต ะฟะตัะตะดะฐะฝ)")
  - ะัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (AirPods) โ ััััะพะนััะฒะพ ะฝะต ะฝะฐัะพะดะธััั ะฒ PortAudio ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะธะผะตะฝะธ ัะตัะตะท SwitchAudioSource
  - ะัะธะฑะบะธ -9986 ะธ -10851 ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฟะพัะพะบะพะฒ ะธะท-ะทะฐ ะฝะตัะพะพัะฒะตัััะฒะธั ะผะตะถะดั ะธะผะตะฝะตะผ ะธ ID
  - ะะฝะพะถะตััะฒะตะฝะฝัะต ะฒัะทะพะฒั SwitchAudioSource (84 ัะฟะพะผะธะฝะฐะฝะธั ะฒ 5 ัะฐะนะปะฐั)
- โ๏ธ **ะะตั ะตะดะธะฝะพะณะพ ะธััะพัะฝะธะบะฐ ะธััะธะฝั ะดะปั ััััะพะนััะฒะฐ:**
  - ะะผั ะธะท SwitchAudioSource, ID ะธะท PortAudio
  - ะัะพะฑะปะตะผั ั ัะธะฝััะพะฝะธะทะฐัะธะตะน ะผะตะถะดั ะธััะพัะฝะธะบะฐะผะธ ะธะฝัะพัะผะฐัะธะธ
  - BT ััััะพะนััะฒะฐ ัะฐััะพ ะฝะต ะฝะฐัะพะดัััั ะฒ PortAudio, ััะพ ะฟัะธะฒะพะดะธั ะบ ะพัะธะฑะบะฐะผ
- โ๏ธ **ะกะปะพะถะฝะฐั ะปะพะณะธะบะฐ ั ะผะฝะพะถะตััะฒะตะฝะฝัะผะธ fallback'ะฐะผะธ:**
  - Guard'ั, ะบััะธ, fallback'ะธ ััะปะพะถะฝััั ะพัะปะฐะดะบั
  - ะขััะดะฝะพ ะฟะพะฝััั, ะบะฐะบะพะน ะธััะพัะฝะธะบ ะธะฝัะพัะผะฐัะธะธ ะธัะฟะพะปัะทัะตััั ะฒ ะบะพะฝะบัะตัะฝัะน ะผะพะผะตะฝั

---

#### 10.0.3 ะะฝะฐะปะธะท ะทะฐััะฐั ะธ ะฒัะณะพะด

**ะะฐััะฐัั ะฝะฐ ัะตัะฐะบัะพัะธะฝะณ:**

1. **ะัะตะผั ัะฐะทัะฐะฑะพัะบะธ:** 7-11 ะดะฝะตะน
   - ะคะฐะทะฐ 1: 2-3 ะดะฝั
   - ะคะฐะทะฐ 2: 3-5 ะดะฝะตะน
   - ะคะฐะทะฐ 3: 2-3 ะดะฝั

2. **ะะธัะบะธ:**
   - **ะััะพะบะธะน ัะธัะบ:** ะะตะณัะตััะธะธ ะฟัะธ ะผะธะณัะฐัะธะธ (ะผะพะถะตั ัะปะพะผะฐัั ััะฐะฑะธะปัะฝัั ัะธััะตะผั)
   - **ะกัะตะดะฝะธะน ัะธัะบ:** ะะตัะพะฒะผะตััะธะผะพััั Core Audio API (ัะฐะทะฝัะต ะฒะตััะธะธ macOS)
   - **ะะธะทะบะธะน ัะธัะบ:** ะะพัะตัั ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ ะฟัะธ ัะดะฐะปะตะฝะธะธ SwitchAudioSource (ะตััั fallback)

3. **ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะทะฐััะฐัั:**
   - ะขะตััะธัะพะฒะฐะฝะธะต ะฝะฐ ัะฐะทะฝัั ััััะพะนััะฒะฐั (BT, USB, ะฒัััะพะตะฝะฝัะต) โ 2-3 ะดะฝั
   - ะะพะบัะผะตะฝัะฐัะธั ะธะทะผะตะฝะตะฝะธะน โ 1 ะดะตะฝั
   - ะะฑััะตะฝะธะต ะบะพะผะฐะฝะดั ะฝะพะฒะพะน ะฐััะธัะตะบัััะต โ 0.5 ะดะฝั
   - ะะพะฝะธัะพัะธะฝะณ ะฟะพัะปะต rollout โ 1-2 ะฝะตะดะตะปะธ

**ะัะพะณะพ:** 10-15 ะดะฝะตะน ัะฐะทัะฐะฑะพัะบะธ + ัะตััะธัะพะฒะฐะฝะธะต + ะผะพะฝะธัะพัะธะฝะณ

**ะัะณะพะดั ะพั ัะตัะฐะบัะพัะธะฝะณะฐ:**

1. **ะขะตัะฝะธัะตัะบะธะต:**
   - โ ะฃะฑัะฐัั ะทะฐะฒะธัะธะผะพััั ะพั ะฒะฝะตัะฝะตะน ััะธะปะธัั (ะฝะพ ะพะฝะฐ ัะฐะฑะพัะฐะตั ััะฐะฑะธะปัะฝะพ)
   - โ ะฃะฟัะพััะธัั ะฐััะธัะตะบัััั (ัะตัะบะธะต ะณัะฐะฝะธัั ะพัะฒะตัััะฒะตะฝะฝะพััะธ)
   - โ ะฃะปัััะธัั ะฟะพะดะดะตัะถะธะฒะฐะตะผะพััั (ะปะตะณัะต ะฟะพะฝััั, ะบัะพ ะทะฐ ััะพ ะพัะฒะตัะฐะตั)
   - โ ะะพะปะตะต ะฝะฐะดะตะถะฝะฐั ัะฐะฑะพัะฐ ั Core Audio ะฝะฐะฟััะผัั (ะฝะพ ัะตะบััะฐั ัะธััะตะผะฐ ัะพะถะต ะฝะฐะดะตะถะฝะฐ)

2. **ะะธะทะฝะตั:**
   - โ๏ธ ะะตะฝััะต ะฟัะพะฑะปะตะผ ั ัััะฐะฝะพะฒะบะพะน/ะพะฑะฝะพะฒะปะตะฝะธะตะผ SwitchAudioSource (ะฝะพ ััะพ ัะตะดะบะฐั ะฟัะพะฑะปะตะผะฐ)
   - โ๏ธ ะะพัะตะฝัะธะฐะปัะฝะพ ะผะตะฝััะต ะฑะฐะณะพะฒ ะฒ ะฑัะดััะตะผ (ะฝะพ ะฝะต ะณะฐัะฐะฝัะธัะพะฒะฐะฝะพ)
   - โ๏ธ ะะตะณัะต ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต ัะธัะธ (ะฝะพ ัะตะบััะฐั ะฐััะธัะตะบัััะฐ ัะพะถะต ะฟะพะทะฒะพะปัะตั)

**ะัะตะฝะบะฐ ะฒัะณะพะด:** ะกัะตะดะฝะธะต (ะฝะต ะบัะธัะธัะฝัะต, ะฝะพ ะฟะพะปะตะทะฝัะต)

**ROI (Return on Investment):**
- **ะะฐััะฐัั:** 5-8 ะดะฝะตะน (ะคะฐะทะฐ 1-2, ะฑะตะท ะคะฐะทั 3)
- **ะัะณะพะดั:** ะััะพะบะธะต (ัะตัะฐะตั ะฟะพััะพัะฝะฝัั ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ)
- **ะะธัะบะธ:** ะกัะตะดะฝะธะต (ะฟะพััะตะฟะตะฝะฝัะน rollout, feature flags)
- **ะัะฒะพะด:** ROI ะฟะพะปะพะถะธัะตะปัะฝัะน ะดะปั ะคะฐะทั 1-2 (ัะตัะฐะตั ัะตะฐะปัะฝัั ะฟัะพะฑะปะตะผั)

---

#### 10.0.4 ะะปััะตัะฝะฐัะธะฒั ัะตัะฐะบัะพัะธะฝะณั

**ะะฐัะธะฐะฝั 1: ะคะฐะทะฐ 1-2 ัะตัะฐะบัะพัะธะฝะณะฐ (5-8 ะดะฝะตะน) โ ะะะะะะะะะฃะะขะกะฏ**
- โ ะคะฐะทะฐ 1: ะฃะฟัะพััะธัั ะปะพะณะธะบั ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ (2-3 ะดะฝั)
  - ะะฐัะธะบัะธัะพะฒะฐัั ะผะพะดะตะปั "ัะปะตะดัะตะผ ะทะฐ ัะธััะตะผะฝัะผ ะดะตัะพะปัะพะผ"
  - ะัะปะฐะฑะธัั ะทะฐะฒะธัะธะผะพััั ะพั SwitchAudioSource
  - ะัะฟะพะปัะทะพะฒะฐัั ะธะผั ัะพะปัะบะพ ะดะปั ะปะพะณะพะฒ ะธ UI
- โ ะคะฐะทะฐ 2: ะะฒะตััะธ CoreAudioDeviceManager (3-5 ะดะฝะตะน)
  - ะะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั ะดะปั Core Audio ััััะพะนััะฒ
  - ะะฑะปะตะณัะธัั DeviceChangePublisher
  - ะัะฟะพะปัะทะพะฒะฐัั core_audio_id/uid ะฒะผะตััะพ ะธะผะตะฝะธ ะดะปั ััะฐะฒะฝะตะฝะธั

**ะัะตะธะผััะตััะฒะฐ:**
- ะะตัะฐะตั ะฟะพััะพัะฝะฝัั ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ
- ะฃัััะฐะฝัะตั ะฟัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (ะตะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั)
- ะฃะฟัะพัะฐะตั ะฐััะธัะตะบัััั (ัะตัะบะธะต ะณัะฐะฝะธัั ะพัะฒะตัััะฒะตะฝะฝะพััะธ)
- ะะพััะตะฟะตะฝะฝัะน rollout ัะตัะตะท feature flags (ะฝะธะทะบะธะน ัะธัะบ)

**ะะฐัะธะฐะฝั 1.1: ะะธะฝะธะผะฐะปัะฝัะต ัะปัััะตะฝะธั (1-2 ะดะฝั) โ ะะ ะะะะะะะะะฃะะขะกะฏ**
- ะะพะฑะฐะฒะธัั fallback ะฝะฐ Core Audio ะดะปั ะฟะพะปััะตะฝะธั ะธะผะตะฝะธ ััััะพะนััะฒะฐ
- ะฃะปัััะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ SwitchAudioSource
- ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ ะฟัะพะฑะปะตะผ

**ะะพัะตะผั ะฝะต ัะตะบะพะผะตะฝะดัะตััั:**
- ะะต ัะตัะฐะตั ะบะพัะฝะตะฒัั ะฟัะพะฑะปะตะผั (ะฝะตั ะตะดะธะฝะพะณะพ ะธััะพัะฝะธะบะฐ ะธััะธะฝั)
- ะัะพะดะพะปะถะฐะตั ะฝะฐะบะฐะฟะปะธะฒะฐัั ัะตัะฝะธัะตัะบะธะน ะดะพะปะณ
- ะัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ ะพััะฐะฝัััั

**ะะฐัะธะฐะฝั 2: ะะพะดะณะพัะพะฒะบะฐ ะบ ัะตัะฐะบัะพัะธะฝะณั (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน ะปะพะณะธะบะธ) โ 2-3 ะดะฝั**
- ะะพะฑะฐะฒะธัั feature flags ะดะปั ะฑัะดััะธั ะธะทะผะตะฝะตะฝะธะน
- ะกะพะทะดะฐัั CoreAudioDeviceManager ะบะฐะบ ะพะฟัะธะพะฝะฐะปัะฝัะน ะบะพะผะฟะพะฝะตะฝั (ะฟะฐัะฐะปะปะตะปัะฝะพ ั ัะตะบััะตะน ะปะพะณะธะบะพะน)
- ะะพะบัะผะตะฝัะธัะพะฒะฐัั ัะตะบัััั ะฐััะธัะตะบัััั ะธ ะฟะปะฐะฝ ะผะธะณัะฐัะธะธ
- ะะพะฑะฐะฒะธัั ัะตััั ะดะปั ะฝะพะฒะพะน ะฐััะธัะตะบัััั

**ะัะตะธะผััะตััะฒะฐ:**
- ะะธะทะบะธะน ัะธัะบ (ะฝะต ะผะตะฝัะตั ัะตะบัััั ะปะพะณะธะบั)
- ะะพะดะณะพัะฐะฒะปะธะฒะฐะตั ะฟะพัะฒั ะดะปั ะฑัะดััะตะณะพ ัะตัะฐะบัะพัะธะฝะณะฐ
- ะะพะถะฝะพ ัะตััะธัะพะฒะฐัั ะฝะพะฒัั ะฐััะธัะตะบัััั ะฟะฐัะฐะปะปะตะปัะฝะพ

**ะะฐัะธะฐะฝั 3: ะะพะปะฝัะน ัะตัะฐะบัะพัะธะฝะณ (10-15 ะดะฝะตะน) โ ะะ ะะะะะะะะะฃะะขะกะฏ ะกะะะงะะก**
- ะะตะฐะปะธะทะพะฒะฐัั ะฒัะต ััะธ ัะฐะทั ะฟะปะฐะฝะฐ ัะตัะฐะบัะพัะธะฝะณะฐ
- ะฃะฑัะฐัั SwitchAudioSource ะฟะพะปะฝะพัััั
- ะะธะณัะธัะพะฒะฐัั ะฝะฐ ัะธัััะน Core Audio

**ะัะตะธะผััะตััะฒะฐ:**
- ะงะธััะฐั ะฐััะธัะตะบัััะฐ
- ะะตั ะทะฐะฒะธัะธะผะพััะธ ะพั ะฒะฝะตัะฝะธั ััะธะปะธั

**ะะตะดะพััะฐัะบะธ:**
- ะััะพะบะธะต ะทะฐััะฐัั ะฒัะตะผะตะฝะธ
- ะััะพะบะธะน ัะธัะบ ัะตะณัะตััะธะน
- ะะตั ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะน ะฒัะณะพะดั

**ะะฐัะธะฐะฝั 4: ะััะฐะฒะธัั ะบะฐะบ ะตััั โ ะะะะะะะะ**
- ะัะพะดะพะปะถะธัั ะผะพะฝะธัะพัะธะฝะณ ะฟัะพะฑะปะตะผ
- ะัะฟัะฐะฒะปััั ะฑะฐะณะธ ะฟะพ ะผะตัะต ะฟะพัะฒะปะตะฝะธั
- ะะตัะฐะบัะพัะธะฝะณ ะพัะปะพะถะธัั ะดะพ ะฟะพัะฒะปะตะฝะธั ะบัะธัะธัะตัะบะธั ะฟัะพะฑะปะตะผ

**ะัะตะธะผััะตััะฒะฐ:**
- ะะตั ัะธัะบะฐ ัะตะณัะตััะธะน
- ะคะพะบัั ะฝะฐ ะฝะพะฒัั ัะธัะฐั

**ะะตะดะพััะฐัะบะธ:**
- ะขะตัะฝะธัะตัะบะธะน ะดะพะปะณ ะฝะฐะบะฐะฟะปะธะฒะฐะตััั
- ะะฐะฒะธัะธะผะพััั ะพั SwitchAudioSource ะพััะฐะตััั

---

#### 10.0.5 ะคะธะฝะฐะปัะฝะฐั ัะตะบะพะผะตะฝะดะฐัะธั

**ะะปั ัะตะบััะตะณะพ ะผะพะผะตะฝัะฐ: ะะฐัะธะฐะฝั 1 (ะคะฐะทะฐ 1-2 ัะตัะฐะบัะพัะธะฝะณะฐ) โ ะะะะะะะะะฃะะขะกะฏ**

**ะงัะพ ัะดะตะปะฐัั (5-8 ะดะฝะตะน):**

**ะคะฐะทะฐ 1: ะฃะฟัะพััะธัั ะปะพะณะธะบั ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ (2-3 ะดะฝั)**

1. **ะะฐัะธะบัะธัะพะฒะฐัั ะผะพะดะตะปั "ัะปะตะดัะตะผ ะทะฐ ัะธััะตะผะฝัะผ ะดะตัะพะปัะพะผ" (1 ะดะตะฝั)**
   - ะัะธ ััะฐััะต ะธัะฟะพะปัะทะพะฒะฐัั ัะตะบััะธะน default-ััััะพะนััะฒะพ PortAudio
   - ะัะธ ัะพะฑััะธะธ `device.default_*_changed` ะฟะตัะตัะพะทะดะฐะฒะฐัั ะฟะพัะพะบ ะฝะฐ ัะตะบััะตะผ default-ััััะพะนััะฒะต PortAudio
   - ะะต ะฟััะฐัััั ัะณะฐะดะฐัั ััััะพะนััะฒะพ ะฟะพ ะธะผะตะฝะธ

2. **ะัะปะฐะฑะธัั ะทะฐะฒะธัะธะผะพััั ะพั SwitchAudioSource (1-2 ะดะฝั)**
   - ะฃะฑัะฐัั SwitchAudioSource ะธะท ะบัะธัะธัะตัะบะพะณะพ ะฟััะธ
   - ะัะฟะพะปัะทะพะฒะฐัั Core Audio ะฝะพัะธัะธะบะฐัะธะธ ะบะฐะบ ะพัะฝะพะฒะฝะพะน ะธััะพัะฝะธะบ ะธะทะผะตะฝะตะฝะธะน
   - SwitchAudioSource ัะพะปัะบะพ ะดะปั fallback/ะดะธะฐะณะฝะพััะธะบะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

**ะคะฐะทะฐ 2: ะะฒะตััะธ CoreAudioDeviceManager (3-5 ะดะฝะตะน)**

1. **ะกะพะทะดะฐัั CoreAudioDeviceManager (2 ะดะฝั)**
   - ะะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั ะดะปั Core Audio ััััะพะนััะฒ
   - ะะพะทะฒัะฐัะฐะตั `DeviceInfo` ั `core_audio_id`, `uid`, `name`, ัะปะฐะณะฐะผะธ
   - ะะต ะทะฝะฐะตั ะฟัะพ PortAudio, EventBus, ะธะฝัะตะณัะฐัะธะธ

2. **ะะฑะฝะพะฒะธัั DeviceChangePublisher (1-2 ะดะฝั)**
   - ะัะฟะพะปัะทะพะฒะฐัั CoreAudioDeviceManager ะฒะผะตััะพ SwitchAudioSource
   - ะกัะฐะฒะฝะธะฒะฐัั ััััะพะนััะฒะฐ ะฟะพ `core_audio_id`/`uid`, ะฐ ะฝะต ะฟะพ ะธะผะตะฝะธ
   - ะฃะฑัะฐัั ะบัั ะธะผัะฝ ะธ ัะปะพะถะฝัะต guard'ั

3. **ะะฑะฝะพะฒะธัั AudioStreamManager (1 ะดะตะฝั)**
   - ะัะฟะพะปัะทะพะฒะฐัั ัะพะฑััะธั ั `core_audio_id`/`uid` ะฒะผะตััะพ ะธะผะตะฝะธ
   - ะฃะฟัะพััะธัั ะปะพะณะธะบั ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ

**ะะพัะตะผั ััะพั ะฒะฐัะธะฐะฝั:**
- โ ะะตัะฐะตั ะฟะพััะพัะฝะฝัั ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ
- โ ะฃัััะฐะฝัะตั ะฟัะพะฑะปะตะผั ั BT ััััะพะนััะฒะฐะผะธ (ะตะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั)
- โ ะฃะฟัะพัะฐะตั ะฐััะธัะตะบัััั (ัะตัะบะธะต ะณัะฐะฝะธัั ะพัะฒะตัััะฒะตะฝะฝะพััะธ)
- โ ะะพััะตะฟะตะฝะฝัะน rollout ัะตัะตะท feature flags (ะฝะธะทะบะธะน ัะธัะบ)
- โ ะะตัะฐะตั ัะตะฐะปัะฝัั ะฟัะพะฑะปะตะผั, ะฐ ะฝะต ะฟัะพััะพ ัะปัััะฐะตั ะฐััะธัะตะบัััั

**ะะปะฐะฝ rollout:**
1. **ะะตะดะตะปั 1:** ะะตะฐะปะธะทะฐัะธั ะคะฐะทั 1 ั feature flag `NEXY_FEATURE_DEVICE_SWITCH_V2`
2. **ะะตะดะตะปั 2:** ะขะตััะธัะพะฒะฐะฝะธะต ะคะฐะทั 1, ะฝะฐัะฐะปะพ ะคะฐะทั 2
3. **ะะตะดะตะปั 3:** ะะฐะฒะตััะตะฝะธะต ะคะฐะทั 2, ัะตััะธัะพะฒะฐะฝะธะต
4. **ะะตะดะตะปั 4:** ะะพััะตะฟะตะฝะฝัะน rollout (1% โ 25% โ 100%)

**ะะพะณะดะฐ ะฟะตัะตัะผะพััะตัั ัะตัะตะฝะธะต:**
- ะัะปะธ ะคะฐะทะฐ 1-2 ะฝะต ัะตัะฐะตั ะฟัะพะฑะปะตะผั ั ะพะฟัะตะดะตะปะตะฝะธะตะผ ััััะพะนััะฒ
- ะัะปะธ ะฟะพัะฒัััั ะบัะธัะธัะตัะบะธะต ัะตะณัะตััะธะธ
- ะัะปะธ ะฑัะดะตั ะฒัะตะผั ะฝะฐ ะคะฐะทั 3 (ะฟะพะปะฝัะน ัะตัะฐะบัะพัะธะฝะณ)

**๐ ะะตัะฐะปัะฝัะน ะฟะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ:** ะกะผ. `Docs/AUDIO_DEVICE_REFACTORING_PLAN.md`

---

### 10.1 ะะฑัะธะต ะฟัะธะฝัะธะฟั (ะฑะฐะทะฐ ะดะปั ะฒัะตั ัะฐะท)

1. **ะััะพัะฝะธะบ ะธััะธะฝั ะฟัะพ "ะบัะพ ะดะตัะพะปัะฝัะน"** โ macOS (Core Audio), ะฐ ะฝะต SwitchAudioSource
2. **PortAudio** โ ัะพะปัะบะพ ะธัะฟะพะปะฝะธัะตะปั: "ะพัะบัะพะน ะฟะพัะพะบ ะฝะฐ ัะฐะบะพะผ-ัะพ ััััะพะนััะฒะต", ะฐ ะฝะต "ัะตัะธ, ััะพ ะทะฐ ััััะพะนััะฒะพ"
3. **DeviceChangePublisher** โ ะฝะต "ะผะพะทะณ", ะฐ **ัะพััะตั/ัะธะปััั ัะพะฑััะธะน**
4. **AudioStreamManager** โ ะตะดะธะฝััะฒะตะฝะฝะพะต ะผะตััะพ, ะณะดะต ัะตัะฐะตััั:
   - ะบะฐะบะพะน PortAudio-ะดะตะฒะฐะนั ะธัะฟะพะปัะทะพะฒะฐัั
   - ะบะพะณะดะฐ ะทะฐะบััะฒะฐัั/ะพัะบััะฒะฐัั ะฟะพัะพะบะธ
   - ะบะฐะบ ััะธััะฒะฐัั Bluetooth/ัะฐะนะผะธะฝะณะธ

---

### 10.2 ะคะฐะทะฐ 1 โ ะฃะฟัะพััะธัั ัะตะบัััั ัะธััะตะผั (ะฟะพัะธััะธัั ัะฐะพั)

**ะฆะตะปั:** ะกะดะตะปะฐัั ัะฐะบ, ััะพะฑั **ะฟะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒ** ะปะพะณะธัะตัะบะธ ะฒัะณะปัะดะตะปะพ ัะฐะบ:

> "macOS ะณะพะฒะพัะธั: ะดะตัะพะปั ัะผะตะฝะธะปัั โ ะผั ะฟัะพััะพ ะฟะตัะตัะพะทะดะฐัะผ ะฟะพัะพะบ ะฝะฐ ัะตะบััะตะผ ะดะตัะพะปัะฝะพะผ ััััะพะนััะฒะต PortAudio"

#### ะจะฐะณ 1.1. ะะฐัะธะบัะธัะพะฒะฐัั ะผะพะดะตะปั "ัะปะตะดัะตะผ ะทะฐ ัะธััะตะผะฝัะผ ะดะตัะพะปัะพะผ"

**ะะดะต ะธะทะผะตะฝะธัั:**
- `modules/audio_core/stream_manager.py` โ `AudioStreamManager`
- `modules/speech_playback/core/player.py` โ `SequentialSpeechPlayer`
- `modules/voice_recognition/core/speech_recognizer.py` โ `SpeechRecognizer`

**ะงัะพ ะธะทะผะตะฝะธัั:**

1. **ะ ัะตะถะธะผะต "ะฟะพ ัะผะพะปัะฐะฝะธั":**
   - ะัะธ ััะฐััะต โ ะธัะฟะพะปัะทะพะฒะฐัั ัะตะบััะธะน default-ััััะพะนััะฒะพ PortAudio (input/output)
   - ะัะธ ัะพะฑััะธะธ `device.default_*_changed`:
     - ะะฐะบัััั ัะพะพัะฒะตัััะฒัััะธะน ัััะธะผ
     - ะัะบัััั ะฝะพะฒัะน **ะฝะฐ ัะตะบััะตะผ default-ััััะพะนััะฒะต PortAudio**, ะฝะต ะฟััะฐััั ัะณะฐะดะฐัั ะฟะพ ะธะผะตะฝะธ

2. **ะะพะผะตัะธัั ะบะฐะบ ะฒัะตะผะตะฝะฝัั ะปะพะณะธะบั:**
   - ะัะฑะฐั ะปะพะณะธะบะฐ, ะณะดะต:
     - ะะตััััั `device_name` ะธะท ัะพะฑััะธั
     - ะะพ ััะพะผั ะธะผะตะฝะธ ะธัะตััั ัะพะพัะฒะตัััะฒัััะธะน PortAudio index
     - ะะฐ ะพัะฝะพะฒะต ะธะผะตะฝะธ ัะตัะฐะตััั BT/ะฝะต BT
   - **ะัะผะตัะธัั ะบะฐะบ ะฒัะตะผะตะฝะฝัั ะธ ะณะพัะพะฒัั ะบ ะฒัะฟะธะปะธะฒะฐะฝะธั**

**ะะตะทัะปััะฐั:**
- ะะตัะตััะฐัั ะฟะพะปะฐะณะฐัััั ะฝะฐ ะธะผั ััััะพะนััะฒะฐ ะดะปั AUDIO-ัะดัะฐ
- ะัะฟะพะปัะทะพะฒะฐัั ะธะผั ัะพะปัะบะพ ะดะปั ะปะพะณะพะฒ ะธ UI

#### ะจะฐะณ 1.2. ะัะปะฐะฑะธัั ะทะฐะฒะธัะธะผะพััั ะพั SwitchAudioSource

**ะะดะต ะธะทะผะตะฝะธัั:**
- `modules/audio_core/device_change_publisher.py` โ `DeviceChangePublisher`

**ะงัะพ ะธะทะผะตะฝะธัั:**

1. **ะฃะฑัะฐัั SwitchAudioSource ะธะท ะบัะธัะธัะตัะบะพะณะพ ะฟััะธ:**
   - ะะฝ ะฝะต ะดะพะปะถะตะฝ ะฑััั ะพะฑัะทะฐัะตะปัะฝัะผ ะดะปั ัะพะณะพ, ััะพะฑั ัะตัะธัั: "ะดะตัะพะปั ัะผะตะฝะธะปัั" ะธะปะธ ะฝะตั

2. **ะะปะณะพัะธัะผ:**
   - ะัะปะธ ะฟัะธัะพะดัั ะฝะพัะธัะธะบะฐัะธะธ ะพั CoreAudio โ **ะฒะตัะธะผ ะธะผ** ะธ ััะธัะฐะตะผ, ััะพ ะดะตัะพะปั ะธะทะผะตะฝะธะปัั
   - SwitchAudioSource:
     - ะะธะฑะพ ะฒะพะพะฑัะต ะฝะต ะธัะฟะพะปัะทัะตััั
     - ะะธะฑะพ ัะพะปัะบะพ ะบะฐะบ fallback/ะดะธะฐะณะฝะพััะธะบะฐ (ะธ ัะฒะฝะพ ะฟะพะผะตัะตะฝ ะบะฐะบ "optional")

**ะัะธัะตัะธะน ััะฟะตัะฐ ัะฐะทั 1:**
๐ ะัะปะธ ัะตะณะพะดะฝั ะฒัะบะปััะธัั SwitchAudioSource, **ะพัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ ะฒัั ัะฐะฒะฝะพ ัะฐะฑะพัะฐะตั**, ะฟัะพััะพ ะผะพะถะตั ััะฐัั ะผะตะฝะตะต ะบัะฐัะธะฒะพะน ะฒ ะปะพะณะฐั/ะธะผะตะฝะฐั.

---

### 10.3 ะคะฐะทะฐ 2 โ ะะฒะตััะธ CoreAudioDeviceManager ะธ "ะพะฑะปะตะณัะธัั" DeviceChangePublisher

**ะฆะตะปั:** ะััะฐัะธัั ัะฐะฑะพัั ั Core Audio ะฒ ะพัะดะตะปัะฝัะน ัะปะพะน ะธ ะฟะตัะตััะฐัั ัะฐัะธัั ัะตัะตะท Publisher ะปะธัะฝะธะต ะพะฑัะทะฐะฝะฝะพััะธ.

#### ะจะฐะณ 2.1. ะะฒะตััะธ CoreAudioDeviceManager (ัะพะปัะบะพ ะฟัะพ CoreAudio)

**ะะดะต ัะพะทะดะฐัั:**
- `modules/audio_core/core_audio_device_manager.py` (ะฝะพะฒัะน ัะฐะนะป)

**ะะพะปั:**
ะัะฒะตัะฐะตั ัะพะปัะบะพ ะทะฐ **ะพะฟะธัะฐะฝะธะต ะผะธัะฐ CoreAudio**, ะฐ ะฝะต ะทะฐ PortAudio.

**ะงัะพ ะดะพะปะถะตะฝ ัะผะตัั ะปะพะณะธัะตัะบะธ (ะฑะตะท ะบะพะดะฐ):**

1. **ะะพะปััะธัั ัะตะบััะธะน ะดะตัะพะปัะฝัะน input/output:**
   - ะะพะทะฒัะฐัะฐัั ะพะฑัะตะบั `DeviceInfo` ั ะฟะพะปัะผะธ:
     - `core_audio_id` (AudioDeviceID)
     - `uid` (ัััะพะบะฐ, ัะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั)
     - `name` (ัััะพะบะฐ, ะธะผั ััััะพะนััะฒะฐ)
     - ะคะปะฐะณะธ (ะฝะฐะฟัะธะผะตั, `is_bluetooth`, `is_builtin`, `is_external`)

2. **ะะฟัะธะพะฝะฐะปัะฝะพ: ะฒะตัะฝััั ัะฟะธัะพะบ ะดะพัััะฟะฝัั ััััะพะนััะฒ** ั ัะฐะบะธะผะธ ะถะต ะฟะพะปัะผะธ

3. **ะะต ะทะฝะฐัั ะฝะธัะตะณะพ ะฟัะพ:**
   - PortAudio
   - EventBus
   - ะะฝัะตะณัะฐัะธะธ

**ะะฝัะตััะตะนั (ะบะพะฝัะตะฟััะฐะปัะฝะพ):**
```python
class CoreAudioDeviceManager:
    def get_default_input_device() -> DeviceInfo
    def get_default_output_device() -> DeviceInfo
    def get_available_devices(device_type: str) -> List[DeviceInfo]
    def is_bluetooth_device(device_info: DeviceInfo) -> bool
```

#### ะจะฐะณ 2.2. ะะฑะฝะพะฒะธัั DeviceChangePublisher โ ัะดะตะปะฐัั ะตะณะพ "ัะพะฝะบะธะผ"

**ะะดะต ะธะทะผะตะฝะธัั:**
- `modules/audio_core/device_change_publisher.py` โ `DeviceChangePublisher`

**ะงัะพ ะธะทะผะตะฝะธัั ะปะพะณะธัะตัะบะธ:**

1. **ะะฐะฒะธัะธะผะพััั:**
   - ะะพะฑะฐะฒะธัั ะทะฐะฒะธัะธะผะพััั ะฝะฐ `CoreAudioDeviceManager`
   - ะะตัะตััะฐัั ะฝะฐะฟััะผัั ะดะตัะณะฐัั PyObjC / CoreAudio API ะฒะฝัััะธ Publisher โ ะฒัั ะดะพะปะถะฝะพ ะธะดัะธ ัะตัะตะท ะผะตะฝะตะดะถะตั

2. **ะกะพััะพัะฝะธะต:**
   - ะะผะตััะพ ััะฐะฝะตะฝะธั ัััะพะบ (`_current_input_device_name`, `_current_output_device_name`)
   - ะฅัะฐะฝะธัั `DeviceInfo` (ะธะปะธ ัะพัั ะฑั `core_audio_id`/`uid`)

3. **ะะปะณะพัะธัะผ "ะดะตัะพะปั ะธะทะผะตะฝะธะปัั":**
   - ะะตัะธะพะดะธัะตัะบะธ (ะธะปะธ ะฟะพ ัะธะณะฝะฐะปะฐะผ Core Audio) ะฟะพะปััะฐัั `DeviceInfo` ะดะปั input/output
   - ะกัะฐะฒะฝะธะฒะฐัั **ะฟะพ `core_audio_id` ะธะปะธ `uid`**, ะฐ ะฝะต ะฟะพ ะธะผะตะฝะธ
   - ะัะธ ัะตะฐะปัะฝะพะผ ะธะทะผะตะฝะตะฝะธะธ:
     - ะะฑะฝะพะฒะปััั ัะฒะพั `_current_*_device`
     - ะัะฑะปะธะบะพะฒะฐัั ัะพะฑััะธะต ะฒ EventBus

4. **ะกะพะดะตัะถะฐะฝะธะต ัะพะฑััะธั:**
   - ะ ัะพะฑััะธะธ `device.default_output_changed` / `device.default_input_changed`:
     - ะัะตะณะดะฐ ะฟะตัะตะดะฐะฒะฐัั `core_audio_id`, `uid`, `name`, ัะปะฐะณะธ (BT ะธ ั.ะด.)
     - ะะต ะพะฑัะทะฐัะตะปัะฝะพ ะฟะตัะตะดะฐะฒะฐัั `portaudio_index` (ััะพ ัะถะต ะดะตัะฐะปั backend'ะฐ)

5. **ะงัะพ ัะฑัะฐัั:**
   - ะัั ะธะผัะฝ (`_device_name_cache`)
   - ะกะปะพะถะฝัะต guard'ั ะฒะพะบััะณ ะผะตะดะปะตะฝะฝะพะณะพ subprocess'ะฐ
   - ะัะทะพะฒั SwitchAudioSource ะธะท Publisher

**ะัะธัะตัะธะน ััะฟะตัะฐ:**
๐ DeviceChangePublisher:
- ะะธัะตะณะพ ะฝะต ะทะฝะฐะตั ะฟัะพ PortAudio
- ะะต ะทะฐะฒะธัะธั ะพั ะฒะฝะตัะฝะธั CLI
- ะัะพััะพ:
  - ะะตัะถะธั ัะตะบััะตะต ัะพััะพัะฝะธะต ััััะพะนััะฒ CoreAudio
  - ะกัะฐะฒะฝะธะฒะฐะตั ะธั
  - ะัะฑะปะธะบัะตั ัะพะฑััะธั

---

### 10.4 ะคะฐะทะฐ 3 โ ะฆะตะปะตะฒะฐั ะฐััะธัะตะบัััะฐ (ัััะบะธะต ะณัะฐะฝะธัั ะธ ะฟะพะปะธัะธะบะธ)

**ะฆะตะปั:** ะกะดะตะปะฐัั ะฐััะธัะตะบัััั "ัะธัะฐะฑะตะปัะฝะพะน ั ะปะธััะฐ": ะบัะพ ะทะฐ ััะพ ะพัะฒะตัะฐะตั, ะฑะตะท ัะบััััั ัะฒัะทะตะน.

#### ะจะฐะณ 3.1. AudioStreamManager ะบะฐะบ ะตะดะธะฝะฐั ัะพัะบะฐ ะฟัะฐะฒะดั ะดะปั ะฟะพัะพะบะพะฒ

**ะะดะต ะธะทะผะตะฝะธัั:**
- `modules/audio_core/stream_manager.py` โ `AudioStreamManager`

**ะะพะณะธะบะฐ:**

1. **ะะพะดะฟะธัะบะธ:**
   - ะะพะปััะฐะตั ะพั ะธะฝัะตะณัะฐัะธะน ัะธะณะฝะฐะป, ััะพ:
     - ะะฐัะฐะปะพัั ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต / ะทะฐะฟะธัั
     - ะัะธัะปะพ ัะพะฑััะธะต `device.default_*_changed`

2. **ะะพะฒะตะดะตะฝะธะต:**
   - ะัะปะธ ัะตะถะธะผ "ัะปะตะดัะตะผ ะทะฐ ัะธััะตะผะพะน":
     - ะัะธ ัะพะฑััะธะธ `device.default_*_changed`:
       - ะะฐะบัััั ััะฐััะน ัััะธะผ
       - ะัะบัััั ะฝะพะฒัะน, ะธัะฟะพะปัะทัั **ัะตะบััะธะน default device PortAudio** (ะฝะต ะธะผั ะธ ะฝะต ะฟััะผะพะน `portaudio_index` ะธะท ัะพะฑััะธะน)
   - ะัะปะธ ะฒ ะฑัะดััะตะผ ะฑัะดะตั ัะตะถะธะผ "ัะธะบัะธัะพะฒะฐะฝะฝะพะต ััััะพะนััะฒะพ":
     - ะฅัะฐะฝะธัั ะฒัะฑัะฐะฝะฝัะน `DeviceInfo`/ID
     - ะัะธ ัะพะฑััะธัั default'ะพะฒ โ ะปะธะฑะพ ะธะณะฝะพัะธัะพะฒะฐัั, ะปะธะฑะพ ะฟะตัะตะบะปััะฐัััั ัะพะปัะบะพ ะตัะปะธ ะฒัะฑัะฐะฝะฝะพะต ััััะพะนััะฒะพ ะฟัะพะฟะฐะปะพ

**ะะฐะถะฝะพ:**
AudioStreamManager โ ะตะดะธะฝััะฒะตะฝะฝะพะต ะผะตััะพ, ะณะดะต:
- ะะตัะฐะตััั, ะบะพะณะดะฐ ะฟะตัะตัะพะทะดะฐะฒะฐัั ะฟะพัะพะบ
- ะฃัะธััะฒะฐัััั ัะฐะนะผะธะฝะณะธ/ะพัะพะฑะตะฝะฝะพััะธ BT (ัะตัะตะท ะฟะพะปะธัะธะบั, ัะผ. ะฝะธะถะต)
- ะะฐะบะฐั ะบะพะฝัะธะณััะฐัะธั PortAudio ะธัะฟะพะปัะทัะตััั

#### ะจะฐะณ 3.2. ะัะฝะตััะธ ะฟะพะปะธัะธะบะธ (Bluetooth, ัะฐะนะผะธะฝะณะธ, ัะตััะฐะธ)

**ะะดะต ัะพะทะดะฐัั:**
- ะะพะฒัะน ะบะพะผะฟะพะฝะตะฝั: `modules/audio_core/device_policy.py` ะธะปะธ `modules/audio_core/audio_environment_policy.py`

**ะะพะปั:**

1. **ะะฐ ะฒัะพะด:**
   - `DeviceInfo` (ะธะปะธ ะฝะตัะบะพะปัะบะพ ััััะพะนััะฒ)
   - ะะพะฝัะตะบัั (input/output, ัะธะฟ ะดะตะนััะฒะธั โ ะทะฐะฟะธัั ะธะปะธ ะฟัะพะธะณััะฒะฐะฝะธะต)

2. **ะะฐ ะฒััะพะด:**
   - ะะฐัะฐะผะตััั ะฟะพะฒะตะดะตะฝะธั:
     - ะัะถะฝะพ ะปะธ ะดะพะฑะฐะฒะธัั ะทะฐะดะตัะถะบั ะฟะตัะตะด ััะฐััะพะผ (BT?)
     - ะกะบะพะปัะบะพ ัะตััะฐะตะฒ
     - ะะฐะบะพะน ัะฐะนะผะฐัั ะฝะฐ ะพะถะธะดะฐะฝะธะต ััััะพะนััะฒะฐ
     - ะัะถะฝะพ ะปะธ ะดะต-ะฑะพัะฝัะธัั ะฑัััััะต ะฟะตัะตะบะปััะตะฝะธั

**ะะฐะถะฝะพ:**
- DeviceChangePublisher, AudioStreamManager ะธ ะธะฝัะตะณัะฐัะธะธ **ะฝะต ะทะฝะฐัั, ะฟะพัะตะผั** ะธะผะตะฝะฝะพ ัะฐะบะธะต ัะฐะนะผะธะฝะณะธ โ ะพะฝะธ ะฟัะพััะพ ะฟะพะปัะทััััั ัะตะทัะปััะฐัะฐะผะธ ะฟะพะปะธัะธะบะธ
- ะญัะพ ะฟะพะทะฒะพะปะธั ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพ ะผะตะฝััั ะฟะพะฒะตะดะตะฝะธะต ะดะปั BT/USB/ะฒัััะพะตะฝะฝัั ััััะพะนััะฒ

**ะัะธะผะตั ะธะฝัะตััะตะนัะฐ (ะบะพะฝัะตะฟััะฐะปัะฝะพ):**
```python
class DevicePolicy:
    def get_close_delay(device_info: DeviceInfo) -> float
    def get_max_retries(device_info: DeviceInfo) -> int
    def get_timeout(device_info: DeviceInfo) -> float
    def should_debounce(device_info: DeviceInfo) -> bool
```

#### ะจะฐะณ 3.3. SwitchAudioSource ัะฑัะฐัั ะพะบะพะฝัะฐัะตะปัะฝะพ (ะธะปะธ ะพััะฐะฒะธัั ัะพะปัะบะพ ะดะปั dev-tools)

**ะะพะณะดะฐ:**
- CoreAudioDeviceManager ััะฐะฑะธะปะตะฝ
- DeviceChangePublisher ะธ AudioStreamManager ัะฐะฑะพัะฐัั ะฑะตะท ะทะฐะฒะธัะธะผะพััะตะน ะพั ะธะผะตะฝะธ ะธ CLI

**ะงัะพ ัะดะตะปะฐัั:**
- ะัะฟะธะปะธัั SwitchAudioSource ะธะท ะฟัะพะดะฐะบัะตะฝ-ะบะพะดะฐ
- ะัะปะธ ะพะฝ ะฝัะถะตะฝ ัะฐะทัะฐะฑะพััะธะบะฐะผ:
  - ะััะฐะฒะธัั ัะพะปัะบะพ ะฒ ะพัะดะตะปัะฝะพะผ ัะบัะธะฟัะต/CLI ะดะปั ัััะฝะพะน ะดะธะฐะณะฝะพััะธะบะธ

---

### 10.5 ะัะพะณ โ "ัััะบะพ, ะบัะพ ะทะฐ ััะพ ะพัะฒะตัะฐะตั"

**ะฆะตะปะตะฒะฐั ะฐััะธัะตะบัััะฐ:**

1. **CoreAudioDeviceManager**
   - ะะฟะธัะฐะฝะธะต ะผะธัะฐ macOS CoreAudio: ะบะฐะบะธะต ััััะพะนััะฒะฐ, ะบะฐะบะพะน ัะตะนัะฐั ะดะตัะพะปั
   - ะะต ะทะฝะฐะตั ะฟัะพ PortAudio, EventBus, ะธะฝัะตะณัะฐัะธะธ

2. **DeviceChangePublisher (v2)**
   - ะะฐะฑะปัะดะฐัะตะปั ะทะฐ ัะพััะพัะฝะธะตะผ ััััะพะนััะฒ:
     - ะกัะฐะฒะฝะธะป ะฝะพะฒะพะต ั ัะตะบััะธะผ
     - ะัะธ ัะตะฐะปัะฝะพะผ ะธะทะผะตะฝะตะฝะธะธ โ ะบะธะฝัะป ัะพะฑััะธะต ะฒ EventBus
   - ะะต ะทะฝะฐะตั ะฟัะพ PortAudio, SwitchAudioSource

3. **DevicePolicy / AudioEnvironment**
   - ะัะฒะตัะฐะตั ะทะฐ ัะพ, *ะบะฐะบ* ัะตะฑั ะฒะตััะธ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ััััะพะนััะฒะฐ (BT, ะฒัััะพะตะฝะฝะพะต, ะธ ั.ะฟ.)
   - ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะปะพะณะธะบะฐ ัะฐะนะผะธะฝะณะพะฒ ะธ ัะตััะฐะตะฒ

4. **AudioStreamManager**
   - ะะดะธะฝััะฒะตะฝะฝัะน "ะฒะปะฐะดะตะปะตั" ะฐัะดะธะพ-ะฟะพัะพะบะพะฒ:
     - ะัะบััะฒะฐะตั/ะทะฐะบััะฒะฐะตั/ะฟะตัะตัะพะทะดะฐัั
     - ะัะฟะพะปัะทัะตั PortAudio
     - ะะฟะธัะฐะตััั ะฝะฐ ัะพะฑััะธั ะพั Publisher ะธ ะฟะพะปะธัะธะบั

5. **SwitchAudioSource**
   - ะะธะฑะพ ะธััะตะทะฐะตั ะฟะพะปะฝะพัััั
   - ะะธะฑะพ ะถะธะฒัั ัะพะปัะบะพ ะฒ dev-ะธะฝััััะผะตะฝัะฐั

---

### 10.6 ะัะธัะตัะธะธ ััะฟะตัะฐ ัะตัะฐะบัะพัะธะฝะณะฐ

**ะคะฐะทะฐ 1:**
- โ ะะตัะตะบะปััะตะฝะธะต ััััะพะนััะฒ ัะฐะฑะพัะฐะตั ะฑะตะท SwitchAudioSource
- โ ะะพะณะธะบะฐ ะฝะต ะทะฐะฒะธัะธั ะพั ะธะผะตะฝะธ ััััะพะนััะฒะฐ ะดะปั ะฟัะธะฝััะธั ัะตัะตะฝะธะน
- โ ะะผั ะธัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะดะปั ะปะพะณะพะฒ ะธ UI

**ะคะฐะทะฐ 2:**
- โ CoreAudioDeviceManager ะธะทะพะปะธัะพะฒะฐะฝ ะธ ัะตััะธััะตะผ
- โ DeviceChangePublisher ะฝะต ะทะฝะฐะตั ะฟัะพ PortAudio ะธ SwitchAudioSource
- โ ะกะพะฑััะธั ัะพะดะตัะถะฐั ะฟะพะปะฝัั ะธะฝัะพัะผะฐัะธั ะพะฑ ััััะพะนััะฒะต (core_audio_id, uid, ัะปะฐะณะธ)

**ะคะฐะทะฐ 3:**
- โ ะงััะบะธะต ะณัะฐะฝะธัั ะพัะฒะตัััะฒะตะฝะฝะพััะธ ะผะตะถะดั ะบะพะผะฟะพะฝะตะฝัะฐะผะธ
- โ ะะพะปะธัะธะบะธ ัะตะฝััะฐะปะธะทะพะฒะฐะฝั ะธ ะปะตะณะบะพ ะธะทะผะตะฝัะตะผั
- โ SwitchAudioSource ัะดะฐะปัะฝ ะธะท ะฟัะพะดะฐะบัะตะฝ-ะบะพะดะฐ
- โ ะััะธัะตะบัััะฐ ัะธัะฐะฑะตะปัะฝะฐ "ั ะปะธััะฐ"

---

### 10.7 ะะธัะบะธ ะธ ะผะธัะธะณะฐัะธั

**ะะธัะบ 1: ะะตะณัะตััะธะธ ะฟัะธ ะผะธะณัะฐัะธะธ**
- **ะะธัะธะณะฐัะธั:** ะะพััะตะฟะตะฝะฝัะน rollout ัะตัะตะท feature flags, ััะฐัะตะปัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ะฝะฐ ะบะฐะถะดะพะผ ััะฐะฟะต

**ะะธัะบ 2: ะะตัะพะฒะผะตััะธะผะพััั Core Audio API**
- **ะะธัะธะณะฐัะธั:** ะกะพััะฐะฝะธัั fallback ะฝะฐ ัะตะบัััั ะปะพะณะธะบั, ะดะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบะธ ะดะพัััะฟะฝะพััะธ Core Audio

**ะะธัะบ 3: ะะพัะตัั ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ ะฟัะธ ัะดะฐะปะตะฝะธะธ SwitchAudioSource**
- **ะะธัะธะณะฐัะธั:** ะฃะฑะตะดะธัััั, ััะพ CoreAudioDeviceManager ะฟะพะบััะฒะฐะตั ะฒัะต ะฝะตะพะฑัะพะดะธะผัะต ัะปััะฐะธ ะฟะตัะตะด ัะดะฐะปะตะฝะธะตะผ

---

### 10.8 ะัะตะฝะบะฐ ััะธะปะธะน

**ะคะฐะทะฐ 1:** 2-3 ะดะฝั
- ะะตัะฐะบัะพัะธะฝะณ ะปะพะณะธะบะธ ะฟะตัะตะบะปััะตะฝะธั ััััะพะนััะฒ
- ะัะปะฐะฑะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะธ ะพั SwitchAudioSource

**ะคะฐะทะฐ 2:** 3-5 ะดะฝะตะน
- ะกะพะทะดะฐะฝะธะต CoreAudioDeviceManager
- ะะตัะฐะบัะพัะธะฝะณ DeviceChangePublisher
- ะขะตััะธัะพะฒะฐะฝะธะต ะธ ะฒะฐะปะธะดะฐัะธั

**ะคะฐะทะฐ 3:** 2-3 ะดะฝั
- ะัะฝะพั ะฟะพะปะธัะธะบ
- ะคะธะฝะฐะปัะฝะฐั ะพัะธััะบะฐ ะพั SwitchAudioSource
- ะะพะบัะผะตะฝัะฐัะธั ะธ ัะตััั

**ะัะพะณะพ:** 7-11 ะดะฝะตะน ัะฐะทัะฐะฑะพัะบะธ + ัะตััะธัะพะฒะฐะฝะธะต
