{
  "timestamp": "2025-11-14T18:32:41.177831",
  "total_requirements": 28,
  "with_implementation": 28,
  "with_verification": 28,
  "with_both": 28,
  "without_implementation": 0,
  "without_verification": 0,
  "gaps": [],
  "requirements": [
    {
      "id": "REQ-001",
      "domain": "Client Runtime / State Management",
      "criticality": "MUST",
      "description": "Все оси состояния (permissions.mic, device.input, network, firstRun, appMode и др.) должны быть зафиксированы в `Docs/STATE_CATALOG.md` с указанием владельцев, читателей/писателей и источников истины.",
      "implementation": "`Docs/STATE_CATALOG.md`, `integration/core/selectors.py`, `integration/core/gateways/`",
      "verification": "`scripts/verify_4_artifacts_invariant.py`, проверка синхронизации STATE_CATALOG ↔ interaction_matrix",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-002",
      "domain": "Client Runtime / State Management",
      "criticality": "MUST",
      "description": "Все правила взаимодействия осей с приоритетами (hard_stop, graceful, preference) должны быть зафиксированы в `config/interaction_matrix.yaml`.",
      "implementation": "`config/interaction_matrix.yaml`, `integration/core/gateways/`",
      "verification": "`scripts/verify_rule_coverage.py`, `tests/test_gateways.py`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-003",
      "domain": "Client Runtime / State Management",
      "criticality": "MUST",
      "description": "Все решения на основе осей состояния принимаются через gateway layer (`integration/core/gateways/`), а не через прямой доступ к состоянию.",
      "implementation": "`integration/core/selectors.py`, `integration/core/gateways/` (decision_engine.py, rule_loader.py, predicates.py, base.py, common.py, permission_gateways.py)",
      "verification": "`scripts/verify_no_direct_state_access.py`, `tests/test_gateways.py` (≥8–14 pairwise + 2 негативных)",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-004",
      "domain": "Client Runtime / State Management",
      "criticality": "MUST",
      "description": "Интеграции и модули не должны напрямую читать состояние через `state_manager.get_*`. Доступ только через selectors и gateways.",
      "implementation": "`pyproject.toml` (настройка линтера), `scripts/verify_no_direct_state_access.py`",
      "verification": "`scripts/verify_no_direct_state_access.py` (CI gate)",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-005",
      "domain": "Client Runtime / Logging",
      "criticality": "MUST",
      "description": "Все gateways обязаны логировать решения в формате: `decision=<start|abort|retry|degrade> ctx={mic=...,screen=...,device=...,network=...,firstRun=...,appMode=...} source=<domain> duration_ms=<int>`",
      "implementation": "`integration/core/gateways/` (все функции `decide_*`)",
      "verification": "`tests/test_gateways.py` (проверка формата логов в тестах)",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": false
    },
    {
      "id": "REQ-006",
      "domain": "Client Runtime / Initialization",
      "criticality": "MUST",
      "description": "Интеграции инициализируются в фиксированной последовательности: InstanceManager → HardwareId → FirstRunPermissions → PermissionRestart → Tray → ModeManagement → InputProcessing → VoiceRecognition → NetworkManager → InterruptManagement → ScreenshotCapture → GrpcClient → SpeechPlayback → Signals → Updater → AutostartManager → WelcomeMessage → VoiceOverDucking.",
      "implementation": "`integration/core/simple_module_coordinator.py::_create_integrations()`",
      "verification": "`scripts/run_release_suite.py`, логи инициализации",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": true
    },
    {
      "id": "REQ-007",
      "domain": "Client Runtime / Integration",
      "criticality": "MUST",
      "description": "Каждая интеграция должна иметь четкий контракт EventBus с документацией входных/выходных событий и payload схем.",
      "implementation": "README модулей, `integration/integrations/*.py` (комментарии CONTRACT)",
      "verification": "Ревью кода, проверка наличия контрактов",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": false
    },
    {
      "id": "REQ-008",
      "domain": "Client Runtime / Error Handling",
      "criticality": "MUST",
      "description": "Все ошибки обрабатываются через `error_handler.handle_error` с указанием контекста и кодов ошибок (E_INPUT_INVALID, E_STATE_INVAR, E_DEP_TIMEOUT, E_DEP_UNAVAILABLE, E_RATE_LIMITED, E_UNKNOWN).",
      "implementation": "`integration/core/error_handler.py`, все интеграции используют `error_handler.handle_error`",
      "verification": "Логи ошибок, проверка кодов ошибок",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-009",
      "domain": "Client Runtime / EventBus",
      "criticality": "MUST",
      "description": "Все инициирующие события включают `session_id` (строка uuid4) для трекинга цепочек в логах.",
      "implementation": "Все интеграции при публикации событий",
      "verification": "Логи событий, проверка наличия session_id",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": false
    },
    {
      "id": "REQ-010",
      "domain": "Permissions/TCC",
      "criticality": "MUST",
      "description": "При первом запуске приложение последовательно запрашивает разрешения: Microphone → Accessibility → Screen Capture с паузами между запросами (13 секунд по умолчанию).",
      "implementation": "`integration/integrations/first_run_permissions_integration.py`, `modules/permissions/first_run/*`",
      "verification": "`scripts/test_first_run_integration.sh`, `scripts/clear_first_run_flags.py`, логи first-run",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-011",
      "domain": "Permissions/TCC",
      "criticality": "MUST",
      "description": "После выдачи критических разрешений приложение автоматически перезапускается для применения новых разрешений.",
      "implementation": "`integration/integrations/permission_restart_integration.py`, `modules/permission_restart/core/restart_scheduler.py`, `modules/permission_restart/macos/permissions_restart_handler.py`",
      "verification": "`Docs/TAL_TESTING_CHECKLIST.md`, `scripts/check_tal_after_restart.py`, `scripts/test_restart_priority.sh`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-012",
      "domain": "Permissions/TCC / TAL",
      "criticality": "MUST",
      "description": "Приложение удерживает TAL (Termination Avoidance Lock) до момента готовности tray (`tray.ready`), обновляя hold каждые 30 секунд, таймаут 120 секунд.",
      "implementation": "`integration/core/simple_module_coordinator.py::_hold_tal_until_tray_ready()`",
      "verification": "`Docs/TAL_TESTING_CHECKLIST.md`, `scripts/check_tal_after_restart.py`, логи runningboardd",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": true
    },
    {
      "id": "REQ-013",
      "domain": "Permissions/TCC",
      "criticality": "SHOULD (TCC-AX-001)",
      "description": "Проверка Accessibility разрешения должна использовать публичный API `AXIsProcessTrustedWithOptions` вместо приватного `TCCAccessRequest`.",
      "implementation": "`modules/permission_restart/macos/permissions_restart_handler.py` (замена приватного API)",
      "verification": "Unit тесты, проверка отсутствия приватных API в коде",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": false
    },
    {
      "id": "REQ-014",
      "domain": "Permissions/TCC",
      "criticality": "MUST",
      "description": "Флаги first-run (`permissions_first_run_completed.flag`, `restart_completed.flag`) хранятся в `~/Library/Application Support/Nexy/`.",
      "implementation": "`modules/permissions/first_run/*`, `modules/permission_restart/core/atomic_flag.py`",
      "verification": "`scripts/clear_first_run_flags.py`, проверка наличия флагов",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-015",
      "domain": "Packaging",
      "criticality": "MUST",
      "description": "Единственный источник инструкций по сборке `.app`/PKG — `Docs/PACKAGING_FINAL_GUIDE.md`. Все чек-листы обязаны ссылаться на этот файл.",
      "implementation": "`Docs/PACKAGING_FINAL_GUIDE.md`, `rebuild_from_scratch.sh`, `packaging/build_final.sh`",
      "verification": "`Docs/PRE_PACKAGING_VERIFICATION.md`, `Docs/PACKAGING_READINESS_CHECKLIST.md`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": true
    },
    {
      "id": "REQ-016",
      "domain": "Packaging",
      "criticality": "MUST",
      "description": "PyInstaller собирает `.app` с включением всех ресурсов (ffmpeg, assets, конфиги) в `Contents/Resources/`.",
      "implementation": "`packaging/Nexy.spec`, `rebuild_from_scratch.sh`",
      "verification": "Проверка содержимого `dist/Nexy.app/Contents/Resources/`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-017",
      "domain": "Packaging",
      "criticality": "MUST",
      "description": "`.app` и `.pkg` подписываются Developer ID сертификатами и проходят нотарификацию через `notarytool`.",
      "implementation": "`packaging/build_final.sh`, команды `codesign`, `productsign`, `notarytool`",
      "verification": "`codesign -vvv`, `spctl -a -vv`, `stapler validate`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-018",
      "domain": "Packaging",
      "criticality": "MUST",
      "description": "Любые изменения, влияющие на рантайм, ресурсы, конфигурацию, зависимости или упаковку, сопровождаются заполненным Packaging Regression Checklist до ревью.",
      "implementation": "`Docs/PRE_PACKAGING_VERIFICATION.md`, `Docs/PACKAGING_READINESS_CHECKLIST.md`",
      "verification": "Проверка наличия checklist в PR",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-019",
      "domain": "Application Termination",
      "criticality": "MUST",
      "description": "Метод `applicationShouldTerminate` должен возвращать `False` для предотвращения автоматического завершения приложения.",
      "implementation": "`modules/tray_controller/macos/menu_handler.py::applicationShouldTerminate()`, `main.py::create_app()`",
      "verification": "`scripts/test_tray_termination.py`, `Docs/PRE_PACKAGING_VERIFICATION.md`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": true
    },
    {
      "id": "REQ-020",
      "domain": "Application Termination",
      "criticality": "MUST",
      "description": "Quit handler (`_setup_quit_handler()`) должен быть установлен до вызова `app.run()`.",
      "implementation": "`main.py::run()`, `modules/tray_controller/macos/menu_handler.py::_setup_quit_handler()`",
      "verification": "`scripts/test_tray_termination.py`, `Docs/PRE_PACKAGING_VERIFICATION.md`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": true
    },
    {
      "id": "REQ-021",
      "domain": "Feature Flags",
      "criticality": "MUST",
      "description": "Все feature flags и kill-switches должны быть зарегистрированы в `Docs/FEATURE_FLAGS.md` с указанием пути в коде и назначения.",
      "implementation": "`Docs/FEATURE_FLAGS.md`",
      "verification": "`scripts/verify_feature_flags.py` (если есть), ревью кода",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-022",
      "domain": "Feature Flags",
      "criticality": "MUST",
      "description": "Система first-run и permission-restart раскатывается через feature flags (`NEXY_FEATURE_FIRST_RUN_V2`, `NEXY_FEATURE_PERMISSION_RESTART_V2`) с kill-switches для мгновенного отката.",
      "implementation": "`config/unified_config.yaml`, `integration/integrations/first_run_permissions_integration.py`, `modules/permission_restart/core/restart_scheduler.py`",
      "verification": "Тесты feature flags, проверка kill-switches",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-023",
      "domain": "Testing / CI",
      "criticality": "MUST",
      "description": "Запрет прямого доступа к состоянию, валидация схем, проверка контрактов EventBus должны быть автоматизированы в CI.",
      "implementation": "`.github/workflows/ci.yml`, `scripts/verify_no_direct_state_access.py`, `scripts/validate_schemas.py`",
      "verification": "CI logs, проверка прогона скриптов",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-024",
      "domain": "Testing",
      "criticality": "MUST",
      "description": "Все gateways покрыты тестами с ≥8–14 pairwise комбинациями осей + 2 негативных теста, с проверкой decision-логов в каноническом формате.",
      "implementation": "`tests/test_gateways.py`",
      "verification": "`pytest tests/test_gateways.py`, проверка coverage",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-025",
      "domain": "Testing / State Management",
      "criticality": "MUST",
      "description": "Все оси из STATE_CATALOG.md присутствуют в interaction_matrix.yaml (если влияют на решения), все правила из interaction_matrix.yaml реализованы в gateways.",
      "implementation": "`scripts/verify_4_artifacts_invariant.py`, `scripts/verify_rule_coverage.py`",
      "verification": "Скрипты проверки синхронизации, CI gate",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-026",
      "domain": "Logging",
      "criticality": "MUST",
      "description": "Формат логов: `YYYY-MM-DD HH:MM:SS - Nexy - LEVEL - [session_id] - Message`. Структурированные события: `module.start|ok|fail` с session_id, duration_ms, контекстом.",
      "implementation": "`client/main.py` (настройка логирования), все модули",
      "verification": "Проверка формата логов, `Docs/AUDIO_LOGGING_CHECKLIST.md`",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": false,
      "verification_exists": true
    },
    {
      "id": "REQ-027",
      "domain": "Observability",
      "criticality": "MUST",
      "description": "Все метрики зарегистрированы в `client/metrics/registry.md` с SLO порогами (например, `p95 start_listening ≤ 600ms`, `stream_open_success_rate ≥ 98%`).",
      "implementation": "`client/metrics/registry.md`",
      "verification": "`tests/perf/test_slo.py` (если есть), проверка метрик",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    },
    {
      "id": "REQ-028",
      "domain": "Deployment",
      "criticality": "SHOULD (GAP-001)",
      "description": "`Docs/GLOBAL_DELIVERY_PLAN.md` должен содержать детали Azure/AppCast rollout и deployment шагов.",
      "implementation": "`Docs/GLOBAL_DELIVERY_PLAN.md`",
      "verification": "Ревью документа, проверка полноты",
      "has_implementation": true,
      "has_verification": true,
      "implementation_exists": true,
      "verification_exists": false
    }
  ],
  "implementation_coverage_percent": 100.0,
  "verification_coverage_percent": 100.0,
  "both_coverage_percent": 100.0
}
