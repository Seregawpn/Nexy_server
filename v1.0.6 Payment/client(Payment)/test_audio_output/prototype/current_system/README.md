# Текущая система работы с аудио устройствами

## Цель

Эта директория содержит **полную копию текущей логики** работы с аудио устройствами, адаптированную для независимого запуска.

**ВАЖНО**: Это baseline версия - без изменений! Сначала нужно убедиться, что она работает идеально, и только потом экспериментировать с улучшениями.

## Структура

```
current_system/
├── device_params_normalizer.py  # Нормализация параметров устройств
├── audio_device_monitor.py       # Мониторинг изменений устройств
├── test_current_system.py        # Базовые тесты для валидации baseline
├── test_bluetooth_scenarios.py   # Тесты проблемных сценариев с BT
└── README.md                     # Этот файл
```

## Компоненты

### 1. DeviceParamsNormalizer

Нормализует параметры устройств к внутреннему формату Nexy:
- OUTPUT: максимум 2 канала, sample rate в диапазоне [16000-48000]
- INPUT: всегда 1 канал (mono), target_rate = 16 kHz

### 2. AudioDeviceMonitor

Мониторит изменения input устройств:
- Проверяет устройство каждые 0.5 сек
- Сравнивает по имени (не по ID)
- Уведомляет через callback при смене устройства

## Запуск тестов

### Базовые тесты

```bash
# Перейти в директорию
cd test_audio_output/prototype/current_system/

# Запустить базовые тесты
python3 test_current_system.py
```

### Тесты проблемных сценариев с Bluetooth

```bash
# Запустить тесты проблемных сценариев
python3 test_bluetooth_scenarios.py
```

**Важно**: Эти тесты требуют интерактивного участия:
- Подключение/отключение Bluetooth устройств
- Нажатие Enter в нужные моменты

### Мониторинг в реальном времени (прямой эфир)

```bash
# Мониторинг на 60 секунд (по умолчанию)
python3 test_live_monitoring.py

# Мониторинг на 120 секунд
python3 test_live_monitoring.py --duration 120

# Мониторинг с интервалом проверки 1 секунда
python3 test_live_monitoring.py --interval 1.0

# Комбинация параметров
python3 test_live_monitoring.py --duration 60 --interval 0.5
```

**Что отслеживает:**
- ✅ Переключения устройств (имя, ID)
- ✅ Изменения частоты (sample rate)
- ✅ Изменения каналов
- ✅ Источник данных (SwitchAudioSource, PortAudio)
- ✅ Время каждого изменения

**Как использовать:**
1. Запустите тест
2. Во время работы теста:
   - Подключайте/отключайте Bluetooth устройства
   - Переключайте default устройство в системных настройках macOS
   - Наблюдайте за изменениями в реальном времени
3. В конце тест выведет полную статистику

## Известные проблемы (baseline)

Эти проблемы должны воспроизводиться в прототипе:

1. **Race condition при подключении BT**: PortAudio кэш может быть устаревшим
   - Тест: `test_race_condition_bt_connection()`
   - Ожидаемое поведение: Устройство может не найтись сразу в PortAudio

2. **Устаревший кэш**: Новые устройства не видны до перезапуска
   - Тест: `test_stale_cache()`
   - Ожидаемое поведение: Новое устройство не появится в списке без обновления кэша

3. **Несинхронизация источников**: SwitchAudioSource и PortAudio могут расходиться
   - Тест: `test_source_synchronization()`
   - Ожидаемое поведение: Разные результаты от разных источников

4. **Задержка инициализации BT**: Устройствам нужно время на инициализацию
   - Проявляется при создании потоков

## Результаты тестирования

После запуска тестов зафиксируйте:
- Какие проблемы воспроизводятся
- В каких сценариях они проявляются
- Частота возникновения проблем

Эти данные будут использованы как baseline для сравнения с улучшенными версиями.

## Следующие шаги

После успешной валидации baseline:
1. Зафиксировать все известные проблемы
2. Создать `../improvements/` для экспериментов
3. Постепенно добавлять улучшения и сравнивать с baseline
