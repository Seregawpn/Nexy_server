# üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã (10-15 —à—Ç—É–∫)

> **–¶–µ–ª—å:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
> **–û—Å–Ω–æ–≤–∞:** `COMPLETE_SYSTEM_LOGIC.md`

---

## TC-1: Webhook Duplicate (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ webhook –¥–≤–∞–∂–¥—ã

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_succeeded` —Å `stripe_event_id=evt_123`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ `invoice.payment_succeeded` —Å `stripe_event_id=evt_123` –ø–æ–≤—Ç–æ—Ä–Ω–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–µ—Ä–≤—ã–π —Ä–∞–∑: —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid`, —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `subscription_events`
- –í—Ç–æ—Ä–æ–π —Ä–∞–∑: —Å–æ–±—ã—Ç–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (UNIQUE constraint), –ë–î –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –õ–æ–≥: "Duplicate event evt_123, skipping"

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `INSERT ... ON CONFLICT (stripe_event_id) DO NOTHING` —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ë–î –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ

---

## TC-2: Webhook Out-of-Order (–ø–æ—Ä—è–¥–æ–∫ —Å–æ–±—ã—Ç–∏–π)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –°–æ–±—ã—Ç–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_succeeded` (created_at=100)
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `checkout.session.completed` (created_at=50) - –±–æ–ª–µ–µ —Å—Ç–∞—Ä–æ–µ —Å–æ–±—ã—Ç–∏–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û–±–∞ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `subscription_events`
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `created_at`: —Å–Ω–∞—á–∞–ª–∞ `checkout.session.completed`, –ø–æ—Ç–æ–º `invoice.payment_succeeded`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ: —Å–Ω–∞—á–∞–ª–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ customer/subscription, –ø–æ—Ç–æ–º —Å—Ç–∞—Ç—É—Å `paid`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–æ–±—ã—Ç–∏—è —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ `created_at` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ

---

## TC-3: Webhook Signature Verification

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Stripe webhooks

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å webhook —Å –≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å webhook —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å webhook –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–∞–ª–∏–¥–Ω–∞—è –ø–æ–¥–ø–∏—Å—å: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –ø–æ–¥–ø–∏—Å—å: HTTP 400, –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –≤ –ë–î, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ security
- –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏: HTTP 400, –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `stripe.Webhook.construct_event()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Replay –∑–∞—â–∏—Ç–∞: —Å–æ–±—ã—Ç–∏—è —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

---

## TC-4: `checkout.session.completed` ‚â† –æ–ø–ª–∞—Ç–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ `checkout.session.completed` –Ω–µ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `checkout.session.completed` (—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ customer/subscription)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ë–î
3. –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `invoice.payment_succeeded`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ `checkout.session.completed`: —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º (–ù–ï `paid`), —Ç–æ–ª—å–∫–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `invoice.payment_succeeded`: —Å—Ç–∞—Ç—É—Å = `paid`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°—Ç–∞—Ç—É—Å –ù–ï –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid` –ø–æ—Å–ª–µ `checkout.session.completed`
- –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid` —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `invoice.payment_succeeded`

---

## TC-5: –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `paid` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ `paid`

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `customer.subscription.updated` status=`active`
2. –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_succeeded`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `invoice.payment_succeeded` - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (–≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å)
- `customer.subscription.updated` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `invoice.payment_succeeded` –µ—â–µ –Ω–µ –ø—Ä–∏—à–µ–ª)
- –ï—Å–ª–∏ –æ–±–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç: `invoice.payment_succeeded` –ø–æ–±–µ–∂–¥–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç `invoice.payment_succeeded` > `customer.subscription.updated`

---

## TC-6: `cancel_at_period_end` –ª–æ–≥–∏–∫–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–∞ –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞

**–®–∞–≥–∏:**
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É "Cancel subscription"
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–æ `current_period_end`
3. –î–æ–∂–¥–∞—Ç—å—Å—è `current_period_end`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ `current_period_end`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã: `cancel_at_period_end=True`, —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è `paid`
- –î–æ `current_period_end`: –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –∫–≤–æ—Ç—ã –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ
- –ü–æ—Å–ª–µ `current_period_end`: —Å—Ç–∞—Ç—É—Å = `limited_free_trial`, –∫–≤–æ—Ç—ã 5/25/50

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –î–æ `current_period_end` –¥–æ—Å—Ç—É–ø –ø–æ–ª–Ω—ã–π
- –ü–æ—Å–ª–µ `current_period_end` ‚Üí `limited_free_trial`

---

## TC-7: `invoice.payment_failed` ‚Üí `billing_problem` ‚Üí `limited_free_trial`

**–°—Ü–µ–Ω–∞—Ä–∏–π:** Grace period –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_failed`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –¥–æ—Å—Ç—É–ø
3. –î–æ–∂–¥–∞—Ç—å—Å—è –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period (1 –¥–µ–Ω—å)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ grace period

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ `invoice.payment_failed`: —Å—Ç–∞—Ç—É—Å = `billing_problem`, `grace_period_end_at=now()+1day`
- –î–æ `grace_period_end_at`: –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø (–∫–∞–∫ —É `paid`)
- –ü–æ—Å–ª–µ `grace_period_end_at`: —Å—Ç–∞—Ç—É—Å = `limited_free_trial`, –∫–≤–æ—Ç—ã 5/25/50

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Grace period = —Ä–æ–≤–Ω–æ 1 –¥–µ–Ω—å (24 —á–∞—Å–∞)
- –î–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period - –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è - `limited_free_trial`

---

## TC-8: `invoice.payment_failed` ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Üí `paid`

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –≤ —Ç–µ—á–µ–Ω–∏–µ grace period

**–®–∞–≥–∏:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_failed` ‚Üí —Å—Ç–∞—Ç—É—Å = `billing_problem`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç payment method
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_succeeded`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ `invoice.payment_succeeded`: —Å—Ç–∞—Ç—É—Å = `paid`, `grace_period_end_at=NULL`
- –î–æ—Å—Ç—É–ø –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Grace period –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- –°—Ç–∞—Ç—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `paid`

---

## TC-9: –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –∫–≤–æ—Ç (–≥–æ–Ω–∫–∏)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –æ–±—Ö–æ–¥–∏—Ç—å –ª–∏–º–∏—Ç—ã

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `limited_free_trial` —Å–¥–µ–ª–∞–ª 4 –∑–∞–ø—Ä–æ—Å–∞ (4/5)
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (5-–π –∏ 6-–π)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç (5-–π, –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ –ª–∏–º–∏—Ç–µ)
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (6-–π, –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç)
- –°—á—ë—Ç—á–∏–∫ = 5 (–Ω–µ 6)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `INSERT ... ON CONFLICT` –∏–ª–∏ `SELECT FOR UPDATE` —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

---

## TC-10: Cooldown –Ω–∞ Checkout (24 —á–∞—Å–∞)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** Anti-spam –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Checkout

**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å Checkout Session (–≤—Ä–µ–º—è T)
2. –ß–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
3. –ß–µ—Ä–µ–∑ 25 —á–∞—Å–æ–≤ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ß–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤: –≤–æ–∑–≤—Ä–∞—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞) –∏–ª–∏ –æ—Ç–∫–∞–∑
- –ß–µ—Ä–µ–∑ 25 —á–∞—Å–æ–≤: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Cooldown = 24 —á–∞—Å–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Å–ø–æ—Å–æ–±–∞–º —Å–æ–∑–¥–∞–Ω–∏—è Checkout (–∞–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ, –∫–æ–º–∞–Ω–¥–∞ "subscribe")

---

## TC-11: –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è —Å–æ Stripe

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏

**–®–∞–≥–∏:**
1. –í –ë–î: —Å—Ç–∞—Ç—É—Å `paid`, `stripe_subscription_id=sub_123`
2. –í Stripe: –ø–æ–¥–ø–∏—Å–∫–∞ `sub_123` –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å `canceled`
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—é

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Stripe –ø–æ–±–µ–∂–¥–∞–µ—Ç (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- –ë–î –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: —Å—Ç–∞—Ç—É—Å = `limited_free_trial`, `stripe_status='canceled'`
- –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Stripe –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö

---

## TC-12: `limited_free_trial` –±–µ—Å—Å—Ä–æ—á–Ω–æ

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ `limited_free_trial` –Ω–µ –∏–º–µ–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è

**–®–∞–≥–∏:**
1. –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `limited_free_trial`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–µ `limited_free_trial_end_at` –≤ –ë–î

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `limited_free_trial_end_at = NULL` (–±–µ—Å—Å—Ä–æ—á–Ω–æ)
- –ö–≤–æ—Ç—ã 5/25/50 –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ—Å—Å—Ä–æ—á–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ù–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è `limited_free_trial`
- –ö–≤–æ—Ç—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

---

## TC-13: Trial Warning (2 –¥–Ω—è, 1 –¥–µ–Ω—å, –¥–µ–Ω—å –æ–∫–æ–Ω—á–∞–Ω–∏—è)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏ trial

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `paid_trial`, –æ—Å—Ç–∞–ª–æ—Å—å 2 –¥–Ω—è
2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–Ω—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
3. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Ç–æ–≥–æ –∂–µ –¥–Ω—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
4. –û—Å—Ç–∞–ª–æ—Å—å 1 –¥–µ–Ω—å ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
5. –î–µ–Ω—å –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞ 2 –¥–Ω—è: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å
- –ó–∞ 1 –¥–µ–Ω—å: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å
- –í –¥–µ–Ω—å –æ–∫–æ–Ω—á–∞–Ω–∏—è: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ Checkout
- `last_trial_warning_date` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ LLM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –†–∞—Å—á–µ—Ç –¥–Ω–µ–π: `(paid_trial_end_at.date() - utc_today).days`
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å

---

## TC-14: Anti-Abuse (–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–±–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤

**–®–∞–≥–∏:**
1. –ù–æ–≤—ã–π `hardware_id` ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è `paid_trial`
2. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–µ–º –∂–µ `hardware_id`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
- –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π `paid_trial`
- –ï—Å–ª–∏ `paid_trial` –∏—Å—Ç–µ–∫ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ trial
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π trial –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `hardware_id`

---

## TC-15: –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ö—ç—à –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `limited_free_trial`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice.payment_succeeded`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
4. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Webhook –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
- –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î (–∫—ç—à –ø—Ä–æ–º–∞—Ö)
- –°—Ç–∞—Ç—É—Å = `paid` –≤ –æ—Ç–≤–µ—Ç–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π webhook, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è–µ—Ç –¥–æ—Å—Ç—É–ø
- TTL = 30 —Å–µ–∫—É–Ω–¥
- –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

| –¢–µ—Å—Ç-–∫–µ–π—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|-----------|------------|--------|
| TC-1: Webhook Duplicate | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-2: Webhook Out-of-Order | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-3: Signature Verification | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-4: checkout.completed ‚â† paid | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-5: –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã paid | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-6: cancel_at_period_end | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-7: payment_failed ‚Üí billing_problem | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-8: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-9: –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –∫–≤–æ—Ç | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-10: Cooldown Checkout | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-11: –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚ö†Ô∏è |
| TC-12: limited_free_trial –±–µ—Å—Å—Ä–æ—á–Ω–æ | üü† –í–∞–∂–Ω—ã–π | ‚ö†Ô∏è |
| TC-13: Trial Warning | üü† –í–∞–∂–Ω—ã–π | ‚ö†Ô∏è |
| TC-14: Anti-Abuse | üü† –í–∞–∂–Ω—ã–π | ‚ö†Ô∏è |
| TC-15: –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è | üü† –í–∞–∂–Ω—ã–π | ‚ö†Ô∏è |

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã (TC-1 –¥–æ TC-11) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:**
- ‚úÖ –ü–æ–∫—Ä—ã—Ç—ã unit —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ü–æ–∫—Ä—ã—Ç—ã integration —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ü–æ–∫—Ä—ã—Ç—ã E2E —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ü—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

**–í–∞–∂–Ω—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã (TC-12 –¥–æ TC-15):**
- ‚úÖ –ü–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ü—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

---

**–°—Ç–∞—Ç—É—Å:** üìù –ö—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –∏–∑ 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ —Å–æ–∑–¥–∞–Ω

