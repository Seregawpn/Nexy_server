# ğŸ¯ Ğ¡Ñ…ĞµĞ¼Ğ° Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

**Ğ”Ğ°Ñ‚Ğ°:** 2025-01-22  
**Feature ID:** F-2025-017-stripe-payment  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0.6

---

## ğŸ“Š ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞšĞ›Ğ˜Ğ•ĞĞ¢ (macOS Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PaymentIntegration                                       â”‚  â”‚
â”‚  â”‚  â€¢ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° deep links (nexy://payment/*)               â”‚  â”‚
â”‚  â”‚  â€¢ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ActionExecutionIntegration                               â”‚  â”‚
â”‚  â”‚  â€¢ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ open_url                            â”‚  â”‚
â”‚  â”‚  â€¢ ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Stripe Checkout/Portal Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ gRPC
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ¡Ğ•Ğ Ğ’Ğ•Ğ                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  StreamingWorkflowIntegration                           â”‚  â”‚
â”‚  â”‚  â€¢ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸                              â”‚  â”‚
â”‚  â”‚  â€¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ²Ğ¾Ñ‚ (check_quota)                          â”‚  â”‚
â”‚  â”‚  â€¢ Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (increment_usage)             â”‚  â”‚
â”‚  â”‚  â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° action_message Ñ open_url                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SubscriptionModule                                       â”‚  â”‚
â”‚  â”‚  â€¢ create_checkout()                                     â”‚  â”‚
â”‚  â”‚  â€¢ cancel_subscription()                                 â”‚  â”‚
â”‚  â”‚  â€¢ get_portal_url()                                      â”‚  â”‚
â”‚  â”‚  â€¢ check_quota()                                         â”‚  â”‚
â”‚  â”‚  â€¢ increment_usage()                                     â”‚  â”‚
â”‚  â”‚  â€¢ get_subscription_context()                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebhookHandler                                          â”‚  â”‚
â”‚  â”‚  â€¢ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Stripe                              â”‚  â”‚
â”‚  â”‚  â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ State Machine Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ²             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SubscriptionStateMachine                                 â”‚  â”‚
â”‚  â”‚  â€¢ Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²                    â”‚  â”‚
â”‚  â”‚  â€¢ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ²                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SubscriptionRepository                                  â”‚  â”‚
â”‚  â”‚  â€¢ CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ‘Ğ”                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ PostgreSQL
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…   â”‚
                    â”‚  subscriptions  â”‚
                    â”‚  payments       â”‚
                    â”‚  webhook_events â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ API
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Stripe API     â”‚
                    â”‚  â€¢ Checkout    â”‚
                    â”‚  â€¢ Portal      â”‚
                    â”‚  â€¢ Webhooks    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (create_subscription)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° "create_subscription"
    â”‚
    â–¼
StreamingWorkflowIntegration
    â”‚
    â–¼
SubscriptionModule.create_checkout()
    â”‚
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    â”œâ”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Stripe Customer (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
    â”œâ”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Checkout Session ($20/Ğ¼ĞµÑÑÑ†)
    â”œâ”€â†’ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ deep links:
    â”‚   â€¢ success_url: nexy://payment/checkout/success?session_id=...
    â”‚   â€¢ cancel_url: nexy://payment/checkout/cancel
    â”œâ”€â†’ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”:
    â”‚   â€¢ stripe_customer_id
    â”‚   â€¢ last_checkout_created_at
    â”‚   â€¢ last_checkout_session_id
    â””â”€â†’ Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºÑÑˆĞ°
    â”‚
    â–¼
action_message Ñ open_url â†’ ĞšĞ»Ğ¸ĞµĞ½Ñ‚
    â”‚
    â–¼
ActionExecutionIntegration._handle_open_url()
    â”‚
    â–¼
ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° Ñ Checkout URL
    â”‚
    â–¼
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ² Stripe
    â”‚
    â–¼
Stripe â†’ Webhook: checkout.session.completed
    â”‚
    â–¼
WebhookHandler._handle_checkout_completed()
    â”‚
    â”œâ”€â†’ State Machine: Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² 'paid_trial'
    â”œâ”€â†’ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ stripe_subscription_id
    â”œâ”€â†’ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° paid_trial_end_at (7 Ğ´Ğ½ĞµĞ¹)
    â””â”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ payment
    â”‚
    â–¼
ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· deep link
    â”‚
    â–¼
PaymentIntegration._handle_payment_success()
    â”‚
    â”œâ”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ payment.success
    â””â”€â†’ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ‡ĞµÑ€ĞµĞ· gRPC
```

### 2. ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (cancel_subscription)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° "cancel_subscription"
    â”‚
    â–¼
SubscriptionModule.cancel_subscription()
    â”‚
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    â”œâ”€â†’ Ğ’Ñ‹Ğ·Ğ¾Ğ² Stripe API: cancel_at_period_end=True
    â”œâ”€â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ‘Ğ”:
    â”‚   â€¢ cancel_at_period_end = True
    â”‚   â€¢ status = 'paid' (Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°)
    â””â”€â†’ Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºÑÑˆĞ°
    â”‚
    â–¼
Stripe â†’ Webhook: customer.subscription.updated
    â”‚
    â–¼
WebhookHandler._handle_subscription_updated()
    â”‚
    â”œâ”€â†’ State Machine: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
    â””â”€â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ stripe_status Ğ² Ğ‘Ğ”
    â”‚
    â–¼
Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° â†’ customer.subscription.deleted
    â”‚
    â–¼
WebhookHandler._handle_subscription_deleted()
    â”‚
    â””â”€â†’ State Machine: Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² 'limited_free_trial'
```

### 3. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ (manage_subscription)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° "manage_subscription"
    â”‚
    â–¼
SubscriptionModule.get_portal_url()
    â”‚
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° stripe_customer_id
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° stripe_subscription_id
    â”œâ”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Portal Session Ğ² Stripe
    â””â”€â†’ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ deep link:
        â€¢ return_url: nexy://payment/portal_return
    â”‚
    â–¼
action_message Ñ open_url â†’ ĞšĞ»Ğ¸ĞµĞ½Ñ‚
    â”‚
    â–¼
ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° Ñ Portal URL
    â”‚
    â–¼
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ Ğ² Stripe
    â”‚
    â–¼
ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· deep link
    â”‚
    â–¼
PaymentIntegration._handle_portal_return()
    â”‚
    â”œâ”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ payment.portal_return
    â””â”€â†’ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ‡ĞµÑ€ĞµĞ· gRPC
```

### 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ²Ğ¾Ñ‚ (check_quota)

```
Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    â”‚
    â–¼
StreamingWorkflowIntegration.process_request_streaming()
    â”‚
    â”œâ”€â†’ SubscriptionModule.check_quota(hardware_id)
    â”‚   â”‚
    â”‚   â”œâ”€â†’ QuotaChecker.check_quota()
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â†’ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¸Ğ· Ğ‘Ğ”
    â”‚   â”‚   â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°:
    â”‚   â”‚   â”‚   â€¢ paid_trial, paid, admin_active, grandfathered â†’ allowed=True
    â”‚   â”‚   â”‚   â€¢ billing_problem â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° grace_period
    â”‚   â”‚   â”‚   â€¢ limited_free_trial â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²:
    â”‚   â”‚   â”‚     - daily: 5 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    â”‚   â”‚   â”‚     - weekly: 25 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    â”‚   â”‚   â”‚     - monthly: 50 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    â”‚   â”‚   â””â”€â†’ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑĞ±Ñ€Ğ¾Ñ daily, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
    â”‚   â”‚
    â”‚   â””â”€â†’ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°:
    â”‚       â€¢ allowed: bool
    â”‚       â€¢ reason: str
    â”‚       â€¢ limits: dict (ĞµÑĞ»Ğ¸ limited_free_trial)
    â”‚
    â”œâ”€â†’ Ğ•ÑĞ»Ğ¸ allowed=False:
    â”‚   â””â”€â†’ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    â”‚
    â””â”€â†’ Ğ•ÑĞ»Ğ¸ allowed=True:
        â””â”€â†’ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
            â”‚
            â–¼
        ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸:
            â”‚
            â””â”€â†’ SubscriptionModule.increment_usage()
                â”‚
                â””â”€â†’ QuotaChecker.increment_usage()
                    â”‚
                    â””â”€â†’ Repository.increment_usage()
                        â”‚
                        â””â”€â†’ UPDATE subscriptions SET
                            usage_daily_count = usage_daily_count + 1,
                            usage_weekly_count = usage_weekly_count + 1,
                            usage_monthly_count = usage_monthly_count + 1
```

---

## ğŸ”€ State Machine: ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ’ĞĞ›Ğ˜Ğ”ĞĞ«Ğ• Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡Ğ«                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ paid_trial          - ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (7 Ğ´Ğ½ĞµĞ¹)           â”‚
â”‚  â€¢ paid                - ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°          â”‚
â”‚  â€¢ billing_problem     - ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¾Ğ¹                â”‚
â”‚  â€¢ limited_free_trial   - ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿    â”‚
â”‚  â€¢ admin_active         - ĞĞ´Ğ¼Ğ¸Ğ½ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ (Ğ½ĞµĞ¸Ğ·Ğ¼ĞµĞ½ÑĞµĞ¼Ñ‹Ğ¹)    â”‚
â”‚  â€¢ grandfathered       - Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ (Ğ½ĞµĞ¸Ğ·Ğ¼ĞµĞ½ÑĞµĞ¼Ñ‹Ğ¹) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ’ĞĞ›Ğ˜Ğ”ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•Ğ¥ĞĞ”Ğ«                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ]                                       â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  paid_trial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚       â”‚                   â”‚                              â”‚  â”‚
â”‚       â”‚ (Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°)          â”‚ (Ğ¸ÑÑ‚ĞµĞº trial)               â”‚  â”‚
â”‚       â–¼                   â–¼                              â”‚  â”‚
â”‚     paid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º limited_free_trial â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                   â–²                              â”‚  â”‚
â”‚       â”‚ (Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹) â”‚ (Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°)                     â”‚  â”‚
â”‚       â–¼                   â”‚                              â”‚  â”‚
â”‚  billing_problem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ (Ğ¸ÑÑ‚ĞµĞº grace period)                                â”‚
â”‚       â–¼                                                      â”‚
â”‚  limited_free_trial                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ¯ Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ•Ğ¥ĞĞ”ĞĞ’                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  checkout.session.completed                                 â”‚
â”‚       â†’ paid_trial (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)                      â”‚
â”‚                                                              â”‚
â”‚  invoice.payment_succeeded                                   â”‚
â”‚       â†’ paid (Ğ¸Ğ· paid_trial Ğ¸Ğ»Ğ¸ billing_problem)            â”‚
â”‚                                                              â”‚
â”‚  invoice.payment_failed                                      â”‚
â”‚       â†’ billing_problem (Ğ¸Ğ· paid)                           â”‚
â”‚                                                              â”‚
â”‚  customer.subscription.updated (past_due)                   â”‚
â”‚       â†’ billing_problem (Ğ¸Ğ· paid)                           â”‚
â”‚                                                              â”‚
â”‚  customer.subscription.deleted                               â”‚
â”‚       â†’ limited_free_trial (Ğ¸Ğ· Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°)              â”‚
â”‚                                                              â”‚
â”‚  trial_expired (Trial Handler)                              â”‚
â”‚       â†’ limited_free_trial (Ğ¸Ğ· paid_trial)                  â”‚
â”‚                                                              â”‚
â”‚  grace_period_expired (Grace Period Handler)                â”‚
â”‚       â†’ limited_free_trial (Ğ¸Ğ· billing_problem)             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ (Cron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞšĞĞ–Ğ”Ğ«Ğ• 6 Ğ§ĞĞ¡ĞĞ’                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  TrialExpirationHandler.check_expired_trials()               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚ĞµĞºÑˆĞ¸Ñ… paid_trial                     â”‚
â”‚       â”œâ”€â†’ State Machine: Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² limited_free_trial       â”‚
â”‚       â”œâ”€â†’ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹ (2 Ğ´Ğ½Ñ, 1 Ğ´ĞµĞ½ÑŒ, Ğ¸ÑÑ‚ĞµĞº)    â”‚
â”‚       â””â”€â†’ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° auto-checkout (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ cooldown)        â”‚
â”‚                                                              â”‚
â”‚  GracePeriodHandler.check_expired_grace_periods()           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚ĞµĞºÑˆĞ¸Ñ… billing_problem                â”‚
â”‚       â”œâ”€â†’ State Machine: Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² limited_free_trial       â”‚
â”‚       â””â”€â†’ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞšĞĞ–Ğ”Ğ«Ğ™ Ğ§ĞĞ¡                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  StripeSyncService.sync_all_subscriptions()                  â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº Ñ stripe_subscription_id       â”‚
â”‚       â”œâ”€â†’ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Stripe API                       â”‚
â”‚       â”œâ”€â†’ Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² (Ğ‘Ğ” vs Stripe)                 â”‚
â”‚       â”œâ”€â†’ State Machine: Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹ Ğ¿Ñ€Ğ¸ Ñ€Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸ÑÑ…          â”‚
â”‚       â”œâ”€â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹:                                 â”‚
â”‚       â”‚   â€¢ stripe_status                                    â”‚
â”‚       â”‚   â€¢ current_period_end                               â”‚
â”‚       â”‚   â€¢ cancel_at_period_end                             â”‚
â”‚       â”‚   â€¢ payment_method_id                                â”‚
â”‚       â””â”€â†’ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº (404)                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ•Ğ–Ğ•Ğ”ĞĞ•Ğ’ĞĞ (00:00)                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  QuotaChecker.reset_daily_counters()                         â”‚
â”‚       â”‚                                                      â”‚
â”‚       â””â”€â†’ Ğ¡Ğ±Ñ€Ğ¾Ñ usage_daily_count Ğ´Ğ»Ñ limited_free_trial    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ•Ğ–Ğ•ĞĞ•Ğ”Ğ•Ğ›Ğ¬ĞĞ (ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº 00:00)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  QuotaChecker.reset_weekly_counters()                        â”‚
â”‚       â”‚                                                      â”‚
â”‚       â””â”€â†’ Ğ¡Ğ±Ñ€Ğ¾Ñ usage_weekly_count Ğ´Ğ»Ñ limited_free_trial   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ•Ğ–Ğ•ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ (1-Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾, 00:00)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  QuotaChecker.reset_monthly_counters()                       â”‚
â”‚       â”‚                                                      â”‚
â”‚       â””â”€â†’ Ğ¡Ğ±Ñ€Ğ¾Ñ usage_monthly_count Ğ´Ğ»Ñ limited_free_trial  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞšĞĞ–Ğ”Ğ«Ğ• 15 ĞœĞ˜ĞĞ£Ğ¢                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PaymentMonitoring.collect_metrics()                         â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº (total, active, by_status)       â”‚
â”‚       â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹ (total, succeeded, failed)      â”‚
â”‚       â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ĞºĞ²Ğ¾Ñ‚ (usage, at_limit)                    â”‚
â”‚       â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ webhooks (processed, unprocessed)         â”‚
â”‚       â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (mismatches)                â”‚
â”‚       â””â”€â†’ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¾Ğ²                                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ£ Webhook Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°

```
Stripe â†’ POST /webhook
    â”‚
    â–¼
WebhookHandler.handle_webhook()
    â”‚
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ (Stripe signature)
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ (stripe_event_id)
    â””â”€â†’ ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
        â”‚
        â”œâ”€â†’ checkout.session.completed
        â”‚   â””â”€â†’ _handle_checkout_completed()
        â”‚       â”œâ”€â†’ State Machine: paid_trial
        â”‚       â”œâ”€â†’ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ stripe_subscription_id
        â”‚       â””â”€â†’ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° paid_trial_end_at
        â”‚
        â”œâ”€â†’ customer.subscription.updated
        â”‚   â””â”€â†’ _handle_subscription_updated()
        â”‚       â”œâ”€â†’ State Machine: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        â”‚       â””â”€â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ stripe_status
        â”‚
        â”œâ”€â†’ customer.subscription.deleted
        â”‚   â””â”€â†’ _handle_subscription_deleted()
        â”‚       â””â”€â†’ State Machine: limited_free_trial
        â”‚
        â”œâ”€â†’ invoice.payment_succeeded
        â”‚   â””â”€â†’ _handle_payment_succeeded()
        â”‚       â”œâ”€â†’ State Machine: paid
        â”‚       â”œâ”€â†’ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° grace_period_end_at
        â”‚       â””â”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ payment
        â”‚
        â”œâ”€â†’ invoice.payment_failed
        â”‚   â””â”€â†’ _handle_payment_failed()
        â”‚       â”œâ”€â†’ State Machine: billing_problem
        â”‚       â”œâ”€â†’ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° grace_period_end_at (3 Ğ´Ğ½Ñ)
        â”‚       â””â”€â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ payment (failed)
        â”‚
        â””â”€â†’ invoice.payment_action_required
            â””â”€â†’ _handle_payment_action_required()
                â””â”€â†’ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ)
```

---

## ğŸ”— Deep Links Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nexy://payment/checkout/success?session_id=...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PaymentIntegration._handle_payment_success()                â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ payment.success                â”‚
â”‚       â””â”€â†’ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ‡ĞµÑ€ĞµĞ· gRPC                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nexy://payment/checkout/cancel                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PaymentIntegration._handle_payment_cancel()                 â”‚
â”‚       â”‚                                                      â”‚
â”‚       â””â”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ payment.cancel                  â”‚
â”‚           (ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ)                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nexy://payment/portal_return                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PaymentIntegration._handle_portal_return()                  â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â†’ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ payment.portal_return           â”‚
â”‚       â””â”€â†’ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ‡ĞµÑ€ĞµĞ· gRPC                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```
SubscriptionModule.get_subscription_context()
    â”‚
    â”œâ”€â†’ SubscriptionCache.get(hardware_id)
    â”‚   â”‚
    â”‚   â”œâ”€â†’ Ğ•ÑĞ»Ğ¸ ĞºÑÑˆ Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ (TTL < 30 ÑĞµĞº):
    â”‚   â”‚   â””â”€â†’ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¸Ğ· ĞºÑÑˆĞ°
    â”‚   â”‚
    â”‚   â””â”€â†’ Ğ•ÑĞ»Ğ¸ ĞºÑÑˆ Ğ¸ÑÑ‚ĞµĞº Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚:
    â”‚       â”‚
    â”‚       â””â”€â†’ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ‘Ğ”
    â”‚           â”‚
    â”‚           â””â”€â†’ SubscriptionCache.set(hardware_id, context)
    â”‚
    â””â”€â†’ Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºÑÑˆĞ° Ğ¿Ñ€Ğ¸:
        â€¢ create_checkout()
        â€¢ cancel_subscription()
        â€¢ get_portal_url() (ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ stripe_customer_id)
        â€¢ Webhook ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ… (Ñ‡ĞµÑ€ĞµĞ· State Machine)
```

---

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹

```
PaymentMonitoring.collect_metrics()
    â”‚
    â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº:
    â”‚   â€¢ total, active, by_status
    â”‚   â€¢ billing_problems
    â”‚   â€¢ expired_trials, expired_grace_periods
    â”‚
    â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹:
    â”‚   â€¢ total, succeeded, failed
    â”‚   â€¢ total_amount_usd, last_24h
    â”‚
    â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ĞºĞ²Ğ¾Ñ‚:
    â”‚   â€¢ total_limited_trial
    â”‚   â€¢ usage (daily/weekly/monthly)
    â”‚   â€¢ at_limit
    â”‚
    â”œâ”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ webhooks:
    â”‚   â€¢ total, processed, unprocessed
    â”‚   â€¢ by_type, last_24h
    â”‚
    â””â”€â†’ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:
        â€¢ with_stripe_id
        â€¢ paid_without_stripe_id
        â€¢ status_mismatch

PaymentMonitoring.check_alerts()
    â”‚
    â”œâ”€â†’ unprocessed_webhooks (warning)
    â”œâ”€â†’ billing_problems (warning)
    â”œâ”€â†’ expired_trials (info)
    â”œâ”€â†’ expired_grace_periods (warning)
    â”œâ”€â†’ status_mismatch (warning)
    â”œâ”€â†’ paid_without_stripe (error) â† ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ!
    â””â”€â†’ quota_limit_reached (info)
```

---

## ğŸ” Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ

```
Ğ’ÑĞµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Stripe API:
    â”‚
    â”œâ”€â†’ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ idempotency_key:
    â”‚   â€¢ Ğ¥ÑÑˆ Ğ¾Ñ‚ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    â”‚   â€¢ Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    â”‚
    â””â”€â†’ Stripe Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹

Ğ’ÑĞµ webhook ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ:
    â”‚
    â”œâ”€â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° stripe_event_id Ğ² Ğ‘Ğ”:
    â”‚   â€¢ Ğ•ÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½ â†’ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞº
    â”‚   â€¢ Ğ•ÑĞ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ â†’ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° + ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
    â”‚
    â””â”€â†’ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ Ğ¾Ğ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
```

---

## ğŸ“‹ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°

1. **State Machine - ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹** Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ² ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
2. **Stripe - Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹** Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ)
3. **Quota Checker** Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼
4. **Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ** Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
5. **ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (TTL 30 ÑĞµĞº)
6. **ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸** Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‚ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°Ğ¼Ğ¸
7. **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³** Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚

---

**Ğ”Ğ°Ñ‚Ğ°:** 2025-01-22  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾

