# üí≥ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**Feature ID:** F-2025-017-stripe-payment  
**–í–µ—Ä—Å–∏—è:** 1.0.6

---

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è trial –ø–æ–¥–ø–∏—Å–∫–∏** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ –ø–ª–∞—Ç–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Stripe.

---

## üìä –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1Ô∏è‚É£ **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "paid_trial"
    ‚Üì
Trial –ø–µ—Ä–∏–æ–¥: 14 –¥–Ω–µ–π (–±–µ–∑ –∫–∞—Ä—Ç—ã)
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è `paid_trial` –ø–æ–¥–ø–∏—Å–∫–∞ (14 –¥–Ω–µ–π)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid_trial`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ

---

### 2Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è trial**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–æ—Ç—ã (–¥–ª—è limited_free_trial)
    ‚Üì
–ï—Å–ª–∏ –∫–≤–æ—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω—ã ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
    ‚Üì
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

**–î–ª—è `paid_trial`:**
- –ö–≤–æ—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–î–ª—è `limited_free_trial`:**
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–Ω–µ–≤–Ω—ã–µ/–Ω–µ–¥–µ–ª—å–Ω—ã–µ/–º–µ—Å—è—á–Ω—ã–µ –ª–∏–º–∏—Ç—ã (5/25/50)
- –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è

---

### 3Ô∏è‚É£ **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º trial**

```
–ó–∞ 2 –¥–Ω—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è trial
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Üì
–ó–∞ 1 –¥–µ–Ω—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è trial
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Üì
–í –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å trial
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ (Trial Handler) –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid_trial`
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ—Å—Ç–∞–ª–æ—Å—å 2 –¥–Ω—è, 1 –¥–µ–Ω—å, –∏–ª–∏ 0 –¥–Ω–µ–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ LLM (–≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)

---

### 4Ô∏è‚É£ **–û–∫–æ–Ω—á–∞–Ω–∏–µ trial –ø–µ—Ä–∏–æ–¥–∞**

```
Trial –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç–µ–∫
    ‚Üì
Trial Handler –Ω–∞—Ö–æ–¥–∏—Ç –∏—Å—Ç–µ–∫—à–∏–µ trial –ø–æ–¥–ø–∏—Å–∫–∏
    ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç cooldown (24 —á–∞—Å–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkout)
    ‚Üì
–ï—Å–ª–∏ cooldown –ø—Ä–æ—à–µ–ª ‚Üí —Å–æ–∑–¥–∞–µ—Ç Stripe Checkout Session
    ‚Üì
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É open_url –∫–ª–∏–µ–Ω—Ç—É
    ‚Üì
–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Checkout –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- Trial Handler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏ —Å `trial_end_at < now()`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –ª–∏ Checkout –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ (cooldown)
- –ï—Å–ª–∏ cooldown –ø—Ä–æ—à–µ–ª ‚Üí —Å–æ–∑–¥–∞–µ—Ç Checkout Session –≤ Stripe
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `action_message` —Å `open_url` –∫–ª–∏–µ–Ω—Ç—É
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ

---

### 5Ô∏è‚É£ **–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Stripe Checkout**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç Checkout —Å—Ç—Ä–∞–Ω–∏—Ü—É Stripe
    ‚Üì
–í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É
    ‚Üì
Stripe –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
    ‚Üì
Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook "checkout.session.completed"
    ‚Üì
–°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç webhook
    ‚Üì
Webhook Handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
    ‚Üì
State Machine –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å: paid_trial ‚Üí paid
    ‚Üì
–ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã –≤ Stripe Checkout
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- Webhook Handler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
- State Machine –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ `paid_trial ‚Üí paid`
- –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `stripe_subscription_id`

---

### 6Ô∏è‚É£ **–í–æ–∑–≤—Ä–∞—Ç –∏–∑ Stripe (Deep Link)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É –≤ Stripe
    ‚Üì
Stripe –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞: nexy://payment/checkout/success?session_id=xxx
    ‚Üì
macOS –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ deep link
    ‚Üì
PaymentIntegration –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç deep link
    ‚Üì
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ gRPC
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã Stripe –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ deep link
- macOS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- `PaymentIntegration` –ø–∞—Ä—Å–∏—Ç URL –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç gRPC –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ

---

### 7Ô∏è‚É£ **–ê–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
    ‚Üì
–°—Ç–∞—Ç—É—Å = "paid" ‚Üí –∫–≤–æ—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
    ‚Üì
–ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –î–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid` –∫–≤–æ—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –°—á–µ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è

---

### 8Ô∏è‚É£ **–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π (Billing Problem)**

```
Stripe –Ω–µ –º–æ–∂–µ—Ç —Å–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –∫–∞—Ä—Ç—ã
    ‚Üì
Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook "invoice.payment_failed"
    ‚Üì
Webhook Handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
    ‚Üì
State Machine –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å: paid ‚Üí billing_problem
    ‚Üì
–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è Grace Period (1 –¥–µ–Ω—å)
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª, Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook
- State Machine –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –≤ `billing_problem`
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è Grace Period (24 —á–∞—Å–∞)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ
- –í–æ –≤—Ä–µ–º—è Grace Period –¥–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

### 9Ô∏è‚É£ **Grace Period –∏—Å—Ç–µ–∫**

```
Grace Period –∏—Å—Ç–µ–∫ (24 —á–∞—Å–∞ –ø—Ä–æ—à–ª–æ)
    ‚Üì
Grace Period Handler –Ω–∞—Ö–æ–¥–∏—Ç –∏—Å—Ç–µ–∫—à–∏–µ grace periods
    ‚Üì
State Machine –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å: billing_problem ‚Üí limited_free_trial
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω
    ‚Üì
–ö–≤–æ—Ç—ã: 5/25/50 –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- Grace Period Handler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º `grace_period_end_at`
- State Machine –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –≤ `limited_free_trial`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–≤–æ—Ç—ã (5/25/50)

---

### üîü **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π (Customer Portal)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç: "–£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–æ–π"
    ‚Üì
LLM —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É
    ‚Üì
–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç Portal Session –≤ Stripe
    ‚Üì
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç open_url —Å URL Portal
    ‚Üì
–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Portal –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
    ‚Üì
–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ deep link
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç –∫–æ–º–∞–Ω–¥—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π
- LLM —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É `manage_subscription`
- –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç Customer Portal Session –≤ Stripe
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ `open_url`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ `nexy://payment/portal/return`

---

## üîÑ State Machine (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏)

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **State Machine** –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:

**–°—Ç–∞—Ç—É—Å—ã:**
1. `paid_trial` - Trial –ø–µ—Ä–∏–æ–¥ (14 –¥–Ω–µ–π)
2. `paid` - –ê–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
3. `billing_problem` - –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π (Grace Period)
4. `limited_free_trial` - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω
5. `canceled` - –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
6. `expired` - –ò—Å—Ç–µ–∫—à–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
7. `pending` - –í –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è
8. `error` - –û—à–∏–±–∫–∞

**–ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:**
- `paid_trial` ‚Üí `paid` (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã)
- `paid` ‚Üí `billing_problem` (–ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–µ —Å –æ–ø–ª–∞—Ç–æ–π)
- `billing_problem` ‚Üí `paid` (–µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
- `billing_problem` ‚Üí `limited_free_trial` (–µ—Å–ª–∏ Grace Period –∏—Å—Ç–µ–∫)
- `paid` ‚Üí `canceled` (–ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏)

---

## üìä –ö–≤–æ—Ç—ã (Quota Checker)

**–î–ª—è `limited_free_trial` –ø–æ–¥–ø–∏—Å–æ–∫:**
- **–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç:** 5 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ù–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç:** 25 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç:** 50 –∑–∞–ø—Ä–æ—Å–æ–≤

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç
2. –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–æ–≤
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ (daily/weekly/monthly)

---

## üîî –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (Cron)

**Trial Handler** (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤):
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ trial –ø–æ–¥–ø–∏—Å–∫–∏
- –°–æ–∑–¥–∞–µ—Ç Checkout –¥–ª—è –∏—Å—Ç–µ–∫—à–∏—Ö trial
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**Grace Period Handler** (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤):
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ grace periods
- –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ `limited_free_trial`

**Stripe Sync** (–∫–∞–∂–¥—ã–π —á–∞—Å):
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å—ã —Å–æ Stripe
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

**Quota Reset** (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ):
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–Ω–µ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ)
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –º–µ—Å—è—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (–µ–∂–µ–º–µ—Å—è—á–Ω–æ)

**Monitoring** (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç):
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–ª–µ—Ä—Ç—ã
- –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ trial** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å
2. **–ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥** - –æ—Ç trial –∫ –ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
3. **Grace Period** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø–ª–∞—Ç–æ–π
4. **–ö–≤–æ—Ç—ã –¥–ª—è free tier** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. **State Machine** - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
6. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - webhooks –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ
7. **Deep Links** - –±–µ—Å—à–æ–≤–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ Stripe

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-22
