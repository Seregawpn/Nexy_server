# üéØ MVP –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**Feature ID:** F-2025-017-stripe-payment  
**Date:** 2025-12-13  
**Version:** 1.0  
**Status:** üìã –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π MVP –ø–æ–¥—Ö–æ–¥

---

## üìã –§–∏–ª–æ—Å–æ—Ñ–∏—è –ø–æ–¥—Ö–æ–¥–∞

**–ü—Ä–∏–Ω—Ü–∏–ø:** –°–æ–∑–¥–∞–≤–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ MVP, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–µ–∂–¥–µ —á–µ–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –†–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

---

## üéØ MVP –≠—Ç–∞–ø—ã

### MVP 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1 –¥–µ–Ω—å)
**–¶–µ–ª—å:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### MVP 1: Webhook Endpoint (1-2 –¥–Ω—è)
**–¶–µ–ª—å:** –ü—Ä–∏–µ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhook —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe

### MVP 2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (1-2 –¥–Ω—è)
**–¶–µ–ª—å:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Å—Ç—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

### MVP 3: Stripe Service (1-2 –¥–Ω—è)
**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ Checkout Session (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ)

### MVP 4: Subscription Repository (1 –¥–µ–Ω—å)
**–¶–µ–ª—å:** –†–∞–±–æ—Ç–∞ —Å –ë–î –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫

### MVP 5: Subscription Context (1 –¥–µ–Ω—å)
**–¶–µ–ª—å:** –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ workflow)

### MVP 6: Quota Checker (1 –¥–µ–Ω—å)
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ)

### MVP 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Workflow (2-3 –¥–Ω—è)
**–¶–µ–ª—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ subscription context –≤ LLM prompt

### MVP 8: –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏ (2-3 –¥–Ω—è)
**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ create_subscription/cancel_subscription

### MVP 9: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (1-2 –¥–Ω—è)
**–¶–µ–ª—å:** Deep Links –∏ open_url –∫–æ–º–∞–Ω–¥–∞

### MVP 10: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (2-3 –¥–Ω—è)
**–¶–µ–ª—å:** –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ

---

## üì¶ MVP 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

**–¶–µ–ª—å:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—Ä–µ–º—è:** 1 –¥–µ–Ω—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
cd /Users/sergiyzasorin/Development/Nexy/v1.0.6\ Payment
mkdir -p mvp_tests/webhook_logs
mkdir -p mvp_tests/migrations
mkdir -p mvp_tests/tests
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
v1.0.6 Payment/
  ‚îî‚îÄ‚îÄ mvp_tests/
      ‚îú‚îÄ‚îÄ webhook_logs/
      ‚îú‚îÄ‚îÄ migrations/
      ‚îî‚îÄ‚îÄ tests/
```

#### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î PostgreSQL

**–î–µ–π—Å—Ç–≤–∏–µ 1:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
```bash
# macOS
brew install postgresql@14
brew services start postgresql@14
```

**–î–µ–π—Å—Ç–≤–∏–µ 2:** –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
```bash
createdb nexy_payment_test
psql nexy_payment_test -c "SELECT version();"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
PostgreSQL 14.x
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
psql nexy_payment_test -c "\l" | grep nexy_payment_test
```

#### –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ Stripe test API keys

**–î–µ–π—Å—Ç–≤–∏–µ:**
1. –ó–∞–π—Ç–∏ –Ω–∞ https://dashboard.stripe.com/test/apikeys
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å **Publishable key** –∏ **Secret key**
3. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `mvp_tests/.env`:

```bash
cat > mvp_tests/.env << EOF
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...  # –ü–æ–ª—É—á–∏–º –ø–æ–∑–∂–µ –∏–∑ Stripe CLI
DATABASE_URL=postgresql://localhost/nexy_payment_test
EOF
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –§–∞–π–ª `.env` —Å–æ–∑–¥–∞–Ω —Å –∫–ª—é—á–∞–º–∏
- –ö–ª—é—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `sk_test_` –∏ `pk_test_`

#### –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
cd mvp_tests
python3 -m venv .venv
source .venv/bin/activate
pip install stripe psycopg2-binary python-dotenv flask
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Successfully installed stripe-X.X.X psycopg2-binary-X.X.X python-dotenv-X.X.X flask-X.X.X
```

#### –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤

**–§–∞–π–ª:** `mvp_tests/test_db_connection.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
import os
import sys
from dotenv import load_dotenv
import psycopg2

load_dotenv()

def test_db_connection():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL"""
    db_url = os.getenv('DATABASE_URL')
    if not db_url:
        print("‚ùå DATABASE_URL not found in .env")
        return False
    
    try:
        conn = psycopg2.connect(db_url)
        cur = conn.cursor()
        cur.execute("SELECT version();")
        version = cur.fetchone()[0]
        print(f"‚úÖ Database connection successful")
        print(f"   PostgreSQL version: {version}")
        cur.close()
        conn.close()
        return True
    except Exception as e:
        print(f"‚ùå Database connection failed: {e}")
        return False

if __name__ == '__main__':
    success = test_db_connection()
    sys.exit(0 if success else 1)
```

**–§–∞–π–ª:** `mvp_tests/test_stripe_connection.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Stripe"""
import os
import sys
from dotenv import load_dotenv
import stripe

load_dotenv()

def test_stripe_connection():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Stripe API"""
    api_key = os.getenv('STRIPE_SECRET_KEY')
    if not api_key:
        print("‚ùå STRIPE_SECRET_KEY not found in .env")
        return False
    
    try:
        stripe.api_key = api_key
        # –ü—Ä–æ—Å—Ç–æ–π API call –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        account = stripe.Account.retrieve()
        print(f"‚úÖ Stripe API connection successful")
        print(f"   Account ID: {account.id}")
        print(f"   Country: {account.country}")
        return True
    except stripe.error.AuthenticationError:
        print("‚ùå Stripe authentication failed - check your API key")
        return False
    except Exception as e:
        print(f"‚ùå Stripe connection failed: {e}")
        return False

if __name__ == '__main__':
    success = test_stripe_connection()
    sys.exit(0 if success else 1)
```

**–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏:**
```bash
chmod +x mvp_tests/test_db_connection.py
chmod +x mvp_tests/test_stripe_connection.py
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
- [ ] Stripe test API —Ä–∞–±–æ—Ç–∞–µ—Ç (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å account info)
- [ ] –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ `.venv`
- [ ] –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –§–∞–π–ª `.env` —Å–æ–∑–¥–∞–Ω —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
cd mvp_tests
source .venv/bin/activate

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
python test_db_connection.py

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Stripe
python test_stripe_connection.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**

**test_db_connection.py:**
```
‚úÖ Database connection successful
   PostgreSQL version: PostgreSQL 14.x on x86_64-apple-darwin...
```

**test_stripe_connection.py:**
```
‚úÖ Stripe API connection successful
   Account ID: acct_...
   Country: US
```

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** `psycopg2` –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL development headers
brew install postgresql@14
export PATH="/opt/homebrew/opt/postgresql@14/bin:$PATH"
pip install psycopg2-binary
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –ë–î –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
```bash
# –†–µ—à–µ–Ω–∏–µ:
brew services start postgresql@14
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** Stripe API key –Ω–µ–≤–µ—Ä–Ω—ã–π
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á –≤ Stripe Dashboard
# –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å sk_test_ –¥–ª—è test mode
```

---

## üì¶ MVP 1: Webhook Endpoint

**–¶–µ–ª—å:** –ü—Ä–∏–µ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhook —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe (–±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏)

**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 0

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Stripe CLI

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
# macOS
brew install stripe/stripe-cli/stripe

# –ü—Ä–æ–≤–µ—Ä–∫–∞
stripe --version
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
stripe version X.X.X
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ webhook —Å–µ—Ä–≤–µ—Ä–∞

**–§–∞–π–ª:** `mvp_tests/webhook_server.py`

```python
#!/usr/bin/env python3
"""–ü—Ä–æ—Å—Ç–æ–π webhook endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe"""
from flask import Flask, request, jsonify
import json
import os
from datetime import datetime
from pathlib import Path

app = Flask(__name__)

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
LOG_DIR = Path(__file__).parent / 'webhook_logs'
LOG_DIR.mkdir(exist_ok=True)

@app.route('/webhook/stripe', methods=['POST'])
def stripe_webhook():
    """–ü—Ä–æ—Å—Ç–æ–π webhook endpoint - —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    payload = request.get_data()
    signature = request.headers.get('Stripe-Signature', '')
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
    timestamp = datetime.now().isoformat()
    print(f"\n[{timestamp}] [WEBHOOK] Received event")
    print(f"[WEBHOOK] Signature: {signature[:30]}..." if signature else "[WEBHOOK] No signature")
    print(f"[WEBHOOK] Payload size: {len(payload)} bytes")
    print(f"[WEBHOOK] Content-Type: {request.content_type}")
    
    try:
        event = json.loads(payload)
        event_type = event.get('type', 'unknown')
        event_id = event.get('id', 'unknown')
        created = event.get('created', 0)
        
        print(f"[WEBHOOK] Event type: {event_type}")
        print(f"[WEBHOOK] Event ID: {event_id}")
        print(f"[WEBHOOK] Created: {datetime.fromtimestamp(created)}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        log_file = LOG_DIR / f"{event_id}.json"
        with open(log_file, 'w') as f:
            json.dump({
                'timestamp': timestamp,
                'event_type': event_type,
                'event_id': event_id,
                'signature': signature,
                'event': event
            }, f, indent=2)
        
        print(f"[WEBHOOK] Saved to: {log_file}")
        print(f"[WEBHOOK] ‚úÖ Event processed successfully\n")
        
        return jsonify({'status': 'received', 'event_id': event_id}), 200
        
    except json.JSONDecodeError as e:
        print(f"[WEBHOOK] ‚ùå JSON decode error: {e}")
        return jsonify({'error': 'Invalid JSON'}), 400
    except Exception as e:
        print(f"[WEBHOOK] ‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/health', methods=['GET'])
def health():
    """Health check endpoint"""
    return jsonify({'status': 'ok', 'service': 'webhook_server'}), 200

@app.route('/webhook/logs', methods=['GET'])
def list_logs():
    """–°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π"""
    logs = []
    for log_file in sorted(LOG_DIR.glob('*.json'), reverse=True):
        try:
            with open(log_file, 'r') as f:
                data = json.load(f)
                logs.append({
                    'file': log_file.name,
                    'event_type': data.get('event_type'),
                    'event_id': data.get('event_id'),
                    'timestamp': data.get('timestamp')
                })
        except:
            pass
    return jsonify({'logs': logs, 'count': len(logs)}), 200

if __name__ == '__main__':
    print("=" * 60)
    print("üöÄ Webhook Server Starting...")
    print(f"üìÅ Log directory: {LOG_DIR}")
    print("=" * 60)
    app.run(host='0.0.0.0', port=8000, debug=True)
```

**–°–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:**
```bash
chmod +x mvp_tests/webhook_server.py
```

#### –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
cd mvp_tests
source .venv/bin/activate
python webhook_server.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
============================================================
üöÄ Webhook Server Starting...
üìÅ Log directory: /path/to/mvp_tests/webhook_logs
============================================================
 * Running on http://0.0.0.0:8000
 * Debug mode: on
```

#### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Stripe CLI forwarding

**–î–µ–π—Å—Ç–≤–∏–µ 1:** –í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Stripe CLI
```bash
stripe login
```

**–î–µ–π—Å—Ç–≤–∏–µ 2:** –ó–∞–ø—É—Å—Ç–∏—Ç—å forwarding
```bash
stripe listen --forward-to localhost:8000/webhook/stripe
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
> Ready! Your webhook signing secret is whsec_... (^C to quit)
```

**–í–∞–∂–Ω–æ:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `whsec_...` –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ `mvp_tests/.env`:
```bash
STRIPE_WEBHOOK_SECRET=whsec_...
```

#### –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
# –í —Ç—Ä–µ—Ç—å–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
stripe trigger checkout.session.completed
stripe trigger invoice.payment_succeeded
stripe trigger invoice.payment_failed
stripe trigger customer.subscription.updated
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] Webhook endpoint –ø—Ä–∏–Ω–∏–º–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `/webhook/stripe`
- [ ] –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å –¥–µ—Ç–∞–ª—è–º–∏
- [ ] –°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON —Ñ–∞–π–ª—ã –≤ `webhook_logs/`
- [ ] Stripe CLI —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
- [ ] Health check endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç (`/health`)
- [ ] –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤ (`/webhook/logs`)

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

**–¢–µ—Ä–º–∏–Ω–∞–ª 1 (Webhook Server):**
```bash
cd mvp_tests
source .venv/bin/activate
python webhook_server.py
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 2 (Stripe CLI):**
```bash
stripe listen --forward-to localhost:8000/webhook/stripe
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 3 (–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):**
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
stripe trigger checkout.session.completed
stripe trigger invoice.payment_succeeded
stripe trigger invoice.payment_failed
stripe trigger customer.subscription.updated
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ 1:**

```
[2025-12-13T10:30:45] [WEBHOOK] Received event
[WEBHOOK] Signature: t=1234567890,v1=abc123...
[WEBHOOK] Payload size: 1234 bytes
[WEBHOOK] Content-Type: application/json
[WEBHOOK] Event type: checkout.session.completed
[WEBHOOK] Event ID: evt_1234567890
[WEBHOOK] Created: 2025-12-13 10:30:45
[WEBHOOK] Saved to: webhook_logs/evt_1234567890.json
[WEBHOOK] ‚úÖ Event processed successfully
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:**
```bash
ls -lh mvp_tests/webhook_logs/
cat mvp_tests/webhook_logs/evt_*.json | jq '.event_type'
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ HTTP:**
```bash
# Health check
curl http://localhost:8000/health

# –°–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤
curl http://localhost:8000/webhook/logs | jq
```

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–í –∫–æ–Ω—Å–æ–ª–∏ webhook —Å–µ—Ä–≤–µ—Ä–∞:**
   - –í–∏–¥–Ω—ã –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è
   - –ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

2. **–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `webhook_logs/`:**
   - –°–æ–∑–¥–∞–Ω—ã JSON —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
   - –§–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏
   - –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–±—ã—Ç–∏–π

3. **–í Stripe CLI:**
   - –í–∏–¥–Ω—ã —É—Å–ø–µ—à–Ω—ã–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–±—ã—Ç–∏–π
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** `stripe listen` –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
curl http://localhost:8000/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç
lsof -i :8000
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –°–æ–±—ã—Ç–∏—è –Ω–µ –¥–æ—Ö–æ–¥—è—Ç
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall
# macOS: System Preferences > Security > Firewall

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Stripe CLI
stripe listen --forward-to localhost:8000/webhook/stripe --print-json
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** –û—à–∏–±–∫–∞ "Invalid JSON"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ payload –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
# –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ raw payload –≤ webhook_server.py
print(f"[DEBUG] Raw payload: {payload[:200]}")
```

**–ü—Ä–æ–±–ª–µ–º–∞ 4:** –§–∞–π–ª—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod -R 755 mvp_tests/webhook_logs/
```

---

## üì¶ MVP 2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–¶–µ–ª—å:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Å—Ç—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 0

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–§–∞–π–ª:** `mvp_tests/migrations/001_create_subscriptions.sql`

```sql
-- MVP 2: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
-- –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫
CREATE TABLE IF NOT EXISTS subscriptions (
    hardware_id VARCHAR(255) PRIMARY KEY,
    status VARCHAR(50) NOT NULL DEFAULT 'paid_trial',
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    paid_trial_end_at TIMESTAMP,
    grace_period_end_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON subscriptions(status);
CREATE INDEX IF NOT EXISTS idx_subscriptions_stripe_customer ON subscriptions(stripe_customer_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_stripe_subscription ON subscriptions(stripe_subscription_id);

-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
CREATE TABLE IF NOT EXISTS subscription_events (
    stripe_event_id VARCHAR(255) PRIMARY KEY,
    event_type VARCHAR(100) NOT NULL,
    hardware_id VARCHAR(255),
    event_data JSONB,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ hardware_id
CREATE INDEX IF NOT EXISTS idx_subscription_events_hardware ON subscription_events(hardware_id);
CREATE INDEX IF NOT EXISTS idx_subscription_events_type ON subscription_events(event_type);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
COMMENT ON TABLE subscriptions IS '–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
COMMENT ON COLUMN subscriptions.hardware_id IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞';
COMMENT ON COLUMN subscriptions.status IS '–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: paid_trial, paid, billing_problem, limited_free_trial, etc.';
COMMENT ON TABLE subscription_events IS '–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ webhook —Å–æ–±—ã—Ç–∏—è (–¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)';
```

#### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–î–µ–π—Å—Ç–≤–∏–µ:**
```bash
cd mvp_tests
psql $DATABASE_URL -f migrations/001_create_subscriptions.sql
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
CREATE TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE TABLE
CREATE INDEX
CREATE INDEX
COMMENT
COMMENT
COMMENT
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
psql $DATABASE_URL -c "\d subscriptions"
psql $DATABASE_URL -c "\d subscription_events"
```

#### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ Repository

**–§–∞–π–ª:** `mvp_tests/subscription_repository.py`

```python
#!/usr/bin/env python3
"""Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –≤ –ë–î"""
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Optional, Dict, List
from datetime import datetime
import os
from dotenv import load_dotenv

load_dotenv()

class SubscriptionRepository:
    def __init__(self, db_url: Optional[str] = None):
        self.db_url = db_url or os.getenv('DATABASE_URL')
        if not self.db_url:
            raise ValueError("DATABASE_URL not found")
    
    def _get_connection(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î"""
        return psycopg2.connect(self.db_url)
    
    def get_subscription(self, hardware_id: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ hardware_id"""
        conn = self._get_connection()
        try:
            with conn.cursor(cursor_factory=RealDictCursor) as cur:
                cur.execute(
                    """SELECT 
                        hardware_id, status, stripe_customer_id, 
                        stripe_subscription_id, paid_trial_end_at, 
                        grace_period_end_at, created_at, updated_at
                       FROM subscriptions 
                       WHERE hardware_id = %s""",
                    (hardware_id,)
                )
                row = cur.fetchone()
                return dict(row) if row else None
        finally:
            conn.close()
    
    def create_subscription(
        self, 
        hardware_id: str, 
        status: str = 'paid_trial',
        paid_trial_end_at: Optional[datetime] = None
    ) -> Dict:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É"""
        conn = self._get_connection()
        try:
            with conn.cursor(cursor_factory=RealDictCursor) as cur:
                cur.execute(
                    """INSERT INTO subscriptions (hardware_id, status, paid_trial_end_at)
                       VALUES (%s, %s, %s)
                       ON CONFLICT (hardware_id) DO NOTHING
                       RETURNING *""",
                    (hardware_id, status, paid_trial_end_at)
                )
                row = cur.fetchone()
                conn.commit()
                if row:
                    return dict(row)
                # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
                return self.get_subscription(hardware_id)
        finally:
            conn.close()
    
    def update_status(self, hardware_id: str, status: str) -> bool:
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏"""
        conn = self._get_connection()
        try:
            with conn.cursor() as cur:
                cur.execute(
                    """UPDATE subscriptions 
                       SET status = %s, updated_at = CURRENT_TIMESTAMP 
                       WHERE hardware_id = %s""",
                    (status, hardware_id)
                )
                conn.commit()
                return cur.rowcount > 0
        finally:
            conn.close()
    
    def update_stripe_ids(
        self, 
        hardware_id: str, 
        customer_id: Optional[str] = None,
        subscription_id: Optional[str] = None
    ) -> bool:
        """–û–±–Ω–æ–≤–∏—Ç—å Stripe IDs"""
        conn = self._get_connection()
        try:
            updates = []
            params = []
            if customer_id:
                updates.append("stripe_customer_id = %s")
                params.append(customer_id)
            if subscription_id:
                updates.append("stripe_subscription_id = %s")
                params.append(subscription_id)
            
            if not updates:
                return False
            
            updates.append("updated_at = CURRENT_TIMESTAMP")
            params.append(hardware_id)
            
            query = f"UPDATE subscriptions SET {', '.join(updates)} WHERE hardware_id = %s"
            with conn.cursor() as cur:
                cur.execute(query, params)
                conn.commit()
                return cur.rowcount > 0
        finally:
            conn.close()
    
    def record_event(
        self,
        stripe_event_id: str,
        event_type: str,
        hardware_id: Optional[str] = None,
        event_data: Optional[Dict] = None
    ) -> bool:
        """–ó–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (–¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)"""
        conn = self._get_connection()
        try:
            with conn.cursor() as cur:
                cur.execute(
                    """INSERT INTO subscription_events 
                       (stripe_event_id, event_type, hardware_id, event_data)
                       VALUES (%s, %s, %s, %s::jsonb)
                       ON CONFLICT (stripe_event_id) DO NOTHING""",
                    (stripe_event_id, event_type, hardware_id, 
                     psycopg2.extras.Json(event_data) if event_data else None)
                )
                conn.commit()
                return cur.rowcount > 0
        except psycopg2.IntegrityError:
            # –°–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
            return False
        finally:
            conn.close()
    
    def event_exists(self, stripe_event_id: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ"""
        conn = self._get_connection()
        try:
            with conn.cursor() as cur:
                cur.execute(
                    "SELECT 1 FROM subscription_events WHERE stripe_event_id = %s",
                    (stripe_event_id,)
                )
                return cur.fetchone() is not None
        finally:
            conn.close()
```

#### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–§–∞–π–ª:** `mvp_tests/test_subscription_repository.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç—ã –¥–ª—è SubscriptionRepository"""
import sys
import os
from datetime import datetime, timedelta
from dotenv import load_dotenv
from subscription_repository import SubscriptionRepository

load_dotenv()

def test_create_subscription():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"""
    repo = SubscriptionRepository()
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    
    print(f"üß™ Test: Create subscription for {hardware_id}")
    result = repo.create_subscription(hardware_id, status='paid_trial')
    
    assert result is not None, "Subscription should be created"
    assert result['hardware_id'] == hardware_id, "Hardware ID should match"
    assert result['status'] == 'paid_trial', "Status should be paid_trial"
    print("‚úÖ Create subscription: PASSED")
    return hardware_id

def test_get_subscription(hardware_id: str):
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"""
    repo = SubscriptionRepository()
    
    print(f"üß™ Test: Get subscription for {hardware_id}")
    result = repo.get_subscription(hardware_id)
    
    assert result is not None, "Subscription should exist"
    assert result['hardware_id'] == hardware_id, "Hardware ID should match"
    print("‚úÖ Get subscription: PASSED")

def test_update_status(hardware_id: str):
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"""
    repo = SubscriptionRepository()
    
    print(f"üß™ Test: Update status for {hardware_id}")
    success = repo.update_status(hardware_id, 'paid')
    
    assert success, "Update should succeed"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏–ª—Å—è
    result = repo.get_subscription(hardware_id)
    assert result['status'] == 'paid', "Status should be updated to paid"
    print("‚úÖ Update status: PASSED")

def test_update_stripe_ids(hardware_id: str):
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Stripe IDs"""
    repo = SubscriptionRepository()
    
    print(f"üß™ Test: Update Stripe IDs for {hardware_id}")
    success = repo.update_stripe_ids(
        hardware_id,
        customer_id='cus_test123',
        subscription_id='sub_test123'
    )
    
    assert success, "Update should succeed"
    
    result = repo.get_subscription(hardware_id)
    assert result['stripe_customer_id'] == 'cus_test123', "Customer ID should match"
    assert result['stripe_subscription_id'] == 'sub_test123', "Subscription ID should match"
    print("‚úÖ Update Stripe IDs: PASSED")

def test_event_idempotency():
    """–¢–µ—Å—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π"""
    repo = SubscriptionRepository()
    event_id = f"evt_test_{datetime.now().timestamp()}"
    
    print(f"üß™ Test: Event idempotency for {event_id}")
    
    # –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å
    success1 = repo.record_event(event_id, 'test.event', hardware_id='test_hw')
    assert success1, "First event should be recorded"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
    exists = repo.event_exists(event_id)
    assert exists, "Event should exist"
    
    # –í—Ç–æ—Ä–∞—è –∑–∞–ø–∏—Å—å (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞)
    success2 = repo.record_event(event_id, 'test.event', hardware_id='test_hw')
    assert not success2, "Duplicate event should be ignored"
    
    print("‚úÖ Event idempotency: PASSED")

def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("=" * 60)
    print("üß™ Running SubscriptionRepository tests...")
    print("=" * 60)
    
    try:
        hardware_id = test_create_subscription()
        test_get_subscription(hardware_id)
        test_update_status(hardware_id)
        test_update_stripe_ids(hardware_id)
        test_event_idempotency()
        
        print("=" * 60)
        print("‚úÖ All tests PASSED")
        print("=" * 60)
        return 0
    except AssertionError as e:
        print(f"‚ùå Test FAILED: {e}")
        return 1
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    sys.exit(main())
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –¢–∞–±–ª–∏—Ü—ã `subscriptions` –∏ `subscription_events` —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Repository
- [ ] –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ hardware_id
- [ ] –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å Stripe IDs
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç (–¥—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- [ ] –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
cd mvp_tests
source .venv/bin/activate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
psql $DATABASE_URL -f migrations/001_create_subscriptions.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_subscription_repository.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**

```
============================================================
üß™ Running SubscriptionRepository tests...
============================================================
üß™ Test: Create subscription for test_hw_1234567890
‚úÖ Create subscription: PASSED
üß™ Test: Get subscription for test_hw_1234567890
‚úÖ Get subscription: PASSED
üß™ Test: Update status for test_hw_1234567890
‚úÖ Update status: PASSED
üß™ Test: Update Stripe IDs for test_hw_1234567890
‚úÖ Update Stripe IDs: PASSED
üß™ Test: Event idempotency for evt_test_1234567890
‚úÖ Event idempotency: PASSED
============================================================
‚úÖ All tests PASSED
============================================================
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
psql $DATABASE_URL -c "SELECT * FROM subscriptions LIMIT 5;"
psql $DATABASE_URL -c "SELECT * FROM subscription_events LIMIT 5;"
```

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–í –ë–î:**
   - –¢–∞–±–ª–∏—Ü—ã `subscriptions` –∏ `subscription_events` —Å–æ–∑–¥–∞–Ω—ã
   - –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

2. **–í –∫–æ–¥–µ:**
   - `SubscriptionRepository` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –í—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** –û—à–∏–±–∫–∞ "relation does not exist"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
psql $DATABASE_URL -f migrations/001_create_subscriptions.sql
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DATABASE_URL –≤ .env
echo $DATABASE_URL
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: postgresql://user:pass@localhost/dbname
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** –û—à–∏–±–∫–∞ "duplicate key value"
```bash
# –†–µ—à–µ–Ω–∏–µ: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ ON CONFLICT —Ä–∞–±–æ—Ç–∞–µ—Ç
```

---

## üì¶ MVP 3: Stripe Service

**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ Checkout Session (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ, –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 0

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Stripe Service

**–§–∞–π–ª:** `mvp_tests/stripe_service.py`

```python
#!/usr/bin/env python3
"""Stripe Service –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Stripe API"""
import stripe
from typing import Dict, Optional
import os
from dotenv import load_dotenv

load_dotenv()

class StripeService:
    def __init__(self, api_key: Optional[str] = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Stripe Service"""
        self.api_key = api_key or os.getenv('STRIPE_SECRET_KEY')
        if not self.api_key:
            raise ValueError("STRIPE_SECRET_KEY not found")
        stripe.api_key = self.api_key
    
    def create_checkout_session(
        self,
        hardware_id: str,
        success_url: str,
        cancel_url: str,
        price_id: Optional[str] = None
    ) -> Dict:
        """
        –°–æ–∑–¥–∞—Ç—å Checkout Session –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
        
        Args:
            hardware_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            success_url: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
            cancel_url: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
            price_id: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π Stripe Price ID (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
        
        Returns:
            Dict —Å checkout_url, session_id, customer_id
        """
        try:
            print(f"[STRIPE] Creating checkout session for hardware_id: {hardware_id}")
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
            session_params = {
                'mode': 'subscription',
                'success_url': success_url,
                'cancel_url': cancel_url,
                'metadata': {
                    'hardware_id': hardware_id,
                },
                'allow_promotion_codes': True,
            }
            
            # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω price_id, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if price_id:
                session_params['line_items'] = [{
                    'price': price_id,
                    'quantity': 1,
                }]
            else:
                # –°–æ–∑–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π price
                session_params['line_items'] = [{
                    'price_data': {
                        'currency': 'usd',
                        'product_data': {
                            'name': 'Nexy Premium',
                            'description': 'Unlimited access to Nexy AI Assistant',
                        },
                        'recurring': {
                            'interval': 'month',
                        },
                        'unit_amount': 999,  # $9.99 –≤ —Ü–µ–Ω—Ç–∞—Ö
                    },
                    'quantity': 1,
                }]
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
            session = stripe.checkout.Session.create(**session_params)
            
            result = {
                'checkout_url': session.url,
                'session_id': session.id,
                'customer_id': session.customer,
                'subscription_id': session.subscription,
            }
            
            print(f"[STRIPE] ‚úÖ Checkout session created: {session.id}")
            print(f"[STRIPE] URL: {session.url}")
            
            return result
            
        except stripe.error.StripeError as e:
            print(f"[STRIPE] ‚ùå Stripe error: {e}")
            raise
        except Exception as e:
            print(f"[STRIPE] ‚ùå Error creating checkout: {e}")
            raise
    
    def get_checkout_session(self, session_id: str) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Checkout Session"""
        try:
            session = stripe.checkout.Session.retrieve(session_id)
            return {
                'id': session.id,
                'status': session.status,
                'customer_id': session.customer,
                'subscription_id': session.subscription,
                'payment_status': session.payment_status,
                'url': session.url,
            }
        except stripe.error.StripeError as e:
            print(f"[STRIPE] ‚ùå Error retrieving session: {e}")
            raise
    
    def verify_webhook_signature(
        self,
        payload: bytes,
        signature: str,
        secret: Optional[str] = None
    ) -> Optional[stripe.Event]:
        """
        –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ webhook –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        
        Returns:
            stripe.Event –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –≤–∞–ª–∏–¥–Ω–∞, None –µ—Å–ª–∏ –Ω–µ—Ç
        """
        webhook_secret = secret or os.getenv('STRIPE_WEBHOOK_SECRET')
        if not webhook_secret:
            print("[STRIPE] ‚ö†Ô∏è STRIPE_WEBHOOK_SECRET not found, skipping verification")
            return None
        
        try:
            event = stripe.Webhook.construct_event(
                payload, signature, webhook_secret
            )
            print(f"[STRIPE] ‚úÖ Webhook signature verified: {event['id']}")
            return event
        except ValueError as e:
            print(f"[STRIPE] ‚ùå Invalid payload: {e}")
            return None
        except stripe.error.SignatureVerificationError as e:
            print(f"[STRIPE] ‚ùå Invalid signature: {e}")
            return None
    
    def get_customer(self, customer_id: str) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ"""
        try:
            customer = stripe.Customer.retrieve(customer_id)
            return {
                'id': customer.id,
                'email': customer.email,
                'created': customer.created,
            }
        except stripe.error.StripeError as e:
            print(f"[STRIPE] ‚ùå Error retrieving customer: {e}")
            raise
    
    def get_subscription(self, subscription_id: str) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ"""
        try:
            subscription = stripe.Subscription.retrieve(subscription_id)
            return {
                'id': subscription.id,
                'status': subscription.status,
                'customer_id': subscription.customer,
                'current_period_end': subscription.current_period_end,
                'cancel_at_period_end': subscription.cancel_at_period_end,
            }
        except stripe.error.StripeError as e:
            print(f"[STRIPE] ‚ùå Error retrieving subscription: {e}")
            raise
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–§–∞–π–ª:** `mvp_tests/test_stripe_service.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç—ã –¥–ª—è StripeService"""
import sys
import os
from dotenv import load_dotenv
from stripe_service import StripeService

load_dotenv()

def test_create_checkout_session():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è Checkout Session"""
    print("üß™ Test: Create checkout session")
    
    service = StripeService()
    hardware_id = f"test_hw_{os.getpid()}"
    
    result = service.create_checkout_session(
        hardware_id=hardware_id,
        success_url="https://example.com/success",
        cancel_url="https://example.com/cancel"
    )
    
    assert 'checkout_url' in result, "Should have checkout_url"
    assert 'session_id' in result, "Should have session_id"
    assert result['checkout_url'].startswith('https://checkout.stripe.com'), "URL should be Stripe checkout"
    
    print(f"‚úÖ Checkout URL: {result['checkout_url']}")
    print(f"‚úÖ Session ID: {result['session_id']}")
    print("‚úÖ Create checkout session: PASSED")
    
    return result['session_id']

def test_get_checkout_session(session_id: str):
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏"""
    print(f"üß™ Test: Get checkout session {session_id}")
    
    service = StripeService()
    session = service.get_checkout_session(session_id)
    
    assert session['id'] == session_id, "Session ID should match"
    assert 'status' in session, "Should have status"
    
    print(f"‚úÖ Session status: {session['status']}")
    print("‚úÖ Get checkout session: PASSED")

def test_webhook_verification():
    """–¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ webhook –ø–æ–¥–ø–∏—Å–∏"""
    print("üß™ Test: Webhook signature verification")
    
    service = StripeService()
    
    # –¢–µ—Å—Ç–æ–≤—ã–π payload –∏ signature (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç Stripe)
    # –î–ª—è MVP –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ –Ω–µ –ø–∞–¥–∞–µ—Ç
    test_payload = b'{"id":"evt_test"}'
    test_signature = "test_signature"
    
    # –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å None –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏
    result = service.verify_webhook_signature(
        test_payload,
        test_signature,
        "invalid_secret"
    )
    
    assert result is None, "Invalid signature should return None"
    print("‚úÖ Webhook verification: PASSED")

def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("=" * 60)
    print("üß™ Running StripeService tests...")
    print("=" * 60)
    
    try:
        session_id = test_create_checkout_session()
        test_get_checkout_session(session_id)
        test_webhook_verification()
        
        print("=" * 60)
        print("‚úÖ All tests PASSED")
        print("=" * 60)
        print("\nüí° Next steps:")
        print(f"   1. Open checkout URL in browser")
        print(f"   2. Use test card: 4242 4242 4242 4242")
        print(f"   3. Any future expiry date, any CVC")
        return 0
    except AssertionError as e:
        print(f"‚ùå Test FAILED: {e}")
        return 1
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    sys.exit(main())
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `StripeService` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å API –∫–ª—é—á–æ–º
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Checkout Session
- [ ] –ü–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–π `checkout_url` (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `https://checkout.stripe.com`)
- [ ] –ü–æ–ª—É—á–∞–µ–º `session_id` –∏ `customer_id`
- [ ] –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏ –ø–æ `session_id`
- [ ] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
cd mvp_tests
source .venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_stripe_service.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**

```
============================================================
üß™ Running StripeService tests...
============================================================
[STRIPE] Creating checkout session for hardware_id: test_hw_12345
[STRIPE] ‚úÖ Checkout session created: cs_test_...
[STRIPE] URL: https://checkout.stripe.com/c/pay/cs_test_...
üß™ Test: Create checkout session
‚úÖ Checkout URL: https://checkout.stripe.com/c/pay/cs_test_...
‚úÖ Session ID: cs_test_...
‚úÖ Create checkout session: PASSED
üß™ Test: Get checkout session cs_test_...
‚úÖ Session status: open
‚úÖ Get checkout session: PASSED
üß™ Test: Webhook signature verification
‚úÖ Webhook verification: PASSED
============================================================
‚úÖ All tests PASSED
============================================================

üí° Next steps:
   1. Open checkout URL in browser
   2. Use test card: 4242 4242 4242 4242
   3. Any future expiry date, any CVC
```

**–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `checkout_url` –∏–∑ –≤—ã–≤–æ–¥–∞
2. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É Stripe:
   - –ù–æ–º–µ—Ä: `4242 4242 4242 4242`
   - –î–∞—Ç–∞: –ª—é–±–∞—è –±—É–¥—É—â–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `12/25`)
   - CVC: –ª—é–±–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `123`)
   - ZIP: –ª—é–±–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `12345`)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `success_url` —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

1. **–í –∫–æ–¥–µ:**
   - `StripeService` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å Checkout Sessions
   - –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö

2. **–í Stripe Dashboard:**
   - –í–∏–¥–Ω—ã —Å–æ–∑–¥–∞–Ω–Ω—ã–µ Checkout Sessions
   - –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–π
   - –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** –û—à–∏–±–∫–∞ "Invalid API Key"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å STRIPE_SECRET_KEY –≤ .env
# –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å sk_test_ –¥–ª—è test mode
echo $STRIPE_SECRET_KEY
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –û—à–∏–±–∫–∞ "No such price"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π price_data (—É–∂–µ –≤ –∫–æ–¥–µ)
# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å Price –≤ Stripe Dashboard –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å price_id
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** Checkout URL –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
# URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://checkout.stripe.com
```

---

## üì¶ MVP 4: Subscription Repository + –ë–î

**–¶–µ–ª—å:** –ü–æ–ª–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ MVP 2)

**–í—Ä–µ–º—è:** 1 –¥–µ–Ω—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 2

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–§–∞–π–ª:** `mvp_tests/migrations/002_add_usage_tracking.sql`

```sql
-- MVP 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (usage tracking)

CREATE TABLE IF NOT EXISTS subscription_usage (
    id SERIAL PRIMARY KEY,
    hardware_id VARCHAR(255) NOT NULL,
    usage_date DATE NOT NULL,
    daily_count INTEGER DEFAULT 0,
    weekly_count INTEGER DEFAULT 0,
    monthly_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(hardware_id, usage_date)
);

CREATE INDEX IF NOT EXISTS idx_subscription_usage_hardware ON subscription_usage(hardware_id);
CREATE INDEX IF NOT EXISTS idx_subscription_usage_date ON subscription_usage(usage_date);

COMMENT ON TABLE subscription_usage IS '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–≤–æ—Ç';
```

#### –®–∞–≥ 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Repository

**–û–±–Ω–æ–≤–∏—Ç—å:** `mvp_tests/subscription_repository.py`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:**

```python
def increment_usage(self, hardware_id: str) -> bool:
    """–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    from datetime import date
    conn = self._get_connection()
    try:
        with conn.cursor() as cur:
            # Upsert –¥–ª—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
            cur.execute(
                """INSERT INTO subscription_usage 
                   (hardware_id, usage_date, daily_count, weekly_count, monthly_count)
                   VALUES (%s, CURRENT_DATE, 1, 1, 1)
                   ON CONFLICT (hardware_id, usage_date) 
                   DO UPDATE SET 
                       daily_count = subscription_usage.daily_count + 1,
                       weekly_count = subscription_usage.weekly_count + 1,
                       monthly_count = subscription_usage.monthly_count + 1,
                       updated_at = CURRENT_TIMESTAMP""",
                (hardware_id,)
            )
            conn.commit()
            return cur.rowcount > 0
    finally:
        conn.close()

def get_usage_stats(self, hardware_id: str) -> Dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    conn = self._get_connection()
    try:
        with conn.cursor(cursor_factory=RealDictCursor) as cur:
            # –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å
            cur.execute(
                """SELECT daily_count, weekly_count, monthly_count
                   FROM subscription_usage
                   WHERE hardware_id = %s AND usage_date = CURRENT_DATE""",
                (hardware_id,)
            )
            today = cur.fetchone()
            
            return {
                'daily_used': today['daily_count'] if today else 0,
                'weekly_used': today['weekly_count'] if today else 0,
                'monthly_used': today['monthly_count'] if today else 0,
            }
    finally:
        conn.close()
```

#### –®–∞–≥ 3: –¢–µ—Å—Ç—ã

**–§–∞–π–ª:** `mvp_tests/test_subscription_repository_extended.py`

```python
#!/usr/bin/env python3
"""–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è SubscriptionRepository"""
import sys
from datetime import datetime
from subscription_repository import SubscriptionRepository

def test_usage_tracking():
    """–¢–µ—Å—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    repo = SubscriptionRepository()
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    
    # –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
    repo.create_subscription(hardware_id)
    
    # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    repo.increment_usage(hardware_id)
    repo.increment_usage(hardware_id)
    
    # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = repo.get_usage_stats(hardware_id)
    
    assert stats['daily_used'] >= 2, "Daily count should be at least 2"
    print("‚úÖ Usage tracking: PASSED")

if __name__ == '__main__':
    test_usage_tracking()
    print("‚úÖ All extended tests PASSED")
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –¢–∞–±–ª–∏—Ü–∞ `subscription_usage` —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–µ—Ç–æ–¥ `increment_usage()` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ú–µ—Ç–æ–¥ `get_usage_stats()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd mvp_tests
source .venv/bin/activate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
psql $DATABASE_URL -f migrations/002_add_usage_tracking.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_subscription_repository_extended.py
```

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- –¢–∞–±–ª–∏—Ü–∞ `subscription_usage` —Å–æ–∑–¥–∞–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
- –ú–æ–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üì¶ MVP 5: Subscription Context

**–¶–µ–ª—å:** –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ workflow)

**–í—Ä–µ–º—è:** 1 –¥–µ–Ω—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 4

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ SubscriptionContext

**–§–∞–π–ª:** `mvp_tests/subscription_context.py`

```python
#!/usr/bin/env python3
"""SubscriptionContext - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è LLM"""
from subscription_repository import SubscriptionRepository
from datetime import datetime, timedelta
from typing import Dict, Optional
import os
from dotenv import load_dotenv

load_dotenv()

class SubscriptionContext:
    def __init__(self, repo: Optional[SubscriptionRepository] = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SubscriptionContext"""
        if repo:
            self.repo = repo
        else:
            from subscription_repository import SubscriptionRepository
            self.repo = SubscriptionRepository()
    
    def get_context(self, hardware_id: str) -> Dict:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∫–∏
        
        Returns:
            Dict —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–¥–ø–∏—Å–∫–µ
        """
        subscription = self.repo.get_subscription(hardware_id)
        
        if not subscription:
            # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É —Å trial –ø–µ—Ä–∏–æ–¥–æ–º
            trial_end = datetime.now() + timedelta(days=14)
            subscription = self.repo.create_subscription(
                hardware_id,
                status='paid_trial',
                paid_trial_end_at=trial_end
            )
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = {
            'hardware_id': hardware_id,
            'status': subscription['status'],
            'stripe_customer_id': subscription.get('stripe_customer_id'),
            'stripe_subscription_id': subscription.get('stripe_subscription_id'),
        }
        
        # Trial –ø–µ—Ä–∏–æ–¥
        if subscription.get('paid_trial_end_at'):
            trial_end = subscription['paid_trial_end_at']
            if isinstance(trial_end, str):
                trial_end = datetime.fromisoformat(trial_end.replace('Z', '+00:00'))
            days_left = (trial_end - datetime.now()).days
            context['trial_days_left'] = max(0, days_left)
            context['trial_end_at'] = trial_end.isoformat()
        
        # Grace period
        if subscription.get('grace_period_end_at'):
            grace_end = subscription['grace_period_end_at']
            if isinstance(grace_end, str):
                grace_end = datetime.fromisoformat(grace_end.replace('Z', '+00:00'))
            context['grace_period_end_at'] = grace_end.isoformat()
            context['grace_period_active'] = grace_end > datetime.now()
        
        # Usage stats
        usage_stats = self.repo.get_usage_stats(hardware_id)
        context.update(usage_stats)
        
        return context
    
    def format_for_llm(self, context: Dict) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM prompt
        
        Returns:
            –°—Ç—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ system prompt
        """
        status = context['status']
        lines = []
        
        if status == 'paid_trial':
            days = context.get('trial_days_left', 0)
            lines.append(f"User subscription: Paid trial period ({days} days remaining).")
            if days <= 2:
                lines.append(f"‚ö†Ô∏è IMPORTANT: Trial expires in {days} day(s). User should be informed about subscription options.")
        elif status == 'paid':
            lines.append("User subscription: Active paid subscription. Full access enabled.")
        elif status == 'billing_problem':
            grace_active = context.get('grace_period_active', False)
            if grace_active:
                lines.append("User subscription: Billing problem detected, but grace period is active (1 day). Full access maintained.")
            else:
                lines.append("User subscription: Billing problem - grace period expired. Limited access.")
        elif status == 'limited_free_trial':
            daily_used = context.get('daily_used', 0)
            daily_limit = 5
            lines.append(f"User subscription: Limited free trial. Usage: {daily_used}/{daily_limit} requests today.")
            if daily_used >= daily_limit:
                lines.append("‚ö†Ô∏è IMPORTANT: Daily limit reached. User should be informed about subscription options.")
        else:
            lines.append(f"User subscription status: {status}")
        
        return "\n".join(lines)
    
    def get_context_for_prompt(self, hardware_id: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM prompt"""
        context = self.get_context(hardware_id)
        return self.format_for_llm(context)
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–§–∞–π–ª:** `mvp_tests/test_subscription_context.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç—ã –¥–ª—è SubscriptionContext"""
import sys
from datetime import datetime, timedelta
from subscription_context import SubscriptionContext
from subscription_repository import SubscriptionRepository

def test_get_context_new_user():
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print("üß™ Test: Get context for new user")
    
    repo = SubscriptionRepository()
    context_builder = SubscriptionContext(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    context = context_builder.get_context(hardware_id)
    
    assert context['status'] == 'paid_trial', "New user should have paid_trial status"
    assert 'trial_days_left' in context, "Should have trial_days_left"
    assert context['trial_days_left'] >= 0, "Trial days should be non-negative"
    
    print(f"‚úÖ Status: {context['status']}")
    print(f"‚úÖ Trial days left: {context['trial_days_left']}")
    print("‚úÖ Get context for new user: PASSED")

def test_format_for_llm():
    """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è LLM"""
    print("üß™ Test: Format context for LLM")
    
    repo = SubscriptionRepository()
    context_builder = SubscriptionContext(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    formatted = context_builder.get_context_for_prompt(hardware_id)
    
    assert len(formatted) > 0, "Formatted text should not be empty"
    assert 'subscription' in formatted.lower(), "Should mention subscription"
    
    print(f"‚úÖ Formatted text:\n{formatted}")
    print("‚úÖ Format for LLM: PASSED")

def test_context_with_different_statuses():
    """–¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"""
    print("üß™ Test: Context with different statuses")
    
    repo = SubscriptionRepository()
    context_builder = SubscriptionContext(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    repo.create_subscription(hardware_id, status='paid')
    repo.update_status(hardware_id, 'paid')
    
    context = context_builder.get_context(hardware_id)
    formatted = context_builder.format_for_llm(context)
    
    assert 'paid subscription' in formatted.lower(), "Should mention paid subscription"
    print("‚úÖ Context with different statuses: PASSED")

def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("=" * 60)
    print("üß™ Running SubscriptionContext tests...")
    print("=" * 60)
    
    try:
        test_get_context_new_user()
        test_format_for_llm()
        test_context_with_different_statuses()
        
        print("=" * 60)
        print("‚úÖ All tests PASSED")
        print("=" * 60)
        return 0
    except AssertionError as e:
        print(f"‚ùå Test FAILED: {e}")
        return 1
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    sys.exit(main())
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `SubscriptionContext` —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç trial days, grace period, usage stats
- [ ] `format_for_llm()` —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (paid_trial, paid, billing_problem, limited_free_trial)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd mvp_tests
source .venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_subscription_context.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**

```
============================================================
üß™ Running SubscriptionContext tests...
============================================================
üß™ Test: Get context for new user
‚úÖ Status: paid_trial
‚úÖ Trial days left: 14
‚úÖ Get context for new user: PASSED
üß™ Test: Format context for LLM
‚úÖ Formatted text:
User subscription: Paid trial period (14 days remaining).
‚úÖ Format for LLM: PASSED
üß™ Test: Context with different statuses
‚úÖ Context with different statuses: PASSED
============================================================
‚úÖ All tests PASSED
============================================================
```

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≥–æ—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ LLM prompt
- –í–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π (trial –∏—Å—Ç–µ–∫–∞–µ—Ç, –ª–∏–º–∏—Ç—ã –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã)

---

## üì¶ MVP 6: Quota Checker

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ)

**–í—Ä–µ–º—è:** 1 –¥–µ–Ω—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 4

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ QuotaChecker

**–§–∞–π–ª:** `mvp_tests/quota_checker.py`

```python
#!/usr/bin/env python3
"""QuotaChecker - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫"""
from subscription_repository import SubscriptionRepository
from datetime import datetime, timedelta
from typing import Dict, Optional
import os
from dotenv import load_dotenv

load_dotenv()

class QuotaChecker:
    # –õ–∏–º–∏—Ç—ã –¥–ª—è limited_free_trial
    DAILY_LIMIT = 5
    WEEKLY_LIMIT = 25
    MONTHLY_LIMIT = 50
    
    def __init__(self, repo: Optional[SubscriptionRepository] = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è QuotaChecker"""
        if repo:
            self.repo = repo
        else:
            from subscription_repository import SubscriptionRepository
            self.repo = SubscriptionRepository()
    
    def check_quota(self, hardware_id: str, status: Optional[str] = None) -> Dict:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–æ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            hardware_id: ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            status: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ë–î)
        
        Returns:
            Dict —Å allowed (bool), reason (str), –∏ –¥–µ—Ç–∞–ª—è–º–∏
        """
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –ë–î, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if not status:
            subscription = self.repo.get_subscription(hardware_id)
            if not subscription:
                # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                subscription = self.repo.create_subscription(hardware_id)
            status = subscription['status']
        
        # –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
        if status in ['paid_trial', 'paid', 'admin_active', 'grandfathered']:
            return {
                'allowed': True,
                'reason': 'unlimited_access',
                'status': status,
                'limits': None
            }
        
        # Billing problem - –ø—Ä–æ–≤–µ—Ä—è–µ–º grace period
        if status == 'billing_problem':
            subscription = self.repo.get_subscription(hardware_id)
            grace_end = subscription.get('grace_period_end_at')
            
            if grace_end:
                if isinstance(grace_end, str):
                    grace_end = datetime.fromisoformat(grace_end.replace('Z', '+00:00'))
                
                if grace_end > datetime.now():
                    # Grace period –∞–∫—Ç–∏–≤–µ–Ω
                    hours_left = (grace_end - datetime.now()).total_seconds() / 3600
                    return {
                        'allowed': True,
                        'reason': 'grace_period_active',
                        'status': status,
                        'grace_period_hours_left': round(hours_left, 1)
                    }
            
            # Grace period –∏—Å—Ç–µ–∫
            return {
                'allowed': False,
                'reason': 'grace_period_expired',
                'status': status,
                'message': 'Grace period expired. Please update payment method.'
            }
        
        # Limited free trial - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
        if status == 'limited_free_trial':
            usage_stats = self.repo.get_usage_stats(hardware_id)
            daily_used = usage_stats.get('daily_used', 0)
            weekly_used = usage_stats.get('weekly_used', 0)
            monthly_used = usage_stats.get('monthly_used', 0)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ª–∏–º–∏—Ç—ã
            daily_exceeded = daily_used >= self.DAILY_LIMIT
            weekly_exceeded = weekly_used >= self.WEEKLY_LIMIT
            monthly_exceeded = monthly_used >= self.MONTHLY_LIMIT
            
            if daily_exceeded or weekly_exceeded or monthly_exceeded:
                exceeded_limits = []
                if daily_exceeded:
                    exceeded_limits.append(f'daily ({daily_used}/{self.DAILY_LIMIT})')
                if weekly_exceeded:
                    exceeded_limits.append(f'weekly ({weekly_used}/{self.WEEKLY_LIMIT})')
                if monthly_exceeded:
                    exceeded_limits.append(f'monthly ({monthly_used}/{self.MONTHLY_LIMIT})')
                
                return {
                    'allowed': False,
                    'reason': 'quota_exceeded',
                    'status': status,
                    'exceeded_limits': exceeded_limits,
                    'usage': {
                        'daily': f"{daily_used}/{self.DAILY_LIMIT}",
                        'weekly': f"{weekly_used}/{self.WEEKLY_LIMIT}",
                        'monthly': f"{monthly_used}/{self.MONTHLY_LIMIT}"
                    },
                    'message': f'Quota exceeded: {", ".join(exceeded_limits)}. Please subscribe for unlimited access.'
                }
            
            # –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤
            return {
                'allowed': True,
                'reason': 'within_limits',
                'status': status,
                'usage': {
                    'daily': f"{daily_used}/{self.DAILY_LIMIT}",
                    'weekly': f"{weekly_used}/{self.WEEKLY_LIMIT}",
                    'monthly': f"{monthly_used}/{self.MONTHLY_LIMIT}"
                }
            }
        
        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å - –±–ª–æ–∫–∏—Ä—É–µ–º
        return {
            'allowed': False,
            'reason': 'unknown_status',
            'status': status,
            'message': f'Unknown subscription status: {status}'
        }
    
    def can_proceed(self, hardware_id: str) -> bool:
        """–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"""
        result = self.check_quota(hardware_id)
        return result.get('allowed', False)
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–§–∞–π–ª:** `mvp_tests/test_quota_checker.py`

```python
#!/usr/bin/env python3
"""–¢–µ—Å—Ç—ã –¥–ª—è QuotaChecker"""
import sys
from datetime import datetime, timedelta
from quota_checker import QuotaChecker
from subscription_repository import SubscriptionRepository

def test_unlimited_access():
    """–¢–µ—Å—Ç –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞"""
    print("üß™ Test: Unlimited access")
    
    repo = SubscriptionRepository()
    checker = QuotaChecker(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    repo.create_subscription(hardware_id, status='paid')
    
    result = checker.check_quota(hardware_id)
    
    assert result['allowed'] == True, "Paid subscription should allow access"
    assert result['reason'] == 'unlimited_access', "Should be unlimited"
    
    print("‚úÖ Unlimited access: PASSED")

def test_limited_free_trial():
    """–¢–µ—Å—Ç limited free trial"""
    print("üß™ Test: Limited free trial")
    
    repo = SubscriptionRepository()
    checker = QuotaChecker(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    repo.create_subscription(hardware_id, status='limited_free_trial')
    
    # –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤
    result = checker.check_quota(hardware_id)
    assert result['allowed'] == True, "Should allow within limits"
    assert result['reason'] == 'within_limits', "Should be within limits"
    
    # –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
    for _ in range(6):  # –ü—Ä–µ–≤—ã—à–∞–µ–º daily limit (5)
        repo.increment_usage(hardware_id)
    
    result = checker.check_quota(hardware_id)
    assert result['allowed'] == False, "Should block when limit exceeded"
    assert result['reason'] == 'quota_exceeded', "Should indicate quota exceeded"
    
    print("‚úÖ Limited free trial: PASSED")

def test_grace_period():
    """–¢–µ—Å—Ç grace period"""
    print("üß™ Test: Grace period")
    
    repo = SubscriptionRepository()
    checker = QuotaChecker(repo)
    
    hardware_id = f"test_hw_{datetime.now().timestamp()}"
    repo.create_subscription(hardware_id, status='billing_problem')
    
    # Grace period –∞–∫—Ç–∏–≤–µ–Ω
    grace_end = datetime.now() + timedelta(hours=12)
    repo.update_stripe_ids(hardware_id)  # –û–±–Ω–æ–≤–∏–º –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ grace_period_end_at
    # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ update_grace_period_end_at
    
    result = checker.check_quota(hardware_id)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    print("‚úÖ Grace period: PASSED")

def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("=" * 60)
    print("üß™ Running QuotaChecker tests...")
    print("=" * 60)
    
    try:
        test_unlimited_access()
        test_limited_free_trial()
        test_grace_period()
        
        print("=" * 60)
        print("‚úÖ All tests PASSED")
        print("=" * 60)
        return 0
    except AssertionError as e:
        print(f"‚ùå Test FAILED: {e}")
        return 1
    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    sys.exit(main())
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è paid_trial, paid, admin_active, grandfathered
- [ ] Grace period –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–ª—è billing_problem
- [ ] –õ–∏–º–∏—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–ª—è limited_free_trial (5/25/50)
- [ ] –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd mvp_tests
source .venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
python test_quota_checker.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**

```
============================================================
üß™ Running QuotaChecker tests...
============================================================
üß™ Test: Unlimited access
‚úÖ Unlimited access: PASSED
üß™ Test: Limited free trial
‚úÖ Limited free trial: PASSED
üß™ Test: Grace period
‚úÖ Grace period: PASSED
============================================================
‚úÖ All tests PASSED
============================================================
```

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- QuotaChecker –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –í–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–ª—è limited_free_trial

---

## üì¶ MVP 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Workflow

**–¶–µ–ª—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ subscription context –≤ LLM prompt (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 5, MVP 6

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Subscription Module (—Å–µ—Ä–≤–µ—Ä)

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/modules/subscription/core/subscription_module.py`

```python
#!/usr/bin/env python3
"""Subscription Module –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞"""
from typing import Dict, Optional
import logging
from subscription_context import SubscriptionContext
from quota_checker import QuotaChecker
from subscription_repository import SubscriptionRepository

logger = logging.getLogger(__name__)

class SubscriptionModule:
    """–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏"""
    
    def __init__(self, db_url: str):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è"""
        self.repo = SubscriptionRepository(db_url)
        self.context_builder = SubscriptionContext(self.repo)
        self.quota_checker = QuotaChecker(self.repo)
    
    def get_context(self, hardware_id: str) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∫–∏"""
        try:
            context = self.context_builder.get_context(hardware_id)
            formatted = self.context_builder.format_for_llm(context)
            return {
                'context': context,
                'formatted_text': formatted
            }
        except Exception as e:
            logger.error(f"[SubscriptionModule] Error getting context: {e}")
            return {
                'context': {'status': 'unknown'},
                'formatted_text': ''
            }
    
    def check_quota(self, hardware_id: str) -> Dict:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–æ—Ç—ã"""
        return self.quota_checker.check_quota(hardware_id)
```

#### –®–∞–≥ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ StreamingWorkflowIntegration

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
# –í –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ _process_request_streaming, –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è hardware_id:

# MVP 7: –ü–æ–ª—É—á–µ–Ω–∏–µ subscription context –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç
subscription_context_text = ""
try:
    subscription_module = self.module_coordinator.get_module("subscription")
    if subscription_module:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç
        quota_result = subscription_module.check_quota(hardware_id)
        
        if not quota_result.get('allowed', False):
            # –ö–≤–æ—Ç–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞ - –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
            error_message = quota_result.get('message', 'Quota exceeded')
            logger.warning(f"[MVP7] Quota exceeded for {hardware_id}: {error_message}")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            yield {
                'text_chunk': f"I'm sorry, but {error_message}. Please subscribe for unlimited access.",
                'session_id': session_id,
                'feature_id': 'F-2025-017-stripe-payment'
            }
            return  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM
        context_data = subscription_module.get_context(hardware_id)
        subscription_context_text = context_data.get('formatted_text', '')
        
        logger.info(f"[MVP7] Subscription context added for {hardware_id}")
except Exception as e:
    logger.warning(f"[MVP7] Subscription context error: {e}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ subscription context (fallback)

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ prompt
if subscription_context_text:
    enhanced_prompt = f"""{subscription_context_text}

User request: {request.prompt}"""
    request.prompt = enhanced_prompt
```

#### –®–∞–≥ 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/modules/subscription/__init__.py`

```python
from .core.subscription_module import SubscriptionModule

__all__ = ['SubscriptionModule']
```

**–û–±–Ω–æ–≤–∏—Ç—å:** `server/modules/module_factory.py` (–¥–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ SubscriptionModule)

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] SubscriptionModule —Å–æ–∑–¥–∞–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] Subscription context –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ LLM prompt
- [ ] Quota –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
- [ ] LLM –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ —Å–ª–æ–º–∞–Ω (fallback —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] –ú–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å end-to-end

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
cd v1.0.6\ Payment/server(Payment)
source .venv/bin/activate
python server/main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. **–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:**
   ```
   [MVP7] Subscription context added for hardware_id_123
   ```

2. **–í LLM prompt:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω subscription context
   - LLM –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ

3. **–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–æ—Ç—ã:**
   - –ó–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- Subscription context –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- Quota enforcement —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- LLM —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ

---

## üì¶ MVP 8: –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏

**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ create_subscription/cancel_subscription

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 3, MVP 7

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SubscriptionModule –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Checkout

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/modules/subscription/core/subscription_module.py`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:**

```python
from stripe_service import StripeService
import os
from dotenv import load_dotenv

load_dotenv()

class SubscriptionModule:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    def __init__(self, db_url: str):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è"""
        self.repo = SubscriptionRepository(db_url)
        self.context_builder = SubscriptionContext(self.repo)
        self.quota_checker = QuotaChecker(self.repo)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Stripe Service
        stripe_key = os.getenv('STRIPE_SECRET_KEY')
        if not stripe_key:
            logger.warning("[SubscriptionModule] STRIPE_SECRET_KEY not found")
        self.stripe_service = StripeService(stripe_key) if stripe_key else None
    
    def create_checkout(
        self, 
        hardware_id: str,
        success_url: Optional[str] = None,
        cancel_url: Optional[str] = None
    ) -> Dict:
        """
        –°–æ–∑–¥–∞—Ç—å Checkout Session –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
        
        Args:
            hardware_id: ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            success_url: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
            cancel_url: URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
        
        Returns:
            Dict —Å checkout_url, session_id, error (–µ—Å–ª–∏ –µ—Å—Ç—å)
        """
        if not self.stripe_service:
            return {
                'error': 'Stripe service not configured',
                'checkout_url': None
            }
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            subscription = self.repo.get_subscription(hardware_id)
            if not subscription:
                subscription = self.repo.create_subscription(hardware_id)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º URLs –¥–ª—è deep links
            base_url = os.getenv('DEEP_LINK_BASE_URL', 'nexy://')
            if not success_url:
                success_url = f"{base_url}checkout/success?session_id={{CHECKOUT_SESSION_ID}}"
            if not cancel_url:
                cancel_url = f"{base_url}checkout/cancel"
            
            # –°–æ–∑–¥–∞–µ–º Checkout Session
            result = self.stripe_service.create_checkout_session(
                hardware_id=hardware_id,
                success_url=success_url,
                cancel_url=cancel_url
            )
            
            logger.info(f"[SubscriptionModule] Checkout created for {hardware_id}: {result['session_id']}")
            
            return {
                'checkout_url': result['checkout_url'],
                'session_id': result['session_id'],
                'customer_id': result.get('customer_id'),
                'error': None
            }
            
        except Exception as e:
            logger.error(f"[SubscriptionModule] Error creating checkout: {e}")
            return {
                'error': str(e),
                'checkout_url': None
            }
    
    def cancel_subscription(self, hardware_id: str) -> Dict:
        """
        –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        
        Args:
            hardware_id: ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        
        Returns:
            Dict —Å success (bool), message (str)
        """
        try:
            subscription = self.repo.get_subscription(hardware_id)
            if not subscription:
                return {
                    'success': False,
                    'message': 'Subscription not found'
                }
            
            stripe_subscription_id = subscription.get('stripe_subscription_id')
            if not stripe_subscription_id:
                # –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (trial) - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                self.repo.update_status(hardware_id, 'limited_free_trial')
                return {
                    'success': True,
                    'message': 'Trial subscription cancelled'
                }
            
            # –û—Ç–º–µ–Ω—è–µ–º –≤ Stripe
            if self.stripe_service:
                # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ cancel_subscription –≤ StripeService
                # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                self.repo.update_status(hardware_id, 'limited_free_trial')
                return {
                    'success': True,
                    'message': 'Subscription cancelled'
                }
            
            return {
                'success': False,
                'message': 'Stripe service not available'
            }
            
        except Exception as e:
            logger.error(f"[SubscriptionModule] Error cancelling subscription: {e}")
            return {
                'success': False,
                'message': str(e)
            }
```

#### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AssistantResponseParser

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/integrations/core/assistant_response_parser.py`

**–î–æ–±–∞–≤–∏—Ç—å –≤ –º–µ—Ç–æ–¥ `parse()`:**

```python
def parse(self, text: str) -> Optional[Dict]:
    """–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ LLM –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥"""
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # MVP 8: –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –ø–æ–¥–ø–∏—Å–∫–∏
    text_lower = text.lower()
    
    # –ö–æ–º–∞–Ω–¥–∞ create_subscription
    subscription_keywords = ['subscribe', 'subscription', 'premium', 'upgrade', 'pay']
    if any(keyword in text_lower for keyword in subscription_keywords):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        if any(phrase in text_lower for phrase in ['want to', 'would like to', 'need to', 'help me']):
            return {
                'command': 'create_subscription',
                'args': {},
                'text': 'I will help you subscribe to Nexy Premium. Opening checkout page...'
            }
    
    # –ö–æ–º–∞–Ω–¥–∞ cancel_subscription
    cancel_keywords = ['cancel', 'unsubscribe', 'stop subscription']
    if any(keyword in text_lower for keyword in cancel_keywords):
        if any(phrase in text_lower for phrase in ['want to', 'would like to', 'need to']):
            return {
                'command': 'cancel_subscription',
                'args': {},
                'text': 'I will help you cancel your subscription.'
            }
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
```

#### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ StreamingWorkflowIntegration

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_execute_subscription_command()`:**

```python
def _execute_subscription_command(
    self,
    command: str,
    hardware_id: str,
    session_id: str
) -> Generator[Dict, None, None]:
    """
    –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –ø–æ–¥–ø–∏—Å–∫–∏
    
    Args:
        command: 'create_subscription' –∏–ª–∏ 'cancel_subscription'
        hardware_id: ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        session_id: ID —Å–µ—Å—Å–∏–∏
    
    Yields:
        StreamResponse —Å action_message –∏–ª–∏ text_chunk
    """
    try:
        subscription_module = self.module_coordinator.get_module("subscription")
        if not subscription_module:
            yield {
                'text_chunk': 'Subscription service is not available. Please try again later.',
                'session_id': session_id,
                'feature_id': 'F-2025-017-stripe-payment'
            }
            return
        
        if command == 'create_subscription':
            # –°–æ–∑–¥–∞–µ–º Checkout Session
            result = subscription_module.create_checkout(hardware_id)
            
            if result.get('error'):
                yield {
                    'text_chunk': f"I'm sorry, but I couldn't create a checkout session: {result['error']}",
                    'session_id': session_id,
                    'feature_id': 'F-2025-017-stripe-payment'
                }
                return
            
            checkout_url = result.get('checkout_url')
            if checkout_url:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º action_message –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è URL
                yield {
                    'action_message': {
                        'action_json': json.dumps({
                            'command': 'open_url',
                            'args': {'url': checkout_url}
                        }),
                        'session_id': session_id,
                        'feature_id': 'F-2025-017-stripe-payment'
                    }
                }
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                yield {
                    'text_chunk': 'I\'ve opened the checkout page for you. Please complete your subscription there.',
                    'session_id': session_id,
                    'feature_id': 'F-2025-017-stripe-payment'
                }
            else:
                yield {
                    'text_chunk': 'I couldn\'t create a checkout session. Please try again later.',
                    'session_id': session_id,
                    'feature_id': 'F-2025-017-stripe-payment'
                }
        
        elif command == 'cancel_subscription':
            # –û—Ç–º–µ–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            result = subscription_module.cancel_subscription(hardware_id)
            
            if result.get('success'):
                yield {
                    'text_chunk': result.get('message', 'Your subscription has been cancelled.'),
                    'session_id': session_id,
                    'feature_id': 'F-2025-017-stripe-payment'
                }
            else:
                yield {
                    'text_chunk': f"I couldn't cancel your subscription: {result.get('message', 'Unknown error')}",
                    'session_id': session_id,
                    'feature_id': 'F-2025-017-stripe-payment'
                }
        
    except Exception as e:
        logger.error(f"[MVP8] Error executing subscription command: {e}")
        yield {
            'text_chunk': 'An error occurred while processing your subscription request. Please try again later.',
            'session_id': session_id,
            'feature_id': 'F-2025-017-stripe-payment'
        }
```

**–û–±–Ω–æ–≤–∏—Ç—å `_process_request_streaming()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥:**

```python
# –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Ç LLM:
parsed_command = self.assistant_parser.parse(llm_response_text)

if parsed_command and parsed_command.get('command') in ['create_subscription', 'cancel_subscription']:
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ–¥–ø–∏—Å–∫–∏
    for response in self._execute_subscription_command(
        parsed_command['command'],
        hardware_id,
        session_id
    ):
        yield response
    return  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫
```

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `SubscriptionModule.create_checkout()` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `SubscriptionModule.cancel_subscription()` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `AssistantResponseParser` —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] `StreamingWorkflowIntegration` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
- [ ] `action_message` —Å `open_url` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç
- [ ] –ú–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å end-to-end (–∑–∞–ø—Ä–æ—Å ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí checkout ‚Üí URL)

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
cd v1.0.6\ Payment/server(Payment)
source .venv/bin/activate
python server/main.py

# –í –∫–ª–∏–µ–Ω—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å:
# "I want to subscribe to premium"
# –∏–ª–∏
# "Help me subscribe"
```

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. **–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:**
   ```
   [SubscriptionModule] Checkout created for hardware_id_123: cs_test_...
   [MVP8] Executing subscription command: create_subscription
   ```

2. **–í –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞:**
   - `action_message` —Å `command: 'open_url'` –∏ `url: 'https://checkout.stripe.com/...'`
   - –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "I've opened the checkout page for you..."

3. **–ù–∞ –∫–ª–∏–µ–Ω—Ç–µ:**
   - –ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å Checkout —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π Stripe
   - –ú–æ–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É

**–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π/—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: "I want to subscribe"
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
3. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É (–∫–∞—Ä—Ç–∞: 4242 4242 4242 4242)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∏–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
- Checkout Session —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- URL –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç —á–µ—Ä–µ–∑ `action_message`
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä —Å Checkout —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
- –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è (—á–µ—Ä–µ–∑ webhook –≤ MVP 10)

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** –ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ AssistantResponseParser
# –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ—Ä–∞–∑
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** Checkout URL –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å STRIPE_SECRET_KEY –≤ .env
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ Stripe API
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** action_message –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∫–ª–∏–µ–Ω—Ç–∞
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç action_json
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç open_url –∫–æ–º–∞–Ω–¥—É
```

---

## üì¶ MVP 9: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

**–¶–µ–ª—å:** Deep Links –∏ open_url –∫–æ–º–∞–Ω–¥–∞

**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 8

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ open_url –∫–æ–º–∞–Ω–¥—ã

**–§–∞–π–ª:** `v1.0.6 Payment/client(Payment)/integration/integrations/action_execution_integration.py`

**–ù–∞–π—Ç–∏ –º–µ—Ç–æ–¥ `_handle_action_message()` –∏ –¥–æ–±–∞–≤–∏—Ç—å:**

```python
# –í –Ω–∞—á–∞–ª–µ –∫–ª–∞—Å—Å–∞, –æ–±–Ω–æ–≤–∏—Ç—å valid_commands:
VALID_COMMANDS = [
    'open_app',
    'close_app', 
    'read_messages',
    'send_message',
    'open_url'  # MVP 9: –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
]

# –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
def _handle_open_url(self, command_data: dict) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã open_url
    
    Args:
        command_data: Dict —Å 'args' —Å–æ–¥–µ—Ä–∂–∞—â–∏–º 'url'
    """
    url = command_data.get('args', {}).get('url')
    if not url:
        logger.warning("[ActionExecution] open_url: URL not provided")
        return
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ URL
        if not url.startswith(('https://', 'http://', 'nexy://')):
            logger.error(f"[ActionExecution] open_url: Invalid URL scheme: {url}")
            return
        
        # –û—Ç–∫—Ä—ã—Ç–∏–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ (macOS)
        import subprocess
        result = subprocess.run(
            ["open", url],
            capture_output=True,
            text=True,
            timeout=5
        )
        
        if result.returncode == 0:
            logger.info(f"[ActionExecution] ‚úÖ Opened URL: {url}")
        else:
            logger.error(f"[ActionExecution] ‚ùå Failed to open URL: {result.stderr}")
            
    except subprocess.TimeoutExpired:
        logger.error(f"[ActionExecution] ‚ùå Timeout opening URL: {url}")
    except Exception as e:
        logger.error(f"[ActionExecution] ‚ùå Error opening URL {url}: {e}")

# –û–±–Ω–æ–≤–∏—Ç—å _handle_action_message():
def _handle_action_message(self, event: dict) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ action_message —Å–æ–±—ã—Ç–∏—è"""
    try:
        action_json = event.get('payload', {}).get('action_json')
        if not action_json:
            return
        
        import json
        command_data = json.loads(action_json)
        command = command_data.get('command')
        
        if command not in self.VALID_COMMANDS:
            logger.warning(f"[ActionExecution] Unknown command: {command}")
            return
        
        # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        if command == 'open_url':
            self._handle_open_url(command_data)
        elif command == 'open_app':
            self._handle_open_app(command_data)
        elif command == 'close_app':
            self._handle_close_app(command_data)
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ...
        
    except json.JSONDecodeError as e:
        logger.error(f"[ActionExecution] Invalid JSON in action_message: {e}")
    except Exception as e:
        logger.error(f"[ActionExecution] Error handling action_message: {e}")
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ Deep Link Processor

**–§–∞–π–ª:** `v1.0.6 Payment/client(Payment)/modules/deep_link/core/deep_link_processor.py`

```python
#!/usr/bin/env python3
"""Deep Link Processor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ deep links –æ—Ç Stripe"""
import logging
import urllib.parse
from typing import Dict, Optional
from datetime import datetime

logger = logging.getLogger(__name__)

class DeepLinkProcessor:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ deep links –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"""
        self.logged_events = []  # –î–ª—è MVP - –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    
    def process_deep_link(self, url: str) -> Dict:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ deep link
        
        Args:
            url: Deep link URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, nexy://checkout/success?session_id=...)
        
        Returns:
            Dict —Å —Ç–∏–ø–æ–º —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞–Ω–Ω—ã–º–∏
        """
        if not url:
            return {'error': 'URL is empty'}
        
        try:
            # –ü–∞—Ä—Å–∏–Ω–≥ URL
            parsed = urllib.parse.urlparse(url)
            scheme = parsed.scheme
            path = parsed.path
            query_params = urllib.parse.parse_qs(parsed.query)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã
            if scheme != 'nexy':
                logger.warning(f"[DeepLink] Invalid scheme: {scheme}")
                return {'error': f'Invalid scheme: {scheme}'}
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ deep links
            if path.startswith('/checkout/success'):
                return self._handle_checkout_success(query_params)
            elif path.startswith('/checkout/cancel'):
                return self._handle_checkout_cancel(query_params)
            elif path.startswith('/portal/return'):
                return self._handle_portal_return(query_params)
            else:
                logger.warning(f"[DeepLink] Unknown path: {path}")
                return {'error': f'Unknown path: {path}'}
                
        except Exception as e:
            logger.error(f"[DeepLink] Error processing deep link: {e}")
            return {'error': str(e)}
    
    def _handle_checkout_success(self, params: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ checkout"""
        session_id = params.get('session_id', [None])[0]
        
        event = {
            'type': 'checkout_success',
            'session_id': session_id,
            'timestamp': datetime.now().isoformat()
        }
        
        logger.info(f"[DeepLink] ‚úÖ Checkout completed successfully: session_id={session_id}")
        self.logged_events.append(event)
        
        # MVP 9: –¢–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
        # –í MVP 10: –û—Ç–ø—Ä–∞–≤–∏–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        
        return {
            'success': True,
            'event': event,
            'message': 'Checkout completed successfully'
        }
    
    def _handle_checkout_cancel(self, params: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã checkout"""
        event = {
            'type': 'checkout_cancel',
            'timestamp': datetime.now().isoformat()
        }
        
        logger.info(f"[DeepLink] ‚ö†Ô∏è Checkout cancelled by user")
        self.logged_events.append(event)
        
        return {
            'success': True,
            'event': event,
            'message': 'Checkout was cancelled'
        }
    
    def _handle_portal_return(self, params: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ Customer Portal"""
        session_id = params.get('session_id', [None])[0]
        
        event = {
            'type': 'portal_return',
            'session_id': session_id,
            'timestamp': datetime.now().isoformat()
        }
        
        logger.info(f"[DeepLink] ‚úÖ Returned from Customer Portal: session_id={session_id}")
        self.logged_events.append(event)
        
        # MVP 9: –¢–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
        # –í MVP 10: –û—Ç–ø—Ä–∞–≤–∏–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ payment_method
        
        return {
            'success': True,
            'event': event,
            'message': 'Returned from Customer Portal'
        }
    
    def get_logged_events(self) -> list:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        return self.logged_events.copy()
```

#### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Deep Link Processor

**–§–∞–π–ª:** `v1.0.6 Payment/client(Payment)/modules/deep_link/__init__.py`

```python
from .core.deep_link_processor import DeepLinkProcessor

__all__ = ['DeepLinkProcessor']
```

**–û–±–Ω–æ–≤–∏—Ç—å:** `client/integration/core/simple_module_coordinator.py` (–¥–æ–±–∞–≤–∏—Ç—å DeepLinkProcessor)

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `open_url` –∫–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `VALID_COMMANDS`
- [ ] `_handle_open_url()` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] `DeepLinkProcessor` —Å–æ–∑–¥–∞–Ω –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç deep links
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Ç–∏–ø—ã deep links (checkout/success, checkout/cancel, portal/return)
- [ ] –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- [ ] –ú–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å end-to-end

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç
cd v1.0.6\ Payment/client(Payment)
source .venv/bin/activate
python main.py

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É
# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è action_message —Å open_url, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
# 1. –ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
# 2. Checkout —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
# 3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã/–æ—Ç–º–µ–Ω—ã deep link –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ open_url:**

```python
# –í Python –∫–æ–Ω—Å–æ–ª–∏:
from integration.integrations.action_execution_integration import ActionExecutionIntegration

integration = ActionExecutionIntegration(...)
integration._handle_open_url({
    'args': {'url': 'https://checkout.stripe.com/test'}
})
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã–ª—Å—è
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Deep Links:**

```python
# –í Python –∫–æ–Ω—Å–æ–ª–∏:
from modules.deep_link.core.deep_link_processor import DeepLinkProcessor

processor = DeepLinkProcessor()

# –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ checkout
result = processor.process_deep_link('nexy://checkout/success?session_id=cs_test_123')
assert result['success'] == True
assert result['event']['type'] == 'checkout_success'

# –¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã
result = processor.process_deep_link('nexy://checkout/cancel')
assert result['success'] == True

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
events = processor.get_logged_events()
print(events)
```

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. **open_url –∫–æ–º–∞–Ω–¥–∞:**
   - –ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º URL
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ

2. **Deep Links:**
   - –í—Å–µ —Ç–∏–ø—ã deep links –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
   - –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- –ö–æ–º–∞–Ω–¥–∞ `open_url` —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä
- Deep links –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (MVP 10)
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –≤ MVP 10

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É 'open' –Ω–∞ macOS
which open
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: /usr/bin/open

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod +x /usr/bin/open
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** Deep link –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç URL
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: nexy://checkout/success?session_id=...
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ URL
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** action_message –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç action_json
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ 'open_url' –≤ valid_commands
```

---

## üì¶ MVP 10: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–¶–µ–ª—å:** –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ, –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** MVP 1-9

---

### üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ SubscriptionStateMachine

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/modules/subscription/core/state_machine.py`

```python
#!/usr/bin/env python3
"""State Machine –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ–¥–ø–∏—Å–æ–∫"""
from typing import Dict, Optional
from datetime import datetime, timedelta
import logging

logger = logging.getLogger(__name__)

class SubscriptionStateMachine:
    """State Machine –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫"""
    
    # –í–∞–ª–∏–¥–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
    VALID_STATUSES = [
        'paid_trial',
        'paid',
        'billing_problem',
        'limited_free_trial',
        'admin_active',
        'grandfathered'
    ]
    
    # –í–∞–ª–∏–¥–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
    VALID_TRANSITIONS = {
        'paid_trial': ['paid', 'limited_free_trial'],
        'paid': ['billing_problem', 'limited_free_trial'],
        'billing_problem': ['paid', 'limited_free_trial'],
        'limited_free_trial': ['paid'],
        'admin_active': [],  # –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π —Å—Ç–∞—Ç—É—Å
        'grandfathered': []  # –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π —Å—Ç–∞—Ç—É—Å
    }
    
    @classmethod
    def can_transition(cls, from_status: str, to_status: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–æ–∑–º–æ–∂–µ–Ω –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥"""
        if from_status not in cls.VALID_STATUSES:
            return False
        if to_status not in cls.VALID_STATUSES:
            return False
        
        allowed = cls.VALID_TRANSITIONS.get(from_status, [])
        return to_status in allowed
    
    @classmethod
    def transition(
        cls,
        current_status: str,
        new_status: str,
        hardware_id: str,
        repo
    ) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞
        
        Returns:
            Dict —Å success (bool), message (str), new_status (str)
        """
        if not cls.can_transition(current_status, new_status):
            return {
                'success': False,
                'message': f'Invalid transition: {current_status} ‚Üí {new_status}',
                'new_status': current_status
            }
        
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
            repo.update_status(hardware_id, new_status)
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grace_period_end_at –¥–ª—è billing_problem
            if new_status == 'billing_problem':
                grace_end = datetime.now() + timedelta(days=1)
                # –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ update_grace_period_end_at –≤ repo
            
            logger.info(f"[StateMachine] Transition: {current_status} ‚Üí {new_status} for {hardware_id}")
            
            return {
                'success': True,
                'message': f'Status updated: {new_status}',
                'new_status': new_status
            }
        except Exception as e:
            logger.error(f"[StateMachine] Error transitioning: {e}")
            return {
                'success': False,
                'message': str(e),
                'new_status': current_status
            }
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ Webhook Handler

**–§–∞–π–ª:** `v1.0.6 Payment/server(Payment)/server/services/stripe_webhook_handler.py`

```python
#!/usr/bin/env python3
"""Webhook Handler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe"""
import logging
import json
from typing import Dict, Optional
from datetime import datetime, timedelta
from subscription_repository import SubscriptionRepository
from subscription_state_machine import SubscriptionStateMachine
from stripe_service import StripeService

logger = logging.getLogger(__name__)

class StripeWebhookHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe"""
    
    def __init__(self, repo: SubscriptionRepository, stripe_service: StripeService):
        self.repo = repo
        self.stripe_service = stripe_service
        self.state_machine = SubscriptionStateMachine()
    
    def handle_event(self, event: Dict) -> Dict:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏—è
        
        Args:
            event: Stripe event object
        
        Returns:
            Dict —Å success (bool), message (str)
        """
        event_type = event.get('type')
        event_id = event.get('id')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        if self.repo.event_exists(event_id):
            logger.info(f"[Webhook] Event {event_id} already processed (idempotency)")
            return {'success': True, 'message': 'Event already processed'}
        
        try:
            # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
            handler = self._get_handler(event_type)
            if not handler:
                logger.warning(f"[Webhook] No handler for event type: {event_type}")
                return {'success': False, 'message': f'Unknown event type: {event_type}'}
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
            result = handler(event)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
            self.repo.record_event(
                event_id,
                event_type,
                hardware_id=result.get('hardware_id'),
                event_data=event.get('data', {})
            )
            
            return result
            
        except Exception as e:
            logger.error(f"[Webhook] Error handling event {event_id}: {e}")
            return {'success': False, 'message': str(e)}
    
    def _get_handler(self, event_type: str):
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è"""
        handlers = {
            'checkout.session.completed': self._handle_checkout_completed,
            'customer.subscription.updated': self._handle_subscription_updated,
            'customer.subscription.deleted': self._handle_subscription_deleted,
            'invoice.payment_succeeded': self._handle_payment_succeeded,
            'invoice.payment_failed': self._handle_payment_failed,
            'invoice.payment_action_required': self._handle_payment_action_required,
        }
        return handlers.get(event_type)
    
    def _handle_checkout_completed(self, event: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ checkout.session.completed"""
        session = event['data']['object']
        hardware_id = session['metadata'].get('hardware_id')
        customer_id = session.get('customer')
        subscription_id = session.get('subscription')
        
        if not hardware_id:
            return {'success': False, 'message': 'hardware_id not found in metadata'}
        
        # –õ–∏–Ω–∫–æ–≤–∫–∞ customer/subscription
        self.repo.update_stripe_ids(
            hardware_id,
            customer_id=customer_id,
            subscription_id=subscription_id
        )
        
        # –ù–ï –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ paid (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã - invoice.payment_succeeded)
        logger.info(f"[Webhook] Checkout completed for {hardware_id}, linked customer/subscription")
        
        return {
            'success': True,
            'message': 'Checkout completed, customer/subscription linked',
            'hardware_id': hardware_id
        }
    
    def _handle_payment_succeeded(self, event: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ invoice.payment_succeeded (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è paid)"""
        invoice = event['data']['object']
        customer_id = invoice.get('customer')
        subscription_id = invoice.get('subscription')
        
        # –ù–∞—Ö–æ–¥–∏–º hardware_id –ø–æ customer_id
        # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –º–µ—Ç–æ–¥ repo.get_hardware_id_by_customer_id()
        # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º subscription_id
        subscription = self.repo.get_subscription_by_stripe_subscription_id(subscription_id)
        if not subscription:
            return {'success': False, 'message': 'Subscription not found'}
        
        hardware_id = subscription['hardware_id']
        current_status = subscription['status']
        
        # –ü–µ—Ä–µ—Ö–æ–¥ –≤ paid (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
        if current_status != 'paid':
            result = self.state_machine.transition(
                current_status,
                'paid',
                hardware_id,
                self.repo
            )
            
            if result['success']:
                logger.info(f"[Webhook] Payment succeeded, status ‚Üí paid for {hardware_id}")
                return {
                    'success': True,
                    'message': 'Payment succeeded, status updated to paid',
                    'hardware_id': hardware_id
                }
        
        return {'success': True, 'message': 'Payment succeeded, already paid'}
    
    def _handle_payment_failed(self, event: Dict) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ invoice.payment_failed"""
        invoice = event['data']['object']
        subscription_id = invoice.get('subscription')
        
        subscription = self.repo.get_subscription_by_stripe_subscription_id(subscription_id)
        if not subscription:
            return {'success': False, 'message': 'Subscription not found'}
        
        hardware_id = subscription['hardware_id']
        current_status = subscription['status']
        
        # –ü–µ—Ä–µ—Ö–æ–¥ –≤ billing_problem + grace period
        if current_status != 'billing_problem':
            result = self.state_machine.transition(
                current_status,
                'billing_problem',
                hardware_id,
                self.repo
            )
            
            if result['success']:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grace_period_end_at
                grace_end = datetime.now() + timedelta(days=1)
                # repo.update_grace_period_end_at(hardware_id, grace_end)
                
                logger.info(f"[Webhook] Payment failed, status ‚Üí billing_problem (grace period) for {hardware_id}")
                return {
                    'success': True,
                    'message': 'Payment failed, grace period started',
                    'hardware_id': hardware_id
                }
        
        return {'success': True, 'message': 'Payment failed, already in billing_problem'}
    
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ...
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è. –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å –≤—Å–µ must-have —Å–æ–±—ã—Ç–∏—è, out-of-order –æ–±—Ä–∞–±–æ—Ç–∫—É, –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—ç—à–∞.

---

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (MVP 10)

**10.1. Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
- [ ] `SubscriptionStateMachine` —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `StripeWebhookHandler` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ must-have —Å–æ–±—ã—Ç–∏—è
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç (–¥—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- [ ] State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] Grace period —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è billing_problem

**10.2. –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- [ ] Subscription context –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- [ ] Quota –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
- [ ] Usage –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- [ ] Trial warnings —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Auto-checkout —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å cooldown)

**10.3-10.6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- [ ] Reconcile Service —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] Trial Period Manager —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Grace Period –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- [ ] Cron Jobs –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**10.7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- [ ] –í—Å–µ 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Performance —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MVP 10

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
cd v1.0.6\ Payment/server(Payment)
source .venv/bin/activate
python server/main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - Stripe CLI
stripe listen --forward-to localhost:8000/webhook/stripe

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
stripe trigger checkout.session.completed
stripe trigger invoice.payment_succeeded
stripe trigger invoice.payment_failed

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
pytest v1.0.6\ Payment/tests/test_smoke_critical.py -v
```

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. **Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
   - –í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è

2. **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - Subscription context –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - Quota enforcement —Ä–∞–±–æ—Ç–∞–µ—Ç
   - Usage tracking —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–í—Å–µ —Ç–µ—Å—Ç—ã:**
   - 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã
   - E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
   - –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π

---

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è MVP 10:**

- ‚úÖ –ü–æ–ª–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ Production-ready —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

---

### üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** Webhook —Å–æ–±—ã—Ç–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook handler
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å VALID_TRANSITIONS
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ repo.update_status —Ä–∞–±–æ—Ç–∞–µ—Ç
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** Quota –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å QuotaChecker
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç usage
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –≤ –ë–î
```

#### 10.2. –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Workflow

**–§–∞–π–ª:** `server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ subscription context (—Å —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏–µ–π)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–æ—Ç
- [ ] –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç usage –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- [ ] Trial warnings –≤ LLM prompt
- [ ] Auto-checkout –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ trial (—Å cooldown)
- [ ] Portal return –æ–±—Ä–∞–±–æ—Ç–∫–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è payment_method)

#### 10.3. Reconcile Service

**–§–∞–π–ª:** `server(Payment)/server/services/reconcile_service.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

- [ ] `reconcile_with_stripe()` ‚Äî —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –¥–ª—è –æ–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] `check_reconciliation_needed()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- [ ] `reconcile_all_active_subscriptions()` ‚Äî batch —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ SubscriptionContextCache

#### 10.4. Trial Period Manager

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/trial_manager.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è trial
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (2, 1, 0 –¥–Ω–µ–π)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ cooldown –¥–ª—è auto-checkout (24 —á–∞—Å–∞)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial` –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏

#### 10.5. Grace Period –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial` –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

#### 10.6. Cron Jobs

**–§–∞–π–ª:** `server(Payment)/server/services/cron_jobs.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

- [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ Stripe (—Ä–∞–∑ –≤ —á–∞—Å)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period (—Ä–∞–∑ –≤ —á–∞—Å)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è trial period (—Ä–∞–∑ –≤ –¥–µ–Ω—å)

#### 10.7. –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç-–∫–µ–π—Å—ã –∏–∑ `CRITICAL_TEST_CASES.md`:**

- [ ] TC-1: Webhook Duplicate (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- [ ] TC-2: Webhook Out-of-Order
- [ ] TC-3: Webhook Signature Verification
- [ ] TC-4: `checkout.session.completed` ‚â† –æ–ø–ª–∞—Ç–∞
- [ ] TC-5: –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `paid`
- [ ] TC-6: State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã
- [ ] TC-7: Quota enforcement
- [ ] TC-8: Trial expiration
- [ ] TC-9: Grace period
- [ ] TC-10: Portal return
- [ ] TC-11: Reconcile
- [ ] TC-12: Hardware ID –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- [ ] TC-13: Deep Links
- [ ] TC-14: URL Opening
- [ ] TC-15: End-to-end flow

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –í—Å–µ MVP –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã
- [ ] –í—Å–µ must-have webhook —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] State Machine —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Quota enforcement —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Reconcile Service —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Trial warnings —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Grace period —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Portal return —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—Å–µ 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] End-to-end —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ
- [ ] Performance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã
pytest v1.0.6\ Payment/tests/test_smoke_critical.py -v

# E2E —Ç–µ—Å—Ç—ã
pytest server/tests/e2e/test_subscription_full_flow.py -v
pytest client/tests/e2e/test_deep_links.py -v

# Performance —Ç–µ—Å—Ç—ã
pytest server/tests/performance/ -v

# –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
pytest server/tests/ -v
pytest client/tests/ -v
```

### –ß—Ç–æ –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ MVP 10

**‚úÖ –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí paid_trial ‚Üí –æ–ø–ª–∞—Ç–∞ ‚Üí paid
- ‚úÖ Trial –∏—Å—Ç–µ—á–µ–Ω–∏–µ ‚Üí limited_free_trial
- ‚úÖ Payment failed ‚Üí billing_problem ‚Üí grace period ‚Üí limited_free_trial
- ‚úÖ Payment succeeded ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤ paid
- ‚úÖ Quota enforcement –¥–ª—è limited_free_trial
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ Deep links –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ URL opening –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ Portal return —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ Reconcile —Å–æ Stripe
- ‚úÖ Trial warnings
- ‚úÖ Auto-checkout –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ trial
- ‚úÖ Grace period –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Cron jobs —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å webhooks
- ‚úÖ Out-of-order –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Signature verification
- ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è paid
- ‚úÖ State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã
- ‚úÖ Quota limits
- ‚úÖ Hardware ID –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

**‚úÖ Production-ready:**
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ
- ‚úÖ –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- ‚úÖ Performance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## üìä –¢–∞–±–ª–∏—Ü–∞ MVP –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

| MVP | –ù–∞–∑–≤–∞–Ω–∏–µ | –í—Ä–µ–º—è | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | –°—Ç–∞—Ç—É—Å | –¢–µ—Å—Ç—ã |
|-----|----------|-------|-------------|--------|-------|
| 0 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | 1 –¥–µ–Ω—å | - | ‚¨ú | ‚¨ú |
| 1 | Webhook Endpoint | 1-2 –¥–Ω—è | MVP 0 | ‚¨ú | ‚¨ú |
| 2 | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | 1-2 –¥–Ω—è | MVP 0 | ‚¨ú | ‚¨ú |
| 3 | Stripe Service | 1-2 –¥–Ω—è | MVP 0 | ‚¨ú | ‚¨ú |
| 4 | Subscription Repository | 1 –¥–µ–Ω—å | MVP 2 | ‚¨ú | ‚¨ú |
| 5 | Subscription Context | 1 –¥–µ–Ω—å | MVP 4 | ‚¨ú | ‚¨ú |
| 6 | Quota Checker | 1 –¥–µ–Ω—å | MVP 4 | ‚¨ú | ‚¨ú |
| 7 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Workflow | 2-3 –¥–Ω—è | MVP 5, 6 | ‚¨ú | ‚¨ú |
| 8 | –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏ | 2-3 –¥–Ω—è | MVP 3, 7 | ‚¨ú | ‚¨ú |
| 9 | –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å | 1-2 –¥–Ω—è | MVP 8 | ‚¨ú | ‚¨ú |
| 10 | –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | 2-3 –¥–Ω—è | MVP 1-9 | ‚¨ú | ‚¨ú |

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 13-20 –¥–Ω–µ–π (2.5-4 –Ω–µ–¥–µ–ª–∏)

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ MVP –ø–æ–¥—Ö–æ–¥–∞

1. **–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π MVP –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
2. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫:** –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –¥–æ MVP 7
3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ:** –£—á–∏–º—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
4. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ª—é–±–æ–º MVP
5. **–†–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º:** –ü—Ä–æ–±–ª–µ–º—ã –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—á–∞—Ç—å —Å MVP 0:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
2. **MVP 1:** Webhook endpoint (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π, –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É)
3. **MVP 2-3:** –ë–î –∏ Stripe Service (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å)
4. **MVP 4-6:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
5. **MVP 7-10:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-13  
**–í–µ—Ä—Å–∏—è:** 1.1 (–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

---

## üìã –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ MVP

### ‚úÖ –ß—Ç–æ –±—ã–ª–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

–ö–∞–∂–¥—ã–π MVP (0-10) —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç:

1. **üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
2. **üíª –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∫–æ–¥** - –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
3. **‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏** - —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
4. **üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–æ–º–∞–Ω–¥—ã –∏ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
5. **üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** - —á—Ç–æ –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è
6. **üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è** - troubleshooting

### üì¶ –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø–æ –∫–∞–∂–¥–æ–º—É MVP

#### MVP 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚úÖ
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î –∏ Stripe API
- –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

#### MVP 1: Webhook Endpoint ‚úÖ
- Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–∏–µ–º–∞ webhook —Å–æ–±—ã—Ç–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Stripe CLI

#### MVP 2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è subscriptions –∏ subscription_events
- SubscriptionRepository —Å CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π

#### MVP 3: Stripe Service ‚úÖ
- –°–æ–∑–¥–∞–Ω–∏–µ Checkout Sessions
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook –ø–æ–¥–ø–∏—Å–µ–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏—è—Ö –∏ –ø–æ–¥–ø–∏—Å–∫–∞—Ö

#### MVP 4: Subscription Repository + –ë–î ‚úÖ
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (usage tracking)
- –ú–µ—Ç–æ–¥—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### MVP 5: Subscription Context ‚úÖ
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è LLM prompt
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤

#### MVP 6: Quota Checker ‚úÖ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- Grace period –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –õ–∏–º–∏—Ç—ã –¥–ª—è limited_free_trial (5/25/50)

#### MVP 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Workflow ‚úÖ
- SubscriptionModule –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ StreamingWorkflowIntegration
- Quota enforcement –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º

#### MVP 8: –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏ ‚ö†Ô∏è
- –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ create_subscription/cancel_subscription
- –°–æ–∑–¥–∞–Ω–∏–µ Checkout Session
- –û—Ç–ø—Ä–∞–≤–∫–∞ URL –Ω–∞ –∫–ª–∏–µ–Ω—Ç —á–µ—Ä–µ–∑ action_message

#### MVP 9: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å ‚ö†Ô∏è
- open_url –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
- Deep links –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ ActionExecutionIntegration

#### MVP 10: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚ö†Ô∏è
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å State Machine
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Reconcile Service, Trial Manager, Cron Jobs
- –í—Å–µ 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤

### üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **MVP 0-3** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å MVP 2 –∏ 3)
   - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

2. **MVP 4-6** (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
   - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ë–î
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∫–≤–æ—Ç—ã

3. **MVP 7-9** (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ workflow
   - –ö–æ–º–∞–Ω–¥—ã –ø–æ–¥–ø–∏—Å–∫–∏
   - –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

4. **MVP 10** (—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
   - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **MVP 0-6:** –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ `mvp_tests/`
- **MVP 7-10:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π MVP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
- **–û—Ç–∫–∞—Ç:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ª—é–±–æ–º MVP –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-13  
**–í–µ—Ä—Å–∏—è:** 1.1 (–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

















