# üöÄ –ë—ã—Å—Ç—Ä—ã–π Smoke-—Ç–µ—Å—Ç: 10 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

> **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 30-60 –º–∏–Ω—É—Ç  
> **–¶–µ–ª—å:** –ü–æ–π–º–∞—Ç—å "–∑–∞–±—ã–ª–∏ –∫—É—Å–æ–∫ –ª–æ–≥–∏–∫–∏" –±–µ–∑ –ø—Ä–æ–≥–æ–Ω–∞ –≤—Å–µ–≥–æ –Ω–∞–±–æ—Ä–∞ –∫–µ–π—Å–æ–≤

---

## üìã –ß—Ç–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç

–í—Å–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–∑ `COMPLETE_SYSTEM_LOGIC.md`:

- ‚úÖ **–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è paid** (`invoice.payment_succeeded` –æ—Å–Ω–æ–≤–Ω–æ–π, `subscription.updated` –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π)
- ‚úÖ **State machine** (`billing_problem` ‚Üí grace ‚Üí `limited_free_trial`)
- ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** (UNIQUE constraint, –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- ‚úÖ **Out-of-order** (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `created_at`, winner rules)
- ‚úÖ **–ö—ç—à** (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ü–ï–†–ï–î –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ë–î)
- ‚úÖ **Cooldown** (24 —á–∞—Å–∞ –Ω–∞ Checkout)
- ‚úÖ **Reconcile** (Stripe –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- ‚úÖ **Portal-return** (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π sync + cache invalidate)

---

## üèÉ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd v1.0.6\ Payment
pip install pytest pytest-asyncio
```

### 2. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
pytest tests/test_smoke_critical.py -v

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/test_smoke_critical.py::test_a1_invalid_signature_nothing_changes -v

# –° –≤—ã–≤–æ–¥–æ–º print
pytest tests/test_smoke_critical.py -v -s
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### –ì—Ä—É–ø–ø–∞ A: Webhook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

- **TC-A1:** Invalid signature = –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
- **TC-A2:** Duplicate event = –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –∏–≥–Ω–æ—Ä

### –ì—Ä—É–ø–ø–∞ B: –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è paid

- **TC-B1:** `checkout.session.completed` –ù–ï –¥–∞—ë—Ç `paid`
- **TC-B2:** `invoice.payment_succeeded` –¥–∞—ë—Ç `paid`

### –ì—Ä—É–ø–ø–∞ C: Out-of-order + winner rules

- **TC-C1:** Out-of-order: —Å–Ω–∞—á–∞–ª–∞ `subscription.updated(active)` –ø–æ—Ç–æ–º `invoice.payment_succeeded`
- **TC-C2:** Winner: `succeeded` –ø–æ–±–µ–∂–¥–∞–µ—Ç `failed`

### –ì—Ä—É–ø–ø–∞ D: State machine "billing_problem ‚Üí grace ‚Üí limited"

- **TC-D1:** `payment_failed` ‚Üí `billing_problem` + grace 24h (–Ω–µ limited —Å—Ä–∞–∑—É)
- **TC-D2:** grace –∏—Å—Ç—ë–∫ ‚Üí `limited_free_trial`

### –ì—Ä—É–ø–ø–∞ E: Portal return + reconcile + –∫—ç—à + cooldown

- **TC-E1:** portal_return = –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π sync + cache invalidate
- **TC-E2:** Cooldown 24h –Ω–∞ checkout

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º

–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–º–æ–∫–∏** (`MockDB`, `MockCache`, `WebhookHandler`).

### –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º:

1. **–ó–∞–º–µ–Ω–∏—Ç—å –º–æ–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
   - `WebhookHandler` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhooks –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
   - `MockDB` ‚Üí —Ä–µ–∞–ª—å–Ω–∞—è –ë–î (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î)
   - `MockCache` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π –∫—ç—à (Redis –∏–ª–∏ in-memory –¥–ª—è —Ç–µ—Å—Ç–æ–≤)

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ Stripe webhooks:**
   - Stripe CLI: `stripe listen --forward-to localhost:8000/webhook/stripe`
   - –ò–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π webhook replay endpoint

3. **–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `stripe.Webhook.construct_event()` –≤–º–µ—Å—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## üìù –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
tests/test_smoke_critical.py::test_a1_invalid_signature_nothing_changes ‚úÖ TC-A1: Invalid signature –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
PASSED
tests/test_smoke_critical.py::test_a2_duplicate_event_ignored ‚úÖ TC-A2: Duplicate event –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
PASSED
tests/test_smoke_critical.py::test_b1_checkout_completed_not_paid ‚úÖ TC-B1: checkout.completed –Ω–µ –¥–∞–µ—Ç paid
PASSED
...
```

---

## üîç –ö–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ "–≤—Å—ë –∑–∞–∫—Ä—ã—Ç–æ"

–ï—Å–ª–∏ –≤—Å–µ 10 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ ‚Äî —É –≤–∞—Å –∑–∞–∫—Ä—ã—Ç—ã –≤—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã `paid`
- ‚úÖ State machine
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- ‚úÖ Out-of-order/–≥–æ–Ω–∫–∏
- ‚úÖ Grace period
- ‚úÖ –õ–∏–º–∏—Ç—ã
- ‚úÖ Portal sync
- ‚úÖ Reconcile
- ‚úÖ Cooldown
- ‚úÖ –ö—ç—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

---

## üõ†Ô∏è –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è smoke-—Ç–µ—Å—Ç–æ–≤:

1. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º** (–∑–∞–º–µ–Ω–∏—Ç—å –º–æ–∫–∏)
2. **–î–æ–±–∞–≤–∏—Ç—å E2E —Ç–µ—Å—Ç—ã** (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –æ—Ç–≤–µ—Ç–∞)
3. **–ü—Ä–æ–≥–Ω–∞—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä** –∏–∑ `CRITICAL_TEST_CASES.md` (15 —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤)
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–æ–º–º–∏—Ç–µ)

---

**–°—Ç–∞—Ç—É—Å:** üìù –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é (—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º)

