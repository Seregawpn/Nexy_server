# üöÄ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ —Ñ–∞–∑–∞–º

**Feature ID:** F-2025-017-stripe-payment  
**Date:** 2025-12-13  
**Status:** üìã –ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, —Ä–∞–∑–±–∏—Ç—ã–π –Ω–∞ —á–µ—Ç–∫–∏–µ —Ñ–∞–∑—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ.

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–π.

---

## üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–∑

```
–§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
  ‚Üì
–§–∞–∑–∞ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
  ‚Üì
–§–∞–∑–∞ 2: Stripe –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–±–∞–∑–æ–≤–∞—è)
  ‚Üì
–§–∞–∑–∞ 3: Subscription Module (—Å–µ—Ä–≤–µ—Ä)
  ‚Üì
–§–∞–∑–∞ 4: Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
  ‚Üì
–§–∞–∑–∞ 5: LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã
  ‚Üì
–§–∞–∑–∞ 6: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (Deep Links + URL Opening)
  ‚Üì
–§–∞–∑–∞ 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  ‚Üì
–§–∞–∑–∞ 8: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üì¶ –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π.

**–í—Ä–µ–º—è:** 1-2 –¥–Ω—è

### –ó–∞–¥–∞—á–∏

#### 0.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

**–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**

```bash
# Server
server(Payment)/server/
‚îú‚îÄ‚îÄ modules/subscription/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ module.py
‚îÇ   ‚îú‚îÄ‚îÄ quota_checker.py
‚îÇ   ‚îú‚îÄ‚îÄ state_machine.py
‚îÇ   ‚îî‚îÄ‚îÄ adapter.py
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ stripe_service.py
‚îÇ   ‚îú‚îÄ‚îÄ stripe_webhook_handler.py
‚îÇ   ‚îú‚îÄ‚îÄ subscription_cache.py
‚îÇ   ‚îî‚îÄ‚îÄ subscription_context_builder.py
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001_create_subscriptions_tables.sql
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 002_add_subscription_indexes.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ROLLBACK_001.sql
‚îÇ   ‚îú‚îÄ‚îÄ subscription_repository.py
‚îÇ   ‚îú‚îÄ‚îÄ payment_repository.py
‚îÇ   ‚îî‚îÄ‚îÄ quota_repository.py
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ webhooks/
        ‚îú‚îÄ‚îÄ __init__.py
        ‚îî‚îÄ‚îÄ stripe_webhook.py

# Client
client(Payment)/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ deep_link/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ core/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ deep_link_processor.py
‚îÇ       ‚îî‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ integrations/
        ‚îî‚îÄ‚îÄ deep_link_integration.py
```

#### 0.2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `server(Payment)/server/config/unified_config.py`

**–î–æ–±–∞–≤–∏—Ç—å dataclass:**

- [ ] `StripeConfig` (–∏–∑ `CONFIGURATION_PLAN.md`)
- [ ] `QuotaConfig` (–∏–∑ `CONFIGURATION_PLAN.md`)
- [ ] `SubscriptionConfig` (–∏–∑ `CONFIGURATION_PLAN.md`)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `FeaturesConfig` (–¥–æ–±–∞–≤–∏—Ç—å `enable_payment_system: bool = False`)

**–§–∞–π–ª:** `server(Payment)/server/config/unified_config.yaml`

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏–∏:**

```yaml
features:
  enable_payment_system: false  # Feature flag

stripe:
  use_test_mode: true
  checkout_cooldown_hours: 24
  grace_period_days: 1
  trial_days: 14

quota:
  enabled: true
  daily_limit: 5
  weekly_limit: 25
  monthly_limit: 50

subscription:
  cache_ttl_seconds: 30
  auto_checkout_enabled: true
  trial_warnings_enabled: true
  trial_warning_days: [2, 1, 0]
```

#### 0.3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–§–∞–π–ª:** `server(Payment)/server/requirements.txt`

**–î–æ–±–∞–≤–∏—Ç—å:**

```txt
stripe>=7.0.0
redis>=5.0.0  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∫—ç—à–∞
```

**–§–∞–π–ª:** `client(Payment)/requirements.txt`

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ:**

- `subprocess` (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
- `webbrowser` (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)

#### 0.4. Environment Variables

**–°–æ–∑–¥–∞—Ç—å `.env.example`:**

```bash
# Stripe
STRIPE_API_KEY_TEST=sk_test_...
STRIPE_API_KEY_LIVE=sk_live_...
STRIPE_WEBHOOK_SECRET_TEST=whsec_...
STRIPE_WEBHOOK_SECRET_LIVE=whsec_...
STRIPE_USE_TEST_MODE=true
STRIPE_CHECKOUT_COOLDOWN_HOURS=24
STRIPE_GRACE_PERIOD_DAYS=1
STRIPE_TRIAL_DAYS=14

# Quota
QUOTA_ENABLED=true
QUOTA_DAILY_LIMIT=5
QUOTA_WEEKLY_LIMIT=25
QUOTA_MONTHLY_LIMIT=50

# Subscription
SUBSCRIPTION_CACHE_TTL_SECONDS=30
SUBSCRIPTION_AUTO_CHECKOUT_ENABLED=true
SUBSCRIPTION_TRIAL_WARNINGS_ENABLED=true
SUBSCRIPTION_TRIAL_WARNING_DAYS=2,1,0
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –í—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `unified_config.py`
- [ ] `unified_config.yaml` –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `requirements.txt`
- [ ] `.env.example` —Å–æ–∑–¥–∞–Ω
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cd server(Payment)
python -c "from server.config.unified_config import load_config; print(load_config())"
```

---

## üóÑÔ∏è –§–∞–∑–∞ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 0

### –ó–∞–¥–∞—á–∏

#### 1.1. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–§–∞–π–ª:** `server(Payment)/server/database/migrations/001_create_subscriptions_tables.sql`

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `subscriptions`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `subscription_events`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `payments`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `quota_usage`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å constraints (UNIQUE –¥–ª—è `stripe_event_id`)

**–§–∞–π–ª:** `server(Payment)/server/database/migrations/002_add_subscription_indexes.sql`

- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `hardware_id`
- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `stripe_customer_id`
- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `stripe_subscription_id`
- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `status`
- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è `quota_usage` (–ø–æ –¥–∞—Ç–∞–º)

**–§–∞–π–ª:** `server(Payment)/server/database/migrations/ROLLBACK_001.sql`

- [ ] Rollback —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü

#### 1.2. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

**–§–∞–π–ª:** `server(Payment)/server/database/subscription_repository.py`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `get_subscription(hardware_id: str) -> Optional[Subscription]`
- [ ] `create_subscription(hardware_id: str, status: str) -> Subscription`
- [ ] `update_subscription(hardware_id: str, **kwargs) -> Subscription`
- [ ] `get_subscription_by_stripe_id(stripe_customer_id: str) -> Optional[Subscription]`
- [ ] `get_subscriptions_by_status(status: str) -> List[Subscription]`
- [ ] `update_status(hardware_id: str, status: str) -> Subscription`
- [ ] `update_payment_method_id(hardware_id: str, payment_method_id: str) -> Subscription`

**–§–∞–π–ª:** `server(Payment)/server/database/payment_repository.py`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `create_payment(payment_data: dict) -> Payment`
- [ ] `get_payments_by_hardware_id(hardware_id: str) -> List[Payment]`
- [ ] `get_payment_by_stripe_id(stripe_payment_intent_id: str) -> Optional[Payment]`

**–§–∞–π–ª:** `server(Payment)/server/database/quota_repository.py`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `increment_quota(hardware_id: str, date: date) -> QuotaUsage`
- [ ] `get_quota_usage(hardware_id: str, start_date: date, end_date: date) -> List[QuotaUsage]`
- [ ] `get_daily_usage(hardware_id: str, date: date) -> int`
- [ ] `get_weekly_usage(hardware_id: str, week_start: date) -> int`
- [ ] `get_monthly_usage(hardware_id: str, month_start: date) -> int`
- [ ] `reset_quota(hardware_id: str) -> None`

**–§–∞–π–ª:** `server(Payment)/server/database/subscription_events_repository.py`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `create_event(stripe_event_id: str, event_type: str, hardware_id: str, event_data: dict) -> SubscriptionEvent`
- [ ] `get_event(stripe_event_id: str) -> Optional[SubscriptionEvent]`
- [ ] `event_exists(stripe_event_id: str) -> bool`

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –í—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
psql -d nexy_db -f server/database/migrations/001_create_subscriptions_tables.sql
psql -d nexy_db -f server/database/migrations/002_add_subscription_indexes.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã
pytest server/database/tests/ -v

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rollback
psql -d nexy_db -f server/database/migrations/ROLLBACK_001.sql
```

---

## üí≥ –§–∞–∑–∞ 2: Stripe –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–±–∞–∑–æ–≤–∞—è)

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å–æ Stripe API.

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 1

### –ó–∞–¥–∞—á–∏

#### 2.1. Stripe Service

**–§–∞–π–ª:** `server(Payment)/server/services/stripe_service.py`

**–ö–ª–∞—Å—Å:** `StripeService`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(config: StripeConfig)`
- [ ] `create_checkout_session(hardware_id: str, success_url: str, cancel_url: str) -> dict`
- [ ] `create_customer_portal_session(customer_id: str, return_url: str) -> dict`
- [ ] `get_customer(customer_id: str) -> dict`
- [ ] `get_subscription(subscription_id: str) -> dict`
- [ ] `cancel_subscription(subscription_id: str, immediately: bool = False) -> dict`
- [ ] `verify_webhook_signature(payload: bytes, signature: str) -> bool`
- [ ] `sync_payment_method(customer_id: str) -> dict`
- [ ] `get_payment_method_id(customer_id: str) -> Optional[str]`

#### 2.2. Webhook Handler (–±–∞–∑–æ–≤—ã–π)

**–§–∞–π–ª:** `server(Payment)/server/services/stripe_webhook_handler.py`

**–ö–ª–∞—Å—Å:** `StripeWebhookHandler`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(stripe_service: StripeService, subscription_repo: SubscriptionRepository)`
- [ ] `handle_event(event: dict) -> dict`
- [ ] `_handle_checkout_session_completed(event: dict) -> None`
- [ ] `_handle_customer_subscription_updated(event: dict) -> None`
- [ ] `_handle_customer_subscription_deleted(event: dict) -> None`
- [ ] `_handle_invoice_payment_succeeded(event: dict) -> None`
- [ ] `_handle_invoice_payment_failed(event: dict) -> None`
- [ ] `_handle_invoice_payment_action_required(event: dict) -> None`

#### 2.3. Webhook Endpoint

**–§–∞–π–ª:** `server(Payment)/server/api/webhooks/stripe_webhook.py`

**HTTP Endpoint:** `POST /webhook/stripe`

**–õ–æ–≥–∏–∫–∞:**

- [ ] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Stripe
- [ ] –ü–∞—Ä—Å–∏–Ω–≥ JSON payload
- [ ] –í—ã–∑–æ–≤ `StripeWebhookHandler.handle_event()`
- [ ] –í–æ–∑–≤—Ä–∞—Ç `200 OK` –∏–ª–∏ `400 Bad Request`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å HTTP —Å–µ—Ä–≤–µ—Ä–æ–º:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å route –≤ HTTP server (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Flask/FastAPI)
- [ ] –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HTTP handler

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `StripeService` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] `StripeWebhookHandler` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ must-have —Å–æ–±—ã—Ç–∏—è
- [ ] Webhook endpoint —Å–æ–∑–¥–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Unit —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Unit —Ç–µ—Å—Ç—ã
pytest server/services/tests/test_stripe_service.py -v
pytest server/services/tests/test_stripe_webhook_handler.py -v

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Stripe CLI
stripe listen --forward-to localhost:8000/webhook/stripe
stripe trigger checkout.session.completed
```

---

## üß© –§–∞–∑–∞ 3: Subscription Module (—Å–µ—Ä–≤–µ—Ä)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å Subscription Module –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ ModuleCoordinator.

**–í—Ä–µ–º—è:** 3-4 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 2

### –ó–∞–¥–∞—á–∏

#### 3.1. Subscription State Machine

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/state_machine.py`

**–ö–ª–∞—Å—Å:** `SubscriptionStateMachine`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `can_transition(from_status: str, to_status: str, event: str) -> bool`
- [ ] `transition(hardware_id: str, new_status: str, event: str, **kwargs) -> Subscription`
- [ ] `get_allowed_transitions(status: str) -> List[str]`
- [ ] `validate_transition(from_status: str, to_status: str) -> bool`

**–ü–µ—Ä–µ—Ö–æ–¥—ã (–∏–∑ `COMPLETE_SYSTEM_LOGIC.md`):**

- [ ] `paid_trial` ‚Üí `paid` (–ø—Ä–∏ `invoice.payment_succeeded`)
- [ ] `paid_trial` ‚Üí `limited_free_trial` (–ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ trial)
- [ ] `paid` ‚Üí `billing_problem` (–ø—Ä–∏ `invoice.payment_failed`)
- [ ] `billing_problem` ‚Üí `paid` (–ø—Ä–∏ `invoice.payment_succeeded`)
- [ ] `billing_problem` ‚Üí `limited_free_trial` (–ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ grace period)
- [ ] `paid` ‚Üí `limited_free_trial` (–ø—Ä–∏ `customer.subscription.deleted`)

#### 3.2. Quota Checker

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/quota_checker.py`

**–ö–ª–∞—Å—Å:** `QuotaChecker`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(quota_repo: QuotaRepository, config: QuotaConfig)`
- [ ] `check_quota(hardware_id: str, subscription_status: str) -> QuotaResult`
- [ ] `increment_usage(hardware_id: str) -> None`
- [ ] `is_within_limits(hardware_id: str, status: str) -> bool`
- [ ] `get_remaining_quota(hardware_id: str, status: str) -> dict`

**–õ–æ–≥–∏–∫–∞:**

- [ ] –î–ª—è `paid_trial`, `paid`, `admin_active`, `grandfathered` ‚Üí –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
- [ ] –î–ª—è `billing_problem` ‚Üí –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period
- [ ] –î–ª—è `limited_free_trial` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (5/–¥–µ–Ω—å, 25/–Ω–µ–¥–µ–ª—è, 50/–º–µ—Å—è—Ü)

#### 3.3. Subscription Cache

**–§–∞–π–ª:** `server(Payment)/server/services/subscription_cache.py`

**–ö–ª–∞—Å—Å:** `SubscriptionContextCache`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(subscription_repo: SubscriptionRepository, config: SubscriptionConfig)`
- [ ] `get_context(hardware_id: str) -> dict`
- [ ] `invalidate(hardware_id: str) -> None`
- [ ] `invalidate_all() -> None`

**–õ–æ–≥–∏–∫–∞:**

- [ ] TTL 30 —Å–µ–∫—É–Ω–¥
- [ ] –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ webhook/–∫–æ–º–∞–Ω–¥–∞—Ö
- [ ] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM

**–§–∞–π–ª:** `server(Payment)/server/services/subscription_context_builder.py`

**–ö–ª–∞—Å—Å:** `SubscriptionContextBuilder`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `build_context(subscription: Subscription, quota_info: dict) -> str`
- [ ] `format_for_llm(subscription: Subscription) -> str`

#### 3.4. Trial Period Manager

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/trial_manager.py`

**–ö–ª–∞—Å—Å:** `TrialPeriodManager`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(subscription_repo: SubscriptionRepository, config: SubscriptionConfig)`
- [ ] `check_trial_expiration(subscription: Subscription) -> dict`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è trial
  - –í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞—Ç—É—Å–µ trial
- [ ] `should_show_warning(subscription: Subscription) -> bool`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (2, 1, 0 –¥–Ω–µ–π)
- [ ] `should_auto_checkout(subscription: Subscription) -> bool`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å auto-checkout (cooldown 24 —á–∞—Å–∞)
- [ ] `get_warning_message(subscription: Subscription) -> str`
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è LLM

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è trial (14 –¥–Ω–µ–π)
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∑–∞ 2, 1, 0 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ cooldown –¥–ª—è auto-checkout (24 —á–∞—Å–∞ –º–µ–∂–¥—É —Å–æ–∑–¥–∞–Ω–∏—è–º–∏)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SubscriptionContextCache –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

#### 3.5. Reconcile Service

**–§–∞–π–ª:** `server(Payment)/server/services/reconcile_service.py`

**–ö–ª–∞—Å—Å:** `ReconcileService`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__(stripe_service: StripeService, subscription_repo: SubscriptionRepository, state_machine: SubscriptionStateMachine)`
- [ ] `reconcile_with_stripe(hardware_id: str, subscription: Subscription) -> bool`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É –ë–î –∏ Stripe
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ Stripe (Stripe - –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
  - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø–æ—Å–ª–µ —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏–∏
- [ ] `check_reconciliation_needed(subscription: Subscription) -> bool`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω—É–∂–Ω–∞ –ª–∏ —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è (–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- [ ] `reconcile_all_active_subscriptions() -> int`
  - Batch —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (–¥–ª—è cron)

**–õ–æ–≥–∏–∫–∞:**

- [ ] –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫—ç—à–∞ (–µ—Å–ª–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
- [ ] –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö:
  - –°—Ç–∞—Ç—É—Å –≤ –ë–î `paid`, –Ω–æ –Ω–µ—Ç `stripe_subscription_id`
  - –°—Ç–∞—Ç—É—Å –≤ –ë–î `limited_free_trial`, –Ω–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π `stripe_subscription_id`
  - –°—Ç–∞—Ç—É—Å `billing_problem` –∏ `grace_period_end_at` –ø—Ä–æ—à–µ–ª
  - –°—Ç–∞—Ç—É—Å `paid` –Ω–æ `current_period_end` –ø—Ä–æ—à–µ–ª
- [ ] Stripe –≤—Å–µ–≥–¥–∞ –ø–æ–±–µ–∂–¥–∞–µ—Ç –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏

#### 3.6. Subscription Module

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/module.py`

**–ö–ª–∞—Å—Å:** `SubscriptionModule` (—Ä–µ–∞–ª–∏–∑—É–µ—Ç `UniversalModuleInterface`)

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `initialize(config: dict) -> None`
- [ ] `process(request: dict) -> dict`
- [ ] `cleanup() -> None`
- [ ] `get_status() -> dict`

**Capabilities:**

- [ ] `subscription_context` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM
- [ ] `quota_check` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç
- [ ] `create_checkout` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ Checkout Session
- [ ] `open_portal` ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ Customer Portal
- [ ] `cancel_subscription` ‚Äî –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

#### 3.5. Module Adapter

**–§–∞–π–ª:** `server(Payment)/server/modules/subscription/adapter.py`

**–ö–ª–∞—Å—Å:** `SubscriptionModuleAdapter`

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è `SubscriptionModule` –ø–æ–¥ `UniversalModuleInterface`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `ModuleFactory`

#### 3.6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ ModuleCoordinator

**–§–∞–π–ª:** `server(Payment)/server/integrations/core/module_factory.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å `SubscriptionModule` –≤ `ModuleFactory.create_module()`
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å capability `subscription`

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] State Machine —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Quota Checker —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Subscription Cache —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Trial Period Manager —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Reconcile Service —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Subscription Module —Å–æ–∑–¥–∞–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] Module –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `ModuleCoordinator`
- [ ] Unit —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Unit —Ç–µ—Å—Ç—ã
pytest server/modules/subscription/tests/ -v

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest server/tests/integration/test_subscription_module.py -v
```

---

## üîî –§–∞–∑–∞ 4: Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø–æ–ª–Ω–∞—è)

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö webhook —Å–æ–±—ã—Ç–∏–π —Å State Machine.

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 3

### –ó–∞–¥–∞—á–∏

#### 4.1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Webhook Handler

**–§–∞–π–ª:** `server(Payment)/server/services/stripe_webhook_handler.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `SubscriptionStateMachine`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `SubscriptionContextCache` (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö must-have —Å–æ–±—ã—Ç–∏–π:
  - [ ] `checkout.session.completed` ‚Üí –ª–∏–Ω–∫–æ–≤–∫–∞ customer/subscription
  - [ ] `customer.subscription.updated` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–≤–∫–ª—é—á–∞—è `incomplete`, `past_due`, `unpaid`, `canceled`)
  - [ ] `customer.subscription.deleted` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial`
  - [ ] `invoice.payment_succeeded` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ `paid` (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
  - [ ] `invoice.payment_failed` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ `billing_problem` + —É—Å—Ç–∞–Ω–æ–≤–∫–∞ grace period
  - [ ] `invoice.payment_action_required` ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 4.2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ `subscription_events` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- [ ] –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (UNIQUE constraint)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

#### 4.3. Out-of-order –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–õ–æ–≥–∏–∫–∞:**

- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ
- [ ] Reconcile –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### 4.4. Grace Period –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–õ–æ–≥–∏–∫–∞:**

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `grace_period_end_at` –ø—Ä–∏ `invoice.payment_failed`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period (cron job –∏–ª–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ)
- [ ] –ü–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial` –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –í—Å–µ must-have —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] State Machine –ø–µ—Ä–µ—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] Out-of-order –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Grace period –ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ)
- [ ] Reconcile –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º webhook
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç—ã webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏
pytest server/services/tests/test_stripe_webhook_handler.py -v

# –¢–µ—Å—Ç—ã State Machine
pytest server/modules/subscription/tests/test_state_machine.py -v

# E2E —Ç–µ—Å—Ç—ã —Å Stripe CLI
stripe listen --forward-to localhost:8000/webhook/stripe
stripe trigger invoice.payment_succeeded
stripe trigger invoice.payment_failed
stripe trigger customer.subscription.updated
```

---

## ü§ñ –§–∞–∑–∞ 5: LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å subscription –∫–æ–º–∞–Ω–¥—ã –≤ LLM workflow.

**–í—Ä–µ–º—è:** 3-4 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 4

### –ó–∞–¥–∞—á–∏

#### 5.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AssistantResponseParser

**–§–∞–π–ª:** `server(Payment)/server/integrations/core/assistant_response_parser.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥:
  - [ ] `create_subscription` ‚Üí `{"command": "create_subscription", "args": {}}`
  - [ ] `cancel_subscription` ‚Üí `{"command": "cancel_subscription", "args": {}}`
  - [ ] `update_payment_method` ‚Üí `{"command": "update_payment_method", "args": {}}`
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- [ ] Rate limiting –¥–ª—è –∫–æ–º–∞–Ω–¥ (cooldown)

#### 5.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ System Prompt

**–§–∞–π–ª:** `server(Payment)/server/modules/text_processing/providers/gemini_live_provider.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å subscription context –≤ system prompt
- [ ] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è LLM –ø–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—é –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] Trial warnings (2 –¥–Ω—è, 1 –¥–µ–Ω—å, 0 –¥–Ω–µ–π)
- [ ] –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è subscription –∫–æ–º–∞–Ω–¥

**–õ–æ–≥–∏–∫–∞:**

- [ ] Subscription context –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É —á–µ—Ä–µ–∑ `SubscriptionContextCache`
- [ ] LLM –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏, –∫–≤–æ—Ç–∞—Ö, trial end date

#### 5.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ StreamingWorkflowIntegration

**–§–∞–π–ª:** `server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ subscription context –ø–µ—Ä–µ–¥ LLM –∑–∞–ø—Ä–æ—Å–æ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–≤–æ—Ç –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É subscription –∫–æ–º–∞–Ω–¥:
  - [ ] `create_subscription` ‚Üí –≤—ã–∑–æ–≤ `SubscriptionModule.create_checkout()`
  - [ ] `cancel_subscription` ‚Üí –≤—ã–∑–æ–≤ `SubscriptionModule.cancel_subscription()`
  - [ ] `update_payment_method` ‚Üí –≤—ã–∑–æ–≤ `SubscriptionModule.open_portal()`
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è `open_url` –∫–æ–º–∞–Ω–¥—ã (checkout_url, portal_url)
- [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ `action_message` —Å `open_url` –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç

**–õ–æ–≥–∏–∫–∞:**

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
def _process_request_streaming(self, request):
    # 1. –ü–æ–ª—É—á–∏—Ç—å subscription context
    subscription_context = self.subscription_module.get_context(hardware_id)
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–æ—Ç—ã
    quota_result = self.subscription_module.check_quota(hardware_id)
    if not quota_result.allowed:
        # –í–µ—Ä–Ω—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–æ—Ç
        yield self._generate_quota_exceeded_message(quota_result)
        return
    
    # 3. –î–æ–±–∞–≤–∏—Ç—å context –≤ LLM prompt
    enhanced_prompt = self._add_subscription_context(prompt, subscription_context)
    
    # 4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å LLM –æ—Ç–≤–µ—Ç
    llm_response = self.text_processor.process(enhanced_prompt)
    
    # 5. –ü–∞—Ä—Å–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã
    commands = self.assistant_parser.parse(llm_response)
    
    # 6. –í—ã–ø–æ–ª–Ω–∏—Ç—å subscription –∫–æ–º–∞–Ω–¥—ã
    for command in commands:
        if command['command'] == 'create_subscription':
            result = self.subscription_module.create_checkout(hardware_id)
            if result.get('checkout_url'):
                yield {
                    'action_message': {
                        'action_json': json.dumps({
                            'command': 'open_url',
                            'args': {'url': result['checkout_url']}
                        }),
                        'session_id': session_id,
                        'feature_id': 'F-2025-017-stripe-payment'
                    }
                }
        # ... –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
```

#### 5.4. Hardware ID –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–§–∞–π–ª:** `server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `hardware_id` –≤ StreamRequest
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `hardware_id` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UUID4 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `hardware_id` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:**

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
def _get_hardware_id(self, request: StreamRequest) -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è hardware_id"""
    if request.hardware_id:
        return request.hardware_id
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    import uuid
    generated_id = str(uuid.uuid4())
    logger.info(f"[HARDWARE_ID] Generated hardware_id for client: {generated_id[:8]}...")
    return generated_id
```

#### 5.5. Portal Return –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–§–∞–π–ª:** `server(Payment)/server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `portal_return` –≤ StreamRequest (–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—è)
- [ ] –í—ã–∑–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ payment_method –∏–∑ Stripe:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `StripeService.sync_payment_method(customer_id)`
  - –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π `payment_method_id`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î:
  - –í—ã–∑–≤–∞—Ç—å `SubscriptionRepository.update_payment_method_id()`
  - –û–±–Ω–æ–≤–∏—Ç—å `last_portal_return_at` timestamp
- [ ] –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ LLM)

**–õ–æ–≥–∏–∫–∞:**

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
def _handle_portal_return(self, request: StreamRequest, hardware_id: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ Portal"""
    subscription = self.subscription_repo.get_subscription(hardware_id)
    if not subscription or not subscription.stripe_customer_id:
        return
    
    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è payment_method –∏–∑ Stripe
    payment_method_data = self.stripe_service.sync_payment_method(
        subscription.stripe_customer_id
    )
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
    self.subscription_repo.update_payment_method_id(
        hardware_id,
        payment_method_data['payment_method_id']
    )
    
    # –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
    self.subscription_cache.invalidate(hardware_id)
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM
    return self._generate_portal_return_message()
```

#### 5.6. Quota Enforcement

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- [ ] –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç usage –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `AssistantResponseParser` –ø–∞—Ä—Å–∏—Ç subscription –∫–æ–º–∞–Ω–¥—ã
- [ ] System prompt –æ–±–Ω–æ–≤–ª–µ–Ω —Å subscription context
- [ ] `StreamingWorkflowIntegration` –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Subscription Module
- [ ] Hardware ID –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- [ ] Portal Return –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Quota enforcement —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] URL –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
pytest server/integrations/core/tests/test_assistant_response_parser.py -v

# –¢–µ—Å—Ç—ã LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
pytest server/integrations/workflow_integrations/tests/test_streaming_workflow_integration.py -v

# E2E —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º LLM
pytest server/tests/e2e/test_subscription_commands.py -v
```

---

## üì± –§–∞–∑–∞ 6: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (Deep Links + URL Opening)

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É deep links –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ URL –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 5

### –ó–∞–¥–∞—á–∏

#### 6.1. Deep Link Processor

**–§–∞–π–ª:** `client(Payment)/modules/deep_link/core/deep_link_processor.py`

**–ö–ª–∞—Å—Å:** `DeepLinkProcessor`

**–ú–µ—Ç–æ–¥—ã:**

- [ ] `__init__()`
- [ ] `process_deep_link(url: str) -> DeepLinkResult`
- [ ] `parse_url(url: str) -> dict`
- [ ] `handle_checkout_success(session_id: str) -> None`
- [ ] `handle_checkout_cancel() -> None`
- [ ] `handle_portal_return() -> None`

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ URL:**

- [ ] `nexy://checkout/success?session_id=xxx`
- [ ] `nexy://checkout/cancel`
- [ ] `nexy://portal/return`

#### 6.2. Deep Link Integration

**–§–∞–π–ª:** `client(Payment)/integration/integrations/deep_link_integration.py`

**–ö–ª–∞—Å—Å:** `DeepLinkIntegration`

**–õ–æ–≥–∏–∫–∞:**

- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è `deep_link.received`
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ deep links —á–µ—Ä–µ–∑ `DeepLinkProcessor`
- [ ] –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π `deep_link.processed`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `SimpleModuleCoordinator`

#### 6.3. URL Opening (open_url –∫–æ–º–∞–Ω–¥–∞)

**–§–∞–π–ª:** `client(Payment)/integration/integrations/action_execution_integration.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å `open_url` –≤ `valid_commands`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `open_url` –∫–æ–º–∞–Ω–¥—ã:

```python
def _handle_open_url(self, command_data: dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ open_url –∫–æ–º–∞–Ω–¥—ã"""
    url = command_data.get('args', {}).get('url')
    if not url:
        logger.error("open_url: URL not provided")
        return
    
    # –û—Ç–∫—Ä—ã—Ç—å URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    import subprocess
    subprocess.run(["open", url])  # macOS
    
    # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webbrowser
    # import webbrowser
    # webbrowser.open(url)
    
    logger.info(f"open_url: Opened URL {url}")
```

#### 6.4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ SimpleModuleCoordinator

**–§–∞–π–ª:** `client(Payment)/integration/core/simple_module_coordinator.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –î–æ–±–∞–≤–∏—Ç—å `DeepLinkIntegration` –≤ —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] `DeepLinkProcessor` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] `DeepLinkIntegration` —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞
- [ ] `open_url` –∫–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `ActionExecutionIntegration`
- [ ] Deep links –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] URL –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] Unit —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–π–¥–µ–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Unit —Ç–µ—Å—Ç—ã
pytest modules/deep_link/tests/ -v
pytest integration/integrations/tests/test_deep_link_integration.py -v

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest tests/integration/test_deep_links.py -v

# –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# –û—Ç–∫—Ä—ã—Ç—å URL: nexy://checkout/success?session_id=test123
```

---

## üß™ –§–∞–∑–∞ 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¶–µ–ª—å:** –ü–æ–ª–Ω–æ–µ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.

**–í—Ä–µ–º—è:** 3-4 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 6

### –ó–∞–¥–∞—á–∏

#### 7.1. E2E —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `server(Payment)/server/tests/e2e/test_subscription_full_flow.py`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

- [ ] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí paid_trial ‚Üí –æ–ø–ª–∞—Ç–∞ ‚Üí paid
- [ ] Trial –∏—Å—Ç–µ—á–µ–Ω–∏–µ ‚Üí limited_free_trial
- [ ] Payment failed ‚Üí billing_problem ‚Üí grace period ‚Üí limited_free_trial
- [ ] Payment succeeded ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤ paid
- [ ] Quota enforcement –¥–ª—è limited_free_trial
- [ ] Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- [ ] Deep links –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [ ] URL opening –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

#### 7.2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

**–§–∞–π–ª:** `v1.0.6 Payment/tests/test_smoke_critical.py`

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
- [ ] –í—Å–µ 15 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏

#### 7.3. Performance —Ç–µ—Å—Ç—ã

**–¢–µ—Å—Ç—ã:**

- [ ] Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ latency < 500ms
- [ ] Quota check latency < 50ms (cached)
- [ ] Subscription context –ø–æ–ª—É—á–µ–Ω–∏–µ < 100ms (cached)

#### 7.4. Failure simulation

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

- [ ] Stripe API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí fallback
- [ ] –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí fallback
- [ ] Webhook –¥—É–±–ª–∏–∫–∞—Ç—ã ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- [ ] Race conditions –≤ –∫–≤–æ—Ç–∞—Ö ‚Üí atomic –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –í—Å–µ E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Performance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] Failure scenarios –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# E2E —Ç–µ—Å—Ç—ã
pytest server/tests/e2e/ -v
pytest client/tests/e2e/ -v

# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
pytest v1.0.6\ Payment/tests/test_smoke_critical.py -v

# Performance —Ç–µ—Å—Ç—ã
pytest server/tests/performance/ -v
```

---

## üìù –§–∞–∑–∞ 8: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–¶–µ–ª—å:** –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ —Ä–µ–ª–∏–∑—É.

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 7

### –ó–∞–¥–∞—á–∏

#### 8.1. –ö–æ–¥ —Ä–µ–≤—å—é

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ observability

#### 8.2. Cron Jobs

**–§–∞–π–ª:** `server(Payment)/server/services/cron_jobs.py` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É cron)

**–ó–∞–¥–∞—á–∏:**

- [ ] **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ Stripe (—Ä–∞–∑ –≤ —á–∞—Å)**
  - –í—ã–∑–æ–≤ `ReconcileService.reconcile_all_active_subscriptions()`
  - –î–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ —Å `status='paid'` –∏–ª–∏ `status='billing_problem'`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period (—Ä–∞–∑ –≤ —á–∞—Å)**
  - –ü–æ–∏—Å–∫ –ø–æ–¥–ø–∏—Å–æ–∫ —Å `status='billing_problem'` –∏ –∏—Å—Ç–µ–∫—à–∏–º `grace_period_end_at`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è trial period (—Ä–∞–∑ –≤ –¥–µ–Ω—å)**
  - –ü–æ–∏—Å–∫ –ø–æ–¥–ø–∏—Å–æ–∫ —Å `status='paid_trial'` –∏ –∏—Å—Ç–µ–∫—à–∏–º `paid_trial_end_at`
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ `limited_free_trial`
  - (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞–Ω–∏–µ auto-checkout (–µ—Å–ª–∏ cooldown –ø—Ä–æ—à–µ–ª)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
def cron_reconcile_subscriptions():
    """Cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    reconcile_service = ReconcileService(...)
    count = reconcile_service.reconcile_all_active_subscriptions()
    logger.info(f"[CRON] Reconciled {count} subscriptions")

def cron_check_grace_period():
    """Cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ grace period"""
    subscriptions = subscription_repo.get_subscriptions_by_status('billing_problem')
    for sub in subscriptions:
        if sub.grace_period_end_at and sub.grace_period_end_at < now():
            state_machine.transition(sub.hardware_id, 'limited_free_trial', 'grace_period_expired')

def cron_check_trial_expiration():
    """Cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ trial expiration"""
    subscriptions = subscription_repo.get_subscriptions_by_status('paid_trial')
    for sub in subscriptions:
        if sub.paid_trial_end_at and sub.paid_trial_end_at < now():
            state_machine.transition(sub.hardware_id, 'limited_free_trial', 'trial_expired')
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É cron (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π cron service
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (hourly/daily)

#### 8.3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] `README.md` –≤ `server(Payment)/server/modules/subscription/`
- [ ] `README.md` –≤ `client(Payment)/modules/deep_link/`
- [ ] API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è webhook endpoint
- [ ] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Stripe
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ cron jobs

#### 8.4. Feature Flag

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**

- [ ] Feature flag `enable_payment_system` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Kill-switch —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≥–æ—Ç–æ–≤—ã

#### 8.5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ù–∞—Å—Ç—Ä–æ–∏—Ç—å:**

- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è subscription –∫–æ–º–∞–Ω–¥
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è quota enforcement
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ä–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É—Å–ø–µ—à–Ω–æ—Å—Ç—å)
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è cron jobs (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
- [ ] –ê–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

#### 8.6. Release Notes

**–°–æ–∑–¥–∞—Ç—å:**

- [ ] Release notes –¥–ª—è v1.0.6
- [ ] Changelog
- [ ] Migration guide

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ö–æ–¥ —Ä–µ–≤—å—é –ø—Ä–æ–π–¥–µ–Ω
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Cron jobs –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Feature flag –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Release notes –≥–æ—Ç–æ–≤—ã
- [ ] –ì–æ—Ç–æ–≤–æ –∫ production deployment

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ñ–∞–∑

| –§–∞–∑–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –í—Ä–µ–º—è | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | –°—Ç–∞—Ç—É—Å |
|------|----------|-------|-------------|--------|
| 0 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | 1-2 –¥–Ω—è | - | ‚¨ú |
| 1 | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ | 2-3 –¥–Ω—è | –§–∞–∑–∞ 0 | ‚¨ú |
| 2 | Stripe –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–±–∞–∑–æ–≤–∞—è) | 2-3 –¥–Ω—è | –§–∞–∑–∞ 1 | ‚¨ú |
| 3 | Subscription Module (—Å–µ—Ä–≤–µ—Ä) | 3-4 –¥–Ω—è | –§–∞–∑–∞ 2 | ‚¨ú |
| 4 | Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ | 2-3 –¥–Ω—è | –§–∞–∑–∞ 3 | ‚¨ú |
| 5 | LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã | 3-4 –¥–Ω—è | –§–∞–∑–∞ 4 | ‚¨ú |
| 6 | –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å | 2-3 –¥–Ω—è | –§–∞–∑–∞ 5 | ‚¨ú |
| 7 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 3-4 –¥–Ω—è | –§–∞–∑–∞ 6 | ‚¨ú |
| 8 | –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 2-3 –¥–Ω—è | –§–∞–∑–∞ 7 | ‚¨ú |

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 20-29 –¥–Ω–µ–π (4-6 –Ω–µ–¥–µ–ª—å)

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ

- [ ] –í—Å–µ —Ñ–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- [ ] Performance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ

- [ ] Trial –ø–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–ø–ª–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Webhooks –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] Quota enforcement —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Deep links —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] URL opening —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ë–∏–∑–Ω–µ—Å

- [ ] Feature flag –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout
- [ ] Kill-switch –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
- [ ] Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≥–æ—Ç–æ–≤—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–æ—Ç–æ–≤–∞

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `COMPLETE_SYSTEM_LOGIC.md` ‚Äî –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
- `F-2025-017-stripe-payment-spec.md` ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- `DATABASE_MIGRATIONS.md` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- `CONFIGURATION_PLAN.md` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `ERROR_HANDLING_PLAN.md` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `DEEP_LINKS_PLAN.md` ‚Äî deep links
- `CRITICAL_TEST_CASES.md` ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-13  
**–í–µ—Ä—Å–∏—è:** 1.1 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å —É—á–µ—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –í–µ—Ä—Å–∏—è 1.1 (2025-12-13)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω **Payment Method —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** (–§–∞–∑–∞ 2)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω **Trial Period Manager** (–§–∞–∑–∞ 3)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω **Reconcile Service** (–§–∞–∑–∞ 3)
- ‚úÖ –£—Ç–æ—á–Ω–µ–Ω–∞ **Grace Period –æ–±—Ä–∞–±–æ—Ç–∫–∞** (–§–∞–∑–∞ 4)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ **Reconcile Integration** (–§–∞–∑–∞ 4)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ **Hardware ID –æ–±—Ä–∞–±–æ—Ç–∫–∞** (–§–∞–∑–∞ 5)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ **Portal Return –æ–±—Ä–∞–±–æ—Ç–∫–∞** (–§–∞–∑–∞ 5)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã **Cron Jobs** (–§–∞–∑–∞ 8)

**–í—Å–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã.**

