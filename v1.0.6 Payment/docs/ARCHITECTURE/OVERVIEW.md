# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**Feature ID:** F-2025-017-stripe-payment  
**Last Updated:** 2025-12-13

---

## üìã –û–±–∑–æ—Ä

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Nexy –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ gRPC –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã.

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **Contract-First:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ proto/gRPC –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
2. **Independent Stacks:** –ö–ª–∏–µ–Ω—Ç –∏ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
3. **State Machine:** –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
4. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Webhooks –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ
5. **Observability:** Feature ID –∏ trace_id –≤–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö

---

## üèõÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### Client (macOS)
- **PaymentIntegration** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ deep links (`nexy://payment/*`)
- **ActionExecutionIntegration** ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (`open_url`)
- **GrpcClientIntegration** ‚Äî gRPC –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è

### Server (Python gRPC)
- **StreamingWorkflowIntegration** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- **SubscriptionContextCache** ‚Äî –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (TTL 30s)
- **StripeService** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Stripe API
- **SubscriptionStateMachine** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏
- **QuotaChecker** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç (5/25/50)

### Database
- **subscriptions** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- **subscription_events** ‚Äî –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å webhooks
- **quota_usage** ‚Äî —Å—á–µ—Ç—á–∏–∫–∏ –∫–≤–æ—Ç
- **payments** ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

### External Services
- **Stripe API** ‚Äî –ø–ª–∞—Ç–µ–∂–∏, checkout, portal, webhooks
- **Gemini API** ‚Äî LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∫–æ–º–∞–Ω–¥

---

## üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. User Request Flow

```
User ‚Üí Client ‚Üí gRPC ‚Üí Server
  ‚Üì
Server: Subscription Context (cache/DB)
  ‚Üì
Server: LLM (Gemini) —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  ‚Üì
Server: –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
  ‚Üì
Server: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (Stripe API)
  ‚Üì
Server: –û—Ç–ø—Ä–∞–≤–∫–∞ URL –Ω–∞ –∫–ª–∏–µ–Ω—Ç (action_message)
  ‚Üì
Client: –û—Ç–∫—Ä—ã—Ç–∏–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
  ‚Üì
Server: TTS –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
  ‚Üì
Client: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ
```

### 2. Webhook Flow

```
Stripe ‚Üí Webhook ‚Üí Server
  ‚Üì
Server: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è signature
  ‚Üì
Server: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (subscription_events)
  ‚Üì
Server: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
  ‚Üì
Server: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
  ‚Üì
Server: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
```

### 3. Deep Link Flow

```
Stripe Checkout/Portal ‚Üí Deep Link (nexy://payment/*)
  ‚Üì
Client: PaymentIntegration –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç URL
  ‚Üì
Client: gRPC –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
  ‚Üì
Server: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –ë–î
  ‚Üì
Server: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ Stripe (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  ‚Üì
Server: TTS —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
```

---

## üìä State Machine

**–°–º. `COMPLETE_SYSTEM_LOGIC.md` —Ä–∞–∑–¥–µ–ª 12** –¥–ª—è –ø–æ–ª–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ—Ö–æ–¥–æ–≤.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**
- `paid_trial` ‚Äî 14-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥
- `paid` ‚Äî –∞–∫—Ç–∏–≤–Ω–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `billing_problem` ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π (grace period 1 –¥–µ–Ω—å)
- `limited_free_trial` ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å –ª–∏–º–∏—Ç–∞–º–∏ (5/25/50)

**–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
- `paid_trial` ‚Üí `paid` (—á–µ—Ä–µ–∑ `invoice.payment_succeeded`)
- `paid` ‚Üí `billing_problem` (—á–µ—Ä–µ–∑ `invoice.payment_failed`)
- `billing_problem` ‚Üí `paid` (—á–µ—Ä–µ–∑ `invoice.payment_succeeded`)
- `billing_problem` ‚Üí `limited_free_trial` (–ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è grace period)

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **`COMPLETE_SYSTEM_LOGIC.md`** ‚Äî –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
- **`APPLICATION_FLOW_SCHEMA.md`** ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ flow
- **`../SERVER/OVERVIEW.md`** ‚Äî –æ–±–∑–æ—Ä —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏
- **`../CLIENT/OVERVIEW.md`** ‚Äî –æ–±–∑–æ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò–∑—É—á–∏—Ç–µ `COMPLETE_SYSTEM_LOGIC.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

