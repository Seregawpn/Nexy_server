# 🏗️ Архитектурная схема проекта Nexy с платежной системой

**Feature ID:** F-2025-017-stripe-payment  
**Date:** 2025-12-13  
**Version:** 1.0  
**Status:** ✅ Полная архитектурная схема

---

## 📋 Содержание

1. [Общая архитектура системы](#1-общая-архитектура-системы)
2. [Детальная схема компонентов](#2-детальная-схема-компонентов)
3. [Потоки данных](#3-потоки-данных)
4. [Интеграция платежной системы](#4-интеграция-платежной-системы)
5. [Взаимодействие компонентов](#5-взаимодействие-компонентов)

---

## 1. Общая архитектура системы

### 1.1. Высокоуровневая схема

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ПОЛЬЗОВАТЕЛЬ (macOS)                                │
│                         Voice Input / Keyboard                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
        ┌───────────────────────────┴───────────────────────────┐
        │                                                         │
        ▼                                                         ▼
┌───────────────────────┐                              ┌───────────────────────┐
│   CLIENT (macOS)      │                              │   EXTERNAL SERVICES   │
│                       │                              │                       │
│  • EventBus           │                              │  • Stripe API         │
│  • Integrations       │                              │  • Stripe Webhooks    │
│  • Modules            │                              │  • Gemini API         │
│  • MCP Servers        │                              │  • Azure TTS          │
│                       │                              │                       │
└───────────┬───────────┘                              └───────────────────────┘
            │
            │ gRPC (StreamRequest/StreamResponse)
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SERVER (Python gRPC)                                 │
│                                                                               │
│  • gRPC Service                                                              │
│  • Streaming Workflow                                                        │
│  • Subscription Module                                                       │
│  • LLM Integration                                                           │
│  • TTS Generation                                                            │
│  • Webhook Handler                                                           │
│                                                                               │
└───────────────────────────┬───────────────────────────────────────────────────┘
                            │
                            │ SQL Queries
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE (PostgreSQL)                                │
│                                                                               │
│  • subscriptions                                                             │
│  • subscription_events                                                       │
│  • quota_usage                                                               │
│  • payments                                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Детальная схема компонентов

### 2.1. Клиентская часть (client(Payment)/)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CLIENT: client(Payment)/                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    INTEGRATION LAYER                                 │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Core Components                                            │    │    │
│  │  │  • EventBus (event_bus.py)                                  │    │    │
│  │  │  • ApplicationStateManager (state_manager.py)                │    │    │
│  │  │  • SimpleModuleCoordinator (simple_module_coordinator.py)   │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Integrations (23 файла)                                     │    │    │
│  │  │                                                               │    │    │
│  │  │  • InputProcessingIntegration                                │    │    │
│  │  │  • VoiceRecognitionIntegration                                │    │    │
│  │  │  • ScreenshotCaptureIntegration                               │    │    │
│  │  │  • GrpcClientIntegration ──┐                                 │    │    │
│  │  │  • SpeechPlaybackIntegration                                 │    │    │
│  │  │  • ModeManagementIntegration                                  │    │    │
│  │  │  • ActionExecutionIntegration ──┐                             │    │    │
│  │  │  • DeepLinkIntegration ────────┼─► NEW                        │    │    │
│  │  │  • ... (15 других)                                            │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Workflows                                                    │    │    │
│  │  │  • ListeningWorkflow                                          │    │    │
│  │  │  • ProcessingWorkflow                                          │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    │ Events                                    │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    MODULES LAYER                                     │    │
│  │                                                                       │    │
│  │  • grpc_client/          ──┐                                         │    │
│  │  • mcp_action/           ─┼─► ActionExecutionIntegration            │    │
│  │  • mode_management/                                                    │    │
│  │  • voice_recognition/                                                 │    │
│  │  • speech_playback/                                                   │    │
│  │  • input_processing/                                                  │    │
│  │  • screenshot_capture/                                                │    │
│  │  • deep_link/ ──────────────────────┐                                │    │
│  │    └─ core/deep_link_processor.py   │                                │    │
│  │                                      │                                │    │
│  │                                      └─► DeepLinkIntegration         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    │ gRPC                                      │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    MCP SERVERS (Local)                                │    │
│  │                                                                       │    │
│  │  • Messages/ (read_messages, send_message)                          │    │
│  │  • mcp_close_app_test/ (close_app)                                  │    │
│  │                                                                       │    │
│  │  NEW: open_url command (subprocess.run(["open", url]))               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2. Серверная часть (server(Payment)/server/)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SERVER: server(Payment)/server/                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    gRPC LAYER                                        │    │
│  │                                                                       │    │
│  │  • GrpcServer (grpc_server.py)                                       │    │
│  │    └─ StreamAudio() ──► StreamingWorkflowIntegration                  │    │
│  │                                                                       │    │
│  │  • HTTP Server (webhook endpoint)                                    │    │
│  │    └─ POST /webhook/stripe ──► StripeWebhookHandler                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    WORKFLOW LAYER                                     │    │
│  │                                                                       │    │
│  │  StreamingWorkflowIntegration                                        │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  1. Получение hardware_id (или генерация)                   │    │    │
│  │  │  2. Получение subscription context (кэш/БД)                 │    │    │
│  │  │  3. Проверка квот (QuotaChecker)                            │    │    │
│  │  │  4. Построение промпта с subscription context               │    │    │
│  │  │  5. LLM обработка (GeminiLiveProvider)                      │    │    │
│  │  │  6. Парсинг ответа (AssistantResponseParser)                │    │    │
│  │  │  7. Выполнение команд (SubscriptionModule)                   │    │    │
│  │  │  8. Генерация TTS (AzureTTSProvider)                        │    │    │
│  │  │  9. Отправка ответа (StreamResponse)                         │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    ├─► ModuleCoordinator                      │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    MODULES LAYER                                      │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Subscription Module ──► NEW                                │    │    │
│  │  │  • module.py (SubscriptionModule)                           │    │    │
│  │  │  • state_machine.py (SubscriptionStateMachine)              │    │    │
│  │  │  • quota_checker.py (QuotaChecker)                         │    │    │
│  │  │  • trial_manager.py (TrialPeriodManager)                    │    │    │
│  │  │  • adapter.py (SubscriptionModuleAdapter)                   │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  • text_processing/ (GeminiLiveProvider)                             │    │
│  │  • audio_generation/ (AzureTTSProvider)                              │    │
│  │  • session_management/                                               │    │
│  │  • memory_management/                                                │    │
│  │  • interrupt_handling/                                                │    │
│  │  • browser_use/                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    SERVICES LAYER                                     │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Subscription Services ──► NEW                               │    │    │
│  │  │  • subscription_cache.py (SubscriptionContextCache)           │    │    │
│  │  │  • subscription_context_builder.py                           │    │    │
│  │  │  • reconcile_service.py (ReconcileService)                  │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Stripe Services ──► NEW                                    │    │    │
│  │  │  • stripe_service.py (StripeService)                        │    │    │
│  │  │  • stripe_webhook_handler.py (StripeWebhookHandler)         │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  • cron_jobs.py ──► NEW (периодические задачи)                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DATABASE LAYER                                    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Repositories ──► NEW                                       │    │    │
│  │  │  • subscription_repository.py                               │    │    │
│  │  │  • payment_repository.py                                    │    │    │
│  │  │  • quota_repository.py                                      │    │    │
│  │  │  • subscription_events_repository.py                        │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Migrations ──► NEW                                         │    │    │
│  │  │  • 001_create_subscriptions_tables.sql                     │    │    │
│  │  │  • 002_add_subscription_indexes.sql                       │    │    │
│  │  │  • ROLLBACK_001.sql                                        │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                           │
│                                    │ SQL                                       │
│                                    ▼                                           │
│                          ┌─────────────────────┐                               │
│                          │  PostgreSQL Database │                               │
│                          │  • subscriptions    │                               │
│                          │  • subscription_events│                              │
│                          │  • quota_usage      │                               │
│                          │  • payments         │                               │
│                          └─────────────────────┘                               │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Потоки данных

### 3.1. Основной поток запроса (с платежной системой)

```
┌──────────────┐
│   USER       │
│  (macOS)     │
└──────┬───────┘
       │ 1. Voice Input (Ctrl+N)
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: InputProcessingIntegration                                     │
│  • Захват голоса                                                        │
│  • Захват скриншота                                                     │
│  • Получение hardware_id (из кэша или генерация)                        │
│  • Создание session_id                                                  │
└──────┬──────────────────────────────────────────────────────────────────┘
       │
       │ 2. grpc.request_started
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: GrpcClientIntegration                                          │
│  • Формирование StreamRequest:                                          │
│    { prompt, screenshot, hardware_id, session_id, feature_id }          │
│  • Отправка через gRPC stream                                           │
└──────┬──────────────────────────────────────────────────────────────────┘
       │
       │ 3. gRPC StreamRequest
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: GrpcServer.StreamAudio()                                        │
│  • Проверка hardware_id (или генерация)                                  │
│  • Передача в StreamingWorkflowIntegration                               │
└──────┬──────────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: StreamingWorkflowIntegration                                    │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 1: Subscription Context                                     │   │
│  │  SubscriptionContextCache.get_context(hardware_id)               │   │
│  │    ├─► Проверка кэша (TTL 30 сек)                               │   │
│  │    ├─► Если нет → запрос к БД (SubscriptionRepository)          │   │
│  │    ├─► Если нет записи → создание paid_trial (14 дней)          │   │
│  │    ├─► Проверка реконсиляции (ReconcileService)                  │   │
│  │    ├─► Проверка grace period (если billing_problem)               │   │
│  │    └─► Формирование context для LLM                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 2: Quota Check                                              │   │
│  │  QuotaChecker.check_quota(hardware_id, status)                   │   │
│  │    ├─► Если limited_free_trial → проверка лимитов (5/25/50)      │   │
│  │    ├─► Если billing_problem → проверка grace_period_end_at       │   │
│  │    └─► Если лимит достигнут → блокировка запроса                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 3: LLM Prompt Building                                      │   │
│  │  • Добавление subscription_context в system_prompt              │   │
│  │  • Trial warnings (2, 1, 0 дней)                                │   │
│  │  • Инструкции для команд подписки                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 4: LLM Processing                                           │   │
│  │  GeminiLiveProvider.process(prompt_with_context)                 │   │
│  │    └─► Генерация ответа (возможно с JSON командой)               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 5: Response Parsing                                        │   │
│  │  AssistantResponseParser.parse(llm_response)                     │   │
│  │    ├─► Извлечение JSON (code fence / balanced braces)           │   │
│  │    ├─► Валидация схемы (command/args/text)                      │   │
│  │    └─► Если команда подписки → передача в executor               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ├─► Если команда подписки                       │
│                          │   └─► Выполнение команды (см. раздел 4)      │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ШАГ 6: TTS Generation                                          │   │
│  │  AzureTTSProvider.generate(text)                                │   │
│  │    └─► Конвертация текста в аудио                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ 4. StreamResponse (text + audio chunks)
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: GrpcClientIntegration                                          │
│  • Получение StreamResponse                                             │
│  • Публикация событий: grpc.response.text, grpc.response.audio         │
│  • Если action_message → обработка open_url команды                    │
└──────┬──────────────────────────────────────────────────────────────────┘
       │
       │ 5. Воспроизведение
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: SpeechPlaybackIntegration                                      │
│  • Воспроизведение аудио                                                │
│  • Публикация: playback.completed                                       │
└──────┬──────────────────────────────────────────────────────────────────┘
       │
       │ 6. Завершение
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: ModeManagementIntegration                                      │
│  • Переход в режим SLEEPING                                             │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2. Поток обработки команды подписки

```
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: StreamingWorkflowIntegration                                    │
│  • Обнаружена команда: create_subscription / cancel_subscription / ...  │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: SubscriptionModule                                              │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  create_subscription:                                            │   │
│  │  1. Проверка cooldown (24 часа)                                  │   │
│  │  2. StripeService.create_checkout_session()                     │   │
│  │  3. Получение checkout_url                                       │   │
│  │  4. Сохранение last_checkout_created_at в БД                     │   │
│  │  5. Возврат { checkout_url, ... }                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  cancel_subscription:                                            │   │
│  │  1. Получение subscription из БД                                 │   │
│  │  2. StripeService.cancel_subscription()                          │   │
│  │  3. Обновление статуса в БД (через State Machine)                │   │
│  │  4. Инвалидация кэша                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  update_payment_method:                                          │   │
│  │  1. Получение subscription из БД                                 │   │
│  │  2. StripeService.create_customer_portal_session()               │   │
│  │  3. Получение portal_url                                         │   │
│  │  4. Возврат { portal_url, ... }                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ URL (checkout_url или portal_url)
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: StreamingWorkflowIntegration                                    │
│  • Генерация action_message:                                            │
│    {                                                                     │
│      "action_json": '{"command": "open_url", "args": {"url": "..."}}', │
│      "session_id": "...",                                               │
│      "feature_id": "F-2025-017-stripe-payment"                          │
│    }                                                                     │
│  • Отправка в StreamResponse                                            │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ StreamResponse.action_message
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: GrpcClientIntegration                                          │
│  • Получение action_message                                             │
│  • Публикация события: grpc.response.action                             │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ grpc.response.action
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: ActionExecutionIntegration                                      │
│  • Парсинг action_json: {"command": "open_url", "args": {"url": "..."}} │
│  • Вызов _handle_open_url()                                             │
│  • subprocess.run(["open", url])  # macOS                               │
│  • Браузер открывается с checkout/portal                                │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ Пользователь завершает оплату в браузере
       │
       │ Deep Link: nexy://checkout/success?session_id=xxx
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  CLIENT: DeepLinkIntegration                                            │
│  • Обработка deep link через DeepLinkProcessor                          │
│  • Парсинг URL: nexy://checkout/success?session_id=xxx                  │
│  • Публикация события: deep_link.processed                              │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ (Опционально) Отправка gRPC запроса с флагом portal_return
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: StreamingWorkflowIntegration                                    │
│  • Обработка portal_return флага                                        │
│  • Синхронизация payment_method из Stripe                                │
│  • Обновление БД и инвалидация кэша                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3. Поток обработки Webhook от Stripe

```
┌─────────────────────────────────────────────────────────────────────────┐
│  STRIPE API                                                              │
│  • Событие: checkout.session.completed / invoice.payment_succeeded / ...│
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       │ HTTP POST /webhook/stripe
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: HTTP Server (webhook endpoint)                                  │
│  • Получение HTTP запроса                                                │
│  • Извлечение payload и signature                                        │
└──────┬───────────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SERVER: StripeWebhookHandler                                            │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. Верификация подписи                                          │   │
│  │     StripeService.verify_webhook_signature()                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  2. Проверка идемпотентности                                     │   │
│  │     SubscriptionEventsRepository.event_exists(stripe_event_id)  │   │
│  │     Если существует → игнорировать (логировать)                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  3. Сохранение события                                           │   │
│  │     SubscriptionEventsRepository.create_event()                 │   │
│  │     (UNIQUE constraint предотвращает дубликаты)                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  4. Обработка события                                            │   │
│  │     handle_event(event)                                          │   │
│  │     ├─► checkout.session.completed                              │   │
│  │     │   └─► Линковка customer/subscription в БД                 │   │
│  │     ├─► invoice.payment_succeeded                               │   │
│  │     │   └─► State Machine: → paid                               │   │
│  │     ├─► invoice.payment_failed                                   │   │
│  │     │   └─► State Machine: → billing_problem + grace_period    │   │
│  │     ├─► customer.subscription.updated                           │   │
│  │     │   └─► Обновление статуса в БД                              │   │
│  │     └─► customer.subscription.deleted                            │   │
│  │         └─► State Machine: → limited_free_trial                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  5. Инвалидация кэша                                             │   │
│  │     SubscriptionContextCache.invalidate(hardware_id)            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          │                                               │
│                          ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  6. Возврат ответа                                               │   │
│  │     HTTP 200 OK                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Интеграция платежной системы

### 4.1. Компоненты платежной системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PAYMENT SYSTEM COMPONENTS                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  SERVER: Subscription Module                                     │   │
│  │                                                                   │   │
│  │  • SubscriptionModule (module.py)                                │   │
│  │    ├─► get_context() → SubscriptionContextCache                  │   │
│  │    ├─► check_quota() → QuotaChecker                              │   │
│  │    ├─► create_checkout() → StripeService                          │   │
│  │    ├─► open_portal() → StripeService                              │   │
│  │    └─► cancel_subscription() → StripeService                       │   │
│  │                                                                   │   │
│  │  • SubscriptionStateMachine (state_machine.py)                   │   │
│  │    └─► Управление переходами статусов                             │   │
│  │                                                                   │   │
│  │  • QuotaChecker (quota_checker.py)                               │   │
│  │    └─► Проверка лимитов для limited_free_trial                    │   │
│  │                                                                   │   │
│  │  • TrialPeriodManager (trial_manager.py)                         │   │
│  │    └─► Управление trial периодом и предупреждениями               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  SERVER: Services                                                │   │
│  │                                                                   │   │
│  │  • StripeService (stripe_service.py)                              │   │
│  │    ├─► create_checkout_session()                                 │   │
│  │    ├─► create_customer_portal_session()                           │   │
│  │    ├─► cancel_subscription()                                     │   │
│  │    ├─► sync_payment_method()                                     │   │
│  │    └─► verify_webhook_signature()                                │   │
│  │                                                                   │   │
│  │  • StripeWebhookHandler (stripe_webhook_handler.py)               │   │
│  │    └─► Обработка всех webhook событий                             │   │
│  │                                                                   │   │
│  │  • SubscriptionContextCache (subscription_cache.py)               │   │
│  │    ├─► get_context() (TTL 30 сек)                                │   │
│  │    ├─► invalidate()                                              │   │
│  │    └─► Интеграция с ReconcileService                             │   │
│  │                                                                   │   │
│  │  • ReconcileService (reconcile_service.py)                       │   │
│  │    └─► Реконсиляция со Stripe (Stripe - источник истины)         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  SERVER: Database                                                │   │
│  │                                                                   │   │
│  │  • SubscriptionRepository                                        │   │
│  │  • PaymentRepository                                              │   │
│  │  • QuotaRepository                                                │   │
│  │  • SubscriptionEventsRepository                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  CLIENT: Deep Link Integration                                   │   │
│  │                                                                   │   │
│  │  • DeepLinkProcessor                                             │   │
│  │    └─► Обработка nexy://checkout/* и nexy://portal/*             │   │
│  │                                                                   │   │
│  │  • ActionExecutionIntegration                                    │   │
│  │    └─► Обработка open_url команды                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2. Интеграция в существующий workflow

```
┌─────────────────────────────────────────────────────────────────────────┐
│  EXISTING WORKFLOW (до платежной системы)                                │
│                                                                           │
│  User Input → gRPC Request → LLM → TTS → Response                        │
└─────────────────────────────────────────────────────────────────────────┘
                            │
                            │ + Payment System
                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ENHANCED WORKFLOW (с платежной системой)                                 │
│                                                                           │
│  User Input                                                               │
│      │                                                                    │
│      ▼                                                                    │
│  gRPC Request (hardware_id)                                               │
│      │                                                                    │
│      ├─► Subscription Context (кэш/БД)                                   │
│      ├─► Quota Check                                                     │
│      ├─► LLM Prompt (с subscription context)                             │
│      ├─► LLM Response (возможно команда подписки)                        │
│      ├─► Command Execution (если команда)                                │
│      │   └─► open_url → Browser → Deep Link                              │
│      └─► TTS → Response                                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Взаимодействие компонентов

### 5.1. Диаграмма взаимодействия (последовательность)

```
User          Client          Server          Stripe          Database
 │              │               │               │                │
 │──Voice──────►│               │               │                │
 │              │               │               │                │
 │              │──gRPC Request─►│               │                │
 │              │  (hardware_id) │               │                │
 │              │               │               │                │
 │              │               │──Get Context──►                │
 │              │               │◄─Subscription─│                │
 │              │               │               │                │
 │              │               │──Check Quota──►                │
 │              │               │◄─Quota Result─│                │
 │              │               │               │                │
 │              │               │──LLM Prompt───►                │
 │              │               │◄─LLM Response─│                │
 │              │               │               │                │
 │              │               │──Parse───────►                │
 │              │               │◄─Command──────│                │
 │              │               │               │                │
 │              │               │──Create───────┼──Checkout─────►│
 │              │               │  Checkout     │                │
 │              │               │◄─checkout_url─┼───────────────┐│
 │              │               │               │                ││
 │              │◄─action_msg───│               │                ││
 │              │  (open_url)    │               │                ││
 │              │               │               │                ││
 │              │──Open Browser─┼───────────────┼───────────────┘│
 │              │               │               │                │
 │◄─Browser─────│               │               │                │
 │  (Checkout)  │               │               │                │
 │              │               │               │                │
 │──Complete────┼───────────────┼───────────────┼──Webhook──────►│
 │  Payment     │               │               │                │
 │              │               │               │                │
 │              │               │◄─Webhook──────┼                │
 │              │               │  Event        │                │
 │              │               │               │                │
 │              │               │──Process──────►                │
 │              │               │  Event        │                │
 │              │               │◄─Updated──────│                │
 │              │               │               │                │
 │              │◄─Deep Link────│               │                │
 │              │  (success)    │               │                │
 │              │               │               │                │
 │              │──gRPC Request─►│               │                │
 │              │  (portal_return)│               │                │
 │              │               │               │                │
 │              │               │──Sync Payment─┼──Get Customer─►│
 │              │               │  Method        │                │
 │              │               │◄─Updated───────┼───────────────┐│
 │              │               │               │                ││
 │              │◄─Response─────│               │                ││
 │              │               │               │                ││
 │              │               │               │                ││
```

### 5.2. Схема State Machine

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SUBSCRIPTION STATE MACHINE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌──────────────┐                                      │
│                    │  paid_trial  │                                      │
│                    │  (14 days)   │                                      │
│                    └──────┬───────┘                                      │
│                           │                                              │
│         ┌──────────────────┼──────────────────┐                          │
│         │                  │                  │                          │
│         │ invoice.payment  │ trial expired    │                          │
│         │ _succeeded        │                  │                          │
│         ▼                  ▼                  │                          │
│    ┌─────────┐      ┌──────────────────┐     │                          │
│    │  paid   │      │limited_free_trial│     │                          │
│    │         │      │  (5/25/50 limits)│     │                          │
│    └────┬────┘      └──────────────────┘     │                          │
│         │                                      │                          │
│         │ invoice.payment_failed               │                          │
│         │                                      │                          │
│         ▼                                      │                          │
│    ┌──────────────────┐                       │                          │
│    │ billing_problem  │                       │                          │
│    │ (grace 1 day)    │                       │                          │
│    └────┬─────────────┘                       │                          │
│         │                                      │                          │
│         ├─► invoice.payment_succeeded           │                          │
│         │   └─► paid                           │                          │
│         │                                      │                          │
│         └─► grace_period_expired                │                          │
│             └─► limited_free_trial            │                          │
│                                                                           │
│  Other statuses:                                                          │
│  • admin_active (безлимитный)                                             │
│  • grandfathered (безлимитный)                                            │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3. Схема кэширования

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SUBSCRIPTION CONTEXT CACHE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  Request → SubscriptionContextCache.get_context(hardware_id)             │
│              │                                                            │
│              ├─► Cache Hit? (TTL 30 сек)                                 │
│              │   └─► Return cached context                               │
│              │                                                            │
│              └─► Cache Miss                                               │
│                  │                                                        │
│                  ├─► SubscriptionRepository.get_subscription()           │
│                  │                                                        │
│                  ├─► ReconcileService.check_reconciliation_needed()      │
│                  │   └─► Если нужно → reconcile_with_stripe()             │
│                  │                                                        │
│                  ├─► Grace Period Check                                   │
│                  │   └─► Если истек → transition to limited_free_trial    │
│                  │                                                        │
│                  ├─► Trial Period Check                                   │
│                  │   └─► Если истек → transition to limited_free_trial   │
│                  │                                                        │
│                  ├─► SubscriptionContextBuilder.build_context()            │
│                  │                                                        │
│                  └─► Save to cache (TTL 30 сек)                          │
│                                                                           │
│  Invalidation triggers:                                                   │
│  • Webhook events (все изменения)                                        │
│  • Subscription commands (create/cancel/update)                          │
│  • Portal return (payment_method sync)                                   │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Технические детали

### 6.1. Протоколы и форматы

**gRPC:**
- `StreamRequest` → `hardware_id`, `prompt`, `screenshot`, `session_id`
- `StreamResponse` → `text`, `audio_chunks`, `action_message`
- `action_message.action_json` → `{"command": "open_url", "args": {"url": "..."}}`

**Deep Links:**
- `nexy://checkout/success?session_id=xxx`
- `nexy://checkout/cancel`
- `nexy://portal/return`

**Stripe Webhooks:**
- HTTP POST `/webhook/stripe`
- Signature verification (HMAC)
- Идемпотентность через `subscription_events` table

**Database:**
- PostgreSQL
- Таблицы: `subscriptions`, `subscription_events`, `quota_usage`, `payments`
- Индексы для производительности

### 6.2. Конфигурация

**Server Config (`unified_config.yaml`):**
```yaml
features:
  enable_payment_system: false  # Feature flag

stripe:
  use_test_mode: true
  checkout_cooldown_hours: 24
  grace_period_days: 1
  trial_days: 14

quota:
  enabled: true
  daily_limit: 5
  weekly_limit: 25
  monthly_limit: 50

subscription:
  cache_ttl_seconds: 30
  auto_checkout_enabled: true
  trial_warnings_enabled: true
  trial_warning_days: [2, 1, 0]
```

### 6.3. Cron Jobs

**Периодические задачи:**
- **Раз в час:** Реконсиляция всех активных подписок со Stripe
- **Раз в час:** Проверка истечения grace period
- **Раз в день:** Проверка истечения trial period

---

## 7. Ключевые принципы архитектуры

### 7.1. Разделение ответственности

**Client:**
- UX логика (deep links, URL opening)
- Нет бизнес-логики
- Нет проверки квот/статусов

**Server:**
- Вся бизнес-логика (subscription, quotas, state machine)
- Источник истины для статусов
- Интеграция со Stripe

**Database:**
- Хранение данных подписок
- Идемпотентность webhooks
- История платежей

### 7.2. Безопасность

- `hardware_id` из gRPC запроса (не от LLM)
- Stripe webhook signature verification
- Идемпотентность через UNIQUE constraints
- Feature flag для постепенного rollout

### 7.3. Производительность

- Кэш subscription context (TTL 30 сек)
- Индексы в БД для быстрых запросов
- Atomic операции для квот
- Асинхронная обработка webhooks

---

## 📚 Связанные документы

- `COMPLETE_SYSTEM_LOGIC.md` — полная логика системы
- `APPLICATION_FLOW_SCHEMA.md` — детальная схема flow
- `IMPLEMENTATION_PHASES.md` — план реализации
- `docs/architecture/PROJECT_STRUCTURE.md` — структура проекта

---

**Последнее обновление:** 2025-12-13  
**Версия:** 1.0


















