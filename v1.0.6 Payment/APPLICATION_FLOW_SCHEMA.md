# 🏗️ Схема работы приложения Nexy с платежной системой

> **Полная архитектурная схема:** От пользовательского ввода до ответа с учетом подписок, квот и платежей

**Дата создания:** 2025-12-13  
**Версия:** 1.0  
**Статус:** Golden source для реализации

---

## 📋 Содержание

1. [Общий поток приложения](#1-общий-поток-приложения)
2. [Интеграция платежной системы](#2-интеграция-платежной-системы)
3. [Проверка квот и статуса](#3-проверка-квот-и-статуса)
4. [Обработка команд подписки](#4-обработка-команд-подписки)
5. [Webhooks от Stripe](#5-webhooks-от-stripe)
6. [Кэширование и синхронизация](#6-кэширование-и-синхронизация)
7. [Генерация TTS речи](#7-генерация-tts-речи)

---

## 1. Общий поток приложения

### 1.1. Полный цикл запроса (End-to-End)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ПОЛЬЗОВАТЕЛЬ (macOS)                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 1. Голосовой ввод (Ctrl+N)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ: InputProcessingIntegration                        │
│  - Захват голоса (VoiceRecognitionIntegration)                              │
│  - Захват скриншота (ScreenshotCaptureIntegration)                           │
│  - Получение hardware_id (из кэша или генерация)                             │
│  - Создание session_id (StateManager)                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 2. Агрегация данных
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ: GrpcClientIntegration                             │
│  - Формирование StreamRequest:                                               │
│    { prompt, screenshot, hardware_id, session_id, feature_id }             │
│  - Отправка через gRPC stream                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 3. gRPC StreamRequest
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    СЕРВЕР: GrpcServer.StreamAudio()                          │
│  - Проверка backpressure (лимиты стримов)                                    │
│  - Проверка глобального прерывания                                           │
│  - Создание request_data                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 4. Передача в workflow
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              СЕРВЕР: StreamingWorkflowIntegration                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5. ПОЛУЧЕНИЕ КОНТЕКСТА ПОДПИСКИ (SubscriptionContextCache)        │   │
│  │    - Проверка кэша (TTL 30 сек)                                      │   │
│  │    - Если нет в кэше → запрос к БД                                    │   │
│  │    - Если нет записи → создание paid_trial (14 дней)                 │   │
│  │    - Формирование context: { status, quotas, trial_warning, ... } │   │
│  │    - Сохранение в кэш                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 6. ПРОВЕРКА КВОТ (QuotaChecker)                                      │   │
│  │    - Если status = limited_free_trial → проверка лимитов             │   │
│  │    - Если status = billing_problem → проверка grace_period_end_at    │   │
│  │    - Если лимит достигнут → блокировка запроса                       │   │
│  │    - Если trial истек → авто-открытие Checkout (с cooldown)         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 7. ПОСТРОЕНИЕ ПРОМПТА ДЛЯ LLM                                        │   │
│  │    - Добавление subscription_context в system_prompt                 │   │
│  │    - Если trial_warning → добавление предупреждения                 │   │
│  │    - Инструкции для команд подписки                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 8. ОБРАБОТКА LLM (GeminiLiveProvider)                                │   │
│  │    - Генерация ответа с учетом контекста подписки                   │   │
│  │    - Возможная генерация JSON команды (subscribe/cancel/status)     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 9. ПАРСИНГ ОТВЕТА (AssistantResponseParser)                         │   │
│  │    - Извлечение JSON из ответа (code fence / balanced braces)       │   │
│  │    - Валидация схемы (command/args/text)                            │   │
│  │    - Проверка allowlist команд                                      │   │
│  │    - Если команда найдена → передача в executor                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ├─► Если команда подписки                │
│                                    │   └─► Выполнение команды (см. раздел 4)│
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 10. ФОРМИРОВАНИЕ ТЕКСТА ДЛЯ TTS                                       │   │
│  │     - Извлечение текста из LLM ответа (или из команды)               │   │
│  │     - Если trial_warning → добавление предупреждения в начало        │   │
│  │     - Если команда подписки → использование text из команды         │   │
│  │     - Валидация длины текста (лимит для TTS)                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 11. ГЕНЕРАЦИЯ АУДИО (AzureTTSProvider)                               │   │
│  │     - Конвертация текста в аудио (Azure Cognitive Services)         │   │
│  │     - Настройки голоса (язык: en-US, голос, скорость)              │   │
│  │     - Разбиение на чанки для стриминга                               │   │
│  │     - Обработка ошибок TTS (fallback на текст, таймауты, retry)     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 12. StreamResponse (text + audio chunks)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ: GrpcClientIntegration                             │
│  - Получение StreamResponse                                                  │
│  - Публикация событий: grpc.response.text, grpc.response.audio            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 12. Воспроизведение
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ: SpeechPlaybackIntegration                         │
│  - Воспроизведение аудио через системный TTS                                  │
│  - Публикация: playback.completed                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 14. Завершение
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ: ModeManagementIntegration                         │
│  - Переход в режим SLEEPING                                                  │
│  - Ожидание следующего запроса                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Интеграция платежной системы

### 2.1. Компоненты платежной системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    СЕРВЕР: Платежные модули                                   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SubscriptionContextCache                                             │   │
│  │ - Кэширование контекста подписки (TTL 30 сек)                        │   │
│  │ - Получение из БД или создание paid_trial                            │   │
│  │ - Расчет days_left, trial_warning_info                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ QuotaChecker                                                         │   │
│  │ - Проверка лимитов для limited_free_trial (5/25/50)                 │   │
│  │ - Проверка grace_period для billing_problem                         │   │
│  │ - Атомарные операции с quota_usage                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ StripeModule                                                        │   │
│  │ - Создание Checkout Session                                         │   │
│  │ - Создание Customer Portal URL                                      │   │
│  │ - Синхронизация с Stripe API                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SubscriptionCommandExecutor                                         │   │
│  │ - Выполнение команд: create_subscription, cancel_subscription,    │   │
│  │   update_payment_method, check_status                                │   │
│  │ - Валидация бизнес-правил                                           │   │
│  │ - Rate limiting (cooldown)                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    БАЗА ДАННЫХ (PostgreSQL)                                   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ subscriptions                                                         │   │
│  │ - hardware_id (PK)                                                    │   │
│  │ - status, stripe_customer_id, stripe_subscription_id                  │   │
│  │ - paid_trial_end_at, grace_period_end_at, current_period_end          │   │
│  │ - last_trial_warning_date, last_checkout_created_at                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ subscription_events                                                  │   │
│  │ - stripe_event_id (UNIQUE PK)                                       │   │
│  │ - event_type, event_data, processed_at                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ quota_usage                                                          │   │
│  │ - hardware_id, period_type (day/week/month)                          │   │
│  │ - period_start, request_count                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ payments                                                            │   │
│  │ - payment_id, hardware_id, stripe_payment_intent_id                │   │
│  │ - amount, currency, status, created_at                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STRIPE (Внешний сервис)                                   │
│                                                                               │
│  - Checkout Sessions                                                         │
│  - Subscriptions                                                             │
│  - Customers                                                                 │
│  - Payment Methods                                                            │
│  - Webhooks (→ Server)                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2. Точки интеграции в основном потоке

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ОСНОВНОЙ ПОТОК + ПЛАТЕЖИ                                   │
└─────────────────────────────────────────────────────────────────────────────┘

1. ПОЛУЧЕНИЕ ЗАПРОСА (GrpcServer)
   │
   ├─► Извлечение hardware_id из StreamRequest
   │
   └─► Передача в StreamingWorkflowIntegration

2. ПОЛУЧЕНИЕ КОНТЕКСТА ПОДПИСКИ (SubscriptionContextCache)
   │
   ├─► Проверка кэша (TTL 30 сек)
   │   ├─► Если есть → возврат из кэша
   │   └─► Если нет → запрос к БД
   │
   ├─► Если нет записи в БД:
   │   └─► Создание paid_trial (14 дней, БЕЗ карты)
   │
   ├─► Формирование context:
   │   {
   │     status: 'paid_trial' | 'paid' | 'limited_free_trial' | 'billing_problem',
   │     days_left: 5,
   │     trial_warning: { should_show: true, days_left: 2 },
   │     quotas: { daily: 5, weekly: 25, monthly: 50 },
   │     current_usage: { daily: 3, weekly: 15, monthly: 30 },
   │     subscription_info: { ... }
   │   }
   │
   └─► Сохранение в кэш (TTL 30 сек)

3. ПРОВЕРКА КВОТ (QuotaChecker)
   │
   ├─► Если status = 'limited_free_trial':
   │   ├─► Проверка лимитов (5/день, 25/неделя, 50/месяц)
   │   ├─► Атомарное увеличение счетчиков (INSERT ... ON CONFLICT)
   │   └─► Если лимит достигнут → блокировка запроса
   │
   ├─► Если status = 'billing_problem':
   │   ├─► Проверка grace_period_end_at
   │   └─► Если grace истек → переход в limited_free_trial
   │
   └─► Если status = 'paid_trial' и trial истек:
       ├─► Проверка cooldown (24 часа)
       └─► Если прошло >= 24 часа → авто-открытие Checkout

4. ПОСТРОЕНИЕ ПРОМПТА ДЛЯ LLM
   │
   ├─► Добавление subscription_context в system_prompt
   │
   ├─► Если trial_warning.should_show:
   │   └─► Добавление предупреждения в начало промпта
   │
   └─► Инструкции для команд подписки:
       - "I want to subscribe" → create_subscription
       - "Cancel subscription" → cancel_subscription
       - "What is my subscription status?" → check_status
       - "Update payment method" → update_payment_method

5. ОБРАБОТКА LLM + ПАРСИНГ
   │
   ├─► LLM генерирует ответ (возможно с JSON командой)
   │
   ├─► AssistantResponseParser извлекает JSON:
   │   ├─► Вариант 1: Code fence ```json {...} ```
   │   ├─► Вариант 2: Code fence ``` {...} ```
   │   ├─► Вариант 3: Весь ответ - JSON
   │   └─► Вариант 4: Balanced braces extraction
   │
   ├─► Валидация схемы (command/args/text)
   │
   └─► Если команда подписки найдена:
       └─► Передача в SubscriptionCommandExecutor (см. раздел 4)

6. ГЕНЕРАЦИЯ ОТВЕТА
   │
   ├─► Текст из LLM (или из команды)
   │
   └─► Генерация TTS через AzureTTSProvider (см. раздел 7)
```

---

## 3. Проверка квот и статуса

### 3.1. Логика проверки квот

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    QuotaChecker.check_quota(hardware_id)                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Получение статуса     │
                        │ из SubscriptionContext│
                        └───────────┬───────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
        │ paid_trial      │ │ limited_free_   │ │ billing_problem  │
        │                 │ │ trial           │ │                 │
        └────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘
                 │                   │                     │
                 │                   ▼                     │
                 │      ┌──────────────────────────┐     │
                 │      │ Проверка лимитов:         │     │
                 │      │ - daily: 5                │     │
                 │      │ - weekly: 25              │     │
                 │      │ - monthly: 50              │     │
                 │      └───────────┬────────────────┘     │
                 │                  │                       │
                 │                  ▼                       │
                 │      ┌──────────────────────────┐       │
                 │      │ Атомарное увеличение:     │       │
                 │      │ INSERT ... ON CONFLICT   │       │
                 │      │ UPDATE request_count     │       │
                 │      └───────────┬────────────────┘     │
                 │                  │                       │
                 │                  ▼                       │
                 │      ┌──────────────────────────┐       │
                 │      │ Если лимит достигнут:    │       │
                 │      │ → BLOCK_REQUEST          │       │
                 │      │ → TTS: "Limit reached"   │       │
                 │      └──────────────────────────┘       │
                 │                                         │
                 │                                         ▼
                 │                              ┌──────────────────────────┐
                 │                              │ Проверка grace_period:    │
                 │                              │ - Если grace_end <= now() │
                 │                              │ → Переход в limited_free   │
                 │                              └──────────────────────────┘
                 │
                 ▼
        ┌───────────────────────┐
        │ Проверка trial_end:    │
        │ - Если trial_end <= now│
        │ → Проверка cooldown    │
        │ → Авто-открытие Checkout│
        └───────────────────────┘
```

### 3.2. Статусы и их влияние на доступ

| Статус | Доступ | Лимиты | Особенности |
|--------|--------|--------|-------------|
| `paid_trial` | ✅ Безлимитный | Нет | 14 дней, БЕЗ карты |
| `paid` | ✅ Безлимитный | Нет | Активная подписка |
| `billing_problem` | ✅ Безлимитный (grace) | Нет | Grace 1 день, затем → limited |
| `limited_free_trial` | ⚠️ Ограниченный | 5/25/50 | Бессрочно |
| `admin_active` | ✅ Безлимитный | Нет | Админ-активация |
| `grandfathered` | ✅ Безлимитный | Нет | Legacy пользователи |

---

## 4. Обработка команд подписки

### 4.1. Команда "create_subscription" (I want to subscribe)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SubscriptionCommandExecutor.create_subscription()          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Валидация:            │
                        │ - Не подписан ли уже? │
                        │ - Есть ли cooldown?   │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Проверка cooldown:     │
                        │ last_checkout_created_at│
                        │ Если < 24 часа →       │
                        │ возврат существующего │
                        │ checkout_url          │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Создание Checkout:    │
                        │ StripeModule.create_  │
                        │ checkout_session()    │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Обновление БД:         │
                        │ - last_checkout_       │
                        │   created_at = now()   │
                        │ - last_checkout_       │
                        │   session_id           │
                        │ - Инвалидация кэша     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Формирование текста:   │
                        │ "Opening the          │
                        │ subscription page.    │
                        │ After subscribing,    │
                        │ payment will be       │
                        │ automatically charged."│
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Генерация TTS:         │
                        │ AzureTTSProvider.     │
                        │ generate(text)         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Возврат checkout_url  │
                        │ + StreamResponse {    │
                        │   text_chunk,          │
                        │   audio_chunk          │
                        │ }                      │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ КЛИЕНТ: Открытие       │
                        │ браузера (webbrowser.  │
                        │ open(checkout_url))    │
                        └───────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ ПОЛЬЗОВАТЕЛЬ: Ввод     │
                        │ карты в Stripe Checkout│
                        └───────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ STRIPE: Webhook        │
                        │ checkout.session.      │
                        │ completed              │
                        └───────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ СЕРВЕР: Обработка      │
                        │ webhook (см. раздел 5) │
                        └───────────────────────┘
```

### 4.2. Команда "cancel_subscription" (Cancel subscription)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SubscriptionCommandExecutor.cancel_subscription()           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Валидация:             │
                        │ - Статус = 'paid'?    │
                        │ - Есть stripe_         │
                        │   subscription_id?     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ LLM: Подтверждение     │
                        │ "Are you sure you     │
                        │ want to cancel?"      │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Если подтверждено:     │
                        │ StripeModule.cancel_  │
                        │ subscription(          │
                        │ cancel_at_period_end=  │
                        │ True)                 │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Обновление БД:         │
                        │ - cancel_at_period_    │
                        │   end = True           │
                        │ - cancellation_reason   │
                        │ - Инвалидация кэша     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Формирование текста:   │
                        │ "Subscription         │
                        │ cancellation scheduled.│
                        │ You can continue using │
                        │ until [date]..."       │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Генерация TTS:         │
                        │ AzureTTSProvider.     │
                        │ generate(text)         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Стриминг аудио:         │
                        │ StreamResponse {       │
                        │   text_chunk,          │
                        │   audio_chunk          │
                        │ }                      │
                        └───────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Доступ остается до     │
                        │ current_period_end     │
                        └───────────────────────┘
```

### 4.3. Команда "check_status" (What is my subscription status?)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SubscriptionCommandExecutor.check_status()                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Получение контекста:   │
                        │ SubscriptionContext   │
                        │ Cache.get_context()    │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Формирование контекста│
                        │ для LLM:              │
                        │ {                     │
                        │   status: 'paid',     │
                        │   current_period_end: │
                        │     '2025-12-30',     │
                        │   cancel_at_period_   │
                        │     _end: false,      │
                        │   ...                 │
                        │ }                     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ LLM: Генерация ответа  │
                        │ на основе контекста    │
                        │ (без JSON команды)     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ LLM: Генерация ответа  │
                        │ "You have an active   │
                        │  paid subscription..." │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Генерация TTS:         │
                        │ AzureTTSProvider.     │
                        │ generate(text)         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Стриминг аудио:         │
                        │ StreamResponse {       │
                        │   text_chunk,          │
                        │   audio_chunk          │
                        │ }                      │
                        └───────────────────────┘
```

### 4.4. Команда "update_payment_method" (Update payment method)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SubscriptionCommandExecutor.update_payment_method()       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Валидация:             │
                        │ - Статус = 'paid'?    │
                        │ - Есть stripe_         │
                        │   customer_id?         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Создание Portal URL:   │
                        │ StripeModule.create_   │
                        │ portal_session()       │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ КЛИЕНТ: Открытие       │
                        │ браузера с Portal URL  │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ ПОЛЬЗОВАТЕЛЬ: Обновление│
                        │ карты в Customer Portal│
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Возврат через deep link│
                        │ nexy://payment/        │
                        │ portal_return         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ СЕРВЕР: Синхронизация  │
                        │ - retrieve subscription│
                        │ - Обновление payment_  │
                        │   method_id            │
                        │ - Инвалидация кэша     │
                        └───────────────────────┘
```

---

## 5. Webhooks от Stripe

### 5.1. Обработка webhook событий

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STRIPE → Server: Webhook Event                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ POST /webhook/stripe   │
                        │ Headers:              │
                        │ - Stripe-Signature     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 1. Верификация подписи│
                        │ verify_stripe_webhook()│
                        │ - Проверка timestamp   │
                        │ - Проверка signature   │
                        │ - Replay protection    │
                        │   (max age 300 сек)    │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 2. Извлечение данных:  │
                        │ extract_event_data()   │
                        │ - event_type           │
                        │ - event_id             │
                        │ - customer_id           │
                        │ - subscription_id       │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 3. Валидация данных:   │
                        │ validate_event_data() │
                        │ - Проверка обязательных│
                        │   полей                │
                        │ - Проверка формата     │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 4. Идемпотентность:    │
                        │ INSERT INTO            │
                        │ subscription_events    │
                        │ (stripe_event_id)      │
                        │ ON CONFLICT DO NOTHING │
                        │ - Если дубликат →      │
                        │   игнорировать         │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 5. Поиск hardware_id:  │
                        │ - По customer_id       │
                        │ - По subscription_id   │
                        │ - Если не найден →     │
                        │   создание новой       │
                        │   записи               │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 6. Инвалидация кэша:   │
                        │ cache.invalidate(     │
                        │   hardware_id)        │
                        │ ⚠️ КРИТИЧНО: ПЕРЕД    │
                        │ обновлением БД!        │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ 7. Обработка события:  │
                        │ process_webhook_event()│
                        │ (см. State Machine)     │
                        └───────────┬───────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
        │ checkout.session│ │ invoice.payment_│ │ customer.       │
        │ .completed      │ │ succeeded       │ │ subscription.    │
        │                 │ │                 │ │ updated         │
        └────────┬────────┘ └────────┬────────┘ └────────┬────────┘
                 │                  │                   │
                 ▼                  ▼                   ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │ Связывание   │  │ status='paid'│  │ Синхронизация│
        │ customer/    │  │ Обновление   │  │ статуса      │
        │ subscription │  │ payments     │  │ payment_     │
        │ НЕ меняем    │  │ Инвалидация  │  │ method       │
        │ статус!       │  │ кэша         │  │ Инвалидация  │
        └──────────────┘  └──────────────┘  └──────────────┘
```

### 5.2. Must-have события и их обработка

| Событие | Действие | Обновление БД | Инвалидация кэша |
|---------|----------|---------------|------------------|
| `checkout.session.completed` | Связывание customer/subscription | `stripe_customer_id`, `stripe_subscription_id` | ✅ Да |
| `invoice.payment_succeeded` | Статус → `paid` | `status='paid'`, `last_payment_at`, `current_period_end` | ✅ Да |
| `invoice.payment_failed` | Статус → `billing_problem` | `status='billing_problem'`, `grace_period_end_at=now()+1day` | ✅ Да |
| `customer.subscription.updated` | Синхронизация статуса | `status`, `current_period_end`, `cancel_at_period_end` | ✅ Да |
| `customer.subscription.deleted` | Статус → `limited_free_trial` | `status='limited_free_trial'` | ✅ Да |
| `invoice.payment_action_required` | Статус → `billing_problem` | `status='billing_problem'`, `grace_period_end_at` | ✅ Да |

---

## 6. Кэширование и синхронизация

### 6.1. Стратегия кэширования

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SubscriptionContextCache                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ get_context(          │
                        │   hardware_id)        │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Проверка кэша:         │
                        │ cache.get(hw_id)       │
                        │ TTL: 30 секунд         │
                        └───────────┬───────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────────┐      ┌───────────────────────┐
        │ Кэш есть и валиден     │      │ Кэш нет или истек     │
        │ → Возврат из кэша     │      │ → Запрос к БД          │
        └───────────────────────┘      └───────────┬───────────┘
                                                    │
                                                    ▼
                                        ┌───────────────────────┐
                                        │ Если нет записи:       │
                                        │ → Создание paid_trial │
                                        │   (14 дней)           │
                                        └───────────┬───────────┘
                                                    │
                                                    ▼
                                        ┌───────────────────────┐
                                        │ Формирование context:  │
                                        │ - status              │
                                        │ - days_left           │
                                        │ - trial_warning_info  │
                                        │ - quotas              │
                                        │ - subscription_info   │
                                        └───────────┬───────────┘
                                                    │
                                                    ▼
                                        ┌───────────────────────┐
                                        │ Сохранение в кэш:      │
                                        │ cache.set(hw_id, ctx,  │
                                        │   ttl=30)              │
                                        └───────────────────────┘
```

### 6.2. Инвалидация кэша

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Моменты инвалидации кэша                                  │
└─────────────────────────────────────────────────────────────────────────────┘

1. Webhook события (ПЕРЕД обновлением БД):
   ├─► checkout.session.completed
   ├─► invoice.payment_succeeded
   ├─► invoice.payment_failed
   ├─► customer.subscription.updated
   └─► customer.subscription.deleted

2. Выполнение команд подписки:
   ├─► create_subscription (после создания Checkout)
   ├─► cancel_subscription (после отмены)
   └─► update_payment_method (после Portal return)

3. Показ trial warning:
   └─► mark_trial_warning_shown() (после доставки LLM)

4. Админ-активация:
   └─► admin_activate_subscription() (после активации)

5. Периодическая синхронизация:
   └─► reconcile_with_stripe() (при подозрительных состояниях)
```

### 6.3. Синхронизация со Stripe

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Reconcile with Stripe                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Триггеры синхронизации:│
                        │ 1. Portal return       │
                        │ 2. Подозрительные      │
                        │    состояния          │
                        │ 3. Cron (опционально)  │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ retrieve_subscription()│
                        │ retrieve_customer()    │
                        │ retrieve_payment_      │
                        │ method()               │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Сравнение с БД:        │
                        │ - status               │
                        │ - current_period_end   │
                        │ - payment_method_id    │
                        │ - cancel_at_period_end │
                        └───────────┬───────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Если расхождение:       │
                        │ → Stripe побеждает      │
                        │ → Обновление БД         │
                        │ → Инвалидация кэша     │
                        └───────────────────────┘
```

---

## 7. Ключевые моменты реализации

### 7.1. Порядок операций (критично!)

```
⚠️ КРИТИЧНО: Всегда соблюдать порядок:

1. Получение контекста подписки (из кэша или БД)
2. Проверка квот (QuotaChecker)
3. Если лимит достигнут → блокировка запроса
4. Построение промпта для LLM (с контекстом подписки)
5. Обработка LLM
6. Парсинг ответа (возможна команда подписки)
7. Если команда → выполнение команды
8. Генерация аудио
9. Отправка ответа клиенту
```

### 7.2. Инвалидация кэша (критично!)

```
⚠️ КРИТИЧНО: Инвалидация кэша ПЕРЕД обновлением БД!

Правильный порядок:
1. Получение webhook события
2. Верификация подписи
3. Проверка идемпотентности
4. Инвалидация кэша ← ПЕРЕД обновлением БД!
5. Обновление БД
6. Логирование

Неправильный порядок (НЕ ДЕЛАТЬ):
1. Обновление БД
2. Инвалидация кэша ← ПОСЛЕ обновления БД (риск показать устаревший статус)
```

### 7.3. Безопасность

```
⚠️ КРИТИЧНО: Безопасность данных

1. hardware_id:
   - Только из gRPC запроса (НЕ из LLM ответа!)
   - Валидация формата (UUID)
   - Логирование только hardware_id[:8]

2. Webhook подписи:
   - Обязательная верификация Stripe-Signature
   - Replay protection (max age 300 сек)
   - При невалидной подписи → 400, ничего не менять в БД

3. LLM команды:
   - Валидация allowlist (только разрешенные команды)
   - Бизнес-проверки перед выполнением
   - Rate limiting (cooldown)
   - hardware_id НЕ из LLM, только из gRPC
```

---

## 9. Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ПОЛНАЯ АРХИТЕКТУРА                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
│   КЛИЕНТ (macOS)  │         │   СЕРВЕР (gRPC) │         │   STRIPE API     │
│                   │         │                  │         │                  │
│ ┌──────────────┐ │         │ ┌──────────────┐ │         │ ┌──────────────┐ │
│ │ Input        │ │         │ │ GrpcServer   │ │         │ │ Checkout      │ │
│ │ Processing   │ │────────▶│ │              │ │         │ │ Sessions      │ │
│ └──────────────┘ │         │ └──────┬───────┘ │         │ └──────────────┘ │
│                  │         │        │          │         │                  │
│ ┌──────────────┐ │         │        ▼          │         │ ┌──────────────┐ │
│ │ GrpcClient   │ │         │ ┌──────────────┐ │         │ │ Subscriptions│ │
│ │ Integration  │ │         │ │ Streaming    │ │         │ └──────────────┘ │
│ └──────────────┘ │         │ │ Workflow     │ │         │                  │
│                  │         │ └──────┬───────┘ │         │ ┌──────────────┐ │
│ ┌──────────────┐ │         │        │          │         │ │ Webhooks     │ │
│ │ Speech       │ │◀────────│        │          │         │ └──────┬───────┘ │
│ │ Playback     │ │         │        ▼          │         │        │         │
│ └──────────────┘ │         │ ┌──────────────┐ │         │        │         │
│                  │         │ │ Subscription │ │         │        │         │
│ ┌──────────────┐ │         │ │ ContextCache │ │         │        │         │
│ │ Browser      │ │         │ └──────┬───────┘ │         │        │         │
│ │ (Checkout)   │ │         │        │          │         │        │         │
│ └──────────────┘ │         │        ▼          │         │        │         │
│                  │         │ ┌──────────────┐ │         │        │         │
└──────────────────┘         │ │ QuotaChecker │ │         │        │         │
                              │ └──────┬───────┘ │         │        │         │
                              │        │          │         │        │         │
                              │        ▼          │         │        │         │
                              │ ┌──────────────┐ │         │        │         │
                              │ │ StripeModule │ │────────▶│        │         │
                              │ └──────┬───────┘ │         │        │         │
                              │        │          │         │        │         │
                              │        ▼          │         │        │         │
                              │ ┌──────────────┐ │         │        │         │
                              │ │ Subscription │ │         │        │         │
                              │ │ Command      │ │         │        │         │
                              │ │ Executor     │ │         │        │         │
                              │ └──────┬───────┘ │         │        │         │
                              │        │          │         │        │         │
                              │        ▼          │         │        │         │
                              │ ┌──────────────┐ │         │        │         │
                              │ │ Webhook      │ │◀────────┘         │         │
                              │ │ Handler      │ │                    │         │
                              │ └──────┬───────┘ │                    │         │
                              │        │          │                    │         │
                              │        ▼          │                    │         │
                              │ ┌──────────────┐ │                    │         │
                              │ │ PostgreSQL   │ │                    │         │
                              │ │ Database     │ │                    │         │
                              │ └──────────────┘ │                    │         │
                              │                  │                    │         │
                              │        ▼          │                    │         │
                              │ ┌──────────────┐ │                    │         │
                              │ │ AzureTTS     │ │                    │         │
                              │ │ Provider     │ │                    │         │
                              │ └──────┬───────┘ │                    │         │
                              │        │          │                    │         │
                              └────────┼──────────┘                    └─────────┘
                                       │
                                       │ audio_chunk (gRPC stream)
                                       ▼
                              ┌──────────────────┐
                              │   КЛИЕНТ (macOS) │
                              │                  │
                              │ ┌──────────────┐ │
                              │ │ Speech       │ │
                              │ │ Playback     │ │
                              │ │ Integration  │ │
                              │ └──────────────┘ │
                              └──────────────────┘
```

---

## 10. Итоговая схема состояний

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    State Machine (упрощенная визуализация)                   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │   НОВЫЙ      │
                    │ ПОЛЬЗОВАТЕЛЬ │
                    └──────┬───────┘
                           │
                           │ Первый запрос
                           ▼
                    ┌─────────────┐
                    │ paid_trial   │◀────────┐
                    │ (14 дней)    │          │
                    └──────┬───────┘          │
                           │                 │
        ┌──────────────────┼─────────────────┼──────────────┐
        │                  │                 │                │
        │ Trial истек      │ Подписка        │ Админ          │
        │                  │                 │ активация      │
        ▼                  ▼                 ▼                ▼
┌──────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ limited_free │  │    paid     │  │ admin_active│  │grandfathered│
│ _trial       │  │             │  │             │  │             │
│ (5/25/50)    │  │ (безлимит)  │  │ (безлимит)  │  │ (безлимит)  │
└──────┬───────┘  └──────┬──────┘  └─────────────┘  └─────────────┘
       │                 │
       │                 │ payment_failed
       │                 ▼
       │          ┌─────────────┐
       │          │ billing_   │
       │          │ problem    │
       │          │ (grace 1d)  │
       │          └──────┬──────┘
       │                 │
       │                 │ grace истек
       │                 ▼
       └─────────────────┘
```

---

## 10. Чеклист реализации

### 10.1. Серверная часть

- [ ] Создание таблиц БД (subscriptions, subscription_events, quota_usage, payments)
- [ ] Реализация SubscriptionContextCache
- [ ] Реализация QuotaChecker
- [ ] Реализация StripeModule
- [ ] Реализация SubscriptionCommandExecutor
- [ ] Интеграция в StreamingWorkflowIntegration
- [ ] Реализация webhook handler
- [ ] Верификация Stripe подписей
- [ ] Идемпотентность webhooks
- [ ] Инвалидация кэша
- [ ] Синхронизация со Stripe

### 10.2. Клиентская часть

- [ ] Обработка checkout_url (открытие браузера)
- [ ] Обработка deep links (nexy://payment/*)
- [ ] Интеграция с GrpcClientIntegration
- [ ] Обработка команд подписки в ответах

### 10.3. Тестирование

- [ ] Smoke tests (10 критичных сценариев)
- [ ] Тесты парсинга LLM JSON
- [ ] Тесты webhook обработки
- [ ] Тесты квот и лимитов
- [ ] E2E тесты подписки

---

**Статус:** ✅ Схема готова к использованию как golden source для реализации

**Следующий шаг:** Начать реализацию с Этапа 1 (Базовая инфраструктура) из `IMPLEMENTATION_PHASES.md` или `MVP_IMPLEMENTATION_PLAN.md`





























