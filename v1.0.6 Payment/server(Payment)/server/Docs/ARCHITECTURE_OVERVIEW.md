# üß≠ Nexy Server ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç ‚Äî –∫–∞–Ω–æ–Ω –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ Nexy. –û–Ω –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –æ—Å–µ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–æ–¥—É–ª–µ–π –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º. –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º–∏ –∫–∞–Ω–æ–Ω–∞–º–∏.

---

## 1. –û—Å–∏, –≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã

| –û—Å—å | Canon | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
| --- | --- | --- |
| gRPC –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª | `server/Docs/GRPC_PROTOCOL_AUDIT.md` | @grpc-core |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ AppCast | `server/Docs/UPDATE_SYSTEM_FIXES.md` | @release-ops |
| Backpressure –∏ –ª–∏–º–∏—Ç—ã | `server/Docs/BACKPRESSURE_README.md` | @reliability |
| Health/–Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å | `server/Docs/CI_GRPC_CHECKS.md` | @sre-duty |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | `server/config/unified_config.py` + `server/config/unified_config_example.yaml` | @server-platform |
| State Catalog | `server/Docs/STATE_CATALOG.md` | Tech Lead –∫–ª–∏–µ–Ω—Ç–∞ |

- –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç-–∫–∞–Ω–æ–Ω –Ω–∞ –æ—Å—å, –æ–¥–∏–Ω –≤–ª–∞–¥–µ–ª–µ—Ü. –°—Å—ã–ª–∫–∏ –≤ PR –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–∞–Ω–æ–Ω–∞.
- `.github/CODEOWNERS` –º–∞–ø–∏—Ç —ç—Ç–∏ –æ—Å–∏ –Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CI –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.
- `Docs/ADR_TEMPLATE.md` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π/–º–∞—Ç—Ä–∏—Ü/–ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–º–∏–∫—Ä–æ-ADR ‚â•7 —Å—Ç—Ä–æ–∫).

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ—ë–≤

```
server/
‚îú‚îÄ‚îÄ main.py                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ modules/                     # –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ grpc_service/            # gRPC —Å–µ—Ä–≤–µ—Ä, –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã, streaming.proto
‚îÇ   ‚îú‚îÄ‚îÄ audio_generation/
‚îÇ   ‚îú‚îÄ‚îÄ text_processing/
‚îÇ   ‚îú‚îÄ‚îÄ session_management/
‚îÇ   ‚îú‚îÄ‚îÄ memory_management/
‚îÇ   ‚îú‚îÄ‚îÄ interrupt_handling/
‚îÇ   ‚îú‚îÄ‚îÄ text_filtering/
‚îÇ   ‚îú‚îÄ‚îÄ database/                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ update/                  # –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ integrations/                # –û–±–≤—è–∑–∫–∞ –∏ orchestration
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ service_integrations/
‚îÇ   ‚îî‚îÄ‚îÄ workflow_integrations/
‚îú‚îÄ‚îÄ monitoring/                  # –ú–µ—Ç—Ä–∏–∫–∏ –∏ health-–ø—Ä–æ–≤–µ—Ä–∫–∏
‚îú‚îÄ‚îÄ scripts/                     # smoke/contract/–≥–≤–∞—Ä–¥—Ä–∞–π–ª—ã
‚îú‚îÄ‚îÄ tests/                       # unit/contract —Å—Ü–µ–Ω–∞—Ä–∏–∏
‚îú‚îÄ‚îÄ config/                      # unified_config + –ø—Ä–∏–º–µ—Ä
‚îú‚îÄ‚îÄ utils/                       # –£—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç—Ä–∏–∫–∏, —Ç–µ–∫—Å—Ç)
‚îú‚îÄ‚îÄ updates/                     # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (manifests, downloads, keys)
‚îú‚îÄ‚îÄ nginx/                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è ingress
‚îî‚îÄ‚îÄ Docs/                        # –ö–∞–Ω–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

- –ú–æ–¥—É–ª–∏ ‚â† –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚â† workflow: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∂–∏–≤—ë—Ç –≤ `server/modules/*`. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö –∏ workflow-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö.
- –ü—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã. –î–æ—Å—Ç—É–ø –∏–¥—ë—Ç —á–µ—Ä–µ–∑ `server/integrations/service_integrations/module_coordinator.py`.
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç `UniversalModuleInterface`. –ù–∞—Å–ª–µ–¥—É–µ–º—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –∞–¥–∞–ø—Ç–µ—Ä–∞–º–∏ (`modules/*/adapter.py`), –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–º–∏ –µ–¥–∏–Ω—ã–π `initialize/process/cleanup/status`.
- gRPC —Å–ª–æ–π –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é; —Å–≤—è–∑—å —á–µ—Ä–µ–∑ `GrpcServiceManager` ‚Üí `ModuleCoordinator`, –∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç `ModuleFactory`.
- Workflow-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (`streaming`, `memory`, `interrupt`) —Ä–∞–±–æ—Ç–∞—é—Ç —Å capability —á–µ—Ä–µ–∑ `module.process()`. –ó–∞–ø—Ä–æ—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö `get_processor()` –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π workaround –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ ADR + `Docs/SERVER_DEVELOPMENT_RULES.md`.
- –í—Å–µ –ø–æ—Ä—Ç—ã/–ª–∏–º–∏—Ç—ã/—Ç–∞–π–º–∞—É—Ç—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `unified_config`; –≤ –∫–æ–¥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ¬´–º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞¬ª.

---

## 3. –û—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ MCP –∫–æ–º–∞–Ω–¥—ã

### 3.1 –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (LLM):

**–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:**
- –¢–æ–ª—å–∫–æ –ø–æ–ª–µ `text` (—Å—Ç—Ä–æ–∫–∞ –¥–ª—è –æ–∑–≤—É—á–∫–∏)
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ: —Ç–µ–∫—Å—Ç –∏–¥—ë—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–µ—á–∏ (TTS) –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç—É

**Action-–æ—Ç–≤–µ—Ç (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π):**
```json
{
  "session_id": "<uuid>",
  "command": "open_app",
  "args": {
    "app_name": "Telegram"
  },
  "text": "–û—Ç–∫—Ä—ã–≤–∞—é Telegram, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —á—Ç–æ-—Ç–æ –µ—â—ë."
}
```

- `text` ‚Äî –∏–¥—ë—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–µ—á–∏/—Å—Ç—Ä–∏–º–∏–Ω–≥ (–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–∑–≤—É—á–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- JSON (`command` + `args` + `session_id`) ‚Äî –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `mcp.command_request`
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `command` –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º: —Ç–µ–∫—Å—Ç/–∞—É–¥–∏–æ –∏–¥—É—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞, MCP —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è

**–ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü–∞—Ä—Å–µ—Ä: `integrations/core/assistant_response_parser.py`
- –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ "–∫—Ä–∏–≤—ã–º" –¥–∞–Ω–Ω—ã–º: –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ JSON ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `text_response`, `command_payload=None`
- –ï—Å–ª–∏ JSON, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `text` ‚Äî –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (—á—Ç–æ–±—ã TTS –Ω–µ –ø–∞–¥–∞–ª)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (`session_id`, `app_name` –¥–ª—è `open_app`) –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—à–∏–±–æ–∫/–ª–æ–≥–æ–≤ –ø—Ä–∏ –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏

**–ü–µ—Ä–µ–¥–∞—á–∞ —á–µ—Ä–µ–∑ gRPC (–§–∞–∑–∞ 3):**
- `command_payload` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –∫–∞–∫ `text_chunk` —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `__MCP__`
- –§–æ—Ä–º–∞—Ç: `__MCP__{"event": "mcp.command_request", "payload": {...}}`
- –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–∞–Ω–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `__MCP__` –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å JSON –≤ EventBus –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ `mcp.command_request`
- –¢–µ–∫—Å—Ç –∏ –∞—É–¥–∏–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ –æ–±—ã—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –ü—Ä–µ—Ñ–∏–∫—Å –≤—ã–±—Ä–∞–Ω –¥–ª—è backward compatibility (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è proto)

**–§–∏—á–∞-—Ñ–ª–∞–≥:**
- `features.forward_assistant_actions` ‚Äî –≤–∫–ª—é—á–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É JSON –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`)
- Kill-switch: `kill_switches.disable_forward_assistant_actions` ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–ª–∏–∑–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: `Docs/MCP_COMMAND_INTEGRATION_PLAN.md`
- –†–µ—à–µ–Ω–∏—è –æ–± action –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (LLM), —Å–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç

---

## 4. gRPC –æ—Å—å

### 4.1 –ü—Ä–æ—Ç–æ–∫–æ–ª –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

- –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π proto-—Ñ–∞–π–ª: `server/modules/grpc_service/streaming.proto` (–Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö).
- –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Python-—Å—Ç–∞–±–æ–≤:
  ```bash
  cd server/modules/grpc_service
  python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. streaming.proto
  ```
- –õ—é–±–æ–µ breaking-–∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí –Ω–æ–≤—ã–π `StreamingServiceV2` + feature-flag + 2 —Ä–µ–ª–∏–∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–æ–ø–∏—Å–∞–Ω–æ –≤ `GRPC_PROTOCOL_AUDIT.md`).

### 4.2 –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å API

- RPC: `StreamAudio` (bidirectional stream), `InterruptSession` (unary-unary).
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ `Docs/GRPC_PROTOCOL_AUDIT.md`; CI (`Docs/CI_GRPC_CHECKS.md`) –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å –ø–æ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ proto –∏ smoke-—Ç–µ—Å—Ç–∞–º.
- –õ—é–±–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ –∫–∞–Ω–æ–Ω–µ.

### 4.3 Error Taxonomy

| error_type | gRPC code | –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ |
| --- | --- | --- |
| `timeout` | `DEADLINE_EXCEEDED` | Retry with backoff |
| `unavailable` | `UNAVAILABLE` | Retry exponential |
| `cancelled_by_user` | `CANCELLED` | Stop UX, no retry |
| `stream_limit_exceeded` | `RESOURCE_EXHAUSTED` | Backoff 60s ‚Üí retry |
| `rate_limit_exceeded` | `RESOURCE_EXHAUSTED` | Throttle locally ‚Üí retry |
| `validation_failed` | `INVALID_ARGUMENT` | Fix payload, no retry |
| `internal` | `INTERNAL` | Surface error, retry once |

### 4.4 LoggingInterceptor

- –§–∞–π–ª: `modules/grpc_service/core/grpc_interceptor.py`. –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç callables —á–µ—Ä–µ–∑ `_replace`, –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (`rpc_method_handler` ‚Äî namedtuple).
- –í –ª–æ–≥–∞—Ö –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç: `scope=grpc`, `method=/streaming.StreamingService/...`, `decision=start|abort|complete`, `ctx` —Å–æ —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.
- –û—à–∏–±–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `ErrorCodeMapper`; transient –æ—à–∏–±–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `decision=error`, `error_classified=transient`.
- –õ—é–±–æ–π –Ω–æ–≤—ã–π RPC –æ–±—è–∑–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ LoggingInterceptor. –í –æ–±—Ö–æ–¥–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è ADR + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `Docs/CI_GRPC_CHECKS.md`.

–¢–∞–±–ª–∏—Ü–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –≤ `server/modules/grpc_service/core/grpc_interceptor.py`. –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤—É—Ö –º–µ—Å—Ç.

---

## 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ñ–ª–∞–≥–∏

–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî `server/config/unified_config.py`. –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤ –ø—Ä–∏–º–µ—Ä–µ `unified_config_example.yaml`.

| –ö–ª—é—á | –¢–∏–ø | dev | stage | prod | Env override |
| --- | --- | --- | --- | --- | --- |
| `grpc.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `GRPC_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `grpc.port` | int | 50051 | 50051 | 50051 | `GRPC_PORT` |
| `grpc.max_workers` | int | 10 | ‚Äî (inherit prod) | 100 | `MAX_WORKERS` |
| `http.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `HTTP_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `http.port` | int | 8080 | 8080 | 8080 | `HTTP_PORT` |
| `backpressure.max_concurrent_streams` | int | 10 | 25 | 50 | `BACKPRESSURE_MAX_STREAMS` |
| `backpressure.max_message_rate_per_second` | int | 5 | 8 | 10 | `BACKPRESSURE_MAX_RATE` |
| `backpressure.idle_timeout_seconds` | int | 60 | 180 | 300 | `BACKPRESSURE_IDLE_TIMEOUT` |
| `features.use_module_coordinator` | bool | true | true | true | `USE_MODULE_COORDINATOR` |
| `kill_switches.disable_module_coordinator` | bool | false | false | false | `NEXY_KS_DISABLE_MODULE_COORDINATOR` |
| `update.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `UPDATE_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `update.port` | int | 8081 | 8081 | 8081 | `UPDATE_PORT` |

> Stage –Ω–∞—Å–ª–µ–¥—É–µ—Ç prod –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è `grpc.host`/`http.host`/`update.host` –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è `NEXY_ENV`: dev ‚Üí `0.0.0.0` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, stage/prod ‚Üí `127.0.0.1` (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ Nginx –Ω–∞ 443). –ó–Ω–∞—á–µ–Ω–∏–µ `auto` –≤ `config.env` –æ–∑–Ω–∞—á–∞–µ—Ç ¬´–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç –ø–æ –æ–∫—Ä—É–∂–µ–Ω–∏—é¬ª. –í—Å–µ overrides –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ unified_config + env, –ø—Ä—è–º—ã—Ö setdefault –≤ –∫–æ–¥–µ –Ω–µ—Ç.

Backpressure –ª–∏–º–∏—Ç—ã, error-–∫–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—Ç–ª–∞–¥–∫–µ ‚Äî –≤ `Docs/BACKPRESSURE_README.md`.

---

## 6. –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ fail-fast

- **Decision-–ª–æ–≥–∏**: —Ñ–æ—Ä–º–∞—Ç `ts=<iso> level=<lvl> scope=<module> method=<rpc> decision=<event> ctx=<json> dur_ms=<int>`. –õ–æ–≥–∏ –±–µ–∑ `decision` —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∫–∞–Ω–æ–Ω–∞.
- **–ú–µ—Ç—Ä–∏–∫–∏ (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 60s)**:
  - `p95_latency_ms{rpc}`
  - `error_rate{rpc}`
  - `backpressure_refusal_rate`
  - `decision_rate{type}`
- **–ì–≤–∞—Ä–¥—Ä–∞–π–ª—ã CI** (`Docs/CI_GRPC_CHECKS.md`):
  - regen proto ‚Üí diff –∑–∞–ø—Ä–µ—Ç–æ–≤
  - smoke-—Ç–µ—Å—Ç—ã (`python scripts/grpc_smoke.py --host 127.0.0.1 --port 50051`)
  - health/–ø–æ—Ä—Ç/–≤–µ—Ä—Å–∏—è (`python scripts/check_grpc_health.py`)
  - Cache-Control –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`curl -I https://<host>/appcast.xml | grep 'Cache-Control'`)
  - validate release size (`scripts/validate_updates.sh`)

---

## 7. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å, ingress –∏ shutdown

- **Ingress**: –æ–¥–∏–Ω –ø—É–±–ª–∏—á–Ω—ã–π –≤—Ö–æ–¥ ‚Äî HTTPS:443 —á–µ—Ä–µ–∑ Nginx (`/etc/nginx/sites-available/nexy`). –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ `127.0.0.1:50051`, `127.0.0.1:8080`, `127.0.0.1:8081` —Å–ª—É—à–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ localhost –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ.
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ—Å—Ç—É–ø–∞:**
  - –ü—É–±–ª–∏—á–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ prod: `https://20.151.51.172` (IP –∑–∞–∫—Ä–µ–ø–ª—ë–Ω –∑–∞ Nexy Server –≤ Azure)
  - –ó–Ω–∞—á–µ–Ω–∏–µ `NEXY_ENV=prod` –∏–ª–∏ `stage` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ä–µ–∂–∏–º `127.0.0.1`. –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ (`NEXY_ENV=dev`) —Ö–æ—Å—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.0.0.0`.
  - –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø: —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Nginx –Ω–∞ –ø–æ—Ä—Ç—É 443 (HTTPS, HTTP/2)
  - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã: 8080 (HTTP health/status), 50051 (gRPC), 8081 (Update Server) ‚Äî —Ç–æ–ª—å–∫–æ localhost
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/health` ‚Üí `http://127.0.0.1:8080/health`
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/status` ‚Üí `http://127.0.0.1:8080/status`
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/` (gRPC) ‚Üí `grpc://127.0.0.1:50051`
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx (–∫—Ä–∏—Ç–∏—á–Ω–æ):**
  - `location /health` –∏ `/status` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–ø–µ—Ä–µ–¥** `location /`
  - –ò–Ω–∞—á–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ø–∞–¥—É—Ç –≤ gRPC –ø—Ä–æ–∫—Å–∏ –≤–º–µ—Å—Ç–æ HTTP –ø—Ä–æ–∫—Å–∏, —á—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É 502 Bad Gateway
  - –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: `Docs/SERVER_DEPLOYMENT_GUIDE.md` –∏ `Docs/TROUBLESHOOTING_502.md`
- **Cache-Control**: `/appcast.xml` ‚Äî `max-age=60`, `/updates/health` ‚Äî `max-age=30`, `/health` ‚Äî `max-age=30`. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é (curl) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ `server/scripts/verify_cache_control_headers.py`.
- **Backpressure**: –æ—à–∏–±–∫–∏ `stream_limit_exceeded`/`rate_limit_exceeded` –º–∞–ø—è—Ç—Å—è –Ω–∞ `RESOURCE_EXHAUSTED` (—Å–º. —Ç–∞–±–ª–∏—Ü—É). –õ–∏–º–∏—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ unified_config.
- **Graceful shutdown**: –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º SIGTERM/SIGINT, –∂–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö RPC ‚â§5s, –ø–µ—á–∞—Ç–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–≥—Ä–µ–≥–∞—Ç –º–µ—Ç—Ä–∏–∫. –ù–∞—Ä—É—à–µ–Ω–∏–µ ‚Äî –±–ª–æ–∫–µ—Ä –¥–ª—è —Ä–µ–ª–∏–∑–∞.
- **–ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** –≤ `StreamAudio`: IO —á–µ—Ä–µ–∑ async-–æ–±—ë—Ä—Ç–∫–∏, CPU ‚Äî threadpool —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º concurrency –∏–∑ unified_config.
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2 –æ–∫—Ç—è–±—Ä—è 2025):**
  - –ò–º–ø–æ—Ä—Ç `get_config` –≤ `grpc_server.py`: –¥–æ–±–∞–≤–ª–µ–Ω `from config.unified_config import get_config`
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ `PermissionError` –≤ `update/config.py`: Update Server –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
  - –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: `Docs/CHANGELOG_SERVER_FIXES.md` –∏ `Docs/REMOTE_SERVER_SPECIFICS.md`

---

## 8. –†–æ–ª–ª–∞—É—Ç –∏ ¬´–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å¬ª

- Feature-flag first: –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ >2 –æ—Å–µ–π ‚Äî –ø–æ–¥ —Ñ–ª–∞–≥ + kill-switch + –∫–∞–Ω–∞—Ä–µ–µ—á–Ω—ã–π –ø–ª–∞–Ω (1% ‚Üí 25% ‚Üí 50% ‚Üí 100%).
- SIMPLE-–≥–µ–π—Ç ‚â§60 LOC/1 —Ñ–∞–π–ª + 2 —Ç–µ—Å—Ç–∞. Impact-–≥–µ–π—Ç —Ç—Ä–µ–±—É–µ—Ç `change_impact.yaml`, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `STATE_CATALOG`, 8‚Äì14 pairwise —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã.
- ¬´–ì–æ—Ç–æ–≤–æ¬ª = —á–µ–∫–ª–∏—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, SLO –≤ –Ω–æ—Ä–º–µ (`p95_latency_ms(StreamAudio) ‚â§ 1000`, `error_rate(StreamAudio) ‚â§ 5%`), –º–µ—Ç—Ä–∏–∫–∏ –≤ dashboards.
- Canary guardrails: jq one-liners –∏–∑ `scripts/` (–æ—à–∏–±–∫–∏/—Ä–µ—à–µ–Ω–∏—è/latency) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏.

---

## 9. –°—Å—ã–ª–∫–∏

- `Docs/SERVER_DEVELOPMENT_RULES.md` ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–µ –≥–µ–π—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `Docs/SERVER_DEPLOYMENT_GUIDE.md` ‚Äî –¥–µ–ø–ª–æ–π, HTTPS ingress, smoke-–ø—Ä–æ–≤–µ—Ä–∫–∏
- `Docs/BACKPRESSURE_README.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –æ—Ç–ª–∞–¥–∫–∞
- `Docs/STATE_CATALOG.md` ‚Äî –∫–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã
- `Docs/CI_GRPC_CHECKS.md` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ CI-—Å—Ç–∞–¥–∏–∏
- `Docs/TROUBLESHOOTING_502.md` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã 502 Bad Gateway –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
