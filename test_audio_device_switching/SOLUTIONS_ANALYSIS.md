# –ê–Ω–∞–ª–∏–∑ —Ä–µ—à–µ–Ω–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ macOS

## üìä –¢–æ–ø-5 —Ä–µ—à–µ–Ω–∏–π (–æ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–≥–æ –∫ –Ω–∞–∏–º–µ–Ω–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–º—É)

### –†–µ—à–µ–Ω–∏–µ 1: Core Audio Notifications (—Å–æ–±—ã—Ç–∏–π–Ω—ã–π –ø–æ–¥—Ö–æ–¥) ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2-3 –¥–Ω—è  
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞:** 95%

#### –û–ø–∏—Å–∞–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Core Audio Property Listeners —á–µ—Ä–µ–∑ PyObjC –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è default input/output —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ polling)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)
- ‚úÖ –ù–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ macOS (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (BT, USB, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ)

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç PyObjC (—É–∂–µ –µ—Å—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ)
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö macOS (fallback –Ω–∞ polling)

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```python
# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Core Audio
AudioObjectAddPropertyListener(
    kAudioObjectSystemObject,
    AudioObjectPropertyAddress(
        kAudioHardwarePropertyDefaultInputDevice,  # –∏–ª–∏ DefaultOutputDevice
        kAudioObjectPropertyScopeGlobal,
        kAudioObjectPropertyElementMain
    ),
    callback_function,
    None
)
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Speech Recognizer:
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ ‚Üí –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å –Ω–æ–≤—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `device_id=None` –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç)
- –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2-3 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)

#### –†–∏—Å–∫–∏:
- **–ù–∏–∑–∫–∏–π:** Callback –º–æ–∂–µ—Ç –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö macOS ‚Üí fallback –Ω–∞ polling
- **–°—Ä–µ–¥–Ω–∏–π:** –ù—É–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å EventBus (async callback)

---

### –†–µ—à–µ–Ω–∏–µ 2: AVAudioSession Route Change (–∫–∞–∫ –≤ iOS/macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö) ‚≠ê‚≠ê‚≠ê‚≠ê

**–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 3-4 –¥–Ω—è  
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞:** 85%

#### –û–ø–∏—Å–∞–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AVAudioSession (—á–µ—Ä–µ–∑ PyObjC) –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –∞—É–¥–∏–æ (`AVAudioSessionRouteChangeNotification`).

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API (–ø—Ä–æ—â–µ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏—á–∏–Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Telegram/WhatsApp –Ω–∞ iOS (–∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –Ω–∞ macOS)

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ö†Ô∏è AVAudioSession –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö macOS
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–∏
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å PortAudio (–Ω—É–∂–Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è)

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```python
# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Route Change Notification
from AVFoundation import AVAudioSession, AVAudioSessionRouteChangeNotification

session = AVAudioSession.sharedInstance()
session.setCategory_withOptions_error_(AVAudioSessionCategoryPlayAndRecord, ...)

# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
NSNotificationCenter.defaultCenter().addObserver_selector_name_object_(
    self,
    self._on_route_change,
    AVAudioSessionRouteChangeNotification,
    None
)
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Speech Recognizer:
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç ‚Üí –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—á–∏–Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏)

#### –†–∏—Å–∫–∏:
- **–°—Ä–µ–¥–Ω–∏–π:** AVAudioSession –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö macOS ‚Üí fallback –Ω–∞ Core Audio Notifications
- **–°—Ä–µ–¥–Ω–∏–π:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å PortAudio (–æ–±–∞ –ø—ã—Ç–∞—é—Ç—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º) ‚Üí –Ω—É–∂–Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è

---

### –†–µ—à–µ–Ω–∏–µ 3: Hybrid Monitoring (Core Audio + Polling —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff) ‚≠ê‚≠ê‚≠ê‚≠ê

**–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –ü—Ä–æ—Å—Ç–æ–π  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 1-2 –¥–Ω—è  
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞:** 90%

#### –û–ø–∏—Å–∞–Ω–∏–µ:
–ö–æ–º–±–∏–Ω–∞—Ü–∏—è Core Audio Notifications (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º) + Polling —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff (fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç).

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (–¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU (polling —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ Core Audio Notifications –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (—É–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞)

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ö†Ô∏è –í—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polling (—Ö–æ—Ç—è –∏ —Ä–µ–∂–µ)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º (–¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞)

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```python
# –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º: Core Audio Notifications
core_audio_manager.start_device_notifications(callback, device_type="input")

# Fallback: Polling —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
poll_interval = 0.5  # –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
max_interval = 5.0   # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
backoff_factor = 1.5  # –§–∞–∫—Ç–æ—Ä —É–≤–µ–ª–∏—á–µ–Ω–∏—è

while not stop_event.is_set():
    check_device_change()
    if device_changed:
        poll_interval = 0.5  # –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
    else:
        poll_interval = min(poll_interval * backoff_factor, max_interval)
    time.sleep(poll_interval)
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Speech Recognizer:
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç Core Audio Notifications ‚Üí –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, fallback –Ω–∞ polling
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ CPU

#### –†–∏—Å–∫–∏:
- **–ù–∏–∑–∫–∏–π:** –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å (–¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞) ‚Üí –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
- **–ù–∏–∑–∫–∏–π:** –í—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polling ‚Üí –Ω–æ —Ä–µ–∂–µ, —á–µ–º —Å–µ–π—á–∞—Å

---

### –†–µ—à–µ–Ω–∏–µ 4: Device State Machine (FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏) ‚≠ê‚≠ê‚≠ê

**–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°–ª–æ–∂–Ω—ã–π  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 5-7 –¥–Ω–µ–π  
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞:** 80%

#### –û–ø–∏—Å–∞–Ω–∏–µ:
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∞ (FSM) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏: IDLE, SWITCHING, RETRY, ERROR, SUCCESS.

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ß–µ—Ç–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π (–ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫–∏
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–Ω–µ—Ç race conditions)
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å (–Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è/–ø–µ—Ä–µ—Ö–æ–¥—ã)

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–Ω—É–∂–Ω–∞ FSM –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```python
# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class DeviceState(Enum):
    IDLE = "idle"
    SWITCHING = "switching"
    RETRY = "retry"
    ERROR = "error"
    SUCCESS = "success"

# –ü–µ—Ä–µ—Ö–æ–¥—ã
transitions = [
    (DeviceState.IDLE, "device_changed", DeviceState.SWITCHING),
    (DeviceState.SWITCHING, "switch_success", DeviceState.SUCCESS),
    (DeviceState.SWITCHING, "switch_error", DeviceState.RETRY),
    (DeviceState.RETRY, "retry_success", DeviceState.SUCCESS),
    (DeviceState.RETRY, "retry_failed", DeviceState.ERROR),
    (DeviceState.SUCCESS, "reset", DeviceState.IDLE),
    (DeviceState.ERROR, "reset", DeviceState.IDLE),
]
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Speech Recognizer:
- FSM —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ SpeechRecognizer
- Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ PortAudio —á–µ—Ä–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è ERROR –∏ RETRY

#### –†–∏—Å–∫–∏:
- **–°—Ä–µ–¥–Ω–∏–π:** –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º
- **–°—Ä–µ–¥–Ω–∏–π:** –ù—É–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å EventBus ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–æ

---

### –†–µ—à–µ–Ω–∏–µ 5: PortAudio Device Refresh + Retry Logic (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–µ–∫—É—â–µ–≥–æ) ‚≠ê‚≠ê‚≠ê

**–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –ü—Ä–æ—Å—Ç–æ–π  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 1-2 –¥–Ω—è  
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞:** 70%

#### –û–ø–∏—Å–∞–Ω–∏–µ:
–£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫—ç—à–∞ PortAudio –∏ retry –ª–æ–≥–∏–∫–æ–π.

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ö†Ô∏è –í—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polling (–∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –Ω–µ —Ä–µ—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã (–æ—Å–æ–±–µ–Ω–Ω–æ —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏)
- ‚ö†Ô∏è –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è macOS

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```python
# –£–ª—É—á—à–µ–Ω–∏—è:
# 1. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
if is_bluetooth_device(device_name):
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å device_id=None –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    device_id = None
    # –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (2-3 —Å–µ–∫)
    await asyncio.sleep(2.5)

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ PortAudio
sd.query_devices.clear_cache()  # –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
# –ò–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
_ = sd.query_devices()

# 3. Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
max_retries = 3
for attempt in range(max_retries):
    try:
        create_stream(device_id)
        break
    except PortAudioError as e:
        if attempt < max_retries - 1:
            delay = 0.3 * (2 ** attempt)  # 0.3, 0.6, 1.2
            await asyncio.sleep(delay)
        else:
            raise
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Speech Recognizer:
- –£–ª—É—á—à–∏—Ç—å `_get_system_default_input_index()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π BT
- –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `device_id=None` –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

#### –†–∏—Å–∫–∏:
- **–í—ã—Å–æ–∫–∏–π:** –ú–æ–∂–µ—Ç –Ω–µ —Ä–µ—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã (–æ—Å–æ–±–µ–Ω–Ω–æ —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏)
- **–°—Ä–µ–¥–Ω–∏–π:** –í—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polling ‚Üí –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å —ç—Ç–æ–≥–æ):
**–†–µ—à–µ–Ω–∏–µ 1: Core Audio Notifications** - –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é —É—Å–ø–µ—Ö–∞ (95%) –∏ —Å—Ä–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (2-3 –¥–Ω—è).

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–µ—Å–ª–∏ –†–µ—à–µ–Ω–∏–µ 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç):
**–†–µ—à–µ–Ω–∏–µ 3: Hybrid Monitoring** - –Ω–∞–¥–µ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –¥–≤—É–º—è –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏ –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π (1-2 –¥–Ω—è).

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏):
**–†–µ—à–µ–Ω–∏–µ 2: AVAudioSession Route Change** - –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è (3-4 –¥–Ω—è).

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4 (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤):
**–†–µ—à–µ–Ω–∏–µ 4: Device State Machine** - –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ retry (5-7 –¥–Ω–µ–π).

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5 (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è):
**–†–µ—à–µ–Ω–∏–µ 5: PortAudio Device Refresh** - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç (1-2 –¥–Ω—è, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ —Ä–µ—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã).

---

## üìù –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –†–µ—à–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞ | CPU –Ω–∞–≥—Ä—É–∑–∫–∞ | –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è |
|---------|-----------|-------|-------------------|--------------|----------------------|
| 1. Core Audio Notifications | –°—Ä–µ–¥–Ω–∏–π | 2-3 –¥–Ω—è | 95% | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | < 100ms |
| 2. AVAudioSession Route Change | –°—Ä–µ–¥–Ω–∏–π | 3-4 –¥–Ω—è | 85% | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | < 100ms |
| 3. Hybrid Monitoring | –ü—Ä–æ—Å—Ç–æ–π | 1-2 –¥–Ω—è | 90% | –ù–∏–∑–∫–∞—è | < 500ms |
| 4. Device State Machine | –°–ª–æ–∂–Ω—ã–π | 5-7 –¥–Ω–µ–π | 80% | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | < 200ms |
| 5. PortAudio Refresh | –ü—Ä–æ—Å—Ç–æ–π | 1-2 –¥–Ω—è | 70% | –°—Ä–µ–¥–Ω—è—è | < 1 —Å–µ–∫ |

---

## üîß –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Speech Recognizer

### –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π:
1. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞** —Å –Ω–æ–≤—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `device_id=None`** –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç)
4. **Retry –ª–æ–≥–∏–∫–∞** –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2-3 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
5. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å EventBus** –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

### –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **–†–µ—à–µ–Ω–∏–µ 1, 2, 3:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async callback –¥–ª—è EventBus
- **–†–µ—à–µ–Ω–∏–µ 4:** FSM —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–†–µ—à–µ–Ω–∏–µ 5:** –£–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π BT

---

## üöÄ –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ù–µ–¥–µ–ª—è 1:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –†–µ—à–µ–Ω–∏—è 1 (Core Audio Notifications) + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–ù–µ–¥–µ–ª—è 2:** –ï—Å–ª–∏ –†–µ—à–µ–Ω–∏–µ 1 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –†–µ—à–µ–Ω–∏–µ 3 (Hybrid Monitoring) + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–ù–µ–¥–µ–ª—è 3:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –≤ production –∫–æ–¥
4. **–ù–µ–¥–µ–ª—è 4:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
