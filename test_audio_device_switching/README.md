# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ macOS

## üéØ –¶–µ–ª—å

–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤ (input/output) –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞—É—à–Ω–∏–∫–æ–≤, Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –¥—Ä—É–≥–∏—Ö –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ macOS.

## üìã –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (INPUT)** - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ AirPods –¥–∞–∂–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. **–û—à–∏–±–∫–∏ PortAudio –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** (-9986, -10851) - –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞
3. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –Ω–∞—É—à–Ω–∏–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (OUTPUT)** - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
4. **–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –º–µ–∂–¥—É macOS API (SwitchAudioSource) –∏ PortAudio

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling (–∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫) –≤–º–µ—Å—Ç–æ —Å–æ–±—ã—Ç–∏–π Core Audio
- Google Speech Recognizer (speech_recognition) –º–æ–∂–µ—Ç –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –Ω—É–∂–Ω–æ 2-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é CoreAudio pipeline
- Device ID –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, –Ω–æ –∏–º—è –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ

## üîç –ê–Ω–∞–ª–∏–∑ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫

### Telegram/WhatsApp –ø–æ–¥—Ö–æ–¥—ã:
1. **AVAudioSession Route Change Notifications** - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
2. **Core Audio Property Listeners** - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ PyObjC
3. **Hybrid –ø–æ–¥—Ö–æ–¥** - —Å–æ–±—ã—Ç–∏—è + polling —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
4. **Device State Machine** - FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏ —Å retry –ª–æ–≥–∏–∫–æ–π
5. **PortAudio Refresh + Retry** - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π BT

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
- `solution_1_core_audio_notifications/` - Core Audio Notifications (—Å–æ–±—ã—Ç–∏–π–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- `solution_2_avsession_route_change/` - AVAudioSession Route Change (–∫–∞–∫ –≤ iOS/macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö)
- `solution_3_hybrid_monitoring/` - Hybrid Monitoring (Core Audio + Polling)
- `solution_4_device_fsm/` - Device State Machine (FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏)
- `solution_5_portaudio_refresh/` - PortAudio Device Refresh + Retry Logic

## üß™ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí AirPods ‚Üí USB –º–∏–∫—Ä–æ—Ñ–æ–Ω)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–∏–Ω–∞–º–∏–∫–∏ ‚Üí AirPods ‚Üí USB –Ω–∞—É—à–Ω–∏–∫–∏)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (AirPods, Beats, –¥—Ä—É–≥–∏–µ BT –Ω–∞—É—à–Ω–∏–∫–∏)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (USB –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã, USB –Ω–∞—É—à–Ω–∏–∫–∏)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω, –¥–∏–Ω–∞–º–∏–∫–∏)

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ PortAudio (-9986, -10851) –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- ‚úÖ –ù–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É macOS API –∏ PortAudio
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2-3 —Å–µ–∫)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è Device ID –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (< 500ms –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, < 3 —Å–µ–∫ –¥–ª—è BT)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU (–Ω–µ polling –∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Google Speech Recognizer (speech_recognition)
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (EventBus, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ production –∫–æ–¥

## üìä –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç**: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ INPUT/OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ macOS System Preferences
2. **Bluetooth —Ç–µ—Å—Ç**: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ AirPods –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **USB —Ç–µ—Å—Ç**: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ USB –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞/–Ω–∞—É—à–Ω–∏–∫–æ–≤
4. **–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç**: –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç**: –†–∞–±–æ—Ç–∞ —Å Google Speech Recognizer –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –∞—É–¥–∏–æ

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –¢–µ—Å—Ç —Ä–µ—à–µ–Ω–∏—è 1
python test_audio_device_switching/solution_1_core_audio_notifications/test_solution_1.py

# –¢–µ—Å—Ç —Ä–µ—à–µ–Ω–∏—è 2
python test_audio_device_switching/solution_2_avsession_route_change/test_solution_2.py

# –¢–µ—Å—Ç —Ä–µ—à–µ–Ω–∏—è 3
python test_audio_device_switching/solution_3_hybrid_monitoring/test_solution_3.py

# –¢–µ—Å—Ç —Ä–µ—à–µ–Ω–∏—è 4
python test_audio_device_switching/solution_4_device_fsm/test_solution_4.py

# –¢–µ—Å—Ç —Ä–µ—à–µ–Ω–∏—è 5
python test_audio_device_switching/solution_5_portaudio_refresh/test_solution_5.py
```

## üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª–µ `RESULTS.md` –≤ –∫–∞–∂–¥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏—è.
