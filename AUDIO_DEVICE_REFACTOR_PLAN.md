# План замены AudioDeviceManager на подход с системными дефолтами

## Анализ текущей архитектуры

### Что у нас есть сейчас:
1. **AudioDeviceManager** - сложный модуль с автоматическим переключением устройств
2. **SwitchAudioBridge** - обертка над SwitchAudioSource для переключения устройств
3. **DeviceMonitor** - мониторинг подключения/отключения устройств
4. **DeviceSwitcher** - логика автоматического переключения
5. **AudioDeviceIntegration** - интеграция с EventBus

### Что работает в новом подходе:
1. **Системные дефолты macOS** - использование `device=None` в sounddevice
2. **Автоматическое следование** - приложение следует настройкам пользователя
3. **Простота** - нет сложной логики переключения устройств

## План замены

### Этап 1: Создание нового модуля DefaultAudioManager

**Создать:** `modules/default_audio_manager/`

```
modules/default_audio_manager/
├── __init__.py
├── core/
│   ├── __init__.py
│   ├── default_audio_manager.py    # Основной класс
│   ├── types.py                    # Типы данных
│   └── health_checker.py          # Проверка здоровья микрофона
├── config/
│   ├── __init__.py
│   └── default_config.py          # Конфигурация
└── README.md
```

**Основные компоненты:**
- `DefaultAudioManager` - основной класс
- `HealthChecker` - проверка RMS микрофона
- `DefaultAudioConfig` - конфигурация
- `AudioStreamManager` - управление потоками

### Этап 2: Создание новой интеграции

**Создать:** `integration/integrations/default_audio_integration.py`

**Функции:**
- Запуск/остановка потоков с системными дефолтами
- Мониторинг здоровья микрофона
- Публикация событий о состоянии аудио
- Обработка ошибок и переоткрытие потоков

### Этап 3: Обновление SpeechRecognizer

**Изменить:** `modules/voice_recognition/core/speech_recognizer.py`

**Изменения:**
- Убрать `device_index` - использовать `device=None`
- Убрать логику выбора устройств
- Упростить инициализацию потоков
- Добавить автоматическое переоткрытие при ошибках

### Этап 4: Обновление SpeechPlayback

**Изменить:** `modules/speech_playback/core/sequential_speech_player.py`

**Изменения:**
- Убрать `device_index` - использовать `device=None`
- Упростить инициализацию потоков

### Этап 5: Обновление конфигурации

**Изменить:** `config/unified_config.yaml`

**Изменения:**
- Убрать секцию `audio.device_manager`
- Добавить секцию `default_audio` с настройками:
  ```yaml
  default_audio:
    input_sample_rate: 16000
    output_sample_rate: 48000
    health_check_interval: 1.0
    rms_threshold: 1e-4
    auto_reopen_on_error: true
  ```

### Этап 6: Обновление SimpleModuleCoordinator

**Изменить:** `integration/core/simple_module_coordinator.py`

**Изменения:**
- Заменить `AudioDeviceIntegration` на `DefaultAudioIntegration`
- Убрать инициализацию `AudioDeviceManager`

## Что удалить

### Полностью удалить:
1. `modules/audio_device_manager/` - весь модуль
2. `integration/integrations/audio_device_integration.py`
3. Все тесты связанные с AudioDeviceManager
4. Конфигурацию `audio.device_manager` из `unified_config.yaml`

### Частично удалить:
1. Из `SpeechRecognizer`:
   - `_pick_input_device()`
   - `set_default_input_device()`
   - `get_available_devices()`
   - Логику выбора устройств

2. Из `SpeechPlayback`:
   - Логику выбора output устройств
   - `device_index` параметры

## Что оставить

### Оставить без изменений:
1. **EventBus** - система событий остается
2. **ApplicationStateManager** - управление состояниями
3. **ErrorHandler** - обработка ошибок
4. **Основная архитектура** - интеграции, workflows

### Адаптировать:
1. **События** - заменить события аудио устройств на события состояния аудио
2. **Логирование** - адаптировать под новый подход
3. **Конфигурация** - упростить конфигурацию

## Новые события

### Заменить события:
```python
# Старые события (удалить)
audio.device_connected
audio.device_disconnected
audio.device_switched
audio.input_device_selected
audio.output_device_selected

# Новые события (добавить)
audio.stream_started
audio.stream_stopped
audio.stream_error
audio.health_check
audio.microphone_active
audio.microphone_silent
```

## Миграция данных

### Конфигурация:
- Удалить `audio.device_manager` секцию
- Добавить `default_audio` секцию
- Сохранить `stt` секцию (она нужна для SpeechRecognizer)

### Состояние:
- Убрать состояние выбранных устройств
- Добавить состояние здоровья аудио потоков

## Тестирование

### Сценарии тестирования:
1. **Базовый тест** - встроенный микрофон + динамики
2. **AirPods тест** - подключение/отключение AirPods
3. **USB микрофон** - внешний микрофон
4. **HDMI монитор** - внешний вывод
5. **Ошибки** - отключение микрофона, TCC ошибки
6. **Переоткрытие** - автоматическое восстановление потоков

### Тестовые файлы:
- `test_default_audio_integration.py`
- `test_speech_recognition_default.py`
- `test_speech_playback_default.py`

## Риски и митигация

### Риски:
1. **Потеря функциональности** - пользователи не смогут программно переключать устройства
2. **Совместимость** - изменения в SpeechRecognizer могут сломать существующий код
3. **Производительность** - постоянные health checks могут влиять на производительность

### Митигация:
1. **Документация** - четкие инструкции для пользователей по настройке устройств
2. **Постепенная миграция** - сначала тестирование, потом полная замена
3. **Fallback** - возможность вернуться к старому подходу при проблемах
4. **Оптимизация** - настраиваемые интервалы health checks

## Временной план

### День 1: Подготовка
- Создание нового модуля `DefaultAudioManager`
- Создание новой интеграции
- Базовое тестирование

### День 2: Интеграция
- Обновление `SpeechRecognizer`
- Обновление `SpeechPlayback`
- Обновление конфигурации

### День 3: Тестирование
- Полное тестирование всех сценариев
- Исправление найденных проблем
- Документация

### День 4: Миграция
- Удаление старого кода
- Обновление `SimpleModuleCoordinator`
- Финальное тестирование

## Критерии успеха

1. **Функциональность** - все аудио функции работают
2. **Простота** - код стал проще и понятнее
3. **Надежность** - меньше ошибок и сбоев
4. **Производительность** - нет деградации производительности
5. **Совместимость** - существующие функции не сломаны

## Откат

### План отката:
1. Сохранить текущий код в отдельной ветке
2. Создать скрипт для быстрого отката
3. Документировать все изменения
4. Подготовить инструкции по восстановлению

### Критерии отката:
- Критические ошибки в аудио
- Потеря функциональности
- Проблемы с производительностью
- Несовместимость с существующим кодом
