#!/bin/bash

cat << 'EOF'

╔══════════════════════════════════════════════════════════════════════════╗
║         🧪 ТЕСТ НОВОЙ СБОРКИ С КРИТИЧЕСКИМИ РАЗРЕШЕНИЯМИ                 ║
╚══════════════════════════════════════════════════════════════════════════╝

EOF

echo "1️⃣  Останавливаем приложение..."
pkill -9 Nexy 2>/dev/null || true
sleep 2
echo "   ✅ Готово"
echo ""

echo "2️⃣  Проверяем дату установленного приложения..."
INSTALLED_DATE=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" /Applications/Nexy.app 2>/dev/null)
PKG_DATE=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$(dirname "$0")/dist/Nexy.pkg" 2>/dev/null)

echo "   Установлено: $INSTALLED_DATE"
echo "   PKG собран:  $PKG_DATE"
echo ""

if [ "$INSTALLED_DATE" \< "2025-10-11 15:56" ]; then
    echo "⚠️  ВНИМАНИЕ: Установлена СТАРАЯ версия!"
    echo ""
    echo "Для установки новой версии выполните:"
    echo "   sudo installer -pkg $(dirname "$0")/dist/Nexy.pkg -target /"
    echo ""
    exit 1
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3️⃣  Запускаем приложение и проверяем логи..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "🔍 Ожидаем в логах:"
echo "   ✅ 🚫 Блокировка приложения - отсутствуют критичные разрешения"
echo "   ✅ 🔐 Запускаем запрос разрешений..."
echo "   ✅ IOHIDCheckAccess результат (ctypes): True"
echo ""
echo "❌ НЕ должно быть:"
echo "   ❌ Разблокировка приложения - все критичные разрешения предоставлены"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Запуск..."
echo ""

# Запускаем приложение в фоне
/Applications/Nexy.app/Contents/MacOS/Nexy > /tmp/nexy_test_output.log 2>&1 &
APP_PID=$!

# Ждём 10 секунд
sleep 10

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4️⃣  Анализ логов (первые 150 строк)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

head -150 /tmp/nexy_test_output.log | grep -E "(критичные|Блокировка|Разблокировка|разрешений|запрос|IOHIDCheckAccess|macOS системные)" || echo "⚠️  Ключевые строки не найдены"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "5️⃣  Проверка наличия критического кода..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if grep -q "Разблокировка приложения - все критичные разрешения предоставлены" /tmp/nexy_test_output.log; then
    echo "❌ ОШИБКА: Найдена СТАРАЯ логика!"
    echo "   Приложение считает что все разрешения предоставлены."
    echo ""
    echo "   Это означает что:"
    echo "   • critical_permissions = set()  (пустое)"
    echo "   • Установлена старая версия кода"
    echo ""
    echo "   Пересоберите или переустановите PKG."
    echo ""
elif grep -q "Блокировка приложения - отсутствуют критичные разрешения" /tmp/nexy_test_output.log; then
    echo "✅ УСПЕХ: Найдена НОВАЯ логика!"
    echo "   Приложение корректно определяет отсутствие разрешений."
    echo ""
    
    if grep -q "Запускаем запрос разрешений" /tmp/nexy_test_output.log; then
        echo "✅ Запрос разрешений инициирован"
    else
        echo "⚠️  Запрос разрешений НЕ инициирован"
    fi
    
    if grep -q "IOHIDCheckAccess" /tmp/nexy_test_output.log; then
        echo "✅ IOHIDCheckAccess вызван (Input Monitoring)"
    else
        echo "⚠️  IOHIDCheckAccess НЕ найден"
    fi
    echo ""
else
    echo "⚠️  Не удалось определить логику разрешений в логах"
    echo ""
    echo "Полный лог сохранён в: /tmp/nexy_test_output.log"
    echo ""
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "6️⃣  Полный лог доступен для анализа:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   cat /tmp/nexy_test_output.log"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

