# Nexy Voice Capture Issue — Go-to-Market Readiness Notes

## 1. Критичные наблюдения из текущих логов
- Права на микрофон выданы: `tccd` и Control Center фиксируют активный `mic:com.nexy.assistant`, значит блокировок TCC нет.
- На удержании пробела сессия дергает `AVAudioSession` каждые ~200–300 мс: последовательность `MediaPlayback → PlayAndRecord_WithBluetooth → Record_WithBluetooth → MediaPlayback` повторяется многократно.
- CoreAudio повторно инициализирует устройства: device `85` (output-only) и device `91` (input-only) подключаются/отключаются в цикле, в логах `SelectDevice` и `SetStreamUsage`.
- Аудиодвижок не успевает стартовать: ошибки `HALC_ProxyIOContext::_StartIO(): Start failed - StartAndWaitForState returned error 35`, `IOWorkLoop: skipping cycle due to overload`, `ClientHALIODurationExceededBudget`.
- Поток записи так и не стабилизируется: `setPlayState` быстро переключается `Started → Stopped`, поэтому распознавание получает пустой аудиопоток.
- Дополнительно активируется `replayd` и screen capture, что увеличивает нагрузку и усугубляет тайминги старта.

## 2. Точка локализации проблемы
- **Уровень:** клиентское приложение, слой управления `AVAudioSession`/`audioEngine`.
- **Механизм сбоя:** множественные вызовы `startRecording` и смены аудио-категорий пока пользователь держит пробел. Рестарты происходят быстрее, чем CoreAudio успевает активировать сессию, что приводит к `error 35`.
- **Влияние окружения:** Bluetooth-аудиомаршрут (AirPods / другой BT-девайс) вызывает дополнительные события `routeChange`, но первопричина — логика приложения, а не железо.

## 3. Области кода для проверки
- Обработчик `keydown`/`keyup` для пробела: должен запускать запись один раз при `keydown` (с `event.repeat === false`) и останавливать ровно на `keyup`.
- Функции `startRecording`/`stopRecording`: добавить идемпотентность (проверка текущего состояния, флаги «запуск уже идёт»).
- Callback-и `AVAudioSession` (`routeChange`, `interruption`, `categoryChange`): убедиться, что они не инициируют повторные старты во время активной сессии.
- Управление Bluetooth-устройствами: фиксировать выбранный input/output перед запуском, отложить повторный `setCategory` до завершения предыдущего вызова.

## 4. План дальнейших шагов
1. Добавить логи вокруг `startRecording`/`stopRecording` и обработчиков клавиш, чтобы подтвердить количество вызовов за одно удержание пробела.
2. Ввести состояние «инициализация записи» (флаг или Promise) и блокировать повторные старты, пока CoreAudio не подтвердил `audioEngine.isRunning`.
3. После правок воспроизвести сценарий и проверить в Console отсутствие `Start failed ... error 35` и сообщений про `ClientHALIODurationExceededBudget`.
4. При необходимости провести A/B тест на проводном микрофоне vs Bluetooth, чтобы исключить специфические задержки маршрутов.

## 5. Готовность к Go-To-Market
- **Текущее состояние:** блокирующий дефект — приложение не принимает голосовые запросы, релиз невозможен.
- **Критерий готовности:** стабильная активация микрофона при удержании пробела без повторных рестартов, успешное распознавание речи минимум в 5 из 5 прогонов на целевой конфигурации (macOS + BT гарнитура).
- **Рекомендация:** приоритетное исправление логики запуска записи и повторное тестирование до любых Go-to-market активностей (PR, маркетинг, онбординг пользователей).
