name: Secrets Check

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
# –ß–∞—Å—Ç—å PR-7: Server Development Rules compliance

on:
  push:
    branches: [ main, develop, 'release/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-secrets:
    name: Check for secrets in repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∫–æ–º–º–∏—Ç–æ–≤

      - name: Check for config.env in git
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ config.env –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è git..."
          if git ls-files | grep -q "^server/config\.env$"; then
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: config.env –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!"
            echo "–§–∞–π–ª config.env —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã –∏ –ù–ï –î–û–õ–ñ–ï–ù –±—ã—Ç—å –≤ git."
            echo ""
            echo "–î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
            echo "  git rm --cached server/config.env"
            echo "  git commit -m 'chore: remove config.env from tracking'"
            echo ""
            echo "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:"
            echo "  1. –†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ API-–∫–ª—é—á–∏"
            echo "  2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ config.env –≤ .gitignore"
            exit 1
          fi
          echo "‚úÖ config.env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ git (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)"

      - name: Check .gitignore includes config.env
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ .gitignore..."
          if ! grep -q "^config\.env$" server/.gitignore; then
            echo "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: config.env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .gitignore"
            echo "–î–æ–±–∞–≤—å—Ç–µ 'config.env' –≤ server/.gitignore"
            exit 1
          fi
          echo "‚úÖ config.env –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ .gitignore"

      - name: Check for common secret patterns
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–µ–∫—Ä–µ—Ç–æ–≤..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–º–º–∏—Ç–∞—Ö
          PATTERNS=(
            "GEMINI_API_KEY="
            "AZURE_SPEECH_KEY="
            "GITHUB_TOKEN="
            "password="
            "secret="
            "api_key="
            "-----BEGIN.*PRIVATE KEY-----"
          )

          FOUND_SECRETS=false

          for pattern in "${PATTERNS[@]}"; do
            if git log --all -p | grep -i "$pattern" > /dev/null; then
              echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω —Å–µ–∫—Ä–µ—Ç–∞: $pattern"
              FOUND_SECRETS=true
            fi
          done

          if [ "$FOUND_SECRETS" = true ]; then
            echo ""
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏ git!"
            echo ""
            echo "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ:"
            echo "  1. –£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ git (git filter-repo –∏–ª–∏ BFG)"
            echo "  2. –†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏"
            echo "  3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å secrets management (AWS Secrets Manager, etc.)"
            exit 1
          fi

          echo "‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

      - name: Check for .env files
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ .env —Ñ–∞–π–ª—ã –≤ git..."

          ENV_FILES=$(git ls-files | grep -E "\.env$" | grep -v "\.env\.example$" || true)

          if [ -n "$ENV_FILES" ]; then
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω—ã .env —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
            echo "$ENV_FILES"
            echo ""
            echo "–¢–æ–ª—å–∫–æ .env.example —Ñ–∞–π–ª—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ git!"
            exit 1
          fi

          echo "‚úÖ .env —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (—Ç–æ–ª—å–∫–æ .example —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:"
          echo "  ‚úÖ config.env –Ω–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
          echo "  ‚úÖ config.env –≤ .gitignore"
          echo "  ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          echo "  ‚úÖ .env —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
