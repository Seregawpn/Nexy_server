#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./diagnose_remote_server.sh [SERVER_IP] [SSH_USER]

set -euo pipefail

SERVER_IP="${1:-20.63.24.187}"
SSH_USER="${2:-azureuser}"

echo "=================================================================================="
echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–î–ê–õ–Å–ù–ù–û–ì–û –°–ï–†–í–ï–†–ê: $SERVER_IP"
echo "=================================================================================="
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
remote_exec() {
    ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 "$SSH_USER@$SERVER_IP" "$1" 2>&1 || echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É"
}

echo "1. –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –°–ï–†–í–ò–°–ê:"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo systemctl status voice-assistant.service --no-pager -l | head -30"
echo ""

echo "2. –ü–†–û–í–ï–†–ö–ê –ü–†–û–¶–ï–°–°–û–í:"
echo "--------------------------------------------------------------------------------"
remote_exec "ps aux | grep -E 'python.*main.py|grpc|voice-assistant' | grep -v grep"
echo ""

echo "3. –ü–†–û–í–ï–†–ö–ê –ü–û–†–¢–û–í:"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo ss -tlnp | grep -E '50051|8080|8081' || echo '–ü–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'"
echo ""

echo "4. –ü–†–û–í–ï–†–ö–ê NGINX:"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo systemctl status nginx --no-pager -l | head -20"
echo ""

echo "5. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø NGINX (gRPC):"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo cat /etc/nginx/sites-enabled/* | grep -A 20 'location /' | head -30"
echo ""

echo "6. –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í NGINX (gRPC –æ—à–∏–±–∫–∏):"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo tail -50 /var/log/nginx/grpc-error.log 2>/dev/null || echo '–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'"
echo ""

echo "7. –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í NGINX (gRPC –¥–æ—Å—Ç—É–ø):"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo tail -20 /var/log/nginx/grpc-access.log 2>/dev/null || echo '–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'"
echo ""

echo "8. –ü–û–°–õ–ï–î–ù–ò–ï –õ–û–ì–ò –°–ï–†–í–ò–°–ê (–æ—à–∏–±–∫–∏):"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo journalctl -u voice-assistant.service -n 100 --no-pager | grep -iE 'ERROR|Exception|Failed|Traceback|grpc' | tail -30"
echo ""

echo "9. –ü–†–û–í–ï–†–ö–ê –õ–û–ö–ê–õ–¨–ù–û–ì–û gRPC –ü–û–†–¢–ê:"
echo "--------------------------------------------------------------------------------"
remote_exec "curl -s http://127.0.0.1:8080/health || echo 'HTTP —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'"
echo ""

echo "10. –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò –°–ï–†–í–ï–†–ê:"
echo "--------------------------------------------------------------------------------"
remote_exec "cd /home/$SSH_USER/voice-assistant/server 2>/dev/null && grep -E 'GRPC_HOST|GRPC_PORT|NEXY_ENV' config.env 2>/dev/null || echo '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'"
echo ""

echo "11. –ü–†–û–í–ï–†–ö–ê NGINX –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò (server_name):"
echo "--------------------------------------------------------------------------------"
remote_exec "sudo grep -r 'server_name' /etc/nginx/sites-enabled/ 2>/dev/null | head -5"
echo ""

echo "=================================================================================="
echo "‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=================================================================================="
echo ""
echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ gRPC —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 50051"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç gRPC –∑–∞–ø—Ä–æ—Å—ã"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ server_name –≤ Nginx —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É IP"
echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx –¥–ª—è gRPC –æ—à–∏–±–æ–∫"
