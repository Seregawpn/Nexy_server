#!/bin/bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª—ë—Ä—Ç–æ–≤ –ø–æ –ª–æ–≥–∞–º (PR-7)
# –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

LOG_FILE="${1:-server.log}"

echo "üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª—ë—Ä—Ç–æ–≤ –ø–æ –ª–æ–≥–∞–º"
echo "=============================="
echo "–õ–æ–≥ —Ñ–∞–π–ª: $LOG_FILE"
echo "=============================="
echo ""

# 1. p95 latency > 1000ms (warn), >1500ms (page)
echo "1. –ê–ª—ë—Ä—Ç –Ω–∞ p95 latency:"
echo ""
echo "   # Warn –ø—Ä–∏ p95 > 1000ms"
echo "   p95=\$(grep -E 'dur_ms=[0-9]+.*method=StreamAudio' $LOG_FILE | tail -100 | grep -oE 'dur_ms=([0-9]+)' | cut -d= -f2 | sort -n | awk '{latencies[NR]=\$1} END {n=length(latencies); if (n>0) {p95_idx=int(n*0.95); if (p95_idx==0) p95_idx=1; print latencies[p95_idx]} else print \"0\"}')"
echo "   if [ \"\$p95\" -gt 1000 ]; then"
echo "       echo \"‚ö†Ô∏è WARN: p95 latency –ø—Ä–µ–≤—ã—à–µ–Ω: \${p95}ms\""
echo "   fi"
echo ""
echo "   # Page –ø—Ä–∏ p95 > 1500ms"
echo "   if [ \"\$p95\" -gt 1500 ]; then"
echo "       echo \"üö® PAGE: p95 latency –∫—Ä–∏—Ç–∏—á–µ–Ω: \${p95}ms\""
echo "       # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (email, Slack, PagerDuty –∏ —Ç.–¥.)"
echo "   fi"
echo ""

# 2. error-rate > 5% (warn), >10% (page)
echo "2. –ê–ª—ë—Ä—Ç –Ω–∞ error rate:"
echo ""
echo "   # –†–∞—Å—á–µ—Ç error rate"
echo "   total=\$(grep -c 'scope=grpc method=StreamAudio' $LOG_FILE | tail -100 || echo \"0\")"
echo "   errors=\$(grep -c 'decision=error.*method=StreamAudio' $LOG_FILE | tail -100 || echo \"0\")"
echo "   if [ \"\$total\" -gt 0 ]; then"
echo "       error_rate=\$(echo \"scale=2; \$errors * 100 / \$total\" | bc)"
echo "       echo \"Error rate: \${error_rate}%\""
echo ""
echo "       # Warn –ø—Ä–∏ error rate > 5%"
echo "       if [ \$(echo \"\$error_rate > 5\" | bc) -eq 1 ]; then"
echo "           echo \"‚ö†Ô∏è WARN: Error rate –ø—Ä–µ–≤—ã—à–µ–Ω: \${error_rate}%\""
echo "       fi"
echo ""
echo "       # Page –ø—Ä–∏ error rate > 10%"
echo "       if [ \$(echo \"\$error_rate > 10\" | bc) -eq 1 ]; then"
echo "           echo \"üö® PAGE: Error rate –∫—Ä–∏—Ç–∏—á–µ–Ω: \${error_rate}%\""
echo "           # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
echo "       fi"
echo "   fi"
echo ""

# 3. –†–æ—Å—Ç unavailable/retry/abort –≤ √ó2 –æ—Ç –º–µ–¥–∏–∞–Ω—ã –∑–∞ 24—á
echo "3. –ê–ª—ë—Ä—Ç –Ω–∞ —Ä–æ—Å—Ç unavailable/retry/abort:"
echo ""
echo "   # –ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞"
echo "   baseline=\$(grep -c 'decision=(retry|abort).*unavailable' $LOG_FILE | head -1000 || echo \"0\")"
echo ""
echo "   # –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π)"
echo "   current=\$(grep -c 'decision=(retry|abort).*unavailable' $LOG_FILE | tail -100 || echo \"0\")"
echo ""
echo "   # –†–∞—Å—á–µ—Ç –º–µ–¥–∏–∞–Ω—ã"
echo "   if [ \"\$baseline\" -gt 0 ]; then"
echo "       median=\$(echo \"\$baseline / 2\" | bc)"
echo "       threshold=\$(echo \"\$median * 2\" | bc)"
echo ""
echo "       if [ \"\$current\" -gt \"\$threshold\" ]; then"
echo "           echo \"üö® PAGE: –†–æ—Å—Ç unavailable/retry/abort: \$current > \$threshold (√ó2 –æ—Ç –º–µ–¥–∏–∞–Ω—ã)\""
echo "           # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
echo "       fi"
echo "   fi"
echo ""

# 4. –ü—Ä–∏–º–µ—Ä –¥–ª—è cron (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
echo "4. –ü—Ä–∏–º–µ—Ä cron –∑–∞–¥–∞—á–∏ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç):"
echo ""
echo "   */5 * * * * /path/to/scripts/setup_alerts.sh /path/to/server.log >> /var/log/nexy-alerts.log 2>&1"
echo ""

# 5. –ü—Ä–∏–º–µ—Ä –¥–ª—è systemd timer
echo "5. –ü—Ä–∏–º–µ—Ä systemd timer:"
echo ""
echo "   # /etc/systemd/system/nexy-alerts.timer"
echo "   [Unit]"
echo "   Description=Nexy Alerts Timer"
echo ""
echo "   [Timer]"
echo "   OnCalendar=*:0/5"
echo "   Persistent=true"
echo ""
echo "   [Install]"
echo "   WantedBy=timers.target"
echo ""
echo "   # /etc/systemd/system/nexy-alerts.service"
echo "   [Unit]"
echo "   Description=Nexy Alerts Check"
echo ""
echo "   [Service]"
echo "   Type=oneshot"
echo "   ExecStart=/path/to/scripts/setup_alerts.sh /path/to/server.log"
echo ""

echo "=============================="
echo "üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:"
echo "   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Prometheus, CloudWatch, Datadog –∏ —Ç.–¥.)"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫"
echo "   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (email, Slack, PagerDuty –∏ —Ç.–¥.)"
echo ""

