# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π Streaming Workflow

## –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚úÖ)

### 1. State-sweep –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
rg -n "self\._(stream_buffer|pending_segment|processed_sentences|json_buffer|pending_command_payload|command_payload_sent|json_parsed|has_emitted)" integrations/workflow_integrations/streaming_workflow_integration.py
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –¢–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ–ª—è —É–¥–∞–ª–µ–Ω—ã –∏–∑ `__init__`)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ session_id
```bash
rg -n "(uuid|session_id.*=.*f\"session_|session_id.*=.*uuid)" integrations/workflow_integrations/streaming_workflow_integration.py
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ü—É—Å—Ç–æ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ `grpc_server.py`)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ backpressure guard
```bash
rg -n "(acquire_stream|check_message_rate|release_stream)" modules/grpc_service/core/grpc_server.py
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –¢–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (guard —Ç–æ–ª—å–∫–æ –≤ `GrpcServiceIntegration`)

---

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –í—Å–µ —Ç–µ—Å—Ç—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
```bash
cd server/server
python scripts/test_streaming_workflow_fix.py --server localhost:50051
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
```bash
# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç 2 (single-flight)
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 2

# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç 3 (–ª–∏–º–∏—Ç —Å—Ç—Ä–∏–º–æ–≤) - —Ç—Ä–µ–±—É–µ—Ç BACKPRESSURE_MAX_STREAMS=2
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 3

# –¢–µ—Å—Ç—ã 4-6 (rate limit –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏—è) - –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 4,5,6

# –¢–µ—Å—Ç—ã 1-2 (–±–µ–∑ backpressure)
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 1,2
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
```bash
cd server/server
./scripts/run_streaming_tests.sh [SERVER_ADDRESS]
```

#### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ 3-4
```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
cd server/server
BACKPRESSURE_MAX_STREAMS=2 BACKPRESSURE_MAX_RATE=5 python main.py
```

**–í–ê–ñ–ù–û**: –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 3 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏ 4-6, —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ backpressure.

### –¢–µ—Å—Ç—ã

#### –¢–µ—Å—Ç 1: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–∑–Ω—ã–º–∏ session_id
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –±—É—Ñ–µ—Ä–æ–≤
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö

#### –¢–µ—Å—Ç 2: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–Ω–∏–º session_id (single-flight)
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å atomic single-flight –∑–∞—â–∏—Ç—É
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å `RESOURCE_EXHAUSTED`

#### –¢–µ—Å—Ç 3: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ max_concurrent_streams
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∏–º–æ–≤
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–∫–∞–∑ —Å `RESOURCE_EXHAUSTED`
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `BACKPRESSURE_MAX_STREAMS=2` –≤ env **–ü–ï–†–ï–î** –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞

#### –¢–µ—Å—Ç 4: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ max_message_rate_per_second
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limit –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: 6-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–∫–∞–∑ —Å `RESOURCE_EXHAUSTED`
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `BACKPRESSURE_MAX_RATE=5` –≤ env **–ü–ï–†–ï–î** –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞

#### –¢–µ—Å—Ç 5: –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ —Å—Ç—Ä–∏–º–∞
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–æ–≥—É—é –ø–æ–ª–∏—Ç–∏–∫—É "–Ω–µ —Å–º–µ—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—à–∏–±–∫–∏"
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–µ—Ç chunks –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏

#### –¢–µ—Å—Ç 6: –†–µ–≥—Ä–µ—Å—Å–∏—è - –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π streaming
- **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞
- **–û–∂–∏–¥–∞–µ–º–æ–µ**: –¢–µ–∫—Å—Ç –∏ –∞—É–¥–∏–æ —Å—Ç—Ä–∏–º—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, `command_payload` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ‚â§1 —Ä–∞–∑

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ backpressure –¥–ª—è —Ç–µ—Å—Ç–æ–≤ 3-4

### –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ 3-4

**–í–ê–ñ–ù–û**: –õ–∏–º–∏—Ç—ã backpressure –±–µ—Ä—É—Ç—Å—è –∏–∑ **–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**, –∞ –Ω–µ –∏–∑ `unified_config.yaml`!

–î–ª—è —Ç–µ—Å—Ç–æ–≤ 3 –∏ 4 **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è **–ü–ï–†–ï–î** –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
export BACKPRESSURE_MAX_STREAMS=2      # –î–ª—è —Ç–µ—Å—Ç–∞ 3 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
export BACKPRESSURE_MAX_RATE=5         # –î–ª—è —Ç–µ—Å—Ç–∞ 4 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
export BACKPRESSURE_IDLE_TIMEOUT=300
export BACKPRESSURE_GRACE_PERIOD=30

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å —ç—Ç–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
cd server/server
python main.py
```

–ò–ª–∏ –≤ –æ–¥–Ω–æ–º –∫–æ–º–∞–Ω–¥–Ω–æ–º –±–ª–æ–∫–µ:

```bash
cd server/server
BACKPRESSURE_MAX_STREAMS=2 BACKPRESSURE_MAX_RATE=5 python main.py
```

**–í–ê–ñ–ù–û**: 
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å env vars **–î–û** –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä** –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ env vars
3. –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –≤–µ—Ä–Ω—É—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –±–µ–∑ —ç—Ç–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏–º–∏—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è env vars
echo "BACKPRESSURE_MAX_STREAMS=${BACKPRESSURE_MAX_STREAMS:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
echo "BACKPRESSURE_MAX_RATE=${BACKPRESSURE_MAX_RATE:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
```

–ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —Ç–µ—Å—Ç 3 –±—É–¥–µ—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω —Å `DEADLINE_EXCEEDED` –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏–º–∏—Ç.

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —á–µ—Ä–µ–∑ config.env

–ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ `config.env`:

```bash
BACKPRESSURE_MAX_STREAMS=2
BACKPRESSURE_MAX_RATE=5
```

–ò –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (–æ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç `config.env` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: –†–∞–∑–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

**–®–∞–≥ 1: –¢–µ—Å—Ç—ã –±–µ–∑ backpressure (1-2)**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ë–ï–ó —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤
cd server/server
python main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 1,2
```

**–®–∞–≥ 2: –¢–µ—Å—Ç 3 (–ª–∏–º–∏—Ç —Å—Ç—Ä–∏–º–æ–≤)**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –ª–∏–º–∏—Ç–æ–º
BACKPRESSURE_MAX_STREAMS=2 python main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 3
```

**–®–∞–≥ 3: –¢–µ—Å—Ç—ã 4-6 (rate limit –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏—è)**
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–ª–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
BACKPRESSURE_MAX_STREAMS=2 BACKPRESSURE_MAX_RATE=5 python main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python scripts/test_streaming_workflow_fix.py --server localhost:50051 --tests 4,5,6
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Å–µ —Ç–µ—Å—Ç—ã –ø–æ–¥—Ä—è–¥ (–¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)

**–í–ê–ñ–ù–û**: –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 3 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏ 4-6.

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å –ª–∏–º–∏—Ç–∞–º–∏
cd server/server
BACKPRESSURE_MAX_STREAMS=2 BACKPRESSURE_MAX_RATE=5 python main.py

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python scripts/test_streaming_workflow_fix.py --server localhost:50051
```

**–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 3** (–µ—Å–ª–∏ –æ–Ω –ø—Ä–æ—à–µ–ª):
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å —Ç–µ–º–∏ –∂–µ –ª–∏–º–∏—Ç–∞–º–∏
3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç—ã 4-6

---

## –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞—é—Ç –ø–∞—É–∑—É 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è backpressure. –û–¥–Ω–∞–∫–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞** –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 3 (–µ—Å–ª–∏ –æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏–º–∏—Ç —Å—Ç—Ä–∏–º–æ–≤)
2. **–ü–∞—É–∑–∞ 5-10 —Å–µ–∫—É–Ω–¥** –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ 3 –∏ 4, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
3. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ 4-6 –æ—Ç–¥–µ–ª—å–Ω–æ** –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

---

## –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### ‚úÖ –£—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```
‚úÖ –¢–ï–°–¢ 1 –ü–†–û–ô–î–ï–ù: –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
‚úÖ –¢–ï–°–¢ 2 –ü–†–û–ô–î–ï–ù: Single-flight —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –¢–ï–°–¢ 3 –ü–†–û–ô–î–ï–ù: –õ–∏–º–∏—Ç —Å—Ç—Ä–∏–º–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –¢–ï–°–¢ 4 –ü–†–û–ô–î–ï–ù: Rate limit —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –¢–ï–°–¢ 5 –ü–†–û–ô–î–ï–ù: –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –¢–ï–°–¢ 6 –ü–†–û–ô–î–ï–ù: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π streaming —Ä–∞–±–æ—Ç–∞–µ—Ç

–í—Å–µ–≥–æ: 6/6 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ
üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´!
```

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö
- –¢–µ—Å—Ç—ã 3-4 —Ç—Ä–µ–±—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ env vars (`BACKPRESSURE_MAX_STREAMS=2`, `BACKPRESSURE_MAX_RATE=5`)
- –¢–µ—Å—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é —Å–µ—Ä–≤–µ—Ä–∞ (–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∏–º—ã –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 3 –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏ 4-6

### ‚ùå –ü—Ä–æ–≤–∞–ª
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤ 3-4

---

## –†—É—á–Ω–æ–π –ø—Ä–æ–≥–æ–Ω (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

### –¢–µ—Å—Ç 1: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```python
import asyncio
import grpc
# ... –∏–º–ø–æ—Ä—Ç—ã ...

async def test_parallel():
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 StreamAudio —Å —Ä–∞–∑–Ω—ã–º–∏ session_id –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
    pass
```

### –¢–µ—Å—Ç 2: Single-flight
```python
async def test_single_flight():
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 StreamAudio —Å –æ–¥–Ω–∏–º session_id –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Ç–æ—Ä–æ–π –æ—Ç–∫–ª–æ–Ω—ë–Ω
    pass
```

### –¢–µ—Å—Ç 3-4: Backpressure
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –ª–∏–º–∏—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–∞–∑—ã —Å `RESOURCE_EXHAUSTED`

### –¢–µ—Å—Ç 5: –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
- –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –≤—ã–∑—ã–≤–∞—é—â–∏–π –æ—à–∏–±–∫—É
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –Ω–µ—Ç chunks

### –¢–µ—Å—Ç 6: –†–µ–≥—Ä–µ—Å—Å–∏—è
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ text/audio chunks
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `command_payload` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ‚â§1 —Ä–∞–∑
