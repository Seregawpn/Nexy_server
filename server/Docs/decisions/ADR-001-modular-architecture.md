# ADR-001: Модульная архитектура с координатором (ModuleCoordinator)

**Date:** 2025-10-03
**Author:** Tech Lead
**Status:** Accepted

---

## Context

Серверная часть Nexy требовала масштабирования до 100 одновременных пользователей и улучшения изоляции модулей для упрощения тестирования и поддержки.

**Проблема:**
- Прямые импорты между модулями создавали плотные связки
- Сложность тестирования отдельных модулей
- Невозможность динамической замены модулей (например, для A/B тестирования)
- Отсутствие единой точки управления жизненным циклом модулей

**Триггер:**
- Требование масштабирования до 100 пользователей (PR-2)
- Необходимость внедрения feature-flags и kill-switches (PR-7)
- Сложность отладки при прямых вызовах между модулями

---

## Decision

Внедрить централизованный `ModuleCoordinator` для управления всеми серверными модулями.

**Решение:**
Создать единую точку управления модулями через `server/integrations/core/module_coordinator.py`:
- Все модули регистрируются через `coordinator.register(capability, module, config)`
- Получение модулей через `coordinator.get(capability)`
- Запрет прямых импортов между модулями
- Поддержка адаптеров для legacy модулей

**Обоснование:**
1. **Изоляция:** Модули не знают друг о друге напрямую
2. **Тестируемость:** Легко мокировать зависимости через координатор
3. **Масштабируемость:** Единая точка для мониторинга и управления ресурсами
4. **Гибкость:** Возможность динамической замены модулей (feature-flags)

---

## Alternatives

1. **Dependency Injection framework (e.g., injector, dependency-injector)**
   - **Плюсы:** Готовое решение, богатая функциональность
   - **Минусы:** Дополнительная зависимость, избыточная сложность для наших нужд
   - **Почему не выбрали:** Слишком тяжеловесно для простой координации модулей

2. **Service Locator pattern**
   - **Плюсы:** Простота реализации
   - **Минусы:** Anti-pattern, скрытые зависимости
   - **Почему не выбрали:** Плохая тестируемость, сложно отследить зависимости

3. **Event-driven architecture (EventBus для всех модулей)**
   - **Плюсы:** Полная развязка модулей
   - **Минусы:** Сложность отладки, неявные потоки данных
   - **Почему не выбрали:** Избыточная сложность для серверных модулей (EventBus используется на клиенте)

---

## Affected Axes / Guards

**Затронутые оси:**
- Не затрагивает оси состояний клиента
- Влияет на архитектуру сервера (см. `Docs/ARCHITECTURE_OVERVIEW.md`)

**Guard-условия:**
- Не добавляет новых guard-условий
- Упрощает добавление guard-условий для модулей в будущем

**Инварианты:**
- **Новый инвариант:** Все серверные модули доступны только через `ModuleCoordinator`
- **Новый инвариант:** Прямые импорты между модулями запрещены (проверяется скриптом `verify_no_direct_module_calls.py`)

---

## Consequences

**Impact на компоненты:**

- **Модули:** Все серверные модули в `server/modules/`:
  - `grpc_service` - использует координатор напрямую (нативный модуль)
  - `text_processing`, `audio_generation`, `database`, `session_management`, `memory_management`, `interrupt_handling`, `text_filtering` - используют адаптеры
  - `update` - требует обновления до нового интерфейса

- **Интеграции:**
  - `GrpcServiceIntegration` - обновлена для использования координатора
  - Добавлены `WorkflowIntegrations` для координации модулей

- **Конфигурация:**
  - Добавлены feature-flags в `server/config/unified_config.py`:
    - `features.use_module_coordinator` (default=True)
    - `kill_switches.disable_module_coordinator` (default=False)

- **gRPC:**
  - Протокол не изменен (backward compatible)
  - `GrpcServiceManager` использует координатор для получения модулей

- **FSM:**
  - Не затрагивает FSM клиента
  - Упрощает управление состоянием серверных модулей

**Риски:**

1. **Риск:** Производительность - дополнительный слой абстракции
   - **Митигация:** Координатор использует простой dict lookup (O(1))
   - **Мониторинг:** Метрика `coordinator_lookup_time_ms` (p95 < 1ms)

2. **Риск:** Миграция legacy модулей
   - **Митигация:** Адаптеры позволяют постепенную миграцию
   - **Мониторинг:** Feature-flag `use_module_coordinator` для постепенного rollout

3. **Риск:** Сложность отладки (непрямые вызовы)
   - **Митигация:** Структурированное логирование всех операций координатора
   - **Мониторинг:** Логи с `scope=coordinator` для отслеживания

**Метрики:**

- `coordinator_lookup_time_ms` - время поиска модуля (p95 < 1ms)
- `coordinator_module_init_time_ms` - время инициализации модуля (p95 < 100ms)
- `direct_module_import_count` - количество прямых импортов (должно быть 0)
- Существующие метрики не меняются

**SLO:**
- `p95_latency_ms` - не должна увеличиться (baseline: ≤1000ms)
- `error_rate` - не должна увеличиться (baseline: ≤5%)

**Тестирование:**

- ✅ Добавлены юнит-тесты: `server/tests/test_pr2_1_coordinator.py`
- ✅ Добавлены интеграционные тесты для всех адаптеров
- ✅ Скрипт проверки: `scripts/verify_no_direct_module_calls.py`
- ✅ Smoke-тесты gRPC обновлены для проверки координатора

**Документация:**

- ✅ Обновлен `Docs/ARCHITECTURE_OVERVIEW.md` - раздел "Серверные модули"
- ✅ Обновлен `README.md` - добавлена секция ModuleCoordinator
- ✅ Создан `Docs/MODULE_COORDINATOR_GUIDE.md` - руководство разработчика
- ✅ Обновлен `Docs/SERVER_DEVELOPMENT_RULES.md` - правило о прямых импортах

---

## Rollout Plan

**Этапы:**

1. **Этап 1 (dev, 100%):**
   - Тестирование в dev окружении
   - Проверка всех модулей через координатор
   - Валидация метрик производительности
   - **Критерии успеха:** Все тесты проходят, p95_latency < 1000ms

2. **Этап 2 (stage, 25%):**
   - Включение `features.use_module_coordinator=true` для 25% трафика
   - Мониторинг метрик в течение 48 часов
   - **Критерии успеха:** error_rate < 5%, p95_latency < 1000ms, coordinator_lookup_time < 1ms

3. **Этап 3 (prod, 100%):**
   - Полный rollout на production
   - Мониторинг метрик в течение 7 дней
   - **Критерии успеха:** Стабильная работа, все SLO выполняются

**Критерии перехода:**
- ✅ Все метрики в зеленой зоне (p95_latency ≤ 1000ms, error_rate ≤ 5%)
- ✅ Нет критических ошибок в логах за последние 24 часа
- ✅ Coordinator lookup time < 1ms (p95)

**Критерии отката:**
- ❌ error_rate > 10% (page)
- ❌ p95_latency > 1500ms (page)
- ❌ Критические ошибки в координаторе

**Kill-switch:**
- **Переменная окружения:** `KILL_SWITCH_DISABLE_MODULE_COORDINATOR=true`
- **Конфиг:** `kill_switches.disable_module_coordinator: true`
- **Эффект:** Откат к прямым импортам модулей
- **Как включить:** Установить переменную окружения и перезапустить сервер

---

## References

- `Docs/ARCHITECTURE_OVERVIEW.md` — описание модульной архитектуры сервера
- `Docs/SERVER_DEVELOPMENT_RULES.md` — правило о запрете прямых импортов (Раздел 12)
- `server/integrations/core/module_coordinator.py` — реализация координатора
- `server/integrations/core/module_adapter.py` — адаптеры для legacy модулей
- `scripts/verify_no_direct_module_calls.py` — скрипт проверки прямых импортов
- PR-2.1: Module Coordinator implementation
- PR-7: Feature-flags и kill-switches
