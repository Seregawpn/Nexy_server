# üß≠ Nexy Server ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç ‚Äî –∫–∞–Ω–æ–Ω –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ Nexy. –û–Ω –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –æ—Å–µ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–æ–¥—É–ª–µ–π –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º. –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º–∏ –∫–∞–Ω–æ–Ω–∞–º–∏.

–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–Ω—ã –∏ –æ—Ç—á–µ—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ `server/Docs/_archive` –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

**Flow Interaction Spec (–∫–∞–Ω–æ–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π):** `server/Docs/FLOW_INTERACTION_SPEC.md`

---

## 0. Release/Deploy Boundaries

- `Seregawpn/Nexy_server` ‚Äî source code –∏ deploy pipeline.
- `Seregawpn/Nexy_production/releases` ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (`Nexy.dmg`, `Nexy.pkg`) –∏ update-–∫–∞–Ω–∞–ª.

–ö–∞–Ω–æ–Ω—ã:
- Deploy: `server/Docs/SERVER_DEPLOYMENT_GUIDE.md`
- Client release: `server/Docs/RELEASE_AND_UPDATE_GUIDE.md`
- Incident runbook: `server/Docs/DEPLOY_INCIDENT_RUNBOOK.md`

–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å —ç—Ç–∏ –ø–∞–π–ø–ª–∞–π–Ω—ã –≤ –æ–¥–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

---

## 1. –û—Å–∏, –≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã

| –û—Å—å | Canon | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
| --- | --- | --- |
| gRPC –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª | `server/Docs/GRPC_PROTOCOL_AUDIT.md` | @grpc-core |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ AppCast | `server/Docs/RELEASE_AND_UPDATE_GUIDE.md` | @release-ops |
| Backpressure –∏ –ª–∏–º–∏—Ç—ã | `server/Docs/BACKPRESSURE_README.md` | @reliability |
| Health/–Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å | `server/Docs/CI_GRPC_CHECKS.md` | @sre-duty |
| –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏ DR | `server/Docs/DB_BACKUP_AND_RESTORE_RUNBOOK.md` | @server-platform |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | `config/unified_config.py` + `config/unified_config.yaml` | @server-platform |
| State Catalog | `server/Docs/STATE_CATALOG.md` | Tech Lead –∫–ª–∏–µ–Ω—Ç–∞ |
| Flow Interaction Spec | `server/Docs/FLOW_INTERACTION_SPEC.md` | Tech Lead –∫–ª–∏–µ–Ω—Ç–∞ |

- –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç-–∫–∞–Ω–æ–Ω –Ω–∞ –æ—Å—å, –æ–¥–∏–Ω –≤–ª–∞–¥–µ–ª–µ—Ü. –°—Å—ã–ª–∫–∏ –≤ PR –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–∞–Ω–æ–Ω–∞.
- `server/Docs/ADR_TEMPLATE.md` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π/–º–∞—Ç—Ä–∏—Ü/–ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–º–∏–∫—Ä–æ-ADR ‚â•7 —Å—Ç—Ä–æ–∫).

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ—ë–≤

```
server/server/
‚îú‚îÄ‚îÄ main.py                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ modules/                     # –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ grpc_service/            # gRPC —Å–µ—Ä–≤–µ—Ä, –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã, streaming.proto
‚îÇ   ‚îú‚îÄ‚îÄ audio_generation/
‚îÇ   ‚îú‚îÄ‚îÄ text_processing/
‚îÇ   ‚îú‚îÄ‚îÄ session_management/
‚îÇ   ‚îú‚îÄ‚îÄ memory_management/
‚îÇ   ‚îú‚îÄ‚îÄ interrupt_handling/
‚îÇ   ‚îú‚îÄ‚îÄ text_filtering/
‚îÇ   ‚îú‚îÄ‚îÄ database/                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ update/                  # –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ integrations/                # –û–±–≤—è–∑–∫–∞ –∏ orchestration
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ service_integrations/
‚îÇ   ‚îî‚îÄ‚îÄ workflow_integrations/
‚îú‚îÄ‚îÄ monitoring/                  # –ú–µ—Ç—Ä–∏–∫–∏ –∏ health-–ø—Ä–æ–≤–µ—Ä–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ grpc_monitor.py          # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ gRPC –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ scripts/                     # smoke/contract/–≥–≤–∞—Ä–¥—Ä–∞–π–ª—ã
‚îú‚îÄ‚îÄ tests/                       # unit/contract —Å—Ü–µ–Ω–∞—Ä–∏–∏
‚îú‚îÄ‚îÄ config/                      # unified_config.yaml (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
‚îú‚îÄ‚îÄ utils/                       # –£—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç—Ä–∏–∫–∏, —Ç–µ–∫—Å—Ç)
‚îú‚îÄ‚îÄ updates/                     # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (manifests, downloads, keys)
‚îú‚îÄ‚îÄ nginx/                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è ingress
‚îî‚îÄ‚îÄ Docs/                        # –ö–∞–Ω–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

- –ú–æ–¥—É–ª–∏ ‚â† –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚â† workflow: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∂–∏–≤—ë—Ç –≤ `server/server/modules/*`. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö –∏ workflow-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö.
- –ü—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã. –î–æ—Å—Ç—É–ø –∏–¥—ë—Ç —á–µ—Ä–µ–∑ `server/server/integrations/service_integrations/module_coordinator.py`.
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç `UniversalModuleInterface`. 
  - **–ü—Ä—è–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `text_processing` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `module.py` (–Ω–∞–ø—Ä—è–º—É—é —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  - **–ê–¥–∞–ø—Ç–µ—Ä—ã:** –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `adapter.py` (–æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞–º–∏), –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ –µ–¥–∏–Ω—ã–π `initialize/process/cleanup/status`
- gRPC —Å–ª–æ–π –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é; —Å–≤—è–∑—å —á–µ—Ä–µ–∑ `GrpcServiceManager` ‚Üí `ModuleCoordinator`, –∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç `ModuleFactory`.
- Workflow-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (`streaming`, `memory`, `interrupt`) —Ä–∞–±–æ—Ç–∞—é—Ç —Å capability —á–µ—Ä–µ–∑ `module.process()`. –ó–∞–ø—Ä–æ—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö `get_processor()` –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π workaround –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ ADR + `server/Docs/SERVER_DEVELOPMENT_RULES.md`.
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏:** `database`, `audio_generation`, `text_filtering`, `interrupt_handling` - —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –Ω–∏—Ö –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (graceful degradation).
- –í—Å–µ –ø–æ—Ä—Ç—ã/–ª–∏–º–∏—Ç—ã/—Ç–∞–π–º–∞—É—Ç—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `unified_config`; –≤ –∫–æ–¥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ¬´–º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞¬ª.

---

## 2.3 Database Durability & Protection (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–æ–Ω)

- **Source of Truth –ø–æ DB policy:** `server/Docs/DB_BACKUP_AND_RESTORE_RUNBOOK.md` + `server/Docs/DATABASE_SETUP_GUIDE.md`.
- **Least-privilege –¥–ª—è app-role:** `SELECT/INSERT/UPDATE`; –∑–∞–ø—Ä–µ—â–µ–Ω—ã `DELETE/TRUNCATE/CREATE` –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–æ–ª–∏.
- **Hard-delete guard:** trigger-–∑–∞—â–∏—Ç–∞ –æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (`users/sessions/commands/llm_answers/token_usage` –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã).
- **–ö–æ–¥–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞:** –º–æ–¥—É–ª—å `database` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `delete` –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ runtime.
- **Release/Deploy gate:** –ø–µ—Ä–µ–¥ production-—Ä–µ–ª–∏–∑–æ–º –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω backup; restore drill –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π.
- **–ü–æ—Å–ª–µ restore:** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å `server/scripts/harden_database_protection.sh`.

---

## 2.2 –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (Server Route)

**–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**: `server/Docs/SERVER_DEVELOPMENT_RULES.md` (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç).  
–ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫–∏–π –ø—É—Ç—å:

1. **Module** ‚Üí `server/server/modules/<feature>/`
   - –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–æ–≤—ã–π: —Å–æ–∑–¥–∞—Ç—å `module.py` —Å –∫–ª–∞—Å—Å–æ–º, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–º `UniversalModuleInterface`
   - –ï—Å–ª–∏ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º: —Å–æ–∑–¥–∞—Ç—å `adapter.py` —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º
2. **ModuleFactory** ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è capability –≤ `_MODULE_REGISTRY` (`integrations/core/module_factory.py`)
   - –§–æ—Ä–º–∞—Ç: `'capability': 'modules.<feature>.module:ClassName'` –∏–ª–∏ `'modules.<feature>.adapter:AdapterName'`
3. **ModuleCoordinator** ‚Üí –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–æ—Å—Ç—É–ø (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `GrpcServiceManager`)
4. **Config/Flags** ‚Üí `server/server/config/unified_config.yaml` + `server/Docs/FEATURE_FLAGS.md`
5. **gRPC Contract** ‚Üí `server/Docs/GRPC_PROTOCOL_AUDIT.md` (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

---

## 2.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞

- **Request-scoped state**: —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–∏–º–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ workflow.
- **Single-flight –ø–æ session_id**: –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π StreamAudio –Ω–∞ `session_id`, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è.
- **Source of Truth**: `session_id` –∏ gRPC —Å—Ç–∞—Ç—É—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `grpc_server.py`.
- **Backpressure —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω**: acquire/check/release –≤ `GrpcServiceIntegration`.
- **–ü–æ–ª–∏—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫**: –æ—à–∏–±–∫–∞ –¥–æ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–∏–º–∞ ‚Üí gRPC —Å—Ç–∞—Ç—É—Å + error_message; –ø–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Üí —Ç–∏—Ö–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ `end_message`.

---

## 2.2 Session Management –∏ Concurrency (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 21 —è–Ω–≤–∞—Ä—è 2026)

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏—è—Ö —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ –∏—Å—Ç–∏–Ω—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-----------|-----------------|
| `SessionRegistry` | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü session state (thread-safe —Å `threading.RLock`) |
| `SessionTracker` | –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤—Å—ë –≤ `SessionRegistry`, —É–ø—Ä–∞–≤–ª—è–µ—Ç lifecycle |
| `InterruptManager` | –ü–æ–ª—É—á–∞–µ—Ç session data –∏–∑ `SessionRegistry`, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –∫–æ–ø–∏–∏ |
| `InterruptWorkflowIntegration` | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `SessionRegistry` –¥–ª—è session queries |

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Å—Å–∏—è–º–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ `SessionRegistry.register_session()`, `get_session()`, `interrupt_session()`, `unregister_session()`.

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–æ–ª—å |
|-----------|------|
| `GlobalFlagProvider` | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü `global_interrupt_flag` |
| `InterruptManager` | –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤—Å–µ flag-–æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `GlobalFlagProvider` |

**–ü–∞—Ç—Ç–µ—Ä–Ω:** `InterruptManager.should_interrupt(hardware_id)` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `GlobalFlagProvider.check_interrupt_flag()`.

### Thread-Safety –∏ Lock Usage

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | Lock Type | –ó–∞—â–∏—â–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å |
|-----------|-----------|-------------------|
| `SessionRegistry` | `threading.RLock` | `_active_sessions` dict |
| `HardwareIDProvider` | `asyncio.Lock` | `received_ids` set |
| `StreamingWorkflowIntegration` | `asyncio.Lock` | `_hardware_id_to_sessions` (in-flight tracking) |
| `BackpressureManager` | `asyncio.Lock` | rate/stream counters |
| `SubscriptionModule` | `threading.Lock` | `_cache` TTL cache |
| `MemoryWorkflowIntegration` | `asyncio.Lock` | `memory_cache`, `_memory_tasks` |

**–ü—Ä–∞–≤–∏–ª–æ:** –õ—é–±–æ–π shared mutable state, –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö async –∑–∞–¥–∞—á, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—â–∏—â—ë–Ω lock.


---

## 3. –û—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ MCP –∫–æ–º–∞–Ω–¥—ã

### 3.1 –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (LLM):

**–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:**
- –¢–æ–ª—å–∫–æ –ø–æ–ª–µ `text` (—Å—Ç—Ä–æ–∫–∞ –¥–ª—è –æ–∑–≤—É—á–∫–∏)
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ: —Ç–µ–∫—Å—Ç –∏–¥—ë—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–µ—á–∏ (TTS) –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç—É

**Action-–æ—Ç–≤–µ—Ç (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π):**
```json
{
  "session_id": "<uuid>",
  "command": "open_app",
  "args": {
    "app_name": "Telegram"
  },
  "text": "–û—Ç–∫—Ä—ã–≤–∞—é Telegram, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —á—Ç–æ-—Ç–æ –µ—â—ë."
}
```

- `text` ‚Äî –∏–¥—ë—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–µ—á–∏/—Å—Ç—Ä–∏–º–∏–Ω–≥ (–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–∑–≤—É—á–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- JSON (`command` + `args` + `session_id`) ‚Äî –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `mcp.command_request`
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `command` –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º: —Ç–µ–∫—Å—Ç/–∞—É–¥–∏–æ –∏–¥—É—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞, MCP —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è

**–ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü–∞—Ä—Å–µ—Ä: `integrations/core/assistant_response_parser.py`
- –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ "–∫—Ä–∏–≤—ã–º" –¥–∞–Ω–Ω—ã–º: –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ JSON ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `text_response`, `command_payload=None`
- –ï—Å–ª–∏ JSON, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `text` ‚Äî –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (—á—Ç–æ–±—ã TTS –Ω–µ –ø–∞–¥–∞–ª)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (`session_id`, `app_name` –¥–ª—è `open_app`) –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—à–∏–±–æ–∫/–ª–æ–≥–æ–≤ –ø—Ä–∏ –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏

**–ü–µ—Ä–µ–¥–∞—á–∞ —á–µ—Ä–µ–∑ gRPC (–§–∞–∑–∞ 3):**
- `command_payload` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –∫–∞–∫ `text_chunk` —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `__MCP__`
- –§–æ—Ä–º–∞—Ç: `__MCP__{"event": "mcp.command_request", "payload": {...}}`
- –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–∞–Ω–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `__MCP__` –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å JSON –≤ EventBus –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ `mcp.command_request`
- –¢–µ–∫—Å—Ç –∏ –∞—É–¥–∏–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ –æ–±—ã—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –ü—Ä–µ—Ñ–∏–∫—Å –≤—ã–±—Ä–∞–Ω –¥–ª—è backward compatibility (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è proto)

**–§–∏—á–∞-—Ñ–ª–∞–≥:**
- `features.forward_assistant_actions` ‚Äî –≤–∫–ª—é—á–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É JSON –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`)
- Kill-switch: `kill_switches.disable_forward_assistant_actions` ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–ª–∏–∑–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –ö–∞–Ω–æ–Ω: `server/Docs/SERVER_DEVELOPMENT_RULES.md` (–∏—Ç–æ–≥–æ–≤—ã–π summary)
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω: `server/Docs/_archive/MCP_COMMAND_INTEGRATION_PLAN.md` (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏, –Ω–µ –∫–∞–Ω–æ–Ω)
- –†–µ—à–µ–Ω–∏—è –æ–± action –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (LLM), —Å–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç

### 3.2 Browser Automation (`browser_use`)

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç AI-—É–ø—Ä–∞–≤–ª—è–µ–º—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –±—Ä–∞—É–∑–µ—Ä–∞ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `browser_use` (Feature ID: F-2025-015).

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–µ–±-–∑–∞–¥–∞—á —Å –ø–æ–º–æ—â—å—é AI-–∞–≥–µ–Ω—Ç–∞ (–ø–æ–∏—Å–∫, –∫–ª–∏–∫–∏, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º)
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (–±—Ä–∞—É–∑–µ—Ä –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.env`):**

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `BROWSER_USE_ENABLED` | `true` | –í–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å browser automation |
| `BROWSER_USE_KEEP_OPEN` | `true` | –°–æ—Ö—Ä–∞–Ω—è—Ç—å –±—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã—Ç—ã–º –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ |
| `BROWSER_USE_TIMEOUT` | `120` | –¢–∞–π–º–∞—É—Ç –∑–∞–¥–∞—á–∏ (—Å–µ–∫—É–Ω–¥—ã) |
| `BROWSER_USE_MAX_STEPS` | `50` | –ú–∞–∫—Å–∏–º—É–º —à–∞–≥–æ–≤ –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –∑–∞–¥–∞—á—É |
| `BROWSER_USE_MODEL` | `gemini-2.5-flash` | LLM –º–æ–¥–µ–ª—å –¥–ª—è browser-–∞–≥–µ–Ω—Ç–∞ |

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞:**
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä (Chromium) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –º–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `playwright install chromium`. –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç >2 —Å–µ–∫—É–Ω–¥, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ macOS).

**–ö–æ–º–∞–Ω–¥—ã:**
- `browser_use` ‚Äî –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤–µ–±-–∑–∞–¥–∞—á—É
- `close_browser` ‚Äî –Ø–≤–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é —Å–µ—Å—Å–∏—é –±—Ä–∞—É–∑–µ—Ä–∞

### 3.3 Messages Integration (`messages`) (Feature ID: F-2025-016)

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç MCP –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Apple Messages –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã.

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ß—Ç–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ iMessage/SMS
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç–∞–º
- –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π –∫–Ω–∏–≥–µ

**–ö–æ–º–∞–Ω–¥—ã (–≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ):**

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `read_messages` | –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞ |
| `send_message` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—É |
| `find_contact` | –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ –∏–º–µ–Ω–∏ |

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- Full Disk Access –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `~/Library/Messages/chat.db`
- –ü—Ä–∞–≤–∞ –Ω–∞ Automation (Messages.app) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ì–æ–ª–æ—Å–æ–≤–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:**
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç –æ–∑–≤—É—á–∏–≤–∞–µ—Ç: "Message to {recipient}: '{content}'. Sent successfully."

### 3.4 Token Usage Tracking (F-2025-019)

–°–µ—Ä–≤–µ—Ä —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ LLM –æ—Ç –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- **Source of Truth**: –¢–∞–±–ª–∏—Ü–∞ `token_usage` –≤ PostgreSQL.
- **Service**: `TokenUsageTracker` ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
- **Repository**: `TokenUsageRepository` ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ –ë–î.

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
1. **Main LLM**: `LangChainGeminiProvider` (—á–µ—Ä–µ–∑ `usage_metadata` –æ—Ç–≤–µ—Ç–∞).
2. **Memory Analyzer**: `MemoryAnalyzer` (–∞–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏ –≤ —Ñ–æ–Ω–µ).
3. **Browser Agent**: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ gRPC `ReportUsage` –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á.

**–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:**
- –°–∫—Ä–∏–ø—Ç `server/scripts/report_token_costs.py` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

## 4. gRPC –æ—Å—å

### 4.1 –ü—Ä–æ—Ç–æ–∫–æ–ª –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

- –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π proto-—Ñ–∞–π–ª: `server/server/modules/grpc_service/streaming.proto` (–Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö).
- –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Python-—Å—Ç–∞–±–æ–≤:
  ```bash
  cd server/server/modules/grpc_service
  python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. streaming.proto
  ```
- –õ—é–±–æ–µ breaking-–∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí –Ω–æ–≤—ã–π `StreamingServiceV2` + feature-flag + 2 —Ä–µ–ª–∏–∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–æ–ø–∏—Å–∞–Ω–æ –≤ `server/Docs/GRPC_PROTOCOL_AUDIT.md`).

### 4.2 –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å API

- RPC: `StreamAudio` (bidirectional stream), `InterruptSession` (unary-unary).
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ `server/Docs/GRPC_PROTOCOL_AUDIT.md`; CI (`server/Docs/CI_GRPC_CHECKS.md`) –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å –ø–æ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ proto –∏ smoke-—Ç–µ—Å—Ç–∞–º.
- –õ—é–±–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ –∫–∞–Ω–æ–Ω–µ.

### 4.3 Error Taxonomy

| error_type | gRPC code | –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ |
| --- | --- | --- |
| `timeout` | `DEADLINE_EXCEEDED` | Retry with backoff |
| `unavailable` | `UNAVAILABLE` | Retry exponential |
| `cancelled_by_user` | `CANCELLED` | Stop UX, no retry |
| `stream_limit_exceeded` | `RESOURCE_EXHAUSTED` | Backoff 60s ‚Üí retry |
| `rate_limit_exceeded` | `RESOURCE_EXHAUSTED` | Throttle locally ‚Üí retry |
| `validation_failed` | `INVALID_ARGUMENT` | Fix payload, no retry |
| `internal` | `INTERNAL` | Surface error, retry once |

### 4.4 LoggingInterceptor

- –§–∞–π–ª: `modules/grpc_service/core/grpc_interceptor.py`. –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç callables —á–µ—Ä–µ–∑ `_replace`, –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (`rpc_method_handler` ‚Äî namedtuple).
- –í –ª–æ–≥–∞—Ö –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç: `scope=grpc`, `method=/streaming.StreamingService/...`, `decision=start|abort|complete`, `ctx` —Å–æ —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.
- –û—à–∏–±–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `ErrorCodeMapper`; transient –æ—à–∏–±–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `decision=error`, `error_classified=transient`.
- –õ—é–±–æ–π –Ω–æ–≤—ã–π RPC –æ–±—è–∑–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ LoggingInterceptor. –í –æ–±—Ö–æ–¥–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è ADR + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `server/Docs/CI_GRPC_CHECKS.md`.

–¢–∞–±–ª–∏—Ü–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –≤ `server/server/modules/grpc_service/core/grpc_interceptor.py`. –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤—É—Ö –º–µ—Å—Ç.

---

## 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ñ–ª–∞–≥–∏

–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî `server/server/config/unified_config.py`. –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤ `server/server/config/unified_config.yaml`.

| –ö–ª—é—á | –¢–∏–ø | dev | stage | prod | Env override |
| --- | --- | --- | --- | --- | --- |
| `grpc.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `GRPC_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `grpc.port` | int | 50051 | 50051 | 50051 | `GRPC_PORT` |
| `grpc.max_workers` | int | 10 | ‚Äî (inherit prod) | 100 | `MAX_WORKERS` |
| `http.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `HTTP_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `http.port` | int | 8080 | 8080 | 8080 | `HTTP_PORT` |
| `backpressure.max_concurrent_streams` | int | 10 | 25 | 50 | `BACKPRESSURE_MAX_STREAMS` |
| `backpressure.max_message_rate_per_second` | int | 5 | 8 | 0 | `BACKPRESSURE_MAX_RATE` (0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ) |
| `backpressure.idle_timeout_seconds` | int | 60 | 180 | 900 | `BACKPRESSURE_IDLE_TIMEOUT` (15 –º–∏–Ω—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö TTS) |
| `features.use_module_coordinator` | bool | true | true | true | `USE_MODULE_COORDINATOR` |
| `kill_switches.disable_module_coordinator` | bool | false | false | false | `NEXY_KS_DISABLE_MODULE_COORDINATOR` |
| `update.host` | string | `0.0.0.0` | `127.0.0.1` | `127.0.0.1` | `UPDATE_HOST` (`auto` = –ø–æ `NEXY_ENV`) |
| `update.port` | int | 8081 | 8081 | 8081 | `UPDATE_PORT` |

> Stage –Ω–∞—Å–ª–µ–¥—É–µ—Ç prod –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è `grpc.host`/`http.host`/`update.host` –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è `NEXY_ENV`: dev ‚Üí `0.0.0.0` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, stage/prod ‚Üí `127.0.0.1` (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ Nginx –Ω–∞ 443). –ó–Ω–∞—á–µ–Ω–∏–µ `auto` –≤ `config.env` –æ–∑–Ω–∞—á–∞–µ—Ç ¬´–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç –ø–æ –æ–∫—Ä—É–∂–µ–Ω–∏—é¬ª. –í—Å–µ overrides –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ unified_config + env, –ø—Ä—è–º—ã—Ö setdefault –≤ –∫–æ–¥–µ –Ω–µ—Ç.

Backpressure –ª–∏–º–∏—Ç—ã, error-–∫–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—Ç–ª–∞–¥–∫–µ ‚Äî –≤ `server/Docs/BACKPRESSURE_README.md`.

### 5.1 Feature Flags Architecture (Server-Side)

–°–µ—Ä–≤–µ—Ä –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Feature Flags –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π LLM –∏ —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.

**1. Modular Prompt Engineering:**
- `unified_config.py` —Å–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏.
- –ï—Å–ª–∏ `MESSAGES_ENABLED=false` ‚Üí —Å–µ–∫—Ü–∏—è "Messages" –≤—ã—Ä–µ–∑–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–æ–º–ø—Ç–∞.
- –ï—Å–ª–∏ `SUBSCRIPTION_ENABLED=false` ‚Üí —Å–µ–∫—Ü–∏—è "Subscriptions" –≤—ã—Ä–µ–∑–∞–µ—Ç—Å—è.

**2. Command Validator:**
- `ResponseValidator` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É –æ—Ç LLM.
- `allowed_commands` —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ `FeaturesConfig`.
- –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `read_messages` –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ –≤—ã–∑—ã–≤–∞–µ—Ç `ValidationError` (–∑–∞—â–∏—Ç–∞ –æ—Ç "–≤–∑–ª–æ–º–∞" –ø—Ä–æ–º–ø—Ç–∞).

---

## 6. –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ fail-fast

- **Decision-–ª–æ–≥–∏**: —Ñ–æ—Ä–º–∞—Ç `ts=<iso> level=<lvl> scope=<module> method=<rpc> decision=<event> ctx=<json> dur_ms=<int>`. –õ–æ–≥–∏ –±–µ–∑ `decision` —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∫–∞–Ω–æ–Ω–∞.
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ (API –∫–ª—é—á–∏, –ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã)
  - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `utils/logging_formatter.py`
- **–ú–µ—Ç—Ä–∏–∫–∏ (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 60s)**:
  - `p95_latency_ms{rpc}` ‚Äî 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ RPC –º–µ—Ç–æ–¥–∞–º
  - `error_rate{rpc}` ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ –ø–æ –º–µ—Ç–æ–¥–∞–º
  - `backpressure_refusal_rate` ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –æ—Ç–∫–∞–∑–æ–≤ –∏–∑-–∑–∞ backpressure
  - `decision_rate{type}` ‚Äî —á–∞—Å—Ç–æ—Ç–∞ —Ä–µ—à–µ–Ω–∏–π (start/abort/retry/degrade/complete)
  - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `utils/metrics_collector.py`
  - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
  - –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏ graceful shutdown
- **–ì–≤–∞—Ä–¥—Ä–∞–π–ª—ã CI** (`server/Docs/CI_GRPC_CHECKS.md`):
  - regen proto ‚Üí diff –∑–∞–ø—Ä–µ—Ç–æ–≤
  - smoke-—Ç–µ—Å—Ç—ã (`python scripts/grpc_smoke.py --host 127.0.0.1 --port 50051`)
  - health/–ø–æ—Ä—Ç/–≤–µ—Ä—Å–∏—è (`python scripts/check_grpc_health.py`)
  - Cache-Control –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`curl -I https://<host>/updates/appcast.xml | grep 'Cache-Control'`)
  - validate release size (`scripts/validate_updates.sh`)

---

## 7. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å, ingress –∏ shutdown

- **Ingress**: –æ–¥–∏–Ω –ø—É–±–ª–∏—á–Ω—ã–π –≤—Ö–æ–¥ ‚Äî HTTPS:443 —á–µ—Ä–µ–∑ Nginx (`/etc/nginx/sites-available/nexy`). –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ `127.0.0.1:50051`, `127.0.0.1:8080`, `127.0.0.1:8081` —Å–ª—É—à–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ localhost –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ.
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ—Å—Ç—É–ø–∞:**
  - –ü—É–±–ª–∏—á–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ prod: `https://20.63.24.187` (IP –∑–∞–∫—Ä–µ–ø–ª—ë–Ω –∑–∞ Nexy Server –≤ Azure)
  - –ó–Ω–∞—á–µ–Ω–∏–µ `NEXY_ENV=prod` –∏–ª–∏ `stage` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ä–µ–∂–∏–º `127.0.0.1`. –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ (`NEXY_ENV=dev`) —Ö–æ—Å—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.0.0.0`.
  - –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø: —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Nginx –Ω–∞ –ø–æ—Ä—Ç—É 443 (HTTPS, HTTP/2)
  - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã: 8080 (HTTP health/status), 50051 (gRPC), 8081 (Update Server) ‚Äî —Ç–æ–ª—å–∫–æ localhost (`127.0.0.1`)
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/health` ‚Üí `http://127.0.0.1:8080/health`
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/status` ‚Üí `http://127.0.0.1:8080/status`
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/` (gRPC) ‚Üí `grpc://127.0.0.1:50051`
  - Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç: `https://<host>/updates/*` ‚Üí `http://127.0.0.1:8081/*`
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx (–∫—Ä–∏—Ç–∏—á–Ω–æ):**
  - `location /health` –∏ `/status` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–ø–µ—Ä–µ–¥** `location /`
  - –ò–Ω–∞—á–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ø–∞–¥—É—Ç –≤ gRPC –ø—Ä–æ–∫—Å–∏ –≤–º–µ—Å—Ç–æ HTTP –ø—Ä–æ–∫—Å–∏, —á—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É 502 Bad Gateway
  - –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: `server/Docs/SERVER_DEPLOYMENT_GUIDE.md`
- **Cache-Control**: `/updates/appcast.xml` ‚Äî `max-age=60`, `/updates/health` ‚Äî `max-age=30`, `/health` ‚Äî `max-age=30`. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é (curl) –∏ –≤ smoke-checks CI.
- **Backpressure**: –æ—à–∏–±–∫–∏ `stream_limit_exceeded`/`rate_limit_exceeded` –º–∞–ø—è—Ç—Å—è –Ω–∞ `RESOURCE_EXHAUSTED` (—Å–º. —Ç–∞–±–ª–∏—Ü—É). –õ–∏–º–∏—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ unified_config.
  - **–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (prod):**
    - `max_concurrent_streams`: 50
    - `idle_timeout_seconds`: 900 (15 –º–∏–Ω—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö TTS –æ—Ç–≤–µ—Ç–æ–≤)
    - `max_message_rate_per_second`: 0 (–æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –∞—É–¥–∏–æ —Å—Ç—Ä–∏–º–æ–≤)
    - `grace_period_seconds`: 30
- **Graceful shutdown**: –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º SIGTERM/SIGINT, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backpressure manager, –ª–æ–≥–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–≥—Ä–µ–≥–∞—Ç –º–µ—Ç—Ä–∏–∫, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∏–º—ã. –ù–∞—Ä—É—à–µ–Ω–∏–µ ‚Äî –±–ª–æ–∫–µ—Ä –¥–ª—è —Ä–µ–ª–∏–∑–∞.
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `ts=... level=INFO scope=grpc method=... decision=... ctx={...} dur_ms=...`. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ (API –∫–ª—é—á–∏, –ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã).
- **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä P95 latency, error rate, decision rate –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥. –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏ graceful shutdown.
- **–ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** –≤ `StreamAudio`: IO —á–µ—Ä–µ–∑ async-–æ–±—ë—Ä—Ç–∫–∏, CPU ‚Äî threadpool —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º concurrency –∏–∑ unified_config.
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (11 —è–Ω–≤–∞—Ä—è 2026):**
  - Backpressure Manager: —É–≤–µ–ª–∏—á–µ–Ω `idle_timeout_seconds` –¥–æ 900 —Å–µ–∫—É–Ω–¥ (15 –º–∏–Ω—É—Ç) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö TTS –æ—Ç–≤–µ—Ç–æ–≤
  - Backpressure Manager: –æ—Ç–∫–ª—é—á–µ–Ω `max_message_rate_per_second` (0) –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∞—É–¥–∏–æ —Å—Ç—Ä–∏–º–æ–≤
  - Graceful Shutdown: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ backpressure manager –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö
  - –ú–µ—Ç—Ä–∏–∫–∏: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥

---

## 8. –†–æ–ª–ª–∞—É—Ç –∏ ¬´–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å¬ª

- Feature-flag first: –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ >2 –æ—Å–µ–π ‚Äî –ø–æ–¥ —Ñ–ª–∞–≥ + kill-switch + –∫–∞–Ω–∞—Ä–µ–µ—á–Ω—ã–π –ø–ª–∞–Ω (1% ‚Üí 25% ‚Üí 50% ‚Üí 100%).
- SIMPLE-–≥–µ–π—Ç ‚â§60 LOC/1 —Ñ–∞–π–ª + 2 —Ç–µ—Å—Ç–∞. Impact-–≥–µ–π—Ç —Ç—Ä–µ–±—É–µ—Ç `change_impact.yaml`, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `STATE_CATALOG`, 8‚Äì14 pairwise —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã.
- ¬´–ì–æ—Ç–æ–≤–æ¬ª = —á–µ–∫–ª–∏—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, SLO –≤ –Ω–æ—Ä–º–µ (`p95_latency_ms(StreamAudio) ‚â§ 1000`, `error_rate(StreamAudio) ‚â§ 5%`), –º–µ—Ç—Ä–∏–∫–∏ –≤ dashboards.
- Canary guardrails: jq one-liners –∏–∑ `scripts/` (–æ—à–∏–±–∫–∏/—Ä–µ—à–µ–Ω–∏—è/latency) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏.

---

## 9. –°—Å—ã–ª–∫–∏

- `server/Docs/SERVER_DEVELOPMENT_RULES.md` ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–µ –≥–µ–π—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `server/Docs/SERVER_DEPLOYMENT_GUIDE.md` ‚Äî –¥–µ–ø–ª–æ–π, HTTPS ingress, smoke-–ø—Ä–æ–≤–µ—Ä–∫–∏
- `server/Docs/BACKPRESSURE_README.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –æ—Ç–ª–∞–¥–∫–∞
- `server/Docs/DATABASE_SETUP_GUIDE.md` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –∏ hardening
- `server/Docs/DB_BACKUP_AND_RESTORE_RUNBOOK.md` ‚Äî backup/restore/restore-drill –∫–∞–Ω–æ–Ω
- `server/Docs/STATE_CATALOG.md` ‚Äî –∫–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã
- `server/Docs/CI_GRPC_CHECKS.md` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ CI-—Å—Ç–∞–¥–∏–∏
- `server/Docs/_archive/ARCHITECTURE_ALIGNMENT_CHECK.md` ‚Äî –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –∫–æ–¥–∞
