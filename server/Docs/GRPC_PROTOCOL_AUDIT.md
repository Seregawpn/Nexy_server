# gRPC Protocol Audit - PR-3

**Дата:** 3 октября 2025  
**Цель:** Фиксация текущего состояния `streaming.proto` и правил совместимости

**Источник истины по Flow и контрактам событий:** [`Docs/FLOW_INTERACTION_SPEC.md`](FLOW_INTERACTION_SPEC.md) — канонический документ по серверным Flow и gRPC контрактам. Этот документ (GRPC_PROTOCOL_AUDIT) содержит только аудит протокола, риски и изменения; полные flow и контракты событий описаны в каноне.

---

## Текущее состояние `streaming.proto`

### Версия протокола
- **Синтаксис:** `proto3`
- **Пакет:** `streaming`
- **Сервис:** `StreamingService`

---

## Таблица RPC методов

| **RPC Метод** | **Тип** | **Запрос** | **Ответ** | **Статус** |
|---------------|---------|-----------|-----------|------------|
| `StreamAudio` | `unary_stream` | `StreamRequest` | `stream StreamResponse` | ✅ Активен |
| `InterruptSession` | `unary_unary` | `InterruptRequest` | `InterruptResponse` | ✅ Активен |
| `ReportUsage` | `unary_unary` | `UsageRequest` | `UsageResponse` | ✅ Активен |

---

## Таблица полей сообщений

### `StreamRequest`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `prompt` | `string` | 1 | ✅ required | Текстовая команда пользователя | ❌ Нельзя менять |
| `screenshot` | `optional string` | 2 | ⚪ optional | Base64 WebP скриншот | ✅ Можно добавить новые optional поля |
| `screen_width` | `optional int32` | 3 | ⚪ optional | Ширина экрана | ✅ Можно добавить новые optional поля |
| `screen_height` | `optional int32` | 4 | ⚪ optional | Высота экрана | ✅ Можно добавить новые optional поля |
| `hardware_id` | `string` | 5 | ✅ required | Hardware ID (не может быть пустым или "unknown") | ❌ Нельзя менять |
| `session_id` | `string` | 6 | ✅ required* | ID сессии (обязателен с 2026-01-12, см. CHANGELOG.md) | ❌ Нельзя менять |

**Примечания:**
- `*` `session_id` технически не имеет `optional` в proto (убрано в 2026-01-12), но из-за ограничений proto3 все поля остаются optional на уровне wire format. Однако **обязателен на уровне сервера** — сервер возвращает `INVALID_ARGUMENT` при отсутствии. См. раздел "Breaking Changes" ниже.

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля (новые теги: 7, 8, 9...)
- ❌ Нельзя удалять существующие поля
- ❌ Нельзя менять типы существующих полей
- ❌ Нельзя делать `required` поля `optional` (breaking change)

---

### `StreamResponse`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `content` | `oneof` | - | ✅ required | Контейнер контента | ❌ Нельзя менять |
| `text_chunk` | `string` | 1 | ⚪ (в oneof) | Текстовый чанк | ✅ Можно добавить новые варианты в oneof |
| `audio_chunk` | `AudioChunk` | 2 | ⚪ (в oneof) | Аудио чанк | ✅ Можно добавить новые варианты в oneof |
| `end_message` | `string` | 3 | ⚪ (в oneof) | Сообщение о завершении | ✅ Можно добавить новые варианты в oneof |
| `error_message` | `string` | 4 | ⚪ (в oneof) | Сообщение об ошибке | ✅ Можно добавить новые варианты в oneof |

**Правила изменения:**
- ✅ Можно добавлять новые варианты в `oneof content` (новые теги: 5, 6, 7...)
- ❌ Нельзя удалять существующие варианты
- ❌ Нельзя менять типы существующих вариантов

---

### `AudioChunk`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `audio_data` | `bytes` | 1 | ✅ required | Аудио данные | ❌ Нельзя менять |
| `dtype` | `string` | 2 | ✅ required | Тип данных (например, 'int16') | ❌ Нельзя менять |
| `shape` | `repeated int32` | 3 | ⚪ optional | Форма массива | ✅ Можно добавить новые optional поля |

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля (новые теги: 4, 5, 6...)
- ❌ Нельзя удалять существующие поля
- ❌ Нельзя менять типы существующих полей

---

### `InterruptRequest`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `hardware_id` | `string` | 1 | ✅ required | Hardware ID для прерывания | ❌ Нельзя менять |

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля (новые теги: 2, 3, 4...)
- ❌ Нельзя удалять существующие поля
- ❌ Нельзя менять типы существующих полей

---

### `InterruptResponse`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `success` | `bool` | 1 | ✅ required | Успешность операции | ❌ Нельзя менять |
| `interrupted_sessions` | `repeated string` | 2 | ⚪ optional | Список прерванных сессий | ✅ Можно добавить новые optional поля |
| `message` | `string` | 3 | ✅ required | Сообщение о результате | ❌ Нельзя менять |

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля (новые теги: 4, 5, 6...)
- ❌ Нельзя удалять существующие поля
- ❌ Нельзя менять типы существующих полей

---

---

### `UsageRequest`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `hardware_id` | `string` | 1 | ✅ required | Hardware ID | ❌ Нельзя менять |
| `source` | `string` | 2 | ✅ required | Источник (`main_llm`, `browser_agent`, etc.) | ❌ Нельзя менять |
| `input_tokens` | `int32` | 3 | ✅ required | Входящие токены | ❌ Нельзя менять |
| `output_tokens` | `int32` | 4 | ✅ required | Исходящие токены | ❌ Нельзя менять |
| `session_id` | `optional string` | 5 | ⚪ optional | ID сессии | ✅ Можно добавить |
| `model_name` | `optional string` | 6 | ⚪ optional | Имя модели | ✅ Можно добавить |

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля
- ❌ Нельзя удалять существующие поля

---

### `UsageResponse`

| **Поле** | **Тип** | **Тег** | **Обязательность** | **Описание** | **Расширяемость** |
|----------|---------|---------|-------------------|--------------|-------------------|
| `success` | `bool` | 1 | ✅ required | Успешность операции | ❌ Нельзя менять |
| `message` | `string` | 2 | ✅ required | Сообщение о результате | ❌ Нельзя менять |

**Правила изменения:**
- ✅ Можно добавлять новые `optional` поля
- ❌ Нельзя удалять существующие поля

---

## Правила совместимости (Backward Compatibility)

### ✅ Разрешённые изменения

1. **Добавление новых optional полей** в существующие сообщения
   - Новые поля должны иметь уникальные теги (не пересекаться с существующими)
   - Новые поля должны быть `optional`
   - Пример: добавление `optional string metadata = 7;` в `StreamRequest`

2. **Добавление новых RPC методов** в сервис
   - Новые методы не должны конфликтовать с существующими
   - Пример: добавление `rpc HealthCheck(HealthRequest) returns (HealthResponse);`

3. **Добавление новых вариантов в oneof**
   - Новые варианты должны иметь уникальные теги
   - Пример: добавление `string status_update = 5;` в `oneof content` в `StreamResponse`

4. **Добавление новых сообщений**
   - Новые сообщения могут использоваться в новых RPC методах

### ❌ Запрещённые изменения (Breaking Changes)

1. **Удаление полей** из существующих сообщений
2. **Изменение типов полей** (например, `string` → `int32`)
3. **Изменение тегов полей** (например, `tag 1` → `tag 2`)
4. **Превращение optional в required** или наоборот
5. **Удаление RPC методов** из сервиса
6. **Изменение сигнатуры RPC методов** (типы запроса/ответа)

### Стратегия для Breaking Changes

Если требуется breaking change:

1. **Создать новый сервис/метод с версией `v2`**
   - Пример: `StreamingServiceV2` или `StreamAudioV2`
   - Старый сервис/метод остаётся активным минимум 2 релиза

2. **Добавить feature-flag в `unified_config`**
   - Пример: `features.use_streaming_v2: true`
   - Kill-switch: `kill_switches.disable_streaming_v2: true`

3. **Документировать миграцию**
   - В `ARCHITECTURE_OVERVIEW.md` описать стратегию миграции
   - В `CHANGELOG.md` или `CURRENT_STATUS_REPORT.md` зафиксировать изменения

4. **Поддержка обеих версий**
   - Минимум 2 релиза поддерживаются параллельно
   - После 2 релизов можно удалить старую версию

---

## Текущий статус изменений

### Breaking Changes (2026-01-12)

#### 1. Строгий контракт `session_id`
- **Статус:** ✅ Реализовано
- **Описание:** В proto `session_id` помечен как `string session_id = 6` с комментарием `REQUIRED` (из-за ограничений proto3 нельзя сделать поле действительно required, но сервер **требует его обязательно** для корректной работы системы).
- **Причина:** Единый источник истины для `session_id` — `InputProcessingIntegration` на клиенте. Fallback-генерация на сервере нарушает архитектуру и создаёт риск рассинхрона.
- **Поведение:** Сервер возвращает `INVALID_ARGUMENT` с `error_message: "session_id is required and must be provided by client"` при отсутствии `session_id`.
- **Миграция:** Все клиенты должны обновляться до версии с поддержкой обязательного `session_id`.

#### 2. Строгий контракт `hardware_id`
- **Статус:** ✅ Реализовано
- **Описание:** `hardware_id` не может быть пустым или "unknown".
- **Поведение:** Сервер возвращает `INVALID_ARGUMENT` при пустом или "unknown" значении.
- **Миграция:** Все клиенты должны передавать валидный `hardware_id`.

#### 3. Исправление контракта `InterruptResponse`
- **Статус:** ✅ Реализовано
- **Описание:** Исправлено использование поля `message` вместо несуществующего `error_message` в `InterruptResponse`.
- **Поведение:** Все ответы `InterruptResponse` используют поле `message` согласно proto-контракту.

### Запланированные изменения
- **Нет новых breaking changes** в планах
- Все поля совместимы с proto3
- Все optional поля поддерживают расширяемость

### Документация миграции
- См. `Docs/CHANGELOG.md` для деталей breaking changes
- См. `Docs/assistant_exchange/cursor/2026-01-12__review__server-identifier-contract.md` для анализа и рекомендаций

### Рекомендации для будущих изменений

1. **Добавление metadata в StreamRequest** (optional поле)
   - Тег: 7
   - Тип: `optional string metadata = 7;`
   - Не ломает существующих клиентов

2. **Добавление HealthCheck RPC**
   - Новый метод: `rpc HealthCheck(HealthRequest) returns (HealthResponse);`
   - Новые сообщения: `HealthRequest`, `HealthResponse`
   - Не ломает существующие методы

---

## Проверка совместимости

### Автоматические проверки

1. **Smoke-тест:** `scripts/grpc_smoke.py`
   - Подключение к серверу
   - Вызов базового RPC
   - Валидация ответа

2. **CI проверки:**
   - Health endpoint: `curl http://20.63.24.187/health` → 200 OK
   - Status endpoint: `curl http://20.63.24.187/status` → JSON
   - Port check: `nc -zv 20.63.24.187 50051` → порт слушает

3. **Версии и размеры:**
   - Health версии совпадают с AppCast
   - Размеры артефактов совпадают с GitHub

---

---

## Контракт-таблицы (PR-6)

### Таблица контракта для `StreamAudio`

| **Вход** | **Выход** | **Коды ошибок** | **Задержка** | **Примечания** |
|----------|----------|----------------|--------------|----------------|
| `prompt="test"`, `hardware_id="valid"` | `text_chunk` → `audio_chunk` → `end_message` | - | p95 ≤ 600ms | Успешный сценарий |
| `prompt=""`, `hardware_id="valid"` | `error_message="Prompt required"` | `INVALID_ARGUMENT` | < 100ms | Валидация входных данных |
| `prompt="test"`, `hardware_id=""` | `error_message="Hardware ID required"` | `INVALID_ARGUMENT` | < 100ms | Валидация входных данных |
| `prompt="test"`, `hardware_id="invalid"` | `error_message="Internal error"` | `INTERNAL` | < 500ms | Ошибка обработки |
| `prompt="test"`, `hardware_id="valid"`, `screenshot="base64..."` | `text_chunk` → `audio_chunk` → `end_message` | - | p95 ≤ 800ms | С изображением |
| Сервер недоступен | `error_message="Connection failed"` | `UNAVAILABLE` | Таймаут 10s | Сетевая ошибка |

**Правила:**
- Все обязательные поля (`prompt`, `hardware_id`) должны быть валидированы
- Optional поля (`screenshot`, `screen_width`, `screen_height`, `session_id`) могут отсутствовать
- Ответ всегда в формате `StreamResponse` с `oneof content`
- Ошибки возвращаются через `error_message` в `StreamResponse`

---

### Таблица контракта для `InterruptSession`

| **Вход** | **Выход** | **Коды ошибок** | **Задержка** | **Примечания** |
|----------|----------|----------------|--------------|----------------|
| `hardware_id="valid"` | `success=true`, `interrupted_sessions=["session1"]`, `message="Sessions interrupted"` | - | < 100ms | Успешное прерывание |
| `hardware_id=""` | `success=false`, `message="Hardware ID required"` | `INVALID_ARGUMENT` | < 50ms | Валидация входных данных |
| `hardware_id="invalid"` | `success=false`, `message="No active sessions found"` | - | < 100ms | Нет активных сессий |
| Сервер недоступен | `success=false`, `message="Connection failed"` | `UNAVAILABLE` | Таймаут 5s | Сетевая ошибка |

**Правила:**
- `hardware_id` обязателен
- `success` всегда возвращается (boolean)
- `interrupted_sessions` - список прерванных сессий (может быть пустым)
- `message` - человекочитаемое сообщение о результате

---

### Таблица контракта для ошибок

| **Код ошибки** | **Описание** | **Когда возникает** | **Действие клиента** |
|----------------|--------------|---------------------|---------------------|
| `INVALID_ARGUMENT` | Невалидные входные данные | Отсутствуют обязательные поля | Исправить запрос |
| `UNAVAILABLE` | Сервер недоступен | Сетевая ошибка, таймаут | Повторить запрос с backoff |
| `INTERNAL` | Внутренняя ошибка сервера | Ошибка обработки на сервере | Логировать, повторить позже |
| `NOT_FOUND` | Ресурс не найден | Сессия/модуль не найден | Проверить входные данные |
| `DEADLINE_EXCEEDED` | Превышен таймаут | Запрос занял слишком много времени | Увеличить таймаут или упростить запрос |

**Правила:**
- Все ошибки возвращаются через gRPC status codes
- Дополнительная информация в `error_message` в `StreamResponse`
- Клиент должен обрабатывать все коды ошибок

---

## Ссылки

- `server/modules/grpc_service/streaming.proto` — исходный протокол
- `Docs/SERVER_DEVELOPMENT_RULES.md` — правила разработки сервера
- `Docs/ARCHITECTURE_OVERVIEW.md` — обзор архитектуры
- `Docs/PR_CHECKLIST_TEMPLATE.md` — чек-лист PR
- `scripts/grpc_smoke.py` — smoke-тест для проверки контракта
