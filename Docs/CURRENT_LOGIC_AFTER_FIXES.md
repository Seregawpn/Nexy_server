# –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## üéØ –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
- ‚úÖ –ï–¥–∏–Ω–æ–ª–∏—á–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º (AVF)
- ‚úÖ –Ø–≤–Ω–∞—è —ç—Å—Ç–∞—Ñ–µ—Ç–∞ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ speech_recognition
- ‚úÖ Legacy fallback —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ result.data –ø—É—Å—Ç–æ–π

---

## üìã –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

### –≠—Ç–∞–ø 1: –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ (`voice.recording_start`)

```python
_on_recording_start(event)
    ‚Üì
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   ‚îú‚îÄ if _first_run_in_progress ‚Üí return (–±–ª–æ–∫–∏—Ä—É–µ–º)
   ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
    ‚Üì
2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Å—Å–∏–∏
   ‚îú‚îÄ _set_session_id(session_id, "recording_start")
   ‚îú‚îÄ _recording_active = True
   ‚îî‚îÄ _processed_mic_data_sessions.discard(session_id)  # ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ñ–ª–∞–≥–∞
    ‚Üì
3. –ó–∞–ø—É—Å–∫ AVF –∑–∞–ø–∏—Å–∏
   ‚îú‚îÄ _clear_audio_buffer()  # –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞
   ‚îî‚îÄ AVFAudioEngine.start_input()
       ‚îú‚îÄ AVF –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (–µ–¥–∏–Ω–æ–ª–∏—á–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ)
       ‚îú‚îÄ –°–±–æ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (device_info, format, diagnostics)
       ‚îî‚îÄ –ó–∞–ø–∏—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ AVF
- ‚úÖ –§–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π –æ—á–∏—â–µ–Ω
- ‚úÖ –ë—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è

---

### –≠—Ç–∞–ø 2: –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)

```python
AVFAudioEngine.recording_callback() (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞)
    ‚Üì
1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞
   ‚îú‚îÄ first_chunk: size, samples, min, max, mean, std, rms
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ _recording_diagnostics
    ‚Üì
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤
   ‚îú‚îÄ chunk_count += 1
   ‚îî‚îÄ total_bytes += len(chunk)
    ‚Üì
3. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   ‚îú‚îÄ AVF –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –≤ _recorded_audio[] (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å)
   ‚îî‚îÄ –ë—É—Ñ–µ—Ä –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –≤ _audio_buffer[] (fallback)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ê—É–¥–∏–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –≤ AVF
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
- ‚úÖ –ë—É—Ñ–µ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è (fallback)

---

### –≠—Ç–∞–ø 3: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ (`voice.recording_stop`)

```python
_on_recording_stop(event)
    ‚Üì
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
   ‚îú‚îÄ active_session_id == request_session_id?
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí return (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)
    ‚Üì
2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ AVF –∑–∞–ø–∏—Å–∏
   ‚îú‚îÄ result = AVFAudioEngine.stop_input()
   ‚îÇ   ‚îú‚îÄ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ engine
   ‚îÇ   ‚îú‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ tap
   ‚îÇ   ‚îú‚îÄ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ ‚Üí all_data
   ‚îÇ   ‚îî‚îÄ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ AudioInputResult (—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏)
   ‚îî‚îÄ AVF –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚úÖ
    ‚Üì
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω)
   ‚îú‚îÄ –ï—Å–ª–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   ‚îî‚îÄ streaming_processed = True/False
    ‚Üì
4. ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
   ‚îú‚îÄ if result.data and len(result.data) > 0:
   ‚îÇ   ‚îî‚îÄ ‚úÖ –û–°–ù–û–í–ù–û–ô –ü–£–¢–¨: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ
   ‚îÇ       ‚îî‚îÄ await _publish_mic_data_ready(result, session_id)
   ‚îÇ           ‚îî‚îÄ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä –∑–¥–µ—Å—å
   ‚îÇ
   ‚îî‚îÄ elif _audio_buffer and not streaming_processed:
       ‚îî‚îÄ ‚úÖ LEGACY FALLBACK: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä
           ‚îî‚îÄ await _recognize_avf_audio(total_audio, ...)
    ‚Üì
5. –û—á–∏—Å—Ç–∫–∞ (–≤ finally)
   ‚îî‚îÄ _clear_audio_buffer()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
- ‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å)
- ‚úÖ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä (legacy fallback)
- ‚úÖ –ù–µ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

---

### –≠—Ç–∞–ø 4: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è (`_publish_mic_data_ready`)

```python
_publish_mic_data_ready(result, session_id)
    ‚Üì
1. ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
   ‚îú‚îÄ if not result.data or len(result.data) == 0:
   ‚îÇ   ‚îî‚îÄ logger.warning + return  # –ù–ï –ø—É–±–ª–∏–∫—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
   ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
    ‚Üì
2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload
   ‚îú‚îÄ session_id
   ‚îú‚îÄ pcm_bytes: result.data
   ‚îú‚îÄ sample_rate: result.sample_rate
   ‚îú‚îÄ channels: result.channels
   ‚îú‚îÄ duration_ms: result.duration_ms
   ‚îú‚îÄ frames_recorded: result.frames_recorded
   ‚îú‚îÄ device_info: {...}
   ‚îú‚îÄ input_format: {...}
   ‚îî‚îÄ diagnostics: {...}
    ‚Üì
3. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è
   ‚îî‚îÄ event_bus.publish("voice.mic_data_ready", payload)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Payload —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

---

### –≠—Ç–∞–ø 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Å—Ç–∞—Ñ–µ—Ç—ã (`voice.mic_data_ready`)

```python
_on_mic_data_ready(event) [–ø–æ–¥–ø–∏—Å–∞–Ω —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º HIGH]
    ‚Üì
1. ‚úÖ –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ô –û–ë–†–ê–ë–û–¢–ö–ò
   ‚îú‚îÄ if session_id in _processed_mic_data_sessions:
   ‚îÇ   ‚îî‚îÄ logger.warning + return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç
   ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
    ‚Üì
2. –ü–æ–º–µ—á–∞–µ–º —Å–µ—Å—Å–∏—é
   ‚îî‚îÄ _processed_mic_data_sessions.add(session_id)
    ‚Üì
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ payload
   ‚îú‚îÄ pcm_bytes, sample_rate, channels
   ‚îú‚îÄ device_info, input_format, diagnostics
   ‚îî‚îÄ session_id
    ‚Üì
4. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
   ‚îú‚îÄ if pcm_bytes and sample_rate and channels:
   ‚îÇ   ‚îî‚îÄ await _recognize_avf_audio(pcm_bytes, sample_rate, channels, session_id)
   ‚îÇ       ‚îî‚îÄ finally: _processed_mic_data_sessions.discard(session_id)
   ‚îî‚îÄ else:
       ‚îî‚îÄ –û—à–∏–±–∫–∞: –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–µ—Å—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –§–ª–∞–≥ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

### –≠—Ç–∞–ø 6: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (`_recognize_avf_audio`)

```python
_recognize_avf_audio(audio_data, sample_rate, channels, session_id)
    ‚Üì
1. –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   ‚îú‚îÄ if sample_rate != 16000:
   ‚îÇ   ‚îî‚îÄ audio_bytes_int16 = resample_to_16khz(audio_data, sample_rate)
   ‚îî‚îÄ sample_rate = 16000
    ‚Üì
2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   ‚îî‚îÄ float32 ‚Üí int16
    ‚Üì
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ Recognizer
   ‚îú‚îÄ if _use_avf:
   ‚îÇ   ‚îî‚îÄ recognizer = sr.Recognizer()  # ‚úÖ –ù–æ–≤—ã–π Recognizer
   ‚îî‚îÄ else:
       ‚îî‚îÄ recognizer = self._recognizer.recognizer  # Legacy
    ‚Üì
4. –°–æ–∑–¥–∞–Ω–∏–µ AudioData –æ–±—ä–µ–∫—Ç–∞
   ‚îî‚îÄ audio_data_obj = sr.AudioData(audio_bytes_int16, sample_rate, 2)
    ‚Üì
5. –í—ã–∑–æ–≤ recognize_google()
   ‚îú‚îÄ text = recognizer.recognize_google(audio_data_obj, language)
   ‚îÇ   ‚îî‚îÄ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç Google Speech API
   ‚îî‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (UnknownValueError, RequestError)
    ‚Üì
6. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   ‚îú‚îÄ –£—Å–ø–µ—Ö: voice.recognition_completed {text, source: "avf_recognition"}
   ‚îî‚îÄ –û—à–∏–±–∫–∞: voice.recognition_failed {error, source: "avf_recognition"}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π Recognizer (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º self._recognizer)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ speech_recognition
- ‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç Google Speech API

---

## üîí –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£—Å–ª–æ–≤–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚ùå –ü—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å –≤—Å–µ–≥–¥–∞
await self._publish_mic_data_ready(result, session_id)
# –ü–æ—Ç–æ–º –º–æ–≥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –±—É—Ñ–µ—Ä ‚Üí –¥–≤–æ–π–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚úÖ –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
if result.data and len(result.data) > 0:
    await self._publish_mic_data_ready(result, session_id)
elif self._audio_buffer and not streaming_processed:
    # Legacy fallback —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
    await self._recognize_avf_audio(total_audio, ...)
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ _publish_mic_data_ready

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚ùå –ú–æ–≥–ª–∞ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
async def _publish_mic_data_ready(self, result, session_id):
    payload = {...}  # –ú–æ–≥–ª–∏ –±—ã—Ç—å –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    await self.event_bus.publish("voice.mic_data_ready", payload)
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
async def _publish_mic_data_ready(self, result, session_id):
    if not result.data or len(result.data) == 0:
        logger.warning("‚ö†Ô∏è result.data –ø—É—Å—Ç–æ–π, –Ω–µ –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ")
        return  # –ù–ï –ø—É–±–ª–∏–∫—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    payload = {...}
    await self.event_bus.publish("voice.mic_data_ready", payload)
```

---

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –¢–ï–ö–£–©–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. voice.recording_start
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ _on_recording_start()
       ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (first_run)
       ‚îú‚îÄ _set_session_id(session_id)
       ‚îú‚îÄ –û—á–∏—Å—Ç–∫–∞: _processed_mic_data_sessions.discard(session_id)
       ‚îú‚îÄ –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞: _clear_audio_buffer()
       ‚îî‚îÄ AVFAudioEngine.start_input()
           ‚îî‚îÄ AVF –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚úÖ

2. –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ AVFAudioEngine.recording_callback()
       ‚îú‚îÄ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ AVF
       ‚îú‚îÄ –°–±–æ—Ä –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
       ‚îî‚îÄ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä–µ (fallback)

3. voice.recording_stop
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ _on_recording_stop()
       ‚îú‚îÄ AVFAudioEngine.stop_input()
       ‚îÇ   ‚îî‚îÄ AVF –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚úÖ
       ‚îÇ
       ‚îú‚îÄ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
       ‚îÇ   ‚îú‚îÄ if result.data and len(result.data) > 0:
       ‚îÇ   ‚îÇ   ‚îî‚îÄ await _publish_mic_data_ready(result, session_id)
       ‚îÇ   ‚îÇ       ‚îî‚îÄ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä
       ‚îÇ   ‚îÇ
       ‚îÇ   ‚îî‚îÄ elif _audio_buffer and not streaming_processed:
       ‚îÇ       ‚îî‚îÄ Legacy fallback –∏–∑ –±—É—Ñ–µ—Ä–∞
       ‚îÇ
       ‚îî‚îÄ –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ (finally)

4. _publish_mic_data_ready
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
       ‚îú‚îÄ if not result.data or len(result.data) == 0:
       ‚îÇ   ‚îî‚îÄ return  # –ù–ï –ø—É–±–ª–∏–∫—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
       ‚îî‚îÄ event_bus.publish("voice.mic_data_ready", payload)

5. voice.mic_data_ready
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ _on_mic_data_ready()
       ‚îú‚îÄ ‚úÖ –ó–ê–©–ò–¢–ê: –ø—Ä–æ–≤–µ—Ä–∫–∞ _processed_mic_data_sessions
       ‚îÇ   ‚îî‚îÄ –ï—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è ‚Üí return
       ‚îÇ
       ‚îú‚îÄ –ü–æ–º–µ—á–∞–µ–º: _processed_mic_data_sessions.add(session_id)
       ‚îÇ
       ‚îî‚îÄ _recognize_avf_audio(...)
           ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ: sr.Recognizer() (–Ω–æ–≤—ã–π)
           ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ: sr.AudioData(...)
           ‚îú‚îÄ –í—ã–∑–æ–≤: recognizer.recognize_google(...)
           ‚îÇ   ‚îî‚îÄ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç Google Speech API
           ‚îî‚îÄ finally: _processed_mic_data_sessions.discard(session_id)

6. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è:
       ‚îú‚îÄ voice.recognition_completed {text, source: "avf_recognition"}
       ‚îî‚îÄ voice.recognition_failed {error, source: "avf_recognition"}
```

---

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã

1. **–ï–¥–∏–Ω–æ–ª–∏—á–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º**
   - ‚úÖ AVF ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü
   - ‚úÖ SpeechRecognition –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω

2. **–Ø–≤–Ω–∞—è —ç—Å—Ç–∞—Ñ–µ—Ç–∞**
   - ‚úÖ –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
   - ‚úÖ –ë—É—Ñ–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç

3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**
   - ‚úÖ –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
   - ‚úÖ –§–ª–∞–≥ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

4. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**
   - ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π Recognizer –ø—Ä–∏ AVF
   - ‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç Google Speech API

5. **Legacy fallback**
   - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ result.data –ø—É—Å—Ç–æ–π
   - ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—É—Ç—ë–º

---

## üéØ –ò—Ç–æ–≥

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- ‚úÖ –ù–µ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- ‚úÖ –ù–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ legacy fallback
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ï–¥–∏–Ω–æ–ª–∏—á–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º

