# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã: –ü—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã (audio_chunks=0)

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç `end_message` –±–µ–∑ `audio_chunks` (audio_chunks=0)
- `sent_any: false` –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞
- `segments=0, audio_chunks=0, total_bytes=0`
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ~335-336ms (–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ, –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Error rate –¥–ª—è StreamAudio: **25%** (2 –æ—à–∏–±–∫–∏ –∏–∑ 8 –∑–∞–ø—Ä–æ—Å–æ–≤)
- Total errors: 2
- Total requests: 8

---

## üîç –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

**Session 1:** `session_1768232380.537131_875ee23f`
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 336ms
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `sent_any: false`, `segments=0, audio_chunks=0`

**Session 2:** `session_1768232390.037599_d1a274ac`
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 335ms
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `sent_any: false`, `segments=0, audio_chunks=0`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ª–æ–≥–∞—Ö:

1. ‚úÖ **–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω:** `üì® –ü–æ–ª—É—á–µ–Ω StreamRequest`
2. ‚úÖ **–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏:** `üîÑ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞`
3. ‚úÖ **Session –¥–æ–±–∞–≤–ª–µ–Ω –≤ inflight:** `‚úÖ Session –¥–æ–±–∞–≤–ª–µ–Ω –≤ inflight`
4. ‚úÖ **Session —É–¥–∞–ª—ë–Ω –∏–∑ inflight:** `üßπ Session —É–¥–∞–ª—ë–Ω –∏–∑ inflight`
5. ‚ùå **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** `sent_any: false`, `segments=0, audio_chunks=0`

### ‚ùå –ß—Ç–æ –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤ –ª–æ–≥–∞—Ö:

1. **–ù–µ—Ç –ª–æ–≥–æ–≤ –æ –ø—Ä–æ–º–ø—Ç–µ:**
   - –ù–µ—Ç `‚Üí Input text len=...`
   - –ù–µ—Ç `‚Üí Input text content: '...'`
   - –ù–µ—Ç `üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ú–û–î–£–õ–ï–ô:`

2. **–ù–µ—Ç –ª–æ–≥–æ–≤ –æ LLM:**
   - –ù–µ—Ç `‚è±Ô∏è  –ü–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç –æ—Ç LLM –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ ...ms`
   - –ù–µ—Ç `Text Module (LLM) processing took ...ms`
   - –ù–µ—Ç `–ü–æ–ª—É—á–µ–Ω–æ X chunks –æ—Ç Text Module`

3. **–ù–µ—Ç –ª–æ–≥–æ–≤ –æ TTS:**
   - –ù–µ—Ç `Audio Module (TTS) processing for sentence took ...ms`
   - –ù–µ—Ç `sending audio_chunk`

4. **–ù–µ—Ç –ª–æ–≥–æ–≤ –æ–± –æ—à–∏–±–∫–∞—Ö:**
   - –ù–µ—Ç `ERROR`, `Exception`, `Failed`

---

## üéØ Root Cause Analysis

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1: –ü—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ù–µ—Ç –ª–æ–≥–æ–≤ `‚Üí Input text len=...` (—Å—Ç—Ä–æ–∫–∞ 226 –≤ `streaming_workflow_integration.py`)
- –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (335ms)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `request_data.get('text', '')`
- –í–æ–∑–º–æ–∂–Ω–æ, –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç

### –ì–∏–ø–æ—Ç–µ–∑–∞ 2: –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ù–µ—Ç –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 227 (`‚Üí Input text content`)
- –ù–µ—Ç –ª–æ–≥–æ–≤ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏ (—Å—Ç—Ä–æ–∫–∞ 251)
- –ù–µ—Ç –ª–æ–≥–æ–≤ –æ –Ω–∞—á–∞–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º (—Å—Ç—Ä–æ–∫–∞ 268)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- –í–æ–∑–º–æ–∂–Ω–æ, `_iter_processed_sentences` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

### –ì–∏–ø–æ—Ç–µ–∑–∞ 3: LLM –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ù–µ—Ç –ª–æ–≥–æ–≤ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç LLM
- –ù–µ—Ç –ª–æ–≥–æ–≤ –æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–æ–∑–º–æ–∂–Ω–æ, LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
- –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –≤ LLM

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### 1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `server/integrations/workflow_integrations/streaming_workflow_integration.py`

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 227
logger.info(f"‚Üí Input text content: '{request_data.get('text', '')[:100]}...'")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
prompt_text = request_data.get('text', '')
if not prompt_text or not prompt_text.strip():
    logger.warning(f"‚ö†Ô∏è –ü–£–°–¢–û–ô –ü–†–û–ú–ü–¢ –¥–ª—è session_id={session_id}")
    yield {
        'success': False,
        'error': 'Empty prompt',
        'error_code': 'INVALID_ARGUMENT',
        'text_response': '',
    }
    return

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º _iter_processed_sentences
logger.info(f"üîÑ –í—ã–∑–æ–≤ _iter_processed_sentences: prompt_len={len(prompt_text)}")
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ _iter_processed_sentences

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç LLM
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏

### 3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ï—Å–ª–∏ `_iter_processed_sentences` –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É –∫–ª–∏–µ–Ω—Ç—É

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ request_data

**–§–∞–π–ª:** `server/integrations/service_integrations/grpc_service_integration.py`

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 261
prompt_text = request_data.get('text', '')
logger.info(f"üìã Prompt –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: len={len(prompt_text)}, content='{prompt_text[:100]}...'")

if not prompt_text or not prompt_text.strip():
    logger.warning(f"‚ö†Ô∏è –ü–£–°–¢–û–ô –ü–†–û–ú–ü–¢ –≤ request_data –¥–ª—è session_id={session_id}")
```

---

## üìä –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:

1. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞:**
   - –í `grpc_service_integration.py` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `process_request_streaming`
   - –í `streaming_workflow_integration.py` –≤ –Ω–∞—á–∞–ª–µ `process_request_streaming`

2. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ LLM:**
   - –í `_iter_processed_sentences` - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü
   - –í `_stream_text_module` - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π chunk

3. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—É—Å—Ç–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞:**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É –∫–ª–∏–µ–Ω—Ç—É

### –í –±—É–¥—É—â–µ–º:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:**
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ `sent_any: false`
   - –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

2. **–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
   - –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - –í—Å–µ –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫–ª–∏–µ–Ω—Ç—É

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `server/integrations/workflow_integrations/streaming_workflow_integration.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `server/integrations/service_integrations/grpc_service_integration.py` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è workflow
- `server/modules/text_processing/providers/langchain_gemini_provider.py` - LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. ‚úÖ –í—Å–µ –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–∏—á–∏–Ω–æ–π
2. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
3. ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∏—á–∏–Ω—É –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
4. ‚úÖ Error rate —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ 0%
