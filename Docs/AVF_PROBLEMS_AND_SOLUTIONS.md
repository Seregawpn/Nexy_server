# –ü—Ä–æ–±–ª–µ–º—ã AVF –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Completion callback –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —á–µ—Ä–µ–∑ PyObjC ‚ùå

**–°–∏–º–ø—Ç–æ–º—ã**:
- –û—à–∏–±–∫–∞: `BadPrototypeError: Objective-C expects 0 arguments, Python argument has 1 arguments`
- –û—à–∏–±–∫–∞: `module 'objc' has no attribute 'ObjCBlock'`
- Completion callback –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è
- –°–æ–±—ã—Ç–∏–µ `audio.playback.completed` –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å

**–ü—Ä–∏—á–∏–Ω–∞**:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏**: –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ `playback_completion_handler_impl(finished)`, –Ω–æ `AVAudioNodeCompletionHandler` —ç—Ç–æ `void (^)(void)` - **–Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–æ–æ–±—â–µ**!
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `objc.ObjCBlock`**: –í –≤–µ—Ä—Å–∏–∏ PyObjC –¥–ª—è Python 3.13 –Ω–µ—Ç –º–µ—Ç–æ–¥–∞ `objc.ObjCBlock`
3. **`objc.callbackFor` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ù–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É –¥–ª—è `void (^)(void)`

**–†–µ—à–µ–Ω–∏–µ**:
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
def playback_completion_handler_impl():
    """Callback –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - AVAudioNodeCompletionHandler = void (^)(void)"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
    engine_instance = next(iter(_AVF_ENGINE_INSTANCES.values()), None)
    # ...

# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º Python —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
_AVF_COMPLETION_CALLBACK = playback_completion_handler_impl
# PyObjC –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å Python callable –≤ Objective-C –±–ª–æ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ Completion callback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ Python —Ñ—É–Ω–∫—Ü–∏—è)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Fallback —Ç–∞–π–º–µ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª ‚ùå

**–°–∏–º–ø—Ç–æ–º—ã**:
- Fallback —Ç–∞–π–º–µ—Ä —Å–æ–∑–¥–∞–≤–∞–ª—Å—è, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è
- –°–æ–±—ã—Ç–∏–µ `audio.playback.completed` –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ fallback
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, –Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–∏—á–∏–Ω–∞**:
1. **Fallback —Ç–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è**: –ö–æ–¥ —Å–æ–∑–¥–∞–≤–∞–ª async —Ñ—É–Ω–∫—Ü–∏—é `_fallback_timeout()`, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –µ—ë —á–µ—Ä–µ–∑ event loop
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã**: –ï—Å–ª–∏ event loop –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, fallback —Ç–∞–π–º–µ—Ä –≤–æ–æ–±—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è

**–†–µ—à–µ–Ω–∏–µ**:
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º fallback —Ç–∞–π–º–µ—Ä —á–µ—Ä–µ–∑ event loop
if self._ensure_loop_attached():
    result = self._submit_to_event_loop(_fallback_timeout(), is_async=True)
    if result:
        logger.info(f"‚úÖ [AVF] Fallback —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ event loop")
else:
    # ‚úÖ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê: –ò—Å–ø–æ–ª—å–∑—É–µ–º threading.Timer –µ—Å–ª–∏ loop –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    self._fallback_timer = threading.Timer(duration_sec + 0.5, _fallback_timer_callback)
    self._fallback_timer.start()
    logger.info(f"‚úÖ [AVF] Fallback —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ threading.Timer")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `audio.playback.completed`

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –°–æ–±—ã—Ç–∏–µ `playback.raw_audio` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å ‚ùå

**–°–∏–º–ø—Ç–æ–º—ã**:
- –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è, –Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `_on_raw_audio` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –ò–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ `audio_data is None`
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è**: EventBus –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `{'type': 'event', 'data': {...}, 'timestamp': ...}`
2. **–î–≤–æ–π–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å**: –í —Ç–µ—Å—Ç–µ –º—ã –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ `{"data": {...}}`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ `event['data'] = {"data": {...}}` –≤–º–µ—Å—Ç–æ `event['data'] = {...}`
3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∂–∏–¥–∞–ª**: `event['data']['audio_data']`, –Ω–æ –ø–æ–ª—É—á–∞–ª `event['data']['data']['audio_data']` (–∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç)

**–†–µ—à–µ–Ω–∏–µ**:
```python
# ‚ùå –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
await event_bus.publish("playback.raw_audio", {
    "data": {  # ‚ùå –õ–∏—à–Ω—è—è –æ–±—ë—Ä—Ç–∫–∞!
        "audio_data": audio_data,
        "sample_rate": sample_rate,
        ...
    }
})

# ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
await event_bus.publish("playback.raw_audio", {
    "audio_data": audio_data,  # ‚úÖ –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—ë—Ä—Ç–∫–∏
    "sample_rate": sample_rate,
    "channels": 1,
    ...
})
# EventBus —Å–∞–º –æ–±–µ—Ä–Ω—ë—Ç –≤ {'type': 'playback.raw_audio', 'data': {...}, 'timestamp': ...}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AVFAudioEngine

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –†–µ—à–µ–Ω–∏–µ |
|----------|--------|---------|
| Completion callback –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Python —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é |
| Fallback —Ç–∞–π–º–µ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ event loop –∏–ª–∏ threading.Timer |
| –°–æ–±—ã—Ç–∏–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è |

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **PyObjC –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: 
   - `objc.ObjCBlock` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Python 3.13
   - `objc.callbackFor` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å `void (^)(void)`
   - **–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å Python —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é, PyObjC –º–æ–∂–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

2. **EventBus —Ñ–æ—Ä–º–∞—Ç**:
   - EventBus –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `{'type': 'event', 'data': {...}, 'timestamp': ...}`
   - **–í–∞–∂–Ω–æ**: –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –æ–±—ë—Ä—Ç–∫—É –≤ "data" –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

3. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º**:
   - Fallback —Ç–∞–π–º–µ—Ä - –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
   - –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ native callback –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   - **–í–∞–∂–Ω–æ**: –ó–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ event loop –∏–ª–∏ threading.Timer

---

## ‚úÖ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!** ‚úÖ

- ‚úÖ Completion callback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- ‚úÖ –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AVFAudioEngine
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–æ–±—ã—Ç–∏–µ `playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: 4/4 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ (100%)

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback —Ç–∞–π–º–µ—Ä –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º**: –û–Ω –Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º native callback
2. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏–π**: –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏—à–Ω–∏–µ –æ–±—ë—Ä—Ç–∫–∏ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º


