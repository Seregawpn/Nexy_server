# Тест-план: UpdateNotificationIntegration

Цель — подтвердить, что слепые и слабовидящие пользователи получают своевременные аудио-уведомления о ходе обновления клиента Nexy, без конфликтов с существующей архитектурой.

## Предпосылки
- Сборка Nexy (dev или prod) с активированными `permission_restart` и `update_notification`.
- Включённый SpeechPlaybackIntegration и SignalIntegration.
- Возможность запускать обновление вручную (`updater.check_manual`) либо использовать тестовый appcast.
- Доступ к логам `logs/nexy.log` и EventBus истории (для проверки опубликованных событий).
- Для сценариев ошибки — контролируемый способ оборвать загрузку (например, mock-сервер или отключение сети).

## Наблюдаемые события
- `updater.update_started`, `updater.download_progress`, `updater.install_progress`, `updater.update_completed`, `updater.update_failed`.
- `speech.playback.request` для категории `update_notification`.
- `signal.play` с паттернами `update_start`, `update_progress`, `update_success`, `update_error`.

## Сценарии

### 1. Старт обновления
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Запустить клиент, инициировать обновление (ручной чек)|Публикуется `updater.update_started`|
|2|Слушать аудио|Озвучка «Началось обновление…», сигнальный тон `update_start`|

### 2. Прогресс скачивания
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Обновление скачивает артефакт|Каждые 20 % (по умолчанию) звучит сообщение «скачивание XX процентов»|
|2|Проверить логи|Публикуются события `updater.download_progress` и `speech.playback.request`|
|3|Параллельно прервать голос клавишей Cancel|Озвучка останавливается; при следующем увеличении прогресса воспроизводится новая фраза|

### 3. Прогресс установки
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|После скачивания начинается установка|Озвучивается «установка Y процентов» (порог 20 %)|
|2|Логи фиксируют `updater.install_progress`|Данные stage = `install`, `unmount`, `finish`|

### 4. Успешное завершение
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Обновление завершено|Сигнал `update_success` + фраза «Обновление завершено…»|
|2|Проверить событие перезапуска|После сообщения происходит стандартный перезапуск приложения|

### 5. Ошибка обновления
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Спровоцировать ошибку (обрыв сети, неверный URL)|Публикуется `updater.update_failed`|
|2|Аудио|Сигнал `update_error` + текст «Обновление не удалось…» с указанием причины|

### 6. Отключение речи/сигналов
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Установить `speak_progress=false`, `use_signals=false` в конфиге|Прогресс не озвучивается и без тонов, но события остаются в EventBus|
|2|Проверить логи|`speech.playback.request` отсутствует, `signal.play` отсутствует|

### 7. Dry-run режим
| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
|1|Установить `update_notification.dry_run=true`|Скачивание идёт, но `speech.playback.request` не публикуется|
|2|Проверить сигналы|Сигналы работают согласно `use_signals`|

### 8. Совместимость с PermissionRestartIntegration
1. Активировать обновление и вручную выдать критическое разрешение.
2. Во время загрузки убедиться, что голосовые уведомления продолжают звучать.
3. После завершения: сначала сообщение о завершении обновления, затем срабатывает `permission_restart.scheduled`.

## Регрессии, которые важно исключить
- Отсутствие озвучки при повторной попытке обновления.
- Дублирование сообщений (повторное объявление того же процента).
- Конкуренция с WelcomeMessageIntegration (последовательность при запуске с обновлением).
- Пересечение с SpeechPlaybackIntegration (уведомления не мешают ответам ассистента после рестарта).

## Метрики
- Время между прогресс-сообщениями ≥ `progress_interval_sec`.
- Количество TTS-сообщений соответствует числу ступеней (100 / `progress_step_percent`).
- Наличие сигналов при включённом `use_signals`.

## Отчёт
После выполнения сценариев зафиксировать:
- Версию клиента, конфигурацию `update_notification`.
- Логи аудио-событий (время, текст, процент).
- Логи EventBus (подтверждение `updater.*` событий).
- Наблюдения о UX (понятность и не навязчивость уведомлений).
