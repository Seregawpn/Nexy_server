# –ß–µ–∫–ª–∏—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ-–≥—Ä–∞—Ñ–∞

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-01-08  
**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è State Machine

### –ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π (13 –º–µ—Å—Ç)

1. ‚úÖ **IDLE ‚Üí STARTING** (—Å—Ç—Ä–æ–∫–∞ 354)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value}")
   ```

2. ‚úÖ **STARTING ‚Üí RUNNING** (—Å—Ç—Ä–æ–∫–∞ 451)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value}")
   ```

3. ‚úÖ **RUNNING ‚Üí STOPPING** (—Å—Ç—Ä–æ–∫–∞ 486)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value}")
   ```

4. ‚úÖ **STOPPING ‚Üí IDLE** (—Å—Ç—Ä–æ–∫–∞ 539)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value}")
   ```

5. ‚úÖ **–û—Ç–∫–∞—Ç –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º RecognitionState** (—Å—Ç—Ä–æ–∫–∏ 361, 368)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–æ—Ç–∫–∞—Ç)")
   ```

6. ‚úÖ **–û—Ç–∫–∞—Ç –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º AudioStreamState –≤ stop** (—Å—Ç—Ä–æ–∫–∞ 493)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–æ—Ç–∫–∞—Ç)")
   ```

7. ‚úÖ **–û—à–∏–±–∫–∞ –≤ start_listening** (—Å—Ç—Ä–æ–∫–∞ 462)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–æ—à–∏–±–∫–∞)")
   ```

8. ‚úÖ **–û—à–∏–±–∫–∞ –≤ stop_listening** (—Å—Ç—Ä–æ–∫–∞ 558)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–æ—à–∏–±–∫–∞)")
   ```

9. ‚úÖ **Graceful stop –Ω–∞—á–∞–ª–æ** (—Å—Ç—Ä–æ–∫–∞ 248)
   ```python
   logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (graceful stop: {reason})")
   ```

10. ‚úÖ **Graceful stop –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ** (—Å—Ç—Ä–æ–∫–∞ 280)
    ```python
    logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (graceful stop –∑–∞–≤–µ—Ä—à–µ–Ω)")
    ```

11. ‚úÖ **–û—à–∏–±–∫–∞ –≤ _run_listening** (—Å—Ç—Ä–æ–∫–∞ 870)
    ```python
    logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–æ—à–∏–±–∫–∞ –≤ _run_listening)")
    ```

12. ‚úÖ **–ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω** (—Å—Ç—Ä–æ–∫–∞ 891)
    ```python
    logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (–ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω)")
    ```

13. ‚úÖ **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ** (—Å—Ç—Ä–æ–∫–∞ 403)
    ```python
    logger.debug(f"üîÑ [AUDIO_STATE] {old_state.value} ‚Üí {self._stream_state.value} (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)")
    ```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–±–∞—É–Ω—Å–∞

14. ‚úÖ **–î–µ–±–∞—É–Ω—Å stop‚Üístart** (—Å—Ç—Ä–æ–∫–∞ 347)
    ```python
    logger.debug(f"‚è≥ –î–µ–±–∞—É–Ω—Å stop‚Üístart: –æ–∂–∏–¥–∞–µ–º {wait_for:.3f}—Å")
    ```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è Bluetooth —Ñ–æ—Ä–º–∞—Ç–∞

15. ‚úÖ **Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ** (—Å—Ç—Ä–æ–∫–∞ 704)
    ```python
    logger.info("üîµ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ - —Ñ–æ—Ä–º–∞—Ç: 16kHz, –º–æ–Ω–æ")
    ```

16. ‚úÖ **–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** (—Å—Ç—Ä–æ–∫–∞ 773)
    ```python
    logger.info("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (%.1fs)...", self.bt_prestart_delay)
    ```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

17. ‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π AudioStreamState** (—Å—Ç—Ä–æ–∫–∞ 339)
    ```python
    logger.warning(f"‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ {self._stream_state.value}")
    ```

18. ‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RecognitionState** (—Å—Ç—Ä–æ–∫–∞ 357)
    ```python
    logger.warning(f"‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ {self.state.value}")
    ```

19. ‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π AudioStreamState** (—Å—Ç—Ä–æ–∫–∞ 478)
    ```python
    logger.warning(f"‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ {self._stream_state.value}")
    ```

20. ‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RecognitionState** (—Å—Ç—Ä–æ–∫–∞ 489)
    ```python
    logger.warning(f"‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ {self.state.value}")
    ```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

21. ‚úÖ **–í—Ö–æ–¥–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ** (—Å—Ç—Ä–æ–∫–∞ 398)
    ```python
    logger.error("‚ùå –í—Ö–æ–¥–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∑–∞–ø–∏—Å—å –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞")
    ```

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ –º–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:** 21
- **–ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π:** 13
- **–î–µ–±–∞—É–Ω—Å:** 1
- **Bluetooth:** 2
- **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:** 4
- **–û—à–∏–±–∫–∏:** 1

## –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤

–í—Å–µ –ª–æ–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
```
üîÑ [AUDIO_STATE] old_state ‚Üí new_state [–∫–æ–Ω—Ç–µ–∫—Å—Ç]
```

–ì–¥–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å:
- (–ø—É—Å—Ç–æ) ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
- (–æ—Ç–∫–∞—Ç) ‚Äî –æ—Ç–∫–∞—Ç –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- (–æ—à–∏–±–∫–∞) ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
- (graceful stop: reason) ‚Äî graceful stop —Å –ø—Ä–∏—á–∏–Ω–æ–π
- (–ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω) ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
- (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ) ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö

–ü—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –≤—ã –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
```
üîÑ [AUDIO_STATE] idle ‚Üí starting
‚è≥ –î–µ–±–∞—É–Ω—Å stop‚Üístart: –æ–∂–∏–¥–∞–µ–º 0.150—Å (–µ—Å–ª–∏ –±—ã–ª –Ω–µ–¥–∞–≤–Ω–∏–π stop)
üîµ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ - —Ñ–æ—Ä–º–∞—Ç: 16kHz, –º–æ–Ω–æ (–µ—Å–ª–∏ BT)
üîÑ [AUDIO_STATE] starting ‚Üí running
üé§ –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–∞—á–∞—Ç–æ
...
üîÑ [AUDIO_STATE] running ‚Üí stopping
üîÑ [AUDIO_STATE] stopping ‚Üí idle
```

## –°—Ç–∞—Ç—É—Å

‚úÖ **–í–°–ï –õ–û–ì–ò –£–°–¢–ê–ù–û–í–õ–ï–ù–´**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Å—Ç–∞ –ø–æ–∫—Ä—ã—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
- ‚úÖ –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ –î–µ–±–∞—É–Ω—Å
- ‚úÖ Bluetooth —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- ‚úÖ –û—à–∏–±–∫–∏

