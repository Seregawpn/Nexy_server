# Edge TTS silent PCM

## Метаданные
- Ассистент: codex
- Тип: analysis
- Дата: 2026-02-03
- ID (INS-###): INS-005

## Diagnosis
При streaming-конвертации MP3→PCM EdgeTTS детектор «silent PCM» слишком агрессивный: первые 3 PCM-чанка нулевые, из-за чего поток аварийно прерывается до появления реального аудио.

## Root Cause
Слишком ранняя проверка тишины (fixed prebuffer=3) → ffmpeg/декодер выдает стартовые нули/задержку → ложное «silent PCM» → исключение → ретраи исчерпаны.

## Optimal Fix
Ослабить/перенести проверку тишины: ждать больше данных или таймаут по времени/байтам и считать ошибкой только если весь поток (или значимый префикс) остается нулевым.

## Verification
- Воспроизвести GenerateWelcomeAudio и убедиться, что первые чанки могут быть нулевыми, но поток продолжается и появляется звук.
- Убедиться, что по-настоящему пустой/нулевой поток корректно помечается как ошибка.

## Запрос/цель
Разобрать причину ошибки `Silent PCM detected in initial chunks` и предложить варианты решения.

## Контекст
- Файлы: `server/modules/audio_generation/providers/edge_tts_provider.py`
- Документы: `Docs/ARCHITECTURE_OVERVIEW.md`
- Логи: фрагмент запроса пользователя (2026-02-03)

## Решения/выводы
- Текущая проверка тишины неустойчива к нормальной стартовой паузе.
- Нужно сместить критерий в сторону «весь поток пустой» или «нет ненулевых данных после N байт/секунд».

## Открытые вопросы
- Насколько допустима стартовая тишина (в секундах/чанках) в клиентском плеере?
- Есть ли фоллбэк-провайдер TTS, который стоит активировать при реальной тишине?

## Следующие шаги
- Согласовать критерий «тишины».
- Внести правку в _stream_mp3_to_pcm_async.
