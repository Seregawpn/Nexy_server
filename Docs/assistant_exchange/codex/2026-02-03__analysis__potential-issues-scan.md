# Potential Issues Scan

## Метаданные
- Ассистент: codex
- Тип: analysis
- Дата: 2026-02-03
- ID (INS-###): INS-005

## Diagnosis
После фиксов критичных тестов потенциальные риски остаются в контрактной части (валидация идентификаторов, session_id override) и в маскировании секретов по ключевому слову `key`.

## Root Cause
Правки делались под тесты и единообразие поведения, что может сместить приоритеты контрактов и привести к излишнему маскированию или несовпадению ожиданий клиента/сервера.

## Optimal Fix
Сделать явную проверку контрактов: утвердить порядок валидации и правила session_id override; сузить секретный ключ `key` либо добавить исключения для безопасных ключей.

## Verification
Мини‑проверки:
- Пары запросов с валидным/невалидным `hardware_id` и `session_id` (контрактный приоритет ошибок).
- Проверка логов с `key` не являющимся секретом (например `monkey`, `keyboard`) — не должен маскироваться.

## Запрос/цель
Выявить потенциальные дубли/конфликты/гонки и несоответствия флагов после правок.

## Контекст
- Файлы: `server/modules/grpc_service/core/grpc_server.py`, `server/integrations/core/assistant_response_parser.py`, `server/utils/logging_formatter.py`
- Документы: `Docs/ARCHITECTURE_OVERVIEW.md`, `Docs/PROJECT_REQUIREMENTS.md`, `Docs/_archive/ASSISTANT_COORDINATION_PROTOCOL.md`, `Docs/_archive/CODEX_PROMPT.md`, `Docs/_archive/assistant_exchange/TEMPLATE.md`
- Ограничения: без изменения архитектуры

## Решения/выводы
- Контракт ошибок зависит от приоритета проверок hardware_id/session_id.
- session_id теперь всегда форсируется, что может скрыть рассинхроны.
- Маскирование по ключу `key` может пере‑маскировать несекретные поля.

## Открытые вопросы
- Подтверждаем приоритет `hardware_id` > `session_id` как API‑контракт?
- Нужно ли логировать/метрить случаи session_id override?

## Следующие шаги
- Подтвердить контракт приоритетов и при необходимости документировать.
- При излишнем маскировании сузить ключевой матч до `*_key`/`api_key`.
