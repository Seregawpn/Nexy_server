# Server flags/interactions audit and dedup plan

Date: 2026-02-15
Type: analysis

## Runtime behavior (current)
- `get_config()` builds `UnifiedServerConfig()` from env/config.env only; `unified_config.yaml` is not used in runtime path.
- gRPC module bootstrap is dual-path in `grpc_service_manager.py`: coordinator path when `use_module_coordinator && !disable_module_coordinator`, legacy otherwise.
- Streaming concurrency uses local in-memory sets in `StreamingWorkflowIntegration` for `session_id` and optionally `hardware_id`.
- `SessionRegistry` exists and is used by interrupt/session modules, but streaming path does not register/unregister stream lifecycle in registry.

## Effective flags in current config.env (observed keys)
- `FORWARD_ASSISTANT_ACTIONS=true`
- `WEB_SEARCH_ENABLED=true`
- `MESSAGES_ENABLED=true`
- `SUBSCRIPTION_ENABLED=false`
- `SUBSCRIPTION_KILL_SWITCH=false`
- Missing keys fallback to defaults (e.g. `USE_MODULE_COORDINATOR=true`, `NEXY_KS_DISABLE_MODULE_COORDINATOR=false`, `PREVENT_CONCURRENT_HARDWARE_ID_SESSIONS=false`).

## Conflicts / drift
1. Dual bootstrap semantics (coordinator vs legacy) still active at runtime boundary.
2. Session state ownership split: `SessionRegistry` as SoT in docs vs local streaming maps for active hardware/session concurrency.
3. `sys.path` mutation in core gRPC files creates non-deterministic import resolution risk.
4. Dead flags: `use_workflow_integrations`, `use_fallback_manager`, `disable_workflow_integrations` are declared but not used in server runtime control flow.
5. Comment drift on `session_id` SoT: streaming workflow says generated by gRPC layer, while gRPC enforces client-provided `session_id`.

## Primary plan
- Coordinator-first bootstrap by default; legacy only as explicit emergency mode.
- Keep `StreamingWorkflowIntegration` lock for atomic single-flight, but move active session/hardware ownership to `SessionRegistry` API.
- Remove `sys.path` hacks from core modules and use package-safe imports.
- Either wire dead flags into runtime decisons or remove them from config/registry docs to avoid fake controls.
- Add race tests for same `session_id` and same `hardware_id` (when guard enabled).

