# Server main.py duplicate/conflict scan

## Метаданные
- Ассистент: codex
- Тип: analysis
- Дата: 2026-02-03
- ID (INS-###): INS-005

## Diagnosis
В `server/main.py` есть дублирование проверок/обработок, и несколько мест с потенциальными конфликтами управления задачами и состоянием.

## Root Cause
Логика старта/остановки серверов и валидации портов реализована разрозненно: сначала превентивные проверки, затем повторные try/except при старте, плюс двойные отмены задач — это создает избыточность и риск гонок между проверкой и фактическим bind.

## Optimal Fix
Цель: убрать дубли и централизовать контроль запуска/остановки, уменьшив гонки.

## Verification
Проверить, что при занятом порте есть единая точка ошибки, а при штатном выключении задачи отменяются ровно один раз, без утечек pending-задач.

## Запрос/цель
Проверить `server/main.py` на дубли/конфликты условий и потенциальные гонки.

## Контекст
- Файлы: `server/main.py`
- Документы: `Docs/ARCHITECTURE_OVERVIEW.md`, `Docs/PROJECT_REQUIREMENTS.md`, `Docs/_archive/ASSISTANT_COORDINATION_PROTOCOL.md`, `Docs/_archive/ANTIGRAVITY_PROMPT.md`, `Docs/_archive/CODEX_PROMPT.md`, `Docs/_archive/assistant_exchange/TEMPLATE.md`
- Ограничения: без изменения архитектуры

## Решения/выводы
- Есть повторная проверка портов и дублирующийся обработчик ошибки занятости порта.
- Есть двойная отмена `metrics_task`.
- Есть потенциальная утечка задачи `shutdown_event.wait()` при раннем завершении `serve_task`.

## Открытые вопросы
- Нужна ли отдельная превентивная проверка порта или достаточно обработки исключения при bind?

## Следующие шаги
- Устранить дубли и привести запуск/остановку к единому пути.
