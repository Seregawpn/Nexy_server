# Диагностика Google Speech API UnknownValueError

## Проблема
Google Speech API возвращает `UnknownValueError` ("Speech not recognized") при попытке распознать аудио.

## Текущие параметры (из логов)
- **Language**: `en-US` ✅
- **Sample rate (original)**: `24000Hz` ✅
- **Sample rate (resampled)**: `16000Hz` ✅ (Google требует 16kHz)
- **Duration (original)**: `21.16s` ⚠️ (слишком длинное, но в пределах лимита 60s)
- **Duration (resampled)**: `21.16s` ✅
- **RMS (original)**: `~1182` ✅ (хороший уровень сигнала)
- **RMS (resampled)**: `~653` ✅ (приемлемый уровень)
- **Range**: `min=-17313, max=5954` ✅ (широкий диапазон, есть сигнал)
- **Mean**: `~-28` ✅ (нет сильного DC offset)

## Возможные причины UnknownValueError

### 1. Тишина в начале/конце аудио
**Симптомы**: Первые 10 samples = `[0, 0, 0, ...]`
**Решение**: Обрезать тишину в начале/конце перед отправкой в Google

### 2. Слишком длинное аудио с большим количеством тишины
**Симптомы**: Duration = 21.16s, но большая часть - тишина
**Решение**: Обрезать тишину или отправлять только сегменты с речью

### 3. Неправильный формат аудио
**Симптомы**: Google не может обработать формат
**Решение**: Проверить что `AudioData` создан правильно (sample_width=2, mono)

### 4. Проблема с ресемплингом
**Симптомы**: Искажения после ресемплинга
**Решение**: Использовать качественный ресемплинг (scipy.signal.resample)

### 5. Неразборчивая речь
**Симптомы**: RMS нормальный, но Google не может распознать
**Решение**: Проверить WAV файл, возможно нужна нормализация или фильтрация

## Диагностические шаги

1. **Прослушать WAV файл** `/tmp/nexy_debug_session_*.wav`
   - Есть ли голос?
   - Есть ли тишина в начале/конце?
   - Разборчива ли речь?

2. **Проверить обрезку тишины**
   - Добавить функцию обрезки тишины перед отправкой в Google
   - Отправлять только сегменты с речью (VAD - Voice Activity Detection)

3. **Проверить формат AudioData**
   - Убедиться что `sample_width=2` (int16)
   - Убедиться что `channels=1` (mono)
   - Убедиться что `sample_rate=16000Hz`

4. **Попробовать с коротким аудио**
   - Записать короткую фразу (1-2 секунды)
   - Проверить работает ли распознавание

5. **Проверить интернет-соединение**
   - Google Speech API требует интернет
   - Проверить доступность `https://speech.googleapis.com`

## Результаты тестирования

### Тест 1: Длинное аудио (5 секунд ожидание, фактически 21.16s)
- Duration: 21.16s ⚠️
- RMS resampled: 577.31 ✅
- Range: [-18095, 7031] ✅
- Результат: ❌ UnknownValueError

### Тест 2: Короткое аудио (2 секунды ожидание, фактически 9.56s)
- Duration: 9.56s ⚠️ (всё ещё длиннее ожидаемого)
- RMS resampled: 912.25 ✅ (отличный уровень)
- Range: [-20633, 28750] ✅ (широкий диапазон)
- Первые 10 samples: `[85, 243, 81, 157, 22, -124, 91, -103, 18, -172]` ✅ (НЕ тишина!)
- Результат: ❌ UnknownValueError

### Выводы
1. ✅ Параметры аудио выглядят правильно (RMS, Range, формат)
2. ✅ Первые samples НЕ тишина (в коротком тесте)
3. ⚠️ Запись продолжается дольше ожидаемого (9.56s вместо 2s)
4. ❌ Google Speech API всё ещё возвращает UnknownValueError

## Возможные причины (после тестирования)

### 1. Проблема с форматом данных для Google API
**Гипотеза**: Возможно, Google API ожидает другой формат или порядок байт.

**Проверка**: Попробовать использовать `recognize_google` с `show_all=True` для получения детальной информации об ошибке.

### 2. Проблема с ресемплингом
**Гипотеза**: Ресемплинг через `scipy.signal.resample` может создавать артефакты, которые Google не может обработать.

**Проверка**: Попробовать использовать другой метод ресемплинга или проверить качество ресемплинга.

### 3. Проблема с языком
**Гипотеза**: Пользователь может говорить не на английском, или акцент слишком сильный.

**Проверка**: Прослушать WAV файл и проверить язык речи.

### 4. Проблема с качеством аудио
**Гипотеза**: Шум, эхо, или другие артефакты могут мешать распознаванию.

**Проверка**: Прослушать WAV файл `/tmp/nexy_debug_session_test_step6_short_123.wav` для проверки качества.

## Следующие шаги

1. ✅ Добавлена детальная диагностика (RMS, Range, Duration)
2. ✅ Исправлена нормализация (32767 → 32768)
3. ✅ Протестировано с коротким аудио
4. ⏳ **Прослушать WAV файл** `/tmp/nexy_debug_session_test_step6_short_123.wav` для проверки качества аудио
5. ⏳ Попробовать `recognize_google` с `show_all=True` для получения детальной информации
6. ⏳ Добавить обрезку тишины (VAD) перед отправкой в Google
7. ⏳ Проверить ресемплинг (возможно, использовать другой метод)

