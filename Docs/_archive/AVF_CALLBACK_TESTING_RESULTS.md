# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Completion Callback

## ‚úÖ –í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ callback (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)

**–û—à–∏–±–∫–∞**: `BadPrototypeError: Objective-C expects 1 arguments, <function> has 2 positional arguments`

**–ü—Ä–∏—á–∏–Ω–∞**: 
- –§—É–Ω–∫—Ü–∏—è `playback_completion_handler_impl` –∏–º–µ–ª–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä—É `(player_node, finished)`
- –ù–æ Objective-C completion handler –¥–ª—è `scheduleBuffer_atTime_options_completionHandler_` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **–¢–û–õ–¨–ö–û –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä** `(BOOL finished)`
- Objective-C **–ù–ï –ø–µ—Ä–µ–¥–∞—ë—Ç** `player_node` –≤ completion handler!

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –ò–∑–º–µ–Ω–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Å `(player_node, finished)` –Ω–∞ `(finished)`
- –î–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å `_AVF_ENGINE_INSTANCES` –≤–º–µ—Å—Ç–æ `player_node`

**–§–∞–π–ª**: `modules/audio_avf/core/avf_audio_engine.py:143`

---

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: AVAudioPlayerNode –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç weakref (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)

**–û—à–∏–±–∫–∞**: `TypeError: cannot create weak reference to 'AVAudioPlayerNode' object`

**–ü—Ä–∏—á–∏–Ω–∞**:
- `AVAudioPlayerNode` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç weakref (—ç—Ç–æ Objective-C –æ–±—ä–µ–∫—Ç)
- –ö–æ–¥ –ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_PLAYER_NODE_TO_ENGINE.get(player_node)`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫—É
- Fallback —á–µ—Ä–µ–∑ `_PLAYER_NODE_ID_MAP` —Ä–∞–±–æ—Ç–∞–ª, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –ò–∑–º–µ–Ω—ë–Ω –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ `_lookup_engine_by_player_node()`:
  - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º fallback —Å–ª–æ–≤–∞—Ä—å `_PLAYER_NODE_ID_MAP` (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è AVAudioPlayerNode)
  - –ó–∞—Ç–µ–º –ø—ã—Ç–∞–µ–º—Å—è weakref —Å–ª–æ–≤–∞—Ä—å (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- –£–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∏–≤—è–∑–∫–∏ - —Ç–µ–ø–µ—Ä—å —ç—Ç–æ debug —Å–æ–æ–±—â–µ–Ω–∏–µ

**–§–∞–π–ª**: `modules/audio_avf/core/avf_audio_engine.py:86-98`

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 1: –ò–º–ø–æ—Ä—Ç AVAudioPlayerNode ‚úÖ
- ‚úÖ AVAudioPlayerNode —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ú–µ—Ç–æ–¥ `scheduleBuffer_atTime_options_completionHandler_` –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ AVAudioPlayerNode —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–æ–º

### –≠—Ç–∞–ø 2: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚úÖ
- ‚úÖ `AVF_PLAYER_NODE_AVAILABLE = True`
- ‚úÖ `AVAudioPlayerNode` –Ω–µ None
- ‚úÖ `_AVF_COMPLETION_CALLBACK` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ None (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è)

### –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ ‚úÖ
- ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä `AVFAudioEngine` —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ `_player_node` —Å–æ–∑–¥–∞–Ω
- ‚úÖ `_output_completion_callback` —Å–æ–∑–¥–∞–Ω (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### –≠—Ç–∞–ø 4: –ü—Ä–∏–≤—è–∑–∫–∞ player_node ‚Üí engine ‚úÖ
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ `_PLAYER_NODE_ID_MAP` (fallback —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ `_lookup_engine_by_player_node()` –≤–µ—Ä–Ω—É–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
- ‚ö†Ô∏è –ü—Ä–∏–≤—è–∑–∫–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ `_PLAYER_NODE_TO_ENGINE` (–æ–∂–∏–¥–∞–µ–º–æ, —Ç.–∫. AVAudioPlayerNode –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç weakref)

### –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ completion callback ‚úÖ
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π `_AVF_COMPLETION_CALLBACK` —Å–æ–∑–¥–∞–Ω
- ‚úÖ `engine._output_completion_callback` —Å–æ–∑–¥–∞–Ω
- ‚úÖ Callback —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- ‚úÖ Callback callable (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å)

### –≠—Ç–∞–ø 6: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã ‚úÖ
- ‚úÖ –û–±–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π callback –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- ‚úÖ `engine._output_completion_callback` –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- ‚úÖ –û–±–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `_AVF_ENGINE_INSTANCES`

---

## üîç –í—ã–≤–æ–¥—ã

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. ‚úÖ –ò–º–ø–æ—Ä—Ç `AVAudioPlayerNode` —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `AVFAudioEngine` —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ fallback —Å–ª–æ–≤–∞—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ completion callback —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã)
5. ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ callback (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ –°–∏–≥–Ω–∞—Ç—É—Ä–∞ callback: `(player_node, finished)` ‚Üí `(finished)`
2. ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏: —Å–Ω–∞—á–∞–ª–∞ fallback, –∑–∞—Ç–µ–º weakref
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ weakref: —Ç–µ–ø–µ—Ä—å —ç—Ç–æ debug —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ –æ—à–∏–±–∫–∞

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
1. ‚ö†Ô∏è Callback –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
2. ‚ö†Ô∏è `audio.playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤–æ–≤—Ä–µ–º—è
3. ‚ö†Ô∏è `playback.completed` —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –∏–∑ `audio.playback.completed`
4. ‚ö†Ô∏è `WelcomeMessageIntegration` –ø–æ–ª—É—á–∞–µ—Ç `playback.completed` –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–∂–∏–¥–∞–Ω–∏–µ

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `‚úÖ [AVF] Completion callback registered`
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `‚úÖ [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (callback –æ—Ç AVAudioPlayerNode...)`
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `‚úÖ [AVF] –ü–æ–ª—É—á–µ–Ω–æ audio.playback.completed –æ—Ç AVFAudioEngine`
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `‚úÖ [AVF] –¢—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–Ω–æ playback.completed`

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è**:
   - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
   - `playback.completed` –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è (–Ω–µ —á–µ—Ä–µ–∑ fallback timeout)
   - `WelcomeMessageIntegration` –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å AirPods**:
   - –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–æ–≤ AirPods callback –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üéØ –ò—Ç–æ–≥

–í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ callback (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å weakref –¥–ª—è AVAudioPlayerNode (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

–¢–µ–ø–µ—Ä—å completion callback –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å `audio.playback.completed` –≤–æ–≤—Ä–µ–º—è.


