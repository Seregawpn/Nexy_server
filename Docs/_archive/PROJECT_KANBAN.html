<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexy Super Kanban V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-sidebar: #13132b;
            --bg-card: rgba(30, 30, 50, 0.7);
            --bg-column: rgba(26, 26, 46, 0.5);
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --border: rgba(255, 255, 255, 0.1);
            --accent-purple: #9333ea;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            border-left: 3px solid var(--accent-purple);
        }

        .epic-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* MAIN AREA */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            background: var(--bg-secondary);
        }

        .view-switcher {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 8px;
        }

        .view-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .view-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--accent-purple);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-outline {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
        }

        /* Date input with calendar styling */
        input[type="date"] {
            position: relative;
            cursor: pointer;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(1);
            opacity: 0.7;
            padding: 4px;
            margin-left: -24px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        .view-container {
            flex: 1;
            overflow: hidden;
            padding: 1.5rem;
            position: relative;
        }

        /* KANBAN BOARD */
        .kanban-board {
            display: flex;
            gap: 1.5rem;
            height: 100%;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .column {
            min-width: 320px;
            width: 320px;
            background: var(--bg-column);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .column-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .column-cards {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .column.drag-over {
            background: rgba(147, 51, 234, 0.1);
            border-color: var(--accent-purple);
        }

        .card {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: grab;
            position: relative;
            transition: 0.2s;
        }

        .card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }

        .card.dragging {
            opacity: 0.5;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .card-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .blocked-badge {
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-size: 0.7rem;
            background: rgba(239, 68, 68, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: auto;
        }

        .epic-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-right: 0.5rem;
        }

        /* GANTT VIEW */
        .gantt-view {
            width: 100%;
            height: 100%;
            overflow: auto;
            background: var(--bg-primary);
            padding: 1rem;
        }

        /* METRICS */
        .metrics-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-primary);
        }

        .metric span {
            color: var(--text-primary);
            font-weight: 600;
            margin-left: 0.25rem;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            width: 600px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="logo">üöÄ Nexy Super Kanban</div>
        <div class="nav-section">
            <div class="nav-title">Views</div>
            <div class="nav-item active" onclick="app.filterByEpic('all')">üìö All Tasks</div>
            <div class="nav-item" onclick="app.filterByEpic('my')">üë§ My Tasks</div>
            <div class="nav-item" onclick="app.toggleArchived()" id="nav-archived">üì¶ Archived</div>
        </div>
        <div class="nav-section">
            <div class="nav-title">Epics</div>
            <div id="epics-list"></div>
            <button class="btn btn-outline" style="width:100%; margin-top:0.5rem; font-size:0.8rem;"
                onclick="app.createEpic()">+ New Epic</button>
        </div>
    </aside>

    <div class="main-content">
        <header class="header">
            <div class="view-switcher">
                <button class="view-btn active" onclick="app.switchView('board')">Board</button>
                <button class="view-btn" onclick="app.switchView('gantt')">Gantt</button>
            </div>
            <div class="actions">
                <button class="btn btn-outline" onclick="app.shipRelease()">üöÄ Ship Release</button>
                <button class="btn btn-outline" onclick="app.model.save()">üíæ Export JSON</button>
                <button class="btn btn-primary" onclick="app.openTaskModal()">‚ûï New Task</button>
            </div>
        </header>

        <div class="metrics-bar">
            <div class="metric">Total: <span id="m-total">0</span></div>
            <div class="metric">In Progress: <span id="m-progress">0</span></div>
            <div class="metric">Blocked: <span id="m-blocked" style="color:var(--danger)">0</span></div>
            <div class="metric">Release Ready: <span id="m-release" style="color:var(--accent-purple)">0</span></div>
        </div>

        <div class="view-container">
            <div id="view-board" class="kanban-board"></div>
            <div id="view-gantt" class="gantt-view hide"></div>
        </div>
    </div>

    <!-- TASK MODAL -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:1.5rem">Task Details</h2>
            <form id="task-form" onsubmit="app.saveTask(event)">
                <input type="hidden" id="t-id">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="t-title" class="form-input" required>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem;">
                    <div class="form-group">
                        <label class="form-label">Epic</label>
                        <select id="t-epic" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="t-status" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="t-prio" class="form-select">
                            <option value="P0">P0 (Critical)</option>
                            <option value="P1">P1 (High)</option>
                            <option value="P2">P2 (Medium)</option>
                            <option value="P3">P3 (Low)</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div class="form-group">
                        <label class="form-label">Owner</label>
                        <input type="text" id="t-owner" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimate</label>
                        <input type="text" id="t-est" class="form-input" placeholder="e.g. 2h, 3d">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="t-start" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" id="t-due" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Blocked By IDs (comma separated)</label>
                    <input type="text" id="t-blocked" class="form-input" placeholder="NEXY-001, NEXY-002">
                </div>

                <!-- Subtasks Section -->
                <div class="form-group">
                    <label class="form-label">Subtasks</label>
                    <div id="t-subtasks"
                        style="background:#1a1a2e; border-radius:8px; padding:8px; max-height:150px; overflow-y:auto;">
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input type="text" id="t-new-subtask" class="form-input" placeholder="New subtask..."
                            style="flex:1;">
                        <button type="button" class="btn btn-outline" onclick="app.addSubtaskFromModal()">+ Add</button>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; margin-top:1.5rem;">
                    <button type="button" id="t-delete-btn" class="btn"
                        style="background:#ef4444; color:white; display:none;" onclick="app.deleteCurrentTask()">üóëÔ∏è
                        Delete</button>
                    <div style="display:flex; gap:1rem; margin-left:auto;">
                        <button type="button" class="btn btn-outline"
                            onclick="document.getElementById('task-modal').style.display='none'">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- EPIC MODAL -->
    <div id="epic-modal" class="modal">
        <div class="modal-content" style="width:400px">
            <h2 style="margin-bottom:1.5rem">New Epic</h2>
            <form id="epic-form" onsubmit="app.saveEpic(event)">
                <div class="form-group">
                    <label class="form-label">Epic Title</label>
                    <input type="text" id="e-title" class="form-input" required placeholder="e.g. MVP: App Control">
                </div>
                <!-- Release Date Field -->
                <div class="form-group">
                    <label class="form-label">Release Date</label>
                    <input type="date" id="e-deadline" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <input type="color" id="e-color" class="form-input" value="#3b82f6"
                        style="height:40px; cursor:pointer;">
                </div>
                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
                    <button type="button" class="btn btn-outline"
                        onclick="document.getElementById('epic-modal').style.display='none'">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Epic</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SUBTASK MODAL -->
    <div id="subtask-modal" class="modal">
        <div class="modal-content" style="width:420px">
            <h2 style="margin-bottom:1.5rem">Subtask Details</h2>
            <form id="subtask-form" onsubmit="app.saveSubtask(event)">
                <input type="hidden" id="st-card-id">
                <input type="hidden" id="st-index">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="st-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="st-status" class="form-select"></select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="st-start" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" id="st-due" class="form-input">
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:1.5rem;">
                    <button type="button" id="st-delete-btn" class="btn"
                        style="background:#ef4444; color:white; display:none;" onclick="app.deleteSubtask()">üóëÔ∏è
                        Delete</button>
                    <div style="display:flex; gap:1rem; margin-left:auto;">
                        <button type="button" class="btn btn-outline"
                            onclick="document.getElementById('subtask-modal').style.display='none'">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. MODEL ---
        class KanbanModel {
            constructor() {
                this.data = { meta: {}, config: {}, epics: [], cards: [], releases: [] };
                this.embeddedData = {
                    "meta": { "version": "2.1.0" },
                    "config": {
                        "statuses": [
                            { "id": "plan", "label": "–ü–ª–∞–Ω", "icon": "üìã", "color": "#6b7280" },
                            { "id": "in_progress", "label": "–í –ø—Ä–æ—Ü–µ—Å—Å–µ", "icon": "üî®", "color": "#3b82f6" },
                            { "id": "testing", "label": "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è", "icon": "üß™", "color": "#f59e0b" },
                            { "id": "released", "label": "–ì–æ—Ç–æ–≤–æ", "icon": "‚úÖ", "color": "#22c55e" }
                        ],
                        "priorities": {
                            "P0": { "color": "#9333ea" },
                            "P1": { "color": "#ef4444" },
                            "P2": { "color": "#eab308" },
                            "P3": { "color": "#22c55e" }
                        },
                        "blocking_mode": "warning"
                    },
                    "epics": [
                        { "id": "EPIC-1", "title": "MVP: App Control", "color": "#3b82f6", "release_date": "2026-02-01" },
                        { "id": "EPIC-2", "title": "Browser Control", "color": "#ec4899", "release_date": "2026-03-01" }
                    ],
                    "cards": [
                        {
                            "id": "NEXY-001", "epicId": "EPIC-1", "title": "State Manager Thread Safety", "status": "in_progress", "priority": "P1", "owner": "Sergiy", "start_date": "2026-01-05", "due_date": "2026-01-10", "blockedBy": [], "subtasks": [
                                { "title": "Add threading.Lock", "status": "released", "start_date": "2026-01-05", "due_date": "2026-01-06" },
                                { "title": "Test concurrency", "status": "in_progress", "start_date": "2026-01-07", "due_date": "2026-01-09" }
                            ]
                        },
                        { "id": "NEXY-002", "epicId": "EPIC-1", "title": "Launch Apps via AppleScript", "status": "plan", "priority": "P2", "owner": "", "start_date": "2026-01-10", "due_date": "2026-01-15", "blockedBy": ["NEXY-001"], "subtasks": [] },
                        { "id": "NEXY-003", "epicId": "EPIC-2", "title": "Browser Navigation", "status": "plan", "priority": "P0", "owner": "", "start_date": "2026-01-12", "due_date": "2026-01-20", "blockedBy": [], "subtasks": [] }
                    ],
                    "releases": []
                };
            }

            async load() {
                try {
                    // Priority: Try Local Bridge Server API
                    const res = await fetch('/api/data');
                    if (res.ok) {
                        this.data = await res.json();
                        console.log('Loaded data from Local Bridge Server');
                    } else {
                        throw new Error('Server not available');
                    }
                } catch (e) {
                    // Fallback: File fetch or Embedded
                    console.warn('Bridge Server failed, falling back to file/embedded', e);
                    try {
                        const res = await fetch('PROJECT_KANBAN.json');
                        if (res.ok) this.data = await res.json();
                        else this.data = this.embeddedData;
                    } catch (e2) { this.data = this.embeddedData; }
                }
                this.enrichData();
            }

            async save() {
                const payload = JSON.stringify(this.data, null, 4);

                // Try saving to Bridge Server
                try {
                    const res = await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: payload
                    });
                    if (res.ok) {
                        console.log('Saved to Bridge Server');
                        return true; // Saved successfully
                    }
                } catch (e) {
                    console.warn('Failed to save to Bridge Server', e);
                }

                // Fallback: Download file (Old method)
                const blob = new Blob([payload], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'PROJECT_KANBAN.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            enrichData() {
                const map = new Map(this.data.cards.map(c => [c.id, c]));
                this.data.cards.forEach(card => {
                    card._isBlocked = (card.blockedBy || []).some(id => {
                        const blocker = map.get(id.trim());
                        return blocker && blocker.status !== 'released';
                    });
                });
            }



            getCardsByStatus(status, filterEpicId) {
                let cards = this.data.cards.filter(c => c.status === status);

                // Archived filter: by default hide archived, unless showArchived is on
                if (app.showArchived) {
                    cards = cards.filter(c => c.archived === true);
                } else {
                    cards = cards.filter(c => !c.archived);
                }

                // Workspace filter
                if (app.currentWorkspace && app.currentWorkspace !== 'all') {
                    if (app.currentWorkspace === 'master') {
                        cards = cards.filter(c => !c.workspace);
                    } else {
                        cards = cards.filter(c => c.workspace === app.currentWorkspace);
                    }
                }

                if (filterEpicId && filterEpicId !== 'all') {
                    if (filterEpicId === 'my') cards = cards.filter(c => c.owner === 'CurrentUser');
                    else cards = cards.filter(c => c.epicId === filterEpicId);
                }
                return this.sortCards(cards);
            }

            sortCards(cards) {
                const prioOrder = { 'P0': 0, 'P1': 1, 'P2': 2, 'P3': 3 };
                return cards.sort((a, b) => (prioOrder[a.priority] ?? 99) - (prioOrder[b.priority] ?? 99) || (a.due_date || '').localeCompare(b.due_date || ''));
            }

            updateCardStatus(cardId, newStatus) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (!card) return;

                // Blocking Check
                if (newStatus === 'released' && card._isBlocked && this.data.config.blocking_mode === 'warning') {
                    if (!confirm(`Task ${card.id} is blocked by ${card.blockedBy.join(', ')}. Move anyway?`)) return false;
                }

                card.status = newStatus;
                card.updated_at = new Date().toISOString().split('T')[0];
                this.enrichData();
                return true;
            }

            createRelease() {
                const ready = this.data.cards.filter(c => c.status === 'released');
                if (ready.length === 0) return alert('No tasks in Released column');

                const version = prompt("Enter Release Version (e.g. 1.0.1):");
                if (!version) return;

                const log = ready.map(c => `- [${c.id}] ${c.title}`).join('\n');

                // Add to Releases
                this.data.releases = this.data.releases || [];
                this.data.releases.push({ version, date: new Date().toISOString().split('T')[0], log, cards: ready });

                // Remove from active cards
                this.data.cards = this.data.cards.filter(c => c.status !== 'released');
                alert('Release created! Tasks archived.');
            }

            saveTask(task) {
                if (task.id) {
                    const idx = this.data.cards.findIndex(c => c.id === task.id);
                    if (idx !== -1) this.data.cards[idx] = { ...this.data.cards[idx], ...task };
                } else {
                    const newId = "NEXY-" + (Math.max(...this.data.cards.map(c => parseInt(c.id.split('-')[1]) || 0), 0) + 1).toString().padStart(3, '0');
                    this.data.cards.push({ ...task, id: newId, status: 'plan', created_at: new Date().toISOString() });
                }
                this.enrichData();
            }

            getStatuses() {
                return this.data.config.statuses || [];
            }

            getMetrics() {
                return {
                    total: this.data.cards.length,
                    in_progress: this.data.cards.filter(c => c.status === 'in_progress').length,
                    blocked: this.data.cards.filter(c => c._isBlocked).length,
                    release_ready: this.data.cards.filter(c => c.status === 'released').length
                };
            }

            getStatusColor(statusId) {
                const status = (this.data.config.statuses || []).find(s => s.id === statusId);
                return status?.color || '#6b7280';
            }

            deleteTask(id) {
                if (!confirm(`Delete task ${id}?`)) return false;
                this.data.cards = this.data.cards.filter(c => c.id !== id);
                return true;
            }

            deleteEpic(id) {
                const tasksInEpic = this.data.cards.filter(c => c.epicId === id).length;
                if (!confirm(`Delete Epic and ${tasksInEpic} tasks in it?`)) return false;
                this.data.epics = this.data.epics.filter(e => e.id !== id);
                this.data.cards = this.data.cards.filter(c => c.epicId !== id);
                return true;
            }

            toggleSubtask(cardId, subtaskIndex) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (card && card.subtasks && card.subtasks[subtaskIndex]) {
                    card.subtasks[subtaskIndex].done = !card.subtasks[subtaskIndex].done;
                }
            }

            // Subtask methods for full schema
            addSubtask(cardId, subtask) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (card) {
                    card.subtasks = card.subtasks || [];
                    card.subtasks.push({
                        title: subtask.title || 'New Subtask',
                        status: subtask.status || 'plan',
                        start_date: subtask.start_date || '',
                        due_date: subtask.due_date || ''
                    });
                }
            }

            updateSubtask(cardId, index, subtask) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (card && card.subtasks && card.subtasks[index]) {
                    card.subtasks[index] = { ...card.subtasks[index], ...subtask };
                }
            }

            removeSubtask(cardId, index) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (card && card.subtasks) {
                    card.subtasks.splice(index, 1);
                }
            }

            cycleSubtaskStatus(cardId, index) {
                const card = this.data.cards.find(c => c.id === cardId);
                if (card && card.subtasks && card.subtasks[index]) {
                    const statuses = ['plan', 'in_progress', 'testing', 'released'];
                    const current = card.subtasks[index].status || 'plan';
                    const nextIdx = (statuses.indexOf(current) + 1) % statuses.length;
                    card.subtasks[index].status = statuses[nextIdx];
                }
            }
        }

        // --- 2. VIEW ---
        class KanbanView {
            constructor(model) {
                this.model = model;
                this.els = {
                    board: document.getElementById('view-board'),
                    gantt: document.getElementById('view-gantt'),
                    epicsList: document.getElementById('epics-list'),
                    metrics: {
                        total: document.getElementById('m-total'),
                        prog: document.getElementById('m-progress'),
                        blocked: document.getElementById('m-blocked'),
                        rel: document.getElementById('m-release')
                    }
                };
            }

            render() {
                this.renderSidebar();
                this.renderMetrics();
                if (app.currentView === 'board') this.renderBoard();
                else this.renderGantt();
            }

            renderSidebar() {
                const epics = (this.model.data.epics || []);
                const cards = this.model.data.cards || [];
                this.els.epicsList.innerHTML = `
                    <div class="nav-item ${app.currentFilter === 'all' ? 'active' : ''}" onclick="app.filterByEpic('all')">
                        üìö All Tasks <span style="opacity:0.5; margin-left:auto;">${cards.length}</span>
                    </div>
                ` + epics.map(epic => {
                    const count = cards.filter(c => c.epicId === epic.id).length;
                    return `
                    <div class="nav-item ${app.currentFilter === epic.id ? 'active' : ''}" style="display:flex; align-items:center;">
                        <div style="flex:1; display:flex; align-items:center; gap:0.5rem;" onclick="app.filterByEpic('${epic.id}')">
                            <div class="epic-dot" style="background:${epic.color}"></div>
                            <span>${epic.title}</span>
                            <span style="opacity:0.5; font-size:0.75rem;">(${count})</span>
                        </div>
                        <button onclick="app.openTaskModal(null, '${epic.id}'); event.stopPropagation();" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;" title="Add task">‚ûï</button>
                        <button onclick="app.deleteEpic('${epic.id}'); event.stopPropagation();" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.8rem; opacity:0.5;" title="Delete Epic" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">üóëÔ∏è</button>
                    </div>`;
                }).join('') + `
                    <hr style="border:none; border-top:1px solid #333; margin:12px 0;">
                    <div style="font-size:11px; color:#888; margin-bottom:6px;">üåê Workspace</div>
                    <div class="nav-item ${app.currentWorkspace === 'all' ? 'active' : ''}" onclick="app.filterByWorkspace('all')">
                        üåç All <span style="opacity:0.5; margin-left:auto;">${cards.length}</span>
                    </div>
                    <div class="nav-item ${app.currentWorkspace === 'client' ? 'active' : ''}" onclick="app.filterByWorkspace('client')">
                        üíª Client <span style="opacity:0.5; margin-left:auto;">${cards.filter(c => c.workspace === 'client').length}</span>
                    </div>
                    <div class="nav-item ${app.currentWorkspace === 'server' ? 'active' : ''}" onclick="app.filterByWorkspace('server')">
                        üñ•Ô∏è Server <span style="opacity:0.5; margin-left:auto;">${cards.filter(c => c.workspace === 'server').length}</span>
                    </div>
                    <div class="nav-item ${app.currentWorkspace === 'master' ? 'active' : ''}" onclick="app.filterByWorkspace('master')">
                        üëë Master <span style="opacity:0.5; margin-left:auto;">${cards.filter(c => !c.workspace).length}</span>
                    </div>
                `;
            }

            renderMetrics() {
                const m = this.model.getMetrics();
                this.els.metrics.total.textContent = m.total;
                this.els.metrics.prog.textContent = m.in_progress;
                this.els.metrics.blocked.textContent = m.blocked;
                this.els.metrics.rel.textContent = m.release_ready;
            }

            renderBoard() {
                const statuses = this.model.getStatuses();
                this.els.board.innerHTML = statuses.map(status => {
                    const cards = this.model.getCardsByStatus(status.id, app.currentFilter);
                    return `
                    <div class="column" ondragover="app.allowDrop(event)" ondrop="app.drop(event, '${status.id}')">
                        <div class="column-header">
                            <span>${status.icon} ${status.label}</span>
                            <span style="opacity:0.5">${cards.length}</span>
                            ${status.id === 'released' && cards.length > 0 ?
                            `<button onclick="app.shipRelease()" style="font-size:10px; margin-left:auto; cursor:pointer; background:#22c55e; border:none; color:white; border-radius:4px; padding:2px 6px;">üöÄ Ship Release</button>`
                            : ''}
                        </div>
                        <div class="column-cards">${cards.map(c => this.createCardHtml(c)).join('')}</div>
                    </div>`;
                }).join('');
            }

            createCardHtml(card) {
                const epic = (this.model.data.epics || []).find(e => e.id === card.epicId);
                const color = (this.model.data.config.priorities[card.priority] || {}).color || '#888';
                const subtasks = card.subtasks || [];
                const doneCount = subtasks.filter(s => s.status === 'released').length;
                const totalCount = subtasks.length;

                // Collapsible subtask list with status colors
                const subtaskHtml = totalCount > 0 ? `
                    <details style="margin-top:8px; font-size:11px;" onclick="event.stopPropagation();">
                        <summary style="cursor:pointer; color:var(--text-secondary); display:flex; align-items:center; gap:6px; user-select:none;">
                            <span style="font-size:10px;">‚ñ∂</span>
                            <span>Subtasks</span>
                            <span style="background:${doneCount === totalCount ? '#22c55e33' : '#3b82f633'}; color:${doneCount === totalCount ? '#22c55e' : '#3b82f6'}; padding:1px 6px; border-radius:10px; font-size:10px;">${doneCount}/${totalCount}</span>
                        </summary>
                        <div style="margin-top:6px; padding-left:8px; border-left:2px solid #333;">
                            ${subtasks.map((st, i) => {
                    const stColor = this.model.getStatusColor(st.status);
                    const isDone = st.status === 'released';
                    return `
                                <div style="display:flex; align-items:center; gap:6px; padding:4px 0; cursor:pointer;" onclick="app.openSubtaskModal('${card.id}', ${i}); event.stopPropagation();">
                                    <span style="width:8px; height:8px; background:${stColor}; border-radius:50%; flex-shrink:0;"></span>
                                    <span style="flex:1; ${isDone ? 'text-decoration:line-through; opacity:0.5;' : ''}">${st.title}</span>
                                    ${st.due_date ? `<span style="font-size:9px; color:#888;">${st.due_date.slice(5)}</span>` : ''}
                                </div>`;
                }).join('')}
                            <div style="padding:4px 0; cursor:pointer; color:#666; font-size:10px;" onclick="app.openSubtaskModal('${card.id}', -1); event.stopPropagation();">
                                ‚ûï Add subtask...
                            </div>
                        </div>
                    </details>` : `
                    <div style="margin-top:8px; font-size:10px; color:#666; cursor:pointer;" onclick="app.openSubtaskModal('${card.id}', -1); event.stopPropagation();">
                        ‚ûï Add subtask...
                    </div>`;

                return `
                <div class="card" draggable="true" id="${card.id}" ondragstart="app.drag(event)" onclick="app.openTaskModal('${card.id}')">
                    <div class="card-meta">
                        <span class="card-id">${card.id}</span>
                        ${card.workspace ? `<span style="font-size:9px; padding:1px 4px; border-radius:3px; background:${card.workspace === 'client' ? '#3b82f622' : '#22c55e22'}; color:${card.workspace === 'client' ? '#3b82f6' : '#22c55e'};">${card.workspace === 'client' ? 'CLI' : 'SRV'}</span>` : ''}
                        <div style="display:flex; align-items:center; margin-left:auto;">
                            ${epic ? `<span class="epic-badge" style="border:1px solid ${epic.color}; color:${epic.color}">${epic.title}</span>` : ''}
                            <span class="card-priority" style="background:${color}22; color:${color}">${card.priority}</span>
                        </div>
                    </div>
                    <div class="card-title">${card.title}</div>
                    ${card.file_path ? `
                    <div style="margin-top:4px;">
                        <button onclick="app.openFile('${card.file_path.replace(/'/g, "\\'")}'); event.stopPropagation();" style="border:1px solid #444; background:#222; color:#aaa; border-radius:3px; padding:2px 6px; font-size:10px; cursor:pointer;">
                            üìÑ Open File
                        </button>
                    </div>` : ''}
                    ${card.registry_ref ? `
                    <div style="margin-top:8px;">
                        <div style="display:flex; justify-content:space-between; font-size:9px; color:#888; margin-bottom:2px;">
                            <span title="Synced with ${card.registry_ref}">‚ö° ${card.registry_ref}</span>
                            <span>${card.progress || 0}%</span>
                        </div>
                        <div style="background:#333; height:4px; border-radius:2px; overflow:hidden;">
                            <div style="width:${card.progress || 0}%; height:100%; background:var(--accent-color);"></div>
                        </div>
                    </div>` : ''}
                    ${card._isBlocked ? `<div class="blocked-badge">üîí Blocked by ${card.blockedBy.join(', ')}</div>` : ''}
                    ${subtaskHtml}
                    <div class="card-footer">
                        <span>${card.owner || 'Unassigned'}</span>
                        ${card.modified_by ? `<span style="font-size:9px; color:#888;" title="Last modified by ${card.modified_by}">ü§ñ ${card.modified_by.slice(0, 3)}</span>` : ''}
                        <span>${card.estimate || ''}</span>
                    </div>
                </div>`;
            }

            renderGantt() {
                const epics = this.model.data.epics || [];
                const cards = this.model.data.cards;
                const start = new Date("2026-01-01");
                const dayW = 18, headerH = 45, rowH = 32;
                const leftCol = 200; // Width of left task list column
                let y = headerH + 10;

                // Date Header (Weeks with days)
                const numWeeks = 10;
                let header = `<div style="position:sticky; top:0; background:var(--bg-primary); z-index:10; display:flex; border-bottom:1px solid #444;">`;
                header += `<div style="width:${leftCol}px; padding:8px; font-weight:600; color:#888; border-right:1px solid #333;">Task</div>`;
                header += `<div style="flex:1; display:flex; position:relative;">`;
                for (let w = 0; w < numWeeks; w++) {
                    const weekStart = new Date(start.getTime() + w * 7 * 86400000);
                    const weekLabel = `${weekStart.getDate()} ${weekStart.toLocaleDateString('ru', { month: 'short' })}`;
                    header += `<div style="width:${7 * dayW}px; padding:6px 4px; font-size:11px; color:#888; border-left:1px dashed #333;">${weekLabel}</div>`;
                }
                header += `</div></div>`;

                let rows = '';
                epics.forEach(epic => {
                    // Epic header row with Release Date
                    let releaseMarker = '';
                    if (epic.release_date) {
                        const rd = new Date(epic.release_date);
                        const rX = Math.max(0, (rd - start) / 86400000 * dayW);
                        releaseMarker = `<div style="position:absolute; left:${rX}px; top:0; bottom:0; width:2px; background:${epic.color}; border-right:1px dashed ${epic.color}; opacity:0.5; z-index:0;" title="Release: ${epic.release_date}">
                            <div style="position:absolute; top:2px; left:2px; font-size:10px; color:${epic.color}; white-space:nowrap;">üèÅ Release</div>
                        </div>`;
                    }

                    rows += `<div style="display:flex; border-bottom:1px solid #333; height:${rowH}px; background:${epic.color}11; position:relative;">
                        <div style="width:${leftCol}px; padding:0 8px; font-weight:600; font-size:12px; color:${epic.color}; border-right:1px solid #333; display:flex; align-items:center; gap:6px;">
                            <span style="font-size:14px;">‚óè</span> ${epic.title}
                            <button onclick="app.openTaskModal(null, '${epic.id}'); event.stopPropagation();" style="margin-left:auto; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;" title="Add task">‚ûï</button>
                        </div>
                        <div style="flex:1; position:relative;">
                            ${releaseMarker}
                        </div>
                    </div>`;

                    const epicCards = cards.filter(c => c.epicId === epic.id);
                    epicCards.forEach(card => {
                        const s = card.start_date ? new Date(card.start_date) : new Date();
                        const e = card.due_date ? new Date(card.due_date) : new Date(s.getTime() + 86400000 * 3);
                        const xPos = Math.max(0, (s - start) / 86400000 * dayW);
                        const w = Math.max(dayW * 2, (e - s) / 86400000 * dayW);
                        const color = this.model.getStatusColor(card.status);

                        // Subtasks
                        const subtasks = card.subtasks || [];
                        const doneCount = subtasks.filter(st => st.status === 'released').length;
                        const totalCount = subtasks.length;
                        const hasSubtasks = totalCount > 0;

                        // Task row with expand toggle if has subtasks
                        rows += `<div class="gantt-task-group" data-card="${card.id}">`;
                        rows += `<div style="display:flex; border-bottom:1px solid #222; min-height:${rowH}px;">`;
                        // Left: Task title with toggle
                        rows += `<div style="width:${leftCol}px; padding:6px 8px; font-size:12px; color:var(--text-primary); border-right:1px solid #333; display:flex; align-items:center; gap:6px;">`;
                        if (hasSubtasks) {
                            rows += `<span onclick="this.parentElement.parentElement.nextElementSibling.classList.toggle('hide'); this.textContent = this.textContent === '‚ñº' ? '‚ñ∂' : '‚ñº';" style="cursor:pointer; font-size:10px; user-select:none;">‚ñ∂</span>`;
                        } else {
                            rows += `<span style="width:10px;"></span>`;
                        }
                        rows += `<span style="width:6px; height:6px; background:${color}; border-radius:50%; flex-shrink:0;"></span>`;
                        rows += `<span onclick="app.openTaskModal('${card.id}')" style="flex:1; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${card.title}</span>`;
                        if (hasSubtasks) {
                            rows += `<span style="font-size:10px; color:${doneCount === totalCount ? '#22c55e' : '#888'}; padding:1px 5px; background:${doneCount === totalCount ? '#22c55e22' : '#33333377'}; border-radius:8px;">${doneCount}/${totalCount}</span>`;
                        }
                        rows += `</div>`;
                        // Right: Timeline bar
                        rows += `<div style="flex:1; position:relative; height:100%;">`;
                        rows += `<div style="position:absolute; left:${xPos}px; top:6px; width:${w}px; height:20px; background:${color}; border-radius:4px; opacity:0.85; display:flex; align-items:center; padding:0 6px; font-size:9px; color:white; overflow:hidden; cursor:pointer;" onclick="app.openTaskModal('${card.id}')" title="${s.toLocaleDateString('ru')} ‚Üí ${e.toLocaleDateString('ru')}">
                            ${s.getDate()}/${s.getMonth() + 1} - ${e.getDate()}/${e.getMonth() + 1}
                        </div>`;
                        rows += `</div></div>`;

                        // Subtasks rows with timeline bars (collapsible, hidden by default)
                        if (hasSubtasks) {
                            rows += `<div class="hide" style="background:#0d0d1a;">`;
                            subtasks.forEach((st, i) => {
                                const stColor = this.model.getStatusColor(st.status);
                                const stStart = st.start_date ? new Date(st.start_date) : s;
                                const stEnd = st.due_date ? new Date(st.due_date) : new Date(stStart.getTime() + 86400000);
                                const stXPos = Math.max(0, (stStart - start) / 86400000 * dayW);
                                const stW = Math.max(dayW, (stEnd - stStart) / 86400000 * dayW);
                                const isDone = st.status === 'released';

                                rows += `<div style="display:flex; border-bottom:1px solid #1a1a2e; min-height:28px;">`;
                                // Left: Subtask title
                                rows += `<div onclick="app.openSubtaskModal('${card.id}', ${i})" style="width:${leftCol}px; padding:4px 8px 4px 36px; font-size:11px; color:var(--text-secondary); border-right:1px solid #333; display:flex; align-items:center; gap:6px; cursor:pointer;">`;
                                rows += `<span style="width:6px; height:6px; background:${stColor}; border-radius:50%; flex-shrink:0;"></span>`;
                                rows += `<span style="flex:1; overflow:hidden; text-overflow:ellipsis; ${isDone ? 'text-decoration:line-through; opacity:0.5;' : ''}">${st.title}</span>`;
                                rows += `</div>`;
                                // Right: Subtask timeline bar
                                rows += `<div style="flex:1; position:relative; height:100%;">`;
                                rows += `<div onclick="app.openSubtaskModal('${card.id}', ${i})" style="position:absolute; left:${stXPos}px; top:4px; width:${stW}px; height:16px; background:${stColor}88; border-radius:3px; cursor:pointer; font-size:8px; color:white; display:flex; align-items:center; padding:0 4px; overflow:hidden;" title="${st.start_date || ''} ‚Üí ${st.due_date || ''}">
                                    ${st.start_date ? `${stStart.getDate()}/${stStart.getMonth() + 1}` : ''}
                                </div>`;
                                rows += `</div></div>`;
                            });
                            // Add subtask row
                            rows += `<div style="display:flex; border-bottom:1px solid #1a1a2e; min-height:24px; opacity:0.5;" onclick="app.openSubtaskModal('${card.id}', -1)" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.5'">`;
                            rows += `<div style="width:${leftCol}px; padding:4px 8px 4px 36px; font-size:10px; color:#666; cursor:pointer;">‚ûï Add subtask...</div>`;
                            rows += `<div style="flex:1;"></div></div>`;
                            rows += `</div>`;
                        }
                        rows += `</div>`;
                    });

                    // Add Task row for this epic
                    rows += `<div style="display:flex; border-bottom:1px solid #333; height:${rowH}px; opacity:0.6;" onclick="app.openTaskModal(null, '${epic.id}')" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">`;
                    rows += `<div style="width:${leftCol}px; padding:6px 8px; cursor:pointer; font-size:11px; color:var(--text-secondary); display:flex; align-items:center; gap:6px;">
                        <span style="font-size:14px;">‚ûï</span> Add task...
                    </div>`;
                    rows += `<div style="flex:1;"></div></div>`;
                });

                // Today marker (calculate position)
                const today = new Date();
                const todayX = leftCol + (today - start) / 86400000 * dayW;
                const todayMarker = `<div style="position:absolute; left:${todayX}px; top:${headerH}px; bottom:0; width:2px; background:#ef4444; z-index:5;">
                    <div style="position:absolute; top:-18px; left:-15px; font-size:9px; color:#ef4444; font-weight:600;">TODAY</div>
                </div>`;

                this.els.gantt.innerHTML = `<div style="position:relative; min-width:${leftCol + numWeeks * 7 * dayW}px;">
                    ${header}
                    <div style="position:relative;">${rows}${todayMarker}</div>
                </div>`;
            }
        }

        // --- 3. CONTROLLER ---
        class App {
            constructor() {
                this.model = new KanbanModel();
                this.view = new KanbanView(this.model);
                this.currentFilter = 'all';
                this.currentWorkspace = 'all';
                this.currentView = 'board';
                this.showArchived = false;
            }

            async init() {
                await this.model.load();
                this.view.render();
            }

            async openFile(path) {
                try {
                    const res = await fetch('/api/open_file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path })
                    });
                    if (!res.ok) alert('Failed to open file via server');
                } catch (e) {
                    alert('Could not open file. Is Local Bridge Server running?');
                }
            }

            filterByEpic(id) { this.showArchived = false; this.currentFilter = id; this.view.render(); }
            filterByWorkspace(ws) { this.currentWorkspace = ws; this.view.render(); }
            toggleArchived() {
                this.showArchived = !this.showArchived;
                document.getElementById('nav-archived').classList.toggle('active', this.showArchived);
                this.view.render();
            }
            switchView(v) {
                this.currentView = v;
                document.getElementById('view-board').classList.toggle('hide', v !== 'board');
                document.getElementById('view-gantt').classList.toggle('hide', v !== 'gantt');
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                this.view.render();
            }

            drag(ev) { ev.dataTransfer.setData("text", ev.target.id); ev.target.classList.add('dragging'); }
            allowDrop(ev) { ev.preventDefault(); ev.target.closest('.column')?.classList.add('drag-over'); }
            drop(ev, newStatus) {
                ev.preventDefault();
                const id = ev.dataTransfer.getData("text");
                document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
                document.getElementById(id)?.classList.remove('dragging');
                if (this.model.updateCardStatus(id, newStatus)) this.view.render();
            }

            async shipRelease() {
                const version = prompt("Enter Release Version (e.g. v1.1.0):");
                if (!version) return;

                if (!confirm(`Ship release ${version}? This will archive all 'Released' cards and generate CHANGELOG.`)) return;

                try {
                    const res = await fetch('/api/create_release', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ version })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        alert(data.message);
                        await this.init(); // Reload all data
                    } else {
                        alert('Error: ' + (data.message || 'Unknown server error'));
                    }
                } catch (e) {
                    alert('Bridge Server connection failed');
                    console.error(e);
                }
            }

            openTaskModal(id, defaultEpicId = null) {
                this.currentEditingTaskId = id || null;
                const card = id ? this.model.data.cards.find(c => c.id === id) : {};

                document.getElementById('t-id').value = id || '';
                document.getElementById('t-title').value = card.title || '';
                document.getElementById('t-prio').value = card.priority || 'P2';
                document.getElementById('t-owner').value = card.owner || '';
                document.getElementById('t-est').value = card.estimate || '';
                document.getElementById('t-start').value = card.start_date || '';
                document.getElementById('t-due').value = card.due_date || '';
                document.getElementById('t-blocked').value = (card.blockedBy || []).join(', ');

                // Populate Statuses
                const statuses = this.model.getStatuses();
                const statusSelect = document.getElementById('t-status');
                statusSelect.innerHTML = statuses.map(s => `<option value="${s.id}" ${card.status === s.id ? 'selected' : ''}>${s.icon} ${s.label}</option>`).join('');

                // Populate Epics
                const epics = this.model.data.epics || [];
                const epicSelect = document.getElementById('t-epic');
                const selectedEpic = card.epicId || defaultEpicId || '';
                epicSelect.innerHTML = `<option value="">No Epic</option>` + epics.map(e => `<option value="${e.id}" ${selectedEpic === e.id ? 'selected' : ''}>${e.title}</option>`).join('');

                // Render Subtasks
                this.renderSubtasksInModal(card.subtasks || []);

                // Show/hide delete button
                document.getElementById('t-delete-btn').style.display = id ? 'block' : 'none';

                document.getElementById('task-modal').style.display = 'flex';
            }

            renderSubtasksInModal(subtasks) {
                const container = document.getElementById('t-subtasks');
                if (!subtasks || subtasks.length === 0) {
                    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px; font-style:italic;">No subtasks</div>';
                    return;
                }
                container.innerHTML = subtasks.map((st, i) => {
                    const color = this.model.getStatusColor(st.status);
                    const isDone = st.status === 'released';
                    return `
                    <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #333; cursor:pointer;" onclick="app.openSubtaskModal('${this.currentEditingTaskId}', ${i})">
                        <span style="width:8px; height:8px; background:${color}; border-radius:50%; flex-shrink:0;"></span>
                        <span style="flex:1; font-size:12px; ${isDone ? 'text-decoration:line-through; opacity:0.5;' : ''}">${st.title}</span>
                        ${st.due_date ? `<span style="font-size:10px; color:#888;">${st.due_date}</span>` : ''}
                        <span style="font-size:12px; color:var(--text-secondary);">‚úèÔ∏è</span>
                    </div>`;
                }).join('');
            }

            // For inline toggle from card/gantt view
            toggleSubtask(cardId, index) {
                this.model.toggleSubtask(cardId, index);
                this.view.render();
            }

            addSubtaskFromModal() {
                const input = document.getElementById('t-new-subtask');
                const title = input.value.trim();
                // If user types and hits add, just open modal with that title pre-filled? 
                // Or better: clicking "New Subtask" button opens empty modal.
                // Let's keep the quick add but with default status 'plan'.
                if (!title) return;

                if (this.currentEditingTaskId) {
                    this.model.addSubtask(this.currentEditingTaskId, { title: title });
                    const card = this.model.data.cards.find(c => c.id === this.currentEditingTaskId);
                    this.renderSubtasksInModal(card?.subtasks || []);
                }
                input.value = '';
            }

            deleteCurrentTask() {
                if (this.currentEditingTaskId && this.model.deleteTask(this.currentEditingTaskId)) {
                    document.getElementById('task-modal').style.display = 'none';
                    this.view.render();
                }
            }

            deleteEpic(epicId) {
                if (this.model.deleteEpic(epicId)) {
                    this.view.render();
                }
            }

            // Subtask Modal Methods
            openSubtaskModal(cardId, index) {
                this.currentSubtaskCardId = cardId;
                this.currentSubtaskIndex = index;

                const card = this.model.data.cards.find(c => c.id === cardId);
                const subtask = index >= 0 && card?.subtasks?.[index] ? card.subtasks[index] : {};
                const isNew = index < 0;

                document.getElementById('st-card-id').value = cardId;
                document.getElementById('st-index').value = index;
                document.getElementById('st-title').value = subtask.title || '';
                document.getElementById('st-start').value = subtask.start_date || '';
                document.getElementById('st-due').value = subtask.due_date || '';

                // Populate status dropdown
                const statuses = this.model.getStatuses();
                const statusSelect = document.getElementById('st-status');
                statusSelect.innerHTML = statuses.map(s =>
                    `<option value="${s.id}" ${subtask.status === s.id ? 'selected' : ''}>${s.icon} ${s.label}</option>`
                ).join('');

                // Show/hide delete button
                document.getElementById('st-delete-btn').style.display = isNew ? 'none' : 'block';

                document.getElementById('subtask-modal').style.display = 'flex';
            }

            saveSubtask(e) {
                e.preventDefault();
                const cardId = document.getElementById('st-card-id').value;
                const index = parseInt(document.getElementById('st-index').value);
                const subtask = {
                    title: document.getElementById('st-title').value,
                    status: document.getElementById('st-status').value,
                    start_date: document.getElementById('st-start').value,
                    due_date: document.getElementById('st-due').value
                };

                if (index < 0) {
                    this.model.addSubtask(cardId, subtask);
                } else {
                    this.model.updateSubtask(cardId, index, subtask);
                }

                document.getElementById('subtask-modal').style.display = 'none';
                this.view.render();
            }

            deleteSubtask() {
                const cardId = this.currentSubtaskCardId;
                const index = this.currentSubtaskIndex;
                if (cardId && index >= 0) {
                    this.model.removeSubtask(cardId, index);
                    document.getElementById('subtask-modal').style.display = 'none';
                    this.view.render();
                }
            }

            saveTask(e) {
                e.preventDefault();
                const blocked = document.getElementById('t-blocked').value.split(',').map(s => s.trim()).filter(s => s);
                const task = {
                    id: document.getElementById('t-id').value,
                    title: document.getElementById('t-title').value,
                    status: document.getElementById('t-status').value,
                    epicId: document.getElementById('t-epic').value,
                    priority: document.getElementById('t-prio').value,
                    owner: document.getElementById('t-owner').value,
                    estimate: document.getElementById('t-est').value,
                    start_date: document.getElementById('t-start').value,
                    due_date: document.getElementById('t-due').value,
                    blockedBy: blocked
                };
                this.model.saveTask(task);
                document.getElementById('task-modal').style.display = 'none';
                this.view.render();
            }
            createEpic() {
                document.getElementById('e-title').value = '';
                document.getElementById('e-deadline').value = '';
                document.getElementById('e-color').value = '#3b82f6';
                document.getElementById('epic-modal').style.display = 'flex';
            }

            saveEpic(e) {
                e.preventDefault();
                const title = document.getElementById('e-title').value.trim();
                const release_date = document.getElementById('e-deadline').value;
                const color = document.getElementById('e-color').value;
                if (title) {
                    this.model.data.epics.push({ id: 'EPIC-' + Date.now(), title, color, release_date });
                    this.view.render();
                }
                document.getElementById('epic-modal').style.display = 'none';
            }
        }

        const app = new App();
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>