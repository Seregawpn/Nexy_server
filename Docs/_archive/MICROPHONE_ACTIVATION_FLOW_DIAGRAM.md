# Схема потока активации микрофона

## Полный цикл работы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СОСТОЯНИЕ: SLEEPING                                │
│  - Микрофон: idle                                                           │
│  - Режим: SLEEPING                                                          │
│  - _recording_started: False                                                │
│  - _playback_active: False                                                  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             │ Пользователь нажимает Ctrl+N
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    InputProcessingIntegration                                 │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _handle_press() → _input_state = PENDING                            │  │
│  │ _pending_session_id = new_session_id                                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _handle_long_press() (после 0.6s удержания)                         │  │
│  │  ├─ Проверка: _can_start_recording()                                 │  │
│  │  │   ├─ _input_state == PENDING? ✓                                  │  │
│  │  │   ├─ _pending_session_id != None? ✓                             │  │
│  │  │   ├─ _playback_active == False? ✓                                │  │
│  │  │   └─ playback grace period прошёл? ✓                              │  │
│  │  ├─ Ожидание закрытия микрофона (если активен)                       │  │
│  │  │   └─ _wait_for_mic_closed_with_timeout(0.5s)                    │  │
│  │  ├─ Публикация: voice.recording_start                               │  │
│  │  │   └─ {session_id, source="keyboard"}                            │  │
│  │  └─ Установка: _recording_started = True                            │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    VoiceRecognitionIntegration                                │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _on_recording_start()                                                 │  │
│  │  ├─ Проверки блокировки:                                              │  │
│  │  │   ├─ PROCESSING + source != "keyboard" → блокировка                │  │
│  │  │   ├─ _first_run_in_progress → блокировка                          │  │
│  │  │   └─ cooldown не прошёл → блокировка                              │  │
│  │  ├─ Установка: _recording_active = True                              │  │
│  │  ├─ Установка: _set_session_id(session_id)                           │  │
│  │  └─ [Если _use_avf == True]                                          │  │
│  │     ├─ AVF диагностика (~1 секунда)                                  │  │
│  │     │   ├─ AVFAudioEngine.start_input()                             │  │
│  │     │   ├─ await asyncio.sleep(1.0)                                 │  │
│  │     │   └─ AVFAudioEngine.stop_input()  ✅ ДЕАКТИВАЦИЯ              │  │
│  │     ├─ Пауза для деактивации AVF (0.2s)                              │  │
│  │     └─ Проверка: AVF полностью деактивирован                         │  │
│  │  └─ Google Speech Recognition активация                              │  │
│  │     ├─ Создание recognizer и microphone                              │  │
│  │     ├─ adjust_for_ambient_noise()                                    │  │
│  │     ├─ Установка: _google_recording_active = True                    │  │
│  │     ├─ listen_in_background(microphone, callback)                    │  │
│  │     │   └─ Возвращает: _google_stop_listening                        │  │
│  │     └─ Публикация: microphone.opened {session_id}                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СОСТОЯНИЕ: LISTENING                              │
│  - Микрофон: active                                                         │
│  - Режим: LISTENING                                                         │
│  - _recording_started: True                                                 │
│  - _google_recording_active: True                                           │
│  - Callback от listen_in_background получает аудио                          │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             │ Пользователь отпускает Ctrl+N
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    InputProcessingIntegration                                 │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _handle_key_release()                                                 │  │
│  │  ├─ Проверка: was_recording = _recording_started || mic_active        │  │
│  │  ├─ Публикация: voice.recording_stop {session_id}                     │  │
│  │  └─ Публикация: mode.request {target=PROCESSING}                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    VoiceRecognitionIntegration                                │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _on_recording_stop()                                                  │  │
│  │  ├─ Проверка session_id: active_session_id == request_session_id      │  │
│  │  ├─ Остановка Google записи:                                           │  │
│  │  │   ├─ Ожидание чанков (chunk_wait = 1.0s)                          │  │
│  │  │   ├─ _google_recording_active = False  ✅ ПЕРЕД остановкой        │  │
│  │  │   ├─ _google_stop_listening(wait_for_stop=False)                   │  │
│  │  │   └─ await asyncio.sleep(callback_wait = 0.5s)                    │  │
│  │  ├─ Объединение чанков из _google_audio_chunks                        │  │
│  │  ├─ Распознавание: _recognize_google_audio()                          │  │
│  │  ├─ Публикация: voice.recognition_completed/failed                    │  │
│  │  ├─ state_manager.set_microphone_state("idle", session_id=None)       │  │
│  │  └─ Публикация: microphone.closed {session_id}                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СОСТОЯНИЕ: PROCESSING                             │
│  - Микрофон: idle                                                           │
│  - Режим: PROCESSING                                                        │
│  - _recording_started: False                                                │
│  - _playback_active: True                                                   │
│  - Воспроизведение ответа ассистента                                        │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             │ playback.completed
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    InputProcessingIntegration                                 │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _on_playback_finished()                                               │  │
│  │  ├─ Проверка: mic_active && _recording_started → НЕ сбрасывать сессию│  │
│  │  ├─ ⚠️ ПРОБЛЕМА: Если mic_active == True, микрофон должен быть       │  │
│  │  │   принудительно закрыт (но сейчас этого нет!)                      │  │
│  │  ├─ Сброс сессии: _reset_session("playback_completed")               │  │
│  │  │   ├─ _recording_started = False                                    │  │
│  │  │   ├─ _pending_session_id = None                                    │  │
│  │  │   └─ _active_grpc_session_id = None                                │  │
│  │  └─ _notify_playback_idle()                                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ProcessingWorkflow                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ _return_to_sleeping()                                                 │  │
│  │  ├─ Публикация: mode.request {target=SLEEPING}                        │  │
│  │  └─ _cleanup_processing()                                             │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СОСТОЯНИЕ: SLEEPING                                │
│  - Микрофон: idle (⚠️ ДОЛЖЕН быть idle, но может быть active!)             │
│  - Режим: SLEEPING                                                          │
│  - _recording_started: False                                                │
│  - _playback_active: False                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Критические точки проблем

### 🔴 Проблема 1: Автоматическая активация после playback.completed

```
playback.completed
    ↓
_on_playback_finished()
    ├─ mic_active = state_manager.is_microphone_active()
    ├─ ⚠️ ПРОБЛЕМА: Если mic_active == True, микрофон НЕ закрывается
    └─ _reset_session()  # Сбрасывает только локальные флаги
        ↓
    [Микрофон остается активным!]
        ↓
    [При следующем LONG_PRESS микрофон может активироваться автоматически]
```

**Решение:**
- Принудительно закрывать микрофон в `_on_playback_finished()`, если `mic_active == True`
- Публиковать `voice.recording_stop` с `session_id=None` для закрытия любого активного микрофона

---

### 🔴 Проблема 2: Callback не вызывается

```
listen_in_background(microphone, callback)
    ↓
[Ожидание callback (2 секунды)]
    ↓
callback_called = _google_chunk_event.is_set()
    ├─ ✅ Если callback вызван → продолжаем
    └─ ❌ Если callback НЕ вызван → ошибка
```

**Возможные причины:**
1. Микрофон не активировался физически (разрешения не предоставлены)
2. AVF все еще активен (конфликт с Google Speech Recognition)
3. PyAudio не может открыть поток (устройство занято)
4. `_google_recording_active` установлен неправильно

**Решение:**
- Улучшить проверку разрешений перед активацией
- Гарантировать полную деактивацию AVF перед активацией Google
- Добавить диагностику состояния PyAudio потока

---

### 🔴 Проблема 3: Микрофон не активируется при Shortcut

```
_handle_long_press()
    ├─ _can_start_recording()
    │   ├─ _input_state == PENDING? ✓
    │   ├─ _pending_session_id != None? ✓
    │   ├─ _playback_active == False? ❌ (может быть True после playback.completed)
    │   └─ playback grace period прошёл? ❌ (может быть не прошёл)
    └─ [БЛОКИРОВКА активации]
```

**Возможные причины:**
1. `_playback_active` не сбрасывается после `playback.completed`
2. `playback grace period` слишком длинный
3. Микрофон не закрыт после предыдущей записи
4. Race condition: `_pending_recording_cancelled_event` установлен

**Решение:**
- Разрешить активацию микрофона через Shortcut **ВСЕГДА** (даже во время PROCESSING)
- Улучшить логику ожидания закрытия микрофона
- Добавить принудительное закрытие микрофона перед новой записью

---

## Схема правильного потока (после исправлений)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Пользователь нажимает Ctrl+N                             │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _handle_long_press()                                                        │
│  ├─ ✅ Проверка: _can_start_recording()                                     │
│  ├─ ✅ Принудительное закрытие микрофона (если активен)                      │
│  ├─ ✅ Публикация: voice.recording_start {source="keyboard"}                 │
│  └─ ✅ Установка: _recording_started = True                                 │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _on_recording_start()                                                       │
│  ├─ ✅ Проверки блокировки (PROCESSING + source != "keyboard" → блокировка)│
│  ├─ ✅ AVF диагностика (если _use_avf == True)                              │
│  ├─ ✅ Гарантированная деактивация AVF                                       │
│  ├─ ✅ Улучшенная проверка разрешений микрофона                              │
│  ├─ ✅ Google Speech Recognition активация                                  │
│  └─ ✅ Публикация: microphone.opened                                         │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Callback от listen_in_background                                            │
│  ├─ ✅ Проверка: _google_recording_active == True                           │
│  ├─ ✅ Накопление чанков в _google_audio_chunks                             │
│  └─ ✅ Установка: _google_chunk_event.set()                                 │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _handle_key_release()                                                       │
│  ├─ ✅ Публикация: voice.recording_stop {session_id}                        │
│  └─ ✅ Публикация: mode.request {target=PROCESSING}                          │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _on_recording_stop()                                                         │
│  ├─ ✅ Остановка Google записи                                               │
│  ├─ ✅ Распознавание: _recognize_google_audio()                              │
│  ├─ ✅ state_manager.set_microphone_state("idle", session_id=None)          │
│  └─ ✅ Публикация: microphone.closed {session_id}                            │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _on_playback_finished()                                                     │
│  ├─ ✅ Проверка: mic_active == True?                                        │
│  ├─ ✅ ПРИНУДИТЕЛЬНОЕ закрытие микрофона (если активен)                     │
│  ├─ ✅ Сброс сессии: _reset_session()                                       │
│  └─ ✅ _notify_playback_idle()                                              │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  _return_to_sleeping()                                                       │
│  ├─ ✅ Публикация: mode.request {target=SLEEPING}                           │
│  └─ ✅ _cleanup_processing()                                                 │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  СОСТОЯНИЕ: SLEEPING                                                         │
│  - Микрофон: idle ✅ (гарантированно закрыт)                                │
│  - Режим: SLEEPING                                                           │
│  - _recording_started: False                                                 │
│  - _playback_active: False                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Ключевые изменения для исправления

1. **Принудительное закрытие микрофона в `_on_playback_finished()`**
   - Проверять `mic_active` после `playback.completed`
   - Если `mic_active == True`, принудительно закрывать микрофон

2. **Разрешение активации через Shortcut во время PROCESSING**
   - Убрать блокировку `_playback_active` для активации через Shortcut
   - Разрешить прерывание воспроизведения через Shortcut

3. **Улучшение проверки разрешений и деактивации AVF**
   - Добавить детальную проверку разрешений перед активацией
   - Гарантировать полную деактивацию AVF перед активацией Google

4. **Улучшение логики ожидания закрытия микрофона**
   - Принудительно закрывать микрофон перед новой записью
   - Увеличить таймаут ожидания закрытия микрофона

