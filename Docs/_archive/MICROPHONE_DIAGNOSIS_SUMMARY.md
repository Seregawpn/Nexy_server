# üìã –°–≤–æ–¥–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

**–î–∞—Ç–∞:** 2025-12-13  
**–°—Ç–∞—Ç—É—Å:** –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: AVF –æ—Ç–∫–ª—é—á–µ–Ω –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)
**–°–∏–º–ø—Ç–æ–º:** `_use_avf = False` –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, —Ö–æ—Ç—è –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:**
- ‚úÖ `avf.enabled = True` –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- ‚úÖ `ks_avf.enabled = False` –≤ –∫–æ–Ω—Ñ–∏–≥–µ  
- ‚úÖ `NEXY_DISABLE_AVF_AUDIO` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ `AVFAudioEngine` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ `_AVF_AVAILABLE = True` –≤ –º–æ–¥—É–ª–µ
- ‚úÖ `AVFAudioEngine` —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AVF –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –º–µ—Ç–æ–¥–µ `initialize()`, –∞ –Ω–µ –≤ `__init__()`. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –≤—ã–∑–æ–≤–∞ `initialize()` AVF –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ `initialize()` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏ –µ—Å–ª–∏ –¥–∞, —Ç–æ –ø–æ—á–µ–º—É `_use_avf` –æ—Å—Ç–∞–µ—Ç—Å—è `False`.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Google Speech Recognition callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)
**–°–∏–º–ø—Ç–æ–º:** `listen_in_background` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:**
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: `GRANTED`
- ‚úÖ PyAudio –¥–æ—Å—Ç—É–ø–µ–Ω: 5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ `speech_recognition` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚ùå Callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (LEGACY –ø—É—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SpeechRecognizer.start_listening()`, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω)
2. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –º–µ–∂–¥—É AVF –∏ Google Speech Recognition
3. –ü—Ä–æ–±–ª–µ–º—ã —Å PyAudio –∏–ª–∏ `speech_recognition` –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π
4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `device_index` –∏–ª–∏ `sample_rate`
5. –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π `energy_threshold`

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LEGACY –ø—É—Ç—å –≤–º–µ—Å—Ç–æ Google Speech Recognition, –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å callback.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: LEGACY –ø—É—Ç—å –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)
**–°–∏–º–ø—Ç–æ–º:** –ú–∏–∫—Ä–æ—Ñ–æ–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ LEGACY –ø—É—Ç–∏

**–ü—Ä–∏—á–∏–Ω–∞:** LEGACY –ø—É—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SpeechRecognizer.start_listening()`, –∫–æ—Ç–æ—Ä—ã–π –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç AVF –ø–æ—Ç–æ–∫ –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å AVF‚ÜíGoogle –ø—É—Ç—å –≤–º–µ—Å—Ç–æ LEGACY –ø—É—Ç–∏.

### –ü—Ä–æ–±–ª–µ–º–∞ 4: UnboundLocalError –≤ speech_recognizer.py (–ò–°–ü–†–ê–í–õ–ï–ù–û)
**–°–∏–º–ø—Ç–æ–º:** `UnboundLocalError: cannot access local variable 'stream_closed'` –≤ —Å—Ç—Ä–æ–∫–µ 970

**–ü—Ä–∏—á–∏–Ω–∞:** `stream_closed` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ `stream_closed = False` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ `_run_listening()`

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UnboundLocalError**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ `stream_closed = False` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ `_run_listening()`
2. ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ AVF**: –ò–∑–º–µ–Ω–µ–Ω–æ `logger.warning` –Ω–∞ `logger.error` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π
3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–≥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**: –î–æ–±–∞–≤–ª–µ–Ω—ã `logger.info` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AVF

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –£—Å–ª–æ–≤–∏—è –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ (AVF‚ÜíGoogle)
- ‚ùå `_use_avf: False` (–ø–æ—Å–ª–µ `__init__()`, –Ω–æ –¥–æ `initialize()`)
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ `initialize()`

### –¢–µ—Å—Ç 2: –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- ‚úÖ –°—Ç–∞—Ç—É—Å: `PermissionStatus.GRANTED`
- ‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ: `granted`

### –¢–µ—Å—Ç 3: PyAudio –∏ speech_recognition
- ‚úÖ PyAudio –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: 5
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤: 5

### –¢–µ—Å—Ç 4: Google Speech Recognition callback
- ‚ùå Callback –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –∫–æ–¥–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∞ –≤ —Å–∞–º–æ–º `listen_in_background` –∏–ª–∏ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É

### –¢–µ—Å—Ç 5: LEGACY –ø—É—Ç—å –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- ‚ö†Ô∏è LEGACY –ø—É—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SpeechRecognizer.start_listening()`
- ‚ö†Ô∏è SpeechRecognizer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç sounddevice, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `initialize()`**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `initialize()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ `initialize()`**: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `initialize()` –∏ –ø–æ—á–µ–º—É `_use_avf` –æ—Å—Ç–∞–µ—Ç—Å—è `False`
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AVF
4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å callback**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í–∫–ª—é—á–∏—Ç—å AVF‚ÜíGoogle –ø—É—Ç—å:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ `initialize()` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ `initialize()` –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä–æ–π `_use_avf` –æ—Å—Ç–∞–µ—Ç—Å—è `False`

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å callback:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `device_index` –∏ `sample_rate`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `energy_threshold`

3. **–£–ª—É—á—à–∏—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ LEGACY –ø—É—Ç–∏
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π

