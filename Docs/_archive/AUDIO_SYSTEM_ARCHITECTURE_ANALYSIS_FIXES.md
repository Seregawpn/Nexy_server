# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—ã –∏ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–î–∞—Ç–∞:** 2025-12-05  
**–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤—ã—è–≤–ª–µ–Ω—ã, –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≥–æ—Ç–æ–≤

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –º–µ—Ç–æ–¥–µ `on_device_changed()` (`modules/voice_recognition/core/speech_recognizer.py:270-432`) —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ (`was_listening=False`). –ü–æ—Ç–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `_current_stream` –∏ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.

**–õ–æ–∫–∞—Ü–∏—è:**  
```python
# –°—Ç—Ä–æ–∫–∏ 394-407
if result.success and result.stream:
    with self._stream_lock:
        self._current_stream = result.stream  # ‚ùå –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∞–∫—Ç–∏–≤–µ–Ω
- –£—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (`input_device_name`, `input_device_id`), –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `start_listening()`.

---

### 2. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ—Ç–æ–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–°—É—â–µ—Å—Ç–≤—É—é—Ç –¥–≤–∞ API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏:
- `AudioStreamManager` –≤ `modules/audio_core/legacy_compat.py` (–∞–¥–∞–ø—Ç–µ—Ä)
- `BaseStreamManager`/`InputStreamManager`/`OutputStreamManager` –≤ `modules/audio_core/stream_managers.py` (–Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

**–õ–æ–∫–∞—Ü–∏—è:**  
- `modules/audio_core/legacy_compat.py:55` - `AudioStreamManager`
- `modules/audio_core/stream_managers.py:23` - `BaseStreamManager`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. `AudioStreamManager` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `SpeechRecognizer` –∏ `SequentialSpeechPlayer` - –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –Ω–∞ `InputStreamManager`/`OutputStreamManager`.

---

### 3. ‚ö†Ô∏è Race conditions —Å `_current_stream`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
`_current_stream` –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, –Ω–æ –Ω–µ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π `_stream_lock`:

1. ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ: `on_device_changed()` (—Å—Ç—Ä–æ–∫–∏ 333, 350, 379, 396)
2. ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ: `_graceful_stop_listening()` (—Å—Ç—Ä–æ–∫–∞ 453)
3. ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ: `stop_listening()` (—Å—Ç—Ä–æ–∫–∞ 759)
4. ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ: `_run_listening()` (—Å—Ç—Ä–æ–∫–∏ 1111, 1263, 1287)
5. ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ `_current_stream` –≤ `_prepare_input_device()` (—Å—Ç—Ä–æ–∫–∞ 609) - –∑–∞—â–∏—â–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

**–õ–æ–∫–∞—Ü–∏—è:**  
`modules/voice_recognition/core/speech_recognizer.py` - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `_current_stream`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `_current_stream` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã `_stream_lock`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–∞.

---

### 4. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

1. `_graceful_stop_listening()` (—Å—Ç—Ä–æ–∫–∞ 434) - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
2. `stop_listening()` (—Å—Ç—Ä–æ–∫–∞ 713) - –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
3. `_run_listening()` finally –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 1234) - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
4. `on_device_changed()` (—Å—Ç—Ä–æ–∫–∞ 346) - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–õ–æ–∫–∞—Ü–∏—è:**  
`modules/voice_recognition/core/speech_recognizer.py`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `_close_stream_safely()`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–µ–∑–¥–µ.

---

## üìã –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–†–ò–¢–ò–ß–ù–û - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ç–æ–∫

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`  
**–ú–µ—Ç–æ–¥:** `on_device_changed()` (—Å—Ç—Ä–æ–∫–∏ 270-432)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ï—Å–ª–∏ `was_listening=False`, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫
2. –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ –∑–∞–ø–∏—Å—å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ - –∑–∞–∫—Ä—ã—Ç—å –µ–≥–æ
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ö–æ–¥:**
```python
# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 392 (return –¥–ª—è was_listening=True):

# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç, –ù–ï —Å–æ–∑–¥–∞—ë–º –ø–æ—Ç–æ–∫ –∑–∞—Ä–∞–Ω–µ–µ
if not was_listening:
    if result.success and result.stream:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫, —Ç–∞–∫ –∫–∞–∫ –∑–∞–ø–∏—Å—å –Ω–µ –∏–¥—ë—Ç
        logger.info(
            f"‚ÑπÔ∏è [DEVICE_CHANGE] –ó–∞–ø–∏—Å—å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è \"{device_name}\". "
            f"–ü–æ—Ç–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º start_listening()"
        )
        try:
            await self._stream_manager.close_stream(result.stream)
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è [DEVICE_CHANGE] –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞: {e}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ç–æ–∫
    self.input_device_name = device_name
    self.input_device_id = device_id
    # actual_input_rate –∏ actual_input_channels –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ start_listening()
    logger.info(
        f"‚úÖ [DEVICE_CHANGE] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: \"{device_name}\" "
        f"(ID={device_id}). –ü–æ—Ç–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º start_listening()"
    )
    return

# –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫ if result.success and result.stream (—Å—Ç—Ä–æ–∫–∏ 394-407)
# —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω - –º—ã –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤—Å–µ —Å–ª—É—á–∞–∏ –≤—ã—à–µ
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ - –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`  
**–ú–µ—Ç–æ–¥:** –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_close_stream_safely()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_close_stream_safely(stream, is_bluetooth=False)`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞

**–ö–æ–¥:**
```python
async def _close_stream_safely(self, stream: Optional[sd.InputStream], is_bluetooth: bool = False) -> bool:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioStreamManager
    
    Args:
        stream: –ü–æ—Ç–æ–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
        is_bluetooth: –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Bluetooth
        
    Returns:
        True –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç
    """
    if stream is None:
        return True
    
    try:
        loop = self._main_loop or asyncio.get_event_loop()
        if loop.is_running():
            import concurrent.futures
            future = asyncio.run_coroutine_threadsafe(
                self._stream_manager.close_stream(stream, is_bluetooth=is_bluetooth),
                loop
            )
            future.result(timeout=5.0)
        else:
            await self._stream_manager.close_stream(stream, is_bluetooth=is_bluetooth)
        logger.debug("‚úÖ –ü–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ AudioStreamManager")
        return True
    except Exception as e:
        error_msg = str(e) if e and str(e) else f"{type(e).__name__} (–±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è)"
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞ —á–µ—Ä–µ–∑ AudioStreamManager: {error_msg}")
        return False
```

**–ó–∞–º–µ–Ω–∞ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö:**
- `_graceful_stop_listening()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_close_stream_safely()`
- `stop_listening()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_close_stream_safely()`
- `_run_listening()` finally –±–ª–æ–∫ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_close_stream_safely()`
- `on_device_changed()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_close_stream_safely()`

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ race conditions

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `_current_stream`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã `_stream_lock`
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

**–ú–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- `_prepare_input_device()` (—Å—Ç—Ä–æ–∫–∞ 609) - ‚úÖ —É–∂–µ –∑–∞—â–∏—â–µ–Ω–æ
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ - ‚úÖ —É–∂–µ –∑–∞—â–∏—â–µ–Ω—ã

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ)

**–§–∞–π–ª—ã:**
- `modules/voice_recognition/core/speech_recognizer.py`
- `modules/speech_playback/core/player.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ó–∞–º–µ–Ω–∏—Ç—å `AudioStreamManager` –Ω–∞ `InputStreamManager`/`OutputStreamManager`
2. –£–¥–∞–ª–∏—Ç—å `legacy_compat.py` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã

**–°—Ç–∞—Ç—É—Å:**  
–≠—Ç–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∑–∞–¥–∞—á–∞, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º.

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å `on_device_changed()` - –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –ø—Ä–∏ `was_listening=False` ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û (2025-12-05)**
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_close_stream_safely()` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–µ–∑–¥–µ ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û (2025-12-05)**
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –ó–∞–º–µ–Ω–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `on_device_changed()` –Ω–∞ `_close_stream_safely()` ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û (2025-12-05)**
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –ó–∞–º–µ–Ω–∏—Ç—å –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞ –Ω–∞ `_close_stream_safely()` ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û (2025-12-05)**
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `_current_stream` –Ω–∞ race conditions ‚úÖ **–ü–†–û–í–ï–†–ï–ù–û - –≤—Å–µ –º–µ—Å—Ç–∞ –∑–∞—â–∏—â–µ–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π**
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4:** (–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ) –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∞–∫—Ç–∏–≤–µ–Ω **‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û**
2. ‚úÖ –ü–æ—Ç–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ **‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û**
3. ‚úÖ –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–æ–≤ **‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –¶–ï–ù–¢–†–ê–õ–ò–ó–û–í–ê–ù–û** (–≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `_close_stream_safely()`)
4. ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–æ–≤ **‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û** (–≤—Å–µ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã)
5. ‚úÖ –ù–µ—Ç race conditions **‚úÖ –ü–†–û–í–ï–†–ï–ù–û - –≤—Å–µ –º–µ—Å—Ç–∞ –∑–∞—â–∏—â–µ–Ω—ã**
6. ‚úÖ –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–¥–∞ **‚úÖ –£–õ–£–ß–®–ï–ù–û**

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2025-12-05)

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `on_device_changed()` - –ø–æ—Ç–æ–∫ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if not was_listening:` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–∞
- –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ –∑–∞–ø–∏—Å—å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ - –ø–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (`input_device_name`, `input_device_id`)
- –ü–æ—Ç–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `start_listening()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py` (—Å—Ç—Ä–æ–∫–∏ 393-415)

### 2. –°–æ–∑–¥–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `_close_stream_safely()` –¥–ª—è –µ–¥–∏–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–Ω async –º–µ—Ç–æ–¥ `_close_stream_safely(stream, is_bluetooth=False)` –¥–ª—è async –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- –°–æ–∑–¥–∞–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `_close_stream_safely_sync(stream, is_bluetooth=False)` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- –û–±–∞ –º–µ—Ç–æ–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **–ó–ê–ú–ï–ù–ï–ù–´ –í–°–ï** –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `_stream_manager.close_stream()` –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
  - `on_device_changed()` - –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞
  - `_prepare_input_device()` - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - `_run_listening()` - –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ finally –±–ª–æ–∫–µ –∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
  - –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py` (—Å—Ç—Ä–æ–∫–∏ 440-500)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –¶–ï–ù–¢–†–ê–õ–ò–ó–û–í–ê–ù–û** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–æ–≤

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –≤ `on_device_changed()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω—ë–Ω –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `_stream_manager.close_stream()` –Ω–∞ `_close_stream_safely()`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `is_bluetooth` –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py` (—Å—Ç—Ä–æ–∫–∏ 339-351)

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `Docs/AUDIO_SYSTEM_ARCHITECTURE.md` - –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `Docs/AUDIO_SYSTEM_RECURRING_PROBLEMS.md` - —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- `modules/audio_core/legacy_compat.py` - legacy –∞–¥–∞–ø—Ç–µ—Ä

