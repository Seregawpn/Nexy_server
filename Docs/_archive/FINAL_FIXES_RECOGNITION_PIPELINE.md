# –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è pipeline —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

## –î–∞—Ç–∞: 2025-12-09

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `_clear_audio_buffer()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_clear_audio_buffer()` –≤—ã–∑—ã–≤–∞–ª—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö (—Å—Ç—Ä–æ–∫–∏ 805, 850, 866, 871, 874, 947)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ —Å–æ–∑–¥–∞–≤–∞–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—É

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –£–±—Ä–∞–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã `_clear_audio_buffer()` –∫—Ä–æ–º–µ –æ–¥–Ω–æ–≥–æ –≤ –±–ª–æ–∫–µ `finally` –º–µ—Ç–æ–¥–∞ `_on_recording_stop`
2. ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –≤ –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π: AVF, legacy, —Å–∏–º—É–ª—è—Ü–∏—è)

**–§–∞–π–ª—ã:**
- `integration/integrations/voice_recognition_integration.py` (—Å—Ç—Ä–æ–∫–∏ 962-966)

---

### 2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_recognize_avf_audio`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `duration` –≤—ã—á–∏—Å–ª—è–ª—Å—è –ø–æ—Å–ª–µ —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (10s –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- –ù–µ –±—ã–ª–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É –∏—Å—Ö–æ–¥–Ω—ã–º –∏ —Ä–µ—Å–µ–º–ø–ª–µ–Ω–Ω—ã–º `sample_rate`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π `sample_rate` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `original_sample_rate`
2. ‚úÖ `duration` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –î–û —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥–∞ –ø–æ –∏—Å—Ö–æ–¥–Ω–æ–º—É `sample_rate`
3. ‚úÖ –í –ª–æ–≥–∞—Ö –≤—ã–≤–æ–¥—è—Ç—Å—è –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è: `sample_rate (original)` –∏ `sample_rate (resampled)`
4. ‚úÖ –í –ª–æ–≥–∞—Ö –≤—ã–≤–æ–¥—è—Ç—Å—è –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è: `duration (original)` –∏ `duration (resampled)`

**–§–∞–π–ª—ã:**
- `integration/integrations/voice_recognition_integration.py` (—Å—Ç—Ä–æ–∫–∏ 988, 1009, 1078-1093, 1139-1158)

---

### 3. ‚úÖ –£–ª—É—á—à–µ–Ω debounce –¥–ª—è `voice.recording_stop`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `time.time() * 1000` (–º—Å) –≤–º–µ—Å—Ç–æ `time.monotonic()`
- Debounce –±—ã–ª 50–º—Å, —á—Ç–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `time.monotonic()` –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
2. ‚úÖ Debounce —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 200–º—Å (`_voice_stop_debounce_sec: float = 0.2`)
3. ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ (—É–±—Ä–∞–Ω–∞ async –∑–∞–¥–∞—á–∞)

**–§–∞–π–ª—ã:**
- `integration/integrations/input_processing_integration.py` (—Å—Ç—Ä–æ–∫–∏ 104-107, 369-395)

---

### 4. ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_stop` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `_handle_key_release`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `voice.recording_stop` –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è –≤ `_handle_short_press` –∏ –≤ `_handle_key_release`
- –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –£–±—Ä–∞–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_stop` –∏–∑ `_handle_short_press`
2. ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ `_handle_key_release`
3. ‚úÖ `SHORT_PRESS` —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ PROCESSING —Ä–µ–∂–∏–º

**–§–∞–π–ª—ã:**
- `integration/integrations/input_processing_integration.py` (—Å—Ç—Ä–æ–∫–∏ 1193-1195, 1637-1643)

---

### 5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ "–∫–æ–º–±–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" –≤ `quartz_monitor.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `SHORT_PRESS` `FlagsChanged` –≤—ã–∑—ã–≤–∞–ª `_trigger_event` –µ—â—ë —Ä–∞–∑
- –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_combo_completed` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–±–æ
2. ‚úÖ –§–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `SHORT_PRESS`
3. ‚úÖ –ü—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ñ–ª–∞–≥, –∏ –µ—Å–ª–∏ –∫–æ–º–±–æ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, —Å–æ–±—ã—Ç–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
4. ‚úÖ –§–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ Control

**–§–∞–π–ª—ã:**
- `modules/input_processing/keyboard/mac/quartz_monitor.py` (—Å—Ç—Ä–æ–∫–∏ 78, 285-288, 314, 167-169)

---

### 6. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ –≤ WAV —Ñ–∞–π–ª –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –°–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –µ—Å—Ç—å –ª–∏ –≥–æ–ª–æ—Å –≤ –∞—É–¥–∏–æ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –∑–≤—É–∫ –∫–ª–∞–≤–∏—à

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ –≤ WAV —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º
2. ‚úÖ –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `NEXY_DEBUG_SAVE_AUDIO=true`
3. ‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `/tmp/nexy_debug_session_{session_id}.wav`

**–§–∞–π–ª—ã:**
- `integration/integrations/voice_recognition_integration.py` (—Å—Ç—Ä–æ–∫–∏ 826-838)

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. ‚úÖ **–ë—É—Ñ–µ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑** ‚Äî –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `üßπ [VOICE] –ë—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω –≤ finally –±–ª–æ–∫–µ _on_recording_stop`
2. ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è `voice.recording_stop`** ‚Äî –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∏ `üö´ [DEBOUNCE] –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–π...` –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
3. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∞—Ö** ‚Äî `duration (original)` –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É —É–¥–µ—Ä–∂–∞–Ω–∏—é –∫–ª–∞–≤–∏—à–∏
4. ‚úÖ **–ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `[AVF] stop_input –≤–µ—Ä–Ω—É–ª None`** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. ‚úÖ **–ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏** ‚Äî –ø—Ä–∏ `NEXY_DEBUG_SAVE_AUDIO=true` —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ `/tmp/`

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```bash
export NEXY_DEBUG_SAVE_AUDIO=true
python client/main.py
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤ `/tmp/` –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è —Ñ–∞–π–ª—ã `nexy_debug_session_{session_id}.wav`, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∞—É–¥–∏–æ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
- ‚úÖ `üßπ [VOICE] –ë—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω –≤ finally –±–ª–æ–∫–µ _on_recording_stop` ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- ‚úÖ `üö´ [DEBOUNCE] –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–π voice.recording_stop` ‚Äî –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
- ‚úÖ `üîí [QUARTZ] –ö–æ–º–±–æ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é` ‚Äî –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö KeyUp/FlagsChanged
- ‚úÖ `duration (original)=X.XXs` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏
- ‚úÖ `üíæ [AVF] –ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: /tmp/nexy_debug_session_{session_id}.wav` ‚Äî –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ó–∞–∂–∞—Ç—å Ctrl+N –∏ –ø—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   - –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `[AVF] stop_input –≤–µ—Ä–Ω—É–ª None`
   - `_clear_audio_buffer()` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ –≤ `finally` –±–ª–æ–∫–µ
   - `duration (original)` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É —É–¥–µ—Ä–∂–∞–Ω–∏—é
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∏—Ç—å `NEXY_DEBUG_SAVE_AUDIO=true` –∏ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ WAV —Ñ–∞–π–ª—ã
5. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–∞–∑–æ–≤–æ–≥–æ pipeline ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–º—É SFSpeechRecognizer

