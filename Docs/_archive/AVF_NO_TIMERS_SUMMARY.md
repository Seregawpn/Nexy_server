# –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ —Ç–∞–π–º–µ—Ä–æ–≤

## üéØ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞

**–£–±—Ä–∞–Ω—ã –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã**, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ completion callback**.

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –£–¥–∞–ª–µ–Ω—ã fallback —Ç–∞–π–º–µ—Ä—ã –∏–∑ `avf_audio_engine.py`

**–£–¥–∞–ª–µ–Ω–æ**:
- `self._fallback_timer: Optional[threading.Timer] = None`
- –ú–µ—Ç–æ–¥ `_cancel_fallback_timer()`
- –í–µ—Å—å –∫–æ–¥ `_fallback_timeout()` coroutine
- –í–µ—Å—å –∫–æ–¥ `threading.Timer` fallback

**–ò–∑–º–µ–Ω–µ–Ω–æ**:
- –ï—Å–ª–∏ `callback_to_use is None` ‚Üí `play_audio()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –±–µ–∑ completion callback

---

### 2. –ò–∑–º–µ–Ω—ë–Ω `_avf_playback_worker` - —É–±—Ä–∞–Ω—ã `asyncio.sleep`

**–£–¥–∞–ª–µ–Ω–æ**:
- `await asyncio.sleep(duration_sec + 0.1)` –ø–æ—Å–ª–µ `play_audio()`
- `await self._avf_engine.stop_output()` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ worker

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
- `self._active_chunks: Dict[Any, Dict[str, Any]] = {}` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `if sid in self._active_chunks` - –ø—Ä–æ–ø—É—Å–∫ –µ—Å–ª–∏ —á–∞–Ω–∫ —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞–Ω–∫–µ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞**:
```python
# Worker –±–µ—Ä—ë—Ç —á–∞–Ω–∫
chunk = chunks.pop(0)
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ active_chunks
self._active_chunks[sid] = {"chunk": chunk, "start_time": time.time(), ...}
# –í—ã–∑—ã–≤–∞–µ—Ç play_audio()
success = await self._avf_engine.play_audio(...)
# –ù–ï –∂–¥—ë—Ç —á–µ—Ä–µ–∑ sleep - –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ completion callback
# Worker –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –∏ –≤–æ–∑—å–º—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è callback
```

---

### 3. –ò–∑–º–µ–Ω—ë–Ω `_on_avf_playback_completed` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ `_active_chunks` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ completion callback
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `grpc_done and buf_empty` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è `playback.completed` —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞**:
```python
# –ü–æ–ª—É—á–µ–Ω completion callback
active_chunk_info = self._active_chunks.pop(sid, None)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏ —ç—Ç–æ —á–∞–Ω–∫
grpc_done = self._grpc_done_sessions.get(sid, False)  # end_message –ø–æ–ª—É—á–µ–Ω
buf_empty = len(self._avf_chunk_buffer.get(sid, [])) == 0  # –±—É—Ñ–µ—Ä –ø—É—Å—Ç

if grpc_done and buf_empty:
    # –ü–û–°–õ–ï–î–ù–ò–ô –ß–ê–ù–ö - –ø—É–±–ª–∏–∫—É–µ–º playback.completed
    await self.event_bus.publish("playback.completed", ...)
    await self.event_bus.publish("mode.request", {"target": AppMode.SLEEPING})
else:
    # –ù–ï –ü–û–°–õ–ï–î–ù–ò–ô - worker –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ
    # (worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑—å–º—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫, —Ç–∞–∫ –∫–∞–∫ active_chunks[sid] —É–¥–∞–ª—ë–Ω)
```

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–±–µ–∑ —Ç–∞–π–º–µ—Ä–æ–≤)

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **gRPC –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏**:
   - `grpc.response.audio` ‚Üí `_on_audio_chunk()` ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ `_avf_chunk_buffer[sid]`

2. **Worker –±–µ—Ä—ë—Ç —á–∞–Ω–∫**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `if sid in self._active_chunks` ‚Üí –µ—Å–ª–∏ –¥–∞, –∂–¥—ë—Ç
   - –ë–µ—Ä—ë—Ç `chunk = chunks.pop(0)`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `_active_chunks[sid]`
   - –í—ã–∑—ã–≤–∞–µ—Ç `play_audio()`

3. **AVFAudioEngine –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç**:
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç completion callback
   - –ù–∞—á–∏–Ω–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
   - **–ù–ï–¢ fallback —Ç–∞–π–º–µ—Ä–æ–≤**

4. **Completion callback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ < 80%)
   - –ü—É–±–ª–∏–∫—É–µ—Ç `audio.playback.completed`
   - `_on_avf_playback_completed` –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ completion**:
   - –£–¥–∞–ª—è–µ—Ç –∏–∑ `_active_chunks[sid]`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `grpc_done and buf_empty`
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç `playback.completed` –∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ SLEEPING
   - –ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Üí worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑—å–º—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫

6. **Worker –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç**:
   - –í–∏–¥–∏—Ç, —á—Ç–æ `_active_chunks[sid]` –ø—É—Å—Ç
   - –ë–µ—Ä—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ –∏–∑ –±—É—Ñ–µ—Ä–∞
   - –ü–æ–≤—Ç–æ—Ä—è–µ—Ç —à–∞–≥–∏ 2-5

---

## üìä –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞

**–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑**:
1. `grpc.request_completed` (end_message) ‚Üí `_grpc_done_sessions[sid] = True`
2. –ë—É—Ñ–µ—Ä –ø—É—Å—Ç ‚Üí `len(_avf_chunk_buffer[sid]) == 0`
3. –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è ‚Üí completion callback –ø–æ–ª—É—á–µ–Ω

**–£—Å–ª–æ–≤–∏–µ**: `grpc_done and buf_empty` ‚Üí —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–µ—Ç race conditions**: –¢–∞–π–º–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
2. **–¢–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —á–∞–Ω–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω
3. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ú–µ–Ω—å—à–µ –∫–æ–¥–∞, –º–µ–Ω—å—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
5. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞**: –ß—ë—Ç–∫–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ `grpc_done` –∏ `buf_empty`

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ï—Å–ª–∏ callback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞**: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–∏—Å–Ω–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç fallback —Ç–∞–π–º–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ**: 
- –£–ª—É—á—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ callback —á–µ—Ä–µ–∑ PyObjC (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- –ï—Å–ª–∏ callback –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí `play_audio()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- Worker –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –≤–µ—Ä–Ω—ë—Ç —á–∞–Ω–∫ –≤ –±—É—Ñ–µ—Ä

### 2. –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback

**–ü—Ä–æ–±–ª–µ–º–∞**: Callback –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ (–∏–∑-–∑–∞ PyObjC).

**–†–µ—à–µ–Ω–∏–µ**: 
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (80% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- –ï—Å–ª–∏ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- **–ù–û**: –ï—Å–ª–∏ callback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ–æ–±—â–µ, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–∏—Å–Ω–µ—Ç

**–†–∏—Å–∫**: –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ callback —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã**:
1. –ß–∞–Ω–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä ‚Üí `_avf_playback_worker` –±–µ—Ä—ë—Ç –µ–≥–æ
2. `play_audio()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí completion callback —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
3. –ß–∞–Ω–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è ‚Üí completion callback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
4. `_on_avf_playback_completed` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏ —ç—Ç–æ —á–∞–Ω–∫
5. –ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Üí worker –±–µ—Ä—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫
6. –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `playback.completed`

**–ë–µ–∑ —Ç–∞–π–º–µ—Ä–æ–≤, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ completion callback!**

**–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑**:
- `grpc.request_completed` (end_message) ‚Üí `_grpc_done_sessions[sid] = True`
- –ë—É—Ñ–µ—Ä –ø—É—Å—Ç ‚Üí `len(_avf_chunk_buffer[sid]) == 0`
- –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è ‚Üí completion callback –ø–æ–ª—É—á–µ–Ω
