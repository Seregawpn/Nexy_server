# üß™ –î–µ—Ç–∞–ª—å–Ω—ã–π –ü–ª–∞–Ω –§–∞–∑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–∞—Ç–∞:** 2025-12-13  
**–°—Ç–∞—Ç—É—Å:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üìä –ß–∞—Å—Ç—å 1: –ü—Ä–∏–Ω—Ü–∏–ø—ã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1.1 –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ—Å—Ç–∞–º:**
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ: –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é/—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–µ: –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –∏ –¥–∞—é—Ç —á–µ—Ç–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø—Ä–æ—à–µ–ª/–Ω–µ –ø—Ä–æ—à–µ–ª)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ: –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è < 1 —Å–µ–∫—É–Ω–¥—ã
- ‚úÖ –ë–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: –Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:**
- ‚ùå –°—á–∏—Ç–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º –±–µ–∑ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
- ‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É —Ü–µ–ª–∏–∫–æ–º –±–µ–∑ –∏–∑–æ–ª—è—Ü–∏–∏
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ unit-—Ç–µ—Å—Ç–∞—Ö
- ‚ùå –î–æ–≥–∞–¥—ã–≤–∞—Ç—å—Å—è –æ –ø—Ä–æ–±–ª–µ–º–µ –±–µ–∑ –∏–∑–æ–ª—è—Ü–∏–∏

---

### 1.2 –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏–∑–æ–ª—è—Ü–∏–∏

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**
1. **–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏**: –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
2. **–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–∏–ø–æ—Ç–µ–∑**: –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
3. **–ò–∑–æ–ª—è—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–∏–ø–æ—Ç–µ–∑—ã
4. **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∏—Å—Ö–æ–¥–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É
5. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç

---

## üìä –ß–∞—Å—Ç—å 2: –§–∞–∑—ã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –≠—Ç–∞–ø–∞–º

### –§–∞–∑–∞ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ initialize() (–î–µ–Ω—å 1-2)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `initialize()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞ initialize()
```python
# tests/test_initialize_call.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.core.simple_module_coordinator import SimpleModuleCoordinator

@pytest.mark.asyncio
async def test_coordinator_initialize_called():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ coordinator.initialize() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è"""
    coordinator = SimpleModuleCoordinator()
    
    # –ú–æ–∫–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    with patch('integration.core.simple_module_coordinator.EventBus') as mock_event_bus:
        with patch('integration.core.simple_module_coordinator.ApplicationStateManager') as mock_state_manager:
            # –í—ã–∑—ã–≤–∞–µ–º initialize()
            result = await coordinator.initialize()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ initialize() –±—ã–ª –≤—ã–∑–≤–∞–Ω
            assert coordinator.is_initialized == True
            assert result == True
```

#### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è initialize()
```python
# tests/test_initialize_logging.py
import pytest
import logging
from unittest.mock import Mock, patch
from integration.core.simple_module_coordinator import SimpleModuleCoordinator

@pytest.mark.asyncio
async def test_initialize_logging():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ initialize()"""
    coordinator = SimpleModuleCoordinator()
    
    # –°–æ–∑–¥–∞–µ–º handler –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –ª–æ–≥–æ–≤
    log_capture = []
    
    def log_handler(record):
        log_capture.append(record.getMessage())
    
    logger = logging.getLogger('integration.core.simple_module_coordinator')
    handler = logging.Handler()
    handler.emit = log_handler
    logger.addHandler(handler)
    
    # –í—ã–∑—ã–≤–∞–µ–º initialize()
    await coordinator.initialize()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    assert any("coordinator.initialize()" in log for log in log_capture)
    assert any("–ù–ê–ß–ê–õ–û" in log for log in log_capture)
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç –≤—ã–∑–æ–≤–∞ initialize() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ < 1 —Å–µ–∫—É–Ω–¥—ã

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_initialize_*.py -v
```

---

### –§–∞–∑–∞ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AVF –º–æ–¥—É–ª—è (–î–µ–Ω—å 3)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ AVF –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
# tests/test_avf_config.py
import pytest
from unittest.mock import Mock, patch
from modules.audio_avf.core.types import AVFConfig
from config.unified_config_loader import UnifiedConfigLoader

def test_avf_config_from_unified_config():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ AVFConfig –∏–∑ unified_config"""
    # –ú–æ–∫–∞–µ–º UnifiedConfigLoader
    with patch('modules.audio_avf.core.types.UnifiedConfigLoader') as mock_loader:
        mock_loader_instance = Mock()
        mock_loader_instance.get_audio_avf_config.return_value = {
            "enabled": True,
            "input_format": "16kHz, mono, int16",
            "buffer_size_ms": 100,
            "enable_hardware_optimization": True
        }
        mock_loader.return_value = mock_loader_instance
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = AVFConfig.from_unified_config(mock_loader_instance)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        assert config.enabled == True
        assert config.input_format == "16kHz, mono, int16"
        assert config.buffer_size_ms == 100
        assert config.enable_hardware_optimization == True
```

#### –¢–µ—Å—Ç 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
```python
# tests/test_avf_manager_init.py
import pytest
from modules.audio_avf.core.avf_manager import AVFManager
from modules.audio_avf.core.types import AVFConfig

def test_avf_manager_initialization():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é AVFManager"""
    config = AVFConfig(enabled=True)
    manager = AVFManager(config)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    assert manager._config == config
    assert manager._engine is None
    assert manager._initialized == False
    assert manager._active == False
```

#### –¢–µ—Å—Ç 3: –ú–µ—Ç–æ–¥ initialize()
```python
# tests/test_avf_manager_initialize.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_avf.core.avf_manager import AVFManager
from modules.audio_avf.core.types import AVFConfig

@pytest.mark.asyncio
async def test_avf_manager_initialize():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ initialize()"""
    config = AVFConfig(enabled=True)
    manager = AVFManager(config)
    
    # –ú–æ–∫–∞–µ–º AVFAudioEngine
    with patch('modules.audio_avf.core.avf_manager.AVFAudioEngine') as mock_engine_class:
        mock_engine = Mock()
        mock_engine_class.return_value = mock_engine
        
        # –ú–æ–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        with patch.object(manager, '_load_audio_config', return_value=Mock()):
            # –í—ã–∑—ã–≤–∞–µ–º initialize()
            result = await manager.initialize()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            assert result == True
            assert manager._initialized == True
            assert manager._engine is not None
```

#### –¢–µ—Å—Ç 4: –ú–µ—Ç–æ–¥ activate()
```python
# tests/test_avf_manager_activate.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_avf.core.avf_manager import AVFManager
from modules.audio_avf.core.types import AVFConfig, DeviceInfo

@pytest.mark.asyncio
async def test_avf_manager_activate():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ activate()"""
    config = AVFConfig(enabled=True)
    manager = AVFManager(config)
    
    # –ú–æ–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    manager._engine = Mock()
    manager._initialized = True
    manager._active = False
    
    # –ú–æ–∫–∞–µ–º start_input()
    mock_result = Mock()
    mock_result.device_info.name = "Test Microphone"
    mock_result.device_info.uid = "test-uid"
    mock_result.format.to_dict.return_value = {"sample_rate": 16000}
    mock_result.diagnostics = {"rms": 0.5}
    manager._engine.start_input = AsyncMock(return_value=mock_result)
    
    # –í—ã–∑—ã–≤–∞–µ–º activate()
    device_info = await manager.activate(duration_sec=0.1)  # –ö–æ—Ä–æ—Ç–∫–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    assert isinstance(device_info, DeviceInfo)
    assert device_info.device_name == "Test Microphone"
    assert manager._active == True
```

#### –¢–µ—Å—Ç 5: –ú–µ—Ç–æ–¥ deactivate()
```python
# tests/test_avf_manager_deactivate.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_avf.core.avf_manager import AVFManager
from modules.audio_avf.core.types import AVFConfig

@pytest.mark.asyncio
async def test_avf_manager_deactivate():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ deactivate()"""
    config = AVFConfig(enabled=True)
    manager = AVFManager(config)
    
    # –ú–æ–∫–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    manager._engine = Mock()
    manager._engine.stop_input = AsyncMock()
    manager._active = True
    
    # –í—ã–∑—ã–≤–∞–µ–º deactivate()
    result = await manager.deactivate()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    assert result == True
    assert manager._active == False
    manager._engine.stop_input.assert_called_once()
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç initialize() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç activate() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç deactivate() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 1 —Å–µ–∫—É–Ω–¥—ã)

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_avf_*.py -v
```

---

### –§–∞–∑–∞ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Google –º–æ–¥—É–ª—è (–î–µ–Ω—å 4)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Google –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
# tests/test_google_config.py
import pytest
from unittest.mock import Mock, patch
from modules.audio_google.core.types import GoogleConfig
from config.unified_config_loader import UnifiedConfigLoader

def test_google_config_from_unified_config():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ GoogleConfig –∏–∑ unified_config"""
    # –ú–æ–∫–∞–µ–º UnifiedConfigLoader
    with patch('modules.audio_google.core.types.UnifiedConfigLoader') as mock_loader:
        mock_loader_instance = Mock()
        mock_loader_instance.get_voice_recognition_config.return_value = {
            "language": "en-US",
            "phrase_time_limit": 5.0,
            "energy_threshold": 4000,
            "pause_threshold": 0.8
        }
        mock_loader.return_value = mock_loader_instance
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = GoogleConfig.from_unified_config(mock_loader_instance)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        assert config.language == "en-US"
        assert config.phrase_time_limit == 5.0
        assert config.energy_threshold == 4000
        assert config.pause_threshold == 0.8
```

#### –¢–µ—Å—Ç 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
```python
# tests/test_google_manager_init.py
import pytest
from modules.audio_google.core.google_manager import GoogleManager
from modules.audio_google.core.types import GoogleConfig

def test_google_manager_initialization():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é GoogleManager"""
    config = GoogleConfig(language="en-US")
    manager = GoogleManager(config)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    assert manager._config == config
    assert manager._recognizer is None
    assert manager._microphone is None
    assert manager._recording_active == False
```

#### –¢–µ—Å—Ç 3: –ú–µ—Ç–æ–¥ initialize()
```python
# tests/test_google_manager_initialize.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_google.core.google_manager import GoogleManager
from modules.audio_google.core.types import GoogleConfig

@pytest.mark.asyncio
async def test_google_manager_initialize():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ initialize()"""
    config = GoogleConfig(language="en-US")
    manager = GoogleManager(config)
    
    # –ú–æ–∫–∞–µ–º speech_recognition
    with patch('modules.audio_google.core.google_manager.sr') as mock_sr:
        mock_recognizer = Mock()
        mock_recognizer.energy_threshold = 4000
        mock_recognizer.pause_threshold = 0.8
        mock_sr.Recognizer.return_value = mock_recognizer
        
        mock_microphone = Mock()
        mock_sr.Microphone.return_value = mock_microphone
        
        # –í—ã–∑—ã–≤–∞–µ–º initialize()
        result = await manager.initialize()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        assert result == True
        assert manager._recognizer is not None
        assert manager._microphone is not None
        assert manager._recognizer.energy_threshold == 4000
```

#### –¢–µ—Å—Ç 4: –ú–µ—Ç–æ–¥ activate()
```python
# tests/test_google_manager_activate.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_google.core.google_manager import GoogleManager
from modules.audio_google.core.types import GoogleConfig

@pytest.mark.asyncio
async def test_google_manager_activate():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ activate()"""
    config = GoogleConfig(language="en-US")
    manager = GoogleManager(config)
    
    # –ú–æ–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    manager._recognizer = Mock()
    manager._microphone = Mock()
    
    # –ú–æ–∫–∞–µ–º listen_in_background
    mock_stop_listening = Mock()
    manager._recognizer.listen_in_background = Mock(return_value=mock_stop_listening)
    
    # Callback –¥–ª—è —Ç–µ—Å—Ç–∞
    callback_called = False
    def test_callback(recognizer, audio):
        nonlocal callback_called
        callback_called = True
    
    # –í—ã–∑—ã–≤–∞–µ–º activate()
    result = await manager.activate(callback=test_callback)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    assert result == True
    assert manager._recording_active == True
    assert manager._stop_listening == mock_stop_listening
    manager._recognizer.listen_in_background.assert_called_once()
```

#### –¢–µ—Å—Ç 5: –ú–µ—Ç–æ–¥ deactivate()
```python
# tests/test_google_manager_deactivate.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from modules.audio_google.core.google_manager import GoogleManager
from modules.audio_google.core.types import GoogleConfig

@pytest.mark.asyncio
async def test_google_manager_deactivate():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ deactivate()"""
    config = GoogleConfig(language="en-US")
    manager = GoogleManager(config)
    
    # –ú–æ–∫–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    manager._stop_listening = Mock()
    manager._recording_active = True
    manager._chunk_event = Mock()
    manager._chunk_event.is_set.return_value = True
    
    # –í—ã–∑—ã–≤–∞–µ–º deactivate()
    result = await manager.deactivate()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    assert result == True
    assert manager._recording_active == False
    assert manager._stop_listening is None
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç initialize() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç activate() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç deactivate() –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 1 —Å–µ–∫—É–Ω–¥—ã)

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_google_*.py -v
```

---

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ (–î–µ–Ω—å 5)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ EventBus

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ EventBus
```python
# tests/test_voice_integration_coordination.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration
from integration.core.event_bus import EventBus
from integration.core.state_manager import ApplicationStateManager
from integration.core.error_handler import ErrorHandler

@pytest.mark.asyncio
async def test_voice_integration_coordination():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é —á–µ—Ä–µ–∑ EventBus"""
    event_bus = Mock(spec=EventBus)
    state_manager = Mock(spec=ApplicationStateManager)
    error_handler = Mock(spec=ErrorHandler)
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            mock_avf_instance = Mock()
            mock_avf_instance.initialize = AsyncMock(return_value=True)
            mock_avf_instance.activate = AsyncMock(return_value=Mock(device_name="Test Mic"))
            mock_avf_instance.deactivate = AsyncMock(return_value=True)
            mock_avf.return_value = mock_avf_instance
            
            mock_google_instance = Mock()
            mock_google_instance.initialize = AsyncMock(return_value=True)
            mock_google_instance.activate = AsyncMock(return_value=True)
            mock_google_instance.deactivate = AsyncMock(return_value=True)
            mock_google.return_value = mock_google_instance
            
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
            await integration.initialize()
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ voice.recording_start
            event = {
                "data": {
                    "session_id": "test-session-123"
                }
            }
            await integration._on_recording_start(event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã
            mock_avf_instance.activate.assert_called_once()
            mock_avf_instance.deactivate.assert_called_once()
            mock_google_instance.activate.assert_called_once()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
            state_manager.set_microphone_state.assert_called()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –±—ã–ª–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
            event_bus.publish.assert_called()
```

#### –¢–µ—Å—Ç 2: –†–∞–∑–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```python
# tests/test_voice_integration_size.py
import inspect
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

def test_voice_integration_size():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
    import os
    file_path = "integration/integrations/voice_recognition_integration.py"
    
    if os.path.exists(file_path):
        with open(file_path, 'r') as f:
            lines = f.readlines()
            line_count = len(lines)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
            assert line_count <= 500, f"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è: {line_count} —Å—Ç—Ä–æ–∫ (–º–∞–∫—Å–∏–º—É–º 500)"
    else:
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        pytest.skip("–§–∞–π–ª –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω")
```

#### –¢–µ—Å—Ç 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
```python
# tests/test_voice_integration_no_local_flags.py
import inspect
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

def test_voice_integration_no_local_flags():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è"""
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∫–ª–∞—Å—Å–∞
    source = inspect.getsource(VoiceRecognitionIntegration.__init__)
    
    # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏
    forbidden_flags = [
        "_recording_active",
        "_google_recording_active",
        "_playback_active",
        "_user_initiated_recording"
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
    for flag in forbidden_flags:
        assert f"self.{flag}" not in source, f"–ù–∞–π–¥–µ–Ω –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π —Ñ–ª–∞–≥: {flag}"
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç (‚â§ 500 —Å—Ç—Ä–æ–∫)
- [ ] –¢–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 1 —Å–µ–∫—É–Ω–¥—ã)

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_voice_integration_*.py -v
```

---

### –§–∞–∑–∞ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–î–µ–Ω—å 6-7)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ ApplicationStateManager

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ state_manager
```python
# tests/test_voice_integration_state_manager.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration
from integration.core.state_manager import ApplicationStateManager

@pytest.mark.asyncio
async def test_voice_integration_state_manager():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ state_manager"""
    event_bus = Mock()
    state_manager = Mock(spec=ApplicationStateManager)
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ voice.recording_start
            event = {
                "data": {
                    "session_id": "test-session-123"
                }
            }
            await integration._on_recording_start(event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ state_manager.set_microphone_state –±—ã–ª –≤—ã–∑–≤–∞–Ω
            state_manager.set_microphone_state.assert_called()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è state_manager.is_microphone_active (–µ—Å–ª–∏ –µ—Å—Ç—å)
            # (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞)
```

#### –¢–µ—Å—Ç 2: –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
# tests/test_state_manager_atomic.py
import pytest
import threading
from integration.core.state_manager import ApplicationStateManager

def test_state_manager_atomic_operations():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π state_manager"""
    state_manager = ApplicationStateManager()
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
    results = []
    
    def set_state_thread(session_id):
        state_manager.set_microphone_state("active", session_id)
        results.append(state_manager.is_microphone_active())
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤
    threads = []
    for i in range(10):
        thread = threading.Thread(target=set_state_thread, args=(f"session-{i}",))
        threads.append(thread)
        thread.start()
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    for thread in threads:
        thread.join()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç race conditions
    # (–≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏)
    assert len(results) == 10
```

#### –¢–µ—Å—Ç 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```python
# tests/test_no_state_desync.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_no_state_desync():
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    event_bus = Mock()
    state_manager = Mock(spec=ApplicationStateManager)
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π
            start_event = {"data": {"session_id": "test-session-123"}}
            stop_event = {"data": {"session_id": "test-session-123"}}
            
            await integration._on_recording_start(start_event)
            await integration._on_recording_stop(stop_event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ state_manager –≤—ã–∑—ã–≤–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
            calls = state_manager.set_microphone_state.call_args_list
            assert len(calls) >= 2  # –ú–∏–Ω–∏–º—É–º 2 –≤—ã–∑–æ–≤–∞ (active –∏ idle)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
            assert not hasattr(integration, '_recording_active')
            assert not hasattr(integration, '_google_recording_active')
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è state_manager –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 1 —Å–µ–∫—É–Ω–¥—ã)

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_voice_integration_state_manager.py tests/test_state_manager_atomic.py tests/test_no_state_desync.py -v
```

---

### –§–∞–∑–∞ 6: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–î–µ–Ω—å 8-9)

**–¶–µ–ª—å:** –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
```python
# tests/test_integration_full_cycle.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_integration_full_cycle():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞"""
    event_bus = Mock()
    state_manager = Mock()
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            await integration.initialize()
            
            # –ê–∫—Ç–∏–≤–∞—Ü–∏—è
            start_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_start(start_event)
            
            # –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
            stop_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_stop(stop_event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤
            assert mock_avf.return_value.initialize.called
            assert mock_avf.return_value.activate.called
            assert mock_avf.return_value.deactivate.called
            assert mock_google.return_value.activate.called
            assert mock_google.return_value.deactivate.called
```

#### –¢–µ—Å—Ç 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```python
# tests/test_integration_error_handling.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_integration_error_handling():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫"""
    event_bus = Mock()
    state_manager = Mock()
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å –æ—à–∏–±–∫–æ–π
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            mock_avf.return_value.activate = AsyncMock(side_effect=Exception("Test error"))
            
            start_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_start(start_event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—à–∏–±–∫–∞ –±—ã–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
            error_handler.handle_error.assert_called()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            state_manager.set_microphone_state.assert_called()
```

#### –¢–µ—Å—Ç 3: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
```python
# tests/test_integration_sequence.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_integration_sequence():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π"""
    event_bus = Mock()
    state_manager = Mock()
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            start_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_start(start_event)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤
            calls = [
                mock_avf.return_value.activate,
                mock_avf.return_value.deactivate,
                mock_google.return_value.activate,
                state_manager.set_microphone_state,
                event_bus.publish
            ]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã
            for call in calls:
                assert call.called, f"–í—ã–∑–æ–≤ –Ω–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω: {call}"
```

#### –¢–µ—Å—Ç 4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```python
# tests/test_integration_performance.py
import pytest
import time
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_integration_performance():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"""
    event_bus = Mock()
    state_manager = Mock()
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            start_time = time.monotonic()
            start_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_start(start_event)
            duration_ms = (time.monotonic() - start_time) * 1000
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ < 2 —Å–µ–∫—É–Ω–¥ (—Å —É—á–µ—Ç–æ–º –º–æ–∫–æ–≤)
            assert duration_ms < 2000, f"–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–∞—è: {duration_ms}ms"
```

#### –¢–µ—Å—Ç 5: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
```python
# tests/test_integration_edge_cases.py
import pytest
from unittest.mock import Mock, patch, AsyncMock
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

@pytest.mark.asyncio
async def test_integration_edge_cases():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏"""
    event_bus = Mock()
    state_manager = Mock()
    error_handler = Mock()
    
    # –ú–æ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    with patch('integration.integrations.voice_recognition_integration.AVFManager') as mock_avf:
        with patch('integration.integrations.voice_recognition_integration.GoogleManager') as mock_google:
            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
            integration = VoiceRecognitionIntegration(
                event_bus=event_bus,
                state_manager=state_manager,
                error_handler=error_handler
            )
            
            # –¢–µ—Å—Ç 1: –°–æ–±—ã—Ç–∏–µ –±–µ–∑ session_id
            event_no_session = {"data": {}}
            await integration._on_recording_start(event_no_session)
            # –î–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
            
            # –¢–µ—Å—Ç 2: –î–≤–æ–π–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è
            start_event = {"data": {"session_id": "test-session-123"}}
            await integration._on_recording_start(start_event)
            await integration._on_recording_start(start_event)
            # –î–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
            
            # –¢–µ—Å—Ç 3: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            stop_event = {"data": {"session_id": "test-session-456"}}
            await integration._on_recording_stop(stop_event)
            # –î–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –¢–µ—Å—Ç –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö)

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
pytest tests/test_integration_*.py -v
```

---

### –§–∞–∑–∞ 7: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–î–µ–Ω—å 12-14)

**–¶–µ–ª—å:** –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

**–¢–µ—Å—Ç—ã:**

#### –¢–µ—Å—Ç 1: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
```python
# tests/test_requirements_compliance.py
import pytest
import inspect
from integration.integrations.voice_recognition_integration import VoiceRecognitionIntegration

def test_requirements_compliance():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –†–∞–∑–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚â§ 500 —Å—Ç—Ä–æ–∫
    import os
    file_path = "integration/integrations/voice_recognition_integration.py"
    if os.path.exists(file_path):
        with open(file_path, 'r') as f:
            lines = f.readlines()
            assert len(lines) <= 500, f"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è: {len(lines)} —Å—Ç—Ä–æ–∫"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    source = inspect.getsource(VoiceRecognitionIntegration.__init__)
    forbidden_flags = [
        "_recording_active",
        "_google_recording_active",
        "_playback_active"
    ]
    for flag in forbidden_flags:
        assert f"self.{flag}" not in source, f"–ù–∞–π–¥–µ–Ω –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π —Ñ–ª–∞–≥: {flag}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ state_manager
    # (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–µ—Ç–æ–¥–æ–≤)
    methods_source = inspect.getsource(VoiceRecognitionIntegration)
    assert "state_manager.set_microphone_state" in methods_source
    assert "state_manager.is_microphone_active" in methods_source
```

#### –¢–µ—Å—Ç 2: –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```python
# tests/test_performance_requirements.py
import pytest
import time
from unittest.mock import Mock, patch, AsyncMock

@pytest.mark.asyncio
async def test_performance_requirements():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    # SLO —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
    # - p95 start_listening ‚â§ 600ms
    # - stream_open_success_rate ‚â• 98%
    
    # –¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    # (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)
    pass
```

#### –¢–µ—Å—Ç 3: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
```python
# tests/test_backward_compatibility.py
import pytest
from unittest.mock import Mock, patch, AsyncMock

@pytest.mark.asyncio
async def test_backward_compatibility():
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞—é—Ç
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞—é—Ç
    # (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)
    pass
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (100%)
- [ ] –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (100%)
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ ‚â• 80%
- [ ] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- [ ] –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- [ ] –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
pytest tests/ -v --cov=modules/audio_avf --cov=modules/audio_google --cov=integration/integrations/voice_recognition_integration

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
pytest tests/ --cov=modules/audio_avf --cov=modules/audio_google --cov=integration/integrations/voice_recognition_integration --cov-report=html
```

---

## üìä –ß–∞—Å—Ç—å 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤

### 3.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–¥—É–ª–µ–π

```
tests/
‚îú‚îÄ‚îÄ test_avf_manager.py
‚îÇ   ‚îú‚îÄ‚îÄ test_avf_config_from_unified_config()
‚îÇ   ‚îú‚îÄ‚îÄ test_avf_manager_initialization()
‚îÇ   ‚îú‚îÄ‚îÄ test_avf_manager_initialize()
‚îÇ   ‚îú‚îÄ‚îÄ test_avf_manager_activate()
‚îÇ   ‚îî‚îÄ‚îÄ test_avf_manager_deactivate()
‚îÇ
‚îî‚îÄ‚îÄ test_google_manager.py
    ‚îú‚îÄ‚îÄ test_google_config_from_unified_config()
    ‚îú‚îÄ‚îÄ test_google_manager_initialization()
    ‚îú‚îÄ‚îÄ test_google_manager_initialize()
    ‚îú‚îÄ‚îÄ test_google_manager_activate()
    ‚îî‚îÄ‚îÄ test_google_manager_deactivate()
```

---

### 3.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

```
tests/
‚îî‚îÄ‚îÄ test_voice_integration.py
    ‚îú‚îÄ‚îÄ test_voice_integration_coordination()
    ‚îú‚îÄ‚îÄ test_voice_integration_size()
    ‚îú‚îÄ‚îÄ test_voice_integration_no_local_flags()
    ‚îú‚îÄ‚îÄ test_voice_integration_state_manager()
    ‚îú‚îÄ‚îÄ test_voice_integration_full_cycle()
    ‚îî‚îÄ‚îÄ test_voice_integration_error_handling()
```

---

## üìä –ß–∞—Å—Ç—å 4: –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ó–∞–ø—É—Å–∫–∞ –¢–µ—Å—Ç–æ–≤

### 4.1 –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–æ —Ñ–∞–∑–∞–º

**–§–∞–∑–∞ 1 (–î–µ–Ω—å 1-2):**
```bash
pytest tests/test_initialize_*.py -v
```

**–§–∞–∑–∞ 2 (–î–µ–Ω—å 3):**
```bash
pytest tests/test_avf_*.py -v
```

**–§–∞–∑–∞ 3 (–î–µ–Ω—å 4):**
```bash
pytest tests/test_google_*.py -v
```

**–§–∞–∑–∞ 4 (–î–µ–Ω—å 5):**
```bash
pytest tests/test_voice_integration_*.py -v
```

**–§–∞–∑–∞ 5 (–î–µ–Ω—å 6-7):**
```bash
pytest tests/test_voice_integration_state_manager.py tests/test_state_manager_atomic.py tests/test_no_state_desync.py -v
```

**–§–∞–∑–∞ 6 (–î–µ–Ω—å 8-9):**
```bash
pytest tests/test_integration_*.py -v
```

**–§–∞–∑–∞ 7 (–î–µ–Ω—å 12-14):**
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
pytest tests/ -v --cov=modules/audio_avf --cov=modules/audio_google --cov=integration/integrations/voice_recognition_integration

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
pytest tests/ --cov=modules/audio_avf --cov=modules/audio_google --cov=integration/integrations/voice_recognition_integration --cov-report=html
```

---

### 4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ ‚â• 80%

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
pytest tests/ --cov=modules/audio_avf --cov=modules/audio_google --cov=integration/integrations/voice_recognition_integration --cov-report=html --cov-report=term

# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–∞
open htmlcov/index.html
```

---

## üìä –ß–∞—Å—Ç—å 5: –¢–∞–±–ª–∏—Ü–∞ –§–∞–∑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –≠—Ç–∞–ø | –î–µ–Ω—å | –§–∞–∑–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | –¢–µ—Å—Ç—ã | –ß–µ–∫-–ª–∏—Å—Ç |
|------|------|------------------|-------|----------|
| **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ initialize()** | 1-2 | –§–∞–∑–∞ 1 | test_initialize_call.py, test_initialize_logging.py | 4 –ø—É–Ω–∫—Ç–∞ |
| **–°–æ–∑–¥–∞–Ω–∏–µ AVF –º–æ–¥—É–ª—è** | 3 | –§–∞–∑–∞ 2 | test_avf_config.py, test_avf_manager_*.py (5 —Ç–µ—Å—Ç–æ–≤) | 7 –ø—É–Ω–∫—Ç–æ–≤ |
| **–°–æ–∑–¥–∞–Ω–∏–µ Google –º–æ–¥—É–ª—è** | 4 | –§–∞–∑–∞ 3 | test_google_config.py, test_google_manager_*.py (5 —Ç–µ—Å—Ç–æ–≤) | 7 –ø—É–Ω–∫—Ç–æ–≤ |
| **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** | 5 | –§–∞–∑–∞ 4 | test_voice_integration_coordination.py, test_voice_integration_size.py, test_voice_integration_no_local_flags.py | 5 –ø—É–Ω–∫—Ç–æ–≤ |
| **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è** | 6-7 | –§–∞–∑–∞ 5 | test_voice_integration_state_manager.py, test_state_manager_atomic.py, test_no_state_desync.py | 4 –ø—É–Ω–∫—Ç–∞ |
| **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | 8-9 | –§–∞–∑–∞ 6 | test_integration_full_cycle.py, test_integration_error_handling.py, test_integration_sequence.py, test_integration_performance.py, test_integration_edge_cases.py | 7 –ø—É–Ω–∫—Ç–æ–≤ |
| **–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** | 12-14 | –§–∞–∑–∞ 7 | –í—Å–µ —Ç–µ—Å—Ç—ã, test_requirements_compliance.py, test_performance_requirements.py, test_backward_compatibility.py | 6 –ø—É–Ω–∫—Ç–æ–≤ |

**–ò–¢–û–ì–û:** 7 —Ñ–∞–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, 30+ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

---

## ‚úÖ –ß–∞—Å—Ç—å 6: –ò—Ç–æ–≥–æ–≤—ã–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

### 6.1 –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ò–∑–æ–ª—è—Ü–∏—è:**
   - ‚úÖ –¢–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
   - ‚úÖ –¢–µ—Å—Ç—ã –±—ã—Å—Ç—Ä—ã–µ (< 1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è unit, < 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö)
   - ‚úÖ –¢–µ—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–µ (—á–µ—Ç–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ—à–µ–ª/–Ω–µ –ø—Ä–æ—à–µ–ª)

2. **–ü–æ–∫—Ä—ã—Ç–∏–µ:**
   - ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ ‚â• 80%
   - ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
   - ‚úÖ –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:**
   - ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏
   - ‚úÖ –í—Å–µ —á–µ–∫-–ª–∏—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏
   - ‚úÖ –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏

---

### 6.2 –ú–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|---------|------------------|----------|
| –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ | ‚â• 80% | ‚úÖ |
| –í—Ä–µ–º—è unit-—Ç–µ—Å—Ç–∞ | < 1 —Å–µ–∫ | ‚úÖ |
| –í—Ä–µ–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ | < 5 —Å–µ–∫ | ‚úÖ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ | 30+ | ‚úÖ |
| –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è | 100% | ‚úÖ |

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ñ–∞–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. ‚úÖ 7 —Ñ–∞–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
2. ‚úÖ 30+ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
3. ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
4. ‚úÖ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
5. ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–∫—Ä—ã—Ç–∏—é –∫–æ–¥–∞

**–í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –±—ã—Å—Ç—Ä—ã–µ.**

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!**

