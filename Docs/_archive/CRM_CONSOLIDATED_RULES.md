# CRM Consolidated Rules v2.0

> **ะะดะธะฝัะน ัะฒะพะด ะฟัะฐะฒะธะป ะธ ะดะพะณะพะฒะพััะฝะฝะพััะตะน ะดะปั Nexy CRM**
> **ะัะธะฝัะธะฟ: CRM = Control Plane ัะพััะพัะฝะธั ะฟัะพะตะบัะฐ, ะฐ ะฝะต ะถััะฝะฐะป ะฐะบัะธะฒะฝะพััะธ**

---

## ๐ TL;DR โ ะะปััะตะฒัะต ะฟัะฐะฒะธะปะฐ ะดะปั ะฐััะธััะตะฝัะพะฒ

### ะะปะฐะฒะฝะฐั ะธะดะตั
CRM ะพัะฒะตัะฐะตั ะฝะฐ ะฒะพะฟัะพัั: **ะณะดะต ะผั**, **ััะพ ะฒะฐะถะฝะพ**, **ััะพ ะฑะปะพะบะธััะตั**, **ััะพ ััะตะฑัะตั ะฒะฝะธะผะฐะฝะธั**.  
ะะต ัะธะบัะธััะตะผ ะบะฐะถะดะพะต ะดะตะนััะฒะธะต โ ัะธะบัะธััะตะผ ะธะทะผะตะฝะตะฝะธั ัะพััะพัะฝะธั.

### ะะพะณะดะฐ ัะพะทะดะฐะฒะฐัั ะทะฐะดะฐัั โ
- ะะปะธัะตั ะฝะฐ ะฟะพะฒะตะดะตะฝะธะต ะฟัะพะดัะบัะฐ / ะบะพะด / ะฐััะธัะตะบัััั
- ะขัะตะฑัะตั ะบะพะพัะดะธะฝะฐัะธะธ ะผะตะถะดั workspace
- ะะฐะฝะธะผะฐะตั > 30โ60 ะผะธะฝัั
- ะะผะตะตั ะฑะปะพะบะตัั ะธะปะธ ะทะฐะฒะธัะธะผะพััะธ
- ะขัะตะฑัะตั ัะตััะธัะพะฒะฐะฝะธั ะธะปะธ ัะตะปะธะทะฐ
- ะฏะฒะปัะตััั deliverable (ะฝะต ะฟัะพััะพ ะดะตะนััะฒะธะต)

### ะะพะณะดะฐ ะะ ัะพะทะดะฐะฒะฐัั ะทะฐะดะฐัั โ
- ะัะพััะพ ัะพะทะดะฐะฝ ะธะปะธ ะฟะพะดะฟัะฐะฒะปะตะฝ ะดะพะบัะผะตะฝั ะฑะตะท ะฒะปะธัะฝะธั
- ะัะฟัะฐะฒะปะตะฝะฐ ะพะฟะตัะฐัะบะฐ / ัะพัะผะฐั
- ะัะพัะธัะฐะฝ ัะฐะนะป
- ะัะฟะพะผะพะณะฐัะตะปัะฝะพะต ะดะตะนััะฒะธะต ะฒะฝัััะธ ัะตะบััะตะน ะทะฐะดะฐัะธ
- โ ะัะฟะพะปัะทัะน **Note** ะฒ description ะธะปะธ **Audit log**

### ะะฑัะทะฐัะตะปัะฝัะน ัะธะบะป
1. **ะัะพัะธัะฐัั snapshot** (`PROJECT_KANBAN.json`)
2. **ะัะพะฒะตัะธัั ะฑะปะพะบะตัั** (`blockedBy`)
3. **ะขะพะปัะบะพ ะฟะพัะพะผ** โ ะดะตะนััะฒะพะฒะฐัั

### ะัะฐะฝะธัั workspace
- ะะตะดะฐะบัะธััะน ัะพะปัะบะพ ัะฒะพะธ ะทะฐะดะฐัะธ (`CLI-*` / `SRV-*` / `NEXY-*`)
- ะะตะถ-workspace ัะฐะฑะพัะฐ = **handoff** ั ัะฒะฝัะผ ะบะพะฝัะตะบััะพะผ
- ะะธะบะพะณะดะฐ ะฝะต ะผะตะฝัะน `id`, `created_by`

### ะัะธ ะพะฑะฝะฐััะถะตะฝะธะธ ะฐะฝะพะผะฐะปะธะธ
**ะกะขะะ** โ ะกะพะทะดะฐัั `NEXY-XXX | type: problem` โ ะะฟะธัะฐัั ะฟัะพะฑะปะตะผั

---


## A) Source of Truth

| ะััะตัะฐะบั | ะััั | ะะฐะทะฝะฐัะตะฝะธะต |
|:---------|:-----|:-----------|
| **Master Data** | `Docs/PROJECT_KANBAN.json` | Epics, Cards, Releases |
| **Registry** | `Docs/CRM_INSTRUCTION_REGISTRY.md` | Index ะธะฝััััะบัะธะน (INS-XXX) |
| **Standard** | `Docs/CRM_MASTER_INSTRUCTION.md` | ะจะฐะฑะปะพะฝ ะดะพะบัะผะตะฝัะฐัะธะธ |
| **Assistant Guide** | `Docs/CRM_ASSISTANT_INSTRUCTIONS.md` | ะะฐะบ ะฐััะธััะตะฝัั ัะพะทะดะฐัั ะทะฐะดะฐัะธ |

---

## B) Contracts

### JSON Schema (`PROJECT_KANBAN.json`)
```json
{
  "meta": {},      // Required
  "config": {},    // Required
  "epics": [],     // Required
  "cards": [],     // Required
  "releases": []   // Required
}
```

### Registry Format
```markdown
| **INS-XXX** | Title | [File](./path) | Description |
```
- ID: `INS-XXX` (bold ะธะปะธ plain)
- Path: Markdown link ะพัะฝะพัะธัะตะปัะฝะพ `Docs/`

### Card Fields
| Field | Type | Required | Description |
|:------|:-----|:---------|:------------|
| `id` | string | โ | Unique ID (NEXY-XXX, CLI-XXX, SRV-XXX) |
| `workspace` | string | โ | Code territory: `client` / `server` / `null` (master) |
| `created_by` | string | โ | Assistant who created: `Antigravity` / `Cursor` / `Codex` |
| `modified_by` | string | โ | Assistant who last modified |
| `updated_at` | ISO date | โ | Last modification timestamp |
| `registry_ref` | string | โ | Link to INS-XXX for progress sync |
| `file_path` | string | โ | Relative path for "Open File" |

---

## C) Security

| Rule | Implementation |
|:-----|:---------------|
| No Shell Execution | `shlex.split()` + `subprocess.run(list)` |
| Path Traversal Block | `os.path.normpath()` + `startswith(ROOT)` |
| JSON Validation | Schema check before `/api/save` |
| No `/api/exec` | Disabled by policy |

---

## D) Scripts & APIs

### `server.py` (Bridge)
| Endpoint | Method | Description |
|:---------|:-------|:------------|
| `/` | GET | Serve UI |
| `/api/data` | GET | Return master JSON |
| `/api/save` | POST | Validate & save JSON |
| `/api/open_file` | POST | Open file in `CRM_EDITOR_CMD` |
| `/api/create_release` | POST | Archive cards, generate CHANGELOG |

### `kanban_progress_collector.py`
- Resolves `registry_ref` โ file path via Registry
- Counts `[x]` / `[ ]` checkboxes
- Updates `progress` (%) and `evidence` (list)

### `task_aggregator.py` (Phase 5)
- Scans `client/.crm/TASKS.json` + `server/.crm/TASKS.json`
- Merges into master by `id + workspace` key
- Respects `updated_at` (newer wins)
- Never deletes master cards

---

## E) Federated Workspaces (Phase 5)

### Structure
```
Fix_new/
โโโ client/.crm/TASKS.json   โ CLI-XXX tasks
โโโ server/.crm/TASKS.json   โ SRV-XXX tasks
โโโ Docs/PROJECT_KANBAN.json โ Master (aggregated)
```

### Merge Rules
1. **Key**: `id` + `workspace`
2. **Update**: If local `updated_at` > master โ update master
3. **Create**: New IDs are added
4. **No Delete**: Master cards without workspace are protected
5. **Isolation**: Each workspace only affects its own cards

### ID Prefixes
| Workspace | Prefix | Example |
|:----------|:-------|:--------|
| Master (Fix_new) | `NEXY-` | NEXY-001 |
| Client | `CLI-` | CLI-001 |
| Server | `SRV-` | SRV-001 |

---

## F) Workflow Summary

```mermaid
graph LR
    A[Edit .crm/TASKS.json] --> B[task_aggregator.py]
    B --> C[PROJECT_KANBAN.json]
    D[Edit Checklist.md] --> E[kanban_progress_collector.py]
    E --> C
    C --> F[server.py]
    F --> G[UI @ localhost:8000]
```

---

## G) Verification Checklist

- [ ] `server.py` ะทะฐะฟััะตะฝ ะฝะฐ :8000
- [ ] `/api/save` ะพัะบะปะพะฝัะตั ะฝะตะฒะฐะปะธะดะฝัะน JSON
- [ ] `/api/open_file` ะธัะฟะพะปัะทัะตั `CRM_EDITOR_CMD`
- [ ] `kanban_progress_collector.py` ะพะฑะฝะพะฒะปัะตั `progress`
- [ ] `task_aggregator.py` ะผะตัะถะธั workspace-ะทะฐะดะฐัะธ
- [ ] UI ะฟะพะบะฐะทัะฒะฐะตั workspace badge ะธ ัะธะปัััั

---

## H) ะะฑัะทะฐัะตะปัะฝัะน ัะธะบะป ัะฐะฑะพัั ะฐััะธััะตะฝัะฐ

> **ะะตัะตะด ะปัะฑัะผะธ ะธะทะผะตะฝะตะฝะธัะผะธ** ะฐััะธััะตะฝั ะพะฑัะทะฐะฝ ะฒัะฟะพะปะฝะธัั ััะพั ัะธะบะป:

```mermaid
graph TD
    A[1. Sync + Read Snapshot] --> B[2. ะัะพะฒะตัะธัั ะบะพะฝัะตะบัั]
    B --> C[3. ะัะฑัะฐัั ะดะตะนััะฒะธะต]
    C --> D{ะะตะนััะฒะธะต}
    D --> E[Update ัััะตััะฒัััะตะน ะทะฐะดะฐัะธ]
    D --> F[ะกะพะทะดะฐัั ะฝะพะฒัั ะทะฐะดะฐัั]
    D --> G[ะะฐะทะฑะธัั ะฝะฐ ะฟะพะดะทะฐะดะฐัะธ]
    D --> H[Handoff ะฒ ะดััะณะพะน workspace]
```

### ะจะฐะณะธ ัะธะบะปะฐ

| ะจะฐะณ | ะะตะนััะฒะธะต | ะคะฐะนะปั |
|:----|:---------|:------|
| **1. Sync + Read** | ะัะพัะธัะฐัั master snapshot | `Docs/PROJECT_KANBAN.json` |
| **2. Check** | ะัะพะฒะตัะธัั ะฐะบัะธะฒะฝัั ะทะฐะดะฐัั, ะฑะปะพะบะตัั, ัะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั | `blockedBy`, `responsible_docs`, `registry_ref` |
| **3. Act** | ะัะฑัะฐัั ะธ ะฒัะฟะพะปะฝะธัั ะดะตะนััะฒะธะต | ะกะพะพัะฒะตัััะฒัััะธะน `TASKS.json` |

> [!CAUTION]
> **ะะฐะฟัะตัะตะฝะพ** ะผะตะฝััั ะทะฐะดะฐัะธ "ะฒัะปะตะฟัั" ะฑะตะท ััะตะฝะธั snapshot!

---

## I) ะัะฐะฒะธะปะฐ ะฒะปะฐะดะตะฝะธั (Ownership)

### ะัะฐะฝะธัั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั

| ะััะธััะตะฝั | ะะพะถะตั ัะตะดะฐะบัะธัะพะฒะฐัั | ะะพะถะตั ัะพะทะดะฐะฒะฐัั |
|:----------|:--------------------|:----------------|
| **Codex (client)** | `CLI-*` | `CLI-*` |
| **Codex (server)** | `SRV-*` | `SRV-*` |
| **Antigravity** | `NEXY-*` + ะทะฐะดะฐัะธ ะณะดะต ะฝะฐะทะฝะฐัะตะฝ | `NEXY-*`, `CLI-*`, `SRV-*` (ั handoff) |
| **Cursor** | ะะพ workspace ะบะพะฝัะตะบััั | ะะพ workspace ะบะพะฝัะตะบััั |

### ะะฐะฟัะตัะตะฝะพ

- โ ะัะฐะฒะธัั ะทะฐะดะฐัะธ ะดััะณะพะณะพ workspace (ะบัะพะผะต handoff)
- โ ะะตะฝััั ััะถะธะต `created_by`
- โ ะะตะฝััั `id` ะทะฐะดะฐัะธ

---

## J) ะะพะฝััะฐะบัั ัะพะทะดะฐะฝะธั/ะพะฑะฝะพะฒะปะตะฝะธั

### J.1 ะกะพะทะดะฐะฝะธะต ะทะฐะดะฐัะธ

**Required fields:**
```json
{
    "id": "CLI-003",
    "title": "Fix audio callback",
    "status": "plan",
    "created_by": "Codex",
    "modified_by": "Codex",
    "updated_at": "2026-01-08T12:00:00-05:00",
    "workspace": "client"
}
```

**Strongly recommended:**
```json
{
    "priority": "P1",
    "epicId": "EPIC-MVP",
    "description": "## ะัะพะฑะปะตะผะฐ\n...\n## ะกะปะตะดัััะธะต ัะฐะณะธ\n...",
    "responsible_docs": [{"path": "Docs/ARCHITECTURE_OVERVIEW.md", "type": "reference"}],
    "file_path": "client/audio/callback.py",
    "blockedBy": [],
    "registry_ref": "INS-007"
}
```

### J.2 ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะดะฐัะธ

**ะะฑัะทะฐัะตะปัะฝะพ ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ:**
1. `modified_by` โ ะธะผั ะฐััะธััะตะฝัะฐ
2. `updated_at` โ ัะตะบััะตะต ะฒัะตะผั ISO 8601
3. `description` โ ััะพ ัะดะตะปะฐะฝะพ / ััะพ ะดะฐะปััะต / ะฑะปะพะบะตัั

**ะะธะบะพะณะดะฐ ะฝะต ะผะตะฝััั:**
- `id`
- `created_by`

### J.3 ะะตัะตัะพะดั ััะฐัััะพะฒ

```mermaid
stateDiagram-v2
    [*] --> plan: ะกะพะทะดะฐะฝะธะต
    plan --> in_progress: ะะตะฐะปัะฝะพ ะฝะฐัะฐะป ัะฐะฑะพัั
    in_progress --> testing: ะััั ััะพ ัะตััะธัะพะฒะฐัั
    testing --> released: ะะพัะพะฒะพ ะบ ship
    released --> [*]: Archive via Ship Release
    
    in_progress --> plan: ะัะบะฐั (ะฑะปะพะบะตั)
    testing --> in_progress: ะะฐะนะดะตะฝ ะฑะฐะณ
```

---

## K) Definition of Done (DoD)

### ะะฑัะทะฐัะตะปัะฝัะต ะฟะพะปั ะดะปั P0/P1

```json
{
    "acceptance_criteria": [
        "Audio callback ะฒัะทัะฒะฐะตััั ะฟัะธ ะฟะพะปััะตะฝะธะธ ะดะฐะฝะฝัั",
        "ะะตั ััะตัะตะบ ะฟะฐะผััะธ",
        "ะะพะณะธ ะฝะต ัะพะดะตัะถะฐั ะพัะธะฑะพะบ"
    ],
    "test_plan": "1. ะะฐะฟัััะธัั ะฟัะธะปะพะถะตะฝะธะต\n2. ะะบัะธะฒะธัะพะฒะฐัั ะผะธะบัะพัะพะฝ\n3. ะัะพะฒะตัะธัั ะปะพะณะธ",
    "definition_of_done": "ะัะต acceptance_criteria ะฒัะฟะพะปะฝะตะฝั, ัะตััั ะฟัะพะนะดะตะฝั"
}
```

> [!IMPORTANT]
> ะัะปะธ ััะธั ะฟะพะปะตะน ะฝะตั โ ัะพะทะดะฐัั ะฟะพะดะทะฐะดะฐัั "ะะพะฟะพะปะฝะธัั ะบัะธัะตัะธะธ/ะฟะปะฐะฝ ัะตััะฐ" ะธ ะฒัะฟะพะปะฝะธัั ะตั ะฟะตัะฒะพะน!

---

## L) ะกะฒัะทั ั ะดะพะบัะผะตะฝัะฐัะธะตะน

### ะะพะณะดะฐ ะพะฑัะทะฐัะตะปัะฝะพ ัะบะฐะทัะฒะฐัั `responsible_docs`

ะะฐะดะฐัะฐ ะฒะปะธัะตั ะฝะฐ:
- โ ะััะธัะตะบัััั
- โ ะัะฐะฒะธะปะฐ ะฐััะธััะตะฝัะพะฒ  
- โ ะะพะฒะตะดะตะฝะธะต ัะธััะตะผั
- โ ะัะธัะธัะฝัะน ะฑะฐะณ

### ะคะพัะผะฐั

```json
{
    "responsible_docs": [
        {
            "path": "Docs/STATE_CATALOG.md",
            "type": "source_of_truth",
            "description": "ะัะธ ัะพััะพัะฝะธั"
        },
        {
            "path": "config/unified_config.yaml",
            "type": "control",
            "description": "Feature flags"
        }
    ]
}
```

### ะขะธะฟั ะดะพะบัะผะตะฝัะพะฒ

| Type | ะะฐะทะฝะฐัะตะฝะธะต | ะัะธะผะตัั |
|:-----|:-----------|:--------|
| `source_of_truth` | ะััะพัะฝะธะบ ะธััะธะฝั | `STATE_CATALOG.md`, `unified_config.yaml` |
| `control` | ะะพะฝััะพะปะธััััะธะต ะฟัะฐะฒะธะปะฐ | `interaction_matrix.yaml`, `PROJECT_REQUIREMENTS.md` |
| `reference` | ะกะฟัะฐะฒะพัะฝัะต | `ARCHITECTURE_OVERVIEW.md` |
| `instruction` | ะะฝััััะบัะธะธ | `INS-XXX` ะธะท ัะตะตัััะฐ |

---

## M) ะะพะดะทะฐะดะฐัะธ ะธ ะดะตะบะพะผะฟะพะทะธัะธั

### ะะพะณะดะฐ ัะฐะทะฑะธะฒะฐัั

- ะะฐะดะฐัะฐ > 1โ2 ัะฐัะพะฒ ัะฐะฑะพัั
- 2+ ะฝะตะทะฐะฒะธัะธะผัั ะฝะฐะฟัะฐะฒะปะตะฝะธะน

### ะคะพัะผะฐั ะฟะพะดะทะฐะดะฐั

```json
{
    "subtasks": [
        {
            "title": "Design architecture",
            "status": "released",
            "workspace": "master",
            "assigned_to": "Antigravity"
        },
        {
            "title": "Implement client-side",
            "status": "in_progress",
            "workspace": "client",
            "assigned_to": "Cursor"
        }
    ]
}
```

### ะัะฐะฒะธะปะฐ

- 3โ9 ะฟะพะดะทะฐะดะฐั ะฝะฐ ะทะฐะดะฐัั
- ะะฐะถะดะฐั โ "ะฟัะพะฒะตััะตะผัะน ัะตะทัะปััะฐั"
- ะะพะดะทะฐะดะฐัะธ ะผะพะถะฝะพ ัะฐัะฟัะตะดะตะปััั ะผะตะถะดั workspace

---

## N) Handoff ะผะตะถะดั workspace

### ะัะพัะตัั ะฟะตัะตะดะฐัะธ

```mermaid
sequenceDiagram
    participant A as Antigravity (master)
    participant C as Cursor (client)
    
    A->>A: ะกะพะทะดะฐัั NEXY-005 "Auth system"
    A->>C: ะกะพะทะดะฐัั CLI-010 "Client auth"
    A->>A: ะะพะฑะฐะฒะธัั blockedBy: ["CLI-010"]
    A->>A: ะะฐะฟะธัะฐัั handoff note ะฒ description
    C->>C: ะะทััั CLI-010 ะฒ ัะฐะฑะพัั
    C->>C: ะะฐะฒะตััะธัั CLI-010
    A->>A: ะกะฝััั ะฑะปะพะบะธัะพะฒะบั, ะฟัะพะดะพะปะถะธัั
```

### Handoff Note (ะพะฑัะทะฐัะตะปัะฝะพ)

```markdown
## Handoff to Client Workspace

**ะะพะฝัะตะบัั:** ะัะถะฝะฐ ัะตะฐะปะธะทะฐัะธั ะบะปะธะตะฝััะบะพะน ะฐะฒัะพัะธะทะฐัะธะธ
**ะคะฐะนะปั:** `client/auth/`, `client/config/`
**ะัะธัะตัะธะธ ะณะพัะพะฒะฝะพััะธ:** 
- [ ] Login flow ัะฐะฑะพัะฐะตั
- [ ] Token ััะฐะฝะธััั ะฑะตะทะพะฟะฐัะฝะพ
**ะงัะพ ัะถะต ัะดะตะปะฐะฝะพ:** ะััะธัะตะบัััะฐ ัะฟัะพะตะบัะธัะพะฒะฐะฝะฐ ะฒ NEXY-005
```

---

## O) ะะฐะฑะพัะฐ ั ะฑะปะพะบะตัะฐะผะธ

### ะัะฐะฒะธะปะฐ

1. โ ะะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัั ะทะฐะดะฐัั **ะฝะตะปัะทั** ะฟะตัะตะฒะพะดะธัั ะฒ `in_progress`
2. ะัะธ ะฑะปะพะบะธัะพะฒะบะต โ ะพะดะฝะพ ะธะท ะดะตะนััะฒะธะน:
   - ะะทััั blocker-ะทะฐะดะฐัั ัะฐะผะพะผั
   - ะกะพะทะดะฐัั ะฝะพะฒัั blocker-ะทะฐะดะฐัั
   - ะญัะบะฐะปะธัะพะฒะฐัั ะฒ master ะบะฐะบ "decision needed"

### ะัะธะผะตั ััะบะฐะปะฐัะธะธ

```json
{
    "id": "NEXY-010",
    "title": "Decision Needed: Auth approach",
    "status": "plan",
    "priority": "P0",
    "description": "## ะขัะตะฑัะตััั ัะตัะตะฝะธะต\n\nCLI-010 ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ โ ะฝัะถะฝะพ ะฒัะฑัะฐัั ะฟะพะดัะพะด ะบ ะฐะฒัะพัะธะทะฐัะธะธ.\n\n**ะะฐัะธะฐะฝัั:**\n1. OAuth2\n2. API Key\n\n**Blocker for:** CLI-010, SRV-008"
}
```

---

## P) ะกะฐะผะพะดะธะฐะณะฝะพััะธะบะฐ ะพัะธะฑะพะบ

### ะขะธะฟั ะฟัะพะฑะปะตะผ ะดะปั ะดะตัะตะบัะธะธ

| ะัะพะฑะปะตะผะฐ | ะะตะนััะฒะธะต |
|:---------|:---------|
| ะะพะฝัะปะธะบั ััะฐัััะพะฒ | ะกะพะทะดะฐัั `NEXY-*` "CRM Fix" |
| ะััััััะฒัััะธะน `registry_ref` | ะกะพะทะดะฐัั `NEXY-*` "Data Integrity" |
| ะะธััะน `file_path` | ะัะฟัะฐะฒะธัั ะฟััั ะธะปะธ ัะดะฐะปะธัั |
| ะฆะธะบะปั ะฒ `blockedBy` | ะกะพะทะดะฐัั `NEXY-*` "Dependency Cycle" |
| ะะตัะพะพัะฒะตัััะฒะธะต ID ะธ workspace | ะัะฟัะฐะฒะธัั workspace |

### ะัะธ ะพะฑะฝะฐััะถะตะฝะธะธ ะฟัะพะฑะปะตะผั

1. **ะััะฐะฝะพะฒะธัััั** โ ะฝะต ะฟัะพะดะพะปะถะฐัั ะธะทะผะตะฝะตะฝะธั
2. **ะกะพะทะดะฐัั ะทะฐะดะฐัั** โ `NEXY-*` "CRM Fix / Data Integrity"
3. **ะะฟะธัะฐัั** โ ะฟัะพะฑะปะตะผั ะธ ะฟัะตะดะปะพะถะธัั ะธัะฟัะฐะฒะปะตะฝะธะต

---

## Q) ะะฐััะธัะฐ ะฒะทะฐะธะผะพะดะตะนััะฒะธั ะบะพะผะฟะพะฝะตะฝัะพะฒ

```mermaid
graph TB
    subgraph Assistants
        ANT[Antigravity]
        COD[Codex]
        CUR[Cursor]
    end
    
    subgraph Workspaces
        MASTER[.crm/TASKS.json<br/>NEXY-*]
        CLIENT[client/.crm/TASKS.json<br/>CLI-*]
        SERVER[server/.crm/TASKS.json<br/>SRV-*]
    end
    
    subgraph Scripts
        AGG[task_aggregator.py]
        PROG[kanban_progress_collector.py]
        SRV[server.py]
    end
    
    subgraph Data
        KANBAN[PROJECT_KANBAN.json]
        REG[CRM_INSTRUCTION_REGISTRY.md]
        DOCS[Docs/*.md]
    end
    
    subgraph UI
        WEB[localhost:8000]
    end
    
    ANT -->|creates/updates| MASTER
    ANT -->|handoff| CLIENT
    ANT -->|handoff| SERVER
    
    COD -->|creates/updates| CLIENT
    COD -->|creates/updates| SERVER
    
    CUR -->|creates/updates| CLIENT
    CUR -->|creates/updates| SERVER
    
    MASTER --> AGG
    CLIENT --> AGG
    SERVER --> AGG
    
    AGG -->|merge| KANBAN
    
    REG --> PROG
    DOCS --> PROG
    KANBAN --> PROG
    PROG -->|update progress| KANBAN
    
    KANBAN --> SRV
    SRV --> WEB
    WEB -->|/api/save| KANBAN
```

### ะะพัะพะบะธ ะดะฐะฝะฝัั

| ะะพัะพะบ | ะััะพัะฝะธะบ | ะะฐะทะฝะฐัะตะฝะธะต | ะขัะธะณะณะตั |
|:------|:---------|:-----------|:--------|
| ะกะพะทะดะฐะฝะธะต ะทะฐะดะฐัะธ | Assistant | `TASKS.json` | ะััะฝะพะต ะดะตะนััะฒะธะต |
| ะะณัะตะณะฐัะธั | `TASKS.json` (all) | `PROJECT_KANBAN.json` | ะะฐะถะดัะต 5 ะผะธะฝ / manual |
| ะกะธะฝััะพะฝะธะทะฐัะธั ะฟัะพะณัะตััะฐ | `registry_ref` โ Docs | `progress`, `evidence` | `kanban_progress_collector.py` |
| UI โ Backend | Browser | `PROJECT_KANBAN.json` | `/api/save` |
| Open File | UI | Editor | `/api/open_file` |

---

## R) ะะธะฝะธะผะฐะปัะฝัะน ัะพัะผะฐั Update Note

ะัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ `description` โ ะดะพััะฐัะพัะฝะพ:

```markdown
**ะงัะพ ัะดะตะปะฐะป:**
- ะะตะฐะปะธะทะพะฒะฐะป callback handler
- ะะพะฑะฐะฒะธะป ะปะพะณะธัะพะฒะฐะฝะธะต

**ะงัะพ ะดะฐะปััะต:**
- ะะฝัะตะณัะธัะพะฒะฐัั ั audio pipeline
- ะะฐะฟะธัะฐัั ัะตััั

**ะะปะพะบะตัั:** ะฝะตั
```

---

## S) Noise Control Policy

> **ะัะธะฝัะธะฟ:** CRM = Control Plane ัะพััะพัะฝะธั, ะฝะต ะถััะฝะฐะป ะฐะบัะธะฒะฝะพััะธ.

### ะะฐะดะฐัะฐ ัะพะทะดะฐัััั ะขะะะฌะะ ะตัะปะธ

| ะัะธัะตัะธะน | ะัะธะผะตั |
|:---------|:-------|
| ะะปะธัะตั ะฝะฐ ะฟะพะฒะตะดะตะฝะธะต ะฟัะพะดัะบัะฐ/ะบะพะด/ะฐััะธัะตะบัััั | ะะพะฒัะน ะผะพะดัะปั, ัะธะบั ะฑะฐะณะฐ |
| ะขัะตะฑัะตั ะบะพะพัะดะธะฝะฐัะธะธ ะผะตะถะดั workspace | Client + Server ะฒะทะฐะธะผะพะดะตะนััะฒะธะต |
| ะะฐะฝะธะผะฐะตั > 30โ60 ะผะธะฝัั | ะะตัะฐะบัะพัะธะฝะณ, ะฝะพะฒะฐั ัะธัะฐ |
| ะะผะตะตั ะฑะปะพะบะตัั ะธะปะธ ะทะฐะฒะธัะธะผะพััะธ | ะะดัั ะดััะณัั ะทะฐะดะฐัั |
| ะขัะตะฑัะตั ัะตััะธัะพะฒะฐะฝะธั ะธะปะธ ัะตะปะธะทะฐ | QA, deploy |
| ะะฒะพะดะธั ัะตัะตะฝะธะต / ัะธัะบ / ัะตะปั | ะััะธัะตะบัััะฝะพะต ัะตัะตะฝะธะต |
| ะฏะฒะปัะตััั deliverable | ะะพะฝะตัะฝัะน ัะตะทัะปััะฐั |

### ะะฐะดะฐัะฐ ะะ ัะพะทะดะฐัััั ะตัะปะธ

- โ ะัะพััะพ ัะพะทะดะฐะฝ/ะฟะพะดะฟัะฐะฒะปะตะฝ ะดะพะบัะผะตะฝั ะฑะตะท ะฒะปะธัะฝะธั
- โ ะัะฟัะฐะฒะปะตะฝะฐ ะพะฟะตัะฐัะบะฐ / ัะพัะผะฐั
- โ ะัะพัะธัะฐะฝ ัะฐะนะป
- โ ะัะฟะพะผะพะณะฐัะตะปัะฝะพะต ะดะตะนััะฒะธะต ะฒะฝัััะธ ัะตะบััะตะน ะทะฐะดะฐัะธ

โ ะัะฟะพะปัะทัะน **Note** ะฒ description ะธะปะธ **Audit log**.

### WIP-ะปะธะผะธัั (Work In Progress)

> [!IMPORTANT]
> ะ ะบะฐะถะดะพะผ workspace ะดะพะฟััะบะฐะตััั ะฝะต ะฑะพะปะตะต:
> - **1 ะทะฐะดะฐัะธ** ัะพ ััะฐัััะพะผ `in_progress`
> - **1 ะทะฐะดะฐัะธ** ัะพ ััะฐัััะพะผ `testing`

ะญัะพ:
- ัะดะตัะถะธะฒะฐะตั ัะพะบัั,
- ะฟัะตะดะพัะฒัะฐัะฐะตั ะฟะฐัะฐะปะปะตะปัะฝัั "ัะฐัะฟะพะปะทััััั" ัะฐะฑะพัั,
- ะดะตะปะฐะตั snapshot ัะธัะฐะตะผัะผ.

### ะัะฐะฒะธะปะพ "ะะดะฝะฐ ะฟัะธัะธะฝะฐ โ ะพะดะฝะฐ ะทะฐะดะฐัะฐ"

> ะัะปะธ ะฒ ะทะฐะดะฐัะต ะฑะพะปะตะต ะพะดะฝะพะน ะฝะตะทะฐะฒะธัะธะผะพะน ะฟัะธัะธะฝั/ัะตะปะธ โ ะฐััะธััะตะฝั **ะพะฑัะทะฐะฝ** ัะฐะทะดะตะปะธัั ะตั ะฝะฐ ะฟะพะดะทะฐะดะฐัะธ ะธะปะธ ะพัะดะตะปัะฝัะต ะทะฐะดะฐัะธ.

**ะะพัะตะผั:**
- DoD ัะฐะทะผัะฒะฐะตััั
- ะัะพะณัะตัั ััะฐะฝะพะฒะธััั ะฝะตัะตััะฝัะผ
- ะะปะพะบะตัั ััะฐะฝะพะฒัััั ะฝะตัะฟัะฐะฒะปัะตะผัะผะธ

### ะะฐะฟัะตั "ัะธัะธั ัะธะบัะพะฒ"

> [!CAUTION]
> ะััะธััะตะฝัั **ะทะฐะฟัะตัะตะฝะพ** ะฒะฝะพัะธัั ะธัะฟัะฐะฒะปะตะฝะธั ะฒ ะดะฐะฝะฝัะต CRM ะฑะตะท ัะพะทะดะฐะฝะธั ะทะฐะดะฐัะธ `type: problem`, ะตัะปะธ ะธัะฟัะฐะฒะปะตะฝะธะต ัะฒัะทะฐะฝะพ ั ะฝะฐัััะตะฝะธะตะผ ะฟัะฐะฒะธะป ะธะปะธ ะธะฝะฒะฐัะธะฐะฝัะพะฒ.

ะะธะบะฐะบะธั "ั ััั ัััั ะฟะพะดะฟัะฐะฒะธะป".

---

## T) Entity Types

### ะขะธะฟั ัััะฝะพััะตะน

CRM ะฟะพะดะดะตัะถะธะฒะฐะตั ะฝะต ัะพะปัะบะพ tasks, ะฝะพ ะธ ะดััะณะธะต ัะธะฟั ะดะปั ะผะพะดะตะปะธัะพะฒะฐะฝะธั ัะพััะพัะฝะธั ะฟัะพะตะบัะฐ:

```json
{
    "type": "task | goal | problem | risk | decision"
}
```

| Type | ะะฐะทะฝะฐัะตะฝะธะต | ะัะพะฑัะฐะถะตะฝะธะต |
|:-----|:-----------|:------------|
| `task` | ะะพะฝะบัะตัะฝะฐั ัะฐะฑะพัะฐ | Kanban ะดะพัะบะฐ |
| `goal` | ะกััะฐัะตะณะธัะตัะบะฐั ัะตะปั | Project Snapshot |
| `problem` | ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ | Project Snapshot + Alerts |
| `risk` | ะะพัะตะฝัะธะฐะปัะฝัะน ัะธัะบ | Project Snapshot |
| `decision` | ะัะธะฝััะพะต ัะตัะตะฝะธะต | Project Snapshot + History |

### ะะฝะฒะฐัะธะฐะฝั ะดะปั `decision`

> [!WARNING]
> ะขะธะฟ `decision` ะธะผะตะตั ะพัะพะฑัะต ะฟัะฐะฒะธะปะฐ:

- โ ะะ ะธะผะตะตั ััะฐัััะฐ `in_progress`
- โ ะัะตะณะดะฐ `plan` โ `released`
- โ ะะพัะปะต `released` **ะฝะต ะผะตะฝัะตััั** โ ัะพะปัะบะพ ะฝะพะฒะฐั `decision`

ะญัะพ ะบัะธัะธัะฝะพ ะดะปั ะธััะพัะธะธ ัะตัะตะฝะธะน ะธ ะฟัะตะดะพัะฒัะฐัะฐะตั "ะฟะตัะตะฟะธััะฒะฐะฝะธะต ะฟัะพัะปะพะณะพ".

### ะัะธะผะตั

```json
{
    "id": "NEXY-015",
    "type": "problem",
    "title": "CRM Data Inconsistency in blockedBy",
    "status": "plan",
    "priority": "P1",
    "description": "ะะฑะฝะฐััะถะตะฝั ัะธะบะปะธัะตัะบะธะต ะทะฐะฒะธัะธะผะพััะธ ะฒ ะฑะปะพะบะตัะฐั"
}
```

---

## U) Project Snapshot Contract

### ะกัััะบัััะฐ snapshot

```json
{
    "project_state": {
        "focus": "client | server | master",
        "active_goals": ["NEXY-001", "NEXY-005"],
        "current_problems": ["NEXY-015"],
        "current_risks": ["NEXY-020"],
        "top_blockers": [
            {"task": "CLI-010", "blocked_by": "NEXY-001", "impact": "high"}
        ],
        "last_sync_at": "2026-01-08T12:00:00-05:00"
    }
}
```

### ะัะฐะฒะธะปะพ Snapshot Enforcement

> [!CAUTION]
> **ะััะธััะตะฝั ะะ ะฝะฐัะธะฝะฐะตั ัะฐะฑะพัั, ะฝะต ะฟัะพัะธัะฐะฒ snapshot.**

ะญัะพ ัะตัะฐะตั ัะฐััะธะฝััะพะฝ ะผะตะถะดั ะฐััะธััะตะฝัะฐะผะธ.

### ะะตะฝะตัะฐัะธั snapshot

Snapshot ะณะตะฝะตัะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ `task_aggregator.py` ะฝะฐ ะพัะฝะพะฒะต:
- ะะฐะดะฐั ั `type: goal | problem | risk`
- ะะฐะดะฐั ั `priority: P0`
- ะัะตั ะฑะปะพะบะธัะพะฒะพะบ (`blockedBy`)

### ะงัะพ ะะ ะฟะพะฟะฐะดะฐะตั ะฒ snapshot

- โ Notes (ะฒ description)
- โ Audit entries
- โ ะะพะดะทะฐะดะฐัะธ (subtasks)
- โ ะะฐะดะฐัะธ ั `priority: P3`
- โ ะะฐะดะฐัะธ ะฑะตะท ะฑะปะพะบะตัะพะฒ ะธ ะฑะตะท ะฒะปะธัะฝะธั ะฝะฐ ัะตะบััะธะน ัะพะบัั

ะญัะพ ะทะฐัะธัะฐะตั snapshot ะพั ัะฐะทะดัะฒะฐะฝะธั.

---

## V) Three-Level Change Tracking

### ะฃัะพะฒะฝะธ ัะธะบัะฐัะธะธ ะธะทะผะตะฝะตะฝะธะน

```mermaid
graph TD
    A[ะะทะผะตะฝะตะฝะธะต] --> B{ะะฝะฐัะธะผะพััั?}
    B -->|ะะตะฝัะตั ัะพััะพัะฝะธะต| C[Task]
    B -->|ะฃัะพัะฝะตะฝะธะต| D[Note]
    B -->|ะขะตัะฝะธัะตัะบะพะต| E[Audit Log]
    
    C --> F[ะะธะดะฝะฐ ะฝะฐ Kanban]
    D --> G[ะ description ะทะฐะดะฐัะธ]
    E --> H[ะะฒัะพะผะฐัะธัะตัะบะธะน ะปะพะณ]
```

| ะฃัะพะฒะตะฝั | ะงัะพ ัะธะบัะธััะตะผ | ะะดะต ััะฐะฝะธััั | ะะธะดะธะผะพััั |
|:--------|:--------------|:-------------|:----------|
| **Task** | ะะทะผะตะฝะตะฝะธะต ัะพััะพัะฝะธั ะฟัะพะตะบัะฐ | `TASKS.json`, Kanban | ะััะพะบะฐั |
| **Note** | ะัะพะผะตะถััะพัะฝัะต ัะตัะตะฝะธั, ััะพัะฝะตะฝะธั | `description` ะทะฐะดะฐัะธ | ะกัะตะดะฝัั |
| **Audit** | ะขะตัะฝะธัะตัะบะธะต ะฟัะฐะฒะบะธ, ัะปัะถะตะฑะฝัะต ะฐะฟะดะตะนัั | `audit_log` (append-only) | ะะธะทะบะฐั |

### ะัะธะผะตัั

**Task:**
```json
{"id": "CLI-015", "title": "Implement new audio callback", "type": "task"}
```

**Note** (ะฒ description ะทะฐะดะฐัะธ):
```markdown
**2026-01-08:** ะฃัะพัะฝะธะปะธ ัะพัะผะฐั ะดะฐะฝะฝัั ั ัะตัะฒะตัะพะผ. ะะตัะธะปะธ ะธัะฟะพะปัะทะพะฒะฐัั protobuf.
```

**Audit** (ะฐะฒัะพะผะฐัะธัะตัะบะธ):
```json
{"timestamp": "2026-01-08T12:00:00Z", "action": "update", "field": "status", "old": "plan", "new": "in_progress"}
```

---

## W) Data Reliability

### ะะธะฝะธะผะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั ะฝะฐะดัะถะฝะพััะธ

| ะะตัะฐะฝะธะทะผ | ะะฐะทะฝะฐัะตะฝะธะต | ะะตะฐะปะธะทะฐัะธั |
|:---------|:-----------|:-----------|
| **revision** | ะะตััะธะพะฝะธัะพะฒะฐะฝะธะต | `meta.revision: 42` ะฝะฐ master ะธ ะบะฐััะพัะบะฐั |
| **conflict detection** | ะะฑะฝะฐััะถะตะฝะธะต ะบะพะฝัะปะธะบัะพะฒ | HTTP 409 ะฟัะธ `revision mismatch` |
| **atomic write** | ะัะพะผะฐัะฝะฐั ะทะฐะฟะธัั | Write to temp โ rename |
| **backup** | ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต | Backup before save |
| **audit log** | ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน | Append-only log file |

### ะคะพัะผะฐั revision

```json
{
    "meta": {
        "version": "2.1.0",
        "revision": 42,
        "updated_at": "2026-01-08T12:00:00-05:00"
    }
}
```

### Conflict Detection

ะัะธ ัะพััะฐะฝะตะฝะธะธ ัะตัะตะท `/api/save`:
1. ะะปะธะตะฝั ะพัะฟัะฐะฒะปัะตั `revision` ะบะพัะพััั ะฒะธะดะธั
2. ะกะตัะฒะตั ััะฐะฒะฝะธะฒะฐะตั ั ัะตะบััะตะน
3. ะัะปะธ `client_revision < server_revision` โ **HTTP 409 Conflict**
4. ะะปะธะตะฝั ะดะพะปะถะตะฝ ะฟะตัะตัะธัะฐัั ะดะฐะฝะฝัะต ะธ ะฟะพะฒัะพัะธัั

### ะะพะฒะตะดะตะฝะธะต ะฐััะธััะตะฝัะฐ ะฟัะธ HTTP 409

> [!IMPORTANT]
> ะัะธ ะฟะพะปััะตะฝะธะธ HTTP 409 ะฐััะธััะตะฝั **ะพะฑัะทะฐะฝ**:

1. **ะะตัะตัะธัะฐัั snapshot** โ ะดะฐะฝะฝัะต ะธะทะผะตะฝะธะปะธัั
2. **ะะพะฒัะพัะฝะพ ะพัะตะฝะธัั ะฐะบััะฐะปัะฝะพััั** โ ะดะตะนััะฒะธะต ะผะพะถะตั ะฑััั ัะถะต ะฝะตะฐะบััะฐะปัะฝะพ
3. **ะะพะถะตั ะพัะบะฐะทะฐัััั ะพั ะดะตะนััะฒะธั** โ ะตัะปะธ ะบะพะฝัะตะบัั ะธะทะผะตะฝะธะปัั

ะะต "ะปัะฑะพะน ัะตะฝะพะน ัะพััะฐะฝะธัั", ะฐ **ะพัะพะทะฝะฐะฝะฝะพ ะฟัะพะดะพะปะถะธัั**.

### Atomic Write

```python
# ะัะตะฒะดะพะบะพะด
def save_kanban(data):
    temp_path = f"{kanban_path}.tmp"
    backup_path = f"{kanban_path}.bak"
    
    # 1. Backup
    shutil.copy(kanban_path, backup_path)
    
    # 2. Write to temp
    with open(temp_path, 'w') as f:
        json.dump(data, f)
    
    # 3. Atomic rename
    os.rename(temp_path, kanban_path)
```

---

## X) Document โ Task Bidirectional Link

### ะะฐะดะฐัะฐ ะทะฝะฐะตั ัะฒะพะธ ะดะพะบัะผะตะฝัั

```json
{
    "responsible_docs": [
        {"path": "Docs/ARCHITECTURE_OVERVIEW.md", "type": "source_of_truth"}
    ]
}
```

### ะะพะบัะผะตะฝั ะทะฝะฐะตั ัะฒะพะธ ะทะฐะดะฐัะธ (meta-ะฑะปะพะบ)

```markdown
---
crm_meta:
  supports_tasks: ["NEXY-001", "CLI-015"]
  type: source_of_truth
  last_reviewed: 2026-01-08
---

# Document Title
...
```

### ะกะฒัะทั ะดะตะปะฐะตั ะดะพะบัะผะตะฝัะฐัะธั ะถะธะฒะพะน

ะกะธััะตะผะฐ ะผะพะถะตั ะฟะพะบะฐะทะฐัั:
- "ะญัะพั ะดะพะบัะผะตะฝั ะพัะฒะตัะฐะตั ะทะฐ ััะธ ะทะฐะดะฐัะธ"
- "ะญัะฐ ะทะฐะดะฐัะฐ ะทะฐะฒะธัะธั ะพั ััะธั ะดะพะบัะผะตะฝัะพะฒ"

---

## Y) Lifecycle & Housekeeping Policy

> **ะัะธะฝัะธะฟ:** ะะต ัะดะฐะปะตะฝะธะต, ะฐ ะฐััะธะฒะฐัะธั + ัะพัะฐัะธั + ะฟะพะผะตัะบะฐ ั ะฟัะธัะธะฝะพะน.

### ะขะธะฟั ะฝะฐะบะพะฟะปะตะฝะธั ะธ ะผะตัะพะดั

| ะขะธะฟ | ะัะพะฑะปะตะผะฐ | ะะตัะตะฝะธะต |
|:----|:---------|:--------|
| ะกัะฐััะต ะทะฐะดะฐัะธ | released ะดะฐะฒะฝะพ ะฝะต ััะพะณะฐะปะธ | Archive via Release |
| ะััะพัะฝัะต ัะตัะฝะพะฒะธะบะธ | plan ะฑะตะท DoD/owner/ะดะฒะธะถะตะฝะธั | Stale โ Backlog |
| ะจัะผ ะฒ audit log | ะะฝะพะณะพ ะทะฐะฟะธัะตะน | ะะพัะฐัะธั |
| ะะธััะต ัััะปะบะธ | ะะตัััะตััะฒัััะธะต docs/files | Problem ะทะฐะดะฐัะฐ |

### TTL-ะฟะพะปะธัะธะบะฐ (Time To Live)

| ะกัะฐััั | ะฃัะปะพะฒะธะต | ะะตะนััะฒะธะต |
|:-------|:--------|:---------|
| `released` | โ | ะััะธะฒะธัะพะฒะฐัั ัะตัะตะท Ship Release |
| `testing` | ะะตะท ะฐะฟะดะตะนัะพะฒ > 14 ะดะฝะตะน | Alert "stale testing" |
| `in_progress` | ะะตะท ะฐะฟะดะตะนัะพะฒ > 7 ะดะฝะตะน | โ `plan` + note "stale" |
| `plan` | ะะตะท ะฐะฟะดะตะนัะพะฒ > 30 ะดะฝะตะน | โ `archived: true` |

> [!IMPORTANT]
> ะะธะบะพะณะดะฐ ะฝะต **delete** โ ัะพะปัะบะพ **archive/move** + ะฟะพะผะตัะบะฐ ะฟัะธัะธะฝั.

### ะะพะปั lifecycle

```json
{
    "archived": true,
    "archived_at": "2026-01-08T12:00:00-05:00",
    "archive_reason": "stale_plan_30d",
    
    "stale": true,
    "stale_since": "2026-01-01T12:00:00-05:00",
    "stale_reason": "no_updates_7d"
}
```

| ะะพะปะต | ะขะธะฟ | ะะฐะทะฝะฐัะตะฝะธะต |
|:-----|:----|:-----------|
| `archived` | bool | ะะฐะดะฐัะฐ ะฒ ะฐััะธะฒะต |
| `archived_at` | ISO date | ะะพะณะดะฐ ะฐััะธะฒะธัะพะฒะฐะฝะฐ |
| `archive_reason` | string | ะัะธัะธะฝะฐ: `stale_plan_30d`, `manual`, `released` |
| `stale` | bool | ะะฐะดะฐัะฐ "ะทะฐััะพัะปะฐัั" |
| `stale_since` | ISO date | ะก ะบะฐะบะพะณะพ ะผะพะผะตะฝัะฐ stale |
| `stale_reason` | string | ะัะธัะธะฝะฐ: `no_updates_7d`, `no_dod`, `no_owner` |

### UI-ัะธะปัััะฐัะธั (ัะตะบะพะผะตะฝะดะฐัะธั)

**ะะพ ัะผะพะปัะฐะฝะธั ะฟะพะบะฐะทัะฒะฐัั:**
- ะัั `in_progress`, `testing`
- `plan` ัะพะปัะบะพ ะตัะปะธ:
  - `priority: P0/P1`, ะธะปะธ
  - ะธะผะตะตั `blockedBy`, ะธะปะธ
  - ะพะฑะฝะพะฒะปัะปะฐัั ะฒ ะฟะพัะปะตะดะฝะธะต 14 ะดะฝะตะน

**ะัะดะตะปัะฝะฐั ะฒะบะปะฐะดะบะฐ:** "Backlog/Archived"

### `crm_housekeeper.py` โ ัะฟะตัะธัะธะบะฐัะธั

ะกะบัะธะฟั ะทะฐะฟััะบะฐะตััั **ะฒัััะฝัั ะธะปะธ ะฟะพ ัะฐัะฟะธัะฐะฝะธั**, ะดะตะปะฐะตั ัะพะปัะบะพ ะฑะตะทะพะฟะฐัะฝัะต ะดะตะนััะฒะธั:

```python
# ะัะตะฒะดะพะปะพะณะธะบะฐ

def run_housekeeper():
    tasks = load_all_tasks()
    problems = []
    
    for task in tasks:
        # 1. ะัะพะฒะตัะบะฐ stale
        if task.status == 'in_progress' and days_since(task.updated_at) > 7:
            task.stale = True
            task.stale_since = now()
            task.stale_reason = 'no_updates_7d'
            task.status = 'plan'  # return to plan
            add_note(task, "Auto-marked stale: no updates 7d")
        
        if task.status == 'plan' and days_since(task.updated_at) > 30:
            task.archived = True
            task.archived_at = now()
            task.archive_reason = 'stale_plan_30d'
        
        # 2. ะัะพะฒะตัะบะฐ ะฑะธััั ัััะปะพะบ
        for doc in task.responsible_docs:
            if not file_exists(doc.path):
                problems.append({
                    'type': 'broken_responsible_doc',
                    'task': task.id,
                    'path': doc.path
                })
        
        if task.file_path and not file_exists(task.file_path):
            problems.append({
                'type': 'broken_file_path',
                'task': task.id,
                'path': task.file_path
            })
    
    # 3. ะกะพะทะดะฐัั NEXY-* problem ะตัะปะธ ะตััั ะฝะฐัััะตะฝะธั
    if problems:
        create_problem_task(
            title="CRM Link Rot / Broken References",
            description=format_problems(problems)
        )
    
    save_all_tasks(tasks)
    log_to_audit(action='housekeeper_run', problems_found=len(problems))
```

> [!CAUTION]
> Housekeeper **ะฝะธะบะพะณะดะฐ ะฝะต ัะดะฐะปัะตั** ะบะฐััะพัะบะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ.

### ะะพัะฐัะธั Audit Log

Audit log = append-only, ะฝะพ ะฝะต ะฑะตัะบะพะฝะตัะฝัะน.

**ะะตัะฐะฝะธะทะผ ัะพัะฐัะธะธ:**
```
CRM_AUDIT_LOG.ndjson
  โ CRM_AUDIT_LOG.2026-01.ndjson.gz  (monthly archive)
```

ะะปัั ะฐะณัะตะณะธัะพะฒะฐะฝะฝัะต daily summaries:
```
Docs/audit/AUDIT_SUMMARY_2026-01-08.md
```

### ะะพะฝัะธะณััะฐัะธั housekeeping

ะ `meta` ัะตะบัะธะธ `PROJECT_KANBAN.json`:

```json
{
    "meta": {
        "housekeeping": {
            "stale_in_progress_days": 7,
            "stale_testing_days": 14,
            "stale_plan_days": 30,
            "default_visible_plan_days": 14,
            "audit_rotate_days": 30
        }
    }
}
```

---

## AA) UI Specification

### ะะบะพะฝะบะธ ัะธะฟะพะฒ ะทะฐะดะฐั

| Type | ะะบะพะฝะบะฐ | ะะดะต ะฒะธะดะฝะพ |
|:-----|:-------|:----------|
| `task` | ๐ง | Kanban |
| `goal` | ๐ฏ | Kanban + Snapshot |
| `problem` | โ๏ธ | Kanban + Snapshot (alert) |
| `risk` | ๐บ | Snapshot |
| `decision` | ๐ | Snapshot + History |

### Layout ะบะฐััะพัะบะธ (UI)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฏ NEXY-003 | Task Title                            P0 ๐ฃ  โ
โ Type: goal                                      Epic: MVP  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Status: in_progress ๐จ      Progress: โโโโโโโโโโ 33%       โ
โ Owner: Antigravity          Updated: 2026-01-08            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ซ BLOCKED BY:                                              โ
โ    โโ NEXY-001 (title) โ status                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ SUBTASKS:                                                โ
โ    โ Completed subtask                                     โ
โ    ๐จ In progress subtask โ current                        โ
โ    โฌ Planned subtask                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ RESPONSIBLE DOCS:                                        โ
โ    โโ Docs/file.md (source_of_truth)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ ACCEPTANCE CRITERIA: (expandable)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ DESCRIPTION: (expandable with markdown)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [Open File] [Edit] [Add Note]                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Snapshot View (ะฐะณัะตะณะธัะพะฒะฐะฝะฝัะน)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ PROJECT SNAPSHOT                    Last sync: 12:00 UTCโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฏ ACTIVE GOALS:                                            โ
โ    โโ NEXY-003: CRM v2.1 Go-Live (33%)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ๏ธ CURRENT PROBLEMS:                                        โ
โ    โโ (none)                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐บ RISKS:                                                   โ
โ    โโ (none)                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ซ TOP BLOCKERS:                                            โ
โ    โโ NEXY-003 blocked by NEXY-001 (high impact)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ WIP STATUS:                                              โ
โ    Master: 1/1 in_progress, 0/1 testing                    โ
โ    Client: 0/1 in_progress, 0/1 testing                    โ
โ    Server: 0/1 in_progress, 0/1 testing                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Z) Version History

| Version | Date | Changes |
|:--------|:-----|:--------|
| **v1.0** | 2026-01-05 | Initial rules A-G |
| **v2.0** | 2026-01-08 | TL;DR, Workflow H-R, Control Plane S-X |
| **v2.1** | 2026-01-08 | Critical refinements, Lifecycle & Housekeeping Y |
| **v2.2** | 2026-01-08 | UI Specification AA, Go-Live Checklist INS-009 |

