# üìä –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Control+N

## üéØ –¶–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞

–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ Control+N, –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç, race conditions –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

---

## üìã –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 1.1. KeyboardMonitor (pynput) / QuartzKeyboardMonitor (macOS)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `_control_pressed` - –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–ª–∞–≤–∏—à–∞ Control
- `_n_pressed` - –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–ª–∞–≤–∏—à–∞ N
- `_combo_active` - –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è (–æ–±–µ –∫–ª–∞–≤–∏—à–∏ –∑–∞–∂–∞—Ç—ã)
- `_combo_start_time` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
- `_long_sent` - –±—ã–ª –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω LONG_PRESS
- `key_pressed` - –æ–±—â–∏–π —Ñ–ª–∞–≥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è:**
1. `PRESS` - –∫–æ–≥–¥–∞ –æ–±–µ –∫–ª–∞–≤–∏—à–∏ –∑–∞–∂–∞—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (combo_active: False ‚Üí True)
2. `LONG_PRESS` - –∫–æ–≥–¥–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è > 0.6 —Å–µ–∫—É–Ω–¥—ã (–∏–∑ `hold_monitor_thread`)
3. `SHORT_PRESS` - –∫–æ–≥–¥–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –æ—Ç–ø—É—â–µ–Ω–∞ –¥–æ LONG_PRESS (combo_active: True ‚Üí False, _long_sent=False)
4. `RELEASE` - –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ SHORT_PRESS, –∏–ª–∏ —Å—Ä–∞–∑—É –µ—Å–ª–∏ LONG_PRESS –±—ã–ª

**–ü–æ—Ç–æ–∫–∏:**
- `hold_monitor_thread` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–¥–µ—Ä–∂–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ `hold_check_interval`
- `_tap_monitor_thread` (Quartz) - –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å event tap

**–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏:**
- `state_lock` (RLock) - –∑–∞—â–∏—â–∞–µ—Ç –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

---

#### 1.2. InputProcessingIntegration
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π

**–ö–ª—é—á–µ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
- `_pending_session_id` - –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è (—Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ PRESS, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –≤ LONG_PRESS)
- `_recording_started` - –Ω–∞—á–∞—Ç–∞ –ª–∏ –∑–∞–ø–∏—Å—å (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ LONG_PRESS)
- `_session_recognized` - —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –ª–∏ —Å–µ—Å—Å–∏—è (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `_on_recognition_completed`)
- `_mic_active` - –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `voice.mic_opened`)
- `_playback_active` - –∞–∫—Ç–∏–≤–Ω–æ –ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
- `_active_grpc_session_id` - –∞–∫—Ç–∏–≤–Ω–∞—è gRPC —Å–µ—Å—Å–∏—è
- `_cancel_session_id` - —Å–µ—Å—Å–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã
- `_pending_recording_cancelled` - —Ñ–ª–∞–≥ –æ—Ç–º–µ–Ω—ã pending –∑–∞–ø–∏—Å–∏

**–°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:**
1. `PRESS` ‚Üí `_handle_press()`
2. `LONG_PRESS` ‚Üí `_handle_long_press()`
3. `SHORT_PRESS` ‚Üí `_handle_short_press()`
4. `RELEASE` ‚Üí `_handle_key_release()`

**–í–Ω–µ—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:**
- `voice.recording_start` - –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ LONG_PRESS
- `voice.recording_stop` - –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ RELEASE –∏–ª–∏ SHORT_PRESS
- `voice.mic_opened` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `_mic_active = True`
- `voice.mic_closed` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `_mic_active = False`
- `mode.request` - –∑–∞–ø—Ä–æ—Å —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ (SLEEPING/LISTENING/PROCESSING)

---

### 2. State Machine (–ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π)

#### 2.1. –†–µ–∂–∏–º—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (AppMode)
```
SLEEPING ‚Üí LISTENING ‚Üí PROCESSING ‚Üí SLEEPING
   ‚Üë                                    ‚Üì
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü–µ—Ä–µ—Ö–æ–¥—ã:**
- `SLEEPING ‚Üí LISTENING`: –ø—Ä–∏ LONG_PRESS (–ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `voice.recording_start`)
- `LISTENING ‚Üí PROCESSING`: –ø—Ä–∏ RELEASE –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ (–ø—É–±–ª–∏–∫—É–µ—Ç—Å—è `voice.recording_stop`)
- `PROCESSING ‚Üí SLEEPING`: –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ SHORT_PRESS (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)

---

#### 2.2. –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏
```
–ù–µ—Ç —Å–µ—Å—Å–∏–∏
   ‚Üì
PRESS ‚Üí _pending_session_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   ‚Üì
LONG_PRESS ‚Üí _recording_started = True, session_id –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
   ‚Üì
RELEASE ‚Üí _recording_started = False, –ø–µ—Ä–µ—Ö–æ–¥ –≤ PROCESSING
   ‚Üì
gRPC –∑–∞–≤–µ—Ä—à–µ–Ω ‚Üí _reset_session()
```

---

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ PRESS

**–§–∞–π–ª:** `input_processing_integration.py::_handle_press()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `_cancel_session_id` (–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Ç–º–µ–Ω—ã)
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `_pending_session_id = event.timestamp`
3. –°–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —Ñ–ª–∞–≥–∏: `_session_recognized = False`, `_recording_started = False`
4. –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è `keyboard.press` (–¥–ª—è VoiceOver)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º - –ª–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

---

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ LONG_PRESS

**–§–∞–π–ª:** `input_processing_integration.py::_handle_long_press()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. **–ó–ê–©–ò–¢–ê 2:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `_pending_session_id is not None`
2. **–ó–ê–©–ò–¢–ê 3:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed == True`
3. **–ó–ê–©–ò–¢–ê 4:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `_mic_active == False`
4. **–ó–ê–©–ò–¢–ê 5:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `_recording_started == False`
5. –û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ gRPC (–µ—Å–ª–∏ –µ—Å—Ç—å)
6. –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (`_ensure_playback_idle()`, —Ç–∞–π–º–∞—É—Ç 2.0s)
7. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (`_wait_for_mic_closed()`, —Ç–∞–π–º–∞—É—Ç 1.0s)
8. –ü—Ä–æ–≤–µ—Ä–∫–∞ `_pending_recording_cancelled` (–µ—Å–ª–∏ RELEASE –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ)
9. –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed` –µ—â–µ —Ä–∞–∑
10. –ü—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_start`
11. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `_recording_started = True`
12. –ü—É–±–ª–∏–∫–∞—Ü–∏—è `mode.request(LISTENING)`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê 1:** –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (–¥–æ 3 —Å–µ–∫—É–Ω–¥) –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–æ–º—É, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—É—Å—Ç–∏—Ç –∫–ª–∞–≤–∏—à—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è LONG_PRESS
- ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê 2:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π (race condition)
- ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê 3:** –ï—Å–ª–∏ RELEASE –ø—Ä–∏—à–µ–ª –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è, `_pending_recording_cancelled` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –Ω–æ LONG_PRESS –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

---

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ SHORT_PRESS

**–§–∞–π–ª:** `input_processing_integration.py::_handle_short_press()`

**–î–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è:**

#### –°—Ü–µ–Ω–∞—Ä–∏–π A: SHORT_PRESS –ë–ï–ó –∑–∞–ø–∏—Å–∏ (pending_session –µ—Å—Ç—å, –Ω–æ _recording_started=False)
1. –û—Ç–º–µ–Ω–∞ pending session
2. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ)
3. –ü—É–±–ª–∏–∫–∞—Ü–∏—è `playback.cancelled` –∏ `interrupt.request`
4. –ü–µ—Ä–µ—Ö–æ–¥ –≤ SLEEPING

#### –°—Ü–µ–Ω–∞—Ä–∏–π B: SHORT_PRESS –° –∑–∞–ø–∏—Å—å—é (_recording_started=True)
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏
2. –ü—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_stop`
3. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
4. –ü–µ—Ä–µ—Ö–æ–¥ –≤ PROCESSING

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

---

### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ RELEASE

**–§–∞–π–ª:** `input_processing_integration.py::_handle_key_release()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `was_recording = _recording_started` (–î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏)
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `saved_session_id` (–î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏)
3. –û—Ç–º–µ–Ω–∞ pending recording (`_pending_recording_cancelled = True`)
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ `_should_stop_recording()` (–º–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω –ò–õ–ò –∑–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞ –ò–õ–ò –µ—Å—Ç—å —Å–µ—Å—Å–∏—è)
5. –ü—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_stop` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
6. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (—Ç–∞–π–º–∞—É—Ç 2.0s)
7. –ü–µ—Ä–µ—Ö–æ–¥ –≤ PROCESSING (–µ—Å–ª–∏ `was_recording == True`)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê 4:** –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–¥–æ 2 —Å–µ–∫—É–Ω–¥) –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
- ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê 5:** –ï—Å–ª–∏ LONG_PRESS –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, `_pending_recording_cancelled` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –Ω–æ LONG_PRESS –º–æ–∂–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ

---

## üêõ –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Race Condition –º–µ–∂–¥—É LONG_PRESS –∏ RELEASE

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- LONG_PRESS –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–æ–∂–∏–¥–∞–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—É—Å–∫–∞–µ—Ç –∫–ª–∞–≤–∏—à—É ‚Üí RELEASE —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `_pending_recording_cancelled = True`
- LONG_PRESS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `_pending_recording_cancelled` –∏ –≤—ã—Ö–æ–¥–∏—Ç
- –ù–û: –µ—Å–ª–∏ LONG_PRESS —É–∂–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É, –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å `voice.recording_start`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `_handle_long_press()` —Å—Ç—Ä–æ–∫–∏ 1127-1132
- `_handle_key_release()` —Å—Ç—Ä–æ–∫–∏ 1218-1221

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î–æ–ª–≥–∏–µ —Ç–∞–π–º–∞—É—Ç—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_ensure_playback_idle()` –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –¥–æ 2 —Å–µ–∫—É–Ω–¥
- `_wait_for_mic_closed()` –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –¥–æ 2 —Å–µ–∫—É–Ω–¥
- –í —Å—É–º–º–µ LONG_PRESS –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–æ 4 —Å–µ–∫—É–Ω–¥
- –ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞–≤–∏—à—É, —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ race condition

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `_handle_long_press()` —Å—Ç—Ä–æ–∫–∏ 1114, 1119
- `_handle_key_release()` —Å—Ç—Ä–æ–∫–∞ 1271

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- LONG_PRESS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `keyboard_monitor.key_pressed` –¥–≤–∞–∂–¥—ã (—Å—Ç—Ä–æ–∫–∏ 1065, 1135)
- –ù–æ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –≤—Ä–µ–º—è (–æ–∂–∏–¥–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
- –ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞–≤–∏—à—É, –Ω–æ LONG_PRESS –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `_handle_long_press()` —Å—Ç—Ä–æ–∫–∏ 1065-1069, 1135-1139

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø

---

### –ü—Ä–æ–±–ª–µ–º–∞ 4: "–ó–∞–ª–∏–ø–∞–Ω–∏–µ" Control –∫–ª–∞–≤–∏—à–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- QuartzKeyboardMonitor –º–æ–∂–µ—Ç –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ Control
- `kCGEventFlagsChanged` —Å `keycode=0` –º–æ–∂–µ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É, —á—Ç–æ `_control_pressed` –æ—Å—Ç–∞–µ—Ç—Å—è `True`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `quartz_monitor.py::_handle_combo_event()` —Å—Ç—Ä–æ–∫–∏ 133-166

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã—Å—Ç—Ä–æ –Ω–∞–∂–∏–º–∞–µ—Ç Control+N –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ö–∞–∂–¥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π `_pending_session_id`
- –°—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –Ω–æ–≤—ã—Ö
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø—É—Ç–∞–Ω–∏—Ü–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø

---

### –ü—Ä–æ–±–ª–µ–º–∞ 6: –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ `stop_listening`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `stop_listening()` –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã (–±—ã–ª–æ 5)
- `_graceful_stop_listening()` –∂–¥–µ—Ç –¥–æ 0.5 —Å–µ–∫—É–Ω–¥—ã (–±—ã–ª–æ 2)
- –≠—Ç–æ –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É RELEASE

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- `speech_recognizer.py::stop_listening()` —Å—Ç—Ä–æ–∫–∞ 532
- `speech_recognizer.py::_graceful_stop_listening()` —Å—Ç—Ä–æ–∫–∞ 286

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –ù–ò–ó–ö–ê–Ø (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

---

## üìê –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)

### –ò–¥–µ–∞–ª—å–Ω–∞—è State Machine

```
[SLEEPING]
   ‚Üì PRESS
[PENDING] (_pending_session_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –º–∏–∫—Ä–æ—Ñ–æ–Ω –ù–ï –æ—Ç–∫—Ä—ã—Ç)
   ‚Üì LONG_PRESS (>0.6s)
[LISTENING] (_recording_started=True, –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫—Ä—ã—Ç)
   ‚Üì RELEASE
[PROCESSING] (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
   ‚Üì –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
[SLEEPING]

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏:
- PENDING ‚Üí SHORT_PRESS ‚Üí SLEEPING (–æ—Ç–º–µ–Ω–∞)
- LISTENING ‚Üí SHORT_PRESS ‚Üí PROCESSING (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏)
- PROCESSING ‚Üí SHORT_PRESS ‚Üí SLEEPING (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)
```

### –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

1. **PRESS:**
   - –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç `_pending_session_id`
   - –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω
   - –ù–ï –º–µ–Ω—è–µ—Ç —Ä–µ–∂–∏–º

2. **LONG_PRESS:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `_pending_session_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–ª–∞–≤–∏—à–∞ –í–°–ï –ï–©–ï –Ω–∞–∂–∞—Ç–∞ (–∞—Ç–æ–º–∞—Ä–Ω–æ)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ù–ï –∞–∫—Ç–∏–≤–µ–Ω
   - –ë—ã—Å—Ç—Ä–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
   - –ë—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
   - –ü—É–±–ª–∏–∫—É–µ—Ç `voice.recording_start`
   - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ LISTENING

3. **SHORT_PRESS:**
   - –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –Ω–∞—á–∞—Ç–∞ ‚Üí –æ—Ç–º–µ–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥ –≤ SLEEPING
   - –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞ ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ—Ö–æ–¥ –≤ PROCESSING

4. **RELEASE:**
   - –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞)
   - –ï—Å–ª–∏ –±—ã–ª–∞ –∑–∞–ø–∏—Å—å ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ PROCESSING
   - –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ –±—ã–ª–æ ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ

---

## üîß –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –≠—Ç–∞–ø 0: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ö–†–ò–¢–ò–ß–ù–û)

#### 0.1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ Enum
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ (`_pending_session_id`, `_recording_started`, `_mic_active`) —É—Å–ª–æ–∂–Ω—è—é—Ç –ª–æ–≥–∏–∫—É –∏ —Å–æ–∑–¥–∞—é—Ç race conditions

**–†–µ—à–µ–Ω–∏–µ:**
```python
from enum import Enum, auto

class InputState(Enum):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞"""
    IDLE = auto()              # –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    PENDING = auto()           # PRESS –ø–æ–ª—É—á–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ LONG_PRESS
    LISTENING = auto()         # LONG_PRESS –ø–æ–ª—É—á–µ–Ω, –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–∞
    PROCESSING = auto()        # RELEASE –ø–æ–ª—É—á–µ–Ω, –æ–±—Ä–∞–±–æ—Ç–∫–∞ gRPC
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –Ø–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_recording_started=True` –∏ `_mic_active=False`)
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫: `if self.state == InputState.LISTENING:` –≤–º–µ—Å—Ç–æ `if _recording_started and _mic_active:`
- –õ–µ–≥—á–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å `self._input_state: InputState = InputState.IDLE`
- –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ `self._input_state`
- –ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `_set_input_state(new_state, reason)`

#### 0.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.Lock` –≤–º–µ—Å—Ç–æ `threading.Lock`
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `threading.Lock/RLock` –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `threading.Lock` –Ω–∞ `asyncio.Lock` –≤ async –º–µ—Ç–æ–¥–∞—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `async with self._state_lock:` –≤–º–µ—Å—Ç–æ `with self._state_lock:`
- –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, KeyboardMonitor) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.run_coroutine_threadsafe()` –∏–ª–∏ `call_soon_threadsafe()`

**–í–∞–∂–Ω–æ:**
- `asyncio.Lock` –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop, –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º –∫–æ—Ä—É—Ç–∏–Ω–∞–º –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
- `threading.Lock` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø–æ—Ç–æ–∫, –≤–∫–ª—é—á–∞—è event loop

#### 0.3. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å "–ø—Ä–æ–≤–µ—Ä–∫–∏-–∏-—É—Å—Ç–∞–Ω–æ–≤–∫–∏"
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
```python
async def _handle_long_press(self, event: KeyEvent):
    async with self._state_lock:  # –ö–†–ò–¢–ò–ß–ù–û: –æ–¥–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ–¥–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        if self._long_press_in_progress:
            logger.warning("‚ö†Ô∏è LONG_PRESS —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
            return
        self._long_press_in_progress = True
    
    try:
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
    finally:
        async with self._state_lock:
            self._long_press_in_progress = False
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `if self._long_press_in_progress:` –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `self._long_press_in_progress = True` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏ (`async with lock:`)

---

### –≠—Ç–∞–ø 1: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Race Conditions

#### 1.1. –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ LONG_PRESS
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π `voice.recording_start`
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `_long_press_in_progress` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LONG_PRESS
- **–ö–†–ò–¢–ò–ß–ù–û:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –≤ –æ–¥–Ω–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏

#### 1.2. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `_pending_recording_cancelled`
**–ü—Ä–æ–±–ª–µ–º–∞:** LONG_PRESS –º–æ–∂–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Event` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–ª–∞–≥–∞ –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `_pending_recording_cancelled_event.is_set()` –ø–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û `await`
- –°–±—Ä–∞—Å—ã–≤–∞—Ç—å event –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: `_pending_recording_cancelled_event.clear()`

---

### –≠—Ç–∞–ø 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤

#### 2.1. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ –æ–∂–∏–¥–∞–Ω–∏—è
**–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `_ensure_playback_idle()`: 2.0s
- `_wait_for_mic_closed()`: 1.0s (LONG_PRESS), 2.0s (RELEASE)

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `_ensure_playback_idle()`: 0.5s (–±—ã—Å—Ç—Ä–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)
- `_wait_for_mic_closed()`: 0.3s (LONG_PRESS), 0.5s (RELEASE)

#### 2.2. –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.wait_for()` —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏
- **–ö–†–ò–¢–ò–ß–ù–û:** –û–±–µ—Ä–Ω—É—Ç—å –≤ `try...except asyncio.TimeoutError` —Å —á–µ—Ç–∫–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ (—Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
try:
    await asyncio.wait_for(self._ensure_playback_idle(), timeout=0.5)
    logger.debug("‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
except asyncio.TimeoutError:
    logger.warning("‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (0.5s), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º")
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    await self.event_bus.publish("playback.cancelled", {...})
except Exception as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: {e}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
```

---

### –≠—Ç–∞–ø 3: –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π

#### 3.1. Debounce –¥–ª—è PRESS
**–†–µ—à–µ–Ω–∏–µ:**
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å PRESS, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π PRESS –±—ã–ª –º–µ–Ω–µ–µ 0.1s –Ω–∞–∑–∞–¥
- –û—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π `_pending_session_id` –ø—Ä–∏ –Ω–æ–≤–æ–º PRESS

#### 3.2. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LONG_PRESS
**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–ª–∞–≥ `_long_press_in_progress`
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ LONG_PRESS –ø–æ–∫–∞ —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

---

### –≠—Ç–∞–ø 4: –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Control –∑–∞–ª–∏–ø–∞–Ω–∏—è

#### 4.1. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Control
**–†–µ—à–µ–Ω–∏–µ:**
- –í `hold_monitor_thread` –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ Control –∫–∞–∂–¥—ã–µ 0.1s
- –°–±—Ä–∞—Å—ã–≤–∞—Ç—å `_control_pressed` –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

#### 4.2. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `kCGEventFlagsChanged`
**–†–µ—à–µ–Ω–∏–µ:**
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `flags & kCGEventFlagMaskControl`, –¥–∞–∂–µ –µ—Å–ª–∏ `keycode=0`
- –û–±–Ω–æ–≤–ª—è—Ç—å `_control_pressed` –Ω–∞ –æ—Å–Ω–æ–≤–µ flags, –∞ –Ω–µ keycode

---

## üìä –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

| –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –°–æ–±—ã—Ç–∏–µ | –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏—è |
|-------------------|---------|-----------------|----------|
| SLEEPING | PRESS | PENDING | `_pending_session_id = timestamp` |
| PENDING | LONG_PRESS | LISTENING | `voice.recording_start`, `mode.request(LISTENING)` |
| PENDING | SHORT_PRESS | SLEEPING | –û—Ç–º–µ–Ω–∞, `interrupt.request`, `mode.request(SLEEPING)` |
| LISTENING | RELEASE | PROCESSING | `voice.recording_stop`, `mode.request(PROCESSING)` |
| LISTENING | SHORT_PRESS | PROCESSING | `voice.recording_stop`, `mode.request(PROCESSING)` |
| PROCESSING | SHORT_PRESS | SLEEPING | `playback.cancelled`, `interrupt.request`, `mode.request(SLEEPING)` |
| PROCESSING | playback.completed | SLEEPING | `mode.request(SLEEPING)` |

---

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. `_handle_long_press()` - —Å—Ç—Ä–æ–∫–∏ 1114-1125
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ race condition

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ **–≠—Ç–∞–ø 0:** –í–≤–µ—Å—Ç–∏ `InputState` enum –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ **–≠—Ç–∞–ø 0:** –ó–∞–º–µ–Ω–∏—Ç—å `threading.Lock` –Ω–∞ `asyncio.Lock`
- –£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–æ 0.3-0.5s
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `_pending_recording_cancelled_event.is_set()` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `await`
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `keyboard_monitor.key_pressed` –∞—Ç–æ–º–∞—Ä–Ω–æ (–≤ `async with lock:`) –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É-–∏-—É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–ª—è `_long_press_in_progress`

### 2. `_handle_key_release()` - —Å—Ç—Ä–æ–∫–∏ 1218-1221, 1271
**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `_pending_recording_cancelled` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ **–≠—Ç–∞–ø 0:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Event` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–ª–∞–≥–∞
- ‚úÖ **–≠—Ç–∞–ø 0:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥–æ 0.5s
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `asyncio.TimeoutError` —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### 3. `quartz_monitor.py::_handle_combo_event()` - —Å—Ç—Ä–æ–∫–∏ 133-166
**–ü—Ä–æ–±–ª–µ–º–∞:** Control –º–æ–∂–µ—Ç "–∑–∞–ª–∏–ø–∞—Ç—å"

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `flags & kCGEventFlagMaskControl`, –¥–∞–∂–µ –µ—Å–ª–∏ `keycode=0`
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ Control –≤ `hold_monitor_thread`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `threading.RLock` (—ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥, –Ω–µ async)

### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É KeyboardMonitor –∏ InputProcessingIntegration

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ **–≠—Ç–∞–ø 0:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –≤ async –∫–æ–¥–µ
- ‚úÖ **–≠—Ç–∞–ø 0:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.run_coroutine_threadsafe()` –¥–ª—è –≤—ã–∑–æ–≤–∞ async –º–µ—Ç–æ–¥–æ–≤ –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
- –ê—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ `InputState` enum

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º):
1. ‚úÖ **–≠—Ç–∞–ø 0.1:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ `InputState` enum
2. ‚úÖ **–≠—Ç–∞–ø 0.2:** –ó–∞–º–µ–Ω–∞ `threading.Lock` –Ω–∞ `asyncio.Lock` –≤ async –∫–æ–¥–µ
3. ‚úÖ **–≠—Ç–∞–ø 0.3:** –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏-–∏-—É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–≥–æ–≤
4. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ race condition –º–µ–∂–¥—É LONG_PRESS –∏ RELEASE
5. ‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ª–∏–ø–∞–Ω–∏—è Control
6. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤ (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –¥–æ 0.3-0.5s)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
7. –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (debounce)
8. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `asyncio.TimeoutError` —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
9. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.Event` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
10. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
11. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
12. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –®–∞–≥ 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–≠—Ç–∞–ø 0)
1. **–°–æ–∑–¥–∞—Ç—å `InputState` enum** –≤ `input_processing_integration.py`
2. **–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ —Ñ–ª–∞–≥–∏ –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** —á–µ—Ä–µ–∑ `_input_state`
3. **–ó–∞–º–µ–Ω–∏—Ç—å `threading.Lock` –Ω–∞ `asyncio.Lock`** –≤ async –º–µ—Ç–æ–¥–∞—Ö
4. **–î–æ–±–∞–≤–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏-–∏-—É—Å—Ç–∞–Ω–æ–≤–∫–∏** –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–ª–∞–≥–æ–≤
5. **–ó–∞–º–µ–Ω–∏—Ç—å `_pending_recording_cancelled` –Ω–∞ `asyncio.Event`**

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Race Conditions (–≠—Ç–∞–ø 1)
1. **–£–ª—É—á—à–∏—Ç—å `_handle_long_press()`** —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
2. **–£–ª—É—á—à–∏—Ç—å `_handle_key_release()`** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `asyncio.Event`
3. **–î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö LONG_PRESS** —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `_long_press_in_progress`

### –®–∞–≥ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤ (–≠—Ç–∞–ø 2)
1. **–£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã** –¥–æ 0.3-0.5s
2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É `asyncio.TimeoutError`** —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. **–ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ** —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏

### –®–∞–≥ 4: –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (–≠—Ç–∞–ø 3)
1. **–î–æ–±–∞–≤–∏—Ç—å debounce –¥–ª—è PRESS** (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ < 0.1s)
2. **–û—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π `_pending_session_id`** –ø—Ä–∏ –Ω–æ–≤–æ–º PRESS

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ race conditions** –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –Ω–∞–∂–∞—Ç–∏—è—Ö
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ª–∏–ø–∞–Ω–∏—è** Control –∫–ª–∞–≤–∏—à–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –¥–ª—è –±—É–¥—É—â–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã —á–µ—Ä–µ–∑ `InputState` enum
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –≤ async –∫–æ–¥–µ
3. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ–¥–Ω–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
4. **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —Ç–∞–π–º–∞—É—Ç—ã:** –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. **–Ø–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:** –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `_set_input_state()`

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `integration/integrations/input_processing_integration.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `modules/input_processing/keyboard/keyboard_monitor.py` - pynput –º–æ–Ω–∏—Ç–æ—Ä
- `modules/input_processing/keyboard/mac/quartz_monitor.py` - Quartz –º–æ–Ω–∏—Ç–æ—Ä
- `modules/voice_recognition/core/speech_recognizer.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
- `modules/speech_playback/core/player.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º

