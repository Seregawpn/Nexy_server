# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ª–∏–ø–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–≤–µ—Ä—Å–∏—è 2)

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2025-11-30

## –ü—Ä–æ–±–ª–µ–º–∞
–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è Ctrl+N. –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ, —á—Ç–æ:
1. ‚úÖ `voice.recording_stop` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è (—Å—Ç—Ä–æ–∫–∞ 353)
2. ‚úÖ `_on_recording_stop` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (—Å—Ç—Ä–æ–∫–∞ 367)
3. ‚ùå **–ù–û `stop_listening()` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** - –Ω–µ—Ç –ª–æ–≥–∞ "üé§ –í—ã–∑–æ–≤ stop_listening"
4. ‚ùå **–ê—É–¥–∏–æ callback –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** - –ª–æ–≥–∏ `üîä AUDIO callback: chunks=...` –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –∏–¥—Ç–∏

## –ü—Ä–∏—á–∏–Ω–∞
–í `_on_recording_stop` –∫–æ–¥ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –≤—ã–∑–æ–≤–∞ `stop_listening()` –∏–∑-–∑–∞:
1. –í–æ–∑–º–æ–∂–Ω–æ, `self.config.simulate == True` - —Ç–æ–≥–¥–∞ `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. –í–æ–∑–º–æ–∂–Ω–æ, `self._recognizer is None` - —Ç–æ–≥–¥–∞ `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. –í–æ–∑–º–æ–∂–Ω–æ, `active_session_id != session_id` - —Ç–æ–≥–¥–∞ –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ

–ù–æ –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç —ç—Ç–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–ª—É–±–∂–µ.

## –†–µ—à–µ–Ω–∏–µ

### 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –ü–ï–†–ï–î request_close
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py:505-525`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞ (`_current_stream.active`) –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º `request_close`
- –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω, –æ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ª–∏–ø–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –¥–∞–∂–µ –µ—Å–ª–∏ `state_manager` —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ `_on_recording_stop`
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py:428-443`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ –≤ –º–µ—Ç–æ–¥ (`üõë VOICE: _on_recording_stop –í–•–û–î`)
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è `session_id` –∏ –µ–≥–æ —Ç–∏–ø
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è `active_session_id` –∏ –µ–≥–æ —Ç–∏–ø
- –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, –¥–æ—Ö–æ–¥–∏—Ç –ª–∏ –∫–æ–¥ –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ session_id

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ session_id
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py:477-500`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±–æ–∏—Ö session_id –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- **–ö–†–ò–¢–ò–ß–ù–û:** –î–∞–∂–µ –ø—Ä–∏ session mismatch –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω

### 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ü–ï–†–ï–î stop_listening()
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py:500-514`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º `stop_listening()`
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ callback –ø–æ—Å–ª–µ `voice.recording_stop`
- –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### 4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_audio_callback`
**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py:1693-1707`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –ò–∑–º–µ–Ω–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å `debug` –Ω–∞ `warning` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ callback

### 5. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –¥–ª—è stop_listening
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py:493-498`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è `simulate` –∏ –Ω–∞–ª–∏—á–∏–µ `_recognizer`
- –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ `voice.recording_stop` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
2. ‚úÖ `_on_recording_stop` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. ‚úÖ **–ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ü–ï–†–ï–î `stop_listening()`**
4. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –ø–æ—á–µ–º—É `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–µ—Å–ª–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)**
5. ‚úÖ `stop_listening()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã)
6. ‚úÖ –ê—É–¥–∏–æ callback –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:
1. ‚úÖ `üõë VOICE: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ü–ï–†–ï–î stop_listening`
2. ‚úÖ `‚úÖ VOICE: –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ`
3. ‚úÖ `üîç VOICE: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è stop_listening: simulate=..., recognizer=...`
4. ‚úÖ `üé§ –í—ã–∑–æ–≤ stop_listening –¥–ª—è session ...`
5. ‚úÖ **–ù–ï–¢** `üîä AUDIO callback: chunks=...` –ø–æ—Å–ª–µ `voice.recording_stop`

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ù–∞–∂–∞—Ç—å –∏ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å Ctrl+N (LONG_PRESS)
2. –î–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
3. –û—Ç–ø—É—Å—Ç–∏—Ç—å Ctrl+N (RELEASE)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞—É–¥–∏–æ callback –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ—Ç–æ–∫–∞

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É `stop_listening()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç)
3. –ï—Å–ª–∏ `simulate=True` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É —Å–∏–º—É–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞
4. –ï—Å–ª–∏ `_recognizer is None` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É recognizer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

