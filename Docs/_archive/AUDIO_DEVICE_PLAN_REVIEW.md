# –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

## –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
2025-01-XX

## –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞–Ω –∏–∑ `AUDIO_DEVICE_AUTO_PLAN.md` –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π
2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
3. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º

---

## 1. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### 1.1 –ö—ç—à –∏–º–µ–Ω–∏‚ÜíID

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –î–æ–±–∞–≤–∏—Ç—å TTL –∏ —Ä—É—á–Ω—É—é –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é (`_invalidate_device_cache()`) –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default
- –ü—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ `SwitchAudioSource` –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ `sd.query_devices()` —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (0.3 —Å, 0.6 —Å, 1.2 —Å)
- –•—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∞ –æ —Ç–æ–º, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –∫—ç—à

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**
```python
# modules/voice_recognition/core/speech_recognizer.py
self._device_name_to_id_cache: Dict[str, int] = {}  # ‚úÖ –ï–°–¢–¨
self._device_cache_valid: bool = False  # ‚úÖ –ï–°–¢–¨ (–Ω–æ –Ω–µ TTL, –∞ boolean)

def _invalidate_device_cache(self):  # ‚úÖ –ï–°–¢–¨
    self._device_cache_valid = False

def _refresh_device_cache(self):  # ‚úÖ –ï–°–¢–¨
    # –û–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à, –Ω–æ –ë–ï–ó TTL
    self._device_name_to_id_cache.clear()
    # ... –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—ç—à–∞
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞**: –ö—ç—à —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–ª—É—á—à–∏—Ç—å –µ–≥–æ
- ‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: `_invalidate_device_cache()` —É–∂–µ –µ—Å—Ç—å, –Ω–æ –±–µ–∑ TTL
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ TTL –ª–æ–≥–∏—á–Ω–æ –∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å TTL –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫—ç—à—É (–Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π)
- –†–∞—Å—à–∏—Ä–∏—Ç—å `_invalidate_device_cache()` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ TTL
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

### 1.2 –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –ü—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ `SwitchAudioSource` –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ `sd.query_devices()` —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (0.3 —Å, 0.6 —Å, 1.2 —Å)

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**
```python
# modules/voice_recognition/core/speech_recognizer.py
def _find_device_id_by_name_input(self, device_name: str) -> Optional[int]:
    # –ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ
    if target_name in self._device_name_to_id_cache:
        return self._device_name_to_id_cache[target_name]
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
    self._refresh_device_cache()
    if target_name in self._device_name_to_id_cache:
        return self._device_name_to_id_cache[target_name]
    
    return None  # ‚ùå –ù–ï–¢ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞**: –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –∏–º–µ–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É race condition —Å BT
- ‚ö†Ô∏è **–ú–µ—Å—Ç–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è**: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `_find_device_id_by_name_input()` –∏ `_get_device_via_macos_api()`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –≤ `_find_device_id_by_name_input()`
- –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤ `AudioDeviceMonitor._get_device_via_macos_api()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω retry (–∫–∞–∫ –≤ `_run_listening()`)

---

### 1.3 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –í `AudioDeviceMonitor` –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ ID –ø—Ä–∏ `SwitchAudioSource` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è, –Ω–æ `sd.query_devices()` –Ω–µ –Ω–∞–π–¥—ë—Ç –µ–≥–æ —Å—Ä–∞–∑—É
- –ü–æ —Å–º–µ–Ω–µ –∏–º–µ–Ω–∏ ‚Äî —Å—Ä–∞–∑—É –ø–æ–º–µ—á–∞—Ç—å –∫—ç—à –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º –∏ –æ—Ç–∫–ª—é—á–∞—Ç—å/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**
```python
# modules/voice_recognition/core/audio_device_monitor.py
def _get_device_via_macos_api(self) -> tuple[Optional[str], Optional[Any]]:
    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —á–µ—Ä–µ–∑ SwitchAudioSource
    device_name = device_info.get('name', '')
    if device_name:
        # –ò—â–µ–º ID –ø–æ –∏–º–µ–Ω–∏ –≤ PortAudio
        all_devices = sd.query_devices()
        for idx, dev in enumerate(all_devices):
            if dev.get('name', '') == device_name:
                return device_name, idx
        # ‚ùå –ù–ï–¢ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    return None, None

def _monitor_loop(self):
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏
    if new_device_name != self.current_input_device_name:
        # ‚úÖ –ï–°–¢–¨ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
        # ‚ùå –ù–ï–¢ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞**: –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –∏–º–µ–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- ‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ —É–∂–µ –µ—Å—Ç—å –≤ `_on_device_changed()`
- ‚ö†Ô∏è **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**: –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞, –Ω–æ —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ **–ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (—Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–¥–µ: "‚ùå –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!")

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤ `_get_device_via_macos_api()`
- ‚ö†Ô∏è **–û–°–¢–û–†–û–ñ–ù–û**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–∞–º —Ä–µ—à–∏—Ç—å, –∫–æ–≥–¥–∞ –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å)
- üí° **–ö–æ–º–ø—Ä–æ–º–∏—Å—Å**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç (state != LISTENING)

---

### 1.4 –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –ü—Ä–∏ —Å–º–µ–Ω–µ default input/output –≤—ã–∑—ã–≤–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é ¬´invalidate + recreate stream¬ª, –∫–æ—Ç–æ—Ä–∞—è:
  * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π UUID/–∏–º—è
  * –≤—ã–∑—ã–≤–∞–µ—Ç `_stop_audio_stream`/`_current_stream.stop()` —Å `RLock`
  * –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ `DeviceParamsNormalizer`
  * –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π `bt_prestart_delay` –¥–ª—è BT
- –í—ã–∑—ã–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ `_on_device_changed` –∏ `_check_and_update_output_device`

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**

**INPUT (SpeechRecognizer):**
```python
def _on_device_changed(self, old_device_id, new_device_id):
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
    self._invalidate_device_cache()
    
    # –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    if new_device_name != old_device_name:
        if self.state == RecognitionState.LISTENING:
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
            self._graceful_stop_listening(reason="device_changed")
            # ‚ùå –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
        else:
            # –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
            logger.info(f"–°–∏—Å—Ç–µ–º–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞: \"{new_device_name}\"")
```

**OUTPUT (SequentialSpeechPlayer):**
```python
def _check_and_update_output_device(self) -> bool:
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if current_device_name != old_device_name:
        return True  # –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

def play_audio(self, audio_data, session_id):
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    device_changed = self._check_and_update_output_device()
    if device_changed:
        # ‚úÖ –ï–°–¢–¨ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
        if self._audio_stream is not None:
            self._stop_audio_stream()
        current_device = self._query_default_output_device()
        device_id = current_device.get('index') if current_device else None
        self._start_audio_stream(device_id=device_id)
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚ö†Ô∏è **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**: –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –¥–ª—è INPUT, –Ω–æ —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ **—è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç** —ç—Ç–æ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "‚ùå –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!")
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –¥–ª—è OUTPUT**: OUTPUT —É–∂–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –ø–æ—Ç–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: OUTPUT —É–∂–µ –∏–º–µ–µ—Ç –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è, –Ω–æ –Ω–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ **OUTPUT**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
- ‚ö†Ô∏è **INPUT**: **–ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
- üí° **–ö–æ–º–ø—Ä–æ–º–∏—Å—Å**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç (state != LISTENING)

---

### 1.5 Retries –∏ backoff

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –î–ª—è BT-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–º–µ—Ç—å 5‚Äì7 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞ —Å —Ä–æ—Å—Ç–æ–º –∑–∞–¥–µ—Ä–∂–∫–∏ (0.8 —Å ‚Üí 1.2 —Å ‚Üí 1.8 —Å)
- –ó–∞–ø—É—Å–∫ –≤ –æ–±–µ–∏—Ö –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞—Ö (–≤—Ö–æ–¥ –∏ –≤—ã–≤–æ–¥) –¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –∏ –ø—Ä–∏—á–∏–Ω—É (`Error 89`, `Error 35` –∏ —Ç.–¥.)

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**

**INPUT (SpeechRecognizer):**
```python
self.max_stream_start_retries = 7  # ‚úÖ –ï–°–¢–¨ (—É–∂–µ 7 –ø–æ–ø—ã—Ç–æ–∫)
self.bt_prestart_delay = 0.5  # ‚úÖ –ï–°–¢–¨ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è BT

for attempt in range(self.max_stream_start_retries):
    try:
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
        if self._is_bluetooth_device(device_info.get('name', '')):
            time.sleep(self.bt_prestart_delay)  # ‚úÖ –ï–°–¢–¨ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è BT
        stream.start()
        # ...
    except (sd.PortAudioError, TimeoutError) as e:
        # ‚úÖ –ï–°–¢–¨ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Error 89
        is_error_89 = "Error -9986" in error_msg or "Hardware" in error_msg
        if is_error_89 and self._is_bluetooth_device(...):
            current_retry_delay = retry_delay * 1.5  # ‚úÖ –ï–°–¢–¨ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏
        time.sleep(current_retry_delay)
```

**OUTPUT (SequentialSpeechPlayer):**
```python
max_retries = 3  # ‚ùå –¢–û–õ–¨–ö–û 3 –ø–æ–ø—ã—Ç–∫–∏ (–º–µ–Ω—å—à–µ —á–µ–º –≤ –ø–ª–∞–Ω–µ)
retry_delay = 0.3  # ‚ùå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–Ω–µ —Ä–∞—Å—Ç—ë—Ç)

for attempt in range(max_retries):
    try:
        self._audio_stream = sd.OutputStream(**stream_config)
        # ...
    except Exception as e:
        if attempt < max_retries - 1:
            time.sleep(retry_delay)  # ‚ùå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **INPUT**: –£–∂–µ –∏–º–µ–µ—Ç 7 –ø–æ–ø—ã—Ç–æ–∫ –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è BT (–Ω–æ –Ω–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç)
- ‚ùå **OUTPUT**: –ò–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ 3 –ø–æ–ø—ã—Ç–∫–∏ –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É
- ‚ö†Ô∏è **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç 5‚Äì7 –ø–æ–ø—ã—Ç–æ–∫, –Ω–æ INPUT —É–∂–µ –∏–º–µ–µ—Ç 7, –∞ OUTPUT —Ç–æ–ª—å–∫–æ 3
- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –û–±–∞ –∏–º–µ—é—Ç retry –ª–æ–≥–∏–∫—É, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ **INPUT**: –£–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É (–¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç –∑–∞–¥–µ—Ä–∂–∫–∏)
- ‚úÖ **OUTPUT**: –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5‚Äì7 –ø–æ–ø—ã—Ç–æ–∫ –∏ –¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
- ‚úÖ **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è**: –°–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff

---

## 2. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 2.1 –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π INPUT

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –Ω–æ —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ **—è–≤–Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç** —ç—Ç–æ –¥–ª—è INPUT:

```python
# modules/voice_recognition/core/speech_recognizer.py:239
# ‚ùå –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–∞–º —Ä–µ—à–∏—Ç—å, –∫–æ–≥–¥–∞ –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å **–ù–ï –∏–¥—ë—Ç** (state != LISTENING)
- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–∞–º —Ä–µ—à–∏—Ç—å)

---

### 2.2 –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç 5‚Äì7 –ø–æ–ø—ã—Ç–æ–∫
- INPUT —É–∂–µ –∏–º–µ–µ—Ç 7 –ø–æ–ø—ã—Ç–æ–∫
- OUTPUT –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ 3 –ø–æ–ø—ã—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å: 5‚Äì7 –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –æ–±–æ–∏—Ö (INPUT —É–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç, OUTPUT –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å)

---

### 2.3 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff (0.8 —Å ‚Üí 1.2 —Å ‚Üí 1.8 —Å)
- INPUT –∏–º–µ–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞ 50% –¥–ª—è BT (–Ω–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π)
- OUTPUT –∏–º–µ–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É 0.3 —Å

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è –æ–±–æ–∏—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É: `delay = base_delay * (multiplier ** attempt)`

---

### 2.4 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ retry –ª–æ–≥–∏–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- INPUT –∏ OUTPUT –∏–º–µ—é—Ç —Ä–∞–∑–Ω—É—é retry –ª–æ–≥–∏–∫—É
- –ù–µ—Ç –æ–±—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `retry_with_exponential_backoff()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö

---

## 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 3.1 –§–∞–∑–∞ 1: –£–ª—É—á—à–µ–Ω–∏–µ –∫—ç—à–∞ (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å TTL –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É `_device_name_to_id_cache`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
3. ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å `_invalidate_device_cache()` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ TTL

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫—ç—à (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)

---

### 3.2 –§–∞–∑–∞ 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –≤ `_find_device_id_by_name_input()`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤ `AudioDeviceMonitor._get_device_via_macos_api()`
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏: 0.3 —Å, 0.6 —Å, 1.2 —Å (–∫–∞–∫ –≤ –ø–ª–∞–Ω–µ)

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- ‚ùå –ù–µ –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å retry)

---

### 3.3 –§–∞–∑–∞ 3: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è retry –ª–æ–≥–∏–∫–∏ (—á–∞—Å—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `retry_with_exponential_backoff()`
2. ‚úÖ –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–ø—ã—Ç–∫–∏ OUTPUT –¥–æ 5‚Äì7 (–∫–∞–∫ INPUT)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è OUTPUT
4. ‚úÖ –£–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π backoff –¥–ª—è INPUT (—Å–¥–µ–ª–∞—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º)

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- ‚ùå –ù–µ —É–º–µ–Ω—å—à–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è INPUT (—É–∂–µ 7, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–ª–∞–Ω—É)

---

### 3.4 –§–∞–∑–∞ 4: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ (–∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. ‚úÖ **OUTPUT**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
2. ‚ö†Ô∏è **INPUT**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ **–¢–û–õ–¨–ö–û** –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç (state != LISTENING)
3. ‚ùå **INPUT**: –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- ‚ùå –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –¥–ª—è INPUT, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç
- ‚ùå –ù–µ –º–µ–Ω—è—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

---

## 4. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### 4.1 –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã

| –≠–ª–µ–º–µ–Ω—Ç –ø–ª–∞–Ω–∞ | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –£—Ä–æ–≤–µ–Ω—å | –†–µ—à–µ–Ω–∏–µ |
|---------------|----------|---------|---------|
| TTL –¥–ª—è –∫—ç—à–∞ | –ù–µ—Ç | - | –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫—ç—à—É |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ | –ù–µ—Ç | - | –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff |
| –ê–≤—Ç–æ–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ INPUT –ø–æ—Ç–æ–∫–∞ | **–ï–°–¢–¨** | **–í–´–°–û–ö–ò–ô** | –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç |
| –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è retry | –ù–µ—Ç | - | –°–æ–∑–¥–∞—Ç—å –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é |
| –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ OUTPUT | –ù–µ—Ç | - | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5‚Äì7 |

### 4.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

| –≠–ª–µ–º–µ–Ω—Ç –ø–ª–∞–Ω–∞ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | –£—Ä–æ–≤–µ–Ω—å | –†–µ—à–µ–Ω–∏–µ |
|---------------|--------------|---------|---------|
| –ö—ç—à –∏–º–µ–Ω–∏‚ÜíID | –ß–∞—Å—Ç–∏—á–Ω–æ–µ | –ù–∏–∑–∫–∏–π | –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π |
| –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ | –ü–æ–ª–Ω–æ–µ | –ù–∏–∑–∫–∏–π | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π |
| Retry –ª–æ–≥–∏–∫–∞ | –ü–æ–ª–Ω–æ–µ | –°—Ä–µ–¥–Ω–∏–π | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é |
| –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ OUTPUT –ø–æ—Ç–æ–∫–∞ | –ü–æ–ª–Ω–æ–µ | –ù–∏–∑–∫–∏–π | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é |

### 4.3 –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

- ‚úÖ **–ö—ç—à**: –ü–ª–∞–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- ‚úÖ **Retry**: –ü–ª–∞–Ω —É–ª—É—á—à–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
- ‚ö†Ô∏è **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ INPUT**: –ü–ª–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º (–Ω—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è)
- ‚úÖ **OUTPUT**: –ü–ª–∞–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–µ

---

## 5. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ö—ç—à —Å TTL (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
1. –î–æ–±–∞–≤–∏—Ç—å TTL –∫ `_device_name_to_id_cache`
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
3. –†–∞—Å—à–∏—Ä–∏—Ç—å `_invalidate_device_cache()` –¥–ª—è TTL

### –§–∞–∑–∞ 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
1. –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –≤ `_find_device_id_by_name_input()`
2. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤ `AudioDeviceMonitor._get_device_via_macos_api()`

### –§–∞–∑–∞ 3: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è retry (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
1. –°–æ–∑–¥–∞—Ç—å `retry_with_exponential_backoff()`
2. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–ø—ã—Ç–∫–∏ OUTPUT –¥–æ 5‚Äì7
3. –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è –æ–±–æ–∏—Ö

### –§–∞–∑–∞ 4: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ (—Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π)
1. **OUTPUT**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
2. **INPUT**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ **–¢–û–õ–¨–ö–û** –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

---

## 6. –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –ø–ª–∞–Ω–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

### 6.1 –ü—Ä–æ—Ç–æ—Ç–∏–ø–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–§–∞–∑–∞ 1, –ø—É–Ω–∫—Ç 3)

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π prototype-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π –ª–æ–≥–∏–∫–∏ (–∫—ç—à, retry, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—á–∞—Å—Ç–æ—Ç–∞, –∫–∞–Ω–∞–ª—ã, ID) –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç

**‚ö†Ô∏è –í–ê–ñ–ù–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:**
> –°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –≥–¥–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å **—Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–¥–µ–∞–ª—å–Ω–æ** (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π), –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏.

**–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
test_audio_output/
‚îú‚îÄ‚îÄ test_realtime_monitoring.py
‚îú‚îÄ‚îÄ test_with_realtime_monitoring.py
‚îú‚îÄ‚îÄ test_enhanced_monitoring.py
‚îú‚îÄ‚îÄ test_device_switching.py
‚îú‚îÄ‚îÄ test_device_switching_normalized.py
‚îú‚îÄ‚îÄ core_audio_monitor.py
‚îú‚îÄ‚îÄ system_default_helper.py
‚îú‚îÄ‚îÄ device_params_normalizer.py
‚îî‚îÄ‚îÄ ... (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤)
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞**: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `test_audio_output/` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ**: –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω - —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å **–ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã**, –∞ –Ω–µ —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ, –∑–∞—Ç–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

**–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1. **–≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∫–æ–ø–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `test_audio_output/prototype/current_system/`
   - ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏:
     * `speech_recognizer.py` (INPUT –ª–æ–≥–∏–∫–∞)
     * `player.py` (OUTPUT –ª–æ–≥–∏–∫–∞)
     * `audio_device_monitor.py` (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
     * `device_params_normalizer.py` (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)
   - ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
   - ‚úÖ **–¶–µ–ª—å**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ

2. **–≠—Ç–∞–ø 2: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
     * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤
     * –°–º–µ–Ω–∞ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤
     * –†–∞–±–æ—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ, USB, BT)
   - ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è
   - ‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å baseline –ø–æ–≤–µ–¥–µ–Ω–∏–µ

3. **–≠—Ç–∞–ø 3: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏**
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `test_audio_output/prototype/improvements/`
   - ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —É–ª—É—á—à–µ–Ω–∏—è:
     * TTL –¥–ª—è –∫—ç—à–∞
     * –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
     * –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
   - ‚úÖ –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å baseline –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**
```
test_audio_output/prototype/
‚îú‚îÄ‚îÄ current_system/              # –≠—Ç–∞–ø 1: –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ speech_recognizer.py
‚îÇ   ‚îú‚îÄ‚îÄ player.py
‚îÇ   ‚îú‚îÄ‚îÄ audio_device_monitor.py
‚îÇ   ‚îú‚îÄ‚îÄ device_params_normalizer.py
‚îÇ   ‚îú‚îÄ‚îÄ test_current_system.py
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ improvements/                # –≠—Ç–∞–ø 3: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ cache_with_ttl.py
‚îÇ   ‚îú‚îÄ‚îÄ retry_with_backoff.py
‚îÇ   ‚îú‚îÄ‚îÄ enhanced_monitoring.py
‚îÇ   ‚îú‚îÄ‚îÄ test_improvements.py
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ README.md                    # –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞
```

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**
- –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º** –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∏—Ç—å—Å—è –∏–¥–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
- –ö–∞–∂–¥–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å baseline

---

### 6.2 "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä" —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç (–§–∞–∑–∞ 4, –ø—É–Ω–∫—Ç 9)

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:**
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å ¬´–ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä¬ª —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—á–∞—Å—Ç–æ—Ç–∞, ID, –∫–∞–Ω–∞–ª—ã)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –ø–æ—Ç–æ–∫–∏

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**
```python
# test_audio_output/test_realtime_monitoring.py (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
# test_audio_output/test_with_realtime_monitoring.py (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
# test_audio_output/test_enhanced_monitoring.py (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞**: –§–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–º–∏
- ‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –£–∂–µ –µ—Å—Ç—å —Ñ–∞–π–ª—ã —Å –ø–æ—Ö–æ–∂–∏–º–∏ –∏–º–µ–Ω–∞–º–∏
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã, ID, –∫–∞–Ω–∞–ª–æ–≤ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `test_realtime_monitoring.py` –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `test_live_device_monitoring.py`
- ‚úÖ –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω:
  - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 0.5-1 —Å–µ–∫) –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–µ–∫—É—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ SwitchAudioSource
  - –ü–æ–ª—É—á–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–º—è, ID, —á–∞—Å—Ç–æ—Ç–∞, –∫–∞–Ω–∞–ª—ã) —á–µ—Ä–µ–∑ PortAudio
  - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - –í—ã–≤–æ–¥–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π, —É—Å–ø–µ—à–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Ç–æ–∫–æ–≤)

---

## 7. –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–ª–∞–Ω–∞

### 7.1 –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

| –≠–ª–µ–º–µ–Ω—Ç –ø–ª–∞–Ω–∞ | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | –£—Ä–æ–≤–µ–Ω—å | –†–µ—à–µ–Ω–∏–µ |
|---------------|----------|--------------|---------|---------|
| –ü—Ä–æ—Ç–æ—Ç–∏–ø–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è | –ù–µ—Ç | –ß–∞—Å—Ç–∏—á–Ω–æ–µ | –ù–∏–∑–∫–∏–π | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `test_audio_output/prototype/` |
| "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä" —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç | –ù–µ—Ç | –ß–∞—Å—Ç–∏—á–Ω–æ–µ | –ù–∏–∑–∫–∏–π | –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π |

### 7.2 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ—Ç–æ—Ç–∏–ø–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–°–ö–û–†–†–ï–ö–¢–ò–†–û–í–ê–ù–û):**
1. ‚úÖ **–≠—Ç–∞–ø 1**: –°–æ–∑–¥–∞—Ç—å `test_audio_output/prototype/current_system/` —Å **–ø–æ–ª–Ω–æ–π –∫–æ–ø–∏–µ–π —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã**
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
   - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
   - **–¶–µ–ª—å**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ

2. ‚úÖ **–≠—Ç–∞–ø 2**: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å baseline –ø–æ–≤–µ–¥–µ–Ω–∏–µ
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è

3. ‚úÖ **–≠—Ç–∞–ø 3**: –°–æ–∑–¥–∞—Ç—å `test_audio_output/prototype/improvements/` –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
   - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —É–ª—É—á—à–µ–Ω–∏—è (TTL, backoff, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
   - –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å baseline –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º

4. ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   ```
   prototype/
   ‚îú‚îÄ‚îÄ current_system/          # –≠—Ç–∞–ø 1: –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   ‚îÇ   ‚îú‚îÄ‚îÄ speech_recognizer.py
   ‚îÇ   ‚îú‚îÄ‚îÄ player.py
   ‚îÇ   ‚îú‚îÄ‚îÄ audio_device_monitor.py
   ‚îÇ   ‚îú‚îÄ‚îÄ device_params_normalizer.py
   ‚îÇ   ‚îú‚îÄ‚îÄ test_current_system.py
   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
   ‚îú‚îÄ‚îÄ improvements/            # –≠—Ç–∞–ø 3: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
   ‚îÇ   ‚îú‚îÄ‚îÄ cache_with_ttl.py
   ‚îÇ   ‚îú‚îÄ‚îÄ retry_with_backoff.py
   ‚îÇ   ‚îú‚îÄ‚îÄ enhanced_monitoring.py
   ‚îÇ   ‚îú‚îÄ‚îÄ test_improvements.py
   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
   ‚îî‚îÄ‚îÄ README.md               # –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
   ```

5. ‚úÖ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ**: –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º** –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

**"–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä" —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `test_audio_output/test_live_device_monitoring.py`
2. ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–∏–º—è, ID, —á–∞—Å—Ç–æ—Ç–∞, –∫–∞–Ω–∞–ª—ã)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
3. ‚úÖ –ó–∞–ø—É—Å–∫: `python test_audio_output/test_live_device_monitoring.py`

---

## 8. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚úÖ **–ü–ª–∞–Ω –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–∏–π**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –¥–ª—è INPUT

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã:**
1. ‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ INPUT –ø–æ—Ç–æ–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
2. ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–ª–∞–Ω–∞ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –∏ —É–ª—É—á—à–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
3. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (–≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)
4. ‚úÖ **–ù–æ–≤—ã–µ –ø—É–Ω–∫—Ç—ã** (–ø—Ä–æ—Ç–æ—Ç–∏–ø –∏ "–ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä") —Ö–æ—Ä–æ—à–æ –≤–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚úÖ **–ü—Ä–∏–Ω—è—Ç—å –ø–ª–∞–Ω —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π** –¥–ª—è INPUT (–ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ù–ï –∏–¥—ë—Ç)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é `test_audio_output/` –∫–∞–∫ –æ—Å–Ω–æ–≤—É
- ‚úÖ **–í–ê–ñ–ù–û**: –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å `prototype/current_system/` —Å –ø–æ–ª–Ω–æ–π –∫–æ–ø–∏–µ–π —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ
- ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å `prototype/improvements/` –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
- ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç –¥–ª—è "–ø—Ä—è–º–æ–≥–æ —ç—Ñ–∏—Ä–∞" –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**
1. **–§–∞–∑–∞ 1.1**: –°–æ–∑–¥–∞—Ç—å `prototype/current_system/` —Å —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π
2. **–§–∞–∑–∞ 1.2**: –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã (baseline)
3. **–§–∞–∑–∞ 1.3**: –°–æ–∑–¥–∞—Ç—å `prototype/improvements/` –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
4. **–§–∞–∑–∞ 2+**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

