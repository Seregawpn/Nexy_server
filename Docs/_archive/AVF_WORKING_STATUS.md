# ‚úÖ AVF –ê—É–¥–∏–æ—Å–∏—Å—Ç–µ–º–∞ - –†–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

## üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! (4/4)

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioSystemIntegration** ‚Äî –ü–†–û–ô–î–ï–ù ‚úÖ
   - AVFAudioEngine —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - Player node —Å–æ–∑–¥–∞—ë—Ç—Å—è
   - Event bus –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è
   - Completion callback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

2. **–ü–µ—Ä–µ–¥–∞—á–∞ AVFAudioEngine –≤ SpeechPlaybackIntegration** ‚Äî –ü–†–û–ô–î–ï–ù ‚úÖ
   - AVFAudioEngine –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä)
   - `_use_avf = True` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - SpeechPlaybackIntegration –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

3. **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö playback.raw_audio ‚Üí AVFAudioEngine** ‚Äî –ü–†–û–ô–î–ï–ù ‚úÖ
   - –°–æ–±—ã—Ç–∏–µ `playback.raw_audio` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
   - –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AVFAudioEngine
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
   - –°–æ–±—ã—Ç–∏–µ `playback.completed` –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ fallback —Ç–∞–π–º–µ—Ä

4. **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è** ‚Äî –ü–†–û–ô–î–ï–ù ‚úÖ
   - –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ
   - –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤–æ–≤—Ä–µ–º—è

---

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è

**–û—à–∏–±–∫–∞**: `audio_data is None` –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `_on_raw_audio`

**–ü—Ä–∏—á–∏–Ω–∞**: 
- EventBus –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `{'type': 'event', 'data': {...}, 'timestamp': ...}`
- –í —Ç–µ—Å—Ç–µ –º—ã –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ `{"data": {...}}`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –¥–≤–æ–π–Ω–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
- –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ `event['data'] = {"data": {...}}` –≤–º–µ—Å—Ç–æ `event['data'] = {...}`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```python
# ‚ùå –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
await event_bus.publish("playback.raw_audio", {
    "data": {
        "audio_data": audio_data,
        ...
    }
})

# ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
await event_bus.publish("playback.raw_audio", {
    "audio_data": audio_data,  # –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—ë—Ä—Ç–∫–∏ –≤ "data"
    "sample_rate": sample_rate,
    ...
})
```

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
   - ‚úÖ AudioSystemIntegration ‚Üí AVFAudioEngine
   - ‚úÖ SpeechPlaybackIntegration –ø–æ–ª—É—á–∞–µ—Ç AVFAudioEngine
   - ‚úÖ Completion callback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

2. **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - ‚úÖ –°–æ–±—ã—Ç–∏–µ `playback.raw_audio` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
   - ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AVFAudioEngine
   - ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è

3. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**:
   - ‚úÖ Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   - ‚úÖ –°–æ–±—ã—Ç–∏–µ `audio.playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
   - ‚úÖ –°–æ–±—ã—Ç–∏–µ `playback.completed` —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤**: 4
- **–ü—Ä–æ–π–¥–µ–Ω–æ**: 4 ‚úÖ
- **–ü—Ä–æ–≤–∞–ª–µ–Ω–æ**: 0 ‚ùå
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å**: 100%

---

## üéØ –í—ã–≤–æ–¥—ã

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚úÖ
   - –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
   - AVFAudioEngine –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚úÖ
   - –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
   - –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AVFAudioEngine
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è

3. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚úÖ
   - Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ
   - –°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤–æ–≤—Ä–µ–º—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ê—É–¥–∏–æ—Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ.

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Completion callback**: Python —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, PyObjC –º–æ–∂–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ç–∞–π–º–µ—Ä.

2. **Fallback —Ç–∞–π–º–µ—Ä**: –Ø–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥—ë–∂–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ native callback –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

3. **–§–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏–π**: EventBus –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `{'type': 'event', 'data': {...}, 'timestamp': ...}`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –æ–±—ë—Ä—Ç–∫—É –≤ "data".


