# –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: LLM JSON/legacy-—Ä–µ–∂–∏–º/streaming

## –î–∞—Ç–∞: 2025-12-28

---

## ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

### 1. ‚úÖ sentence_audio_map –¥–ª—è close_app –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è command-confirmation –≤—ã—Å—Ç–∞–≤–ª—è–ª—Å—è `sentence_audio_map[emitted_segment_counter] = 1`, —á—Ç–æ —Ç–µ—Ä—è–ª–æ —Ä–µ–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `segment_audio_chunks` –¥–ª—è command confirmation
- `sentence_audio_map[emitted_segment_counter] = segment_audio_chunks` (—Ä–µ–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤)

**–§–∞–π–ª:** `server/server/integrations/workflow_integrations/streaming_workflow_integration.py` (lines 245-275)

---

### 2. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ should_emit –±–ª–æ–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Å—Ç–∞–ª–∏—Å—å `logger.info` —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ –±–ª–æ–∫–µ `should_emit`, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ —Ä–∏—Å–∫ –ª–æ–≥-—à—É–º–∞ –∏ PII.

**–†–µ—à–µ–Ω–∏–µ:**
- –í—Å–µ `logger.info` –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤ `logger.debug`
- –£–±—Ä–∞–Ω–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—Å—Ç–∞, –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω—ã
- –ü—Ä–∏–º–µ—Ä—ã:
  - `logger.info(f"   ‚Üí should_emit={should_emit}")` ‚Üí `logger.debug(f"   ‚Üí should_emit={should_emit}")`
  - `logger.info(f"‚úÖ –í–•–û–î –í –ë–õ–û–ö –≠–ú–ò–°–°–ò–ò: candidate='{candidate[:50]}...'")` ‚Üí `logger.debug(f"‚úÖ –í–•–û–î –í –ë–õ–û–ö –≠–ú–ò–°–°–ò–ò: {len(candidate)} —Å–∏–º–≤–æ–ª–æ–≤")`
  - `logger.info(f"   ‚Üí to_emit: len={len(to_emit)}, content='{to_emit[:50]}...'")` ‚Üí `logger.debug(f"   ‚Üí to_emit: {len(to_emit)} —Å–∏–º–≤–æ–ª–æ–≤")`

**–§–∞–π–ª:** `server/server/integrations/workflow_integrations/streaming_workflow_integration.py` (lines 301, 303, 306)

---

### 3. ‚úÖ –õ–∏–º–∏—Ç –±—É—Ñ–µ—Ä–∞ JSON –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ—Ç–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Å–Ω–æ–≤–Ω–æ–π `_json_buffer` (–¥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞) –º–æ–≥ —Ä–∞—Å—Ç–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –µ—Å–ª–∏ LLM –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ —Ä–∏—Å–∫ –ø–∞–º—è—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞: `MAX_JSON_BUFFER_SIZE = 10000` (10KB)
- –î–æ–±–∞–≤–ª–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞: `MAX_JSON_PARSE_ATTEMPTS = 10`
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ - —Å–±—Ä–æ—Å –±—É—Ñ–µ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫ - —Å–±—Ä–æ—Å –±—É—Ñ–µ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
- –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ

**–§–∞–π–ª:** `server/server/integrations/workflow_integrations/streaming_workflow_integration.py` (lines 159-239)

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ |
|----------|-----------|--------|------|--------|
| sentence_audio_map –¥–ª—è command confirmation | –ö—Ä–∏—Ç–∏—á–Ω–æ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 245-275 |
| logger.info –≤ should_emit | –í–∞–∂–Ω–æ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 301, 303, 306 |
| –õ–∏–º–∏—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ JSON –±—É—Ñ–µ—Ä–∞ | –í–∞–∂–Ω–æ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 159-239 |
| JSON –±—É—Ñ–µ—Ä –≤ legacy —Ä–µ–∂–∏–º–µ | High | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 596-634 |
| dict‚ÜíJSON –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π | Medium | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 762 |
| –ê—É–¥–∏–æ latency | Medium | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | 887-933 |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ç–µ—á–∫–∞ | Low | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | streaming_workflow_integration.py | –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `test_close_app_full_e2e.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JSON –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `sentence_audio_map` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤ –¥–ª—è command confirmation
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π JSON –±—É—Ñ–µ—Ä –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ª–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ production

---

## üìù –í—ã–≤–æ–¥—ã

1. ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**
2. ‚úÖ **sentence_audio_map –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—á–∏—Ç–∞–µ—Ç —á–∞–Ω–∫–∏**
3. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ (debug, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞)**
4. ‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π JSON –±—É—Ñ–µ—Ä –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è**
5. ‚úÖ **Legacy —Ä–µ–∂–∏–º –∑–∞—â–∏—â–µ–Ω –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è**
6. ‚úÖ **–ê—É–¥–∏–æ —Å—Ç—Ä–∏–º–∏–Ω–≥ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**
