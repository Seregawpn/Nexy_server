# üîÑ –õ–æ–≥–∏–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤ –∞—É–¥–∏–æ

## üìã –ö–∞–∫ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–≥–∏–∫–∞

### 1. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏

**Callback `listen_in_background`** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ `speech_recognition` –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Ä—Ü–∏—é –∞—É–¥–∏–æ:

```python
def callback(recognizer, audio):
    """Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ –∏–∑ listen_in_background"""
    with self._google_audio_chunks_lock:
        self._google_audio_chunks.append(audio)  # –î–æ–±–∞–≤–ª—è–µ–º —á–∞–Ω–∫ –≤ —Å–ø–∏—Å–æ–∫
        chunks_count = len(self._google_audio_chunks)
    logger.info(f"üîç [Google] –ü–æ–ª—É—á–µ–Ω —á–∞–Ω–∫ –∞—É–¥–∏–æ #{chunks_count}: {len(raw_data)} bytes")
```

**–í–∞–∂–Ω–æ:**
- –ö–∞–∂–¥—ã–π —á–∞–Ω–∫ - —ç—Ç–æ –æ–±—ä–µ–∫—Ç `sr.AudioData` –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `speech_recognition`
- –ß–∞–Ω–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ `_google_audio_chunks`
- –î–æ—Å—Ç—É–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `_google_audio_chunks_lock` (thread-safe)

### 2. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏

–ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç `voice.recording_stop`, –Ω—É–∂–Ω–æ:
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `listen_in_background`
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö callback'–æ–≤
3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –≤ –æ–¥–∏–Ω `AudioData`
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ

## ‚úÖ –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)

### –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏

```python
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
self._google_stop_listening(wait_for_stop=False)

# –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö callback'–æ–≤
await asyncio.sleep(callback_wait)  # 0.5 —Å–µ–∫ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
```

### –®–∞–≥ 2: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤

```python
import speech_recognition as sr

with self._google_audio_chunks_lock:
    chunks_count = len(self._google_audio_chunks)
    
    if chunks_count == 0:
        # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –æ—à–∏–±–∫–∞
        self._google_audio_data = None
    elif chunks_count == 1:
        # –û–¥–∏–Ω —á–∞–Ω–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
        self._google_audio_data = self._google_audio_chunks[0]
    else:
        # –ù–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ - –æ–±—ä–µ–¥–∏–Ω—è–µ–º
        first_chunk = self._google_audio_chunks[0]
        
        # –ü–æ–ª—É—á–∞–µ–º raw –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —á–∞–Ω–∫–æ–≤
        all_raw_data = first_chunk.get_raw_data()
        for chunk in self._google_audio_chunks[1:]:
            all_raw_data += chunk.get_raw_data()
        
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π AudioData –∏–∑ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        sample_rate = first_chunk.sample_rate
        sample_width = first_chunk.sample_width
        self._google_audio_data = sr.AudioData(all_raw_data, sample_rate, sample_width)
```

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü–æ—á–µ–º—É –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `get_raw_data()`?

1. **`AudioData` –æ–±—ä–µ–∫—Ç—ã –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–∂–∏—Ç—å** - —ç—Ç–æ –Ω–µ —Å–ø–∏—Å–∫–∏
2. **`get_raw_data()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç bytes** - –º–æ–∂–Ω–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞—Ç—å
3. **–í—Å–µ —á–∞–Ω–∫–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç** - `sample_rate` –∏ `sample_width` –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ

### –ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞?

- –í—Å–µ —á–∞–Ω–∫–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `sample_rate` –∏ `sample_width` –æ–¥–∏–Ω–∞–∫–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö —á–∞–Ω–∫–æ–≤
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∑—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞

### Thread-safety

- –ò—Å–ø–æ–ª—å–∑—É–µ–º `_google_audio_chunks_lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- Callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —á–∏—Ç–∞–µ—Ç —á–∞–Ω–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–¥–∏–Ω —á–∞–Ω–∫ (–∫–æ—Ä–æ—Ç–∫–∞—è –∑–∞–ø–∏—Å—å)

```
1. Callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 1 —Ä–∞–∑
   ‚Üí _google_audio_chunks = [chunk1]
   
2. –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:
   ‚Üí chunks_count = 1
   ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ–º chunk1 –∫–∞–∫ –µ—Å—Ç—å
   ‚Üí self._google_audio_data = chunk1
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ—Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ (–¥–ª–∏–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å)

```
1. Callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 3 —Ä–∞–∑–∞:
   ‚Üí _google_audio_chunks = [chunk1, chunk2, chunk3]
   
2. –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:
   ‚Üí chunks_count = 3
   ‚Üí –û–±—ä–µ–¥–∏–Ω—è–µ–º:
     all_raw_data = chunk1.get_raw_data() + chunk2.get_raw_data() + chunk3.get_raw_data()
   ‚Üí –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π AudioData:
     self._google_audio_data = sr.AudioData(all_raw_data, sample_rate, sample_width)
```

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –†–∞–∑–Ω—ã–µ sample_rate –≤ —á–∞–Ω–∫–∞—Ö (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —á–∞–Ω–∫–∏ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ `sample_rate` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 48kHz –∏ 16kHz)

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º:
```python
sample_rates = [chunk.sample_rate for chunk in self._google_audio_chunks]
if len(set(sample_rates)) > 1:
    logger.warning("‚ö†Ô∏è –†–∞–∑–Ω—ã–µ sample_rate –≤ —á–∞–Ω–∫–∞—Ö, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥")
    # –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –≤—Å–µ—Ö —á–∞–Ω–∫–æ–≤ –¥–æ –µ–¥–∏–Ω–æ–≥–æ sample_rate
```

### 2. –ü—É—Å—Ç—ã–µ —á–∞–Ω–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ —á–∞–Ω–∫ –ø—É—Å—Ç–æ–π (0 bytes)

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø—É—Å—Ç—ã–µ —á–∞–Ω–∫–∏:
```python
for chunk in self._google_audio_chunks[1:]:
    chunk_data = chunk.get_raw_data()
    if len(chunk_data) > 0:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ
        all_raw_data += chunk_data
```

### 3. –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ (> 1MB)

**–†–µ—à–µ–Ω–∏–µ:** Google Speech API –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã, –Ω–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `speech_recognition` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏

## ‚úÖ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:**
- ‚úÖ –í—Å–µ —á–∞–Ω–∫–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Thread-safety –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ —á–µ—Ä–µ–∑ lock
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ (–∫–∞–∂–¥—ã–π —á–∞–Ω–∫)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (0 —á–∞–Ω–∫–æ–≤, 1 —á–∞–Ω–∫, –º–Ω–æ–≥–æ —á–∞–Ω–∫–æ–≤)

**–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ `sample_rate` –≤ —á–∞–Ω–∫–∞—Ö
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø—É—Å—Ç—ã–µ —á–∞–Ω–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç –Ω–∞ —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üîß –ö–æ–¥ –≤ `voice_recognition_integration.py`

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –º–µ—Ç–æ–¥–µ `_on_recording_stop`, —Å—Ç—Ä–æ–∫–∏ ~1042-1075.






