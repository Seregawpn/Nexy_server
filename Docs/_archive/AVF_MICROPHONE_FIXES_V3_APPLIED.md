# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ v3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è state_manager –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è microphone.closed

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
2025-12-11

## –ü—Ä–æ–±–ª–µ–º—ã, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ —Ç–µ—Å—Ç–∞—Ö

### 1. –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è state_manager

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Google –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ `state_manager.is_microphone_active()` –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `True`, —Ö–æ—Ç—è `_google_stop_listening=None`.

**–ü—Ä–∏—á–∏–Ω–∞**: 
- `set_microphone_state("idle", ...)` –∏–ª–∏ `force_close_microphone()` –º–æ–≥—É—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- –ù–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 2. microphone.closed –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ç–µ—Å—Ç–∞—Ö `test_microphone_stop_duplicates.py` —Å–æ–±—ã—Ç–∏–µ `microphone.closed` –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–æ—Å—å (0 —Å–æ–±—ã—Ç–∏–π).

**–ü—Ä–∏—á–∏–Ω–∞**: 
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å –±–µ–∑ `await` (`event_bus.subscribe()` - —ç—Ç–æ async —Ñ—É–Ω–∫—Ü–∏—è)
- RuntimeWarning: `coroutine 'EventBus.subscribe' was never awaited`

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è v3

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 992-1001, 1042-1050)

**–ë—ã–ª–æ**:
```python
self.state_manager.force_close_microphone(reason="recording_stop_no_session")
await self.event_bus.publish("microphone.closed", {"session_id": None})
```

**–°—Ç–∞–ª–æ**:
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∑–∞—Ç–µ–º –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ
state_changed = self.state_manager.force_close_microphone(reason="recording_stop_no_session")
if state_changed:
    logger.info("‚úÖ [VOICE] –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ idle —á–µ—Ä–µ–∑ force_close_microphone")
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
if self.state_manager.is_microphone_active():
    logger.warning("‚ö†Ô∏è [VOICE] state_manager –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç active –ø–æ—Å–ª–µ force_close_microphone - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞")
    self.state_manager.set_microphone_state("idle", session_id=None, reason="force_close_retry")
await self.event_bus.publish("microphone.closed", {"session_id": None})
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ session mismatch (—Å—Ç—Ä–æ–∫–∏ 1042-1050)

**–ë—ã–ª–æ**:
```python
self.state_manager.set_microphone_state("idle", session_id=None, reason="google_recording_stopped_mismatch")
await self.event_bus.publish("microphone.closed", {"session_id": request_session_str})
```

**–°—Ç–∞–ª–æ**:
```python
# –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
state_changed = self.state_manager.set_microphone_state("idle", session_id=None, reason="google_recording_stopped_mismatch")
if state_changed:
    logger.info("‚úÖ [VOICE] –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ idle —á–µ—Ä–µ–∑ set_microphone_state")
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
if self.state_manager.is_microphone_active():
    logger.warning("‚ö†Ô∏è [VOICE] state_manager –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç active –ø–æ—Å–ª–µ set_microphone_state - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞")
    self.state_manager.force_close_microphone(reason="set_idle_retry")
await self.event_bus.publish("microphone.closed", {"session_id": request_session_str})
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—Å—Ç—Ä–æ–∫–∏ 978-982, 1047-1052)

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
```python
except Exception as e:
    logger.error(f"‚ùå [Google] –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Google –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: {e}", exc_info=True)
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    self._google_recording_active = False
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    if self.state_manager.is_microphone_active():
        logger.warning("‚ö†Ô∏è [VOICE] state_manager –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç active –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è")
        self.state_manager.force_close_microphone(reason="error_sync_no_session")
        await self.event_bus.publish("microphone.closed", {"session_id": None})
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö

**–ë—ã–ª–æ**:
```python
event_bus.subscribe("microphone.closed", on_microphone_closed, priority=1)
```

**–°—Ç–∞–ª–æ**:
```python
await event_bus.subscribe("microphone.closed", on_microphone_closed, priority=1)
```

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `integration/integrations/voice_recognition_integration.py`:
  - –°—Ç—Ä–æ–∫–∏ 992-1001: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ `force_close_microphone()` (session_id=None)
  - –°—Ç—Ä–æ–∫–∏ 1042-1050: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ `set_microphone_state()` (session mismatch)
  - –°—Ç—Ä–æ–∫–∏ 978-982: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ (session_id=None)
  - –°—Ç—Ä–æ–∫–∏ 1047-1052: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ (session mismatch)

- `scripts/test_microphone_stop_duplicates.py`:
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è: `await event_bus.subscribe(...)`

- `scripts/test_microphone_sticking_scenarios.py`:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ç–µ—Å—Ç–µ 2.3
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è v3

### ‚úÖ –¢–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:

1. **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**:
   - `_google_stop_listening` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **1 —Ä–∞–∑** (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
   - `force_close_microphone` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **1 —Ä–∞–∑** (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
   - `microphone.closed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è **1 —Ä–∞–∑** (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)

2. **microphone.closed –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è**:
   - –¢–µ—Å—Ç 1: **1 —Å–æ–±—ã—Ç–∏–µ** ‚úÖ
   - –¢–µ—Å—Ç 2: **1 —Å–æ–±—ã—Ç–∏–µ** ‚úÖ
   - –¢–µ—Å—Ç 3: **1 —Å–æ–±—ã—Ç–∏–µ** ‚úÖ

3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**:
   - –ü–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
   - –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è v3

```
20:39:26,630 - üõë [Google] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ Google –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (session mismatch)
20:39:26,630 - ‚úÖ [Google] _google_recording_active = False (—Ñ–ª–∞–≥ —Å–±—Ä–æ—à–µ–Ω –î–û –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
20:39:26,630 - ‚è≥ [Google] –ó–∞–¥–µ—Ä–∂–∫–∞ 0.1 —Å–µ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö callback'–æ–≤
20:39:26,630 - ‚úÖ [Google] _google_stop_listening(wait_for_stop=False) –≤—ã–∑–≤–∞–Ω
20:39:26,630 - ‚úÖ [Google] Google –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (session mismatch)
20:39:26,630 - ‚úÖ [VOICE] –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ idle —á–µ—Ä–µ–∑ set_microphone_state
20:39:26,630 - üîÑ [MIC_STATE] active ‚Üí idle (session=None, reason=google_recording_stopped_mismatch)
20:39:26,631 - üì¢ –°–æ–±—ã—Ç–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: microphone.closed
20:39:26,631 - ‚úÖ [VOICE] –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ v3 –ø—Ä–∏–º–µ–Ω–µ–Ω–æ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
2. ‚úÖ **–¢–µ—Å—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º (–Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Å–∏–º—É–ª—è—Ü–∏–∏) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

## –°—Ç–∞—Ç—É—Å

- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ v3 –ø—Ä–∏–º–µ–Ω–µ–Ω–æ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ **microphone.closed –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è**: 1 —Ä–∞–∑ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ
- ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –í—Å–µ –≤—ã–∑–æ–≤—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç 1 —Ä–∞–∑
- ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–µ 2.3 –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å —Ä–µ–∂–∏–º–æ–º —Å–∏–º—É–ª—è—Ü–∏–∏

