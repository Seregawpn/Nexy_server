# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º (`AVAudioEngineConfigurationChangeNotification`) —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `STARTING`.

### –°–∏–º–ø—Ç–æ–º—ã –∏–∑ –ª–æ–≥–æ–≤:

1. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è:
   ```
   ‚úÖ [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ: 506880 bytes, 48000Hz, 1ch, duration‚âà5.28s
   ‚úÖ [AVF] scheduleBuffer –≤—ã–∑–≤–∞–Ω —Å completion handler (Python —Ñ—É–Ω–∫—Ü–∏—è)
   ```

2. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ:
   ```
   üîî [AVF] AVAudioEngineConfigurationChangeNotification –ø–æ–ª—É—á–µ–Ω–∞
   üîÑ [AVF] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ player node: engine_running=True, output_active=False, state=AudioState.STARTING
   üõë [AVF] Engine –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   ```

3. –†–µ–∑—É–ª—å—Ç–∞—Ç: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è, –∑–≤—É–∫ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.

---

## –ü—Ä–∏—á–∏–Ω–∞

1. **`is_output_active` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ `RUNNING`**:
   ```python
   def is_output_active(self) -> bool:
       return self._output_state == AudioState.RUNNING  # ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç STARTING
   ```

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `scheduleBuffer`**:
   - –°–æ—Å—Ç–æ—è–Ω–∏–µ –µ—â—ë `STARTING` (–Ω–µ —É—Å–ø–µ–ª–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ `RUNNING`)
   - `was_output_active = False` (—Ç–∞–∫ –∫–∞–∫ `STARTING != RUNNING`)
   - Engine –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è

3. **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –∫–æ–≥–¥–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ—Å—å**:
   - `_reconnect_player_node()` –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç engine
   - –≠—Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞—á–∞–≤—à–µ–µ—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£—á–∏—Ç—ã–≤–∞–µ–º STARTING –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```python
def is_output_active(self) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    
    ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –£—á–∏—Ç—ã–≤–∞–µ–º STARTING –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —É–∂–µ –Ω–∞—á–∞–ª–æ—Å—å
    """
    with self._lock:
        return self._output_state in (AudioState.RUNNING, AudioState.STARTING, AudioState.RECONNECTING)
```

### 2. –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º engine –µ—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º engine —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
should_stop_engine = was_running and was_output_active

if should_stop_engine:
    self._engine.stop()
    logger.debug("üõë [AVF] Engine –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ)")
elif was_running and not was_output_active:
    # Engine –∑–∞–ø—É—â–µ–Ω, –Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ—Å—å)
    # –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º engine - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    logger.warning("‚ö†Ô∏è [AVF] –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è STARTING - –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º engine, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ")
```

### 3. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –®–∞–≥ 2-4: –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ engine
# –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING, –ù–ï —Ç—Ä–æ–≥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ - –æ–Ω–æ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
if should_stop_engine:
    # –û—Ç–∫–ª—é—á–∞–µ–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –∑–∞–Ω–æ–≤–æ
    ...
else:
    # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –æ–Ω–æ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    logger.debug("üîç [AVF] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)")
```

### 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ STARTING –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```python
elif was_running and not was_output_active:
    # Engine —É–∂–µ –∑–∞–ø—É—â–µ–Ω –∏ –Ω–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
    logger.info("‚úÖ [AVF] Engine —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ STARTING –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)")
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ STARTING, —á—Ç–æ–±—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–æ—Å—å
    with self._lock:
        if self._output_state == AudioState.RECONNECTING:
            self._output_state = AudioState.STARTING
            logger.info("‚úÖ [AVF] _output_state –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ STARTING –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
```

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ `STARTING`
- ‚úÖ Engine –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ—Å—å
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `STARTING` –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
2. –ó–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –°–æ–±—ã—Ç–∏–µ `playback.completed` –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–æ–≤—Ä–µ–º—è
