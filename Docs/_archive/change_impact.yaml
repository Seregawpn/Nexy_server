# Change Impact Analysis: First Run Restart Flow
# Created: 2025-11-02
# Related: ADR-001, STATE_CATALOG.md, interaction_matrix.yaml
# Phase: Phase 2 (Architectural Compliance)

change_id: first_run_restart_blocking
description: |
  Automatic application restart after first-run permissions flow.
  Blocks all integrations (especially voice_recognition) from starting until restart completes.

# Affected State Axes
affected_axes:
  - axis: FirstRun
    states: [true, false]
    owner: first_run_permissions_integration
    source_of_truth: ~/Library/Application Support/Nexy/permissions_first_run_completed.flag
    changes: |
      - Existing axis, no structural changes
      - New persistent flag: restart_completed.flag
      - Event order changed: restart_pending published BEFORE completed

  - axis: permissions.restart_pending
    states: [true, false]
    owner: first_run_permissions_integration
    source_of_truth: ~/Library/Application Support/Nexy/restart_completed.flag (persistent)
    changes: |
      - NEW AXIS: Tracks if app restart is pending after first_run
      - Set to true when restart_completed.flag is created
      - Set to false when new process publishes completed event
      - Blocks coordinator from launching remaining integrations

  - axis: process.lifecycle
    states: [running, restarting, terminated]
    owner: permissions_restart_handler
    source_of_truth: OS process state + subprocess.run() result
    changes: |
      - NEW AXIS: Tracks application process lifecycle
      - restarting: open -W is waiting for new process
      - terminated: old process exited after new process verified

  - axis: appMode
    states: [SLEEPING, LISTENING, PROCESSING]
    owner: mode_management_integration
    source_of_truth: ApplicationStateManager
    changes: |
      - Existing axis, no structural changes
      - LISTENING blocked when restart_pending=true (via gateway)

# Invariants (Must Never Be Violated)
invariants:
  - id: INV-1
    description: voice_recognition MUST NOT start when restart_pending=true
    enforcement: decide_continue_integration_startup() gateway
    test: test_voice_recognition_blocked_during_restart_pending

  - id: INV-2
    description: permissions.first_run_completed MUST be published AFTER restart, not before
    enforcement: Event order in first_run_permissions_integration.start()
    test: test_completed_event_after_restart

  - id: INV-3
    description: New process MUST verify before old process exits (via open -W)
    enforcement: permissions_restart_handler._launch_packaged_app()
    test: test_restart_verification_via_open_w

  - id: INV-4
    description: restart_completed.flag MUST be cleaned up after publishing completed
    enforcement: first_run_permissions_integration.initialize()
    test: test_restart_flag_cleanup

# Guards (Conditional Checks)
guards:
  - id: GUARD-1
    condition: FirstRun=true AND restart_pending=true
    action: ABORT integration startup (coordinator)
    priority: hard_stop
    gateway: decide_continue_integration_startup()
    description: Stop launching integrations until restart completes

  - id: GUARD-2
    condition: FirstRun=true (regardless of restart_pending)
    action: ABORT listening mode
    priority: hard_stop
    gateway: decide_start_listening()
    description: Already exists in gateways.py:54

  - id: GUARD-3
    condition: restart_pending=true (coordinator check)
    action: Trigger restart via permissions_restart_handler
    priority: hard_stop
    gateway: decide_continue_integration_startup()
    description: Call request_restart() if pending

  - id: GUARD-4
    condition: NEXY_KS_FIRST_RUN_RESTART=true
    action: SKIP restart (dry-run mode)
    priority: hard_stop
    enforcement: permissions_restart_handler.__init__()
    description: Kill-switch for emergency rollback

# Test Strategy
test_strategy:
  pairwise_combinations:
    axes: [FirstRun, restart_pending, appMode, perm_mic]
    minimum_tests: 14
    tests:
      - name: happy_path_first_run_restart
        values: {FirstRun: true, restart_pending: true, appMode: SLEEPING, perm_mic: GRANTED}
        expected: ABORT integration startup, trigger restart

      - name: restart_pending_blocks_listening
        values: {FirstRun: true, restart_pending: true, appMode: LISTENING, perm_mic: GRANTED}
        expected: ABORT listening, ABORT integration startup

      - name: first_run_without_restart_pending
        values: {FirstRun: true, restart_pending: false, appMode: SLEEPING, perm_mic: GRANTED}
        expected: Should not happen (logic error)

      - name: normal_startup_no_first_run
        values: {FirstRun: false, restart_pending: false, appMode: SLEEPING, perm_mic: GRANTED}
        expected: START integrations normally

      - name: double_block_denied_mic_first_run
        values: {FirstRun: true, restart_pending: true, appMode: SLEEPING, perm_mic: DENIED}
        expected: ABORT integration startup (restart has priority)

      - name: restart_pending_in_processing_mode
        values: {FirstRun: true, restart_pending: true, appMode: PROCESSING, perm_mic: GRANTED}
        expected: ABORT integration startup

      - name: first_run_granted_mic_sleeping
        values: {FirstRun: true, restart_pending: true, appMode: SLEEPING, perm_mic: GRANTED}
        expected: ABORT and restart

      - name: normal_processing_no_first_run
        values: {FirstRun: false, restart_pending: false, appMode: PROCESSING, perm_mic: GRANTED}
        expected: START normally

      - name: first_run_prompt_blocked_mic
        values: {FirstRun: true, restart_pending: true, appMode: SLEEPING, perm_mic: PROMPT_BLOCKED}
        expected: ABORT integration startup

      - name: listening_mode_no_first_run
        values: {FirstRun: false, restart_pending: false, appMode: LISTENING, perm_mic: GRANTED}
        expected: START listening normally

      - name: first_run_sleeping_granted
        values: {FirstRun: true, restart_pending: true, appMode: SLEEPING, perm_mic: GRANTED}
        expected: ABORT and trigger restart

      - name: processing_no_first_run_denied
        values: {FirstRun: false, restart_pending: false, appMode: PROCESSING, perm_mic: DENIED}
        expected: DEGRADE (mic not critical for processing)

      - name: first_run_listening_denied
        values: {FirstRun: true, restart_pending: true, appMode: LISTENING, perm_mic: DENIED}
        expected: ABORT (multiple hard_stop conditions)

      - name: sleeping_no_first_run_denied
        values: {FirstRun: false, restart_pending: false, appMode: SLEEPING, perm_mic: DENIED}
        expected: START coordinator, but listening will abort

  negative_tests:
    - name: restart_timeout_fallback
      scenario: open -W times out after 10 seconds
      expected: Return False, coordinator continues with fallback

    - name: restart_failed_new_process_crashes
      scenario: New process launches but crashes immediately
      expected: open -W succeeds, but restart_completed.flag never processed

  contract_tests:
    - name: event_order_verification
      events:
        - permissions.first_run_started (first)
        - permissions.first_run_restart_pending (second)
        - NO permissions.first_run_completed (until new process)
      validation: Check EventBus logs for correct sequence

    - name: new_process_completed_event
      events:
        - NEW PROCESS starts
        - initialize() finds restart_completed.flag
        - permissions.first_run_completed published
        - restart_completed.flag deleted
      validation: Check flag lifecycle and event timing

# Metrics to Monitor
metrics:
  - name: first_run_restart_success_rate
    type: counter
    description: Percentage of successful restarts after first_run
    target: ">95%"
    alert_threshold: "<90%"

  - name: permission_flow_completion_time_p95
    type: histogram
    description: Time from first_run_started to completed event
    target: "<60s"
    alert_threshold: ">90s"

  - name: voice_recognition_premature_activation_count
    type: counter
    description: Times voice_recognition started during restart_pending
    target: "0"
    alert_threshold: ">0"

  - name: restart_timeout_rate
    type: counter
    description: Times open -W timed out (>10s)
    target: "<1%"
    alert_threshold: ">5%"

  - name: restart_completed_flag_orphan_rate
    type: counter
    description: Times restart_completed.flag found but no restart occurred
    target: "<0.1%"
    alert_threshold: ">1%"

# Rollout Strategy
rollout:
  feature_flag: NEXY_FF_FIRST_RUN_RESTART
  kill_switch: NEXY_KS_FIRST_RUN_RESTART

  phases:
    - phase: 1
      percentage: 1%
      duration: 2 days
      success_criteria:
        - first_run_restart_success_rate > 95%
        - voice_recognition_premature_activation_count = 0
        - restart_timeout_rate < 2%

    - phase: 2
      percentage: 25%
      duration: 3 days
      success_criteria:
        - first_run_restart_success_rate > 97%
        - permission_flow_completion_time_p95 < 60s
        - No critical incidents

    - phase: 3
      percentage: 100%
      duration: ongoing
      success_criteria:
        - SLO maintained: first_run_restart_success_rate > 99%
        - permission_flow_success >= 99% (from .cursorrules section 20)

  shadow_mode:
    enabled: false
    description: |
      Shadow mode not applicable for this change - restart mechanism cannot run
      without actually restarting the process. Testing must be done in controlled
      environments with rollback plan.

  rollback_triggers:
    - first_run_restart_success_rate < 85% (sustained for >1 hour)
    - voice_recognition_premature_activation_count > 10 (in any 1-hour window)
    - restart_timeout_rate > 10% (sustained)
    - Critical incidents related to restart flow

  rollback_procedure: |
    1. Set NEXY_KS_FIRST_RUN_RESTART=true via environment/config
    2. Monitor that restarts stop occurring
    3. Git revert commit if needed: git revert <commit-hash>
    4. Clear orphaned flags: rm ~/Library/Application Support/Nexy/restart_completed.flag
    5. Notify users to manually restart if they're stuck in first_run flow

# Risks and Mitigation
risks:
  - risk: open -W may hang if app never finishes launching
    severity: high
    probability: low
    mitigation: |
      - 10-second timeout catches infinite hangs
      - Fallback to dev process restart if packaged app fails
      - User can manually launch app if both fail
    monitoring: restart_timeout_rate metric

  - risk: restart_completed.flag corruption/orphaning
    severity: medium
    probability: low
    mitigation: |
      - Try/catch in initialize() for flag operations
      - Flag automatically cleaned up after publishing completed
      - Manual cleanup procedure in rollback steps
    monitoring: restart_completed_flag_orphan_rate metric

  - risk: PyInstaller bundle in non-standard location
    severity: medium
    probability: medium
    mitigation: |
      - get_user_app_path() hardcodes /Applications/Nexy.app
      - Fallback to dev process restart if bundle not found
      - Future: Use sys.executable to detect actual bundle path
    monitoring: Check logs for "Nexy.app not found" messages

  - risk: Coordinator race condition checking restart_pending
    severity: high
    probability: low (after Phase 2)
    mitigation: |
      - Phase 1: asyncio.sleep(0.5) gives time for event handlers
      - Phase 2: Use gateway with Snapshot (atomic check)
      - restart_pending flag is set synchronously in event handler
    monitoring: voice_recognition_premature_activation_count

  - risk: Breaking existing integrations expecting completed event
    severity: high
    probability: medium
    mitigation: |
      - Event still published, just timing changed
      - PermissionRestartIntegration and others still receive it
      - Backward compatibility maintained
    monitoring: Monitor for errors in permission_restart logs

# Side Effects
side_effects:
  positive:
    - voice_recognition can no longer activate prematurely
    - Restart verification prevents orphaned processes
    - Kill-switch allows emergency rollback without deploy
    - Persistent flag prevents race conditions

  negative:
    - Longer shutdown time (up to 10s for open -W timeout)
    - Additional file I/O for restart_completed.flag
    - More complex event ordering (harder to debug)
    - Technical debt until Phase 2 gateway refactor completes

# Related Documents
related_docs:
  - Docs/ADR-001-first-run-restart-hotfix.md
  - Docs/STATE_CATALOG.md (sections 6, 13-new)
  - config/interaction_matrix.yaml (lines 32-37, new rules)
  - integration/core/gateways.py (decide_continue_integration_startup)
  - integration/core/selectors.py (Snapshot.restart_pending)
  - .cursorrules (sections 11.2, 18.x, 21.x)

# Approval and Sign-off
approval:
  tech_lead: pending
  qa_lead: pending
  product_owner: pending
  date_approved: null
  deployment_date: null
