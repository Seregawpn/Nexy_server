# –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å AVF –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioSystemIntegration**:
   - ‚úÖ AVFAudioEngine —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ Player node —Å–æ–∑–¥–∞—ë—Ç—Å—è
   - ‚úÖ Event bus –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è
   - ‚úÖ Completion callback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ Python —Ñ—É–Ω–∫—Ü–∏—è)

2. **–ü–µ—Ä–µ–¥–∞—á–∞ AVFAudioEngine –≤ SpeechPlaybackIntegration**:
   - ‚úÖ AVFAudioEngine –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä)
   - ‚úÖ `_use_avf = True` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - ‚úÖ SpeechPlaybackIntegration –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

3. **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ Input –∏ Output —Ä–µ–∂–∏–º–æ–≤**:
   - ‚úÖ –û–±–∞ —Ä–µ–∂–∏–º–∞ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∞–∫—Ç–∏–≤–µ–Ω

## ‚ùå –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Completion callback**:
   - ‚ùå Python —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ Objective-C –±–ª–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - ‚ùå `objc.callbackFor` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å void (^)(void)
   - ‚ùå `objc.ObjCBlock` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ PyObjC

2. **Fallback —Ç–∞–π–º–µ—Ä**:
   - ‚ùå Fallback —Ç–∞–π–º–µ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)
   - ‚ùå –°–æ–±—ã—Ç–∏–µ `audio.playback.completed` –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ fallback

3. **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - ‚ùå –°–æ–±—ã—Ç–∏–µ `playback.raw_audio` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
   - ‚ùå `play_audio` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ AVFAudioEngine
   - ‚ùå –°–æ–±—ã—Ç–∏–µ `playback.completed` –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

## üîß –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è completion callback

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Python —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é –≤–º–µ—Å—Ç–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è Objective-C –±–ª–æ–∫–∞

```python
# –ü–æ–ø—ã—Ç–∫–∞ 1: –ü–µ—Ä–µ–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é (PyObjC –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å)
_AVF_COMPLETION_CALLBACK = playback_completion_handler_impl
```

### 2. –£–ª—É—á—à–µ–Ω–∏–µ fallback —Ç–∞–π–º–µ—Ä–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: Fallback —Ç–∞–π–º–µ—Ä –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ event loop –∏–ª–∏ threading.Timer

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º fallback —Ç–∞–π–º–µ—Ä —á–µ—Ä–µ–∑ event loop
if self._ensure_loop_attached():
    result = self._submit_to_event_loop(_fallback_timeout(), is_async=True)
    if result:
        logger.info(f"‚úÖ [AVF] Fallback —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ event loop")
else:
    # Fallback —á–µ—Ä–µ–∑ threading.Timer
    self._fallback_timer = threading.Timer(duration_sec + 0.5, _fallback_timer_callback)
    self._fallback_timer.start()
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ callback

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–¥–∞—Ç—å `None` –∏ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ fallback —Ç–∞–π–º–µ—Ä

```python
try:
    if callback_to_use is not None:
        self._player_node.scheduleBuffer_atTime_options_completionHandler_(
            audio_buffer, None, 0, callback_to_use
        )
except Exception as schedule_error:
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º None
    self._player_node.scheduleBuffer_atTime_options_completionHandler_(
        audio_buffer, None, 0, None
    )
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–æ–≤–µ–¥–µ–Ω–∏—è –¥–æ —Ä–∞–±–æ—á–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏—è `playback.raw_audio`**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `_on_raw_audio`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `{"data": {"audio_data": numpy_array, ...}}`)
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_on_raw_audio` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å fallback —Ç–∞–π–º–µ—Ä**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ fallback —Ç–∞–π–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ `audio.playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ fallback
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ completion callback**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NSNotification –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ fallback —Ç–∞–π–º–µ—Ä (–±–µ–∑ native callback)

### –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–≥–æ–≤ –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è callback
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞ fallback —Ç–∞–π–º–µ—Ä–∞

2. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**:
   - –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
   - Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ callback

3. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏**:
   - –°—á—ë—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö callback'–æ–≤
   - –°—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è fallback —Ç–∞–π–º–µ—Ä–∞
   - –í—Ä–µ–º—è –º–µ–∂–¥—É –Ω–∞—á–∞–ª–æ–º –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏—è `playback.raw_audio` - —ç—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—é –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö
2. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å fallback —Ç–∞–π–º–µ—Ä - —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
3. **–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è**: –ù–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è completion callback –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ fallback —Ç–∞–π–º–µ—Ä
4. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ**: –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å PyObjC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–æ–≤

## ‚úÖ –í—ã–≤–æ–¥—ã

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**, –Ω–æ **–ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏ completion callback –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç**. 

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:
1. –°–æ–±—ã—Ç–∏–µ `playback.raw_audio` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ `_on_raw_audio`)
2. Fallback —Ç–∞–π–º–µ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ)
3. Completion callback –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ PyObjC

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è `playback.raw_audio` –∏ fallback —Ç–∞–π–º–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã.


