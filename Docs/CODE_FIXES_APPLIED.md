# ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –£–±—Ä–∞–Ω fallback –Ω–∞ ApplicationStateManager (–ö–†–ò–¢–ò–ß–ù–û)

### –ü—Ä–æ–±–ª–µ–º–∞:
–í `VoiceRecognitionIntegration` –±—ã–ª fallback –Ω–∞ `state_manager.set_microphone_state()`, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
- ‚úÖ –£–±—Ä–∞–Ω—ã `else` –±–ª–æ–∫–∏ —Å fallback –≤ `_on_recording_start()` –∏ `_on_recording_stop()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `MicrophoneStateManager` —Å –≤—ã–±—Ä–æ—Å–æ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, —á—Ç–æ `MicrophoneStateManager` –≤—Å–µ–≥–¥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

### –ö–æ–¥ –¥–æ:
```python
if self._mic_state_manager:
    opened = await self._mic_state_manager.request_open(str(session_id))
else:
    # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    self.state_manager.set_microphone_state("opening", str(session_id), reason="recording_start")
```

### –ö–æ–¥ –ø–æ—Å–ª–µ:
```python
if not self._mic_state_manager:
    logger.error("‚ùå VOICE: MicrophoneStateManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω")
    self._recording_active = False
    self._set_session_id(None, reason="mic_state_manager_not_initialized")
    return

opened = await self._mic_state_manager.request_open(str(session_id))
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞:
–ï—Å–ª–∏ `MicrophoneStateManager` –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å fallback, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (fail-fast –ø–æ–¥—Ö–æ–¥)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

### –ö–æ–¥:
```python
try:
    self._mic_state_manager = MicrophoneStateManager(...)
    mic_init_result = await self._mic_state_manager.initialize()
    if not mic_init_result:
        logger.error("‚ùå VOICE: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å MicrophoneStateManager")
        raise RuntimeError("MicrophoneStateManager initialization failed")
except Exception as e:
    logger.error(f"‚ùå VOICE: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MicrophoneStateManager: {e}")
    raise  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - –±–µ–∑ MicrophoneStateManager –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ `state_manager.force_close_microphone()`, –º–∏–Ω—É—è `MicrophoneStateManager`.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `MicrophoneStateManager.force_close()` –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å
- ‚úÖ Fallback –Ω–∞ `state_manager.force_close_microphone()` —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö (–µ—Å–ª–∏ `MicrophoneStateManager` –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)

### –ö–æ–¥:
```python
# ‚úÖ –≠–¢–ê–ü 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º MicrophoneStateManager –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
if self._mic_state_manager:
    await self._mic_state_manager.force_close(reason="recording_stop_no_session")
else:
    # Fallback —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
    logger.error("‚ùå VOICE: MicrophoneStateManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏")
    self.state_manager.force_close_microphone(reason="recording_stop_no_session_fallback")
```

---

## üìä –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)

### –ü–æ—Ç–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:

```
InputProcessingIntegration
  ‚Üì (–ø—É–±–ª–∏–∫—É–µ—Ç voice.recording_start)
EventBus
  ‚Üì
VoiceRecognitionIntegration._on_recording_start()
  ‚Üì (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç MicrophoneStateManager.request_open())
MicrophoneStateManager
  ‚Üì (–ø—É–±–ª–∏–∫—É–µ—Ç microphone.open_requested)
EventBus
  ‚Üì
VoiceRecognitionIntegration._on_microphone_open_requested()
  ‚Üì (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω —á–µ—Ä–µ–∑ SpeechRecognizer)
  ‚Üì (–ø—É–±–ª–∏–∫—É–µ—Ç microphone.opened)
EventBus
  ‚Üì
MicrophoneStateManager (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç microphone.opened)
  ‚Üì (–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Üí ACTIVE)
  ‚Üì (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å ApplicationStateManager - –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è)
ApplicationStateManager (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è —á–µ—Ä–µ–∑ InputProcessingIntegration)
```

### –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:

- **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:** `MicrophoneStateManager`
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** `MicrophoneStateManager` ‚Üí `ApplicationStateManager` (–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è, —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
  - `VoiceRecognitionIntegration` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `MicrophoneStateManager` –Ω–∞–ø—Ä—è–º—É—é
  - `InputProcessingIntegration` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ApplicationStateManager.is_microphone_active()` (—á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é)

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ:
1. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** - —É–±—Ä–∞–Ω fallback –Ω–∞ `ApplicationStateManager`
2. ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã** - —Ç–æ–ª—å–∫–æ `MicrophoneStateManager` —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
3. ‚úÖ **–ù–∞—Ä—É—à–µ–Ω–∏–µ –∏–∑–æ–ª—è—Ü–∏–∏** - –º–æ–¥—É–ª–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ EventBus

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:
1. ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - `InputProcessingIntegration` –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
2. ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å `InputProcessingIntegration`
3. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - fail-fast –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

## ‚ö†Ô∏è –û—Å—Ç–∞–≤—à–∏–µ—Å—è –º–æ–º–µ–Ω—Ç—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è MicrophoneStateManager ‚Üí ApplicationStateManager

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- `MicrophoneStateManager` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- `ApplicationStateManager` - —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è (—á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é)
- `InputProcessingIntegration` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ApplicationStateManager` (—á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å - —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –±–µ–∑ breaking changes.

### 2. InputProcessingIntegration –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ApplicationStateManager

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `state_manager.is_microphone_active()` —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ):** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `MicrophoneStateManager` –≤ `InputProcessingIntegration` –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. ‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** - `MicrophoneStateManager`
2. ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –º–æ–¥—É–ª–µ–π** - —á–µ—Ä–µ–∑ EventBus
3. ‚úÖ **–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - `MicrophoneStateManager` ‚Üí `ApplicationStateManager`
4. ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - —É–±—Ä–∞–Ω fallback
5. ‚úÖ **Fail-fast** - –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

### –ú–æ–¥—É–ª–∏:

| –ú–æ–¥—É–ª—å | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –°–ø–æ—Å–æ–± –¥–æ—Å—Ç—É–ø–∞ |
|--------|------------|----------------|
| `VoiceRecognitionIntegration` | `MicrophoneStateManager` | –ù–∞–ø—Ä—è–º—É—é (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç) |
| `InputProcessingIntegration` | `ApplicationStateManager` | –ß–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é |
| `MicrophoneStateManager` | –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã |

---

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ò–°–ü–†–ê–í–õ–ï–ù–û

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã:
- ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–±—Ä–∞–Ω–æ
- ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —Å–æ–±–ª—é–¥–µ–Ω–∞
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ EventBus —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

