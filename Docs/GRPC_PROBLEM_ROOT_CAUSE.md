# üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å gRPC

**–î–∞—Ç–∞:** 13 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–í –ª–æ–≥–∞—Ö Nginx –≤–∏–¥–Ω–æ:
```
"PRI * HTTP/2.0" 400 166
```

–≠—Ç–æ **HTTP/2 connection preface**, –∫–æ—Ç–æ—Ä—ã–π gRPC –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ HTTP/2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. Nginx –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **400 –æ—à–∏–±–∫—É**.

---

## üîç Root Cause Analysis

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ú–æ–¥—É–ª—å grpc –ù–ï —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –≤ Nginx

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx:**
```bash
nginx -V 2>&1 | grep grpc
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–ò–ß–ï–ì–û –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
```

**–ß—Ç–æ –µ—Å—Ç—å:**
- ‚úÖ `--with-http_v2_module` (HTTP/2 –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –µ—Å—Ç—å)
- ‚úÖ `--with-http_ssl_module` (SSL –µ—Å—Ç—å)
- ‚ùå **–ù–ï–¢ `--with-http_grpc_module`** (gRPC –º–æ–¥—É–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!)

**–í–µ—Ä—Å–∏—è Nginx:** 1.24.0 (Ubuntu)

### –ü—Ä–æ–±–ª–µ–º–∞ #2: Nginx –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç gRPC –∑–∞–ø—Ä–æ—Å—ã

–ö–æ–≥–¥–∞ gRPC –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP/2 connection preface: `PRI * HTTP/2.0`
2. Nginx –≤–∏–¥–∏—Ç —ç—Ç–æ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π HTTP/2 –∑–∞–ø—Ä–æ—Å
3. –ù–æ –±–µ–∑ –º–æ–¥—É–ª—è `grpc` Nginx –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ gRPC
4. Nginx –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400 –æ—à–∏–±–∫—É

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `grpc_pass`, –Ω–æ –º–æ–¥—É–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å:
```nginx
location / {
    grpc_pass grpc://grpc_backend;  # ‚ùå –≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!
    ...
}
```

–ù–æ –±–µ–∑ –º–æ–¥—É–ª—è `ngx_http_grpc_module` –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `grpc_pass` **–Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è** –∏–ª–∏ **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è**.

---

## üîß –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π gRPC (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–î–ª—è Ubuntu/Debian:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
apt-cache search nginx | grep grpc

# –ï—Å–ª–∏ –µ—Å—Ç—å nginx-extras –∏–ª–∏ nginx-full —Å grpc:
sudo apt-get update
sudo apt-get install nginx-extras  # –∏–ª–∏ nginx-full

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
nginx -V 2>&1 | grep grpc
```

**–ï—Å–ª–∏ –ø–∞–∫–µ—Ç–æ–≤ —Å grpc –Ω–µ—Ç:**
–ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Nginx —Å –º–æ–¥—É–ª–µ–º grpc –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–∞–∫–µ—Ç –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å proxy_pass –≤–º–µ—Å—Ç–æ grpc_pass (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π `proxy_pass` —Å HTTP/2, –Ω–æ —ç—Ç–æ **–Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ** –¥–ª—è gRPC:

```nginx
location / {
    # –í–º–µ—Å—Ç–æ grpc_pass –∏—Å–ø–æ–ª—å–∑—É–µ–º proxy_pass
    proxy_pass http://grpc_backend;
    proxy_http_version 2.0;  # HTTP/2
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è gRPC
    proxy_set_header Content-Type application/grpc;
    proxy_set_header TE trailers;
    
    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...
}
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –≠—Ç–æ –Ω–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ `grpc_pass`, –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Nginx —Å –º–æ–¥—É–ª–µ–º grpc

–¢—Ä–µ–±—É–µ—Ç—Å—è:
1. –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ Nginx
2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å `ngx_http_grpc_module`
3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

–≠—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å.

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```
‚úÖ HTTP/2 –º–æ–¥—É–ª—å: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ SSL –º–æ–¥—É–ª—å: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω  
‚úÖ HTTP endpoints: —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ gRPC —Å–µ—Ä–≤–µ—Ä: –∑–∞–ø—É—â–µ–Ω –Ω–∞ 50051
‚ùå gRPC –º–æ–¥—É–ª—å Nginx: –û–¢–°–£–¢–°–¢–í–£–ï–¢
‚ùå grpc_pass –¥–∏—Ä–µ–∫—Ç–∏–≤–∞: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ùå gRPC –∑–∞–ø—Ä–æ—Å—ã: –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π gRPC –º–æ–¥—É–ª—è
2. –ò–ª–∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Nginx —Å `--with-http_grpc_module`
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É gRPC

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞):**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ gRPC —Å–µ—Ä–≤–µ—Ä—É (–ø–æ—Ä—Ç 50051) —á–µ—Ä–µ–∑ VPN/SSH —Ç—É–Ω–Ω–µ–ª—å
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è gRPC

---

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥—É–ª—å
nginx -V 2>&1 | grep grpc
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: --with-http_grpc_module

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo nginx -t

# 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
sudo systemctl reload nginx

# 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
python3 scripts/test_grpc_connection.py 20.63.24.187 443
```

---

**–°—Ç–∞—Ç—É—Å:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–æ–¥—É–ª—å grpc –≤ Nginx
