# –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫ –∏ –ø—Ä–æ–±–ª–µ–º –≤ –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º–µ AVF

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
2025-12-11

## –¶–µ–ª—å
–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫, —Ç–∞–π–º–∞—É—Ç–æ–≤, race conditions –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø–æ–ª–Ω–æ–º—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é —Ä–µ—á–∏.

---

## 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã

### 1.1 `_finalize_on_silence` (3.0 —Å–µ–∫—É–Ω–¥—ã)

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:1145`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
async def _finalize_on_silence(self, sid, timeout: float = 3.0):
    await asyncio.sleep(timeout)  # ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ñ–¥—ë—Ç 3 —Å–µ–∫—É–Ω–¥—ã
    # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç grpc_done –∏ buf_empty
    if grpc_done and buf_empty and not finalized:
        await self._avf_engine.stop_output()  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        await self.event_bus.publish("playback.completed", ...)
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**: –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `grpc.request_completed` (—Å—Ç—Ä–æ–∫–∞ 645)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ **–í–´–°–û–ö–ê–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –ï—Å–ª–∏ completion callback –æ—Ç AVFAudioEngine –Ω–µ –ø—Ä–∏—à—ë–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `grpc.request_completed`, `_finalize_on_silence` –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `stop_output()`.
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å completion callback**: –ï—Å–ª–∏ completion callback –ø—Ä–∏—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ `_finalize_on_silence` —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –≤–æ–∑–Ω–∏–∫–∞–µ—Ç race condition.
3. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**: `_finalize_on_silence` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**:
- –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 10-15 —Å–µ–∫—É–Ω–¥ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- –û—Ç–º–µ–Ω—è—Ç—å `_finalize_on_silence` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ completion callback

---

### 1.2 `WelcomeMessageIntegration._wait_for_playback_completion` (10.0 —Å–µ–∫—É–Ω–¥)

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/welcome_message_integration.py:289`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
await asyncio.wait_for(playback_completed, timeout=10.0)  # ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: 10 —Å–µ–∫—É–Ω–¥
except asyncio.TimeoutError:
    logger.warning("‚è±Ô∏è Timeout –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (10 —Å–µ–∫—É–Ω–¥)")
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–¢–∞–π–º–∞—É—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º**: –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (>10 —Å–µ–∫—É–Ω–¥) —Ç–∞–π–º–∞—É—Ç –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ.
2. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞**: –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è warning, –Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ**:
- –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –æ–∂–∏–¥–∞–Ω–∏—è

---

### 1.3 `_on_raw_audio` —Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è (duration_sec + 0.5 —Å–µ–∫—É–Ω–¥—ã)

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:896`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
max_wait_time = duration_sec + 0.5  # ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
while (time.time() - start_time) < max_wait_time:
    await asyncio.sleep(check_interval)  # 0.1 —Å–µ–∫—É–Ω–¥—ã
    if not self._avf_engine.is_output_active:
        # ‚ö†Ô∏è –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
        playback_interrupted = True
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è**: –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, AirPods), `is_output_active` –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å `False` –≤—Ä–µ–º–µ–Ω–Ω–æ, –Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å –ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
- –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–ø–∞—Å –≤—Ä–µ–º–µ–Ω–∏ –¥–æ `duration_sec + 2.0` –¥–ª—è —É—á—ë—Ç–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

---

## 2. Race conditions

### 2.1 `session_id` —Å–±—Ä–æ—Å –≤ `state_manager` vs completion callback

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: 
- `integration/integrations/input_processing_integration.py` (—Å–±—Ä–æ—Å session_id)
- `integration/integrations/speech_playback_integration.py:_on_avf_playback_completed` (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ session_id)

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# InputProcessingIntegration._on_grpc_completed
self.state_manager._reset_session("grpc_completed")  # ‚ö†Ô∏è –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç session_id

# SpeechPlaybackIntegration._on_avf_playback_completed (–ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
sid = self.state_manager.get_current_session_id()  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å None
if sid is None:
    # Fallback: –∏—â–µ–º –≤ _active_chunks
    sid = ...  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º _active_chunks
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ **–í–´–°–û–ö–ê–Ø** (—á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å**: `state_manager` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `session_id` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `grpc.request_completed`, –Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –µ—â—ë –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.
2. **Race condition**: –ï—Å–ª–∏ completion callback –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ `session_id`, –Ω–æ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ —á–∞–Ω–∫ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ `_active_chunks`, `session_id` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω.

**–†–µ—à–µ–Ω–∏–µ** (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_active_chunks` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è `session_id` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ `_avf_chunk_buffer` –µ—Å–ª–∏ `session_id` –Ω–µ –Ω–∞–π–¥–µ–Ω
- ‚ö†Ô∏è **TODO**: –û—Ç–ª–æ–∂–∏—Ç—å —Å–±—Ä–æ—Å `session_id` –≤ `state_manager` –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è `playback.completed`

---

### 2.2 Worker vs completion callback

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:1283`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# Worker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞–Ω–∫
if sid in self._active_chunks:
    await asyncio.sleep(0.1)  # ‚ö†Ô∏è –ñ–¥—ë—Ç completion callback
    continue

# Completion callback —É–¥–∞–ª—è–µ—Ç –∏–∑ _active_chunks
self._active_chunks.pop(sid, None)  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª—ë–Ω –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ worker
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **Window –¥–ª—è race condition**: –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π `if sid in self._active_chunks` –∏ `continue` –µ—Å—Ç—å –Ω–µ–±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ, –≥–¥–µ completion callback –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ `_active_chunks`.
2. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ**: –ï—Å–ª–∏ completion callback —É–¥–∞–ª–∏—Ç –∑–∞–ø–∏—Å—å –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ worker –≤—ã–ø–æ–ª–Ω–∏—Ç `continue`, worker –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç–æ—Ç –∂–µ —á–∞–Ω–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ `_active_chunks`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é `pop()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π

---

### 2.3 `_finalize_on_silence` vs completion callback

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: 
- `integration/integrations/speech_playback_integration.py:1145` (`_finalize_on_silence`)
- `integration/integrations/speech_playback_integration.py:1380` (`_on_avf_playback_completed`)

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# _finalize_on_silence –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ grpc.request_completed
await asyncio.sleep(3.0)
if grpc_done and buf_empty:
    await self._avf_engine.stop_output()  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    await self.event_bus.publish("playback.completed", ...)

# completion callback –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
def _on_avf_playback_completed(self, event):
    # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ _finalize_on_silence —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    await self.event_bus.publish("playback.completed", ...)  # ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ **–í–´–°–û–ö–ê–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `playback.completed`**: –ï—Å–ª–∏ completion callback –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ `_finalize_on_silence` —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª `playback.completed`, —Å–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã.
2. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞**: `_finalize_on_silence` –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ completion callback –µ—â—ë –Ω–µ –ø—Ä–∏—à—ë–ª.

**–†–µ—à–µ–Ω–∏–µ**:
- –û—Ç–º–µ–Ω—è—Ç—å `_finalize_on_silence` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ completion callback
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–ª–∞–≥ `_finalized_sessions` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `is_output_active` –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π

---

## 3. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

### 3.1 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (AVAudioEngineConfigurationChangeNotification)

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `modules/audio_avf/core/avf_audio_engine.py:_handle_output_device_change`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
def _handle_output_device_change(self, notification):
    # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å _reconnect_player_node –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if self._output_state not in (AudioState.STARTING, AudioState.RUNNING):
        await self._reconnect_player_node()  # ‚ö†Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç engine
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø** (—á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**: –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, AirPods), –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ `_output_state not in (STARTING, RUNNING)` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π.

**–†–µ—à–µ–Ω–∏–µ** (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `_output_state` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
- ‚ö†Ô∏è **TODO**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ `is_output_active`

---

### 3.2 `playback.cancelled` —Å–æ–±—ã—Ç–∏–µ

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:681`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
async def _on_unified_interrupt(self, event):
    # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
    if self._avf_engine:
        await self._avf_engine.stop_output()  # ‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü¢ **–ù–ò–ó–ö–ê–Ø** (–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Ctrl+N) - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
2. **–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º**: –≠—Ç–æ –Ω–µ –±–∞–≥, –∞ —Ñ–∏—á–∞.

---

### 3.3 Worker –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —á–∞–Ω–∫–æ–º

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:1298`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
if self._avf_engine.is_output_active:
    logger.warning("‚ö†Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —á–∞–Ω–∫–æ–º, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º")
    stop_success = await self._avf_engine.stop_output()  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞–Ω–∫
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —á–∞–Ω–∫–∞**: –ï—Å–ª–∏ completion callback –µ—â—ë –Ω–µ –ø—Ä–∏—à—ë–ª, –Ω–æ worker —É–∂–µ –ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫, —Ç–µ–∫—É—â–∏–π —á–∞–Ω–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω.
2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: Worker –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —á–∞–Ω–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `is_output_active`.

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `_active_chunks` –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- –ñ–¥–∞—Ç—å completion callback –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

---

## 4. –ü—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∏–∫–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### 4.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ `grpc_done` –∏ `buf_empty`

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:1171`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
if grpc_done and buf_empty and not finalized:
    # ‚ö†Ô∏è –ü—É–±–ª–∏–∫—É–µ—Ç playback.completed
    await self.event_bus.publish("playback.completed", ...)
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**: `buf_empty` –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å. –ê—É–¥–∏–æ –º–æ–∂–µ—Ç –µ—â—ë –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –∏–∑ –±—É—Ñ–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
2. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –ï—Å–ª–∏ `buf_empty=True`, –Ω–æ `is_output_active=True`, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π `playback.completed`
- –ñ–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ completion callback –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ `buf_empty`

---

### 4.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `integration/integrations/speech_playback_integration.py:1380`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
def _on_avf_playback_completed(self, event):
    # ‚ö†Ô∏è –ù–µ—Ç —è–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫
    grpc_done = self._grpc_done_sessions.get(sid, False)
    buf_empty = len(self._avf_chunk_buffer.get(sid, [])) == 0
    if grpc_done and buf_empty:
        # –ü—É–±–ª–∏–∫—É–µ—Ç playback.completed
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° **–°–†–ï–î–ù–Ø–Ø**

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–ù–µ—Ç —è–≤–Ω–æ–π –ø–æ–º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞**: gRPC –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —è–≤–Ω—ã–π —Ñ–ª–∞–≥ "–ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫". –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ `grpc.request_completed` –∏ `buf_empty`.
2. **Race condition**: –ï—Å–ª–∏ `grpc.request_completed` –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ —á–∞–Ω–∫–∏ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É—Ñ–µ—Ä, `buf_empty` –º–æ–∂–µ—Ç –±—ã—Ç—å `True` –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –ø–æ–º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞ –≤ gRPC –ø—Ä–æ—Ç–æ–∫–æ–ª–µ
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ —á–∞–Ω–∫–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ

---

## 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### 5.1 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ)

1. **–û—Ç–ª–æ–∂–∏—Ç—å —Å–±—Ä–æ—Å `session_id`**: –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å `session_id` –≤ `state_manager` –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è `playback.completed`.
2. **–û—Ç–º–µ–Ω—è—Ç—å `_finalize_on_silence`**: –û—Ç–º–µ–Ω—è—Ç—å –∑–∞–¥–∞—á—É `_finalize_on_silence` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ completion callback.
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ `is_output_active`**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –≤ `_finalize_on_silence`.

### 5.2 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–≤–∞–∂–Ω–æ)

1. **–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã**: –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç `_finalize_on_silence` –¥–æ 10-15 —Å–µ–∫—É–Ω–¥.
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è `_active_chunks`**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ `_active_chunks`.
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –≤ `_on_raw_audio`.

### 5.3 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

1. **–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç WelcomeMessage**: –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç `_wait_for_playback_completion` –¥–æ 30 —Å–µ–∫—É–Ω–¥.
2. **–Ø–≤–Ω–∞—è –ø–æ–º–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞**: –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –ø–æ–º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞ –≤ gRPC –ø—Ä–æ—Ç–æ–∫–æ–ª–µ.
3. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è race conditions.

---

## 6. –¢–∞–±–ª–∏—Ü–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫

| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å | –†–µ—à–µ–Ω–∏–µ |
|------------------|-------------|--------|---------|
| `_finalize_on_silence` —Ç–∞–π–º–∞—É—Ç 3s | üî¥ –í–´–°–û–ö–ê–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç, –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–∏ completion callback |
| `session_id` —Å–±—Ä–æ—Å | üî¥ –í–´–°–û–ö–ê–Ø | ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –û—Ç–ª–æ–∂–∏—Ç—å —Å–±—Ä–æ—Å –¥–æ `playback.completed` |
| `_finalize_on_silence` vs completion callback | üî¥ –í–´–°–û–ö–ê–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ç–º–µ–Ω—è—Ç—å `_finalize_on_silence` –ø—Ä–∏ completion callback |
| Worker vs completion callback | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Lock` |
| `WelcomeMessageIntegration` —Ç–∞–π–º–∞—É—Ç 10s | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 30s |
| `_on_raw_audio` —Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è | üü° –°–†–ï–î–ù–Ø–Ø | ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` |
| Worker –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–æ–≤–µ—Ä—è—Ç—å `_active_chunks` –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ `grpc_done` –∏ `buf_empty` | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_output_active` |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞ | üü° –°–†–ï–î–ù–Ø–Ø | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –ø–æ–º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞ |

---

## 7. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:
1. **–¢–∞–π–º–∞—É—Ç–∞–º–∏**: –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.
2. **Race conditions**: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –º–µ–∂–¥—É `_finalize_on_silence`, completion callback –∏ worker –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é —Å–æ–±—ã—Ç–∏–π –∏–ª–∏ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.
3. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å `session_id`**: `session_id` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**:
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 5.1 (–∫—Ä–∏—Ç–∏—á–Ω–æ)
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö (–¥–ª–∏–Ω–Ω—ã–µ –∞—É–¥–∏–æ, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è)
