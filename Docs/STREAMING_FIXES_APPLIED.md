# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ Race Condition –≤ `audio_callback` (–ö–†–ò–¢–ò–ß–ù–û)

**–ë—ã–ª–æ:**
```python
async def audio_callback(data: bytes, sample_rate: int, channels: int):
    # ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ self._use_streaming –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    if self._use_streaming and self._sf_recognizer is not None:
        # ...
```

**–°—Ç–∞–ª–æ:**
```python
# –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û —Å–æ–∑–¥–∞–Ω–∏—è callback
use_streaming = self._is_streaming_active()
sf_recognizer = self._sf_recognizer if use_streaming else None

async def audio_callback(data: bytes, sample_rate: int, channels: int):
    # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (thread-safe)
    if use_streaming and sf_recognizer is not None:
        # ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –≥–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.

---

### 2. ‚úÖ –î–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ (–ö–†–ò–¢–ò–ß–ù–û)

**–ë—ã–ª–æ:**
```python
if self._use_streaming and self._sf_recognizer is not None:
    success = self._sf_recognizer.append_audio(data, sample_rate, channels)
    if success:
        # –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Å—Ç—Ä–∏–º–∏–Ω–≥
    else:
        # ‚ùå –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä, –Ω–æ —Å—Ç—Ä–∏–º–∏–Ω–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω
        self._audio_buffer.append(data)
```

**–°—Ç–∞–ª–æ:**
```python
if use_streaming and sf_recognizer is not None:
    success = sf_recognizer.append_audio(data, sample_rate, channels)
    if success:
        # –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Å—Ç—Ä–∏–º–∏–Ω–≥
    else:
        # ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–∏–º–∏–Ω–≥ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ batch
        logger.warning("‚ö†Ô∏è [SFSpeech] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∞–Ω–∫–∞, –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–∏–º–∏–Ω–≥ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ batch")
        self._use_streaming = False  # –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞–Ω–∫–æ–≤
        self._audio_buffer.append(data)  # –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä –¥–ª—è batch
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –æ–Ω –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –∏ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —á–∞–Ω–∫–∏ –∏–¥—É—Ç –≤ batch.

---

### 3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É—Ñ–µ—Ä–∞ –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (–í–ê–ñ–ù–û)

**–ë—ã–ª–æ:**
```python
if self._use_streaming and self._sf_recognizer is not None:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
    # ...
elif self._audio_buffer:  # ‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, –µ—Å–ª–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
    # Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

**–°—Ç–∞–ª–æ:**
```python
streaming_processed = False
if self._is_streaming_active():
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
    if final_text:
        streaming_processed = True
    # ...

# ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—É—Ñ–µ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–º –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞)
if self._audio_buffer and not streaming_processed:
    # Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—É—Ñ–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö).

---

### 4. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ (–£–õ–£–ß–®–ï–ù–ò–ï)

**–ë—ã–ª–æ:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 8 —Ä–∞–∑ –≤ –∫–æ–¥–µ
if self._use_streaming and self._sf_recognizer is not None:
    # ...
```

**–°—Ç–∞–ª–æ:**
```python
# –•–µ–ª–ø–µ—Ä-–º–µ—Ç–æ–¥
def _is_streaming_active(self) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (thread-safe)"""
    return self._use_streaming and self._sf_recognizer is not None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
if self._is_streaming_active():
    # ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ–¥ —Å—Ç–∞–ª —á–∏—â–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.

---

### 5. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –±—É—Ñ–µ—Ä–∞ (–£–õ–£–ß–®–ï–ù–ò–ï)

**–ë—ã–ª–æ:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
self._audio_buffer = []
self._audio_buffer_sample_rate = None
self._audio_buffer_channels = None
```

**–°—Ç–∞–ª–æ:**
```python
# –•–µ–ª–ø–µ—Ä-–º–µ—Ç–æ–¥
def _clear_audio_buffer(self) -> None:
    """–û—á–∏—Å—Ç–∫–∞ –∞—É–¥–∏–æ –±—É—Ñ–µ—Ä–∞"""
    self._audio_buffer = []
    self._audio_buffer_sample_rate = None
    self._audio_buffer_channels = None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
self._clear_audio_buffer()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—á–∏—Å—Ç–∫–∏.

---

### 6. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (–í–ê–ñ–ù–û)

**–ë—ã–ª–æ:**
```python
def on_streaming_error(error: str):
    logger.error(f"‚ùå [SFSpeech] –û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞: {error}")
    # ‚ùå –ù–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥
```

**–°—Ç–∞–ª–æ:**
```python
def on_streaming_error(error: str):
    logger.error(f"‚ùå [SFSpeech] –û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞: {error}")
    # ‚úÖ –û—Ç–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥ –≥–ª–æ–±–∞–ª—å–Ω–æ
    self._use_streaming = False
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|---|----------|--------|-------------|
| 1 | Race condition –≤ `audio_callback` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üî¥ –í—ã—Å–æ–∫–∞—è |
| 2 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ `_use_streaming` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üü° –°—Ä–µ–¥–Ω—è—è |
| 3 | –î–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üî¥ –í—ã—Å–æ–∫–∞—è |
| 4 | –ò–∑–º–µ–Ω–µ–Ω–∏–µ `_use_streaming` –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üî¥ –í—ã—Å–æ–∫–∞—è |
| 5 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –±—É—Ñ–µ—Ä–∞ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üü° –°—Ä–µ–¥–Ω—è—è |
| 6 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É—Ñ–µ—Ä–∞ –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | üü° –°—Ä–µ–¥–Ω—è—è |

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `audio_callback`
- ‚úÖ Thread-safe –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ —Ö–µ–ª–ø–µ—Ä-–º–µ—Ç–æ–¥—ã

### –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ù–µ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –¥–∞–∂–µ –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞

### –ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ï–¥–∏–Ω—ã–µ —Ç–æ—á–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å

---

## üß™ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

1. **–¢–µ—Å—Ç race condition:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å
   - –í–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥ (—Å–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —á–∞–Ω–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–¢–µ—Å—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
   - –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É `append_audio` (–≤–µ—Ä–Ω—É—Ç—å False)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞—É–¥–∏–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã

3. **–¢–µ—Å—Ç fallback:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
   - –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ batch –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

4. **–¢–µ—Å—Ç –±—É—Ñ–µ—Ä–∞ –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
   - –î–æ–±–∞–≤–∏—Ç—å —á–∞—Å—Ç—å –∞—É–¥–∏–æ –≤ –±—É—Ñ–µ—Ä (—Å–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±—É—Ñ–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞



