# üìö –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ race conditions

**–¶–ï–õ–¨**: –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞, –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è/–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤/race conditions –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã.

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-XX  
**–í–µ—Ä—Å–∏—è**: 1.0

---

## üîç –ü—Ä–∏–º–µ—Ä 1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ is_bluetooth_device

### –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: –§—É–Ω–∫—Ü–∏—è `is_bluetooth_device()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞**:
1. `modules/voice_recognition/core/speech_recognizer.py:1364` ‚Äî `_is_bluetooth_device()` (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥)
2. `modules/speech_playback/core/player.py:1669` ‚Äî `_is_bluetooth_device()` (–º–µ—Ç–æ–¥ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞)
3. `modules/audio_system/utils/device_utils.py` ‚Äî `is_bluetooth_device()` (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

**–†–∞–∑–ª–∏—á–∏—è –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö**:
- `speech_recognizer.py`: `("bluetooth", "airpods", "beats", "headset", "earbud")`
- `player.py`: `("bluetooth", "airpods", "airpod", "beats", "headset", "earbud")` (–µ—Å—Ç—å "airpod" –±–µ–∑ 's')
- `device_utils.py`: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

### –ö–∞–∫ DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –±—ã –ø—Ä–æ–±–ª–µ–º—É

**–≠—Ç–∞–ø 1.1: –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**

```markdown
- [x] **–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É**: –í—ã–ø–æ–ª–Ω–µ–Ω –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
  - –ù–∞–π–¥–µ–Ω–æ: device_utils.is_bluetooth_device() –≤ modules/audio_system/utils/device_utils.py
  - –ù–∞–π–¥–µ–Ω–æ: _is_bluetooth_device() –≤ speech_recognizer.py –∏ player.py (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
  
- [x] **–°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç**: –°–æ—Å—Ç–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–µ—Å—Ç —Å is_bluetooth_device
- [x] **–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π**: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–∞–π–¥–µ–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è.

**–≠—Ç–∞–ø 1.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏**

```markdown
- [x] **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π**: –ù–∞–π–¥–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–æ—Ö–æ–∂–µ–π –ª–æ–≥–∏–∫–æ–π –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
- [x] **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã**: –ï—Å—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è device_utils.is_bluetooth_device()
```

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.

---

## ‚öîÔ∏è –ü—Ä–∏–º–µ—Ä 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É MicrophoneStateManager –∏ ApplicationStateManager

### –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: –î–≤–∞ –º–µ—Å—Ç–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞**:
1. `MicrophoneStateManager._set_state()` ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
2. `ApplicationStateManager.set_microphone_state()` ‚Äî —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç**:
```python
# –í MicrophoneStateManager:
self._state = "opening"

# –í ApplicationStateManager:
self._mic_state = "opening"  # –ö–æ–Ω—Ñ–ª–∏–∫—Ç! –î–≤–∞ –º–µ—Å—Ç–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
```

### –ö–∞–∫ DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –±—ã –ø—Ä–æ–±–ª–µ–º—É

**–≠—Ç–∞–ø 2.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º**

```markdown
- [x] **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π**: –ï—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π (–¥–≤–∞ –º–µ—Å—Ç–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º)?
  - –ù–∞–π–¥–µ–Ω–æ: MicrophoneStateManager –∏ ApplicationStateManager —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
  
- [x] **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω –ª–∏ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞?
  - –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: MicrophoneStateManager
  - ApplicationStateManager –¥–æ–ª–∂–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è EventBus
```

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ MicrophoneStateManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å ApplicationStateManager —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è EventBus.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω, –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.

---

## üèÉ –ü—Ä–∏–º–µ—Ä 3: Race condition –≤ _google_audio_chunks

### –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: `_google_audio_chunks` –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∏–∑ callback –ø–æ—Ç–æ–∫–∞ –∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ async –ø–æ—Ç–æ–∫–∞ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞**:
1. `integration/integrations/voice_recognition_integration.py:782` ‚Äî callback –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
2. `integration/integrations/voice_recognition_integration.py:770` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π async –ø–æ—Ç–æ–∫ —á–∏—Ç–∞–µ—Ç/–æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**Race condition**:
```python
# –ü–æ—Ç–æ–∫ 1 (callback –æ—Ç listen_in_background):
def callback(recognizer, audio):
    self._google_audio_chunks.append(audio)  # ‚ùå –ë–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

# –ü–æ—Ç–æ–∫ 2 (–æ—Å–Ω–æ–≤–Ω–æ–π async):
self._google_audio_chunks = []  # ‚ùå –ë–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (race condition!)
if self._google_audio_chunks and len(self._google_audio_chunks) > 0:
    self._google_audio_data = self._google_audio_chunks[-1]
```

### –ö–∞–∫ DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –±—ã –ø—Ä–æ–±–ª–µ–º—É

**–≠—Ç–∞–ø 3.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ thread-safety**

```markdown
- [x] **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø**: –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤?
  - –ù–∞–π–¥–µ–Ω–æ: _google_audio_chunks –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ callback –ø–æ—Ç–æ–∫–∞ –∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ async –ø–æ—Ç–æ–∫–∞
  
- [x] **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞?
  - –ù–∞–π–¥–µ–Ω–æ: –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –¥–ª—è _google_audio_chunks
  
- [x] **–†–∏—Å–∫ race condition**: –ï—Å—Ç—å –ª–∏ —Ä–∏—Å–∫ race condition?
  - –ù–∞–π–¥–µ–Ω–æ: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ - –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
```

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å `threading.Lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ `_google_audio_chunks`.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Race condition –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞, –¥–æ—Å—Ç—É–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥**:
```python
# ‚úÖ –•–û–†–û–®–û: –î–æ—Å—Ç—É–ø —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
self._google_audio_chunks_lock = threading.Lock()

def callback(recognizer, audio):
    with self._google_audio_chunks_lock:
        self._google_audio_chunks.append(audio)

async def process_audio():
    with self._google_audio_chunks_lock:
        if self._google_audio_chunks:
            self._google_audio_data = self._google_audio_chunks[-1]
        self._google_audio_chunks = []
```

---

## üîÑ –ü—Ä–∏–º–µ—Ä 4: –î—É–±–ª–∏–∫–∞—Ç—ã async –∑–∞–¥–∞—á

### –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: –°–æ–∑–¥–∞–Ω–∏–µ `asyncio.create_task()` –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º –∑–∞–¥–∞—á.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞**:
1. `integration/integrations/welcome_message_integration.py:245,279` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ Future –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
2. `integration/integrations/hardware_id_integration.py:151,168,184` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ create_task –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
3. `integration/integrations/screenshot_capture_integration.py:464,517,559,562,622` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ create_task –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# ‚ùå –ü–õ–û–•–û: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
async def start_listening():
    asyncio.create_task(self._listen_loop())  # –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã!
```

### –ö–∞–∫ DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –±—ã –ø—Ä–æ–±–ª–µ–º—É

**–≠—Ç–∞–ø 3.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ async/await –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**

```markdown
- [x] **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á**: –û—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –ª–∏ –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ asyncio.create_task()?
  - –ù–∞–π–¥–µ–Ω–æ: –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –≤ start_listening()
  
- [x] **–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á**: –û—Ç–º–µ–Ω—è—é—Ç—Å—è –ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö?
  - –ù–∞–π–¥–µ–Ω–æ: –ù–µ—Ç –æ—Ç–º–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞—á
  
- [x] **–†–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**: –ï—Å—Ç—å –ª–∏ —Ä–∏—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–¥–∞—á?
  - –ù–∞–π–¥–µ–Ω–æ: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
```

**–†–µ—à–µ–Ω–∏–µ**: –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏ –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–¥–∞—á –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã, –∑–∞–¥–∞—á–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥**:
```python
# ‚úÖ –•–û–†–û–®–û: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
self._listen_task: Optional[asyncio.Task] = None

async def start_listening():
    if self._listen_task and not self._listen_task.done():
        self._listen_task.cancel()
        try:
            await self._listen_task
        except asyncio.CancelledError:
            pass
    self._listen_task = asyncio.create_task(self._listen_loop())
```

---

## üîÑ –ü—Ä–∏–º–µ—Ä 5: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop –≤ run_coroutine_threadsafe

### –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: `run_coroutine_threadsafe` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞**:
1. `modules/audio_avf/core/avf_audio_engine.py` ‚Äî callback –∏–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# ‚ùå –ü–õ–û–•–û: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ event loop
def callback_from_thread():
    loop = asyncio.new_event_loop()
    loop.run_until_complete(self._publish_event())
```

### –ö–∞–∫ DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –±—ã –ø—Ä–æ–±–ª–µ–º—É

**–≠—Ç–∞–ø 3.3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è async –∏ threading**

```markdown
- [x] **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ asyncio.run_coroutine_threadsafe() –¥–ª—è –≤—ã–∑–æ–≤–∞ async –º–µ—Ç–æ–¥–æ–≤ –∏–∑ –ø–æ—Ç–æ–∫–æ–≤?
  - –ù–∞–π–¥–µ–Ω–æ: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ event loop)
  
- [x] **Event loops**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop –¥–ª—è run_coroutine_threadsafe?
  - –ù–∞–π–¥–µ–Ω–æ: –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π event loop –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–∑ EventBus
```

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å event loop –∏–∑ EventBus —á–µ—Ä–µ–∑ `run_coroutine_threadsafe`.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ø—Ä–æ–±–ª–µ–º—ã —Å async/threading –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥**:
```python
# ‚úÖ –•–û–†–û–®–û: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ event loop –∏–∑ EventBus
def callback_from_thread():
    loop = self.event_bus._loop  # Event loop –∏–∑ EventBus
    asyncio.run_coroutine_threadsafe(self._publish_event(), loop)
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–º–µ—Ä–æ–≤

| –ü—Ä–∏–º–µ—Ä | –ü—Ä–æ–±–ª–µ–º–∞ | –ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç—Å—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|--------|----------|---------------------|-----------|
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ is_bluetooth_device | –§—É–Ω–∫—Ü–∏—è –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 3 –º–µ—Å—Ç–∞—Ö | –≠—Ç–∞–ø 1.1-1.2: –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ |
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π | –î–≤–∞ –º–µ—Å—Ç–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º | –≠—Ç–∞–ø 2.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π | –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã |
| Race condition –≤ _google_audio_chunks | –î–æ—Å—Ç—É–ø –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ | –≠—Ç–∞–ø 3.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ thread-safety | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ |
| –î—É–±–ª–∏–∫–∞—Ç—ã async –∑–∞–¥–∞—á | –ó–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è | –≠—Ç–∞–ø 3.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ async/await –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ |
| –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π event loop | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ event loop | –≠—Ç–∞–ø 3.3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è async –∏ threading | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ event loop |

---

## ‚úÖ –í—ã–≤–æ–¥—ã

**–ß—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md**:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**: –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ –∫–æ–¥–∞
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–µ–Ω/—Å–æ—Å—Ç–æ—è–Ω–∏–π/–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
3. **Race conditions**: –ü—Ä–æ–≤–µ—Ä–∫–∞ thread-safety –∏ async/await –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞.

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `DUPLICATE_CONFLICT_RACE_PREVENTION_CHECKLIST.md` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ü–Ø–¢–´–ô —ç—Ç–∞–ø)
- `CODE_CONFLICTS_AND_RACE_CONDITIONS_ANALYSIS.md` ‚Äî –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ race conditions
- `PLANNING_PROCESS_ORDER.md` ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —á–µ–∫-–ª–∏—Å—Ç–æ–≤

---

**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-XX



