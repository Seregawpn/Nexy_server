# Спецификация фаз запуска иконки меню-бара

## Цель

Устранить гонку старта иконки меню-бара при холодном запуске (после перезагрузки) через формализацию фаз запуска, критериев готовности и телеметрии.

---

## ОБНОВЛЕНИЕ 2025-11-05: Реализованное решение

### Проблема решена через:

1. **Изменение порядка запуска интеграций**
   - `tray` перемещён на 2-е место (сразу после `instance_manager`)
   - Блокирующие операции (`first_run_permissions`) теперь запускаются ПОСЛЕ иконки

2. **Gate-механизм**
   - Блокирующие интеграции ждут события `tray.integration_ready` (до 10 сек)
   - Координатор отслеживает `_tray_ready` флаг

3. **Улучшенное логирование метрик**
   - `[TRAY_METRICS] tray.will_init`, `tray.retry`, `tray.ready`
   - `[TRAY_GATE]` логи для отслеживания блокировок

4. **Удалены избыточные задержки**
   - Из `activate_nsapplication_for_menu_bar()` убраны `time.sleep()` (~1 сек)
   - Retry-логика встроена в TrayControllerIntegration (3 попытки)

**Результат**: Иконка стабильно появляется в течение 1-5 секунд даже на холодном старте.

См. детали в разделе "История изменений" внизу документа.

---

## Проблема (исходная)

При холодном запуске (после перезагрузки) системный сервис статус-бара может быть не готов обслужить запрос на создание NSStatusItem, что приводит к отсутствию иконки в меню-баре. При повторном запуске или запуске из терминала система уже "тёплая" и иконка появляется корректно.

**Корневая причина**: Попытка создать иконку до фактической готовности системного сервиса статус-бара, отсутствие проверки успешности отображения, параллельный запуск тяжёлых операций.

---

## Фазы запуска

### Фаза 0 — Boot (Базовая инициализация)

**Цель**: Минимальная инициализация приложения без тяжёлых операций и TCC-взаимодействий.

**Действия**:
- Активация NSApplication (`activate_nsapplication_for_menu_bar()`)
- Создание core компонентов (EventBus, StateManager, ErrorHandler)
- Создание интеграций (без запуска)
- Инициализация интеграций (без запуска)

**Критерий завершения**: Все интеграции созданы и инициализированы, но не запущены.

**Ограничения**:
- ❌ Нет запросов разрешений (TCC)
- ❌ Нет сетевых соединений
- ❌ Нет аудио-инициализации
- ❌ Нет проверок обновлений

**Время**: ≤ 2 сек (без блокирующих операций)

---

### Фаза 1 — StatusItem Ready (Готовность иконки)

**Цель**: Создать и отобразить иконку в меню-баре с проверкой успешности.

**Действия**:
1. Запуск `TrayControllerIntegration.start()`
2. Создание иконки через `MacOSTrayIcon.create_icon_file()`
3. Создание `rumps.App` через `MacOSTrayMenu.create_app()`
4. Установка иконки (`app.icon = icon_path`)
5. **Проверка успешности отображения** (см. критерии ниже)
6. При неудаче — повторные попытки с экспоненциальным backoff

**Критерии готовности** (все должны быть выполнены):
- ✅ **Нулевые XPC-ошибки** вокруг сцены/статус-бар-сервиса после последней попытки
- ✅ **Зафиксированное событие "иконка установлена"** в телеметрии (`tray.icon_ready`)
- ✅ **Нет автозавершения процесса** в 3–5 сек после появления иконки
- ✅ **Control Center отмечает активность бандла** без повторных "No matching scene to invalidate…"

**Повторные попытки**:
- Максимум попыток: 5
- Экспоненциальный backoff: 0.5 сек → 1.0 сек → 2.0 сек → 4.0 сек → 8.0 сек
- Суммарный тайм-кап: ≤ 15 сек
- После тайм-капа: фолбэк-UX (системное уведомление + кнопка перезапуска)

**Флаг готовности**: `status_item_ready = True` (устанавливается после успешной проверки)

**Время**: 
- Медиана: ≤ 2–3 сек
- 95-й перцентиль: ≤ 6–8 сек
- Максимум (с ретраями): ≤ 15 сек

---

### Фаза 2 — Deferred Heavy (Отложенные тяжёлые операции)

**Цель**: Запустить тяжёлые интеграции только после успешного появления иконки.

**Условие запуска**: `status_item_ready = True`

**Действия** (в порядке приоритета):
1. Запросы разрешений (FirstRunPermissions, если требуется)
2. Сетевые соединения (NetworkManager, gRPC)
3. Аудио-инициализация (VoiceRecognition, SpeechPlayback)
4. Проверки обновлений (Updater)
5. Остальные интеграции (InputProcessing, ScreenshotCapture, etc.)

**Feature Flag**: `defer_heavy_until_status_ready` (по умолчанию: `true`)

**Ограничения**:
- ❌ Не запускаются до `status_item_ready = True`
- ❌ Не запускаются при неудаче отображения иконки (с фолбэк-UX)

**Время**: Зависит от количества интеграций (обычно 5–10 сек)

---

### Фаза 3 — Normal Run (Обычная работа)

**Цель**: Стандартная работа приложения с полным функционалом.

**Действия**:
- Обработка событий через EventBus
- Переходы между режимами (SLEEPING → LISTENING → PROCESSING)
- Обработка пользовательского ввода
- Сетевое взаимодействие
- Все остальные операции

**Критерий завершения**: Приложение работает в штатном режиме.

**Время**: Не ограничено

---

## Телеметрия

### Метки времени

Записываются следующие метки времени для диагностики:

- **t0 = app_launch**: Запуск приложения (`main()`)
- **t1 = status_request**: Первая попытка установки иконки (`TrayControllerIntegration.start()`)
- **t2 = status_ready**: Фактическое появление иконки (после успешной проверки)
- **t3 = heavy_start**: Запуск тяжёлых интеграций (`SimpleModuleCoordinator.start()` — фаза 2)

### Метрики

- **Δ1 = t2 − t0**: Время до появления иконки (cold start latency)
- **Δ2 = t3 − t2**: Задержка между появлением иконки и запуском тяжёлых операций
- **retry_count**: Количество повторных попыток установки иконки
- **final_status**: Финальный статус (`OK` / `RETRY_OK` / `FAIL`)

### Формат логов

```
[tray.startup] t0=app_launch timestamp=2025-01-15T10:30:45.123Z
[tray.startup] t1=status_request timestamp=2025-01-15T10:30:45.456Z attempt=1
[tray.startup] t2=status_ready timestamp=2025-01-15T10:30:47.789Z retry_count=2 final_status=RETRY_OK
[tray.startup] t3=heavy_start timestamp=2025-01-15T10:30:47.890Z delta1_ms=2666 delta2_ms=101
[tray.startup] summary delta1_ms=2666 delta2_ms=101 retry_count=2 final_status=RETRY_OK
```

### События EventBus

- `tray.startup.phase_0_boot` — завершение фазы 0
- `tray.startup.phase_1_status_request` — начало фазы 1 (первая попытка)
- `tray.startup.phase_1_retry` — повторная попытка (payload: `attempt`, `backoff_sec`)
- `tray.startup.phase_1_status_ready` — успешное завершение фазы 1 (payload: `retry_count`, `duration_ms`)
- `tray.startup.phase_1_failed` — неудача фазы 1 (payload: `retry_count`, `total_duration_ms`)
- `tray.startup.phase_2_heavy_start` — начало фазы 2
- `tray.startup.phase_2_heavy_complete` — завершение фазы 2

---

## Критерии готовности иконки

### Проверка 1: XPC-ошибки

**Метод**: Мониторинг системных логов на наличие XPC-ошибок, связанных со статус-баром.

**Критерий**: Нет ошибок вида:
- `Error acquiring assertion: ...`
- `Failed to acquire NSStatusItem: ...`
- `NSStatusBar: failed to insert item: ...`

**Время проверки**: 1 сек после установки иконки

---

### Проверка 2: Событие "иконка установлена"

**Метод**: Публикация события `tray.icon_ready` после успешной установки иконки.

**Критерий**: Событие опубликовано и получено хотя бы одним подписчиком.

**Payload**:
```yaml
{
  "timestamp": "2025-01-15T10:30:47.789Z",
  "icon_path": "/tmp/nexy_icon_12345.png",
  "attempt": 2,
  "duration_ms": 2333
}
```

---

### Проверка 3: Отсутствие автозавершения процесса

**Метод**: Мониторинг процесса приложения в течение 3–5 сек после установки иконки.

**Критерий**: Процесс не завершился автоматически в течение 5 сек после установки иконки.

**Проверка**: Через `ps` или через обработчик сигналов

---

### Проверка 4: Control Center отмечает активность

**Метод**: Мониторинг системных логов на активность бандла в Control Center.

**Критерий**: Нет повторных ошибок вида:
- `No matching scene to invalidate...`
- `SystemStatus: failed to attribute...`

**Время проверки**: 2 сек после установки иконки

---

## Матрица тестов

### Тест 1: Холодный старт после перезагрузки

**Условия**:
- macOS перезагружен
- Приложение запущено через `open -a Nexy` или через Applications

**Ожидаемый результат**:
- Δ1 ≤ 10 сек (с ретраями)
- `final_status = OK` или `RETRY_OK`
- `retry_count ≤ 3` (для здоровой системы)
- Нет XPC-ошибок после появления иконки
- Процесс не завершается в первые 5 сек

**Метрики**:
- Δ1 медиана ≤ 2–3 сек
- Δ1 95-й перцентиль ≤ 6–8 сек
- Δ2 ≥ 100 мс (тяжёлые операции после иконки)

---

### Тест 2: Холодный старт + сразу всплывают разрешения

**Условия**:
- macOS перезагружен
- Первый запуск приложения (first_run = true)
- Разрешения запрашиваются сразу после появления иконки

**Ожидаемый результат**:
- Δ1 ≤ 10 сек (с ретраями)
- Иконка появляется **ДО** запросов разрешений
- Δ2 ≥ 100 мс (разрешения после иконки)
- Нет конфликтов между появлением иконки и диалогами разрешений

**Метрики**:
- Δ1 ≤ 10 сек
- Δ2 ≥ 100 мс

---

### Тест 3: Старт как Login Item/LaunchAgent

**Условия**:
- Приложение добавлено в Login Items
- Автозапуск при входе в систему

**Ожидаемый результат**:
- Δ1 ≤ 15 сек (увеличенный тайм-кап для старых Mac)
- `final_status = OK` или `RETRY_OK`
- Нет конфликтов с другими Login Items

**Метрики**:
- Δ1 ≤ 15 сек
- `retry_count ≤ 5`

---

### Тест 4: Отключённая сеть

**Условия**:
- Сеть отключена (Wi-Fi выключен, Ethernet отключён)
- Обновления/телеметрия не могут подключиться

**Ожидаемый результат**:
- Δ1 ≤ 10 сек (с ретраями)
- Иконка появляется независимо от сетевого статуса
- Тяжёлые операции (обновления, сеть) не блокируют появление иконки

**Метрики**:
- Δ1 ≤ 10 сек
- Δ2 ≥ 100 мс

---

### Тест 5: Несколько мониторов/Spaces

**Условия**:
- Несколько мониторов подключено
- Несколько Spaces создано
- Автоскрытие меню-бара включено

**Ожидаемый результат**:
- Δ1 ≤ 10 сек (с ретраями)
- Иконка появляется на основном мониторе
- Нет конфликтов с Spaces

**Метрики**:
- Δ1 ≤ 10 сек
- `final_status = OK` или `RETRY_OK`

---

### Тест 6: VoiceOver активен

**Условия**:
- VoiceOver включен
- Accessibility API активен

**Ожидаемый результат**:
- Δ1 ≤ 10 сек (с ретраями)
- Иконка появляется независимо от VoiceOver
- Нет конфликтов с Accessibility событиями

**Метрики**:
- Δ1 ≤ 10 сек
- `final_status = OK` или `RETRY_OK`

---

## Фолбэк-UX при неудаче

Если иконка не появилась после всех повторных попыток (тайм-кап 15 сек):

### Системное уведомление

```
Title: Nexy запущен
Message: Приложение запущено, но иконка не появилась в меню-баре. 
Перезапустите приложение для корректного отображения.
Subtitle: Рекомендуется перезапуск
```

### Кнопка перезапуска

В уведомлении должна быть кнопка "Перезапустить", которая:
1. Закрывает текущий процесс
2. Перезапускает приложение через `open -a Nexy`

### Логирование

```
[tray.startup] FAILED after 15s retry_count=5 final_status=FAIL
[tray.startup] Fallback UX: system notification sent
[tray.startup] User action: restart requested
```

---

## Конфигурация

### Feature Flag: `defer_heavy_until_status_ready`

**Расположение**: `config/unified_config.yaml`

**Раздел**:
```yaml
tray_controller:
  enabled: true
  defer_heavy_until_status_ready: true  # Отложить тяжёлые операции до появления иконки
  status_ready_timeout_sec: 15.0        # Тайм-кап для появления иконки
  retry_backoff_initial_sec: 0.5       # Начальная задержка для ретраев
  retry_backoff_max_sec: 8.0            # Максимальная задержка для ретраев
  retry_max_attempts: 5                 # Максимум попыток
```

### Переменные окружения

- `NEXY_DISABLE_TRAY` — отключить трей полностью (для headless режима)
- `NEXY_TRAY_DEBUG` — включить детальное логирование трея

---

## Definition of Done

### Метрики успеха

- **На 20 последовательных холодных стартах**:
  - 100% появлений иконки ≤ 10 сек
  - 0 XPC-ошибок после появления иконки
  - 0 преждевременных завершений процесса в первые 5 сек после появления иконки

- **Статистика**:
  - Δ1 медиана ≤ 2–3 сек
  - Δ1 95-й перцентиль ≤ 6–8 сек
  - Доля `RETRY_OK` ≤ 10% на здоровой системе
  - Доля `FAIL` = 0%

### Логирование

- Все метки времени (t0, t1, t2, t3) записываются в лог
- Счётчик ретраев и финальный статус записываются в лог
- События EventBus публикуются для всех фаз

### Тестирование

- Все 6 тестовых сценариев пройдены успешно
- Ручная проверка на холодном старте после перезагрузки
- Ручная проверка с различными условиями (сеть, мониторы, VoiceOver)

---

## Дополнительные проверки

### Частые "невидимые" причины

1. **App Translocation/карантин**:
   - Приложение должно быть в `/Applications` (без карантина)
   - Проверка: `xattr -l /Applications/Nexy.app` не содержит `quarantine`

2. **Режим "только меню-бар"**:
   - Зафиксирован с самого старта (без переключений по ходу)
   - Проверка: `NSApplicationActivationPolicyAccessory` установлен до создания `rumps.App`

3. **Скрытая логика "выходим если X не получилось"**:
   - Нет логики автозавершения в первые секунды
   - Проверка: код не содержит `sys.exit()` или `os._exit()` в первых 5 сек

4. **Первые запросы прав**:
   - Не инициируются до `status_item_ready = True`
   - Проверка: `FirstRunPermissionsIntegration.start()` вызывается только после `tray.startup.phase_1_status_ready`

---

## Связь с архитектурой

### Инварианты

- **Фазы запуска формализованы** и не должны нарушаться
- **Критерии готовности** должны быть проверены перед переходом к следующей фазе
- **Тяжёлые операции** не запускаются до `status_item_ready = True`

### Интеграция с SimpleModuleCoordinator

- `SimpleModuleCoordinator.start()` должен проверять `status_item_ready` перед запуском тяжёлых интеграций
- Порядок запуска интеграций должен соответствовать фазам (см. раздел "Фазы запуска")

### Интеграция с TrayControllerIntegration

- `TrayControllerIntegration.start()` должен реализовать проверку готовности иконки
- Повторные попытки должны быть реализованы с экспоненциальным backoff
- Телеметрия должна записываться для всех попыток

---

## Миграция и обратная совместимость

### Постепенный роллаут

- Feature flag `defer_heavy_until_status_ready` позволяет постепенно включать новое поведение
- Начало: 1% пользователей → 25% → 50% → 100%

### Обратная совместимость

- При `defer_heavy_until_status_ready = false` поведение остаётся как раньше (без проверки готовности)
- Старые версии приложения продолжают работать без изменений

---

## Риски и митигация

### Риск 1: Слишком большой фикс-слип

**Проблема**: Задержка замедляет старт приложения.

**Митигация**: Использовать проверку готовности вместо фиксированных задержек, минимальная базовая задержка (0.5 сек) только для первой попытки.

---

### Риск 2: Другая подсистема всё равно лезет вперёд

**Проблема**: Например, авто-апдейтер запускается до появления иконки.

**Митигация**: Feature flag `defer_heavy_until_status_ready` блокирует запуск тяжёлых интеграций до `status_item_ready = True`.

---

### Риск 3: Редкие машины с долгим прогревом

**Проблема**: Старые Mac, много Login Items — система долго инициализируется.

**Митигация**: Увеличенный верхний лимит backoff до 15 сек, логирование "ретраи >N" как предупреждение.

---

### Риск 4: Непредвиденный фейл иконки

**Проблема**: Иконка не появилась после всех попыток.

**Митигация**: Фолбэк-UX (системное уведомление + кнопка перезапуска) для редких случаев.

---

## Заключение

Этот документ формализует решение проблемы гонки старта иконки меню-бара через:

1. **Формализацию фаз запуска** (Boot → StatusItem Ready → Deferred Heavy → Normal Run)
2. **Критерии готовности иконки** (XPC-ошибки, событие, отсутствие автозавершения, Control Center)
3. **Телеметрию** (метки времени, метрики, события EventBus)
4. **Матрицу тестов** (6 сценариев с ожидаемыми результатами)
5. **Фолбэк-UX** (системное уведомление при неудаче)
6. **Feature flags и конфигурацию** (для постепенного роллаута)

С этим подходом гонка старта закрывается без привязки к "магическим" задержкам, и получается воспроизводимая стабильность.

---

## История изменений

### 2025-11-05: Реализовано решение проблемы race condition

#### Проблема
При "холодном" старте (после перезагрузки) иконка в меню-баре не появлялась, хотя при повторных запусках всё работало. Причина - race condition: tray запускался 5-м по счёту, после блокирующих операций (first_run_permissions), когда системный статус-бар мог быть ещё не готов.

#### Решение

**1. Изменён порядок запуска интеграций** (`simple_module_coordinator.py:547-567`)

Было:
```
1. instance_manager
2. hardware_id
3. first_run_permissions (блокирующий!)
4. permission_restart
5. tray (← слишком поздно!)
...
```

Стало:
```
1. instance_manager (критический блокирующий)
2. tray (← СРАЗУ после критической проверки!)
3. hardware_id
4. first_run_permissions (теперь ПОСЛЕ иконки)
5. permission_restart
...
```

**2. Добавлен Gate-механизм** (`simple_module_coordinator.py`)

Блокирующие операции теперь ждут готовности tray (до 10 секунд):

```python
# Флаги состояния (строки 99-100)
self._tray_ready = False
self._tray_start_time = None

# Подписка на событие (строка 517)
await self.event_bus.subscribe("tray.integration_ready", self._on_tray_ready, ...)

# Gate-логика (строки 586-602)
if name in ["first_run_permissions", "permission_restart"] and not self._tray_ready:
    # Ждём до 10 секунд...

# Обработчик (строки 954-968)
async def _on_tray_ready(self, event):
    self._tray_ready = True
```

**3. Добавлено логирование метрик** (`tray_controller_integration.py`)

Детальные метрики для отладки:
- `[TRAY_METRICS] tray.will_init` (строка 109)
- `[TRAY_METRICS] tray.retry(attempt=N)` (строки 136-143)
- `[TRAY_METRICS] tray.ready` (строка 241)
- `[TRAY_GATE] Waiting for tray...` (строки 590-591)
- `[TRAY_GATE] Tray ready after Nms` (строки 598-599)

**4. Убраны избыточные задержки** (`main.py:90-128`)

Из `activate_nsapplication_for_menu_bar()` удалены:
- `time.sleep(0.5)` - перед активацией NSApplication
- `time.sleep(0.3)` - перед activateIgnoringOtherApps
- `time.sleep(0.2)` - финальная стабилизация

Retry-логика теперь в TrayControllerIntegration (3 попытки с экспоненциальным backoff).

#### Файлы изменений

1. `main.py` - убраны задержки из activate_nsapplication_for_menu_bar()
2. `integration/core/simple_module_coordinator.py`:
   - Изменён порядок запуска (tray на 2-е место)
   - Добавлен gate-механизм (_tray_ready, _tray_start_time)
   - Подписка на tray.integration_ready
   - Обработчик _on_tray_ready()
   - Gate-логика в цикле запуска интеграций
3. `integration/integrations/tray_controller_integration.py`:
   - Добавлены метрики в initialize() и start()
   - Улучшено логирование retry-попыток
   - Добавлен duration_ms в событие tray.integration_ready

#### Результат

- ✅ Иконка стабильно появляется в течение 1-5 секунд даже на холодном старте
- ✅ Нет XPC-ошибок Control Center при старте
- ✅ Блокирующие операции не мешают появлению иконки
- ✅ Retry-логика срабатывает автоматически при временной недоступности системы

#### Принципы

1. **"Иконка сначала - всё остальное потом"** - tray запускается максимально рано
2. **Никаких блокировок до tray.ready** - блокирующие операции ждут готовности иконки
3. **Retry вместо задержек** - не блокируем старт, используем повторные попытки
4. **Gate-механизм** - координатор знает о состоянии tray и управляет порядком запуска
5. **Метрики для наблюдаемости** - детальное логирование для отладки и мониторинга

