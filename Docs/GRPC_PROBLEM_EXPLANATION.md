# üîç –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã gRPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 13 —è–Ω–≤–∞—Ä—è 2026

---

## üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç gRPC –∑–∞–ø—Ä–æ—Å –Ω–∞ `20.63.24.187:443`
- –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É **400 Bad Request**
- –í –ª–æ–≥–∞—Ö Nginx: `"PRI * HTTP/2.0" 400 157`
- –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: `Trying to connect an http1.x server (HTTP status 400)`

---

## üîç Root Cause (–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞)

### –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**

1. **–ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `insecure_channel`:**
   ```python
   channel = aio.insecure_channel("20.63.24.187:443")
   ```
   - `insecure_channel` = **–ë–ï–ó TLS** (plaintext —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP/2 preface: `PRI * HTTP/2.0`
   - **–ù–û:** –ë–µ–∑ TLS handshake

2. **Nginx –Ω–∞ –ø–æ—Ä—Ç—É 443 –æ–∂–∏–¥–∞–µ—Ç TLS+HTTP/2:**
   ```nginx
   listen 443 ssl http2;
   ```
   - –ü–æ—Ä—Ç 443 = **–¢–†–ï–ë–£–ï–¢ TLS**
   - –û–∂–∏–¥–∞–µ—Ç TLS handshake –ü–ï–†–ï–î HTTP/2
   - –ü–æ–ª—É—á–∞–µ—Ç HTTP/2 preface –ë–ï–ó TLS ‚Üí **400 –æ—à–∏–±–∫–∞**

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```
   –ö–ª–∏–µ–Ω—Ç: [HTTP/2 preface –±–µ–∑ TLS] ‚Üí Nginx:443
   Nginx: "–≠—Ç–æ –Ω–µ TLS! –≠—Ç–æ –æ–±—ã—á–Ω—ã–π HTTP!" ‚Üí 400 Bad Request
   ```

---

## üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã

```
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±—ã–ª–æ):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö–ª–∏–µ–Ω—Ç  ‚îÇ‚îÄ‚îÄ[insecure_channel]‚îÄ‚Üí‚îÇ Nginx  ‚îÇ
‚îÇ         ‚îÇ  (–ë–ï–ó TLS)          ‚îÇ :443   ‚îÇ
‚îÇ         ‚îÇ  PRI * HTTP/2.0     ‚îÇ (TLS!) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚ùå 400

–ü–†–ê–í–ò–õ–¨–ù–û (—Å—Ç–∞–ª–æ):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö–ª–∏–µ–Ω—Ç  ‚îÇ‚îÄ‚îÄ[secure_channel]‚îÄ‚îÄ‚Üí‚îÇ Nginx  ‚îÇ
‚îÇ         ‚îÇ  TLS handshake      ‚îÇ :443   ‚îÇ
‚îÇ         ‚îÇ  + HTTP/2           ‚îÇ (TLS!) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚úÖ 200
```

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)

### 1. –ü–æ—Ä—è–¥–æ–∫ location –±–ª–æ–∫–æ–≤ –≤ Nginx
- **–ü—Ä–æ–±–ª–µ–º–∞:** `location /` –±—ã–ª –ø–µ—Ä–µ–¥ `location /health` –∏ `/status`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ `/health` –ø—ã—Ç–∞–ª–∏—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –∫–∞–∫ gRPC
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ `/health` –∏ `/status` –ø–µ—Ä–µ–¥ `/`

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–¥—É–ª—è grpc –≤ Nginx
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞–∫–µ—Ç `nginx` –≤ Ubuntu –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç `ngx_http_grpc_module`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∏—Ä–µ–∫—Ç–∏–≤–∞ `grpc_pass` –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Å–æ–±—Ä–∞–ª–∏ Nginx —Å –º–æ–¥—É–ª–µ–º grpc

### 3. –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ grpcio/protobuf –º–æ–≥–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏–ª–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏–π

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ì–ª–∞–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

**–ó–∞–º–µ–Ω–∏–ª–∏ `insecure_channel` –Ω–∞ `secure_channel` –¥–ª—è –ø–æ—Ä—Ç–∞ 443:**

```python
# –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
channel = aio.insecure_channel("20.63.24.187:443")  # ‚ùå –ë–µ–∑ TLS

# –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
# –°–∫–∞—á–∏–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞
cert_pem = download_server_certificate("20.63.24.187", 443)
credentials = grpc.ssl_channel_credentials(root_certificates=cert_pem)
channel = aio.secure_channel("20.63.24.187:443", credentials)  # ‚úÖ –° TLS
```

---

## üìù –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

### –ü—Ä–∞–≤–∏–ª–æ:
- **–ü–æ—Ä—Ç 443 = TLS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**
- **`insecure_channel` = –ë–ï–ó TLS**
- **`secure_channel` = –° TLS**

### –ê–Ω–∞–ª–æ–≥–∏—è:
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –≤–æ–π—Ç–∏ –≤ –¥–æ–º —á–µ—Ä–µ–∑ –¥–≤–µ—Ä—å, –∫–æ—Ç–æ—Ä–∞—è —Ç—Ä–µ–±—É–µ—Ç –∫–ª—é—á:
- `insecure_channel` = –ø—ã—Ç–∞–µ—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å –±–µ–∑ –∫–ª—é—á–∞
- `secure_channel` = –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)

---

## üéØ –ò—Ç–æ–≥

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ TLS –ø–æ—Ä—Ç—É –±–µ–∑ TLS ‚Üí Nginx –≤–æ–∑–≤—Ä–∞—â–∞–ª 400

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `secure_channel` —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ—Ä—Ç–∞ 443

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ gRPC —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ TLS+HTTP/2

---

## üìö –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### HTTP/2 Connection Preface:
```
PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n
```
–≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ HTTP/2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

### –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ:
1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–ª HTTP/2 preface **–ë–ï–ó –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ TLS handshake**
2. Nginx –Ω–∞ –ø–æ—Ä—Ç—É 443 –æ–∂–∏–¥–∞–µ—Ç: **TLS handshake ‚Üí –∑–∞—Ç–µ–º HTTP/2**
3. –ü–æ–ª—É—á–∏–≤ HTTP/2 –±–µ–∑ TLS, Nginx –¥—É–º–∞–ª: "–≠—Ç–æ –Ω–µ TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!" ‚Üí 400

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç **TLS handshake** (–∏—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞)
2. –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç **HTTP/2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**
3. Nginx –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí ‚úÖ 200 OK

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∞
