# Tray Icon Acceptance - Quick Reference

–ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞ –¥–ª—è –ø—Ä–∏—ë–º–∫–∏ tray icon.

## üéØ –ß—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ–≥–æ–Ω–µ

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **`TRAY_SERIES_ID`** ‚Äî ID —Å–µ—Ä–∏–∏ –ø–æ–ø—ã—Ç–æ–∫
2. **`CC_READY ts=‚Ä¶`** ‚Äî –º–æ–º–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Control Center
3. **`TRAY_ATTEMPT1 result=ok`** ‚Äî –≤—Ä–µ–º—è –¥–æ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∫–æ–Ω–∫–∏
4. **`CIRCUIT_OPEN`** ‚Äî –±—ã–ª –ª–∏ circuit –æ—Ç–∫—Ä—ã—Ç –∏ —Å–∫–æ–ª—å–∫–æ –¥–ª–∏–ª—Å—è –¥–æ `CIRCUIT_CLOSE`
5. **`TAL=hold ‚Üí TAL=released (duration=‚Ä¶s)`** ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–¥–µ—Ä–∂–∞–Ω–∏—è
6. **`RESTART_FLAG ‚Ä¶`** ‚Äî –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ TCC: —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Å–∫–æ–ø–∏—Ä—É–π-–≤—Å—Ç–∞–≤—å)

### –û–Ω–ª–∞–π–Ω-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫:

```bash
./scripts/monitor_tray_metrics.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
log stream --style compact \
  --predicate 'process == "Nexy" && (eventMessage CONTAINS[c] "TRAY_" OR eventMessage CONTAINS[c] "CC_READY" OR eventMessage CONTAINS[c] "CIRCUIT_" OR eventMessage CONTAINS[c] "TAL=" OR eventMessage CONTAINS[c] "RESTART_FLAG")'
```

### –°—Ä–µ–∑ –ø–æ XPC/Scene-–æ—à–∏–±–∫–∞–º (–ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–∫–∞—Å–∫–∞–¥–∞ Aux¬ª):

```bash
./scripts/check_aux_cascade.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
log show --last 15m --style compact \
  --predicate 'process == "Nexy" AND (eventMessage CONTAINS[c] "BSServiceConnectionErrorDomain" OR eventMessage CONTAINS[c] "InvalidScene" OR eventMessage CONTAINS[c] "-Aux[" )'
```

### –ê–Ω–∞–ª–∏–∑ SLO –ø–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–∞:

```bash
./scripts/analyze_slo.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
log show --last 15m --style compact --predicate 'process == "Nexy"' > log.md
python scripts/parse_tray_metrics.py log.md --warm-start
python scripts/parse_tray_metrics.py log.md --cold-start
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ PASS (–∂—ë—Å—Ç–∫–æ)

### –¢—ë–ø–ª—ã–π —Å—Ç–∞—Ä—Ç:
- ‚úÖ `tray.ready` ‚â§ 5 —Å
- ‚úÖ –ë–µ–∑ —Å–µ—Ä–∏–π `‚Ä¶-Aux[n]`
- ‚úÖ 0 —Ä–µ—Ç—Ä–∞–µ–≤

### –•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç:
- ‚úÖ 95% ‚â§ 30 —Å
- ‚úÖ 99% ‚â§ 60 —Å
- ‚úÖ –†–µ—Ç—Ä–∞–∏ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º –≤–∏–¥–Ω—ã
- ‚úÖ –ù–µ—Ç ¬´–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π¬ª –ø–∏–ª—ã –æ—à–∏–±–æ–∫

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ TCC:
- ‚úÖ –û–¥–∏–Ω `RESTART_FLAG`
- ‚úÖ –î–∞–ª—å—à–µ ‚Äî –∫–∞–∫ –≤ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ

### –ü—Ä–∏ —É–±–∏–π—Å—Ç–≤–µ Control Center:
- ‚úÖ –û–¥–Ω–∞ —Å–µ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫
- ‚úÖ –ü—Ä–∏ ‚â•3 –æ—à–∏–±–∫–∞—Ö –ø–æ–¥—Ä—è–¥ ‚Äî `CIRCUIT_OPEN` (~8 s) ‚Üí `CIRCUIT_CLOSE`
- ‚úÖ –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è ‚Äî —É—Å–ø–µ—à–Ω—ã–π `ATTEMPT{n}`

---

## üîß –ë—ã—Å—Ç—Ä—ã–µ ¬´—Ç—É–º–±–ª–µ—Ä—ã¬ª, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫

### –ò–∫–æ–Ω–∫–∞ —Ç–∞–∫ –∏ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞ 60 s:

**–í `config/unified_config.yaml` —É–≤–µ–ª–∏—á—å:**

```yaml
tray:
  status_item:
    first_attempt_delay_ms: 1500  # –ë—ã–ª–æ 1000, —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 1500-2000
    final_timeout_ms: 90000      # –ë—ã–ª–æ 60000, —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 90000
```

**–ü—Ä–æ–≤–µ—Ä—å:**
- –ß—Ç–æ `single-flight` —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ create()
- –í –ª–æ–≥–∞—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è `TRAY_ATTEMPT start`

---

### –ö–∞—Å–∫–∞–¥ `‚Ä¶-Aux[n]` –∏ ¬´–ø–∏–ª–∞¬ª XPC-–æ—à–∏–±–æ–∫:

**–ü—Ä–æ–≤–µ—Ä—å:**
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—É–∑–∞ `CIRCUIT_OPEN` (8 s)
- –ò–Ω–∞—á–µ —Å—á—ë—Ç—á–∏–∫ —Å–µ—Ä–∏–∏ –Ω–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç—Å—è –∏–ª–∏ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É—Å–ø–µ—Ö–µ

**–ù–∞ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∫–∏ –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å:**

```yaml
tray:
  status_item:
    circuit_open_duration_ms: 12000  # –ë—ã–ª–æ 8000, —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 12000
```

---

### `TAL=released` —Ä–∞–Ω—å—à–µ `tray.ready`:

**–ü—Ä–æ–≤–µ—Ä—å:**
- –í Gate –≤—ã–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ `tray.integration_ready` –∏–ª–∏ –ø–æ —Ç–≤—ë—Ä–¥–æ–º—É —Ç–∞–π–º–∞—É—Ç—É
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ EventBus –∏ –ø–æ—Ä—è–¥–æ–∫ await

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ `_release_tal_hold()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ `_on_tray_ready()` –∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É 60s

---

### `RESTART_FLAG` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ:

**–ü—Ä–æ–≤–µ—Ä—å:**
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å read-and-delete –∏ TTL —Ñ–ª–∞–≥–∞
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–≤–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ñ–ª–∞–≥–∞ `age_ms` –∏ PID –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ `read_and_remove()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fcntl.flock()` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `MAX_FLAG_AGE_SEC = 60.0` (10 –º–∏–Ω—É—Ç) —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üß™ –ù–∞–±–æ—Ä ¬´—Å—Ç—Ä–µ—Å—Å-–∫–µ–π—Å–æ–≤¬ª (5 –º–∏–Ω—É—Ç —Å–≤–µ—Ä—Ö—É, –Ω–æ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ)

1. **–ë—ã—Å—Ç—Ä–æ–µ –ª–æ–≥–∏–Ω-–≤—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ + —Å—Ä–∞–∑—É –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Nexy**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Control Center –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º —Å—Ç–∞—Ä—Ç–µ

2. **–ë—ã—Å—Ç—Ä—ã–π —Ç–∞–π–ø –ø–æ Spotlight/Launchpad (–¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å—Ç–∞—Ä—Ç—ã)**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `instance_manager` –∏ single-flight

3. **–í–Ω–µ—à–Ω–∏–π –º–æ–Ω–∏—Ç–æ—Ä + —Å–º–µ–Ω–∞ Spaces –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç—Ä–µ—è**
   - –ò–Ω–æ–≥–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ Control Center

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏

### 1. –¢—ë–ø–ª—ã–π —Å—Ç–∞—Ä—Ç √ó3
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Nexy –≤—Ä—É—á–Ω—É—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `TRAY_ATTEMPT1 result=ok` ‚â§ 5 —Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `‚Ä¶-Aux[n]`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `TAL=hold ‚Üí TAL=released`

### 2. –•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç √ó3
- [ ] –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å macOS
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Nexy (–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `tray.ready` —É 95% ‚â§ 30 —Å, —É 99% ‚â§ 60 —Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Ç—Ä–∞–∏ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ¬´–ª–µ—Å–µ–Ω–∫–∏¬ª `Aux`

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ TCC
- [ ] –°–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ-—Ä–µ–ª–æ–Ω—á–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω `RESTART_FLAG`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ –∂–µ SLO, —á—Ç–æ –≤ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Control Center
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Nexy
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å `killall ControlCenter`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–Ω—É —Å–µ—Ä–∏—é –ø–æ–ø—ã—Ç–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `CIRCUIT_OPEN` (~8 s) ‚Üí `CIRCUIT_CLOSE` –ø—Ä–∏ ‚â•3 –æ—à–∏–±–∫–∞—Ö

### 5. ¬´–ë–µ–∑ —Ç—Ä–µ—è¬ª fallback
- [ ] –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç—è–∂—ë–ª—ã–µ —É—Å–ª–æ–≤–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º –±–µ–∑ tray –ø–æ—Å–ª–µ 60 s
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∫–∏–π —Ñ–æ–Ω–æ–≤—ã–π retry (30‚Äì60 s)

---

## üéØ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É

1. –ó–∞–ø—É—Å—Ç–∏ `./scripts/monitor_tray_metrics.sh` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
2. –ó–∞–ø—É—Å—Ç–∏ Nexy
3. –ü—Ä–æ–≤–µ—Ä—å –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
4. –ü–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–∞ –∑–∞–ø—É—Å—Ç–∏ `./scripts/analyze_slo.sh` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ SLO

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π ¬´—Ç—É–º–±–ª–µ—Ä—ã¬ª –≤—ã—à–µ –¥–ª—è –ø–æ–¥–∫—Ä—É—Ç–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞.

