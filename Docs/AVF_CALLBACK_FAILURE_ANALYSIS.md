# ะะตัะฐะปัะฝัะน ะฐะฝะฐะปะธะท: ะะฐ ะบะฐะบะพะผ ััะฐะฟะต ะปะพะผะฐะตััั ะปะพะณะธะบะฐ Completion Callback

## ๐ ะขะพัะบะฐ ะฟะพะปะพะผะบะธ

### ะญัะฐะฟ 1: ะะผะฟะพัั ะผะพะดัะปั (ะผะพะผะตะฝั ะทะฐะณััะทะบะธ Python ะผะพะดัะปั)

**ะคะฐะนะป**: `modules/audio_avf/core/avf_audio_engine.py:25-42`

```python
try:
    logger.info("๐ง [AVF] ะะพะฟััะบะฐ ะธะผะฟะพััะฐ AVAudioPlayerNode ะธะท AVFoundation...")
    from AVFoundation import AVAudioPlayerNode
    AVF_PLAYER_NODE_AVAILABLE = True
    logger.info("โ [AVF] AVAudioPlayerNode ััะฟะตัะฝะพ ะธะผะฟะพััะธัะพะฒะฐะฝ ะธะท AVFoundation")
except ImportError as e:
    AVAudioPlayerNode = None
    AVF_PLAYER_NODE_AVAILABLE = False
    # ... ะปะพะณะธัะพะฒะฐะฝะธะต ะพัะธะฑะบะธ
```

**ะัะพะฑะปะตะผะฐ**: ะัะปะธ ะธะผะฟะพัั ะฝะต ัะดะฐะปัั:
- `AVF_PLAYER_NODE_AVAILABLE = False`
- `AVAudioPlayerNode = None`
- ะะพ ะฒ ะปะพะณะฐั ะฟะพะปัะทะพะฒะฐัะตะปั **ะะะข** ัะพะพะฑัะตะฝะธั ะพะฑ ะพัะธะฑะบะต ะธะผะฟะพััะฐ!

**ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั**:
1. ะะพะณะธ ะธะผะฟะพััะฐ ะฝะต ะฒะธะดะฝั (ััะพะฒะตะฝั DEBUG ะฒะผะตััะพ INFO - **ะะกะะะะะะะะ**)
2. ะะผะฟะพัั ะฟัะพะธััะพะดะธั ะะ ะฝะฐัััะพะนะบะธ ะปะพะณะธัะพะฒะฐะฝะธั
3. ะัะบะปััะตะฝะธะต ะฟะตัะตัะฒะฐััะฒะฐะตััั, ะฝะพ ะปะพะณะธ ะฝะต ะดะพัะพะดัั ะดะพ ะฟะพะปัะทะพะฒะฐัะตะปั

---

### ะญัะฐะฟ 2: ะกะพะทะดะฐะฝะธะต ัะบะทะตะผะฟะปััะฐ AVFAudioEngine

**ะคะฐะนะป**: `modules/audio_avf/core/avf_audio_engine.py:256-356`

**ะะพััะดะพะบ ะฒัะทะพะฒะพะฒ ะฒ `__init__`**:
1. ะะผะฟะพัั AVFoundation ะบะปะฐััะพะฒ (ัััะพะบะฐ 265-280)
2. ะะฐะณััะทะบะฐ ะบะพะฝัะธะณััะฐัะธะธ (ัััะพะบะฐ 283-290)
3. ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟะตัะตะผะตะฝะฝัั (ัััะพะบะฐ 292-346)
4. **`_initialize_engine()`** (ัััะพะบะฐ 349) - ัะพะทะดะฐัั `_player_node`
5. **`_init_completion_callback()`** (ัััะพะบะฐ 353) - ัะพะทะดะฐัั callback
6. `_setup_device_monitoring()` (ัััะพะบะฐ 356)

**ะัะพะฑะปะตะผะฐ**: ะัะปะธ `_initialize_engine()` ะฟะฐะดะฐะตั ั ะธัะบะปััะตะฝะธะตะผ:
- `_player_node` ะฝะต ัะพะทะดะฐัััั
- `_init_completion_callback()` ะฒัั ัะฐะฒะฝะพ ะฒัะทัะฒะฐะตััั
- Callback ัะพะทะดะฐัััั, ะฝะพ `_player_node` = `None`
- ะัะธะฒัะทะบะฐ `_bind_player_node_to_engine()` ะฝะต ะฒัะฟะพะปะฝัะตััั (ัััะพะบะฐ 869)

**ะะพะบะฐัะธั ะฟัะพะฑะปะตะผั**:
```python
# ะกััะพะบะฐ 867-870
if self._player_node is not None:
    _bind_player_node_to_engine(self._player_node, self)
    logger.debug("โ [AVF] Player node ะฟัะธะฒัะทะฐะฝ ะบ ัะบะทะตะผะฟะปััั AVFAudioEngine")
# โ ะะะะะะะะ: ะัะปะธ _player_node = None, ะฟัะธะฒัะทะบะฐ ะะ ะฒัะฟะพะปะฝัะตััั!
```

---

### ะญัะฐะฟ 3: ะกะพะทะดะฐะฝะธะต Completion Callback

**ะคะฐะนะป**: `modules/audio_avf/core/avf_audio_engine.py:856-914`

**ะะพััะดะพะบ ะฒัะทะพะฒะพะฒ ะฒ `_init_completion_callback()`**:
1. ะะตะณะธัััะฐัะธั ัะบะทะตะผะฟะปััะฐ ะฒ `_AVF_ENGINE_INSTANCES` (ัััะพะบะฐ 865)
2. ะัะธะฒัะทะบะฐ `_player_node` โ engine (ัััะพะบะฐ 867-870) - **ะะะะะข ะะ ะะซะะะะะะขะฌะกะฏ!**
3. ะัะพะฒะตัะบะฐ `AVF_PLAYER_NODE_AVAILABLE` (ัััะพะบะฐ 877-886)
4. ะัะพะฒะตัะบะฐ `AVAudioPlayerNode is None` (ัััะพะบะฐ 888-893)
5. ะัะทะพะฒ `_create_avf_completion_callback()` (ัััะพะบะฐ 896)

**ะัะพะฑะปะตะผะฐ**: ะัะปะธ `AVF_PLAYER_NODE_AVAILABLE = False` ะธะปะธ `AVAudioPlayerNode = None`:
- `_create_avf_completion_callback()` ะฒะพะทะฒัะฐัะฐะตั `None` (ัััะพะบะฐ 123, 128)
- `self._output_completion_callback = None` (ัััะพะบะฐ 896)
- ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ัะฐะฑะพัะฐะตั, ะฝะพ callback ะฝะต ะฒัะทัะฒะฐะตััั

**ะะพะบะฐัะธั ะฟัะพะฑะปะตะผั**:
```python
# ะกััะพะบะฐ 877-886
if not AVF_PLAYER_NODE_AVAILABLE:
    logger.error("โ [AVF] ะะะะขะะงะะกะะะฏ ะะจะะะะ: AVF_PLAYER_NODE_AVAILABLE = False")
    self._output_completion_callback = None
    return  # โ ะะะะะะะะ: Callback ะฝะต ัะพะทะดะฐัััั, ะฝะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะฟัะพะดะพะปะถะธั ัะฐะฑะพัะฐัั!
```

---

### ะญัะฐะฟ 4: ะัะฟะพะปัะทะพะฒะฐะฝะธะต Callback ะฒ play_audio()

**ะคะฐะนะป**: `modules/audio_avf/core/avf_audio_engine.py:1708-1723`

**ะัะพะฑะปะตะผะฐ**: ะัะปะธ `callback_to_use = None`:
- `scheduleBuffer_atTime_options_completionHandler_()` ะฒัะทัะฒะฐะตััั ั `None` (ัััะพะบะฐ 1722)
- AVAudioPlayerNode ะฝะต ะฒัะทัะฒะฐะตั callback
- ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ัะฐะฑะพัะฐะตั, ะฝะพ `playback.completed` ะฝะต ะฟัะฑะปะธะบัะตััั
- Fallback timeout ััะฐะฑะฐััะฒะฐะตั ัะตัะตะท 5.78 ัะตะบัะฝะด

**ะะพะบะฐัะธั ะฟัะพะฑะปะตะผั**:
```python
# ะกััะพะบะฐ 1708-1722
callback_to_use = self._output_completion_callback

if callback_to_use is None:
    logger.error("โ [AVF] ะะะะขะะงะะกะะะฏ ะะะะะะะะ: Completion callback ะฝะตะดะพัััะฟะตะฝ...")
    # โ ะะะะะะะะ: ะะพะณะธััะตััั ะพัะธะฑะบะฐ, ะฝะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะฟัะพะดะพะปะถะฐะตััั!

self._player_node.scheduleBuffer_atTime_options_completionHandler_(
    audio_buffer,
    None,
    0,
    callback_to_use if callback_to_use is not None else None  # โ None ะฟะตัะตะดะฐัััั ะฒ AVAudioPlayerNode!
)
```

---

## ๐ ะะพะฝะบะธ ััะปะพะฒะธะน ะธ ะดัะฑะปะธัะพะฒะฐะฝะธะต

### ะะพะฝะบะฐ 1: ะะฝะพะถะตััะฒะตะฝะฝัะต ัะบะทะตะผะฟะปััั AVFAudioEngine

**ะัะพะฑะปะตะผะฐ**: ะกะพะทะดะฐัััั ะฝะตัะบะพะปัะบะพ ัะบะทะตะผะฟะปััะพะฒ:
1. `AudioSystemIntegration._do_initialize()` ัะพะทะดะฐัั ัะบะทะตะผะฟะปัั (ัััะพะบะฐ 82)
2. `SpeechPlaybackIntegration._ensure_avf_engine()` ัะพะทะดะฐะฒะฐะป ะปะพะบะฐะปัะฝัะน ัะบะทะตะผะฟะปัั (ัััะพะบะฐ 98) - **ะะกะะะะะะะะ**

**ะะพัะปะตะดััะฒะธั**:
- Completion callback ัะพะทะดะฐัััั ัะพะปัะบะพ ะดะปั ะฟะตัะฒะพะณะพ ัะบะทะตะผะฟะปััะฐ (ะณะปะพะฑะฐะปัะฝัะน `_AVF_COMPLETION_CALLBACK`)
- ะัะปะธ ะธัะฟะพะปัะทัะตััั ะฒัะพัะพะน ัะบะทะตะผะฟะปัั, callback ะฝะต ัะฐะฑะพัะฐะตั
- ะะตะฟะพะฝััะฝะพ, ะบะฐะบะพะน ัะบะทะตะผะฟะปัั ะธัะฟะพะปัะทัะตััั ะดะปั ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั

**ะะพะบะฐัะธั**:
- `integration/integrations/audio_system_integration.py:82`
- `integration/integrations/speech_playback_integration.py:98` (ัะดะฐะปะตะฝะพ)

---

### ะะพะฝะบะฐ 2: ะะพััะดะพะบ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ

**ะัะพะฑะปะตะผะฐ**: ะะพััะดะพะบ ะฒัะทะพะฒะพะฒ ะฒ `__init__`:
1. `_initialize_engine()` ัะพะทะดะฐัั `_player_node` (ัััะพะบะฐ 373)
2. `_init_completion_callback()` ะฒัะทัะฒะฐะตััั ะะะกะะ (ัััะพะบะฐ 353)
3. ะะพ ะตัะปะธ `_initialize_engine()` ะฟะฐะดะฐะตั, `_player_node` = `None`
4. `_init_completion_callback()` ะฒัั ัะฐะฒะฝะพ ะฒัะทัะฒะฐะตััั
5. ะัะธะฒัะทะบะฐ `_bind_player_node_to_engine()` ะฝะต ะฒัะฟะพะปะฝัะตััั

**ะะพัะปะตะดััะฒะธั**:
- Callback ัะพะทะดะฐัััั, ะฝะพ ะฝะต ะฟัะธะฒัะทะฐะฝ ะบ `_player_node`
- ะัะธ ะฒัะทะพะฒะต callback ะธะท AVAudioPlayerNode, `_lookup_engine_by_player_node()` ะฝะต ะฝะฐัะพะดะธั ัะบะทะตะผะฟะปัั
- Fallback ะฝะฐ ะฟะตัะฒัะน ะดะพัััะฟะฝัะน ัะบะทะตะผะฟะปัั ะผะพะถะตั ะฒัะฑัะฐัั ะฝะตะฟัะฐะฒะธะปัะฝัะน

**ะะพะบะฐัะธั**:
- `modules/audio_avf/core/avf_audio_engine.py:349-356` (ะฟะพััะดะพะบ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ)
- `modules/audio_avf/core/avf_audio_engine.py:867-870` (ะฟัะธะฒัะทะบะฐ player_node)

---

### ะะพะฝะบะฐ 3: ะกะพะทะดะฐะฝะธะต callback ะดะพ ะฟัะพะฒะตัะบะธ ะธะผะฟะพััะฐ

**ะัะพะฑะปะตะผะฐ**: `_create_avf_completion_callback()` ะฒัะทัะฒะฐะตััั ะะะ ะฟัะพะฒะตัะบะธ:
- ะัะพะฒะตัะบะฐ `AVF_PLAYER_NODE_AVAILABLE` ะฟัะพะธััะพะดะธั ะะะฃะขะะ ััะฝะบัะธะธ (ัััะพะบะฐ 119)
- ะะพ ะตัะปะธ ะธะผะฟะพัั ะฝะต ัะดะฐะปัั, ะฟัะพะฒะตัะบะฐ ะฒะพะทะฒัะฐัะฐะตั `None` ะะะ ะปะพะณะธัะพะฒะฐะฝะธั ะฝะฐ ััะพะฒะฝะต INFO

**ะะพัะปะตะดััะฒะธั**:
- Callback ะฝะต ัะพะทะดะฐัััั, ะฝะพ ะพัะธะฑะบะฐ ะฝะต ะฒะธะดะฝะฐ ะฒ ะปะพะณะฐั
- ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ัะฐะฑะพัะฐะตั, ะฝะพ `playback.completed` ะฝะต ะฟัะฑะปะธะบัะตััั

**ะะพะบะฐัะธั**:
- `modules/audio_avf/core/avf_audio_engine.py:119-123` (ะฟัะพะฒะตัะบะฐ ะฒะฝัััะธ ััะฝะบัะธะธ)
- `modules/audio_avf/core/avf_audio_engine.py:877-886` (ะฟัะพะฒะตัะบะฐ ะะะะะ ะฒัะทะพะฒะพะผ - **ะะกะะะะะะะะ**)

---

## โ ะะฐัะธะฐะฝัั ะธัะฟัะฐะฒะปะตะฝะธั

### ะะฐัะธะฐะฝั 1: ะะฐะฝะฝัั ะฟัะพะฒะตัะบะฐ ะธะผะฟะพััะฐ (ะะะะะะะะะะะ)

**ะงัะพ ัะดะตะปะฐะฝะพ**:
- ะะทะผะตะฝัะฝ ััะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั ั `DEBUG` ะฝะฐ `INFO` ะฟัะธ ะธะผะฟะพััะต
- ะะพะฑะฐะฒะปะตะฝะฐ ะฟัะพะฒะตัะบะฐ `AVF_PLAYER_NODE_AVAILABLE` ะธ `AVAudioPlayerNode is None` ะะะะะ ะฒัะทะพะฒะพะผ `_create_avf_completion_callback()`
- ะะพะฑะฐะฒะปะตะฝะพ ัะฒะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะพัะธะฑะพะบ

**ะัะตะธะผััะตััะฒะฐ**:
- ะัะธะฑะบะธ ะฒะธะดะฝั ะฒ ะปะพะณะฐั
- ะะต ัะพะทะดะฐัััั callback, ะตัะปะธ ะธะผะฟะพัั ะฝะต ัะดะฐะปัั
- ะฏะฒะฝะฐั ะดะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผั

**ะะตะดะพััะฐัะบะธ**:
- ะะต ัะตัะฐะตั ะฟัะพะฑะปะตะผั, ะตัะปะธ ะธะผะฟะพัั ะดะตะนััะฒะธัะตะปัะฝะพ ะฝะต ัะดะฐะปัั
- ะขัะตะฑัะตั ัััะฐะฝะพะฒะบะธ PyObjC

---

### ะะฐัะธะฐะฝั 2: ะฃะฑัะฐัั ัะพะทะดะฐะฝะธะต ะปะพะบะฐะปัะฝะพะณะพ ัะบะทะตะผะฟะปััะฐ (ะะะะะะะะะะะ)

**ะงัะพ ัะดะตะปะฐะฝะพ**:
- ะะตัะพะด `_ensure_avf_engine()` ะฑะพะปััะต ะฝะต ัะพะทะดะฐัั ะปะพะบะฐะปัะฝัะน ัะบะทะตะผะฟะปัั
- ะัะต ะฒัะทะพะฒั ะทะฐะผะตะฝะตะฝั ะฝะฐ ัะฒะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะพัะธะฑะพะบ

**ะัะตะธะผััะตััะฒะฐ**:
- ะขะพะปัะบะพ ะพะดะธะฝ ัะบะทะตะผะฟะปัั `AVFAudioEngine` ัะพะทะดะฐัััั
- Completion callback ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ
- ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ัะบะทะตะผะฟะปััะพะฒ

**ะะตะดะพััะฐัะบะธ**:
- ะัะปะธ `AudioSystemIntegration` ะฝะต ะฟะตัะตะดะฐัั ัะบะทะตะผะฟะปัั, ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะฝะต ัะฐะฑะพัะฐะตั
- ะขัะตะฑัะตั ะฟัะฐะฒะธะปัะฝะพะณะพ ะฟะพััะดะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ

---

### ะะฐัะธะฐะฝั 3: ะัะพะฒะตัะบะฐ ะฟัะธะฒัะทะบะธ player_node (ะะะะะะะะะฃะะขะกะฏ)

**ะงัะพ ะฝัะถะฝะพ ัะดะตะปะฐัั**:
- ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั `_player_node is not None` ะะะะะ ะฒัะทะพะฒะพะผ `_init_completion_callback()`
- ะัะปะธ `_player_node = None`, ะปะพะณะธัะพะฒะฐัั ะพัะธะฑะบั ะธ ะฝะต ัะพะทะดะฐะฒะฐัั callback
- ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั ััะฟะตัะฝะพััะธ ะฟัะธะฒัะทะบะธ `_bind_player_node_to_engine()`

**ะัะตะธะผััะตััะฒะฐ**:
- Callback ัะพะทะดะฐัััั ัะพะปัะบะพ ะตัะปะธ `_player_node` ัััะตััะฒัะตั
- ะฏะฒะฝะฐั ะดะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผั
- ะัะตะดะพัะฒัะฐัะฐะตั ะณะพะฝะบั ััะปะพะฒะธะน

**ะะตะดะพััะฐัะบะธ**:
- ะัะปะธ `_initialize_engine()` ะฟะฐะดะฐะตั, callback ะฝะต ัะพะทะดะฐัััั
- ะขัะตะฑัะตั ะธัะฟัะฐะฒะปะตะฝะธั ะฟัะพะฑะปะตะผั ั `_initialize_engine()`

---

### ะะฐัะธะฐะฝั 4: Fallback ะฝะฐ ะฐะปััะตัะฝะฐัะธะฒะฝัะน ะผะตัะฐะฝะธะทะผ (ะะะะะะะะะฃะะขะกะฏ)

**ะงัะพ ะฝัะถะฝะพ ัะดะตะปะฐัั**:
- ะัะปะธ callback ะฝะต ัะพะทะดะฐัััั, ะธัะฟะพะปัะทะพะฒะฐัั ะฐะปััะตัะฝะฐัะธะฒะฝัะน ะผะตัะฐะฝะธะทะผ:
  - Polling ัะพััะพัะฝะธั `_output_state` ะฒ ะพัะดะตะปัะฝะพะผ ะฟะพัะพะบะต
  - ะัะฟะพะปัะทะพะฒะฐะฝะธะต `AVAudioPlayerNodeDelegate` (ะตัะปะธ ะดะพัััะฟะตะฝ)
  - ะฃะปัััะตะฝะธะต fallback timeout ั ะฑะพะปะตะต ัะพัะฝัะผ ัะฐััััะพะผ

**ะัะตะธะผััะตััะฒะฐ**:
- ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ัะฐะฑะพัะฐะตั ะดะฐะถะต ะตัะปะธ callback ะฝะต ัะพะทะดะฐัััั
- `playback.completed` ะฟัะฑะปะธะบัะตััั ัะตัะตะท ะฐะปััะตัะฝะฐัะธะฒะฝัะน ะผะตัะฐะฝะธะทะผ
- ะะต ะทะฐะฒะธัะธั ะพั PyObjC callback

**ะะตะดะพััะฐัะบะธ**:
- ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ัะปะพะถะฝะพััั
- ะะพะถะตั ะฑััั ะผะตะฝะตะต ัะพัะฝัะผ, ัะตะผ ะฝะฐัะธะฒะฝัะน callback

---

## ๐ ะะธะฐะณัะฐะผะผะฐ ะฟะพัะพะบะฐ ั ัะพัะบะฐะผะธ ะฟะพะปะพะผะบะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะะะะะข ะะะะฃะะฏ (ะผะพะผะตะฝั ะทะฐะณััะทะบะธ Python)                     โ
โ  โโ> from AVFoundation import AVAudioPlayerNode            โ
โ      โโ> โ ะฃะกะะะฅ: AVF_PLAYER_NODE_AVAILABLE = True        โ
โ      โโ> โ ะะจะะะะ: AVF_PLAYER_NODE_AVAILABLE = False       โ
โ          โโ> โ ะขะะงะะ ะะะะะะะ 1: ะะผะฟะพัั ะฝะต ัะดะฐะปัั          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AudioSystemIntegration._do_initialize()                   โ
โ  โโ> AVFAudioEngine(audio_config, event_bus)               โ
โ      โโ> __init__()                                         โ
โ          โโ> _initialize_engine()                            โ
โ          โ   โโ> _player_node = AVAudioPlayerNode()        โ
โ          โ   โ   โโ> โ ะฃะกะะะฅ: _player_node ัะพะทะดะฐะฝ         โ
โ          โ   โ   โโ> โ ะะจะะะะ: _player_node = None         โ
โ          โ   โ       โโ> โ ะขะะงะะ ะะะะะะะ 2: player_node   โ
โ          โ   โ           ะฝะต ัะพะทะดะฐะฝ                          โ
โ          โ   โโ> _bind_player_node_to_engine()             โ
โ          โ       โโ> โ ะฃะกะะะฅ: ะัะธะฒัะทะบะฐ ะฒัะฟะพะปะฝะตะฝะฐ          โ
โ          โ       โโ> โ ะะจะะะะ: ะัะธะฒัะทะบะฐ ะฝะต ะฒัะฟะพะปะฝะตะฝะฐ      โ
โ          โ           โโ> โ ะขะะงะะ ะะะะะะะ 3: player_node   โ
โ          โ               ะฝะต ะฟัะธะฒัะทะฐะฝ                         โ
โ          โโ> _init_completion_callback()                    โ
โ              โโ> ะัะพะฒะตัะบะฐ AVF_PLAYER_NODE_AVAILABLE         โ
โ              โ   โโ> โ ะฃะกะะะฅ: True                        โ
โ              โ   โโ> โ ะะจะะะะ: False                       โ
โ              โ       โโ> โ ะขะะงะะ ะะะะะะะ 4: Callback       โ
โ              โ           ะฝะต ัะพะทะดะฐัััั                       โ
โ              โโ> _create_avf_completion_callback()          โ
โ                  โโ> objc.callbackFor(...)                  โ
โ                  โ   โโ> โ ะฃะกะะะฅ: Callback ัะพะทะดะฐะฝ         โ
โ                  โ   โโ> โ ะะจะะะะ: Callback = None         โ
โ                  โ       โโ> โ ะขะะงะะ ะะะะะะะ 5: objc       โ
โ                  โ           callbackFor ะฒะตัะฝัะป None         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  play_audio() - ะธัะฟะพะปัะทะพะฒะฐะฝะธะต callback                      โ
โ  โโ> callback_to_use = self._output_completion_callback    โ
โ      โโ> โ ะฃะกะะะฅ: callback_to_use != None                 โ
โ      โ   โโ> scheduleBuffer(..., callback_to_use)          โ
โ      โ       โโ> โ AVAudioPlayerNode ะฒัะทัะฒะฐะตั callback    โ
โ      โโ> โ ะะจะะะะ: callback_to_use = None                  โ
โ          โโ> scheduleBuffer(..., None)                      โ
โ              โโ> โ ะขะะงะะ ะะะะะะะ 6: Callback ะฝะต ะฒัะทัะฒะฐะตัััโ
โ                  โโ> Fallback timeout ัะตัะตะท 5.78s           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ

### ะัะธัะธัะฝัะต ะธัะฟัะฐะฒะปะตะฝะธั (ะะซะะะะะะะ)

1. โ ะฃะฑัะฐัั ัะพะทะดะฐะฝะธะต ะปะพะบะฐะปัะฝะพะณะพ ัะบะทะตะผะฟะปััะฐ ะฒ `SpeechPlaybackIntegration`
2. โ ะฃะปัััะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ะธะผะฟะพััะฐ (DEBUG โ INFO)
3. โ ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั ะะะะะ ะฒัะทะพะฒะพะผ `_create_avf_completion_callback()`

### ะะตะบะพะผะตะฝะดัะตะผัะต ะธัะฟัะฐะฒะปะตะฝะธั

4. โ๏ธ ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั `_player_node is not None` ะะะะะ `_init_completion_callback()`
5. โ๏ธ ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั ััะฟะตัะฝะพััะธ ะฟัะธะฒัะทะบะธ `_bind_player_node_to_engine()`
6. โ๏ธ ะฃะปัััะธัั fallback timeout ั ะฑะพะปะตะต ัะพัะฝัะผ ัะฐััััะพะผ

### ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะปัััะตะฝะธั

7. ๐ก ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ััะฟะตัะฝะพััะธ ัะพะทะดะฐะฝะธั callback
8. ๐ก ะะพะฑะฐะฒะธัั ะฐะฒัะพะผะฐัะธัะตัะบัั ะดะธะฐะณะฝะพััะธะบั ะฟัะธ ััะฐััะต ะฟัะธะปะพะถะตะฝะธั
9. ๐ก ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั PyObjC ะฟัะธ ัััะฐะฝะพะฒะบะต ะทะฐะฒะธัะธะผะพััะตะน


