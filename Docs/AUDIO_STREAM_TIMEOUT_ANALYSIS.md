# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Ç–∞–π–º–∞—É—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∞

**–î–∞—Ç–∞:** 2025-12-02  
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∞–π–º–∞—É—Ç 15s –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ OUTPUT –ø–æ—Ç–æ–∫–∞ —á–µ—Ä–µ–∑ AudioStreamManager

## –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –ª–æ–≥–æ–≤

### –°–∏–º–ø—Ç–æ–º—ã:
1. **–°—Ç—Ä–æ–∫–∞ 447**: `üîç [OUTPUT] –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioStreamManager: device=2, BT=False`
2. **–°—Ç—Ä–æ–∫–∏ 449-491**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `device_change_publisher` (polling –∫–∞–∂–¥—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã)
3. **–°—Ç—Ä–æ–∫–∞ 492**: `‚ùå [OUTPUT] –ü–æ–ø—ã—Ç–∫–∞ 5/5 —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å (–≤—Ä–µ–º—è: 15.01—Å)`
4. **–°—Ç—Ä–æ–∫–∞ 495**: `–û—à–∏–±–∫–∞: TimeoutError`
5. **–°—Ç—Ä–æ–∫–∞ 500**: `result = future.result(timeout=timeout_sec)` - —Ç–∞–π–º–∞—É—Ç –≤ `_start_audio_stream`

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
**–í –ª–æ–≥–∞—Ö –ù–ï–¢ –∑–∞–ø–∏—Å–µ–π –∏–∑ `AudioStreamManager.create_stream`** (—Å—Ç—Ä–æ–∫–∏ 120-128), —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ú–µ—Ç–æ–¥ –ª–∏–±–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –õ–∏–±–æ –∑–∞–≤–∏—Å–∞–µ—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ª–æ–≥–∞ (`üîç [{self.stream_type.upper()}] create_stream: –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock...`)

## –ü—Ä–∏—á–∏–Ω—ã

### 1. –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ `_start_audio_stream`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `asyncio.run_coroutine_threadsafe` —Å —Ç–∞–π–º–∞—É—Ç–æ–º 15s –≤–º–µ—Å—Ç–æ –Ω–æ–≤–æ–≥–æ `_run_async_in_thread`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ `_run_async_in_thread` —Å —Ç–∞–π–º–∞—É—Ç–æ–º 3-5s
- –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (2 –≤–º–µ—Å—Ç–æ 5)

### 2. –í–æ–∑–º–æ–∂–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ AudioStreamManager
**–ü—Ä–æ–±–ª–µ–º–∞:** `AudioStreamManager.create_stream` –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞:
- `with self._lock:` (—Å—Ç—Ä–æ–∫–∞ 110) - –µ—Å–ª–∏ lock —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω
- `await self._close_stream_safe()` (—Å—Ç—Ä–æ–∫–∞ 114) - –µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –∑–∞–≤–∏—Å–∞–µ—Ç
- –°–æ–∑–¥–∞–Ω–∏–µ PortAudio –ø–æ—Ç–æ–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 137) - –µ—Å–ª–∏ PortAudio –∑–∞–≤–∏—Å–∞–µ—Ç

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `AudioStreamManager.create_stream` –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ –∑–∞–≤–∏—Å–∞–Ω–∏—è

### 3. –ß–∞—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã device_change_publisher
**–ü—Ä–æ–±–ª–µ–º–∞:** `device_change_publisher` –¥–µ–ª–∞–µ—Ç polling –∫–∞–∂–¥—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã, –≤—ã–∑—ã–≤–∞—è `SwitchAudioSource`, —á—Ç–æ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞

**–†–µ—à–µ–Ω–∏–µ:** Debounce —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (0.5s), –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **`_start_audio_stream`** —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_run_async_in_thread` –≤–º–µ—Å—Ç–æ `asyncio.run_coroutine_threadsafe`
2. **–¢–∞–π–º–∞—É—Ç —É–º–µ–Ω—å—à–µ–Ω** —Å 15s –¥–æ 3-5s –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —É–º–µ–Ω—å—à–µ–Ω–æ** —Å 5 –¥–æ 2 –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ fallback
4. **`_stop_audio_stream`** —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_run_async_in_thread` –≤–º–µ—Å—Ç–æ `asyncio.run_coroutine_threadsafe`
5. **–õ–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ "—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å"** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

### ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ AudioStreamManager** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ –≤ `create_stream` –∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞—Ö–≤–∞—Ç–∞ lock
2. **–õ–æ–∂–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º)
3. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ª–æ–≥–∏** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç" (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ)
4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø–æ–ø—ã—Ç–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `result.attempt` –∏–∑ AudioStreamManager)
5. **Timeout playback.completed** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ `playback.completed` –¥–ª—è raw-—Å–µ—Å—Å–∏–π (welcome_message) —Å —Ç–∞–π–º–∞—É—Ç–æ–º 10s

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. **Debounce device_change_publisher** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–∏ polling —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ playback.completed** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–µ—Å—Å–∏–π

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–µ—à–µ–Ω–∞ –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Ç–∞–π–º–∞—É—Ç–∞
2. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ `AudioStreamManager.create_stream` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å device_change_publisher** - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–∏ polling —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
2. **Fallback –Ω–∞ device=None** - –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç
3. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** - –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω —Ç–∞–π–º–∞—É—Ç–∞

