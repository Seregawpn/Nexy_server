# Изолированные тесты для диагностики залипания микрофона

## Дата создания
2025-12-11

## Цель

Созданы изолированные тесты для диагностики проблемы залипания микрофона. Тесты проверяют:
- Race conditions между остановкой и callback'ами
- Дублирование логики остановки
- Конфликты между разными источниками остановки
- Синхронизацию состояния микрофона
- Последовательность событий при LONG_PRESS → SHORT_PRESS

## Список тестов

### 1. `scripts/test_google_microphone_stopping.py`

**Назначение**: Изолированная проверка состояния и остановки Google микрофона

**Тесты**:
- **Тест 1**: Проверка состояния Google микрофона
  - Начальное состояние
  - Состояние после активации
  - Состояние после остановки
  - Состояние после очистки

- **Тест 2**: Остановка Google микрофона при session mismatch
  - Активация микрофона с session_id
  - Сброс session_id
  - Публикация voice.recording_stop с оригинальным session_id
  - Проверка состояния после обработки

- **Тест 3**: Проверка физического состояния микрофона после остановки
  - Активация микрофона
  - Ожидание callback'ов
  - Остановка микрофона
  - Проверка, что callback'и не приходят после остановки

- **Тест 4**: Синхронизация состояния после остановки
  - Активация микрофона
  - Остановка при session mismatch
  - Проверка синхронизации state_manager и _google_recording_active

**Запуск**:
```bash
python scripts/test_google_microphone_stopping.py
```

---

### 2. `scripts/test_microphone_sticking_scenarios.py`

**Назначение**: Тестирование критических сценариев залипания микрофона

**Тесты**:
- **Тест 1**: LONG_PRESS → SHORT_PRESS
  - Симуляция LONG_PRESS
  - Симуляция SHORT_PRESS (прерывание)
  - Проверка, что микрофон остановлен

- **Тест 2**: Повторная активация после остановки
  - Первая активация
  - Остановка первой активации
  - Вторая активация
  - Проверка корректности второй активации

- **Тест 3**: Проверка физического состояния микрофона после остановки
  - Активация микрофона
  - Остановка с session mismatch
  - Проверка синхронизации состояния

**Запуск**:
```bash
python scripts/test_microphone_sticking_scenarios.py
```

---

### 3. `scripts/test_microphone_race_conditions.py`

**Назначение**: Проверка race conditions при остановке микрофона

**Тесты**:
- **Тест 1**: Race condition между остановкой и callback'ами
  - Активация микрофона с мониторингом callback'ов
  - Остановка микрофона параллельно с callback'ами
  - Анализ, сколько callback'ов пришло после остановки

- **Тест 2**: Дублирование логики остановки
  - Активация микрофона
  - Множественные источники остановки одновременно (session_id=None, session mismatch, нормальная остановка)
  - Анализ, сколько раз вызвана остановка

- **Тест 3**: Конфликты между разными источниками остановки
  - Сценарий 1: session_id сбрасывается ДО voice.recording_stop
  - Сценарий 2: session_id сбрасывается ПОСЛЕ voice.recording_stop
  - Проверка состояния после каждого сценария

- **Тест 4**: Последовательность событий при LONG_PRESS → SHORT_PRESS
  - Отслеживание всех событий (voice.recording_start, voice.recording_stop, playback.cancelled, microphone.opened, microphone.closed)
  - Анализ последовательности событий
  - Проверка финального состояния

- **Тест 5**: Одновременные попытки остановки из разных мест
  - Три попытки остановки одновременно (session_id=None, session mismatch, нормальная остановка)
  - Анализ попыток остановки
  - Проверка финального состояния

**Запуск**:
```bash
python scripts/test_microphone_race_conditions.py
```

---

### 4. `scripts/test_microphone_state_synchronization.py`

**Назначение**: Проверка синхронизации состояния микрофона

**Тесты**:
- **Тест 1**: Синхронизация после активации
  - Активация микрофона через событие
  - Проверка синхронизации state_manager, _google_recording_active, _google_stop_listening
  - Остановка микрофона
  - Проверка синхронизации после остановки

- **Тест 2**: Синхронизация после сброса session_id
  - Активация микрофона
  - Сброс session_id
  - Публикация voice.recording_stop
  - Проверка синхронизации

- **Тест 3**: Синхронизация после ошибки
  - Активация микрофона
  - Симуляция ошибки (установка _google_stop_listening в None)
  - Попытка остановки
  - Проверка синхронизации

- **Тест 4**: Синхронизация при множественных активациях
  - Три цикла активации/остановки
  - Проверка синхронизации после каждого цикла
  - Проверка финального состояния

**Запуск**:
```bash
python scripts/test_microphone_state_synchronization.py
```

---

### 5. `scripts/test_microphone_stop_duplicates.py`

**Назначение**: Проверка дублирования логики остановки микрофона

**Тесты**:
- **Тест 1**: Дублирование при session_id=None
  - Активация микрофона
  - Отслеживание вызовов _google_stop_listening, force_close_microphone, set_microphone_state('idle'), microphone.closed
  - Сброс session_id и публикация voice.recording_stop
  - Анализ дублирования

- **Тест 2**: Дублирование при session mismatch
  - Активация микрофона
  - Отслеживание вызовов
  - Публикация voice.recording_stop с другим session_id
  - Анализ дублирования

- **Тест 3**: Дублирование при нормальной остановке
  - Активация микрофона
  - Отслеживание вызовов
  - Нормальная остановка
  - Анализ дублирования

**Запуск**:
```bash
python scripts/test_microphone_stop_duplicates.py
```

---

## Как использовать тесты

### Последовательность запуска

1. **Сначала**: Запустите базовые тесты состояния
   ```bash
   python scripts/test_google_microphone_stopping.py
   ```

2. **Затем**: Запустите тесты сценариев
   ```bash
   python scripts/test_microphone_sticking_scenarios.py
   ```

3. **Далее**: Запустите тесты race conditions
   ```bash
   python scripts/test_microphone_race_conditions.py
   ```

4. **После**: Запустите тесты синхронизации
   ```bash
   python scripts/test_microphone_state_synchronization.py
   ```

5. **Наконец**: Запустите тесты дублирования
   ```bash
   python scripts/test_microphone_stop_duplicates.py
   ```

### Что искать в результатах

1. **Race conditions**:
   - Callback'и приходят после остановки
   - Множественные вызовы остановки
   - Неправильная последовательность событий

2. **Дублирование**:
   - `_google_stop_listening` вызывается более 1 раза
   - `force_close_microphone` вызывается более 1 раза
   - `microphone.closed` публикуется более 1 раза

3. **Рассинхронизация**:
   - `state_manager.is_microphone_active()` != `_google_recording_active`
   - `state_manager.is_microphone_active()` != `_google_stop_listening is not None`
   - Состояние не восстанавливается после ошибок

4. **Конфликты**:
   - Разные источники остановки конфликтуют
   - session_id сбрасывается в неправильный момент
   - События обрабатываются в неправильном порядке

---

## Ожидаемые результаты после исправления v2

После применения исправления v2 (защита callback от обработки после остановки):

1. ✅ **Нет race conditions**: Callback'и не обрабатываются после остановки
2. ✅ **Нет дублирования**: Каждая остановка вызывается только 1 раз
3. ✅ **Синхронизация**: state_manager и _google_recording_active всегда синхронизированы
4. ✅ **Нет конфликтов**: Разные источники остановки не конфликтуют

---

## Интерпретация результатов

### Если тесты показывают проблемы:

1. **Race condition обнаружена**:
   - Увеличить задержку перед остановкой (сейчас 0.1 сек)
   - Добавить дополнительную проверку в callback

2. **Дублирование обнаружено**:
   - Добавить защиту от повторных вызовов (флаг `_stopping_in_progress`)
   - Проверить, что остановка вызывается только в одном месте

3. **Рассинхронизация обнаружена**:
   - Улучшить логику синхронизации в finally блоке
   - Добавить проверку синхронизации после каждой операции

4. **Конфликты обнаружены**:
   - Добавить приоритеты для разных источников остановки
   - Улучшить обработку session_id при конфликтах

---

## Следующие шаги

После запуска всех тестов:

1. Проанализируйте результаты каждого теста
2. Определите, какие проблемы обнаружены
3. Примените дополнительные исправления на основе результатов
4. Повторите тесты для проверки исправлений

