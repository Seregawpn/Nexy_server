# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞—É–¥–∏–æ —Å–∏—Å—Ç–µ–º—ã Nexy

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-02  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-03  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–≤—Å–µ —Ñ–∞–∑—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã)

**–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- `Docs/AUDIO_SYSTEM_ROADMAP.md` - –ü–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–æ–∫ (—á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ / —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å)

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#1-–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [INPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ (–ó–∞—Ö–≤–∞—Ç —Ä–µ—á–∏)](#2-input-–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞-–∑–∞—Ö–≤–∞—Ç-—Ä–µ—á–∏)
3. [OUTPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ (–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)](#3-output-–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞-–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
4. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤](#4-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-—É—Å—Ç—Ä–æ–π—Å—Ç–≤)
5. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏ (AudioStreamManager)](#5-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–æ—Ç–æ–∫–∞–º–∏-audiostreammanager)
6. [–ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞](#6-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—É–∑–∫–∏–µ-–º–µ—Å—Ç–∞)
7. [–î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–æ–≤](#7-–¥–∏–∞–≥—Ä–∞–º–º—ã-–ø–æ—Ç–æ–∫–æ–≤)
8. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#8-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)
9. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#9-–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)
10. [–ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞—É–¥–∏–æ-—Å–∏—Å—Ç–µ–º—ã](#10-–ø–ª–∞–Ω-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞-–∞—É–¥–∏–æ-—Å–∏—Å—Ç–µ–º—ã)

---

## 1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã

**–°–æ–±—ã—Ç–∏–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (EventBus):**
- –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ `EventBus` (—Å–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—É–±–ª–∏–∫—É—é—Ç/–ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (async/await)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ–±—ã—Ç–∏–π (CRITICAL, HIGH, MEDIUM, LOW)

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–ú–æ–¥—É–ª–∏** (`modules/`) - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ (PortAudio, Core Audio)
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** (`integration/integrations/`) - –∞–¥–∞–ø—Ç–µ—Ä—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –∏ EventBus
- **Workflows** (`integration/workflows/`) - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
- **Core** (`integration/core/`) - –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (EventBus, StateManager, ErrorHandler)

**–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:**
- `ApplicationStateManager` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `session_id` - –∏–∑ `state_manager.get_current_session_id()`
- `AppMode` - —á–µ—Ä–µ–∑ `state_manager.set_mode()`

### 1.2 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    EventBus (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —à–∏–Ω–∞)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   INPUT       ‚îÇ   ‚îÇ   OUTPUT     ‚îÇ   ‚îÇ   DEVICE      ‚îÇ
‚îÇ   –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞  ‚îÇ   ‚îÇ   –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞  ‚îÇ   ‚îÇ   –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. INPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ (–ó–∞—Ö–≤–∞—Ç —Ä–µ—á–∏)

### 2.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 2.1.1 InputProcessingIntegration
**–§–∞–π–ª:** `integration/integrations/input_processing_integration.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (PRESS, LONG_PRESS, RELEASE, SHORT_PRESS)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (InputState: IDLE ‚Üí PENDING ‚Üí LISTENING ‚Üí PROCESSING)
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è `voice.recording_start` / `voice.recording_stop`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `_handle_press()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è (IDLE ‚Üí PENDING)
- `_handle_long_press()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è (PENDING ‚Üí LISTENING)
- `_handle_key_release()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è (LISTENING ‚Üí PROCESSING)
- `_can_start_recording()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∑–∞–ø–∏—Å–∏

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **Race condition**: LONG_PRESS –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –ø–æ—Å–ª–µ RELEASE, –ø—Ä–æ–≤–µ—Ä–∫–∞ `key_pressed` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- ‚ö†Ô∏è **–¢–∞–π–º–∞—É—Ç—ã**: `_ensure_playback_idle()` (0.5s) –∏ `_wait_for_mic_closed()` (1.0s) –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏
- ‚ö†Ô∏è **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: `_can_start_recording()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `keyboard_monitor.key_pressed`, –Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –º–µ–∂–¥—É LONG_PRESS –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π

#### 2.1.2 VoiceRecognitionIntegration
**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º —á–µ—Ä–µ–∑ `MicrophoneStateManager`
- –†–∞–±–æ—Ç–∞ —Å `SpeechRecognizer`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `_on_recording_start()` - –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
- `_on_recording_stop()` - –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏
- `_on_input_device_changed()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–°–æ–±—ã—Ç–∏—è:**
- –ü—É–±–ª–∏–∫—É–µ—Ç: `voice.recognition_started`, `voice.recognition_completed`, `voice.recognition_failed`
- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è: `voice.recording_start`, `voice.recording_stop`, `device.default_input_changed`

#### 2.1.3 SpeechRecognizer
**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å PortAudio
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PortAudio —Å—Ç—Ä–∏–º–∞–º–∏ —á–µ—Ä–µ–∑ `AudioStreamManager`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ `_audio_callback`
- **–í—ã–±–æ—Ä INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `start_listening()` - –∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏
- `stop_listening()` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
- `on_device_changed()` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `_select_default_input_device()` - –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å fallback
- `_device_is_available()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `_classify_input_device()` - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `AudioStreamManager` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏
- ‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `device.default_input_changed` –æ—Ç `DeviceChangePublisher`
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ**
- ‚úÖ **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ ‚Üí USB ‚Üí BT ‚Üí Remote)**
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `sd.check_input_settings()` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º**

#### 2.1.4 MicrophoneStateManager
**–§–∞–π–ª:** `modules/microphone_state/core/microphone_state_manager.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (IDLE, OPENING, OPEN, CLOSING)
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π `microphone.opened/closed/error`

### 2.2 –ü–æ—Ç–æ–∫ INPUT (–æ—Ç –Ω–∞–∂–∞—Ç–∏—è –¥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Ctrl+N (PRESS)
   ‚îî‚îÄ InputProcessingIntegration._handle_press()
      ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç pending_session_id = timestamp
      ‚îú‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: IDLE ‚Üí PENDING
      ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: keyboard.press

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Ctrl+N > 0.6s (LONG_PRESS)
   ‚îî‚îÄ InputProcessingIntegration._handle_long_press()
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∏ (_can_start_recording):
      ‚îÇ   ‚îú‚îÄ _input_state == PENDING?
      ‚îÇ   ‚îú‚îÄ _pending_session_id != None?
      ‚îÇ   ‚îú‚îÄ keyboard_monitor.key_pressed? ‚ö†Ô∏è RACE CONDITION
      ‚îÇ   ‚îî‚îÄ state_manager.is_microphone_active()?
      ‚îÇ
      ‚îú‚îÄ –û–∂–∏–¥–∞–Ω–∏—è:
      ‚îÇ   ‚îú‚îÄ _ensure_playback_idle() (—Ç–∞–π–º–∞—É—Ç 0.5s)
      ‚îÇ   ‚îî‚îÄ _wait_for_mic_closed() (—Ç–∞–π–º–∞—É—Ç 1.0s)
      ‚îÇ
      ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.recording_start{session_id}
         ‚îî‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: PENDING ‚Üí LISTENING

3. VoiceRecognitionIntegration –ø–æ–ª—É—á–∞–µ—Ç voice.recording_start
   ‚îî‚îÄ VoiceRecognitionIntegration._on_recording_start()
      ‚îú‚îÄ MicrophoneStateManager.request_open(session_id)
      ‚îÇ   ‚îú‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: IDLE ‚Üí OPENING
      ‚îÇ   ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.open_requested
      ‚îÇ
      ‚îî‚îÄ SpeechRecognizer.start_listening()
         ‚îú‚îÄ AudioStreamManager.create_stream(StreamConfig)
         ‚îÇ   ‚îú‚îÄ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
         ‚îÇ   ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π PortAudio InputStream
         ‚îÇ   ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç StreamOperationResult
         ‚îÇ
         ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.opened
         ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.mic_opened

4. SpeechRecognizer._audio_callback –ø–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫–∏
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ PortAudio
   ‚îú‚îÄ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, VAD)
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±—É—Ñ–µ—Ä –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—É—Å–∫–∞–µ—Ç Ctrl+N (RELEASE)
   ‚îî‚îÄ InputProcessingIntegration._handle_key_release()
      ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.recording_stop{session_id}
      ‚îî‚îÄ _wait_for_mic_closed() (—Ç–∞–π–º–∞—É—Ç 1.0s)

6. VoiceRecognitionIntegration –ø–æ–ª—É—á–∞–µ—Ç voice.recording_stop
   ‚îî‚îÄ VoiceRecognitionIntegration._on_recording_stop()
      ‚îú‚îÄ SpeechRecognizer.stop_listening()
      ‚îÇ   ‚îú‚îÄ AudioStreamManager.close_stream()
      ‚îÇ   ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: microphone.closed
      ‚îÇ
      ‚îî‚îÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
         ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: voice.recognition_completed{session_id, text}
            ‚îî‚îÄ –ü–µ—Ä–µ—Ö–æ–¥: LISTENING ‚Üí PROCESSING
```

### 2.3 –ü—Ä–æ–±–ª–µ–º—ã INPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Race condition –º–µ–∂–¥—É LONG_PRESS –∏ RELEASE
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- LONG_PRESS —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ 0.6s –ø–æ—Å–ª–µ PRESS
- RELEASE –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Ä–∞–Ω—å—à–µ –∏–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å LONG_PRESS
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `keyboard_monitor.key_pressed` –≤ `_can_start_recording()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–∑–∞–≤–∏—Å–∞–Ω–∏–µ"

**–õ–æ–≥–∏:**
```
‚ö†Ô∏è LONG_PRESS: –Ω–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å - key_not_pressed
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- –ù–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞–≤–∏—à–∏
- –°–æ—Å—Ç–æ—è–Ω–∏–µ `key_pressed` –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –º–µ–∂–¥—É LONG_PRESS –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ):**
- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞–≤–∏—à–∏ –≤ `_can_start_recording()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.Lock` –¥–ª—è –∑–∞—â–∏—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `_pending_recording_cancelled_event` –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π `voice.recording_start`

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –¢–∞–π–º–∞—É—Ç—ã –æ–∂–∏–¥–∞–Ω–∏—è
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_ensure_playback_idle()` - —Ç–∞–π–º–∞—É—Ç 0.5s (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º)
- `_wait_for_mic_closed()` - —Ç–∞–π–º–∞—É—Ç 1.0s (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º)
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ):**
- –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –î–æ–±–∞–≤–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤

### 2.4 –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback)

#### 2.4.1 –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ú–µ—Ç–æ–¥:** `SpeechRecognizer._select_default_input_device(strict=True)`

**–®–∞–≥–∏:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   ```python
   default_input = self._get_system_default_input_index()
   # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sd.default.device[0] (–µ—Å–ª–∏ feature flag device_switch_v2 –≤–∫–ª—é—á–µ–Ω)
   # –ò–ª–∏ SwitchAudioSource (fallback)
   ```

2. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
   ```python
   candidates = [default_input]  # –ü–µ—Ä–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç - —Å–∏—Å—Ç–µ–º–Ω—ã–π default
   
   # –î–æ–±–∞–≤–ª—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   sorted_indices = sorted(
       (idx for idx, dev in enumerate(devices_snapshot)
        if dev.get('max_input_channels', 0) > 0 and idx != default_input),
       key=lambda idx: self._classify_input_device(devices_snapshot[idx].get('name', ''))
   )
   candidates.extend(sorted_indices)  # [0, 3, 2] - –ø—Ä–∏–º–µ—Ä: AirPods, MacBook, –¥—Ä—É–≥–æ–µ
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:**
   ```python
   for candidate in candidates:
       info = sd.query_devices(candidate, 'input')
       if not self._device_is_available(candidate, info):
           continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
       return candidate, info  # ‚úÖ –£—Å–ø–µ—Ö!
   ```

#### 2.4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ú–µ—Ç–æ–¥:** `SpeechRecognizer._device_is_available(device_id, device_info)`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –í—ã–∑–æ–≤ `sd.check_input_settings()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ `samplerate`, `channels`, `dtype`
- –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ

**–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≥–æ—Ç–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
- –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∏—Å—Ç–µ–º—ã

#### 2.4.3 –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

**–ú–µ—Ç–æ–¥:** `SpeechRecognizer._classify_input_device(name)`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (–º–µ–Ω—å—à–µ = –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ):**

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 0: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - `MacBook Air Microphone`, `Built-in Microphone`
   - –°–∞–º—ã–µ –Ω–∞–¥–µ–∂–Ω—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ

2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: USB/–≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - USB –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã, –≤–Ω–µ—à–Ω–∏–µ –∞—É–¥–∏–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
   - –•–æ—Ä–æ—à–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - `Sergiy's AirPods`, `AirPods Pro`
   - –ú–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω, –Ω–µ –≥–æ—Ç–æ–≤)
   - –¢—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é

4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - –£–¥–∞–ª–µ–Ω–Ω—ã–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã, —Å–µ—Ç–µ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –ù–∞–∏–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–µ

#### 2.4.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ PortAudio —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

**–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BT –∫–∞–∫ INPUT:**

1. **–û—à–∏–±–∫–∞ -10851 (Invalid Property Value):**
   - –ü—Ä–∏—á–∏–Ω–∞: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ (`blocksize`, `latency`)
   - –†–µ—à–µ–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

2. **–û—à–∏–±–∫–∞ -9986 (Internal PortAudio error):**
   - –ü—Ä–∏—á–∏–Ω–∞: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ –∏–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤–æ
   - –†–µ—à–µ–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
üîç [SELECT] –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ID 0...
üîç [SELECT] ID 0: "Sergiy's AirPods"
‚ö†Ô∏è check_input_settings –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Sergiy's AirPods (id=0) –Ω–µ –ø—Ä–æ–π–¥–µ–Ω: Internal PortAudio error [PaErrorCode -9986]
‚ö†Ô∏è [SELECT] ID 0 ("Sergiy's AirPods"): —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
üîç [SELECT] –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ID 3...
üîç [SELECT] ID 3: "MacBook Air Microphone"
‚úÖ [SELECT] –í–´–ë–†–ê–ù: ID 3 - "MacBook Air Microphone"
```

#### 2.4.5 –ü–æ—á–µ–º—É —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è

**–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:**

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback:**
   - –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Üí –ø—Ä–æ–±—É—é—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–µ—Ä–≤—ã–º–∏

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:**
   - `_device_is_available()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ `sd.check_input_settings()`
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞

3. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
   - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–º–µ—é—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
   - BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–º–µ—é—Ç –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)

**–≠—Ç–æ –Ω–µ –±–∞–≥, –∞ –∑–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º:**
- –°–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É (—Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ)

---

## 3. OUTPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ (–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)

### 3.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 3.1.1 SpeechPlaybackIntegration
**–§–∞–π–ª:** `integration/integrations/speech_playback_integration.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤ –æ—Ç gRPC —Å–µ—Ä–≤–µ—Ä–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `SequentialSpeechPlayer`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `_on_audio_chunk()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —á–∞–Ω–∫–∞
- `_on_output_device_changed()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `_on_unified_interrupt()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

**–°–æ–±—ã—Ç–∏—è:**
- –ü—É–±–ª–∏–∫—É–µ—Ç: `playback.started`, `playback.completed`, `playback.failed`
- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è: `grpc.response.audio`, `device.default_output_changed`, `playback.cancelled`

#### 3.1.2 SequentialSpeechPlayer
**–§–∞–π–ª:** `modules/speech_playback/core/player.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å PortAudio –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PortAudio —Å—Ç—Ä–∏–º–∞–º–∏ —á–µ—Ä–µ–∑ `AudioStreamManager`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ `_audio_callback`
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (`ChunkBuffer`)

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `_start_audio_stream()` - –∑–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- `_stop_audio_stream()` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
- `_switch_output_device()` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `_audio_callback()` - callback –¥–ª—è PortAudio

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `AudioStreamManager` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏
- ‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `device.default_output_changed` –æ—Ç `DeviceChangePublisher`
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (device=None, —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏)
- ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (2025-12-02)
- ‚úÖ **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π** (`_switch_sequence_counter`) –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ **Guard –∑–∞—â–∏—Ç–∞** (`_switch_in_progress`) –æ—Ç concurrent –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ **–ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π** (`_last_successful_config`) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚ö†Ô∏è **Lazy start** - –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —á–∞–Ω–∫–µ (–º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)

### 3.2 –ü–æ—Ç–æ–∫ OUTPUT (–æ—Ç gRPC –æ—Ç–≤–µ—Ç–∞ –¥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)

```
1. GrpcClientIntegration –ø–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
   ‚îî‚îÄ GrpcClientIntegration._on_audio_chunk()
      ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: grpc.response.audio{bytes, session_id}

2. SpeechPlaybackIntegration –ø–æ–ª—É—á–∞–µ—Ç grpc.response.audio
   ‚îî‚îÄ SpeechPlaybackIntegration._on_audio_chunk()
      ‚îú‚îÄ –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ (WAV header skip, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
      ‚îî‚îÄ SequentialSpeechPlayer.add_audio_data(audio_data, session_id)

3. SequentialSpeechPlayer.add_audio_data()
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–ª–µ–µ—Ä–∞
   ‚îú‚îÄ –î–æ–±–∞–≤–ª—è–µ—Ç —á–∞–Ω–∫ –≤ ChunkBuffer
   ‚îî‚îÄ –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ —Å–æ–∑–¥–∞–Ω ‚Üí _start_audio_stream()
      ‚îú‚îÄ AudioStreamManager.create_stream(StreamConfig)
      ‚îÇ   ‚îú‚îÄ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      ‚îÇ   ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π PortAudio OutputStream
      ‚îÇ   ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç StreamOperationResult
      ‚îÇ
      ‚îî‚îÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç playback thread

4. SequentialSpeechPlayer._audio_callback (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è PortAudio)
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ ChunkBuffer
   ‚îú‚îÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   ‚îî‚îÄ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ outdata (PortAudio)

5. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
   ‚îî‚îÄ SequentialSpeechPlayer._on_playback_completed()
      ‚îú‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: playback.completed{session_id}
      ‚îî‚îÄ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioStreamManager
```

### 3.3 –ü—Ä–æ–±–ª–µ–º—ã OUTPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –¢–∞–π–º–∞—É—Ç switch_device (15+ —Å–µ–∫—É–Ω–¥) ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_switch_output_device()` –≤—ã–∑—ã–≤–∞–ª `AudioStreamManager.switch_device()`
- –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º thread —á–µ—Ä–µ–∑ `_run_async_in_thread()`
- –¢–∞–π–º–∞—É—Ç: 15s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, 30s –¥–ª—è BT
- –ü—Ä–∏ –æ—à–∏–±–∫–µ PortAudio (-9986, -10851) –æ–ø–µ—Ä–∞—Ü–∏—è –º–æ–≥–ª–∞ –∑–∞–Ω—è—Ç—å 15+ —Å–µ–∫—É–Ω–¥

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è switch_device: **5s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, 10s –¥–ª—è BT**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: **2 –≤–º–µ—Å—Ç–æ 5**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `_audio_stream == None` –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
- ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `create_stream()` –≤–º–µ—Å—Ç–æ `switch_device()` (—Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ —É–∂–µ –∑–∞–∫—Ä—ã—Ç)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –¢–∞–π–º–∞—É—Ç—ã: 5s (–æ–±—ã—á–Ω—ã–µ), 10s (BT)
- –ü–æ–ø—ã—Ç–∫–∏: 2 (–≤–º–µ—Å—Ç–æ 5)
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∏ PortAudio –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –û—à–∏–±–∫–∏ -9986 (Internal PortAudio error) –∏ -10851 (Audio Unit: Invalid Property Value)
- –ß–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`_last_successful_config`)
- ‚úÖ –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `device=None` (macOS —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ (—É—Å—Ç—Ä–∞–Ω—è–µ—Ç "—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ")
- ‚úÖ Fallback –Ω–∞ `device=None` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö -9986/-10851

**–û—Å—Ç–∞—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –û—à–∏–±–∫–∏ -10851 –≤—Å–µ –µ—â–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (—Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
- ‚ö†Ô∏è Retry –ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –¥–∞–∂–µ —Å 2 –ø–æ–ø—ã—Ç–∫–∞–º–∏

**–õ–æ–≥–∏ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```
‚úÖ [OUTPUT][seq=123] close_stream –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ
‚úÖ [OUTPUT] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç (_audio_stream=None)
üîç [OUTPUT][seq=123] –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioStreamManager.create_stream
```

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: Lazy start –ø–æ—Ç–æ–∫–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —á–∞–Ω–∫–µ (`add_audio_data()`)
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ):**
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞
- –ò–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `grpc.response.audio` (–¥–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)

### 3.4 –ü–æ–ª–∏—Ç–∏–∫–∞ OUTPUT –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (2025-12-03)

**–¶–µ–ª—å:** OUTPUT –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ —Å–µ–±—è —Ç–∞–∫ –∂–µ —É–º–Ω–æ, –∫–∞–∫ INPUT (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π output)

#### 3.4.1 –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å fallback

**–ú–µ—Ç–æ–¥:** `SequentialSpeechPlayer._select_default_output_device(strict=True)`

**–®–∞–≥–∏:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   ```python
   default_output_name, default_output_id = self._query_system_default_output()
   # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sd.default.device[1] (–µ—Å–ª–∏ feature flag device_switch_v2 –≤–∫–ª—é—á–µ–Ω)
   # –ò–ª–∏ SwitchAudioSource (fallback)
   ```

2. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
   ```python
   candidates = [default_output_id]  # –ü–µ—Ä–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç - —Å–∏—Å—Ç–µ–º–Ω—ã–π default
   
   # –î–æ–±–∞–≤–ª—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   sorted_indices = sorted(
       (idx for idx, dev in enumerate(devices_snapshot)
        if dev.get('max_output_channels', 0) > 0 and idx != default_output_id),
       key=lambda idx: self._classify_output_device(devices_snapshot[idx].get('name', ''))
   )
   candidates.extend(sorted_indices)  # [0, 3, 2] - –ø—Ä–∏–º–µ—Ä: MacBook Speakers, USB, AirPods
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:**
   ```python
   for candidate in candidates:
       info = sd.query_devices(candidate, 'output')
       if not self._device_is_available(candidate, info):
           continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
       return candidate, info  # ‚úÖ –£—Å–ø–µ—Ö!
   ```

#### 3.4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ú–µ—Ç–æ–¥:** `SequentialSpeechPlayer._device_is_available(device_id, device_info)`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –í—ã–∑–æ–≤ `sd.check_output_settings()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ `samplerate`, `channels`, `dtype`
- –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ

**–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≥–æ—Ç–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
- –î–∏–Ω–∞–º–∏–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∏—Å—Ç–µ–º—ã

#### 3.4.3 –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

**–ú–µ—Ç–æ–¥:** `SequentialSpeechPlayer._classify_output_device(name)`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (–º–µ–Ω—å—à–µ = –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ):**

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 0: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - `MacBook Air Speakers`, `Built-in Output`
   - –°–∞–º—ã–µ –Ω–∞–¥–µ–∂–Ω—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ

2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: USB/–≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - USB –¥–∏–Ω–∞–º–∏–∫–∏, –≤–Ω–µ—à–Ω–∏–µ –∞—É–¥–∏–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
   - –•–æ—Ä–æ—à–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - `Sergiy's AirPods`, `AirPods Pro`
   - –ú–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏, —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
   - iPhone, iPad —á–µ—Ä–µ–∑ Continuity
   - –ù–∞–∏–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–µ

#### 3.4.4 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞

**–ú–µ—Ç–æ–¥:** `SequentialSpeechPlayer._switch_output_device()`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:**
   ```python
   result = self._stream_manager.create_stream(stream_config, max_retries=2)
   ```

2. **–ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º**

3. **–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º fallback:**
   ```python
   # –ò—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   fallback_device_id, fallback_device_info = self._select_default_output_device(strict=False)
   
   if fallback_device_id is not None:
       # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ fallback —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
       self._switch_output_device(fallback_device_name, fallback_device_id, fallback_is_bluetooth)
   else:
       # –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (device=None)
       fallback_config = StreamConfig(device_id=None, ...)  # –°–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç
       result = self._stream_manager.create_stream(fallback_config, max_retries=1)
   ```

#### 3.4.5 –ì–∞—Ä–∞–Ω—Ç–∏—è "–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π output"

**–ü–æ–ª–∏—Ç–∏–∫–∞:** "–õ—É—á—à–µ –∏–≥—Ä–∞–µ—Ç –Ω–µ —Ç—É–¥–∞, –∫—É–¥–∞ —Ö–æ—Ç–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–æ –∏–≥—Ä–∞–µ—Ç"

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

1. **–ï—Å–ª–∏ –≤—Å–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (`device=None`)
   - macOS —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç —Ä–∞–±–æ—á–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –º–æ–Ω–æ, —Å–∏—Å—Ç–µ–º–Ω—ã–π sample rate

2. **–ï—Å–ª–∏ –¥–∞–∂–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   - –õ–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É: `OUTPUT_UNAVAILABLE`
   - –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º `RuntimeError("OUTPUT_UNAVAILABLE: –í—Å–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")`
   - Guard —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–Ω–æ–≤–∞

**–õ–æ–≥–∏ (–ø—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ fallback):**
```
‚ö†Ô∏è [OUTPUT][seq=123] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ –¥–ª—è "Sergiy's AirPods" (ID=1, BT=True): ...
üîÑ [OUTPUT][seq=123] –ó–∞–ø—É—Å–∫–∞–µ–º fallback: –ø–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...
‚úÖ [OUTPUT][SELECT] –í–´–ë–†–ê–ù: ID 2 - "MacBook Air Speakers"
‚úÖ [OUTPUT][seq=123] Fallback –Ω–∞–π–¥–µ–Ω: "MacBook Air Speakers" (ID=2, BT=False)
‚úÖ [OUTPUT][seq=123] –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º (device=None) - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π output
```

**–õ–æ–≥–∏ (–ø—Ä–∏–º–µ—Ä fallback –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç):**
```
‚ö†Ô∏è [OUTPUT][seq=123] –í—Å–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (device=None)
üîç [OUTPUT][seq=123] –°–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º (device=None)...
‚úÖ [OUTPUT][seq=123] –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º (device=None) - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π output
```

---

## 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### 4.1 DeviceChangePublisher
**–§–∞–π–ª:** `modules/audio_core/device_change_publisher.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ï–¥–∏–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ INPUT –∏ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
- Fallback –Ω–∞ polling –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Core Audio
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ EventBus

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `start_monitoring()` - –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `_on_input_device_changed_core_audio()` - callback –¥–ª—è INPUT –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π
- `_on_output_device_changed_core_audio()` - callback –¥–ª—è OUTPUT –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π
- `_polling_loop()` - fallback polling —Ü–∏–∫–ª

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CoreAudioDeviceManager` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
- ‚úÖ –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è polling fallback
- ‚úÖ Debounce –º–µ—Ö–∞–Ω–∏–∑–º (300ms) –¥–ª—è rapid device switch
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `DeviceInfo` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:
  - `name`, `device_id` (PortAudio), `is_bluetooth`, `is_builtin`, `is_external`
  - `core_audio_id`, `uid` (—É—Å—Ç–æ–π—á–∏–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã Core Audio)
  - `portaudio_index`, `max_input_channels`, `max_output_channels`, `default_samplerate`
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ `device_id` –∏–ª–∏ `uid` (–Ω–µ –ø–æ –∏–º–µ–Ω–∏) –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ SwitchAudioSource –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag `device_switch_v2` –≤—ã–∫–ª—é—á–µ–Ω)

### 4.2 DeviceChangePublisherIntegration
**–§–∞–π–ª:** `integration/integrations/device_change_publisher_integration.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ DeviceChangePublisher
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ INPUT/OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### 4.3 –ü–æ—Ç–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

```
1. DeviceChangePublisher.start_monitoring()
   ‚îú‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—É—â–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   ‚îú‚îÄ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   ‚îÇ   ‚îú‚îÄ –£—Å–ø–µ—Ö ‚Üí –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è polling
   ‚îÇ   ‚îî‚îÄ –û—à–∏–±–∫–∞ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è polling fallback
   ‚îÇ
   ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: device.monitoring_started

2. Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
   ‚îî‚îÄ CoreAudioManager callback
      ‚îú‚îÄ DeviceChangePublisher._on_input_device_changed_core_audio()
      ‚îÇ   ‚îî‚îÄ _handle_device_change("input", new_device, CORE_AUDIO)
      ‚îÇ
      ‚îî‚îÄ DeviceChangePublisher._on_output_device_changed_core_audio()
         ‚îî‚îÄ _handle_device_change("output", new_device, CORE_AUDIO)

3. Polling fallback (–µ—Å–ª–∏ Core Audio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
   ‚îî‚îÄ DeviceChangePublisher._polling_loop()
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª 1.0s –∏–ª–∏ 5.0s –¥–ª—è BT)
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª 1.0s –∏–ª–∏ 5.0s –¥–ª—è BT)
      ‚îî‚îÄ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí _handle_device_change(..., POLLING)

4. _handle_device_change() (—Å debounce 300ms)
   ‚îî‚îÄ –ü—É–±–ª–∏–∫—É–µ—Ç: device.default_input_changed / device.default_output_changed
      ‚îú‚îÄ VoiceRecognitionIntegration._on_input_device_changed()
      ‚îÇ   ‚îî‚îÄ SpeechRecognizer.on_device_changed()
      ‚îÇ
      ‚îî‚îÄ SpeechPlaybackIntegration._on_output_device_changed()
         ‚îî‚îÄ SequentialSpeechPlayer._switch_output_device()
```

### 4.4 –ü—Ä–æ–±–ª–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-03)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_get_device_name_via_macos_api()` –≤—ã–∑—ã–≤–∞–ª `subprocess.run()` —Å —Ç–∞–π–º–∞—É—Ç–æ–º 1s
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –∏–ª–∏ –æ—à–∏–±–∫–µ –º–æ–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (TTL 0.5s) –ø–æ–º–æ–≥–∞–ª–æ, –Ω–æ –Ω–µ —Ä–µ—à–∞–ª–æ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª–Ω–æ—Å—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫:** `CoreAudioDeviceManager` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `sounddevice` (PortAudio) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- ‚úÖ **Feature flag:** `device_switch_v2` –≤–∫–ª—é—á–∞–µ—Ç –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –±–µ–∑ SwitchAudioSource
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource —á–µ—Ä–µ–∑ `asyncio.to_thread` –≤ `_check_and_update_output_device()` (fallback)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (TTL 0.5s) –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ (fallback)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `_device_check_in_progress` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è concurrent –≤—ã–∑–æ–≤–æ–≤
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ `cannot access local variable 'old_device_name'` –≤ `_check_and_update_output_device()`

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ SwitchAudioSource –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag –≤—ã–∫–ª—é—á–µ–Ω)
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö ‚Äî `CoreAudioDeviceManager` (—á–µ—Ä–µ–∑ PortAudio)
- ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±–ª–æ–∫–∞—Ö (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å `old_device_name`)

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: Race conditions –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –°—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –º–æ–≥ –Ω–µ —É—Å–ø–µ—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—à–∏–±–∫–∏ PortAudio, –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ **Guard –∑–∞—â–∏—Ç–∞** (`_switch_in_progress`) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —á–µ—Ä–µ–∑ `_stop_audio_stream()`
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞** (`_audio_stream == None`) –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
- ‚úÖ **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π** (`_switch_sequence_counter`) –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ –¢–∞–π–º–∞—É—Ç guard (10s) –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∑–∞–ª–∏–ø–∞–Ω–∏—è

---

## 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏ (AudioStreamManager)

### 5.1 AudioStreamManager
**–§–∞–π–ª:** `modules/audio_core/stream_manager.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- Lock –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç concurrent –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–∂–∏–¥–∞–Ω–∏–µ `active=False` –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ—Ç–æ–∫–∞
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (2.5—Å –¥–ª—è BT, 0.3—Å –¥–ª—è –æ–±—ã—á–Ω—ã—Ö)
- Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ -9986/-10851

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `create_stream()` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- `close_stream()` - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞
- `switch_device()` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ + —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `_close_delay_bt = 2.5` —Å–µ–∫—É–Ω–¥ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `_close_delay_normal = 0.3` —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `_max_wait_active_bt = 3.0` —Å–µ–∫—É–Ω–¥ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `_max_wait_active_normal = 1.0` —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `_max_retries = 2` –ø–æ–ø—ã—Ç–æ–∫ (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 5, 2025-12-02)
- `_base_retry_delay = 0.5` —Å–µ–∫—É–Ω–¥

**–£–ª—É—á—à–µ–Ω–∏—è (2025-12-02):**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å 5 –¥–æ 2 –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ fallback
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –≤ `_switch_output_device()`
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

### 5.2 –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞

```
1. create_stream(StreamConfig)
   ‚îú‚îÄ –ó–∞—Ö–≤–∞—Ç lock (_lock)
   ‚îú‚îÄ –ó–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   ‚îÇ   ‚îî‚îÄ _close_stream_safe(old_stream, is_bluetooth)
   ‚îÇ       ‚îú‚îÄ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ (stream.stop())
   ‚îÇ       ‚îú‚îÄ –û–∂–∏–¥–∞–Ω–∏–µ active=False (—Ç–∞–π–º–∞—É—Ç 3.0s –¥–ª—è BT, 1.0s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö)
   ‚îÇ       ‚îú‚îÄ –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ (stream.close())
   ‚îÇ       ‚îî‚îÄ –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è (2.5s –¥–ª—è BT, 0.3s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö)
   ‚îÇ
   ‚îî‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (retry –¥–æ 2 –ø–æ–ø—ã—Ç–æ–∫)
      ‚îú‚îÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (_prepare_stream_params)
      ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ PortAudio –ø–æ—Ç–æ–∫–∞ (sd.InputStream/OutputStream)
      ‚îú‚îÄ –ü—Ä–∏ –æ—à–∏–±–∫–µ -9986/-10851:
      ‚îÇ   ‚îú‚îÄ –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry (√ó2 –¥–ª—è BT)
      ‚îÇ   ‚îî‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
      ‚îÇ
      ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—Ç StreamOperationResult
```

### 5.3 –ü—Ä–æ–±–ª–µ–º—ã AudioStreamManager

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞ ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –û–∂–∏–¥–∞–Ω–∏–µ `active=False` –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 3.0s –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ `close()` - 2.5s –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è: –¥–æ 5.5s –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤ `_switch_output_device()`
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `_audio_stream == None` –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è

**–û—Å—Ç–∞—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∏ –≤—Å–µ –µ—â–µ –±–æ–ª—å—à–∏–µ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2.5s –ø–æ—Å–ª–µ close)
- ‚ö†Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ `active=False` –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 3.0s –¥–ª—è BT

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: Retry –ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
- –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞–¥–µ—Ä–∂–∫–∞ —É–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 0.5s √ó 2^4 √ó 2 = 16s (–¥–ª—è BT –Ω–∞ 5-–π –ø–æ–ø—ã—Ç–∫–µ)

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: **2 –≤–º–µ—Å—Ç–æ 5**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã: **5s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 10s –¥–ª—è BT** (–≤–º–µ—Å—Ç–æ 15s/30s)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π fallback –Ω–∞ `device=None` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö -9986/-10851
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –º–Ω–æ–≥–∏–µ –æ—à–∏–±–∫–∏

---

## 6. –ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

### 6.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à–∏ ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∂–∏–º–∞–µ—Ç Ctrl+N, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- –í –ª–æ–≥–∞—Ö: "‚ö†Ô∏è LONG_PRESS: –Ω–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å - key_not_pressed"
- –ò–ª–∏: "‚ùå [OUTPUT] –¢–∞–π–º–∞—É—Ç switch_device (15.0—Å)"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. **Race condition**: LONG_PRESS –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ RELEASE, –ø—Ä–æ–≤–µ—Ä–∫–∞ `key_pressed` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` ‚ö†Ô∏è –ù–ï –ò–°–ü–†–ê–í–õ–ï–ù–û
2. **–¢–∞–π–º–∞—É—Ç switch_device**: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–Ω–∏–º–∞–ª–æ 15+ —Å–µ–∫—É–Ω–¥ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
3. **–û—à–∏–±–∫–∏ PortAudio**: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –Ω–µ —É–¥–∞–≤–∞–ª–æ—Å—å –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è switch_device (5s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 10s –¥–ª—è BT)
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (2 –≤–º–µ—Å—Ç–æ 5)
- ‚ö†Ô∏è –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞–≤–∏—à–∏ –≤ `_can_start_recording()` - –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∏ PortAudio –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –û—à–∏–±–∫–∏ -9986 (Internal PortAudio error) –∏ -10851 (Audio Unit: Invalid Property Value)
- –ß–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`_last_successful_config`)
- ‚úÖ –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `device=None` (macOS —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ (—É—Å—Ç—Ä–∞–Ω—è–µ—Ç "—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ")
- ‚úÖ Fallback –Ω–∞ `device=None` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö -9986/-10851

**–û—Å—Ç–∞—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –û—à–∏–±–∫–∏ -10851 –≤—Å–µ –µ—â–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (—Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: –î–æ–ª–≥–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–Ω–∏–º–∞–ª–æ 15+ —Å–µ–∫—É–Ω–¥
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ `_run_async_in_thread()`

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è switch_device: **5s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 10s –¥–ª—è BT**
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: **2 –≤–º–µ—Å—Ç–æ 5**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `create_stream()` –≤–º–µ—Å—Ç–æ `switch_device()` (—Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ —É–∂–µ –∑–∞–∫—Ä—ã—Ç)

### 6.2 –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Lazy start –ø–æ—Ç–æ–∫–∞ OUTPUT
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —á–∞–Ω–∫–µ (`add_audio_data()`)
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞
- –ò–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `grpc.response.audio` (–¥–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_get_device_name_via_macos_api()` –≤—ã–∑—ã–≤–∞–µ—Ç `subprocess.run()` —Å —Ç–∞–π–º–∞—É—Ç–æ–º 1s
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –∏–ª–∏ –æ—à–∏–±–∫–µ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource —á–µ—Ä–µ–∑ `asyncio.to_thread` –≤ `_check_and_update_output_device()`
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (TTL 0.5s) –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤

**–û—Å—Ç–∞—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –≤—Å–µ –µ—â–µ 1s (–º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 0.5s)
- ‚ö†Ô∏è –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `subprocess.run()`

### 6.3 –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Race conditions –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-02)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –°—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –º–æ–≥ –Ω–µ —É—Å–ø–µ—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- ‚úÖ Guard –∑–∞—â–∏—Ç–∞ (`_switch_in_progress`) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –æ–∂–∏–¥–∞–Ω–∏—è
**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `_ensure_playback_idle()` - —Ç–∞–π–º–∞—É—Ç 0.5s (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º)
- `_wait_for_mic_closed()` - —Ç–∞–π–º–∞—É—Ç 1.0s (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º)

**–†–µ—à–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ):**
- –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –î–æ–±–∞–≤–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤

---

## 7. –î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–æ–≤

### 7.1 –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª INPUT (–æ—Ç –Ω–∞–∂–∞—Ç–∏—è –¥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Ctrl+N
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ InputProcessing         ‚îÇ
‚îÇ _handle_press()         ‚îÇ
‚îÇ IDLE ‚Üí PENDING          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ keyboard.press
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚îÇ
‚îÇ Ctrl+N > 0.6s          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ InputProcessing         ‚îÇ
‚îÇ _handle_long_press()    ‚îÇ
‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∏:               ‚îÇ
‚îÇ - _input_state == PENDING‚îÇ
‚îÇ - key_pressed? ‚ö†Ô∏è RACE  ‚îÇ
‚îÇ - mic_active?           ‚îÇ
‚îÇ PENDING ‚Üí LISTENING     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ voice.recording_start
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ VoiceRecognition        ‚îÇ
‚îÇ _on_recording_start()   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ microphone.open_requested
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MicrophoneStateManager  ‚îÇ
‚îÇ request_open()          ‚îÇ
‚îÇ IDLE ‚Üí OPENING          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ SpeechRecognizer.start_listening()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AudioStreamManager      ‚îÇ
‚îÇ create_stream()         ‚îÇ
‚îÇ - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫‚îÇ
‚îÇ - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ - Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ microphone.opened
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SpeechRecognizer        ‚îÇ
‚îÇ _audio_callback()      ‚îÇ
‚îÇ –ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—É—Å–∫–∞–µ—Ç Ctrl+N
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ InputProcessing         ‚îÇ
‚îÇ _handle_key_release()   ‚îÇ
‚îÇ voice.recording_stop    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ voice.recording_stop
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ VoiceRecognition        ‚îÇ
‚îÇ _on_recording_stop()    ‚îÇ
‚îÇ - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ voice.recognition_completed
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LISTENING ‚Üí PROCESSING  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.2 –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª OUTPUT (–æ—Ç gRPC –¥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)

```
gRPC —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ GrpcClientIntegration  ‚îÇ
‚îÇ _on_audio_chunk()       ‚îÇ
‚îÇ grpc.response.audio     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ grpc.response.audio
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SpeechPlayback          ‚îÇ
‚îÇ _on_audio_chunk()       ‚îÇ
‚îÇ - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ      ‚îÇ
‚îÇ - add_audio_data()      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ —Å–æ–∑–¥–∞–Ω
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SequentialSpeechPlayer ‚îÇ
‚îÇ _start_audio_stream()   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ AudioStreamManager.create_stream()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AudioStreamManager      ‚îÇ
‚îÇ create_stream()         ‚îÇ
‚îÇ - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫‚îÇ
‚îÇ - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ - Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ PortAudio OutputStream
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SequentialSpeechPlayer ‚îÇ
‚îÇ _audio_callback()      ‚îÇ
‚îÇ - –ü–æ–ª—É—á–∞–µ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞    ‚îÇ
‚îÇ - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ outdata  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ playback.completed      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3 –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û

```
DeviceChangePublisher –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å–º–µ–Ω—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DeviceChangePublisher  ‚îÇ
‚îÇ _on_output_device_     ‚îÇ
‚îÇ changed_core_audio()   ‚îÇ
‚îÇ device.default_output_ ‚îÇ
‚îÇ changed                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ device.default_output_changed
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SpeechPlayback          ‚îÇ
‚îÇ _on_output_device_     ‚îÇ
‚îÇ changed()               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ _switch_output_device()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SequentialSpeechPlayer ‚îÇ
‚îÇ _switch_output_device() ‚îÇ
‚îÇ [seq=123]               ‚îÇ
‚îÇ - Guard –∑–∞—â–∏—Ç–∞          ‚îÇ
‚îÇ - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ - ‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π   ‚îÇ
‚îÇ   –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑           ‚îÇ
‚îÇ   _stop_audio_stream()  ‚îÇ
‚îÇ - –ü—Ä–æ–≤–µ—Ä–∫–∞ _audio_stream‚îÇ
‚îÇ   == None               ‚îÇ
‚îÇ - –û—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä         ‚îÇ
‚îÇ - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ   —á–µ—Ä–µ–∑ create_stream() ‚îÇ
‚îÇ   (—Ç–∞–π–º–∞—É—Ç 5s/10s) ‚úÖ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ AudioStreamManager.create_stream()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AudioStreamManager      ‚îÇ
‚îÇ create_stream()         ‚îÇ
‚îÇ - –°—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ —É–∂–µ      ‚îÇ
‚îÇ   –∑–∞–∫—Ä—ã—Ç ‚úÖ             ‚îÇ
‚îÇ - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫   ‚îÇ
‚îÇ   (retry –¥–æ 2 –ø–æ–ø—ã—Ç–æ–∫) ‚úÖ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –£—Å–ø–µ—Ö –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ—Ç–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω        ‚îÇ
‚îÇ (–∏–ª–∏ –æ—à–∏–±–∫–∞)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 8. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 8.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ LONG_PRESS** ‚ö†Ô∏è –í –ü–†–û–¶–ï–°–°–ï
   - –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞–≤–∏—à–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.Lock` –¥–ª—è –∑–∞—â–∏—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `_pending_recording_cancelled_event` –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π

2. **–£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç switch_device** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ 5s –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤–º–µ—Å—Ç–æ 15s)
   - ‚úÖ 10s –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤–º–µ—Å—Ç–æ 30s)
   - ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (2 –≤–º–µ—Å—Ç–æ 5)

3. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ PortAudio** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`_last_successful_config`)
   - ‚úÖ –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è device=None
   - ‚úÖ Fallback –Ω–∞ device=None –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö -9986/-10851

### 8.2 –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ OUTPUT –ø–æ—Ç–æ–∫–∞** ‚ö†Ô∏è –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
   - –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞
   - –ò–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `grpc.response.audio` (–¥–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource** ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `asyncio.to_thread` –≤ `_check_and_update_output_device()`
   - ‚ö†Ô∏è –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `subprocess.run()`
   - ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –≤—Å–µ –µ—â–µ 1s (–º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 0.5s)

3. **–£–ª—É—á—à–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (TTL 0.5s) –≤ DeviceChangePublisher
   - ‚úÖ –ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`_last_successful_config`) –≤ SequentialSpeechPlayer

### 8.3 –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ "SWITCHING"** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ Guard –∑–∞—â–∏—Ç–∞ (`_switch_in_progress`) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
   - ‚úÖ –¢–∞–π–º–∞—É—Ç guard (10s) –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∑–∞–ª–∏–ø–∞–Ω–∏—è
   - ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π (`_switch_sequence_counter`) –¥–ª—è –∞—É–¥–∏—Ç–∞

2. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (10s –≤–º–µ—Å—Ç–æ 5s)
   - ‚úÖ –£–º–µ–Ω—å—à–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (5s –≤–º–µ—Å—Ç–æ 15s)
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏

3. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-12-02)
   - ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (`_switch_device_times`)
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ PortAudio —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   - ‚úÖ Decision-–ª–æ–≥–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
   - ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π (`seq=123`) –¥–ª—è –∞—É–¥–∏—Ç–∞

### 8.4 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- **SwitchAudioSource** (subprocess) - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **PortAudio** (sounddevice) - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ device_id –ø–æ –∏–º–µ–Ω–∏
- **Core Audio** (PyObjC) - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **DeviceChangePublisher** - –µ–¥–∏–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä —Å Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ + polling fallback

**–ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–π —É—Ç–∏–ª–∏—Ç—ã SwitchAudioSource (–Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
- ‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (SwitchAudioSource –¥–ª—è –∏–º–µ–Ω–∏, PortAudio –¥–ª—è ID)
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (guard'—ã, –∫—ç—à–∏, fallback'–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, —É–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ fallback'–∏
- **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ Core Audio, –µ—Å–ª–∏ SwitchAudioSource –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:** –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —á–∏—Å—Ç—ã–π Core Audio, —É–±—Ä–∞–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç SwitchAudioSource

---

## 8.5 –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–µ–∂–∏–º Spotify/Zoom)

**‚úÖ –§–ê–ó–ê 6: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**

Nexy —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Spotify, Apple Music –∏–ª–∏ Zoom: **–∂–µ–ª–µ–∑–æ –º–æ–∂–µ—Ç —á—É–¥–∏—Ç—å, –Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å—ë "–ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç"**.

### –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å–∏—Å—Ç–µ–º—ã

**INPUT (–ó–∞—Ö–≤–∞—Ç —Ä–µ—á–∏):**
- ‚úÖ **–í—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π input** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–°–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º default** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PortAudio
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** ‚Äî –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Üí –ø—Ä–æ–±—É—é—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
  1. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (MacBook speakers, internal mic)
  2. USB/–≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  3. Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  4. Remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Continuity)
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏** ‚Äî –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `sd.check_input_settings()`
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –æ—à–∏–±–∫–∏ PortAudio (-9986, -10851) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ –∏ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ

**OUTPUT (–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ):**
- ‚úÖ **–í—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π output** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–°–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º default** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PortAudio
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** ‚Äî –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:
  1. –ü—Ä–æ–±—É—é—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ ‚Üí USB ‚Üí BT ‚Üí Remote)
  2. –ï—Å–ª–∏ –≤—Å–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (`device=None`)
  3. –ï—Å–ª–∏ –¥–∞–∂–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ `OUTPUT_UNAVAILABLE` (–∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
- ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞** ‚Äî —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç concurrent –æ–ø–µ—Ä–∞—Ü–∏–π** ‚Äî guard'—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### –ü–æ–ª–∏—Ç–∏–∫–∞ fallback

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
1. **Built-in —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–∞–º—ã–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)
2. **USB/–≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
3. **Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏)
4. **Remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ç–∏–ø—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ DevicePolicy):**
- **Bluetooth:** timeout=5.0s, retries=5, close_delay=2.5s
- **Normal (USB/–≤–Ω–µ—à–Ω–∏–µ):** timeout=3.0s, retries=3, close_delay=0.3s
- **Built-in:** timeout=2.0s, retries=2, close_delay=0.1s
- **Remote:** timeout=8.0s, retries=7, close_delay=3.0s

### –ß—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- ‚ùå **–¢–æ—á–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
- ‚ùå **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- ‚ùå **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º default, –∞ –Ω–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** Nexy —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ "—Å–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º default":
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–µ–µ default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PortAudio
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- –ù–µ –ø—ã—Ç–∞–µ—Ç—Å—è —É–≥–∞–¥–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ –∏–º–µ–Ω–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PortAudio ID –Ω–∞–ø—Ä—è–º—É—é

**–í –±—É–¥—É—â–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** –ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º "—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –µ–≥–æ.

---

## 9. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É–¥–∏–æ —Å–∏—Å—Ç–µ–º—ã Nexy –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–π–Ω–æ–π –º–æ–¥–µ–ª–∏ (EventBus) –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏.

**üìã –ü–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–æ–∫:** –°–º. `Docs/AUDIO_SYSTEM_ROADMAP.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –∏ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å.

### 9.1 –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (2025-12-03)

**‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç):**

**INPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ `sd.check_input_settings()`
- ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ ‚Üí USB ‚Üí BT ‚Üí Remote)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ PortAudio (-9986, -10851) –¥–ª—è INPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ `_select_default_input_device()`

**OUTPUT –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞:**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è "–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π output" (fallback –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç)
- ‚úÖ Guard –∑–∞—â–∏—Ç–∞ –æ—Ç concurrent –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π (`_switch_in_progress`)
- ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞ (`seq={sequence_id}`)
- ‚úÖ –ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`_last_successful_config`)

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- ‚úÖ AudioStreamManager ‚Äî –µ–¥–∏–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ—Ö PortAudio –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ DevicePolicy ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ CoreAudioDeviceManager ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è Core Audio —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ DeviceChangePublisher ‚Äî —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–±–µ–∑ SwitchAudioSource –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø—É—Ç–∏)
- ‚úÖ –°–æ–±—ã—Ç–∏—è `device.default_*_changed` ‚Äî —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ payload —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- ‚úÖ Feature flag `device_switch_v2` ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã —á–µ—Ä–µ–∑ DevicePolicy (–∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff —á–µ—Ä–µ–∑ DevicePolicy
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π (`_recording_stop_sent`, `_processed_recording_stop_sessions`)

**üîß –ß–¢–û –û–°–¢–ê–õ–û–°–¨ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- ‚úÖ –†–∞–∑–¥–µ–ª "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" –¥–æ–±–∞–≤–ª–µ–Ω (–§–∞–∑–∞ 6.1)
- ‚úÖ –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω (–§–∞–∑–∞ 6.2)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚ö†Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ OUTPUT –ø–æ—Ç–æ–∫–∞ (–¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- ‚ö†Ô∏è –†–µ–∂–∏–º "—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- ‚ö†Ô∏è –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ SwitchAudioSource –∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã (—Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è fallback)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- ‚ö†Ô∏è –û—à–∏–±–∫–∏ -10851 –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (—Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2.5s –ø–æ—Å–ª–µ close) ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è BT

### 9.2 –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–≤—Å–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
1. ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
2. ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã —á–µ—Ä–µ–∑ DevicePolicy (–∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
3. ‚úÖ **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å** - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∏ decision-–ª–æ–≥–∏ –≤ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
4. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫** - guard'—ã, –∫—ç—à–∏, fallback'–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
5. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏** - –≤—Å–µ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ if-—ã" –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ DevicePolicy
6. ‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** - CoreAudioDeviceManager –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
7. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** - DeviceChangePublisher –æ–±–ª–µ–≥—á–µ–Ω, SwitchAudioSource —É–±—Ä–∞–Ω —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—É—Ç–∏

**–ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:**
- ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∑—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã** (–§–∞–∑—ã 1-5)
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ** ‚Äî –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π input/output
- ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ø—Ä–æ—â–µ–Ω–∞** ‚Äî —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞** ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–ø–∏—Å–∞–Ω–æ (–§–∞–∑–∞ 6)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
- –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ -10851 –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç)
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ SwitchAudioSource –∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã (—Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è fallback)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ OUTPUT –ø–æ—Ç–æ–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## 10. –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞—É–¥–∏–æ-—Å–∏—Å—Ç–µ–º—ã

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-02  
**–°—Ç–∞—Ç—É—Å:** –ü–ª–∞–Ω (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

### 10.0 –ê–Ω–∞–ª–∏–∑: —Å—Ç–æ–∏—Ç –ª–∏ –º–µ–Ω—è—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É?

#### 10.0.1 –ö—Ä–∞—Ç–∫–∏–π –≤–µ—Ä–¥–∏–∫—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–¢–û–ò–¢ –º–µ–Ω—è—Ç—å, –Ω–∞—á–∏–Ω–∞—è —Å –§–∞–∑—ã 1 –∏ –§–∞–∑—ã 2 (—Ä–µ—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É).**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. ‚ö†Ô∏è **–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤** (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º):
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ fallback'–∏ –Ω–∞ SwitchAudioSource ("Fallback –Ω–∞ SwitchAudioSource (device_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω)")
   - –ü—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (AirPods) ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ PortAudio –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏
   - –û—à–∏–±–∫–∏ -9986 –∏ -10851 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–æ–≤ –∏–∑-–∑–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∏–º–µ–Ω–µ–º –∏ ID
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource (84 —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ 5 —Ñ–∞–π–ª–∞—Ö)
2. ‚ö†Ô∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
   - –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã (–∏–º—è –∏–∑ SwitchAudioSource, ID –∏–∑ PortAudio)
   - –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ fallback'–∞–º–∏ –∏ guard'–∞–º–∏
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
3. ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–æ–≤)
4. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –§–∞–∑—ã 1-2 —Ä–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

**–ö–æ–≥–¥–∞ –°–¢–û–ò–¢ –º–µ–Ω—è—Ç—å (–¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø):**
- ‚úÖ **–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤** ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (AirPods) ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ PortAudio
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ fallback'–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ö–æ–≥–¥–∞ –ù–ï –°–¢–û–ò–¢ –º–µ–Ω—è—Ç—å:**
- –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–ù–ï –ù–ê–® –°–õ–£–ß–ê–ô)
- –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)

---

#### 10.0.2 –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
- Guard –∑–∞—â–∏—Ç–∞ –æ—Ç concurrent –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- –ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource (—á–∞—Å—Ç–∏—á–Ω–æ)
- Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- Fallback –Ω–∞ polling –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Core Audio

**‚ö†Ô∏è –ß—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–π —É—Ç–∏–ª–∏—Ç—ã SwitchAudioSource (84 —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ 5 —Ñ–∞–π–ª–∞—Ö)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (SwitchAudioSource –¥–ª—è –∏–º–µ–Ω–∏, PortAudio –¥–ª—è ID)
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (guard'—ã, –∫—ç—à–∏, fallback'–∏)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ core_audio_id/uid)

**üìä –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ –ª–æ–≥–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (2025-12-02):**

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ fallback'–∏ –Ω–∞ SwitchAudioSource:**
   ```
   ‚úÖ [OUTPUT] Fallback –Ω–∞ SwitchAudioSource (device_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω)
   ```
   - –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Ç–æ–∫–∞
   - –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ `device_id` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–ü—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (AirPods) ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û:**
   ```
   ‚ö†Ô∏è [OUTPUT] –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "Sergiy's AirPods" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ PortAudio –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
   ‚ùå [OUTPUT] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ –ø–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫: Error opening OutputStream: Internal PortAudio error [PaErrorCode -9986]
   ```
   - **OUTPUT:** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ SwitchAudioSource, –Ω–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ PortAudio
   - **OUTPUT:** –ü—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–∞–º -9986 –∏ -10851 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–æ–≤
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `_device_is_available()` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏)

3. **–û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ç–æ–∫–æ–≤ ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û:**
   ```
   ||PaMacCore (AUHAL)|| Error on line 1332: err='-10851', msg=Audio Unit: Invalid Property Value
   ‚ùå [OUTPUT] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ –ø–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫: Error opening OutputStream: Internal PortAudio error [PaErrorCode -9986]
   ```
   - **OUTPUT:** –ü—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∏–∑-–∑–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∏–º–µ–Ω–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–∑ SwitchAudioSource) –∏ ID (–∏–∑ PortAudio)
   - **OUTPUT:** –û—Å–æ–±–µ–Ω–Ω–æ —á–∞—Å—Ç–æ –Ω–∞ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `sd.check_input_settings()` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–∞
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - **INPUT:** ‚úÖ **–†–ï–®–ï–ù–û** - –û—à–∏–±–∫–∏ -9986/-10851 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ)

4. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã SwitchAudioSource:**
   - –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ `SwitchAudioSource` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
   - –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Ä–µ–º—è (subprocess —Å timeout=5s)
   - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2025-12-03):**
- ‚úÖ **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
  - `CoreAudioDeviceManager` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `sounddevice` (PortAudio) –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  - SwitchAudioSource –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag `device_switch_v2` –≤—ã–∫–ª—é—á–µ–Ω)
  - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `DeviceInfo` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (core_audio_id, uid, —Ñ–ª–∞–≥–∏)
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
  - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ `device_id` –∏–ª–∏ `uid` (–Ω–µ –ø–æ –∏–º–µ–Ω–∏)
  - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –¥–ª—è INPUT –∏ OUTPUT:**
  - INPUT: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
  - OUTPUT: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π output (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
  - –ß–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
  - DeviceChangePublisher –æ–±–ª–µ–≥—á–µ–Ω (–Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ PortAudio, SwitchAudioSource —Ç–æ–ª—å–∫–æ fallback)
  - –í—Å–µ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ if-—ã" –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ DevicePolicy
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å `old_device_name`:**
  - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
  - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç `NameError: cannot access local variable 'old_device_name'`

**‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
- ‚ö†Ô∏è –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ SwitchAudioSource –∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã (—Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è fallback)
- ‚ö†Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ OUTPUT –ø–æ—Ç–æ–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚ö†Ô∏è –†–µ–∂–∏–º "—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)

---

#### 10.0.3 –ê–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç –∏ –≤—ã–≥–æ–¥

**–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥:**

1. **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** 7-11 –¥–Ω–µ–π
   - –§–∞–∑–∞ 1: 2-3 –¥–Ω—è
   - –§–∞–∑–∞ 2: 3-5 –¥–Ω–µ–π
   - –§–∞–∑–∞ 3: 2-3 –¥–Ω—è

2. **–†–∏—Å–∫–∏:**
   - **–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫:** –†–µ–≥—Ä–µ—Å—Å–∏–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É)
   - **–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫:** –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Core Audio API (—Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ macOS)
   - **–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫:** –ü–æ—Ç–µ—Ä—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ SwitchAudioSource (–µ—Å—Ç—å fallback)

3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã:**
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (BT, USB, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ) ‚Äî 2-3 –¥–Ω—è
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî 1 –¥–µ–Ω—å
   - –û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ‚Äî 0.5 –¥–Ω—è
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ rollout ‚Äî 1-2 –Ω–µ–¥–µ–ª–∏

**–ò—Ç–æ–≥–æ:** 10-15 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–í—ã–≥–æ–¥—ã –æ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**

1. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:**
   - ‚úÖ –£–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–π —É—Ç–∏–ª–∏—Ç—ã (–Ω–æ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ)
   - ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (—á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
   - ‚úÖ –£–ª—É—á—à–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å (–ª–µ–≥—á–µ –ø–æ–Ω—è—Ç—å, –∫—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç)
   - ‚úÖ –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å Core Audio –Ω–∞–ø—Ä—è–º—É—é (–Ω–æ —Ç–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∂–µ –Ω–∞–¥–µ–∂–Ω–∞)

2. **–ë–∏–∑–Ω–µ—Å:**
   - ‚ö†Ô∏è –ú–µ–Ω—å—à–µ –ø—Ä–æ–±–ª–µ–º —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º SwitchAudioSource (–Ω–æ —ç—Ç–æ —Ä–µ–¥–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞)
   - ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –º–µ–Ω—å—à–µ –±–∞–≥–æ–≤ –≤ –±—É–¥—É—â–µ–º (–Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ)
   - ‚ö†Ô∏è –õ–µ–≥—á–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ (–Ω–æ —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–æ–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç)

**–û—Ü–µ–Ω–∫–∞ –≤—ã–≥–æ–¥:** –°—Ä–µ–¥–Ω–∏–µ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ, –Ω–æ –ø–æ–ª–µ–∑–Ω—ã–µ)

**ROI (Return on Investment):**
- **–ó–∞—Ç—Ä–∞—Ç—ã:** 5-8 –¥–Ω–µ–π (–§–∞–∑–∞ 1-2, –±–µ–∑ –§–∞–∑—ã 3)
- **–í—ã–≥–æ–¥—ã:** –í—ã—Å–æ–∫–∏–µ (—Ä–µ—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- **–†–∏—Å–∫–∏:** –°—Ä–µ–¥–Ω–∏–µ (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout, feature flags)
- **–í—ã–≤–æ–¥:** ROI –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –¥–ª—è –§–∞–∑—ã 1-2 (—Ä–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É)

---

#### 10.0.4 –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

**–í–∞—Ä–∏–∞–Ω—Ç 1: –§–∞–∑–∞ 1-2 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (5-8 –¥–Ω–µ–π) ‚Äî –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**
- ‚úÖ –§–∞–∑–∞ 1: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2-3 –¥–Ω—è)
  - –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å "—Å–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º"
  - –û—Å–ª–∞–±–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç SwitchAudioSource
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–æ–≤ –∏ UI
- ‚úÖ –§–∞–∑–∞ 2: –í–≤–µ—Å—Ç–∏ CoreAudioDeviceManager (3-5 –¥–Ω–µ–π)
  - –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è Core Audio —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  - –û–±–ª–µ–≥—á–∏—Ç—å DeviceChangePublisher
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å core_audio_id/uid –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–µ—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- –£–ø—Ä–æ—â–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (—á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout —á–µ—Ä–µ–∑ feature flags (–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫)

**–í–∞—Ä–∏–∞–Ω—Ç 1.1: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –¥–Ω—è) ‚Äî –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**
- –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ Core Audio –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ SwitchAudioSource
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–±–ª–µ–º

**–ü–æ—á–µ–º—É –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –ù–µ —Ä–µ—à–∞–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É (–Ω–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã)
- –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥
- –ü—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ‚Äî 2-3 –¥–Ω—è**
- –î–æ–±–∞–≤–∏—Ç—å feature flags –¥–ª—è –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°–æ–∑–¥–∞—Ç—å CoreAudioDeviceManager –∫–∞–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π)
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (–Ω–µ –º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É)
- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—á–≤—É –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (10-15 –¥–Ω–µ–π) ‚Äî –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –°–ï–ô–ß–ê–°**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ç—Ä–∏ —Ñ–∞–∑—ã –ø–ª–∞–Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- –£–±—Ä–∞—Ç—å SwitchAudioSource –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —á–∏—Å—Ç—ã–π Core Audio

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —É—Ç–∏–ª–∏—Ç

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –í—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã–≥–æ–¥—ã

**–í–∞—Ä–∏–∞–Ω—Ç 4: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å ‚Äî –í–û–ó–ú–û–ñ–ù–û**
- –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–±–ª–µ–º
- –ò—Å–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–≥–∏ –ø–æ –º–µ—Ä–µ –ø–æ—è–≤–ª–µ–Ω–∏—è
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–ª–æ–∂–∏—Ç—å –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç —Ä–∏—Å–∫–∞ —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- –§–æ–∫—É—Å –Ω–∞ –Ω–æ–≤—ã—Ö —Ñ–∏—á–∞—Ö

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç SwitchAudioSource –æ—Å—Ç–∞–µ—Ç—Å—è

---

#### 10.0.5 –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞: –í–∞—Ä–∏–∞–Ω—Ç 1 (–§–∞–∑–∞ 1-2 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞) ‚Äî –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å (5-8 –¥–Ω–µ–π):**

**–§–∞–∑–∞ 1: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2-3 –¥–Ω—è)**

1. **–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å "—Å–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º" (1 –¥–µ–Ω—å)**
   - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PortAudio
   - –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `device.default_*_changed` –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –Ω–∞ —Ç–µ–∫—É—â–µ–º default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ PortAudio
   - –ù–µ –ø—ã—Ç–∞—Ç—å—Å—è —É–≥–∞–¥–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ –∏–º–µ–Ω–∏

2. **–û—Å–ª–∞–±–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç SwitchAudioSource (1-2 –¥–Ω—è)**
   - –£–±—Ä–∞—Ç—å SwitchAudioSource –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—É—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Core Audio –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - SwitchAudioSource —Ç–æ–ª—å–∫–æ –¥–ª—è fallback/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–∑–∞ 2: –í–≤–µ—Å—Ç–∏ CoreAudioDeviceManager (3-5 –¥–Ω–µ–π)**

1. **–°–æ–∑–¥–∞—Ç—å CoreAudioDeviceManager (2 –¥–Ω—è)**
   - –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è Core Audio —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `DeviceInfo` —Å `core_audio_id`, `uid`, `name`, —Ñ–ª–∞–≥–∞–º–∏
   - –ù–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ PortAudio, EventBus, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

2. **–û–±–Ω–æ–≤–∏—Ç—å DeviceChangePublisher (1-2 –¥–Ω—è)**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CoreAudioDeviceManager –≤–º–µ—Å—Ç–æ SwitchAudioSource
   - –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ `core_audio_id`/`uid`, –∞ –Ω–µ –ø–æ –∏–º–µ–Ω–∏
   - –£–±—Ä–∞—Ç—å –∫—ç—à –∏–º—ë–Ω –∏ —Å–ª–æ–∂–Ω—ã–µ guard'—ã

3. **–û–±–Ω–æ–≤–∏—Ç—å AudioStreamManager (1 –¥–µ–Ω—å)**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è —Å `core_audio_id`/`uid` –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ü–æ—á–µ–º—É —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç:**
- ‚úÖ –†–µ—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- ‚úÖ –£–ø—Ä–æ—â–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (—á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout —á–µ—Ä–µ–∑ feature flags (–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫)
- ‚úÖ –†–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

**–ü–ª–∞–Ω rollout:**
1. **–ù–µ–¥–µ–ª—è 1:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –§–∞–∑—ã 1 —Å feature flag `NEXY_FEATURE_DEVICE_SWITCH_V2`
2. **–ù–µ–¥–µ–ª—è 2:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 1, –Ω–∞—á–∞–ª–æ –§–∞–∑—ã 2
3. **–ù–µ–¥–µ–ª—è 3:** –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –§–∞–∑—ã 2, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **–ù–µ–¥–µ–ª—è 4:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout (1% ‚Üí 25% ‚Üí 100%)

**–ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ:**
- –ï—Å–ª–∏ –§–∞–∑–∞ 1-2 –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –ï—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
- –ï—Å–ª–∏ –±—É–¥–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –§–∞–∑—É 3 (–ø–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)

**üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** –°–º. `Docs/AUDIO_DEVICE_REFACTORING_PLAN.md`

---

### 10.1 –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã (–±–∞–∑–∞ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–∑)

1. **–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø—Ä–æ "–∫—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π"** ‚Äî macOS (Core Audio), –∞ –Ω–µ SwitchAudioSource
2. **PortAudio** ‚Äî —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: "–æ—Ç–∫—Ä–æ–π –ø–æ—Ç–æ–∫ –Ω–∞ —Ç–∞–∫–æ–º-—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ", –∞ –Ω–µ "—Ä–µ—à–∏, —á—Ç–æ –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
3. **DeviceChangePublisher** ‚Äî –Ω–µ "–º–æ–∑–≥", –∞ **—Ä–æ—É—Ç–µ—Ä/—Ñ–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π**
4. **AudioStreamManager** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ —Ä–µ—à–∞–µ—Ç—Å—è:
   - –∫–∞–∫–æ–π PortAudio-–¥–µ–≤–∞–π—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   - –∫–æ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞—Ç—å/–æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏
   - –∫–∞–∫ —É—á–∏—Ç—ã–≤–∞—Ç—å Bluetooth/—Ç–∞–π–º–∏–Ω–≥–∏

---

### 10.2 –§–∞–∑–∞ 1 ‚Äî –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Å—Ç–µ–º—É (–ø–æ—á–∏—Å—Ç–∏—Ç—å —Ö–∞–æ—Å)

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã **–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã–≥–ª—è–¥–µ–ª–æ —Ç–∞–∫:

> "macOS –≥–æ–≤–æ—Ä–∏—Ç: –¥–µ—Ñ–æ–ª—Ç —Å–º–µ–Ω–∏–ª—Å—è ‚Üí –º—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –ø–æ—Ç–æ–∫ –Ω–∞ —Ç–µ–∫—É—â–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ PortAudio"

#### –®–∞–≥ 1.1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å "—Å–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–º –¥–µ—Ñ–æ–ª—Ç–æ–º"

**–ì–¥–µ –∏–∑–º–µ–Ω–∏—Ç—å:**
- `modules/audio_core/stream_manager.py` ‚Äî `AudioStreamManager`
- `modules/speech_playback/core/player.py` ‚Äî `SequentialSpeechPlayer`
- `modules/voice_recognition/core/speech_recognizer.py` ‚Äî `SpeechRecognizer`

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å:**

1. **–í —Ä–µ–∂–∏–º–µ "–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é":**
   - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ PortAudio (input/output)
   - –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `device.default_*_changed`:
     - –ó–∞–∫—Ä—ã—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç—Ä–∏–º
     - –û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π **–Ω–∞ —Ç–µ–∫—É—â–µ–º default-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ PortAudio**, –Ω–µ –ø—ã—Ç–∞—è—Å—å —É–≥–∞–¥–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏

2. **–ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É:**
   - –õ—é–±–∞—è –ª–æ–≥–∏–∫–∞, –≥–¥–µ:
     - –ë–µ—Ä—ë—Ç—Å—è `device_name` –∏–∑ —Å–æ–±—ã—Ç–∏—è
     - –ü–æ —ç—Ç–æ–º—É –∏–º–µ–Ω–∏ –∏—â–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π PortAudio index
     - –ù–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ —Ä–µ—à–∞–µ—Ç—Å—è BT/–Ω–µ BT
   - **–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏ –≥–æ—Ç–æ–≤—É—é –∫ –≤—ã–ø–∏–ª–∏–≤–∞–Ω–∏—é**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–µ—Ä–µ—Å—Ç–∞—Ç—å –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è AUDIO-—è–¥—Ä–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–æ–≤ –∏ UI

#### –®–∞–≥ 1.2. –û—Å–ª–∞–±–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç SwitchAudioSource

**–ì–¥–µ –∏–∑–º–µ–Ω–∏—Ç—å:**
- `modules/audio_core/device_change_publisher.py` ‚Äî `DeviceChangePublisher`

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å:**

1. **–£–±—Ä–∞—Ç—å SwitchAudioSource –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—É—Ç–∏:**
   - –û–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ä–µ—à–∏—Ç—å: "–¥–µ—Ñ–æ–ª—Ç —Å–º–µ–Ω–∏–ª—Å—è" –∏–ª–∏ –Ω–µ—Ç

2. **–ê–ª–≥–æ—Ä–∏—Ç–º:**
   - –ï—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç CoreAudio ‚Üí **–≤–µ—Ä–∏–º –∏–º** –∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–µ—Ñ–æ–ª—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
   - SwitchAudioSource:
     - –õ–∏–±–æ –≤–æ–æ–±—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
     - –õ–∏–±–æ —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–∏ —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ "optional")

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 1:**
üëâ –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤—ã–∫–ª—é—á–∏—Ç—å SwitchAudioSource, **–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**, –ø—Ä–æ—Å—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –º–µ–Ω–µ–µ –∫—Ä–∞—Å–∏–≤–æ–π –≤ –ª–æ–≥–∞—Ö/–∏–º–µ–Ω–∞—Ö.

---

### 10.3 –§–∞–∑–∞ 2 ‚Äî –í–≤–µ—Å—Ç–∏ CoreAudioDeviceManager –∏ "–æ–±–ª–µ–≥—á–∏—Ç—å" DeviceChangePublisher

**–¶–µ–ª—å:** –í—ã—Ç–∞—â–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å Core Audio –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∏ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ç–∞—â–∏—Ç—å —á–µ—Ä–µ–∑ Publisher –ª–∏—à–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.

#### –®–∞–≥ 2.1. –í–≤–µ—Å—Ç–∏ CoreAudioDeviceManager ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–ì–¥–µ —Å–æ–∑–¥–∞–Ω:**
- `modules/audio_core/core_audio_device_manager.py` ‚úÖ

**–†–æ–ª—å:**
–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sounddevice` (PortAudio) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ input/output:**
   - ‚úÖ `get_current_default_input() -> Optional[DeviceInfo]`
   - ‚úÖ `get_current_default_output() -> Optional[DeviceInfo]`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç `DeviceInfo` —Å –ø–æ–ª—è–º–∏:
     - `name`, `device_id` (PortAudio), `is_bluetooth`, `is_builtin`, `is_external`
     - `core_audio_id`, `uid` (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Core Audio API)
     - `portaudio_index`, `max_input_channels`, `max_output_channels`, `default_samplerate`

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
   - ‚úÖ `get_available_devices(device_type: Literal["input", "output"]) -> List[DeviceInfo]`

3. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
   - ‚úÖ `_is_bluetooth_device(name: str) -> bool`
   - ‚úÖ `_is_builtin_device(name: str) -> bool`
   - ‚úÖ `_is_external_device(name: str) -> bool`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sounddevice` (PortAudio) –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç PyObjC / Core Audio API (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- ‚úÖ –ù–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ EventBus –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω)
- ‚úÖ –ü–æ–ª—è `core_audio_id` –∏ `uid` –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Core Audio API

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω):**
```python
class CoreAudioDeviceManager:
    def get_current_default_input() -> Optional[DeviceInfo]
    def get_current_default_output() -> Optional[DeviceInfo]
    def get_available_devices(device_type: Literal["input", "output"]) -> List[DeviceInfo]
    def _is_bluetooth_device(name: str) -> bool
    def _is_builtin_device(name: str) -> bool
    def _is_external_device(name: str) -> bool
```

#### –®–∞–≥ 2.2. –û–±–Ω–æ–≤–∏—Ç—å DeviceChangePublisher ‚Äî —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ "—Ç–æ–Ω–∫–∏–º" ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–ì–¥–µ –∏–∑–º–µ–Ω–µ–Ω–æ:**
- `modules/audio_core/device_change_publisher.py` ‚Äî `DeviceChangePublisher` ‚úÖ

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

1. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –Ω–∞ `CoreAudioDeviceManager`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CoreAudioDeviceManager` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
   - ‚úÖ SwitchAudioSource –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag –≤—ã–∫–ª—é—á–µ–Ω)

2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
   - ‚úÖ –•—Ä–∞–Ω–∏—Ç `DeviceInfo` –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫ (`_current_input_device`, `_current_output_device`)
   - ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `DeviceInfo` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

3. **–ê–ª–≥–æ—Ä–∏—Ç–º "–¥–µ—Ñ–æ–ª—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è":**
   - ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `DeviceInfo` –¥–ª—è input/output —á–µ—Ä–µ–∑ `CoreAudioDeviceManager`
   - ‚úÖ –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç **–ø–æ `device_id` –∏–ª–∏ `uid`**, –∞ –Ω–µ –ø–æ –∏–º–µ–Ω–∏ (–Ω–∞–¥–µ–∂–Ω–µ–µ)
   - ‚úÖ –ü—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏:
     - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ—ë `_current_*_device`
     - –ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ EventBus —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

4. **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:**
   - ‚úÖ –í —Å–æ–±—ã—Ç–∏–∏ `device.default_output_changed` / `device.default_input_changed`:
     - –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `core_audio_id`, `uid`, `name`, —Ñ–ª–∞–≥–∏ (BT, builtin, external)
     - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è `portaudio_index`, `max_input_channels`, `max_output_channels`, `default_samplerate`
     - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (`old_device_name`, `old_device_id`, –∏ —Ç.–¥.)

5. **–ß—Ç–æ —É–±—Ä–∞–Ω–æ:**
   - ‚úÖ –ö—ç—à –∏–º—ë–Ω (`_device_name_cache`) ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
   - ‚úÖ –°–ª–æ–∂–Ω—ã–µ guard'—ã –≤–æ–∫—Ä—É–≥ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ subprocess'–∞ ‚Äî —É–ø—Ä–æ—â–µ–Ω—ã
   - ‚úÖ –í—ã–∑–æ–≤—ã SwitchAudioSource –∏–∑ Publisher ‚Äî —Ç–æ–ª—å–∫–æ fallback

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
üëâ DeviceChangePublisher:
- –ù–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ PortAudio
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö CLI
- –ü—Ä–æ—Å—Ç–æ:
  - –î–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ CoreAudio
  - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏—Ö
  - –ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è

---

### 10.4 –§–∞–∑–∞ 3 ‚Äî –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—á—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∏)

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É "—á–∏—Ç–∞–±–µ–ª—å–Ω–æ–π —Å –ª–∏—Å—Ç–∞": –∫—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç, –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö —Å–≤—è–∑–µ–π.

#### –®–∞–≥ 3.1. AudioStreamManager –∫–∞–∫ –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤

**–ì–¥–µ –∏–∑–º–µ–Ω–∏—Ç—å:**
- `modules/audio_core/stream_manager.py` ‚Äî `AudioStreamManager`

**–õ–æ–≥–∏–∫–∞:**

1. **–ü–æ–¥–ø–∏—Å–∫–∏:**
   - –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å–∏–≥–Ω–∞–ª, —á—Ç–æ:
     - –ù–∞—á–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ / –∑–∞–ø–∏—Å—å
     - –ü—Ä–∏—à–ª–æ —Å–æ–±—ã—Ç–∏–µ `device.default_*_changed`

2. **–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
   - –ï—Å–ª–∏ —Ä–µ–∂–∏–º "—Å–ª–µ–¥—É–µ–º –∑–∞ —Å–∏—Å—Ç–µ–º–æ–π":
     - –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `device.default_*_changed`:
       - –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–π —Å—Ç—Ä–∏–º
       - –û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π, –∏—Å–ø–æ–ª—å–∑—É—è **—Ç–µ–∫—É—â–∏–π default device PortAudio** (–Ω–µ –∏–º—è –∏ –Ω–µ –ø—Ä—è–º–æ–π `portaudio_index` –∏–∑ —Å–æ–±—ã—Ç–∏–π)
   - –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç —Ä–µ–∂–∏–º "—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ":
     - –•—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π `DeviceInfo`/ID
     - –ü—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö default'–æ–≤ ‚Äî –ª–∏–±–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, –ª–∏–±–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–æ–ø–∞–ª–æ

**–í–∞–∂–Ω–æ:**
AudioStreamManager ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ:
- –†–µ—à–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç–æ–∫
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–∞–π–º–∏–Ω–≥–∏/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ BT (—á–µ—Ä–µ–∑ –ø–æ–ª–∏—Ç–∏–∫—É, —Å–º. –Ω–∏–∂–µ)
- –ö–∞–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PortAudio –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

#### –®–∞–≥ 3.2. –í—ã–Ω–µ—Å—Ç–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ (Bluetooth, —Ç–∞–π–º–∏–Ω–≥–∏, —Ä–µ—Ç—Ä–∞–∏)

**–ì–¥–µ —Å–æ–∑–¥–∞—Ç—å:**
- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: `modules/audio_core/device_policy.py` –∏–ª–∏ `modules/audio_core/audio_environment_policy.py`

**–†–æ–ª—å:**

1. **–ù–∞ –≤—Ö–æ–¥:**
   - `DeviceInfo` (–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç (input/output, —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –∑–∞–ø–∏—Å—å –∏–ª–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ)

2. **–ù–∞ –≤—ã—Ö–æ–¥:**
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è:
     - –ù—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (BT?)
     - –°–∫–æ–ª—å–∫–æ —Ä–µ—Ç—Ä–∞–µ–≤
     - –ö–∞–∫–æ–π —Ç–∞–π–º–∞—É—Ç –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
     - –ù—É–∂–Ω–æ –ª–∏ –¥–µ-–±–æ—É–Ω—Å–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

**–í–∞–∂–Ω–æ:**
- DeviceChangePublisher, AudioStreamManager –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ **–Ω–µ –∑–Ω–∞—é—Ç, –ø–æ—á–µ–º—É** –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–µ —Ç–∞–π–º–∏–Ω–≥–∏ ‚Äî –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∏
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è BT/USB/–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ):**
```python
class DevicePolicy:
    def get_close_delay(device_info: DeviceInfo) -> float
    def get_max_retries(device_info: DeviceInfo) -> int
    def get_timeout(device_info: DeviceInfo) -> float
    def should_debounce(device_info: DeviceInfo) -> bool
```

#### –®–∞–≥ 3.3. SwitchAudioSource —É–±—Ä–∞—Ç—å –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è dev-tools)

**–ö–æ–≥–¥–∞:**
- CoreAudioDeviceManager —Å—Ç–∞–±–∏–ª–µ–Ω
- DeviceChangePublisher –∏ AudioStreamManager —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –∏ CLI

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
- –í—ã–ø–∏–ª–∏—Ç—å SwitchAudioSource –∏–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–∫–æ–¥–∞
- –ï—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º:
  - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ/CLI –¥–ª—è —Ä—É—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

### 10.5 –ò—Ç–æ–≥ ‚Äî "—á—ë—Ç–∫–æ, –∫—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç" ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (2025-12-03):**

1. **CoreAudioDeviceManager** ‚úÖ
   - –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sounddevice` (PortAudio) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –ù–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ EventBus, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `DeviceInfo` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

2. **DeviceChangePublisher (v2)** ‚úÖ
   - –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤:
     - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å —Ç–µ–∫—É—â–∏–º –ø–æ `device_id` –∏–ª–∏ `uid`
     - –ü—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ EventBus
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CoreAudioDeviceManager` –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
   - SwitchAudioSource —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag –≤—ã–∫–ª—é—á–µ–Ω)

3. **DevicePolicy** ‚úÖ
   - –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ç–æ, *–∫–∞–∫* —Å–µ–±—è –≤–µ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (BT, –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ, –∏ —Ç.–ø.)
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç–∞–π–º–∏–Ω–≥–æ–≤ –∏ —Ä–µ—Ç—Ä–∞–µ–≤
   - –í—Å–µ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ if-—ã" –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

4. **AudioStreamManager** ‚úÖ
   - –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π "–≤–ª–∞–¥–µ–ª–µ—Ü" –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫–æ–≤:
     - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç/–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç
     - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç PortAudio
     - –û–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç Publisher –∏ –ø–æ–ª–∏—Ç–∏–∫—É
   - –í—Å–µ PortAudio –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ AudioStreamManager

5. **SwitchAudioSource**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–∫–æ–≥–¥–∞ feature flag `device_switch_v2` –≤—ã–∫–ª—é—á–µ–Ω)
   - –í –±—É–¥—É—â–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–∫–æ–¥–∞

---

### 10.6 –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ ‚úÖ –í–°–ï –í–´–ü–û–õ–ù–ï–ù–û

**–§–∞–∑–∞ 1: OUTPUT fallback (–¥–æ–≤–µ—Å—Ç–∏ –¥–æ —É—Ä–æ–≤–Ω—è INPUT)** ‚úÖ
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ SwitchAudioSource (—á–µ—Ä–µ–∑ feature flag)
- ‚úÖ –õ–æ–≥–∏–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
- ‚úÖ –ò–º—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–æ–≤ –∏ UI
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π output (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–§–∞–∑–∞ 2: –°–ª–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (CoreAudio –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)** ‚úÖ
- ‚úÖ CoreAudioDeviceManager –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º
- ‚úÖ DeviceChangePublisher –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CoreAudioDeviceManager (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
- ‚úÖ DeviceChangePublisher –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç SwitchAudioSource (—Ç–æ–ª—å–∫–æ fallback)
- ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (core_audio_id, uid, —Ñ–ª–∞–≥–∏)

**–§–∞–∑–∞ 3: –°–æ–±—ã—Ç–∏—è (—Å–¥–µ–ª–∞—Ç—å payload "—Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º")** ‚úÖ
- ‚úÖ –°–æ–±—ã—Ç–∏—è `device.default_*_changed` —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã (–ø–æ–ª–Ω—ã–π payload)
- ‚úÖ –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π —É–ø—Ä–æ—â–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ payload –Ω–∞–ø—Ä—è–º—É—é)

**–§–∞–∑–∞ 4: AudioStreamManager (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –ø–æ—Ç–æ–∫–æ–≤)** ‚úÖ
- ‚úÖ –í—Å–µ PortAudio –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ AudioStreamManager
- ‚úÖ INPUT –∏ OUTPUT –∂–∏–≤—É—Ç –ø–æ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏

**–§–∞–∑–∞ 5: –ü–æ–ª–∏—Ç–∏–∫–∏ (–≤—ã–Ω–µ—Å—Ç–∏ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ if-—ã")** ‚úÖ
- ‚úÖ DevicePolicy —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ if-—ã"
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω—è–µ–º—ã

**–§–∞–∑–∞ 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)** ‚úÖ
- ‚úÖ –†–∞–∑–¥–µ–ª "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ä–µ–∂–∏–º Spotify/Zoom)" –¥–æ–±–∞–≤–ª–µ–Ω
- ‚úÖ –í —Å—Ç–∞—Ç—É—Å–µ/–ø–ª–∞–Ω–µ —á—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–æ "—á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ" / "—á—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è"

---

### 10.7 –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

**–†–∏—Å–∫ 1: –†–µ–≥—Ä–µ—Å—Å–∏–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏**
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout —á–µ—Ä–µ–∑ feature flags, —Ç—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

**–†–∏—Å–∫ 2: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Core Audio API**
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å fallback –Ω–∞ —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Core Audio

**–†–∏—Å–∫ 3: –ü–æ—Ç–µ—Ä—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ SwitchAudioSource**
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ CoreAudioDeviceManager –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–ª—É—á–∞–∏ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º

---

### 10.8 –û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π

**–§–∞–∑–∞ 1:** 2-3 –¥–Ω—è
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –û—Å–ª–∞–±–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç SwitchAudioSource

**–§–∞–∑–∞ 2:** 3-5 –¥–Ω–µ–π
- –°–æ–∑–¥–∞–Ω–∏–µ CoreAudioDeviceManager
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ DeviceChangePublisher
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–§–∞–∑–∞ 3:** 2-3 –¥–Ω—è
- –í—ã–Ω–æ—Å –ø–æ–ª–∏—Ç–∏–∫
- –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç SwitchAudioSource
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã

**–ò—Ç–æ–≥–æ:** 7-11 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
