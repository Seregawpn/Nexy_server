# –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ—à–µ–Ω–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
2025-01-XX

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞, –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ 1: –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ playback.completed

### –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã

**–ö–æ–¥:**
```python
mic_active = self.state_manager.is_microphone_active()  # ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
if mic_active:
    self.state_manager.force_close_microphone(reason="playback_completed")  # ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `state_manager.is_microphone_active()` –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `state_manager.force_close_microphone()` –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 21.3 –ø—Ä–∞–≤–∏–ª: "–ó–∞–ø—Ä–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é"

#### ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ EventBus

**–ö–æ–¥:**
```python
await self._publish_recording_stop_with_debounce({...})  # ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ EventBus
await self._wait_for_mic_closed_with_timeout(...)  # ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `_publish_recording_stop_with_debounce()` (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `_wait_for_mic_closed_with_timeout()` (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 5 –ø—Ä–∞–≤–∏–ª: "–ü–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ event_bus"

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –ú–µ—Ç–æ–¥ `_on_playback_finished()` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π)
- ‚úÖ –ú–µ—Ç–æ–¥—ã `force_close_microphone()`, `_publish_recording_stop_with_debounce()`, `_wait_for_mic_closed_with_timeout()` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º)
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `state_manager.force_close_microphone()`
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `_publish_recording_stop_with_debounce()`

**–ò—Ç–æ–≥:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ**

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ 2: AVF –Ω–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω—ã

### –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏

**–ö–æ–¥ 2.1 (AVF –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è):**
```python
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è AVF (5 –ø–æ–ø—ã—Ç–æ–∫)
max_avf_check_attempts = 5
for attempt in range(max_avf_check_attempts):
    if hasattr(self._avf_engine, 'is_input_active') and self._avf_engine.is_input_active:
        await asyncio.sleep(0.2)
    else:
        break
else:
    raise RuntimeError("AVF not deactivated after all attempts")
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `self._avf_engine.is_input_active` (–Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π)
- ‚úÖ –†–∞—Å—à–∏—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É (–¥–æ–±–∞–≤–ª—è–µ–º —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 10.2 –ø—Ä–∞–≤–∏–ª: "–ò–∑–æ–ª—è—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"

**–ö–æ–¥ 2.2 (–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π):**
```python
from modules.permissions.core.permission_checker import PermissionChecker
permission_checker = PermissionChecker()
mic_permission = permission_checker.check_microphone_permission()
if mic_permission != "granted":
    raise RuntimeError(f"Microphone permission not granted: {mic_permission}")
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `modules.permissions.core.permission_checker` (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `check_microphone_permission()` (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 9 –ø—Ä–∞–≤–∏–ª: "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `max_avf_check_attempts` –ª–æ–∫–∞–ª—å–Ω–∞—è (–Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –∏ –º–æ–¥—É–ª–∏ (–Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ)
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –õ–æ–≥–∏–∫–∞ AVF –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç)
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç)

**–ò—Ç–æ–≥:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ**

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ 3: LONG_PRESS –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è PROCESSING

### –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã gateways

**–ö–æ–¥:**
```python
# integration/core/gateways/audio_gateways.py (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
def decide_allow_shortcut_during_processing(snapshot: Snapshot, source: str) -> Decision:
    if snapshot.app_mode == AppMode.PROCESSING:
        if source == "keyboard":
            return Decision.START
        else:
            return Decision.ABORT
    return Decision.START
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Snapshot` (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Decision` (—Ç–∏–ø –∏–∑ `integration/core/gateways/types.py`)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 21 –ø—Ä–∞–≤–∏–ª: "Selectors –∏ Gateways (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π)"
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª—É 14.2 –ø—Ä–∞–≤–∏–ª: "FSM-–¥–æ–º–µ–Ω—ã —Å guard-—É—Å–ª–æ–≤–∏—è–º–∏ (–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ)"

#### ‚ö†Ô∏è –í–æ–ø—Ä–æ—Å: DecisionEngine vs –ø—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö gateways:**

–í `integration/core/gateways/common.py`:
- `decide_start_listening()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DecisionEngine —Å fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É
- `decide_process_audio()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DecisionEngine —Å fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É

**–ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é (–±–µ–∑ DecisionEngine)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é** –¥–ª—è –Ω–∞—á–∞–ª–∞ (–∫–∞–∫ fallback –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö gateways)
- ‚ö†Ô∏è **–í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ DecisionEngine** —á–µ—Ä–µ–∑ `interaction_matrix.yaml`

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–æ—â–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É fallback –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö gateways
- –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ DecisionEngine –ø–æ–∑–∂–µ –±–µ–∑ breaking changes

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –§–∞–π–ª `audio_gateways.py` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–æ–≤—ã–π —Ñ–∞–π–ª, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç)
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `decide_allow_shortcut_during_processing` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç)
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ gateways

#### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –õ–æ–≥–∏–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ source + app_mode)
- ‚úÖ –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ gateways (`decide_start_listening`, `decide_process_audio`)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã (`Snapshot`, `Decision`, `AppMode`)

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ selectors

**–ö–æ–¥:**
```python
from integration.core.selectors import create_snapshot_from_state_manager
snapshot = create_snapshot_from_state_manager(self.state_manager)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ `create_snapshot_from_state_manager()`

**–ï—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–¥–∏–º —Ñ—É–Ω–∫—Ü–∏—é –≤ `integration/core/selectors.py` (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ selectors –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Snapshot

**–ò—Ç–æ–≥:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ** (—Å –Ω–µ–±–æ–ª—å—à–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–æ–π)

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

| –†–µ—à–µ–Ω–∏–µ | –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã | EventBus | Gateways | –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | –ò—Ç–æ–≥ |
|---------|------------------------|----------|----------|-----------|--------------|------|
| **1: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥** | ‚úÖ | ‚úÖ | - | ‚úÖ –ù–µ—Ç | ‚úÖ –ù–µ—Ç | ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** |
| **2.1: AVF –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è** | ‚úÖ | - | - | ‚úÖ –ù–µ—Ç | ‚úÖ –ù–µ—Ç | ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** |
| **2.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π** | ‚úÖ | - | - | ‚úÖ –ù–µ—Ç | ‚úÖ –ù–µ—Ç | ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** |
| **3: Gateway –¥–ª—è shortcut** | ‚úÖ | - | ‚úÖ | ‚úÖ –ù–µ—Ç | ‚úÖ –ù–µ—Ç | ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** |

---

## üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω —Ñ—É–Ω–∫—Ü–∏–π:

| –§—É–Ω–∫—Ü–∏—è | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---------|------|--------|
| `decide_allow_shortcut_during_processing` | `integration/core/gateways/audio_gateways.py` | ‚úÖ –ù–æ–≤—ã–π —Ñ–∞–π–ª, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç |
| `_on_playback_finished` | `integration/integrations/input_processing_integration.py` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–∑–º–µ–Ω—è–µ–º |
| `_handle_long_press` | `integration/integrations/input_processing_integration.py` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–∑–º–µ–Ω—è–µ–º |

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ | –°—Ç–∞—Ç—É—Å |
|-----------|-------------------|--------|
| `max_avf_check_attempts` | –õ–æ–∫–∞–ª—å–Ω–∞—è (–≤ –º–µ—Ç–æ–¥–µ) | ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç |
| `avf_deactivated` | –õ–æ–∫–∞–ª—å–Ω–∞—è (–≤ –º–µ—Ç–æ–¥–µ) | ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç |
| `mic_permission` | –õ–æ–∫–∞–ª—å–Ω–∞—è (–≤ –º–µ—Ç–æ–¥–µ) | ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç |

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:

| –ò–º–ø–æ—Ä—Ç | –ú–æ–¥—É–ª—å | –°—Ç–∞—Ç—É—Å |
|--------|--------|--------|
| `Snapshot` | `integration.core.selectors` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç |
| `Decision` | `integration.core.gateways.types` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç |
| `AppMode` | `integration.core.state_manager` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç |
| `PermissionChecker` | `modules.permissions.core.permission_checker` | ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç |

---

## üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ—à–µ–Ω–∏–µ 1: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏:**

| –õ–æ–≥–∏–∫–∞ | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ? |
|--------|------------------|--------------|
| `force_close_microphone()` | `state_manager` | ‚úÖ –ù–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) |
| `_publish_recording_stop_with_debounce()` | `input_processing_integration` | ‚úÖ –ù–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) |
| `_wait_for_mic_closed_with_timeout()` | `input_processing_integration` | ‚úÖ –ù–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) |

**–ò—Ç–æ–≥:** ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 2: AVF –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏:**

| –õ–æ–≥–∏–∫–∞ | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ? |
|--------|------------------|--------------|
| AVF –ø—Ä–æ–≤–µ—Ä–∫–∞ | `voice_recognition_integration` | ‚úÖ –ù–µ—Ç (—Ä–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é) |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π | `modules.permissions` | ‚úÖ –ù–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å) |

**–ò—Ç–æ–≥:** ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 3: Gateway –¥–ª—è shortcut

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏:**

| –õ–æ–≥–∏–∫–∞ | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ? |
|--------|------------------|--------------|
| –ü—Ä–æ–≤–µ—Ä–∫–∞ `app_mode == PROCESSING` | `decide_process_audio()` | ‚ö†Ô∏è –ü–æ—Ö–æ–∂–∞—è, –Ω–æ —Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ `source == "keyboard"` | - | ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ |

**–ê–Ω–∞–ª–∏–∑:**
- `decide_process_audio()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞—É–¥–∏–æ (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, —Å–µ—Ç—å, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- `decide_allow_shortcut_during_processing()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ shortcut –≤–æ –≤—Ä–µ–º—è processing
- **–†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞, –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–ò—Ç–æ–≥:** ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---

## ‚ö†Ô∏è –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

### 1. –§—É–Ω–∫—Ü–∏—è `create_snapshot_from_state_manager()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ `selectors.py`

**–†–µ—à–µ–Ω–∏–µ:**
```python
# integration/core/selectors.py
def create_snapshot_from_state_manager(state_manager: ApplicationStateManager) -> Snapshot:
    """–°–æ–∑–¥–∞–µ—Ç Snapshot –∏–∑ ApplicationStateManager."""
    return Snapshot(
        perm_mic=PermissionStatus.GRANTED if state_manager.get_mic_permission() == "granted" else PermissionStatus.DENIED,
        perm_screen=PermissionStatus.GRANTED if state_manager.get_screen_permission() == "granted" else PermissionStatus.DENIED,
        perm_accessibility=PermissionStatus.GRANTED if state_manager.get_accessibility_permission() == "granted" else PermissionStatus.DENIED,
        device_input=DeviceStatus.DEFAULT_OK,  # TODO: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ state_manager
        network=NetworkStatus.ONLINE if state_manager.is_network_online() else NetworkStatus.OFFLINE,
        first_run=state_manager.is_first_run(),
        app_mode=state_manager.get_mode(),
    )
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

1. ‚úÖ **–†–µ—à–µ–Ω–∏–µ 1:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã, EventBus, –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤/–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
2. ‚úÖ **–†–µ—à–µ–Ω–∏–µ 2:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏, –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤/–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
3. ‚úÖ **–†–µ—à–µ–Ω–∏–µ 3:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (gateways, selectors, –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤/–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

1. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å `create_snapshot_from_state_manager()` –≤ `selectors.py`

### –†–∏—Å–∫–∏:

- **–ù–∏–∑–∫–∏–π:** –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –º–æ–¥—É–ª–∏
- **–ù–µ—Ç breaking changes:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `Docs/FINAL_SOLUTIONS_GUIDE.md` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Å –∫–æ–¥–æ–º
- `Docs/BEST_SOLUTIONS_RECOMMENDATION.md` ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª—É—á—à–∏–º —Ä–µ—à–µ–Ω–∏—è–º
- `integration/core/gateways/common.py` ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ gateways
- `integration/core/selectors.py` ‚Äî selectors –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π

