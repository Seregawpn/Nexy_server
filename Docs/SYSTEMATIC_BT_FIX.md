# –°–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (-9986, -10851)

## –î–∞—Ç–∞
2025-11-30

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ AirPods –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏:
- `PaErrorCode -9986` (Internal PortAudio error)
- `Audio Unit: Invalid Property Value (-10851)`

–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –Ω–µ —É–¥–∞—é—Ç—Å—è.

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–û—à–∏–±–∫–∞ -10851 (Invalid Property Value)** —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤:
- `blocksize=512` –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ macOS
- –î–∞–∂–µ `latency` –∏–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É `sd.default.device` (PortAudio) –∏ `SwitchAudioSource` (macOS)
- PortAudio –≤–∏–¥–∏—Ç AirPods –∫–∞–∫ default, –Ω–æ macOS —Å—á–∏—Ç–∞–µ—Ç default –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é CoreAudio pipeline (2-3 —Å–µ–∫—É–Ω–¥—ã)

## –°–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –ü—Ä–∏–Ω—Ü–∏–ø: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–í–º–µ—Å—Ç–æ "–∑–∞–ª–∞—Ç—ã–≤–∞–Ω–∏—è" –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:

1. **–ò—Å–ø–æ–ª—å–∑—É–µ–º SwitchAudioSource –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. **–î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º `device=None`** (—Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç) - –ø—É—Å—Ç—å macOS —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
3. **–î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ù–ï –∑–∞–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏** (`blocksize` –∏–ª–∏ `latency`) - –ø—É—Å—Ç—å PortAudio/macOS —Å–∞–º–∏ –≤—ã–±–µ—Ä—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
4. **–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (2 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ 0.5)
5. **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è** –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–î–û:**
```python
stream_config = {
    'device': device_id,
    'channels': self.config.channels,
    'dtype': self.config.dtype,
    'samplerate': self.config.sample_rate,
    'blocksize': self.config.buffer_size,  # ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è BT
    'callback': self._audio_callback
}
```

**–ü–û–°–õ–ï:**
```python
# ‚úÖ –°–ò–°–¢–ï–ú–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º SwitchAudioSource –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
current_device = self._query_default_output_device()  # macOS API
device_name = current_device.get('name', 'Unknown')
is_bluetooth = self._params_normalizer.is_bluetooth_device(device_name)

stream_config = {
    'device': None if is_bluetooth else device_id,  # ‚úÖ –î–ª—è BT –≤—Å–µ–≥–¥–∞ None
    'channels': self.config.channels,
    'dtype': self.config.dtype,
    'samplerate': self.config.sample_rate,
    'callback': self._audio_callback
    # ‚úÖ –î–ª—è BT –ù–ï –∑–∞–¥–∞–µ–º –Ω–∏ blocksize, –Ω–∏ latency - –ø—É—Å—Ç—å PortAudio –≤—ã–±–µ—Ä–µ—Ç —Å–∞–º
}

if not is_bluetooth:
    # –î–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º blocksize
    stream_config['blocksize'] = self.config.buffer_size
```

#### 2. –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è BT

**–î–û:**
```python
if is_bluetooth:
    bt_prestart_delay = 0.5  # ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    time.sleep(bt_prestart_delay)
```

**–ü–û–°–õ–ï:**
```python
if is_bluetooth:
    bt_prestart_delay = 2.0  # ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ CoreAudio pipeline
    logger.info(f"‚è≥ [OUTPUT] Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ CoreAudio pipeline ({bt_prestart_delay}—Å)...")
    time.sleep(bt_prestart_delay)
```

#### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–î–û:**
```python
# –ü—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –∏ –ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–Ω–æ–≤–∞
if is_error_9986:
    delay = base_delay * (2 ** attempt) * 1.5
    time.sleep(delay)
```

**–ü–û–°–õ–ï:**
```python
# ‚úÖ –°–ò–°–¢–ï–ú–ù–û–ï –†–ï–®–ï–ù–ò–ï: –û—à–∏–±–∫–∞ -10851 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è BT
if is_error_10851 and is_bluetooth:
    logger.warning("‚ö†Ô∏è [OUTPUT] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ -10851 (Invalid Property Value) –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞")
    logger.info("üí° [OUTPUT] –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (device=None) –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏")
    # –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
    stream_config['device'] = None
    device_id_actual = 'System Default'
    # ‚úÖ –°–ò–°–¢–ï–ú–ù–û–ï –†–ï–®–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è BT
    if 'blocksize' in stream_config:
        del stream_config['blocksize']
    if 'latency' in stream_config:
        del stream_config['latency']
    # –ü—É—Å—Ç—å PortAudio/macOS —Å–∞–º–∏ –≤—ã–±–µ—Ä—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```

#### 4. –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–î–û:**
```python
if is_error_9986:
    delay = base_delay * (2 ** attempt) * 1.5
```

**–ü–û–°–õ–ï:**
```python
# ‚úÖ –°–ò–°–¢–ï–ú–ù–û–ï –†–ï–®–ï–ù–ò–ï: –î–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –æ—à–∏–±–æ–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –≤ 2 —Ä–∞–∑–∞
if is_bluetooth or is_error_9986 or is_error_10851:
    delay = base_delay * (2 ** attempt) * 2.0  # –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è BT/–æ—à–∏–±–æ–∫
else:
    delay = base_delay * (2 ** attempt)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É**, –∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –µ—ë –ø–æ—Å–ª–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è
2. **–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤**, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è AirPods
3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å MacBook –Ω–∞ AirPods - –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
2. ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å AirPods –Ω–∞ MacBook - –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
3. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AirPods - –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
4. ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `latency` –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
5. ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É–≤–µ–ª–∏—á–µ–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É (2 —Å–µ–∫—É–Ω–¥—ã) –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–π –∏–ª–∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ -9986 –∏ -10851 –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –°—Ç–∞—Ç—É—Å: –°–ò–°–¢–ï–ú–ù–û–ï –†–ï–®–ï–ù–ò–ï

–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞, –∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –µ—ë –ø–æ—Å–ª–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è. –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö BT —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

