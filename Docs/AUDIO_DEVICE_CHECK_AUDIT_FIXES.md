# –ê—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π

**–î–∞—Ç–∞:** 2025-12-02  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ callback –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** `SwitchAudioSource` –≤—ã–∑—ã–≤–∞–ª—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ `subprocess.run(timeout=5)` –≤–Ω—É—Ç—Ä–∏ `_check_and_update_output_device`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `add_audio_data` (–º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ callback)
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ callback –Ω–∞ –¥–æ 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
- **–õ–æ–≥–∏:** –°—Ç—Ä–æ–∫–∏ 453-480 –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ voice.recording_stop
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–±—ã—Ç–∏–µ `voice.recording_stop` –ø—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å –¥–≤–∞–∂–¥—ã: –≤ `_handle_short_press` –∏ `_handle_release`
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã `stop_listening`, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "audio stream is idle"
- **–õ–æ–≥–∏:** –°—Ç—Ä–æ–∫–∞ 327 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle"

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—è
- **–ü—Ä–æ–±–ª–µ–º–∞:** `stop_listening` –≤—ã–∑—ã–≤–∞–ª—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "audio stream is idle" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–Ω–æ—Å SwitchAudioSource –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É

**–§–∞–π–ª:** `modules/speech_playback/core/player.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è:**
   - `_device_check_in_progress: bool` - —Ñ–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - `_device_check_task: Optional[asyncio.Task]` - –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - `_device_check_result: Optional[tuple[Optional[str], bool]]` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (device_name, is_bluetooth)

2. **–°–æ–∑–¥–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–ø—Ä–æ—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   - `_get_output_device_name_via_macos_api_sync()` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ `asyncio.to_thread`
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –ø—Ä–∏ `returncode != 0` —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `None` –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è

3. **–°–æ–∑–¥–∞–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   - `_async_fetch_default_output_device()` - –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ `asyncio.to_thread`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(device_name, is_bluetooth)`

4. **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_check_and_update_output_device()`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ `_device_check_in_progress` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (`_device_check_result`)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É `_run_device_check_async()` —á–µ—Ä–µ–∑ `asyncio.create_task` –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
   - –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç callback - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` —Å—Ä–∞–∑—É, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

5. **–°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `_run_device_check_async()`:**
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `_device_check_result`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–ª–∞–≥ `_device_check_in_progress`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `SwitchAudioSource` –±–æ–ª—å—à–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç callback, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ.

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è voice.recording_stop

**–§–∞–π–ª:** `integration/integrations/input_processing_integration.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_recording_stop_sent: bool`** –≤ `__init__`

2. **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_handle_short_press()`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `_recording_stop_sent` –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π `voice.recording_stop`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_handle_release()`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `_recording_stop_sent` –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π `voice.recording_stop`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

4. **–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_reset_session()`:**
   - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç `_recording_stop_sent = False` –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–µ—Å—Å–∏–∏

5. **–û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `_on_key_press()`:**
   - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç `_recording_stop_sent = False` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ (PRESS)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `voice.recording_stop` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ—Ç.

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ stop_listening

**–§–∞–π–ª:** `integration/integrations/voice_recognition_integration.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ `stop_listening()`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `is_listening` –∏ `stream_active`
   - –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤—ã–∑–æ–≤ `stop_listening()`
   - –ü—É–±–ª–∏–∫—É–µ—Ç `microphone.closed` –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "audio stream is idle" –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç:
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `SwitchAudioSource` –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø—É—Ç–∏ (–Ω–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `returncode=-2` –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ –ª–æ–≥–æ–≤
- [ ] –ù–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ `voice.recording_stop/stop_listening`, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ (callback, device check task) –ª–æ–≥–∏—Ä—É—é—Ç —Å—Ç–∞—Ä—Ç/–æ–∫–æ–Ω—á–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
1. **–õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   - `üîç [OUTPUT] –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...`
   - `‚úÖ [OUTPUT] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: "device_name" (BT=False)`
   - –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥

2. **–õ–æ–≥–∏ voice.recording_stop:**
   - –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
   - –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π "audio stream is idle"

3. **–õ–æ–≥–∏ stop_listening:**
   - `‚ö†Ô∏è VOICE: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º stop_listening` (–µ—Å–ª–∏ –ø–æ—Ç–æ–∫ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
   - –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `stop_listening`

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `modules/speech_playback/core/player.py` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `integration/integrations/input_processing_integration.py` - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- `integration/integrations/voice_recognition_integration.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—è




