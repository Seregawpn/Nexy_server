# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `_on_recording_stop`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–±—ã—Ç–∏–µ `voice.mic_data_ready` –ø—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ `result.data` –±—ã–ª –ø—É—Å—Ç—ã–º, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–≤–æ–π–Ω–æ–º—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
if result.data and len(result.data) > 0:
    # –û–°–ù–û–í–ù–û–ô –ü–£–¢–¨: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    await self._publish_mic_data_ready(result, session_id)
    # –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä –∑–¥–µ—Å—å
elif self._audio_buffer and not streaming_processed:
    # LEGACY FALLBACK: –ï—Å–ª–∏ result.data –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä
    logger.warning(f"‚ö†Ô∏è [AVF] result.data –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º legacy fallback –∏–∑ –±—É—Ñ–µ—Ä–∞")
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ï—Å–ª–∏ `result.data` –Ω–µ –ø—É—Å—Ç–æ–π ‚Üí –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ, –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä
- ‚úÖ –ï—Å–ª–∏ `result.data` –ø—É—Å—Ç–æ–π ‚Üí –ù–ï –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä (legacy fallback)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `_publish_mic_data_ready`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ –º–æ–≥ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
async def _publish_mic_data_ready(self, result, session_id: str):
    # ‚úÖ –ü–†–û–í–ï–†–ö–ê: –ù–µ –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if not result.data or len(result.data) == 0:
        logger.warning(f"‚ö†Ô∏è [AVF] _publish_mic_data_ready: result.data –ø—É—Å—Ç–æ–π, –Ω–µ –ø—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ")
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º payload —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    payload = {...}
    await self.event_bus.publish("voice.mic_data_ready", payload)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ `_on_mic_data_ready`

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã (—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ)

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `_recognizer = None` –ø—Ä–∏ AVF

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
if self._use_avf:
    logger.info("‚ÑπÔ∏è [AUDIO_DEBUG] SpeechRecognizer –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º AVF, –∏–∑–±–µ–≥–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)")
    self._recognizer = None
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ AVF –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è SpeechRecognizer
- ‚úÖ –ò–∑–±–µ–≥–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

---

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ `_on_mic_data_ready`

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
async def _on_mic_data_ready(self, event: Dict[str, Any]):
    session_id = data.get("session_id")
    
    # ‚úÖ –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ô –û–ë–†–ê–ë–û–¢–ö–ò
    if session_id in self._processed_mic_data_sessions:
        logger.warning(f"‚ö†Ô∏è [AVF] voice.mic_data_ready –¥–ª—è session={session_id} —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç")
        return
    
    # –ü–æ–º–µ—á–∞–µ–º —Å–µ—Å—Å–∏—é –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—É—é
    self._processed_mic_data_sessions.add(session_id)
    
    try:
        await self._recognize_avf_audio(...)
    finally:
        # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        self._processed_mic_data_sessions.discard(session_id)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –§–ª–∞–≥ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞)

---

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ `Recognizer` –≤ `_recognize_avf_audio`

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
if self._use_avf:
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏ AVF —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π Recognizer –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ SpeechRecognizer)
    # –≠—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç –¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ PyAudio
    recognizer = sr.Recognizer()
    language = batch_language
    logger.debug(f"üîç [AVF] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π Recognizer (–∏–∑–±–µ–≥–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π `sr.Recognizer()` –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ AVF
- ‚úÖ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `self._recognizer` (–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω)

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **–ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏** (`voice.recording_start`)
   - ‚úÖ `_recognizer = None` –ø—Ä–∏ `_use_avf = True`
   - ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ñ–ª–∞–≥–∞ `_processed_mic_data_sessions`
   - ‚úÖ –ó–∞–ø—É—Å–∫ AVF –∑–∞–ø–∏—Å–∏

2. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏** (`voice.recording_stop`)
   - ‚úÖ –ï—Å–ª–∏ `result.data` –Ω–µ –ø—É—Å—Ç–æ–π ‚Üí –ø—É–±–ª–∏–∫—É–µ–º `voice.mic_data_ready`
   - ‚úÖ –ï—Å–ª–∏ `result.data` –ø—É—Å—Ç–æ–π ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º legacy fallback –∏–∑ –±—É—Ñ–µ—Ä–∞
   - ‚úÖ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä, –µ—Å–ª–∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ —Å–æ–±—ã—Ç–∏–µ

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Å—Ç–∞—Ñ–µ—Ç—ã** (`voice.mic_data_ready`)
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - ‚úÖ –ü–æ–º–µ—á–∞–µ–º —Å–µ—Å—Å–∏—é –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—É—é
   - ‚úÖ –í—ã–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
   - ‚úÖ –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

4. **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ** (`_recognize_avf_audio`)
   - ‚úÖ –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π `sr.Recognizer()`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É `speech_recognition`
   - ‚úÖ –í—ã–∑—ã–≤–∞–µ–º `recognize_google()` –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `_on_recording_stop` (–ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `_publish_mic_data_ready` (–Ω–µ –ø—É–±–ª–∏–∫—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ)
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `_recognizer = None` –ø—Ä–∏ AVF
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ `_on_mic_data_ready`
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ `Recognizer` –≤ `_recognize_avf_audio`

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–õ–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- ‚úÖ –ï–¥–∏–Ω–æ–ª–∏—á–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º (AVF)
- ‚úÖ –Ø–≤–Ω–∞—è —ç—Å—Ç–∞—Ñ–µ—Ç–∞ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ speech_recognition
- ‚úÖ Legacy fallback —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ result.data –ø—É—Å—Ç–æ–π

