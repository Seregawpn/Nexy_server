# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã: –†–µ—á—å –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–ª–∞—Å—å

## üîç –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –ª–æ–≥–æ–≤

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:

1. **–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å**:
   - `‚úÖ [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ: 506880 bytes, 48000Hz, 1ch, duration‚âà5.28s`
   - `‚úÖ [AVF] scheduleBuffer –≤—ã–∑–≤–∞–Ω —Å completion handler (Python —Ñ—É–Ω–∫—Ü–∏—è)`
   - `‚úÖ [AVF] Fallback —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ event loop (duration=5.78s)`

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–µ—Ä–≤–∞–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ**:
   - `üîÑ [AVF] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è OUTPUT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: Sergiy's AirPods`
   - `üîÑ [AVF] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ player node: engine_running=True, output_active=False, state=AudioState.STARTING`
   - `üõë [AVF] Engine –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`

3. **Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ**:
   - `‚ö†Ô∏è [AVF] –ö–†–ò–¢–ò–ß–ù–û: Playback completion callback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª —á–µ—Ä–µ–∑ 5.78s, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º`
   - **–ù–û**: –ù–µ—Ç –ª–æ–≥–∞ `‚úÖ [AVF] –°–æ–±—ã—Ç–∏–µ audio.playback.completed –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ fallback —Ç–∞–π–º–µ—Ä`

---

## üîß –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–∏—á–∏–Ω–∞ 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (`AVAudioEngineConfigurationChangeNotification`) –ø—Ä–∏—Ö–æ–¥—è—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –û–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç `_reconnect_player_node()`, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç engine –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è —Å `STARTING` ‚Üí `RECONNECTING` ‚Üí `IDLE` –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —É—Å–ø–µ–≤–∞–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ—Å—å (STARTING), –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –µ–≥–æ
if current_state_under_lock == AudioState.STARTING:
    logger.debug("üîç [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ STARTING, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ")
    self._cached_output_device_name = new_device_name
    return
```

### –ü—Ä–∏—á–∏–Ω–∞ 2: Fallback —Ç–∞–π–º–µ—Ä –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**:
- Fallback —Ç–∞–π–º–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `if self._output_state == AudioState.RUNNING`
- –ù–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–∂–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ `IDLE` –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
- –°–æ–±—ã—Ç–∏–µ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ WelcomeMessageIntegration –ø–æ–ª—É—á–∏—Ç —Å–æ–±—ã—Ç–∏–µ
if self._event_bus:
    await self._event_bus.publish("audio.playback.completed", {
        "source": "AVF_FALLBACK_TIMEOUT" if should_stop else "AVF_FALLBACK_TIMEOUT_STATE_CHANGED",
        "final_state": final_state.name,
        "missed_callbacks": self._missed_completion_callbacks,
        "was_stopped": should_stop
    })
```

### –ü—Ä–∏—á–∏–Ω–∞ 3: Python —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ Objective-C –±–ª–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞**:
- Python —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `scheduleBuffer_atTime_options_completionHandler_`
- PyObjC –Ω–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –µ—ë –≤ Objective-C –±–ª–æ–∫
- Completion callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ**: Fallback —Ç–∞–π–º–µ—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ)

---

## ‚úÖ –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ STARTING

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `STARTING`

```python
if current_state_under_lock == AudioState.STARTING:
    logger.debug("üîç [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ STARTING, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ")
    self._cached_output_device_name = new_device_name
    return
```

### 2. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ fallback

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ –í–°–ï–ì–î–ê (–¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
if self._event_bus:
    await self._event_bus.publish("audio.playback.completed", {
        "source": "AVF_FALLBACK_TIMEOUT" if should_stop else "AVF_FALLBACK_TIMEOUT_STATE_CHANGED",
        "final_state": final_state.name,
        "missed_callbacks": self._missed_completion_callbacks,
        "was_stopped": should_stop
    })
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ `audio.playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

2. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è completion callback**:
   - –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è Objective-C –±–ª–æ–∫–∞
   - –í–æ–∑–º–æ–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NSNotification –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ fallback —Ç–∞–π–º–µ—Ä –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º

---

## üìù –í—ã–≤–æ–¥—ã

1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ STARTING)
2. **Fallback —Ç–∞–π–º–µ—Ä –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞)
3. **Completion callback –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

