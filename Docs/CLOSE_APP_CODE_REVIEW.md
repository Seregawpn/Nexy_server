# –ö–æ–¥-—Ä–µ–≤—å—é: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è close_app E2E

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –°—Ç–∞—Ç—É—Å: ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –≥–æ—Ç–æ–≤–æ –∫ production

---

## üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å

#### 1. `server/server/config/unified_config.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `close_app` –≤ —Ä–∞–∑–¥–µ–ª "Action Intent" (—Å—Ç—Ä–æ–∫–∏ 155-160)
- –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä `close_app` –≤ "Action Output Format" (—Å—Ç—Ä–æ–∫–∏ 226-234)
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è `close_app`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 155-160: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è close_app
"If user asks to close/quit an app:
- Use **Action JSON format** with:
  ‚Ä¢ \"command\": \"close_app\"
  ‚Ä¢ \"args\": {\"app_name\": \"<exact macOS app name>\"}
  ‚Ä¢ \"session_id\": <MUST reuse from request, REQUIRED, never null>
  ‚Ä¢ \"text\": short confirmation (\"Closing Safari now.\")"

# –°—Ç—Ä–æ–∫–∞ 226-234: –ü—Ä–∏–º–µ—Ä close_app
"Example 2: Closing an app
{
  \"session_id\": \"<MUST use session_id from request, REQUIRED>\",
  \"command\": \"close_app\",
  \"args\": {
    \"app_name\": \"Safari\"
  },
  \"text\": \"Closing Safari.\"
}"
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

#### 2. `server/server/integrations/core/response_models.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `CloseAppArgs` (—Å—Ç—Ä–æ–∫–∏ 52-62)
- –û–±–Ω–æ–≤–ª–µ–Ω `validate_command`: –¥–æ–±–∞–≤–ª–µ–Ω `'close_app'` –≤ `allowed_commands` (—Å—Ç—Ä–æ–∫–∞ 88)
- –û–±–Ω–æ–≤–ª–µ–Ω `validate_args_for_command`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è `close_app` (—Å—Ç—Ä–æ–∫–∏ 102-107)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 52-62: CloseAppArgs
class CloseAppArgs(BaseModel):
    """Arguments for close_app command"""
    app_name: str = Field(..., min_length=1, description="macOS application name (without .app extension)")
    
    @field_validator('app_name')
    @classmethod
    def validate_app_name(cls, v: str) -> str:
        """Remove .app extension if present"""
        if v.endswith('.app'):
            return v[:-4]
        return v

# –°—Ç—Ä–æ–∫–∞ 88: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ close_app
allowed_commands = ['open_app', 'close_app']

# –°—Ç—Ä–æ–∫–∞ 102-107: –í–∞–ª–∏–¥–∞—Ü–∏—è args –¥–ª—è close_app
elif self.command == 'close_app':
    try:
        CloseAppArgs(**self.args)
    except Exception as e:
        raise ValueError(f"Invalid args for close_app command: {e}")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ —Å `open_app`

---

#### 3. `server/server/integrations/core/assistant_response_parser.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `args.app_name` –¥–ª—è `close_app` –≤ fallback-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 314-317)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 314-317: Fallback-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è close_app
if command == 'close_app':
    if 'app_name' not in args or not args.get('app_name'):
        validation_errors.append("–î–ª—è –∫–æ–º–∞–Ω–¥—ã 'close_app' —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–µ 'args.app_name'")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ —Å `open_app`

---

#### 4. `server/server/config.env.example`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò–∑–º–µ–Ω–µ–Ω –¥–µ—Ñ–æ–ª—Ç `FORWARD_ASSISTANT_ACTIONS` –Ω–∞ `false` (—Å—Ç—Ä–æ–∫–∞ 34)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Å—Ç—Ä–æ–∫–∏ 30-37)
- –î–æ–±–∞–≤–ª–µ–Ω `NEXY_KS_DISABLE_FORWARD_ASSISTANT_ACTIONS=false` (—Å—Ç—Ä–æ–∫–∞ 37)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –°—Ç—Ä–æ–∫–∞ 30-37: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç
# ‚ö†Ô∏è  –í–ê–ñ–ù–û: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# –í–∫–ª—é—á–∏—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –≤ production/staging –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
FORWARD_ASSISTANT_ACTIONS=false
# ‚ö†Ô∏è  –ù–ï –≤–∫–ª—é—á–∞–π—Ç–µ –≤ dev/–ª–æ–∫–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
NEXY_KS_DISABLE_FORWARD_ASSISTANT_ACTIONS=false
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç

---

#### 5. `server/server/config/unified_config_example.yaml`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–º–ø—Ç —Å `unified_config.py` (–≤–∫–ª—é—á–∞—è `close_app`)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `sample_rate: 24000`, `image_format: webp`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–º–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –ø—Ä–∏–º–µ—Ä (—Å—Ç—Ä–æ–∫–∏ 1-15)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–∏—á–∞-—Ñ–ª–∞–≥–∏ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Å—Ç—Ä–æ–∫–∏ 289-298)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `close_app` –≤ Action Intent –∏ Action Output Format
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å `unified_config.py`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

---

#### 6. `server/server/scripts/test_mcp_chain.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `"close_app"` –≤ `required_keywords` (—Å—Ç—Ä–æ–∫–∞ 40)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã –¥–ª—è `close_app` (—Å—Ç—Ä–æ–∫–∏ 125-135)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 40: –î–æ–±–∞–≤–ª–µ–Ω close_app
required_keywords = [
    "command",
    "open_app",
    "close_app",  # –î–æ–±–∞–≤–ª–µ–Ω–æ
    "args",
    "app_name",
    "session_id",
    "JSON"
]

# –°—Ç—Ä–æ–∫–∞ 125-135: –¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã
{
    "name": "–û—Ç–≤–µ—Ç —Å –∫–æ–º–∞–Ω–¥–æ–π close_app (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)",
    "response": {
        "command": "close_app",
        "args": {"app_name": "Safari"},
        "session_id": "test_session_456"
    },
    "expected_command": "close_app",
    "expected_app": "Safari"
},
{
    "name": "–û—Ç–≤–µ—Ç —Å –∫–æ–º–∞–Ω–¥–æ–π close_app –±–µ–∑ app_name (–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)",
    ...
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Ç–µ—Å—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

#### 7. `server/server/scripts/verify_close_app_production_readiness.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∫ `close_app`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
1. –§–∏—á–∞-—Ñ–ª–∞–≥–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏
2. –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏ –Ω–∞–ª–∏—á–∏–µ `close_app`
3. –ü—É—Ç—å –∫ MCP —Å–µ—Ä–≤–µ—Ä—É

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–∞—Ä–∞–º–µ—Ç—Ä `--project-root` –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

#### 8. `client/integration/integrations/action_execution_integration.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `close_app` –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 244-258)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `app_name` –¥–ª—è `close_app` (—Å—Ç—Ä–æ–∫–∏ 95, 275-300, 420-430)
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è `app_name` (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- **–ò–°–ü–†–ê–í–õ–ï–ù–û:** –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è `actions.close_app.failed` —Å –∫–æ–¥–æ–º `already_running` –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–Ω—ã—Ö —Å–µ—Å—Å–∏–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 95: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
self._active_apps: Dict[str, str] = {}  # app_name_normalized -> session_id

# –°—Ç—Ä–æ–∫–∞ 275-300: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è close_app —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ —Å–æ–±—ã—Ç–∏–µ–º
if action_type == "close_app" and app_name:
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º app_name –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
    app_name_normalized = app_name.strip().lower()
    if app_name_normalized in self._active_apps:
        existing_session = self._active_apps[app_name_normalized]
        logger.info(
            "[%s] close_app already running for app=%s (session=%s, new_session=%s)",
            feature_id, app_name, existing_session, session_id
        )
        # –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ failure –¥–ª—è –≤—Ç–æ—Ä–æ–π —Å–µ—Å—Å–∏–∏
        await self._publish_failure(
            session_id=session_id,
            feature_id=action_feature_id,
            error_code="already_running",
            message=f"close_app already running for {app_name} (session={existing_session})",
            app_name=app_name,
        )
        return
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á)
    self._active_apps[app_name_normalized] = session_id

# –°—Ç—Ä–æ–∫–∞ 420-430: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π)
if action_type == "close_app" and app_name:
    app_name_normalized = app_name.strip().lower()
    if self._active_apps.get(app_name_normalized) == session_id:
        self._active_apps.pop(app_name_normalized, None)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ —Å–æ–±—ã—Ç–∏—è–º–∏

---

#### 9. `client/scripts/verify_close_app_client_readiness.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∫ `close_app`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é MCP `close_app`
2. –ù–∞–ª–∏—á–∏–µ `ActionExecutionIntegration`
3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `actions.close_app`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–∞—Ä–∞–º–µ—Ç—Ä `--project-root` –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å `OpenAppActionConfig` –æ–±—ä–µ–∫—Ç–∞–º–∏ (–Ω–µ —Å–ª–æ–≤–∞—Ä—è–º–∏)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

#### 10. `client/scripts/test_close_app_e2e.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—É—Ç—å: `client(prod)` ‚Üí `client` (—Å—Ç—Ä–æ–∫–∞ 21)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç

---

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### 11. `Docs/CLOSE_APP_E2E_IMPLEMENTATION_GUIDE.md` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ü–æ–ª–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Definition of Done

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

#### 12. `Docs/CLOSE_APP_PRODUCTION_CHECKLIST.md` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è production
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –†–µ—à–µ–Ω–∏—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç

---

#### 13. `Docs/CLOSE_APP_SAFETY_FIXES.md` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç —Ñ–ª–∞–≥–æ–≤
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å `close_app`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

#### 14. `Docs/CLOSE_APP_PRODUCTION_DEPLOYMENT.md` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å

‚úÖ **–°–∏–º–º–µ—Ç—Ä–∏—è —Å open_app:**
- `close_app` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ —Å `open_app`
- –¢–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (Pydantic + fallback)
- –¢–µ –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –¢–µ –∂–µ —Å–æ–±—ã—Ç–∏—è EventBus

‚úÖ **–°–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤:**
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (unified_config.py)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ (response_models.py, assistant_response_parser.py)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç (false –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç:**
- `FORWARD_ASSISTANT_ACTIONS=false` –≤ `config.env.example`
- –Ø–≤–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è
- Kill-switch –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ `session_id` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ `app_name` –¥–ª—è `close_app` (–Ω–æ–≤–∞—è)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

‚úÖ **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:**
- Unit —Ç–µ—Å—Ç—ã: –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `response_models.py`
- Integration —Ç–µ—Å—Ç—ã: –ø–∞—Ä—Å–∏–Ω–≥ –≤ `assistant_response_parser.py`
- E2E —Ç–µ—Å—Ç—ã: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≤ `test_close_app_e2e.py`
- Readiness-—Å–∫—Ä–∏–ø—Ç—ã: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production

‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã:**
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `close_app` —Å `app_name`
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `close_app` –±–µ–∑ `app_name` (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è)
- –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã
- –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ `session_id` (fallback)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

‚úÖ **–ü–æ–ª–Ω–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (E2E_IMPLEMENTATION_GUIDE)
- –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è production (PRODUCTION_CHECKLIST)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (SAFETY_FIXES)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é (PRODUCTION_DEPLOYMENT)

‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
- –ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
- –ß–µ–∫-–ª–∏—Å—Ç—ã
- –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ–¥-—Ä–µ–≤—å—é

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–Ω—ã—Ö —Å–µ—Å—Å–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–µ `close_app` –¥–ª—è –¥—Ä—É–≥–æ–≥–æ `session_id` —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ "–ø–æ–¥–≤–∏—Å—à–µ–º—É" –∑–∞–ø—Ä–æ—Å—É.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ `actions.close_app.failed` —Å –∫–æ–¥–æ–º `already_running`, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç/—Å–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∏ 290-297)

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è app_name
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `app_name` –±—ã–ª–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –ø—Ä–æ–±–µ–ª–∞–º (Safari vs safari), —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ `app_name.strip().lower()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ `_active_apps`, –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ `app_name` –≤ `action_data` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ MCP.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∏ 280, 300, 423)

---

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

1. **MCP –ø—É—Ç—å:** –í –∫–æ–Ω—Ñ–∏–≥–µ —É–∫–∞–∑–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—É—Ç—å `mcp_close_app_test/server/close_app_server.py`
   - –ï—Å–ª–∏ —ç—Ç–æ production –ø—É—Ç—å - –≤—Å—ë –æ–∫
   - –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –ø—É—Ç—å - –æ–±–Ω–æ–≤–∏—Ç—å –≤ `unified_config.yaml`

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö `close_app`
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `close_app`
   - –ß–∞—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

### –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ production

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** ‚úÖ –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ —Å `open_app`, —Å–æ–±–ª—é–¥–µ–Ω—ã –ø—Ä–∏–Ω—Ü–∏–ø—ã
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚úÖ –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** ‚úÖ –ü–æ–ª–Ω–∞—è –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚úÖ **APPROVE** - –≥–æ—Ç–æ–≤–æ –∫ merge –∏ –¥–µ–ø–ª–æ—é

---

## üìù –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å env –≤ production:**
```bash
export FORWARD_ASSISTANT_ACTIONS=true
export NEXY_KS_DISABLE_FORWARD_ASSISTANT_ACTIONS=false
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ `close_app` –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –≤ production.
