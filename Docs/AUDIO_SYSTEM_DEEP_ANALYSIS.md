# –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—ã

**–î–∞—Ç–∞:** 2025-12-05  
**–¶–µ–ª—å:** –í—ã—è–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –≥–æ–Ω–æ–∫ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ **–º–∏–Ω–∏–º—É–º 4 –º–µ—Å—Ç–∞—Ö** —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏:

1. `modules/voice_recognition/core/speech_recognizer.py:1364` - `_is_bluetooth_device()` (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥)
   ```python
   return any(keyword in lowered for keyword in ("bluetooth", "airpods", "beats", "headset", "earbud"))
   ```

2. `modules/speech_playback/core/player.py:1669` - `_is_bluetooth_device()`
   ```python
   return any(keyword in lowered for keyword in ("bluetooth", "airpods", "airpod", "beats", "headset", "earbud"))
   ```
   ‚ö†Ô∏è **–û—Ç–ª–∏—á–∏–µ:** –µ—Å—Ç—å "airpod" (–±–µ–∑ 's')

3. `modules/audio_core/legacy_compat.py:271` - `is_bluetooth_device()` –≤ `DeviceParamsNormalizer`
   ```python
   # –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
   ```

4. `modules/voice_recognition/core/audio_recovery_manager.py:328` - `_is_bluetooth_device()`
   ```python
   # –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
   ```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏: –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏: –æ–¥–Ω–æ –º–µ—Å—Ç–æ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —É—Ç–∏–ª–∏—Ç–Ω—ã–π –º–æ–¥—É–ª—å `modules/audio_core/device_utils.py` —Å –µ–¥–∏–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π `is_bluetooth_device(name: str) -> bool`.

---

### 2. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ device_id –ø–æ –∏–º–µ–Ω–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ PortAudio ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ –∏–º–µ–Ω–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

1. `modules/voice_recognition/core/speech_recognizer.py` - `_find_device_id_by_name_input()`
2. `modules/speech_playback/core/player.py` - `_uid_to_portaudio_index()`
3. `modules/audio_core/core_audio_device_bus.py` - `_find_device_id_by_name()`
4. `modules/voice_recognition/core/audio_device_monitor.py` - –≤ `_get_device_via_macos_api()`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –†–∞–∑–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `modules/audio_core/device_utils.py`:
- `find_device_id_by_name(name: str, direction: str = "input") -> Optional[int]`

---

### 3. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:

1. `modules/voice_recognition/core/speech_recognizer.py` - `_get_system_default_input_index()`, `_get_system_default_input_name()`
2. `modules/speech_playback/core/player.py` - `_query_system_default_output()`
3. `modules/audio_core/core_audio_device_bus.py` - `_get_current_device_info()`
4. `modules/voice_recognition/core/audio_device_monitor.py` - `_get_current_input_device()`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –†–∞–∑–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (SwitchAudioSource vs PortAudio)
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `modules/audio_core/device_utils.py`:
- `get_system_default_device(direction: str = "input") -> tuple[Optional[str], Optional[int]]`

---

### 4. ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ deadlocks —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í `SpeechRecognizer` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **4 —Ä–∞–∑–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:
- `self.audio_lock = threading.Lock()` (—Å—Ç—Ä–æ–∫–∞ 48)
- `self._start_lock = asyncio.Lock()` (—Å—Ç—Ä–æ–∫–∞ 61)
- `self._stream_state_lock = threading.RLock()` (—Å—Ç—Ä–æ–∫–∞ 68)
- `self._stream_lock = threading.RLock()` (—Å—Ç—Ä–æ–∫–∞ 76)

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:**
- `_stream_lock` –∏ `_stream_state_lock` –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ
- `audio_lock` –∏ `_stream_lock` –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ deadlocks:**
```python
# –ú–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:
# 1. _run_listening() - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç _stream_lock –∏ _stream_state_lock
# 2. on_device_changed() - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç _stream_lock
# 3. stop_listening() - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç _stream_lock –∏ _stream_state_lock
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `RLock` –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω—ã –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ deadlocks

---

### 5. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:

1. `modules/voice_recognition/core/speech_recognizer.py` - `_classify_input_device()`
2. `modules/speech_playback/core/player.py` - `_classify_output_device()`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –†–∞–∑–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è INPUT –∏ OUTPUT
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `modules/audio_core/device_utils.py`:
- `classify_device(name: str, direction: str = "input") -> int`

---

### 6. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:

1. `modules/voice_recognition/core/speech_recognizer.py` - `_is_remote_device()`
2. `modules/speech_playback/core/player.py` - `_is_remote_device()`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `modules/audio_core/device_utils.py`:
- `is_remote_device(name: str) -> bool`

---

### 7. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è StreamConfig

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–õ–æ–≥–∏–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è `StreamConfig` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:

1. `modules/voice_recognition/core/speech_recognizer.py` - `_build_stream_config_for_device()`
2. `modules/speech_playback/core/player.py` - –≤–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `modules/audio_core/device_utils.py` –∏–ª–∏ `legacy_compat.py`:
- `build_stream_config(device_name: str, device_id: Optional[int], is_bluetooth: bool, direction: str) -> StreamConfig`

---

## üìã –ü–ª–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å device_utils.py

**–§–∞–π–ª:** `modules/audio_core/device_utils.py` (–Ω–æ–≤—ã–π)

**–§—É–Ω–∫—Ü–∏–∏:**
```python
def is_bluetooth_device(name: str) -> bool:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤"""
    
def is_remote_device(name: str) -> bool:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤"""
    
def classify_device(name: str, direction: str = "input") -> int:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)"""
    
def find_device_id_by_name(name: str, direction: str = "input") -> Optional[int]:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ device_id –ø–æ –∏–º–µ–Ω–∏"""
    
def get_system_default_device(direction: str = "input") -> tuple[Optional[str], Optional[int]]:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"""
    
def build_stream_config(device_name: str, device_id: Optional[int], 
                       is_bluetooth: bool, direction: str, 
                       sample_rate: int = 48000, channels: int = 1) -> StreamConfig:
    """–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è StreamConfig"""
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –≤—ã–∑–æ–≤—ã

**–§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
1. `modules/voice_recognition/core/speech_recognizer.py`
2. `modules/speech_playback/core/player.py`
3. `modules/audio_core/legacy_compat.py`
4. `modules/voice_recognition/core/audio_recovery_manager.py`
5. `modules/audio_core/core_audio_device_bus.py`
6. `modules/voice_recognition/core/audio_device_monitor.py`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–§–∞–π–ª:** `modules/voice_recognition/core/speech_recognizer.py`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í—Å–µ–≥–¥–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `RLock` –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞

---

## üîí –ê–Ω–∞–ª–∏–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö deadlocks

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ SpeechRecognizer:

1. **`audio_lock`** (threading.Lock)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: –∑–∞—â–∏—Ç—ã `audio_data`
   - –ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: `get_audio_data_length()`

2. **`_start_lock`** (asyncio.Lock)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: –∑–∞—â–∏—Ç—ã –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
   - –ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: `start_listening()`

3. **`_stream_state_lock`** (threading.RLock)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: –∑–∞—â–∏—Ç—ã `_stream_state`
   - –ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: `_run_listening()`, `stop_listening()`, `start_listening()`

4. **`_stream_lock`** (threading.RLock)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: –∑–∞—â–∏—Ç—ã `_current_stream`
   - –ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: `on_device_changed()`, `_run_listening()`, `stop_listening()`

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: `_stream_lock` + `_stream_state_lock`**

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:

1. **`_graceful_stop_listening()` (—Å—Ç—Ä–æ–∫–∏ 518-535):**
   ```python
   with self._stream_state_lock:  # –ó–∞—Ö–≤–∞—Ç 1
       # ...
   with self._stream_lock:  # –ó–∞—Ö–≤–∞—Ç 2
       # ...
   ```
   ‚úÖ **–ü–û–†–Ø–î–û–ö:** `_stream_state_lock` ‚Üí `_stream_lock`

2. **`start_listening()` (—Å—Ç—Ä–æ–∫–∏ 612-714):**
   ```python
   with self._stream_state_lock:  # –ó–∞—Ö–≤–∞—Ç 1
       # ...
   with self._stream_lock:  # –ó–∞—Ö–≤–∞—Ç 2
       # ...
   with self._stream_state_lock:  # –ó–∞—Ö–≤–∞—Ç 3 (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π, –Ω–æ RLock –±–µ–∑–æ–ø–∞—Å–µ–Ω)
       # ...
   with self._stream_lock:  # –ó–∞—Ö–≤–∞—Ç 4 (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π, –Ω–æ RLock –±–µ–∑–æ–ø–∞—Å–µ–Ω)
       # ...
   ```
   ‚úÖ **–ü–û–†–Ø–î–û–ö:** `_stream_state_lock` ‚Üí `_stream_lock` (RLock –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞—Ö–≤–∞—Ç–æ–≤)

3. **`stop_listening()` (—Å—Ç—Ä–æ–∫–∏ 787-829):**
   ```python
   with self._stream_state_lock:  # –ó–∞—Ö–≤–∞—Ç 1
       # ...
   with self._stream_lock:  # –ó–∞—Ö–≤–∞—Ç 2
       # ...
   ```
   ‚úÖ **–ü–û–†–Ø–î–û–ö:** `_stream_state_lock` ‚Üí `_stream_lock`

4. **`_run_listening()` (—Å—Ç—Ä–æ–∫–∏ 1289-1309):**
   ```python
   with self._stream_state_lock:  # –ó–∞—Ö–≤–∞—Ç 1
       # ...
   with self._stream_lock:  # –ó–∞—Ö–≤–∞—Ç 2
       # ...
   ```
   ‚úÖ **–ü–û–†–Ø–î–û–ö:** `_stream_state_lock` ‚Üí `_stream_lock`

**–í—ã–≤–æ–¥:** ‚úÖ **–ù–ï–¢ DEADLOCKS** - –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:
1. `_stream_state_lock` (–≤–Ω–µ—à–Ω—è—è)
2. `_stream_lock` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)

–û–±–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - `RLock`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Bluetooth:
- **–ë—ã–ª–æ:** 4+ –º–µ—Å—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏
- **–ù—É–∂–Ω–æ:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ device_id:
- **–ë—ã–ª–æ:** 4+ –º–µ—Å—Ç–∞
- **–ù—É–∂–Ω–æ:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
- **–ë—ã–ª–æ:** 4+ –º–µ—Å—Ç–∞
- **–ù—É–∂–Ω–æ:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- **–ë—ã–ª–æ:** 2 –º–µ—Å—Ç–∞ (INPUT –∏ OUTPUT)
- **–ù—É–∂–Ω–æ:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º direction

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏

- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –°–æ–∑–¥–∞—Ç—å `modules/audio_core/device_utils.py` —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ ‚úÖ **–°–û–ó–î–ê–ù (2025-12-05)**
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_is_bluetooth_device()` –Ω–∞ `device_utils.is_bluetooth_device()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_find_device_id_by_name()` –Ω–∞ `device_utils.find_device_id_by_name()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_get_system_default_*()` –Ω–∞ `device_utils.get_system_default_device()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_classify_*_device()` –Ω–∞ `device_utils.classify_device()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_is_remote_device()` –Ω–∞ `device_utils.is_remote_device()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `_build_stream_config_for_device()` –Ω–∞ `device_utils.build_stream_config()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ deadlocks ‚úÖ **–ü–†–û–í–ï–†–ï–ù–û - –ù–ï–¢ DEADLOCKS (2025-12-05)**
- [x] **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ ‚úÖ **–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–û (2025-12-05)**

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏:
1. ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ **‚úÖ –ß–ê–°–¢–ò–ß–ù–û** (—Å–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å, –Ω–æ –∑–∞–º–µ–Ω–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞)
2. ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —É—Ç–∏–ª–∏—Ç **‚úÖ –ì–û–¢–û–í–û** (–º–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω)
3. ‚úÖ –ù–µ—Ç –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ **‚úÖ –ì–û–¢–û–í–û** (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
4. ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö deadlocks **‚úÖ –ü–†–û–í–ï–†–ï–ù–û** (–ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
5. ‚úÖ –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ **‚úÖ –£–õ–£–ß–®–ï–ù–û**

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2025-12-05)

### 1. –°–æ–∑–¥–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å `device_utils.py`

**–§–∞–π–ª:** `modules/audio_core/device_utils.py` (–Ω–æ–≤—ã–π)

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ `is_bluetooth_device(name: str) -> bool` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Bluetooth
- ‚úÖ `is_remote_device(name: str) -> bool` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è remote —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ `classify_device(name: str, direction: str) -> int` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ `find_device_id_by_name(name: str, direction: str) -> Optional[int]` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ ID
- ‚úÖ `get_system_default_device(direction: str) -> tuple[Optional[str], Optional[int]]` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è default
- ‚úÖ `build_stream_config(...) -> StreamConfig` - –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ**

### 2. –ü—Ä–æ–≤–µ—Ä–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ deadlocks

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ù–ï–¢ DEADLOCKS**

**–ü–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π):**
1. `_stream_state_lock` (–≤–Ω–µ—à–Ω—è—è, RLock)
2. `_stream_lock` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è, RLock)

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `_graceful_stop_listening()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
- ‚úÖ `start_listening()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (RLock –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞—Ö–≤–∞—Ç–æ–≤)
- ‚úÖ `stop_listening()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
- ‚úÖ `_run_listening()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `Docs/AUDIO_SYSTEM_DEEP_ANALYSIS.md`

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Bluetooth:** 4+ –º–µ—Å—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏
- **–ü–æ–∏—Å–∫ device_id:** 4+ –º–µ—Å—Ç–∞
- **–ü–æ–ª—É—á–µ–Ω–∏–µ default —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:** 4+ –º–µ—Å—Ç–∞
- **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:** 2 –º–µ—Å—Ç–∞
- **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–æ–≤:** 13 –º–µ—Å—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ)

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):
- ‚úÖ **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ç–æ–∫–æ–≤:** 2 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ (`_close_stream_safely()` –∏ `_close_stream_safely_sync()`)
- ‚úÖ **–£—Ç–∏–ª–∏—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤:** 1 —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å (`device_utils.py`) —Å 6 —Ñ—É–Ω–∫—Ü–∏—è–º–∏
- ‚úÖ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏:** –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ deadlocks, –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –≤—ã–∑–æ–≤—ã –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `device_utils.py` –¥–ª—è –ø–æ–ª–Ω–æ–π —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `device_utils.py` –≤ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª—è—Ö
- **–í–∞–∂–Ω–æ:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

