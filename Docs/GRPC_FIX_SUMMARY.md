# üîß –†–µ–∑—é–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã gRPC

**–î–∞—Ç–∞:** 13 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Nginx —Å –º–æ–¥—É–ª–µ–º grpc

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

Nginx –æ—Ç–≤–µ—á–∞–µ—Ç 400 –Ω–∞ HTTP/2 preface gRPC –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ—Ç–æ–º—É —á—Ç–æ –º–æ–¥—É–ª—å `ngx_http_grpc_module` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å–±–æ—Ä–∫–µ Ubuntu 24.04.

---

## üîç Root Cause

1. **–ú–æ–¥—É–ª—å grpc –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞–∫–µ—Ç—ã `nginx` –∏ `nginx-full` –≤ Ubuntu 24.04 –Ω–µ –≤–∫–ª—é—á–∞—é—Ç –º–æ–¥—É–ª—å `ngx_http_grpc_module`
2. **–î–∏—Ä–µ–∫—Ç–∏–≤–∞ grpc_pass –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –ë–µ–∑ –º–æ–¥—É–ª—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `grpc_pass` –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è –∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
3. **HTTP/2 preface –ø–æ–ª—É—á–∞–µ—Ç 400:** Nginx –≤–∏–¥–∏—Ç `PRI * HTTP/2.0` –∫–∞–∫ –æ–±—ã—á–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ location –±–ª–æ–∫–æ–≤ (`/health` –∏ `/status` –ø–µ—Ä–µ–¥ `/`)
2. ‚úÖ –£–¥–∞–ª–µ–Ω—ã backup —Ñ–∞–π–ª—ã, –≤—ã–∑—ã–≤–∞–≤—à–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
3. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `nginx-full` (–Ω–æ –º–æ–¥—É–ª—å grpc –≤—Å—ë –µ—â—ë –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
4. ‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `proxy_pass` –≤–º–µ—Å—Ç–æ `grpc_pass` (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

---

## ‚ö†Ô∏è –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ —Å `proxy_pass` –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ gRPC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- Nginx –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å gRPC –ø—Ä–æ—Ç–æ–∫–æ–ª –±–µ–∑ –º–æ–¥—É–ª—è grpc
- HTTP/2 preface –≤—Å—ë –µ—â—ë –ø–æ–ª—É—á–∞–µ—Ç 400 –æ—à–∏–±–∫—É

**–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:**
```
"PRI * HTTP/2.0" 400 166
```

---

## üéØ –†–µ—à–µ–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Nginx —Å –º–æ–¥—É–ª–µ–º grpc (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /tmp
wget http://nginx.org/download/nginx-1.24.0.tar.gz
tar -xzf nginx-1.24.0.tar.gz
cd nginx-1.24.0

# –°–∫–∞—á–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
sudo apt-get install -y build-essential libpcre3-dev zlib1g-dev libssl-dev

# –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –º–æ–¥—É–ª–µ–º grpc
./configure \
  --prefix=/usr/share/nginx \
  --conf-path=/etc/nginx/nginx.conf \
  --http-log-path=/var/log/nginx/access.log \
  --error-log-path=/var/log/nginx/error.log \
  --with-http_ssl_module \
  --with-http_v2_module \
  --with-http_grpc_module \
  --with-http_realip_module \
  --with-http_stub_status_module

# –°–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
make
sudo make install

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
nginx -V 2>&1 | grep grpc
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–∞–∫–µ—Ç —Å grpc (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ PPA —Å Nginx, –≤–∫–ª—é—á–∞—é—â–∏–º –º–æ–¥—É–ª—å grpc.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏ (Envoy/HAProxy)

–ï—Å–ª–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π gRPC –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–¥ Nginx.

---

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–¥—É–ª—è grpc –≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```nginx
location / {
    grpc_pass grpc://grpc_backend;
    grpc_read_timeout 300s;
    grpc_send_timeout 300s;
    grpc_connect_timeout 10s;
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. `nginx -V 2>&1 | grep grpc` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å
2. gRPC –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 443 –±–µ–∑ 400 –Ω–∞ "PRI * HTTP/2.0"
3. –í –ª–æ–≥–∞—Ö –Ω–µ—Ç 400 –æ—à–∏–±–æ–∫ –Ω–∞ HTTP/2 preface
4. gRPC –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

---

**–°—Ç–∞—Ç—É—Å:** üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Nginx —Å –º–æ–¥—É–ª–µ–º grpc –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
