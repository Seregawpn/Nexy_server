# ‚úÖ –ê—É–¥–∏—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## üìä –†–µ–∑—é–º–µ

–ü—Ä–æ–≤–µ–¥—ë–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–¥–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
- ‚úÖ Race conditions (–≥–æ–Ω–∫–∏ —É—Å–ª–æ–≤–∏–π)
- ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ Hardcoded –∑–Ω–∞—á–µ–Ω–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∞–π–¥–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ **6 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º**.

---

## ‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ Race Condition –¥–ª—è `_google_audio_chunks`**

**–ü—Ä–æ–±–ª–µ–º–∞:** `_google_audio_chunks` –∏–∑–º–µ–Ω—è–ª—Å—è –∏–∑ callback –ø–æ—Ç–æ–∫–∞ –∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ async –ø–æ—Ç–æ–∫–∞ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `threading.Lock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `_google_audio_chunks` —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω—ã lock'–æ–º

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –í __init__:
self._google_audio_chunks_lock = threading.Lock()

# –í callback:
with self._google_audio_chunks_lock:
    self._google_audio_chunks.append(audio)

# –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ:
with self._google_audio_chunks_lock:
    if self._google_audio_chunks and len(self._google_audio_chunks) > 0:
        self._google_audio_data = self._google_audio_chunks[-1]
    self._google_audio_chunks = []
```

**–§–∞–π–ª—ã:**
- `integration/integrations/voice_recognition_integration.py` (—Å—Ç—Ä–æ–∫–∏ ~103, ~782, ~1010, ~828, ~839, ~1035, ~1048, ~1489, ~1495, ~770)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

### 2. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã hardcoded timeout/delay –∑–Ω–∞—á–µ–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞:** `0.5` —Å–µ–∫—É–Ω–¥—ã –±—ã–ª–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è `audio.google_recognition` –≤ `unified_config.yaml`
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ —Å fallback –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**–í `unified_config.yaml`:**
```yaml
audio:
  google_recognition:
    callback_wait_sec: 0.5  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è callback'–æ–≤
    ambient_noise_duration_sec: 0.5  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞
```

**–í –∫–æ–¥–µ:**
```python
# –î–ª—è adjust_for_ambient_noise:
ambient_noise_duration = 0.5  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
try:
    loader = UnifiedConfigLoader()
    avf_config = loader.get_audio_avf_config()
    if 'google_recognition' in avf_config:
        ambient_noise_duration = avf_config['google_recognition'].get('ambient_noise_duration_sec', 0.5)
except Exception:
    pass
recognizer.adjust_for_ambient_noise(microphone, duration=ambient_noise_duration)

# –î–ª—è asyncio.sleep:
callback_wait = 0.5  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
try:
    loader = UnifiedConfigLoader()
    avf_config = loader.get_audio_avf_config()
    if 'google_recognition' in avf_config:
        callback_wait = avf_config['google_recognition'].get('callback_wait_sec', 0.5)
except Exception:
    pass
await asyncio.sleep(callback_wait)
```

**–§–∞–π–ª—ã:**
- `config/unified_config.yaml` (—Å—Ç—Ä–æ–∫–∏ ~565-567)
- `integration/integrations/voice_recognition_integration.py` (—Å—Ç—Ä–æ–∫–∏ ~790-798, ~1004-1010)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üìã –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### 3. ‚ö†Ô∏è **Hardcoded sample_rate –∑–Ω–∞—á–µ–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞:** `48000` –∏ `16000` –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö.

**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ - –µ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥ `audio.input.target_rate: 16000` –∏ `audio.output.source_rate: 48000`, –Ω–æ –Ω–µ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ).

**–ú–µ—Å—Ç–∞:**
- –°—Ç—Ä–æ–∫–∞ 118: `self._streaming_sample_rate: int = 48000`
- –°—Ç—Ä–æ–∫–∞ 121: `self._batch_sample_rate: int = 48000`
- –°—Ç—Ä–æ–∫–∞ 263: `default_sample_rate = speech_config.get("default_sample_rate", 48000)`
- –°—Ç—Ä–æ–∫–∞ 595: `self._audio_config.input.target_rate if self._audio_config else 48000`
- –°—Ç—Ä–æ–∫–∞ 1124: `sample_rate = self._audio_buffer_sample_rate or getattr(self, '_batch_sample_rate', 48000)`
- –°—Ç—Ä–æ–∫–∞ 1701: `target_sample_rate = 16000  # Google Speech API —Å—Ç–∞–Ω–¥–∞—Ä—Ç`

---

### 4. ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ `_google_audio_chunks`**

**–ü—Ä–æ–±–ª–µ–º–∞:** `_google_audio_chunks = []` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ 6+ –º–µ—Å—Ç–∞—Ö.

**–°—Ç–∞—Ç—É—Å:** –£–ª—É—á—à–µ–Ω–æ - —Ç–µ–ø–µ—Ä—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã lock'–æ–º, –Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_clear_google_recording_state()` –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç).

---

### 5. ‚ö†Ô∏è **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:** `_google_listening_thread` –æ–±—ä—è–≤–ª–µ–Ω–∞, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–°—Ç–∞—Ç—É—Å:** –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ **1 –∫—Ä–∏—Ç–∏—á–Ω–∞—è race condition** (Lock –¥–ª—è `_google_audio_chunks`)
- ‚úÖ **2 hardcoded –∑–Ω–∞—á–µ–Ω–∏—è** —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥
- ‚úÖ **–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `_google_audio_chunks`** –∑–∞—â–∏—â–µ–Ω—ã lock'–æ–º

### –û—Å—Ç–∞–ª–æ—Å—å (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
- ‚ö†Ô∏è **6 –º–µ—Å—Ç** —Å hardcoded `sample_rate` (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- ‚ö†Ô∏è **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥)
- ‚ö†Ô∏è **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–í—Å–µ **–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
1. ‚úÖ Race condition —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ `threading.Lock`
2. ‚úÖ Hardcoded timeout/delay –∑–Ω–∞—á–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã
3. ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å shared state –∑–∞—â–∏—â–µ–Ω—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π

**–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é lock'–æ–≤ –≤ production
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `_clear_google_recording_state()` –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏






