# Audio Core Architecture Transition Plan

## Цель

Перенести логику аудиоплеера с фокусом на PortAudio (`sounddevice`) на более точное взаимодействие с macOS Core Audio и macOS API, чтобы:

1. Правильно узнавать дефолтное выходное устройство (имя, UID, тип BT) и его поддерживаемые конфигурации.
2. Получать настоящий host error (`-10851` и т.п.) до вызова `sd.OutputStream` и строить поток как macOS ожидает.
3. Реагировать на смену устройства через нотификации и адаптировать stream config без `-9986` retries.
4. Сохранять “плохие” профили (например, когда Bluetooth отвергает ручные параметры) и сразу применять macOS-managed конфигурацию.

В итоге планируем избавиться от бесконечного цикла `-9986` ➝ `-10851`, заставить переход на Bluetooth/дефолт работать без явных ошибок и получить универсальную, адаптивную систему.

## Компоненты системы

1. **`MacOSAudioSession` (или аналог)**  
   * Запрашивает текущий дефолтный output через Core Audio / SwitchAudioSource.  
   * Возвращает поддерживаемые форматы (sample rate, channels, host error state).  
   * Подписывается на нотификации о смене маршрута и возвращает актуальные параметры.  
   * Хранит историю “неподходящих” конфигураций, чтобы при повторных подключениях сразу выбирать безопасный профиль.

2. **Resolver/Factory для `stream_config`**  
   * Принимает имя устройства, флаг BT, `host_error_code` и историю ошибок.  
   * Выдает корректную конфигурацию (`device_id`/`device=None`, sample_rate, моно/стерео, `blocksize`, `latency`).  
   * Может работать в режиме “macOS-managed” (device=None, каналы из Core Audio) или “портативном” (PortAudio ID).

3. **SequentialSpeechPlayer + Retry Manager**  
   * Использует resolver перед созданием `sd.OutputStream`.  
   * Отвечает за поток: останавливает старый (с учетом BT задержки), создаёт новый по config и логирует состояние.  
   * Ретрай остаётся только для “device busy” (`-9986`), не для конфигурационных конфликтов.

## Итерационный план

Каждая итерация строит полный цикл: **собрать данные → выбрать конфигурацию → создать поток → протестировать**. Пример итерационного цикла:

1. **Сбор данных**
   - Подключить `MacOSAudioSession` (SwitchAudioSource) и получить текущий дефолтный output.
   - Запросить поддерживаемые sample rates/channels и `host_error_code`.
   - Сохранить их в лог (обязательно ID/UID и BT-флаг).

2. **Решение**
   - Resolver анализирует данные и возвращает конфиг:  
     * Если BT и/или `host_error_code == -10851` ⇒ `device=None`, моно, без `blocksize/latency`.  
     * Иначе использовать PortAudio ID + нормализованные параметры (DeviceParamsNormalizer).  
   - Resolver также учитывает history: если в истории device уже отказал, сразу применяет macOS-managed вариант.

3. **Создание потока**
   - `_start_audio_stream` получает config и:
     * Останавливает старый поток (`_stop_audio_stream` + задержки).
     * Создает `sd.OutputStream` с полученными параметрами.
     * При успехе сохраняет имя/UID или логирует ошибку `-9986`/`-10851`.

4. **Проверка**
   - Запускаем сценарий переключения устройств (например AirPods ↔ MacBook).
   - Проверяем: нет `PaErrorCode -9986`, сразу попадаем в macOS-managed конфиг, log показывает `host_error_code=-10851`.
   - Также тестируем реакцию на смену дефолтного устройства (через уведомления Core Audio) и проверяем, что resolver реинициализирует поток.

## Фазы перехода

1. **Поиск и построение API**  
   - Изучить `CoreAudio` и `AVFoundation` через PyObjC: как получить дефолтное устройство, какие форматы поддерживаются, как подписаться на `kAudioHardwarePropertyDefaultOutputDevice`.
   - Реализовать обёртку `MacOSAudioSession`.

2. **Интеграция Resolver-а**
   - Вынести выбор `stream_config` из `_start_audio_stream` и делегировать его новому resolver-у.  
   - Resolver будет использовать выдачу из `MacOSAudioSession` + историю ошибок.  
   - Поддержать два режима: “macOS-managed” и “PortAudio-managed”.

3. **Кэш и адаптация**
   - Добавить хранение “неподходящих” конфигураций (по UID/имени устройства).  
   - При следующем подключении устройство сразу получает безопасный профиль, без дожидания ошибок.
   - Обновить логирование: показывать используемый режим, источник конфигурации, host error code.

4. **Событийная реакция**
   - Подписаться на сообщения Core Audio о смене дефолтного устройства/маршрута.  
   - При изменении автоматически инициировать новый resolver-цикл и перезапуск `_start_audio_stream`.
   - Обеспечить корректное обновление `ChunkBuffer` (channels/sample rate) до создания потока.

5. **Отказ от fallback retry**
   - После стабилизации resolver-а убрать многопопыточный цикл (оставить только `device busy` handling).
   - Убедиться, что `PaErrorCode -9986` больше не появляется и `log.md` показывает быстрый переход к macOS-managed режиму.

## Тесты и проверка

1. Проверить подключение AirPods:  
   - Логи не содержат `-9986` после `host_error_code=-10851`.  
   - Поток создаётся с `device=None`, `channels=1` (если ранее было `-10851`).  
   - При переподключении дефолтного устройства resolver использует cached profile.

2. Проверить обычное устройство (e.g., встроенные колонки):  
   - `stream_config` использует PortAudio ID и нормализованные параметры.  
   - `host_error_code` = `None` → retry loop не задействован.

3. Проверить смену дефолтного устройства в runtime:  
   - Core Audio нотификация вызывает перезапуск players → новый config.  
   - Нет дополнительных `PaErrorCode -9986` после реакции.

4. Regression:  
   - Сценарии, которые раньше пользовались fallback’ами, остаются рабочими.  
   - Поведение `switch`-логики и queue не ломается.

## Статус реализации

### ✅ Фаза 0: Валидация текущих исправлений (в процессе)
- Создан чек-лист для тестирования (`Docs/AUDIO_CORE_ARCHITECTURE_VALIDATION_CHECKLIST.md`)
- Требуется тестирование всех сценариев переключения устройств

### ✅ Фаза 1: Минимальный кэш ошибок (реализовано)
- Добавлен `_device_error_cache` в `SequentialSpeechPlayer`
- Реализованы методы `_get_safe_stream_config()`, `_cache_error_config()`, `_clear_error_cache()`
- Интегрирован кэш в `_start_audio_stream()`:
  - Вызов `_get_safe_stream_config()` перед созданием потока
  - Сохранение безопасной конфигурации при ошибке -10851
  - Сохранение безопасной конфигурации при успешном создании потока после ошибок

**Детали:** См. `Docs/AUDIO_CORE_ARCHITECTURE_IMPLEMENTATION_STATUS.md`

### ⏸️ Фаза 2: Core Audio нотификации (не начато)
- Зависит от завершения Фазы 0

### ⏸️ Фаза 3: Полная интеграция Core Audio (не начато)
- Зависит от завершения Фазы 2

## Вывод

