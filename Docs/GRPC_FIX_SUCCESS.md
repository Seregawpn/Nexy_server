# ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã gRPC - –£–°–ü–ï–®–ù–û

**–î–∞—Ç–∞:** 13 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

---

## üéØ Root Cause

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `insecure_channel` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ TLS –ø–æ—Ä—Ç—É 443, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞.

**–û—à–∏–±–∫–∞:** `Trying to connect an http1.x server (HTTP status 400)` –Ω–∞ HTTP/2 preface `PRI * HTTP/2.0`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ secure_channel –≤–º–µ—Å—Ç–æ insecure_channel

**–ü—Ä–æ–±–ª–µ–º–∞:** `insecure_channel` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TLS, –∞ Nginx –Ω–∞ –ø–æ—Ä—Ç—É 443 —Ç—Ä–µ–±—É–µ—Ç TLS+HTTP/2.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `secure_channel` —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞.

### 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞

–î–ª—è self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω—É–∂–Ω–æ:
1. –°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ `ssl_channel_credentials`

---

## üìù –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞

```python
import grpc
from grpc import aio
import subprocess

# –î–ª—è –ø–æ—Ä—Ç–∞ 443 –∏—Å–ø–æ–ª—å–∑—É–µ–º secure_channel —Å TLS
if port == 443:
    # –°–∫–∞—á–∏–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞
    result = subprocess.run(
        ['openssl', 's_client', '-connect', address, '-showcerts'],
        input=b'', capture_output=True, timeout=5
    )
    
    if result.returncode == 0:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
        cert_start = result.stdout.find(b'-----BEGIN CERTIFICATE-----')
        cert_end = result.stdout.find(b'-----END CERTIFICATE-----', cert_start)
        cert_pem = result.stdout[cert_start:cert_end + len(b'-----END CERTIFICATE-----')]
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ credentials
        credentials = grpc.ssl_channel_credentials(root_certificates=cert_pem)
        channel = aio.secure_channel(address, credentials)
    else:
        # Fallback
        credentials = grpc.ssl_channel_credentials()
        channel = aio.secure_channel(address, credentials)
else:
    # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    channel = aio.insecure_channel(address)
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚ùå gRPC –æ—à–∏–±–∫–∞: Trying to connect an http1.x server (HTTP status 400)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ –ö–∞–Ω–∞–ª –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
‚úÖ gRPC —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ TLS+HTTP/2
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞

1. ‚úÖ Backend –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ 50051
2. ‚úÖ Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ gRPC –∑–∞–ø—Ä–æ—Å—ã
3. ‚úÖ Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç gRPC —á–µ—Ä–µ–∑ TLS+HTTP/2
4. ‚úÖ –ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ secure_channel
5. ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –¥–æ—Ö–æ–¥—è—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞

---

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ location –±–ª–æ–∫–æ–≤ –≤ Nginx
2. ‚úÖ Nginx –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å –º–æ–¥—É–ª–µ–º grpc
3. ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏–π
4. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ secure_channel –¥–ª—è –ø–æ—Ä—Ç–∞ 443
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

### –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å secure_channel –¥–ª—è –ø–æ—Ä—Ç–∞ 443:**
   ```python
   credentials = grpc.ssl_channel_credentials(root_certificates=cert_pem)
   channel = aio.secure_channel("20.63.24.187:443", credentials)
   ```

2. **–î–ª—è production —Å –≤–∞–ª–∏–¥–Ω—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º:**
   ```python
   credentials = grpc.ssl_channel_credentials()
   channel = aio.secure_channel("example.com:443", credentials)
   ```

3. **–ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞** –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏–π

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ (DoD)

- ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ secure_channel –Ω–∞ 443 —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ç 400 –Ω–∞ "PRI * HTTP/2.0"
- ‚úÖ gRPC –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Ö–æ–¥—è—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ HTTP(S) –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ - gRPC —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ TLS+HTTP/2
