# –ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–µ—á–∏

## üéØ –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å **–ø–æ–ª–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–µ—á–∏ –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π**, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ Ctrl+N).

---

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ callback

**–ü—Ä–æ–±–ª–µ–º–∞**: Completion callback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ (—á–µ—Ä–µ–∑ 0.89s –≤–º–µ—Å—Ç–æ 5.28s)

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ callback - –µ—Å–ª–∏ callback —Å—Ä–∞–±–æ—Ç–∞–ª –º–µ–Ω–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 80% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –æ–Ω –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è:

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ callback —Å—Ä–∞–±–æ—Ç–∞–ª –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
if engine_instance._playback_start_time is not None and engine_instance._expected_playback_duration is not None:
    elapsed_time = current_time - engine_instance._playback_start_time
    expected_duration = engine_instance._expected_playback_duration
    min_acceptable_duration = expected_duration * 0.8  # –ú–∏–Ω–∏–º—É–º 80% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    
    if elapsed_time < min_acceptable_duration:
        logger.warning(f"‚ö†Ô∏è [AVF] Completion callback —Å—Ä–∞–±–æ—Ç–∞–ª –ü–†–ï–ñ–î–ï–í–†–ï–ú–ï–ù–ù–û: "
                      f"–ø—Ä–æ—à–ª–æ {elapsed_time:.2f}s –∏–∑ {expected_duration:.2f}s. "
                      f"–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º callback, –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ fallback —Ç–∞–π–º–µ—Ä.")
        return  # –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ fallback —Ç–∞–π–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.

---

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (`AVAudioEngineConfigurationChangeNotification`) –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è `RUNNING` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (RUNNING), –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –µ–≥–æ
if current_state_under_lock == AudioState.RUNNING:
    logger.debug("üîç [AVF] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (RUNNING), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ "
                 "(–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)")
    # –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –Ω–æ –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º
    self._cached_output_device_name = new_device_name
    return
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –ø–æ–ª–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

---

### 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

**–î–æ–±–∞–≤–ª–µ–Ω–æ**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏ –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```python
# –í __init__
self._playback_start_time: Optional[float] = None
self._expected_playback_duration: Optional[float] = None

# –í play_audio()
with self._lock:
    import time
    self._playback_start_time = time.time()
    duration_sec = len(audio_data) / (sample_rate * channels * 2)
    self._expected_playback_duration = duration_sec
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–µ—Ç, –∫–æ–≥–¥–∞ –Ω–∞—á–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ —Å–∫–æ–ª—å–∫–æ –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –¥–ª–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ callback'–∏.

---

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏

### –ü–æ–ª–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è:

1. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è**:
   - –ï—Å–ª–∏ callback —Å—Ä–∞–±–æ—Ç–∞–ª –º–µ–Ω–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 80% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –æ–Ω –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   - –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ fallback —Ç–∞–π–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ**:
   - –í —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `STARTING` - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –í —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `RUNNING` - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `stop_output()`) –º–æ–≥—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

3. **Fallback —Ç–∞–π–º–µ—Ä –≤—Å–µ–≥–¥–∞ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ**:
   - –î–∞–∂–µ –µ—Å–ª–∏ callback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –°–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `duration + 0.5` —Å–µ–∫—É–Ω–¥—ã
   - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

## üîç –ò—Å–∫–ª—é—á–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–æ)

### –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã):

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ Ctrl+N**:
   - `interrupt.request` ‚Üí `stop_output()` ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

2. **–†—É—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API**:
   - `stop_output()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —è–≤–Ω–æ
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

3. **–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**:
   - –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

---

## üìù –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π)

1. `play_audio()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `STARTING` ‚Üí `RUNNING`
2. –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: `_playback_start_time = time.time()`
3. –û–∂–∏–¥–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: `_expected_playback_duration = 5.28s`
4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è (—Å–æ—Å—Ç–æ—è–Ω–∏–µ `RUNNING`)
5. –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
6. Fallback —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ 5.78s ‚Üí —Å–æ–±—ã—Ç–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
7. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Ctrl+N

1. `play_audio()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `RUNNING`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Ctrl+N ‚Üí `interrupt.request`
3. `stop_output()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
4. –°–æ–±—ã—Ç–∏–µ `audio.playback.completed` –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏
5. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø—Ä–µ—Ä–≤–∞–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç**:
- ‚úÖ –ü–æ–ª–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–µ—á–∏ –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π (–µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π)
- ‚úÖ –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π callback –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
- ‚úÖ Fallback —Ç–∞–π–º–µ—Ä –≤—Å–µ–≥–¥–∞ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (Ctrl+N, –æ—à–∏–±–∫–∏) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
