# План тестирования: PermissionRestartIntegration

## Цель
Подтвердить, что автоматический перезапуск Nexy после выдачи критических разрешений работает надёжно, не мешает активным сессиям и не конфликтует с системой обновлений.

## Охват
- Интеграция: `PermissionRestartIntegration`
- Модуль: `modules.permission_restart`
- События: `permissions.changed`, `permissions.status_checked`, `permission_restart.*`, `updater.update_*`
- Платформа: macOS (требуются системные разрешения микрофона, Accessibility, Input Monitoring, Screen Recording)

## Предпосылки
1. Собранный Nexy app или запуск из исходников.
2. Возможность управлять системными разрешениями (через `System Settings → Privacy & Security`).
3. Доступ к логам `logs/nexy.log` (или консольный вывод).
4. Для сценариев с обновлением — имитация `UpdaterIntegration` (флаг `update_in_progress` через событие или временный monkey-patch).

## Метрики наблюдения
- Логи `PermissionRestartIntegration` и `modules.permission_restart`.
- События EventBus (использовать `EventBus.get_event_history` при необходимости).
- Поведение приложения (автоматический выход / повторный запуск).

## Сценарии

### 1. Базовый перезапуск по одному разрешению
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Запустить приложение, убедиться что `permission_restart` включён|Лог `PermissionRestart integration initialised`|
|2|Удалить разрешение (например, микрофон) до состояния `NOT_DETERMINED`|Статус в macOS сброшен|
|3|Снова открыть Nexy, дождаться запроса разрешения и нажать «Allow»|В EventBus появляется `permissions.changed`|
|4|Отследить логи `permission_restart.scheduled`|Лог с задержкой (5 с) и указанием разрешения|
|5|Через ~5 с приложение должно закрыться и запуститься заново|Лог `permission_restart.executing`, процесс перезапущен|

### 2. Перезапуск после нескольких разрешений
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Сбросить сразу два критических разрешения|Статусы `NOT_DETERMINED`|
|2|Выдать оба разрешения в одном сеансе (через FirstRun или вручную)|Два события `permissions.changed`|
|3|Лог `permission_restart.scheduled` должен содержать оба разрешения|Список `["microphone","accessibility"]`|
|4|Перезапуск выполняется один раз после совокупной задержки|Нет повторных перезапусков|

### 3. Отсрочка при активном режиме LISTENING/PROCESSING
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Войти в режим LISTENING (удерживать hotkey) и удерживать его активным|`AppMode` ≠ SLEEPING|
|2|Параллельно выдать разрешение (через macOS Settings)|Лог `permission_restart.scheduled` появляется|
|3|Пока режим не вернётся в SLEEPING, нет `permission_restart.executing`|Перезапуск не происходит|
|4|Завершить сессию, дождаться возврата в SLEEPING|Через задержку перезапуск запускается|

### 4. Блокировка во время обновления
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Запустить Nexy, программно выставить `state_manager.set_state_data("update_in_progress", True)` или инициировать обновление|Лог `UpdaterIntegration: update_in_progress=True`|
|2|Выдать критическое разрешение|`permission_restart.scheduled` публикуется|
|3|Пока `update_in_progress=True`, перезапуск не выполняется|Нет `permission_restart.executing`|
|4|Снять флаг обновления (`False`)|Через задержку происходит перезапуск|

### 5. Проверка флага `NEXY_DISABLE_AUTO_RESTART`
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Запустить приложение с `NEXY_DISABLE_AUTO_RESTART=1`|Лог `Dry-run mode enabled`|
|2|Выдать разрешение|`permission_restart.scheduled` есть|
|3|Перезапуск не выполняется, приложение продолжает работу|Лог `restart skipped`|

### 6. Максимум попыток
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|В конфиге установить `max_restart_attempts=1`|Перезапуск допустим один раз|
|2|Выдать разрешение — происходит перезапуск|Лог scheduling/executing|
|3|Повторно сбросить и выдать разрешение|Лог `Max restart attempts reached`, перезапуска нет|

### 7. Уведомления EventBus
| Шаг | Описание | Ожидаемый результат |
|-----|----------|---------------------|
|1|Подписаться тестовым обработчиком на `permission_restart.*`|Получать данные в тестовом коде|
|2|Выдать разрешение|Клиентские обработчики получают корректный payload (reason, delay, разрешения)|

## Негативные проверки
- Нет перезапуска, если критические разрешения уже были `GRANTED` (проверка отсутствия ложных срабатываний).
- Нет перезапуска при изменении некритических разрешений (например, notifications).
- Перезапуск не запускается при отключённой интеграции (`enabled=false`).

## Автоматизация
- Покрыть unit-тестами уровень `PermissionChangeDetector` и `RestartScheduler` (мок EventBus, state manager, флаг updater).
- Инструментальные тесты: моковый EventBus, проверки публикации событий и правил задержки.

## Критерии выхода
- Все ключевые сценарии (1–5) пройдены без регрессий.
- Нет ложных перезапусков в режимах LISTENING/PROCESSING.
- Убедиться, что журнал содержит ожидаемые события, а система обновлений не конфликтует.
