# Interaction Matrix
# Defines rules for state transitions based on multiple axes.
# See .cursorrules section 18.2 for format and priority rules.
# Synced with Docs/STATE_CATALOG.md
#
# IMPORTANT: Any changes to axes must be synchronized with:
# 1. Docs/STATE_CATALOG.md (source of truth for axes)
# 2. integration/core/gateways.py (decision logic)
# 3. Gateway tests (≥8–14 pairwise + 2 negative)

axes:
  Permission.mic: [granted, denied, prompt_blocked]
  Permission.screen: [granted, denied, prompt_blocked]
  Permission.accessibility: [granted, denied, prompt_blocked]
  Device.input: [default_ok, busy]
  Network: [online, offline]
  FirstRun: [true, false]
  appMode: [SLEEPING, LISTENING, PROCESSING]
  permissions.restart_pending: [true, false]  # NEW - Phase 2
  process.lifecycle: [running, restarting, terminated]  # NEW - Phase 2

rules:
  # ============================================================================
  # LISTENING MODE RULES
  # ============================================================================

  # Hard stop: permission denied always aborts listening
  - when: {Permission.mic: denied}
    decision: abort_listen
    priority: hard_stop
    description: Microphone permission denied - cannot proceed with listening
    gateway: decide_start_listening

  # Hard stop: first_run in progress blocks activation
  - when: {FirstRun: true}
    decision: abort_listen
    priority: hard_stop
    description: First run in progress - block activation until permissions are granted
    gateway: decide_start_listening

  # Graceful: device busy - retry with backoff
  - when: {Permission.mic: granted, Device.input: busy, appMode: LISTENING}
    decision: retry_backoff
    priority: graceful
    description: Device busy - retry with exponential backoff
    gateway: decide_with_backoff

  # Graceful: network offline during listening (can still listen, won't process)
  - when: {Network: offline, appMode: LISTENING}
    decision: degrade_offline
    priority: graceful
    description: Network offline - can listen but won't process until online
    gateway: decide_start_listening

  # ============================================================================
  # FIRST RUN RESTART RULES (Phase 2)
  # See Docs/ADR-001-first-run-restart-hotfix.md and Docs/change_impact.yaml
  # ============================================================================

  # Hard stop: first_run + restart_pending blocks all integration startup
  - when: {FirstRun: true, permissions.restart_pending: true}
    decision: abort_integration_startup
    priority: hard_stop
    description: First run restart pending - stop launching remaining integrations until restart completes
    gateway: decide_continue_integration_startup
    source: Docs/change_impact.yaml

  # Hard stop: restarting lifecycle blocks integrations
  - when: {process.lifecycle: restarting}
    decision: abort_integration_startup
    priority: hard_stop
    description: Process restarting - do not launch new integrations
    gateway: decide_continue_integration_startup
    source: Docs/change_impact.yaml

  # ============================================================================
  # PROCESSING MODE RULES
  # ============================================================================

  # Hard stop: screen capture denied during processing
  - when: {Permission.screen: denied, appMode: PROCESSING}
    decision: abort_processing
    priority: hard_stop
    description: Screen capture permission denied during processing
    gateway: decide_process_audio

  # Graceful: network offline during processing
  - when: {Network: offline, appMode: PROCESSING}
    decision: degrade_offline
    priority: graceful
    description: Network offline - degrade to offline mode
    gateway: decide_process_audio

  # ============================================================================
  # PERMISSION RESTART RULES
  # Permission Restart rules consolidated here (previous narrative docs archived)
  # ============================================================================

  # Hard stop: respect_updates blocks restart if update available
  # Rule: If respect_updates=true AND update_available=true → skip permission restart
  # Reason: Avoid double restart (update will restart itself, permissions apply automatically)
  - when: {permission_restart: {respect_updates: true, update_available: true}}
    decision: skip_restart
    priority: hard_stop
    description: Update available - skip permission restart (update will restart itself)
    gateway: permission_restart.maybe_schedule_restart
      source: STATE_CATALOG.md (Связь с Permission Restart)

  # Graceful: respect_active_sessions delays restart until SLEEPING
  # Rule: If respect_active_sessions=true AND appMode != SLEEPING → delay restart (max 10 min)
  # Reason: Don't interrupt user during active session (listening/processing)
  - when: {permission_restart: {respect_active_sessions: true}, appMode: [LISTENING, PROCESSING]}
    decision: delay_restart
    priority: graceful
    description: Active session - delay restart until SLEEPING (max 10 minutes, then force)
    gateway: permission_restart._wait_for_safe_conditions
    timeout_seconds: 600
      source: STATE_CATALOG.md (Связь с Permission Restart)

  # Graceful: respect_updates delays restart if update in progress
  # Rule: If respect_updates=true AND update_in_progress=true → delay restart (max 10 min)
  # Reason: Don't interrupt update installation
  - when: {permission_restart: {respect_updates: true, update_in_progress: true}}
    decision: delay_restart
    priority: graceful
    description: Update in progress - delay restart until installation completes (max 10 minutes)
    gateway: permission_restart._wait_for_safe_conditions
    timeout_seconds: 600
      source: STATE_CATALOG.md (Связь с Permission Restart)

  # Hard stop: max_restart_attempts exceeded
  # Rule: If attempts >= max_restart_attempts → skip restart
  # Reason: Protection against infinite restart loops
  - when: {permission_restart: {attempts: ">=max_restart_attempts"}}
    decision: skip_restart
    priority: hard_stop
    description: Max restart attempts reached - skip to prevent infinite loops
    gateway: permission_restart.maybe_schedule_restart
      source: STATE_CATALOG.md (Связь с Permission Restart)

  # Hard stop: permission_restart enabled=false
  # Rule: If enabled=false → skip restart
  # Reason: Mechanism disabled by configuration (development/debugging)
  - when: {permission_restart: {enabled: false}}
    decision: skip_restart
    priority: hard_stop
    description: Permission restart disabled by configuration
    gateway: permission_restart.maybe_schedule_restart
      source: STATE_CATALOG.md (Связь с Permission Restart)

