accessibility:
  error_sound: true
  sound_notifications: true
  startup_sound: true
  success_sound: true
  voice_feedback: true
  voiceover_control:
    enabled: true
    mode: stop
    duck_modes:
    - listening
    - processing
    release_modes:
    - sleeping
    debounce_seconds: 0.25
    stop_repeats: 2
    stop_repeat_delay: 0.05
    use_apple_script_fallback: true
    engage_on_keyboard_events: true
    debug_logging: false
    log_osascript_commands: false
    log_voiceover_state: false
app:
  bundle_id: com.nexy.assistant
  debug: false
  name: Nexy
  team_id: 5NKLL2CLB9
  version: 1.0.1  # ЕДИНСТВЕННОЕ МЕСТО ДЛЯ ИЗМЕНЕНИЯ ВЕРСИИ - при сборке автоматически обновятся все файлы
# Авто-всё конфигурация аудио - автоматическое определение параметров устройства
default_audio:
  # Только целевые параметры для STT (что ожидает движок распознавания)
  target_sample_rate: 16000   # стандарт для ASR
  target_channels: 1          # mono
  target_dtype: "int16"       # формат для ASR
  
  # Автоматические параметры (не настраиваются пользователем)
  auto_detect_device: true
  auto_detect_sample_rate: true
  auto_detect_channels: true
  auto_detect_dtype: true
  
  # Настройки автовосстановления и устойчивости
  silent_window_seconds: 0.3        # окно оценки тишины
  silent_windows_threshold: 2        # подряд окон тишины до перезапуска
  reopen_debounce_ms: 600            # пауза перед reopen (CoreAudio/BT стабилизация)
  device_quarantine_sec: 20          # если девайс флапает — «отлежаться»
  health_check_interval_sec: 1.0     # период "здоровья"/RMS
  
  # Буферизация и производительность
  read_chunk_sec: 0.2               # размер чанка для чтения
  chunk_size: 1024                  # размер блока для sounddevice
  max_retry_attempts: 3
  retry_delay: 0.5
  error_cooldown: 2.0
  
  # Логирование и отладка
  enable_debug_logging: true
  log_health_checks: true
  log_stream_events: true
  log_device_changes: true           # логировать смену устройств
  log_performance_metrics: true      # логировать метрики производительности
  
  # Обратная совместимость (будут удалены в будущих версиях)
  input_sample_rate: 16000          # DEPRECATED: используйте target_sample_rate
  output_sample_rate: 48000         # DEPRECATED: определяется автоматически
  input_channels: 1                 # DEPRECATED: используйте target_channels
  output_channels: 1                # DEPRECATED: определяется автоматически
  dtype: "int16"                    # DEPRECATED: используйте target_dtype
grpc:
  connection_timeout: 30
  enable_compression: true
  enable_keepalive: true
  keepalive_time: 10
  keepalive_timeout: 3
  keepalive_without_calls: true
  max_connection_idle: 300
  max_connection_age: 3600
  max_connection_age_grace: 5
  max_message_length: 4194304
  max_receive_message_length: 4194304
  max_send_message_length: 4194304
  retry_attempts: 3
  retry_delay: 1.0
  use_tls: false
  servers:
    local:
      host: 127.0.0.1
      port: 50051
      ssl: false
      timeout: 30
      retry_attempts: 3
      retry_delay: 1.0
      description: Локальный сервер для разработки
    production:
      host: 20.151.51.172
      port: 443
      ssl: true
      ssl_verify: false  # Временно отключено для self-signed сертификата
      use_http2: true    # Включить HTTP/2 (ALPN h2)
      timeout: 300       # Увеличен таймаут для длинных ответов
      retry_attempts: 5
      retry_delay: 2.0
      keepalive: true    # Включить keepalive
      description: Production сервер на Azure (HTTPS через Nginx, gRPC на /)
    fallback:
      host: 127.0.0.1
      port: 50052
      ssl: false
      timeout: 30
      retry_attempts: 3
      retry_delay: 1.0
      description: Резервный сервер
integrations:
  autostart_manager:
    enabled: true
    priority: 12
  grpc_client:
    enabled: true
    priority: 9
    server: production  # local|production|fallback - для dev используем local (127.0.0.1:50051)
    aggregate_timeout_sec: 1.5
    request_timeout_sec: 30.0
    max_retries: 3
    retry_delay: 1.0
    use_network_gate: true
  hardware_id:
    enabled: true
    priority: 2
  keyboard:
    key_to_monitor: ctrl_n
    short_press_threshold: 0.1
    long_press_threshold: 0.6
    event_cooldown: 0.1
    hold_check_interval: 0.05
    debounce_time: 0.1
    backend: auto
    # Защита от залипания состояния
    combo_timeout_sec: 10.0  # Максимальное время активной комбинации (секунды)
    key_state_timeout_sec: 5.0  # Максимальное время удержания отдельной клавиши (секунды)
  input_processing:
    enabled: true
    priority: 4
    enable_keyboard_monitoring: true
    auto_start: true
    min_recording_duration_sec: 0.6
    recording_prestart_delay_sec: 0.3
    playback_idle_grace_sec: 0.3
    playback_wait_timeout_sec: 5.0
    # Максимальное время (в секундах), которое микрофон может быть активен.
    # По истечении этого времени состояние будет принудительно сброшено
    # для защиты от "залипания" при потере системных событий. 0 - отключено.
    mic_reset_timeout_sec: 60.0
  instance_manager:
    enabled: true
    priority: 13
  interrupt_management:
    enabled: true
    priority: 8
  mode_management:
    enabled: true
    priority: 3
  network_manager:
    enabled: true
    priority: 6
  permissions:
    auto_open_preferences: false
    check_interval: 30.0
    enabled: true
    priority: 0
    retry_attempts: 3
    retry_delay: 5.0
    show_instructions: false
    required_permissions:
    - microphone
    - screen_capture
    - network
    - accessibility
    - input_monitoring
  permission_restart:
    enabled: true
    critical_permissions:
    - microphone
    - accessibility
    - input_monitoring
    - screen_capture
    restart_delay_sec: 5.0
    max_restart_attempts: 3
    respect_active_sessions: true
    respect_updates: true
    # Polling enabled: false by default to avoid conflicts with Updater and reduce EventBus load
    # Enable only for debugging/canary rollout
    polling_enabled: false
    poll_interval_sec: 3.0  # Only used if polling_enabled: true
  update_notification:
    enabled: true
    priority: 15
    speak_start: true
    speak_progress: true
    speak_complete: true
    speak_error: true
    progress_interval_sec: 30.0
    progress_step_percent: 50  # Озвучивать только при 50% (было: 20)
    use_signals: true
    voice: en-US
    dry_run: false
  screenshot_capture:
    enabled: true
    priority: 7
  signals:
    enabled: true
    priority: 11
    patterns:
      update_start:
        tone_hz: 880
        duration_ms: 200
        volume: 0.25
        repeat: 2
      update_progress:
        tone_hz: 660
        duration_ms: 120
        volume: 0.2
      update_success:
        tone_hz: 1200
        duration_ms: 300
        volume: 0.3
      update_error:
        tone_hz: 440
        duration_ms: 500
        volume: 0.3
  speech_playback:
    enabled: true
    priority: 10
  tray_controller:
    enabled: true
    priority: 1
  updater:
    enabled: true
    priority: 5
  voice_recognition:
    enabled: true
    priority: 4
    simulate: false
    timeout_sec: 10.0
    simulate_success_rate: 0.7
    simulate_min_delay_sec: 1.0
    simulate_max_delay_sec: 3.0
  welcome_message:
    enabled: true
    priority: 14
logging:
  console_level: DEBUG
  file_level: DEBUG
  file_path: logs/nexy.log
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  max_file_size: 10485760
  max_files: 5
  rotation: true
network:
  connection_check_interval: 30
  auto_fallback: true
  ping_timeout: 5
  ping_hosts:
  - 8.8.8.8
  - 1.1.1.1
permissions:
  # First Run - запрос разрешений при первом запуске приложения
  first_run:
    enabled: true                         # Включить запрос разрешений при первом запуске
    activation_hold_duration_sec: 13.0    # Сколько держать открытым каждый запрос разрешения (13 секунд)
    wait_for_grant: true                  # Опрос статуса разрешения после активации (ждём GRANTED или таймаут)
    grant_wait_timeout_sec: 30            # Максимальное время ожидания GRANTED статуса (30 секунд)

  # Управление последовательностью запросов разрешений (устаревшее, оставлено для совместимости)
  sequential: true                      # Запрашивать разрешения по очереди (не одновременно)
  pause_between_requests_sec: 13.0      # Пауза между запросами разрешений (13 секунд)
  request_timeout_sec: 120.0            # Ждать ответа пользователя 2 минуты (максимум)
  auto_open_settings: false             # Не открывать System Settings автоматически

  microphone:
    enabled: true
    required: true
    description: Nexy использует микрофон для распознавания речи и голосового управления.
  screen_capture:
    enabled: true
    required: true
    description: Nexy захватывает содержимое экрана для анализа и помощи пользователю.
  camera:
    enabled: false
    required: false
    description: Nexy может использовать камеру для анализа окружения.
  network:
    enabled: true
    required: true
    description: Nexy использует сеть для связи с сервером и обновлений.
  notifications:
    enabled: true
    required: true
    description: Nexy отправляет уведомления о статусе работы и важных событиях.
  accessibility:
    enabled: true
    required: true
    description: Nexy использует Accessibility для мониторинга клавиатуры и автоматизации.
  system_preferences:
    microphone: x-apple.systempreferences:com.apple.preference.security?Privacy_Microphone
    screen_capture: x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture
    camera: x-apple.systempreferences:com.apple.preference.security?Privacy_Camera
    accessibility: x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility
    input_monitoring: x-apple.systempreferences:com.apple.preference.security?Privacy_ListenEvent
    notifications: x-apple.systempreferences:com.apple.preference.notifications
screenshot_capture:
  auto_capture: false
  capture_delay: 0.1
  capture_format: PNG
  capture_quality: 85
  enabled: true
  max_captures: 10
  save_path: screenshots
  timeout: 5.0
speech_playback:
  # audio_device: auto  # Удалено - используем системные дефолты
  enabled: true
  fade_in_duration: 0.1
  fade_out_duration: 0.1
  max_queue_size: 5
  playback_speed: 1.0
  volume: 0.8
  auto_output_device_switch: true  # Автоматическое переключение output устройства при смене системного дефолта
tray:
  icon_active: assets/icons/active.png
  icon_inactive: assets/icons/off.png
  menu_items:
  - action: quit
    label: Выход
    separator: true
  - action: settings
    label: Настройки
  - action: about
    label: О программе
  - action: status
    label: Статус
  show_notifications: true
  tooltip: Nexy AI Assistant
  # Настройки создания NSStatusItem (для приёмки можно подкручивать без перекомпиляции)
  status_item:
    # Circuit-breaker
    circuit_open_threshold: 3  # Количество ошибок для открытия circuit
    circuit_open_duration_ms: 8000  # Длительность открытого состояния (8s)
    # Retry-логика
    max_attempts_per_series: 10  # Максимум попыток в серии
    initial_backoff_ms: 800  # Начальный backoff (800-1200ms)
    max_backoff_ms: 10000  # Максимальный backoff
    backoff_multiplier: 1.5  # Множитель для экспоненциального backoff
    jitter_percent: 0.15  # Jitter ±15%
    # Готовность Control Center
    control_center_ready_timeout_sec: 10.0  # Максимальное ожидание готовности
    first_attempt_delay_ms: 1000  # Задержка первой попытки (800-1200ms)
    # Fallback поведение
    final_timeout_ms: 60000  # Таймаут для перехода в режим без tray (60s)
    background_retry_interval_sec: 45  # Интервал фонового retry (30-60s)
updater:
  default:
    enabled: true
    update_channel: stable
    appcast_url: https://20.151.51.172/updates/appcast.xml
    manifest_url: https://20.151.51.172/updates/appcast.xml
    auto_check: true
    check_interval: 3600
    check_on_startup: true
    auto_install: true
    install_after_download: false
    silent_mode: true
    security:
      public_key: ''
      verify_signatures: true
      require_https: true
      ssl_verify: false  # Временно отключено для self-signed сертификата
    network:
      timeout: 30
      retries: 3
      user_agent: Nexy-Updater/1.0
    ui:
      show_notifications: true
      auto_download: true
      progress_notifications: true
    channels:
      stable:
        url: https://20.151.51.172/updates/appcast.xml
        description: Стабильные релизы
      beta:
        url: https://20.151.51.172/updates/appcast-beta.xml
        description: Бета версии
      alpha:
        url: https://20.151.51.172/updates/appcast-alpha.xml
        description: Альфа версии
  development:
    enabled: false
    auto_check: false
    check_on_startup: false
    auto_install: false
    network:
      timeout: 10
      retries: 0
    ui:
      show_notifications: false
      auto_download: false
voice_recognition:
  enabled: true
  language: en-US
  max_alternatives: 3
  phrase_timeout: 0.3
  silence_timeout: 0.8

# Voice integration settings (used by voice_recognition_integration.py)
voice:
  start_retry_delay_ms: 300  # Задержка между попытками запуска микрофона (мс)

# Coordinator settings (used by simple_module_coordinator.py)
coordinator:
  event_settle_delay_ms: 500  # Задержка после событий для обработки handlers (мс)

# Настройки STT (Speech-to-Text)
stt:
  language: en-US
  # sample_rate: 24000  # Удалено - используем системные дефолты
  channels: 1
  chunk_size: 1024
  dtype: 'int16'
  simulate: false
  timeout: 5.0
  use_google: true
  wake_word: nexy
welcome_message:
  enabled: true
  text: Hi! Nexy is here. How can I help you?
  use_server: true
  server_timeout_sec: 20
  delay_sec: 0.3
  volume: 0.8
  voice: en-US-JennyNeural
  sample_rate: 48000
  channels: 1
  bit_depth: 16
  ignore_microphone_permission: true
network_manager:
  enabled: true
  priority: 6
  check_interval: 10
  ping_timeout: 3
  max_retries: 3
  retry_delay: 5.0
  ping_hosts:
  - 1.1.1.1
  - 8.8.8.8
  test_urls:
  - https://www.google.com
  - https://www.apple.com
  - https://www.cloudflare.com

permission_override:
  default:
    assume_granted: false
  development:
    assume_granted: true

# Feature flags and kill-switches
# See .cursorrules section 19 for rollout policy
features:
  # Rollout flags: stages 1% → 25% → 100%
  # Example: sequential TCC prompts (gradual rollout)
  serial_tcc_prompts:
    enabled: false  # Currently disabled (1% → will move to 25% → 100%)
    rollout_percentage: 1
  
  # Kill-switches: override feature flags (immediate shutdown)
  # Format: ks_<feature_name>
  # If ks_* == true, feature is disabled regardless of feature flag
  ks_serial_tcc:
    enabled: false  # Kill-switch for serial_tcc_prompts (if true, disables regardless of feature flag)
  
  # Shadow-mode: use events/selectors for update status instead of state_data
  use_events_for_update_status:
    enabled: true  # Shadow-mode: read update_in_progress via selectors/events
    rollout_percentage: 1  # Beta: 1% rollout for observation
  
  # Shadow-mode: use events/selectors for restart_pending instead of state_data
  use_events_for_restart_pending:
    enabled: true  # Shadow-mode: read restart_pending via selectors/events
  
  # Fix: Critical subscriptions before integration initialization (race condition fix)
  # This ensures permissions.first_run_completed event is not lost
  critical_subscriptions_fix:
    enabled: true  # Production: enabled by default (critical bug fix)
    rollout_percentage: 100  # Full rollout
    description: "Prevent race condition in permissions event handling by subscribing before integration initialization"
  
  # Kill-switches: override feature flags (immediate shutdown)
  ks_first_run_normalization:
    enabled: false  # Kill-switch for first_run normalization (if true, disables new gateway checks)

  # Example pattern for new features:
  # new_feature_name:
  #   enabled: false
  #   rollout_percentage: 0
  # ks_new_feature_name:
  #   enabled: false

# Конфигурация действий (MCP commands)
# Feature ID: F-2025-016-mcp-app-opening-integration
actions:
  open_app:
    enabled: true  # Включено для dev окружения (автоматически включается в development)
    timeout_sec: 10.0  # Таймаут выполнения команды в секундах
    allowed_apps: []  # Whitelist приложений (пустой список = все разрешены)
    binary: "/usr/bin/open"  # Бинарный файл для открытия приложений на macOS
    speak_errors: true  # Произносить голосовой фидбек при ошибках
    use_server_tts: false  # Использовать серверный TTS для ошибок (по умолчанию локальный)
