name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CONTAINER_APP: nexy
  RESOURCE_GROUP: Nexy
  CONTAINER_APPS_ENVIRONMENT: managedEnvironment-Nexy-b374

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: "pip"
        cache-dependency-path: |
          server/requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r server/requirements.txt
        python -m pip install basedpyright

    - name: Run server quality scan
      run: bash server/scripts/full_quality_scan.sh

  deploy:
    runs-on: ubuntu-latest
    needs: [quality]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        appSourcePath: ${{ github.workspace }}/server
        containerAppName: ${{ env.CONTAINER_APP }}
        resourceGroupName: ${{ env.RESOURCE_GROUP }}
        containerAppEnvironment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}
        runtimeStack: python
        targetPort: 80
        
    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60
        
    - name: Test health endpoint
      run: |
        echo "Testing health endpoint..."
        # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–µ–∑ Azure CLI
        echo "‚úÖ Deployment completed successfully!"
        echo "üåê Container App: ${{ env.CONTAINER_APP }}"
        echo "üìÅ Resource Group: ${{ env.RESOURCE_GROUP }}"
        echo "üîß Environment: ${{ env.CONTAINER_APPS_ENVIRONMENT }}"
        echo ""
        echo "üìã Next steps:"
        echo "1. Check Azure Portal for Container App status"
        echo "2. Test health endpoint manually"
        echo "3. Verify gRPC server is running"
