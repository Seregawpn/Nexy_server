name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint:
    name: Lint (including state access checks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install ruff
      - name: Run ruff
        run: ruff check .
      - name: Check state access
        run: |
          # Verify no direct state access outside selectors/gateways
          python scripts/verify_no_direct_state_access.py
          if [ $? -ne 0 ]; then
            echo "ERROR: Direct state access violations found. Use selectors/gateways instead."
            exit 1
          fi

  schema-validate:
    name: Validate config schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest jsonschema pyyaml
      - name: Validate schemas
        run: |
          pytest tests/test_schemas.py -v

  contracts-test:
    name: Test contracts (gateways + decision logs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest
      - name: Run gateway tests
        run: |
          pytest tests/test_gateways.py -v
          # Verify decision logs in canonical format
          pytest tests/test_gateways.py::TestGatewayDecisionLogs -v
          # Verify permission restart gateway tests
          pytest tests/test_gateways.py::TestPermissionRestartGateway -v
          # Verify permission restart with updates tests
          pytest tests/test_gateways.py::TestPermissionRestartWithUpdates -v
      - name: Test initialization order
        run: |
          pytest tests/test_init_order.py -v

  impact-gate:
    name: Impact-gate check (4-artifacts invariant)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pyyaml
      - name: Check 4-artifacts invariant
        run: |
          # Verify STATE_CATALOG.md → interaction_matrix.yaml → gateways.py → tests
          python scripts/verify_4_artifacts_invariant.py update_in_progress restart_pending
          if [ $? -ne 0 ]; then
            echo "ERROR: 4-artifacts invariant violated. See .cursorrules section 11."
            exit 1
          fi
      - name: Check rule coverage
        run: |
          # Verify all rules from interaction_matrix.yaml are covered by tests
          python scripts/verify_rule_coverage.py
          if [ $? -ne 0 ]; then
            echo "ERROR: Some rules from interaction_matrix.yaml are not covered by tests."
            exit 1
          fi
      - name: Check predicate coverage
        run: |
          # Verify all predicate keys in interaction_matrix.yaml are registered
          python scripts/verify_predicate_coverage.py
          if [ $? -ne 0 ]; then
            echo "ERROR: Some predicate keys in interaction_matrix.yaml are not registered in predicates.py"
            exit 1
          fi
      - name: Check feature flags registration
        run: |
          # Verify feature flags are registered in FEATURE_FLAGS.md
          python scripts/verify_feature_flags.py
          if [ $? -ne 0 ]; then
            echo "ERROR: Required feature flags not registered. See .cursorrules section 6.1."
            exit 1
          fi
      - name: Check change_impact.yaml
        run: |
          # Check if interaction_matrix.yaml or gateways.py changed
          if git diff --name-only origin/${{ github.base_ref }} | grep -E "(interaction_matrix.yaml|gateways.py)" > /dev/null; then
            if [ ! -f ".impact/change_impact.yaml" ]; then
              echo "ERROR: change_impact.yaml required when modifying interaction_matrix.yaml or gateways.py"
              exit 1
            fi
          fi

  golden-tests:
    name: Golden tests (first-run logs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest pyyaml
      - name: Run golden tests
        run: |
          # Verify expected sequence is defined correctly
          pytest tests/test_golden_first_run_logs.py::TestGoldenFirstRunLogs -v
          # Note: Actual log validation requires log file (skip for now)
          # TODO: Implement actual log file validation when golden logs are available

  perf-slo:
    name: Performance SLO checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest
      - name: Run SLO tests
        run: |
          # Verify SLO thresholds are defined
          pytest tests/perf/test_slo_smoke.py::TestSLOSmoke::test_slo_thresholds_defined -v
          # Note: Actual metric validation requires log file (skip for now)
          # TODO: Implement actual SLO checks from logs/metrics when metrics are logged

