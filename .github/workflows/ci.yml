name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint:
    name: Lint (including state access checks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install ruff
      - name: Run ruff
        run: ruff check .
      - name: Check state access
        run: |
          # Verify no direct state access outside selectors/gateways
          python scripts/verify_no_direct_state_access.py || true
          # TODO: Implement actual verification script

  schema-validate:
    name: Validate config schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest jsonschema pyyaml
      - name: Validate schemas
        run: |
          pytest tests/test_schemas.py -v

  contracts-test:
    name: Test contracts (gateways + decision logs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest
      - name: Run gateway tests
        run: |
          pytest tests/test_gateways.py -v
          # Verify decision logs in canonical format
          pytest tests/test_gateways.py::TestGatewayDecisionLogs -v

  impact-gate:
    name: Impact-gate check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check change_impact.yaml
        run: |
          # Check if interaction_matrix.yaml or gateways.py changed
          if git diff --name-only origin/${{ github.base_ref }} | grep -E "(interaction_matrix.yaml|gateways.py)" > /dev/null; then
            if [ ! -f ".impact/change_impact.yaml" ]; then
              echo "ERROR: change_impact.yaml required when modifying interaction_matrix.yaml or gateways.py"
              exit 1
            fi
          fi

  golden-tests:
    name: Golden tests (permission-restart)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest pyyaml
      - name: Run golden tests
        run: |
          pytest integration/tests/test_golden_permission_restart.py -v || true
          # TODO: Implement golden test runner

  perf-slo:
    name: Performance SLO checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest
      - name: Run SLO tests
        run: |
          pytest tests/perf/test_slo.py::TestSLOSmoke -v -m smoke || true
          # TODO: Implement actual SLO checks from logs/metrics

